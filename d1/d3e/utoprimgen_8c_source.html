<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.3.1"/>
<title>HARM: utoprimgen.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">HARM
   </div>
   <div id="projectbrief">harm and utilities</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.3.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="../../search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">utoprimgen.c</div>  </div>
</div><!--header-->
<div class="contents">
<a href="../../d1/d3e/utoprimgen_8c.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="preprocessor">#include &quot;decs.h&quot;</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;</div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment">// NOTEMARK: if using primtoU() or primtoflux(), these respect nprlist for PLOOP, hence why these tests use PLOOP while others use PALLLOOP</span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;</div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;</div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;</div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="preprocessor">#if(PRODUCTION&gt;=2)</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define CHECKONINVFRAC (1E-1)</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#elif(PRODUCTION==1)</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define CHECKONINVFRAC (1E-2)</span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#else</span></div>
<div class="line"><a name="l00020"></a><span class="lineno"><a class="code" href="../../d1/d3e/utoprimgen_8c.html#a11db68297c24100ffe1c76e659268e5f">   20</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define CHECKONINVFRAC (MAX(1E-7,newtonstats-&gt;tryconv*1E3)) // can&#39;t check if didn&#39;t ask for large error.</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00024"></a><span class="lineno"><a class="code" href="../../d1/d3e/utoprimgen_8c.html#a3a3cb87e250a02050cb52a1f1240b128">   24</a></span>&#160;<span class="preprocessor">#define FAILIFBADCHECK 1</span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00027"></a><span class="lineno"><a class="code" href="../../d1/d3e/utoprimgen_8c.html#ac85d41f36d0739a78a1e6cc767157a8f">   27</a></span>&#160;<span class="preprocessor">#define CHECKONINVFRACFAIL (1E-1)</span></div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00029"></a><span class="lineno"><a class="code" href="../../d1/d3e/utoprimgen_8c.html#a29c71c132c174c4a72d398ebfc197d62">   29</a></span>&#160;<span class="preprocessor">#define REPORTCYCLE (10)</span></div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00032"></a><span class="lineno"><a class="code" href="../../d1/d3e/utoprimgen_8c.html#a3a8adda834dd0777f2230a3d2dca2aba">   32</a></span>&#160;<span class="preprocessor">#define ENTROPYFIXGUESSEXTERNAL (ENTROPYFIXGUESS)</span></div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;</div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;</div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;</div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> negdensitycheck(<span class="keywordtype">int</span> finalstep, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *prim, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *pflag);</div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> check_on_inversion(<span class="keywordtype">int</span> checkoninversiongas, <span class="keywordtype">int</span> checkoninversionrad, <span class="keywordtype">int</span> usedhotinversion,<span class="keywordtype">int</span> usedentropyinversion,<span class="keywordtype">int</span> usedcoldinversion,<span class="keywordtype">int</span> usedffdeinversion, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflag, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr0, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *<a class="code" href="../../dc/dd2/newcodediff_8txt.html#ae7ab77d7e616dc02fba121a009b48c27">pr</a>, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pressure, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Uold, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Unew, <span class="keyword">struct</span> <a class="code" href="../../db/d3a/structof__newtonstats.html">of_newtonstats</a> *newtonstats, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflagrad);</div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> debug_utoprimgen(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflag, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr0, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *<a class="code" href="../../dc/dd2/newcodediff_8txt.html#ae7ab77d7e616dc02fba121a009b48c27">pr</a>, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Uold, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Unew);</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> compare_ffde_inversions(<span class="keywordtype">int</span> showmessages, <span class="keywordtype">int</span> allowlocalfailurefixandnoreport, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflag, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr0, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *<a class="code" href="../../dc/dd2/newcodediff_8txt.html#ae7ab77d7e616dc02fba121a009b48c27">pr</a>, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pressure, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ugeomfree0, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a>*Ugeomfree, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Uold, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Unew, <span class="keyword">struct</span> <a class="code" href="../../db/d3a/structof__newtonstats.html">of_newtonstats</a> *newtonstats, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflagrad);</div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;</div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> tryhotinversion(<span class="keywordtype">int</span> showmessages, <span class="keywordtype">int</span> allowlocalfailurefixandnoreport, <span class="keywordtype">int</span> finalstep, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> oldpflag, <span class="keywordtype">int</span> forcetry, <span class="keywordtype">int</span> whichcap, <span class="keywordtype">int</span> modprim, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pi, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr0, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *<a class="code" href="../../dc/dd2/newcodediff_8txt.html#ae7ab77d7e616dc02fba121a009b48c27">pr</a>, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pressure, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ugeomfree, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ugeomfree0, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *qptr, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <span class="keyword">struct</span> <a class="code" href="../../db/d3a/structof__newtonstats.html">of_newtonstats</a> *newtonstats, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflagrad);</div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> tryentropyinversion(<span class="keywordtype">int</span> showmessages, <span class="keywordtype">int</span> allowlocalfailurefixandnoreport, <span class="keywordtype">int</span> finalstep, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> oldpflag, <span class="keywordtype">int</span> forcetry, <span class="keywordtype">int</span> whichcap, <span class="keywordtype">int</span> modprim, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pi, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr0, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *<a class="code" href="../../dc/dd2/newcodediff_8txt.html#ae7ab77d7e616dc02fba121a009b48c27">pr</a>, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pressure, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ugeomfree, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ugeomfree0, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *qptr, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <span class="keyword">struct</span> <a class="code" href="../../db/d3a/structof__newtonstats.html">of_newtonstats</a> *newtonstats, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflagrad);</div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> trycoldinversion(<span class="keywordtype">int</span> showmessages, <span class="keywordtype">int</span> allowlocalfailurefixandnoreport, <span class="keywordtype">int</span> finalstep, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> oldpflag, <span class="keywordtype">int</span> forcetry, <span class="keywordtype">int</span> whichcap, <span class="keywordtype">int</span> modprim, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pi, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr0, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *<a class="code" href="../../dc/dd2/newcodediff_8txt.html#ae7ab77d7e616dc02fba121a009b48c27">pr</a>, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pressure, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ugeomfree, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ugeomfree0, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *qptr, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <span class="keyword">struct</span> <a class="code" href="../../db/d3a/structof__newtonstats.html">of_newtonstats</a> *newtonstats, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflagrad);</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> tryffdeinversion(<span class="keywordtype">int</span> showmessages, <span class="keywordtype">int</span> allowlocalfailurefixandnoreport, <span class="keywordtype">int</span> finalstep, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> oldpflag, <span class="keywordtype">int</span> forcetry, <span class="keywordtype">int</span> whichcap, <span class="keywordtype">int</span> modprim, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pi, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr0, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *<a class="code" href="../../dc/dd2/newcodediff_8txt.html#ae7ab77d7e616dc02fba121a009b48c27">pr</a>, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pressure, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ugeomfree, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ugeomfree0, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *qptr, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <span class="keyword">struct</span> <a class="code" href="../../db/d3a/structof__newtonstats.html">of_newtonstats</a> *newtonstats, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflagrad);</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;</div>
<div class="line"><a name="l00053"></a><span class="lineno"><a class="code" href="../../db/dc8/utoprimgen_8funcdeclare_8h.html#a7e078cc9a354495bc85554d875a705d9">   53</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="../../d1/d3e/utoprimgen_8c.html#a7e078cc9a354495bc85554d875a705d9" title="General explicit inversion of U[MHD]-&gt;P[MHD] and also inverts scalars. Inverts radiation if(EOMRADTYP...">Utoprimgen</a>(<span class="keywordtype">int</span> showmessages, <span class="keywordtype">int</span> checkoninversiongas, <span class="keywordtype">int</span> checkoninversionrad, <span class="keywordtype">int</span> allowlocalfailurefixandnoreport, <span class="keywordtype">int</span> finalstep, <span class="keywordtype">int</span> *eomtype, <span class="keywordtype">int</span> whichcap, <span class="keywordtype">int</span> whichmethod, <span class="keywordtype">int</span> modprim, <span class="keywordtype">int</span> evolvetype, <span class="keywordtype">int</span> inputtype,<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *U, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *qptr,  <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dissmeasure, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pi, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *<a class="code" href="../../dc/dd2/newcodediff_8txt.html#ae7ab77d7e616dc02fba121a009b48c27">pr</a>, <span class="keyword">struct</span> <a class="code" href="../../db/d3a/structof__newtonstats.html">of_newtonstats</a> *newtonstats)</div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;{</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;  <span class="comment">// debug</span></div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>, <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>, k;</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Ugeomfree[NPR],Ugeomfree0[NPR];</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> pr0[NPR];</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> prother[NPR];</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;  <span class="keywordtype">int</span> whichentropy;</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;  <span class="comment">//  struct of_state q;</span></div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Uold[NPR],Unew[NPR];</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;  <span class="keywordtype">int</span> otherfail;</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;  <span class="keyword">extern</span> <span class="keywordtype">void</span> UtoU(<span class="keywordtype">int</span> inputtype, <span class="keywordtype">int</span> returntype,<span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom,<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Uin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Uout);</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d1/d3e/utoprimgen_8c.html#a0a83e9e7fdd3cc595c5b8d0df88ec684" title="just picks the algorithm to invert">Utoprimgen_pick</a>(<span class="keywordtype">int</span> showmessages, <span class="keywordtype">int</span> allowlocalfailurefixandnoreport, <span class="keywordtype">int</span> which, <span class="keywordtype">int</span> eomtype, <span class="keywordtype">int</span> whichcap, <span class="keywordtype">int</span> parameter, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ugeomfree, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflag, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pressure, <span class="keyword">struct</span> <a class="code" href="../../db/d3a/structof__newtonstats.html">of_newtonstats</a> *newtonstats, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflagrad);</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;  <span class="keywordtype">int</span> Utoprimgen_compare(<span class="keywordtype">int</span> showmessages, <span class="keywordtype">int</span> allowlocalfailurefixandnoreport, <span class="keywordtype">int</span> eomtype, <span class="keywordtype">int</span> whichcap, <span class="keywordtype">int</span> parameter, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ugeomfree, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflag, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pressure, <span class="keyword">struct</span> <a class="code" href="../../db/d3a/structof__newtonstats.html">of_newtonstats</a> *newtonstats, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflagrad);</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;  <span class="keywordtype">int</span> Utoprimgen_tryagain(<span class="keywordtype">int</span> showmessages, <span class="keywordtype">int</span> allowlocalfailurefixandnoreport, <span class="keywordtype">int</span> eomtype, <span class="keywordtype">int</span> whichcap, <span class="keywordtype">int</span> parameter, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ugeomfree0, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ugeomfree,<span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflag, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr0, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pressure, <span class="keyword">struct</span> <a class="code" href="../../db/d3a/structof__newtonstats.html">of_newtonstats</a> *newtonstats, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflagrad);</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;  <span class="keywordtype">int</span> Utoprimgen_tryagain2(<span class="keywordtype">int</span> showmessages, <span class="keywordtype">int</span> allowlocalfailurefixandnoreport, <span class="keywordtype">int</span> eomtype, <span class="keywordtype">int</span> whichcap, <span class="keywordtype">int</span> parameter, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ugeomfree0, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ugeomfree,<span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflag, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr0, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pressure, <span class="keyword">struct</span> <a class="code" href="../../db/d3a/structof__newtonstats.html">of_newtonstats</a> *newtonstats, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflagrad);</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;  <span class="keywordtype">void</span> convert_U_removerestmassfromuu(<span class="keywordtype">int</span> utoprimverison, <span class="keywordtype">int</span> removerestmassfromuu, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *U);</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d1/d3e/utoprimgen_8c.html#abfc42de6975dd4ff02f2748404e10911" title="perform U-&gt;p inversion on advected scalars">invert_scalars1</a>(<span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ugeomfree,<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr);</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d1/d3e/utoprimgen_8c.html#a1118806d01e553c38ae5cf5f036f9f2e" title="perform U-&gt;p inversion on advected scalars">invert_scalars2</a>(<span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ugeomfree, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *q, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr);</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;  <span class="keywordtype">int</span> pl,pliter;</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;  <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> lpflag,lpflagrad;</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;  <span class="keywordtype">int</span> usedhotinversion,usedentropyinversion,usedcoldinversion,usedffdeinversion;</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> pressuremem=-1.0;</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pressure=&amp;pressuremem;</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;  <span class="keywordtype">int</span> eomtypelocal;</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;  <span class="comment">// set check flag to default if user didn&#39;t want to choose</span></div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;<span class="comment"></span>  <span class="keywordflow">if</span>(checkoninversiongas==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a80769727aecfcc996c34a2ddc147c195">CHECKONINVERSIONDEFAULT</a>) checkoninversiongas=<a class="code" href="../../da/d3e/definit_8h.html#a5dc18e6d15e4420586d45d912fccebac" title="whether to check on inversion and report problem Also, use diag_fixup() to account for changes in U w...">CHECKONINVERSION</a>;</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;  <span class="keywordflow">if</span>(checkoninversionrad==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a80769727aecfcc996c34a2ddc147c195">CHECKONINVERSIONDEFAULT</a>) checkoninversionrad=<a class="code" href="../../da/d3e/definit_8h.html#a70e4418eb8c6479afc202024b46ad581">CHECKONINVERSIONRAD</a>;</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;  <span class="comment">// DEBUG:</span></div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;  <span class="comment">//  dualfprintf(fail_file,&quot;Doing inversion for ijk=%d %d %d nstep=%ld steppart=%d\n&quot;,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,nstep,steppart);</span></div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160; </div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;  <span class="comment">// INVERT Magnetic field or restore magnetic field for SPLITNPR case</span></div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;<span class="preprocessor">#if(SPLITNPR)</span></div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;<span class="preprocessor"></span>  <span class="keywordflow">if</span>(<a class="code" href="../../d8/d5b/defs_8general_8h.html#af637e542453ec23c1a41a1038b223040">nprlist</a>[<a class="code" href="../../d8/d5b/defs_8general_8h.html#aa513122b9e25a436a0e98805e46961af" title="OPENMPNOTE: Ensure all pl&#39;s are set as private as required [only npr2interp and npr2notinterp changed...">nprstart</a>]==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a> &amp;&amp; <a class="code" href="../../d8/d5b/defs_8general_8h.html#af637e542453ec23c1a41a1038b223040">nprlist</a>[<a class="code" href="../../d8/d5b/defs_8general_8h.html#a11c2c3ace90a795cd7a910ac0a6256d2">nprend</a>]==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>){ <span class="comment">// then assume doing B1,B2,B3</span></div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;    <span class="comment">// invert magnetic field only</span></div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a9afde1f1647e18e733406a1566b8b550">PLOOPBONLY</a>(pl) pr[pl]=U[pl]/ptrgeom-&gt;e[pl]; <span class="comment">// direct inversion from geometry-free conserved quantity</span></div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;    <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;  }</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;    <span class="comment">// otherwise assume want to invert ONLY non-B components and assume using same memory space</span></div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;    <span class="comment">// can achieve this by setting Ugeomfree to *existing* pr (assume memory space for SPLITNPR step 0 and 1 didn&#39;t change</span></div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;    <span class="comment">// overwrites update (that is no field update done on second pass) to magnetic field</span></div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;    <span class="comment">// Note that field U not updated in this pass, so need to fill with something.</span></div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;    <span class="comment">// Assume pr here is pbb that contains field-update&#39;s Bnew</span></div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a9afde1f1647e18e733406a1566b8b550">PLOOPBONLY</a>(pl) U[pl]=pr[pl]*ptrgeom-&gt;e[pl];</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;  }</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;<span class="preprocessor"></span>  <span class="comment">// invert magnetic field</span></div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;  <span class="comment">// direct inversion from geometry-free conserved quantity</span></div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;  <span class="comment">// assume normal inversion takes care of this</span></div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;  <span class="comment">//  PLOOPBONLY(pl) pr[pl]=U[pl]/ptrgeom-&gt;e[pl];</span></div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;</div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;  <span class="comment">// Notice that reconstruct &quot;standard&quot; geometry-free conserved quantities by first modifying the geometry prefactor and THEN dealing with rest-mass or other subtractions and additions.</span></div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;  <span class="comment">// This is consistent with primtoflux() and how primtoflux() is used in source_conn().</span></div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;<span class="comment"></span>  UtoU(inputtype,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab2be21bd5eff40ca89c20eeecbeab5e0">UNOTHING</a>,ptrgeom,U,Ugeomfree);</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;  <span class="comment">// e.g. if REMOVERESTMASSFROMUU==1 and inputtype==UEVOLVE, then Ugeomfree has energy T^t_t that includes rest-mass</span></div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;<span class="preprocessor">#if(SPLITNPR)</span></div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;<span class="preprocessor"></span>  <span class="keywordflow">if</span>(!(<a class="code" href="../../d8/d5b/defs_8general_8h.html#af637e542453ec23c1a41a1038b223040">nprlist</a>[<a class="code" href="../../d8/d5b/defs_8general_8h.html#aa513122b9e25a436a0e98805e46961af" title="OPENMPNOTE: Ensure all pl&#39;s are set as private as required [only npr2interp and npr2notinterp changed...">nprstart</a>]==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a> &amp;&amp; <a class="code" href="../../d8/d5b/defs_8general_8h.html#af637e542453ec23c1a41a1038b223040">nprlist</a>[<a class="code" href="../../d8/d5b/defs_8general_8h.html#a11c2c3ace90a795cd7a910ac0a6256d2">nprend</a>]==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>)){</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;    <span class="comment">// then need to update field quantities since UtoU uses PLOOP not PALLLOOP -- GODMARK: could use PALLLOOP in UtoU, but then adds excessive code to phys.c related to SPLITNPR</span></div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a9afde1f1647e18e733406a1566b8b550">PLOOPBONLY</a>(pl) Ugeomfree[pl]=U[pl]/ptrgeom-&gt;e[pl];</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;  }</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;  <span class="comment">// Copy over Ugeomfree/pr to Ugeomfree0/pr0</span></div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;<span class="comment"></span>  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl){</div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;    Uold[pl]=Ugeomfree0[pl]=Ugeomfree[pl];</div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;    pr0[pl]=pr[pl];</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;  }</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;</div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;</div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;  <span class="comment">// convert U into form appropriate for inversion routine</span></div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;<span class="comment"></span>  convert_U_removerestmassfromuu(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a538f4ebe3434f76ec67690f0651b53e7">UTOPRIMVERSION</a>,<a class="code" href="../../da/d3e/definit_8h.html#af48e1348f10b3468e425c084365f5e64" title="which velocity to compute in (init can be anything (see init.c&#39;s for transformations)">REMOVERESTMASSFROMUU</a>,Ugeomfree);</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;  convert_U_removerestmassfromuu(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a538f4ebe3434f76ec67690f0651b53e7">UTOPRIMVERSION</a>,<a class="code" href="../../da/d3e/definit_8h.html#af48e1348f10b3468e425c084365f5e64" title="which velocity to compute in (init can be anything (see init.c&#39;s for transformations)">REMOVERESTMASSFROMUU</a>,Ugeomfree0);</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;  <span class="comment">// Setup which eomtype to use depending upon how got to this function</span></div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;<span class="comment"></span>  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fracenergy;</div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;  <span class="comment">//  if(nstep==4 &amp;&amp; steppart==0){</span></div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;  <span class="comment">//    PLOOP(pliter,pl) dualfprintf(fail_file,&quot;PRIMUTOPRIMGEN0(%d): pl=%d pp=%21.15g uu=%21.15g\n&quot;,*eomtype,pl,pr[pl],Ugeomfree[pl]);</span></div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;  <span class="comment">//  }</span></div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;  <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> didnothing=0,didsomething=0,didentropy=0,didenergy=0,didcold=0;</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a764cd8d9be62c23988abfe51e269f6d3">EOMDONOTHING</a>(*eomtype)){</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;    <span class="comment">// if finalstep==0, then don&#39;t do inversion.  If finalstep==1, only need to do inversion if ucum is different than final uf.</span></div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;    <span class="comment">// then do nothing since assume already pr=pr[U].</span></div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;    <span class="comment">// also don&#39;t change any failure flags, assuming prior flags are correct.</span></div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;    <span class="comment">// still can check inversion</span></div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;    <span class="keywordflow">if</span>(GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>)&lt;=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#abdf9e55b7b15ec0bcd386055f1787f47">UTOPRIMNOFAIL</a>){</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;      usedhotinversion=usedentropyinversion=usedcoldinversion=usedffdeinversion=0;</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;      <span class="keywordflow">if</span>(*eomtype==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a04d93d33dd8dba356800fa12cb80064e">EOMDIDGRMHD</a>) usedhotinversion=1;</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;      <span class="keywordflow">if</span>(*eomtype==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a74427604dbc716cea325f65f5c927662">EOMDIDENTROPYGRMHD</a>) usedentropyinversion=1;</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;      <span class="keywordflow">if</span>(*eomtype==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a32a2f53eca0d980049cee1dd4680aa00">EOMDIDCOLDGRMHD</a>) usedcoldinversion=1;</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;      <span class="keywordflow">if</span>(*eomtype==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3420955bd635f2316f19b5fbd2bf9377" title="whether relativistic or nonrelativistic EOMs (speed of light limitation)">EOMDIDFFDE</a>) usedffdeinversion=1;</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;      <span class="comment">// check cold inversion if inversion thinks it was successful</span></div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;      check_on_inversion(checkoninversiongas, checkoninversionrad, usedhotinversion,usedentropyinversion,usedcoldinversion,usedffdeinversion,&amp;GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>), pr0, pr, pressure, ptrgeom, Uold, Unew,newtonstats,&amp;GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>));</div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;    }</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a71b7c970651a395e2500645e74862abc">DOEVOLVERHO</a>){</div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;      negdensitycheck(finalstep, pr, &amp;GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>));</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;    }</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;    didnothing++;</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;    <span class="keywordflow">if</span>(debugfail&gt;=2) <span class="keywordflow">if</span>(didnothing%(<a class="code" href="../../dd/d46/mpidefs_8h.html#a38e1083345af2cf99e31d941f18b56ad">totalzones</a>*<a class="code" href="../../d1/d3e/utoprimgen_8c.html#a29c71c132c174c4a72d398ebfc197d62">REPORTCYCLE</a>)==0) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;DIDNOTHING: %lld : %ld %d : %d\n&quot;</span>,didnothing,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a1a1088d87617078680f1fd0f0d707384">nstep</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a70170b90229f9fc05eebf8508a685c70">steppart</a>,*eomtype);</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;    <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;  }</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;    <span class="comment">// setup default eomtype</span></div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;    <span class="keywordflow">if</span>(*eomtype==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aa28b06d889a02621b45edc716bfb2d01">EOMDEFAULT</a>) eomtypelocal=<a class="code" href="../../da/d3e/definit_8h.html#a87e5572748e4cc27373e50bd78e6f2e8">EOMTYPE</a>; <span class="comment">// use default</span></div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;    <span class="comment">// if did certain inversion on last sub-step, then assume want same inversion type (e.g. for finalstep==1 for TIMEORDER&gt;2 cases)</span></div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(*eomtype==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a04d93d33dd8dba356800fa12cb80064e">EOMDIDGRMHD</a>) eomtypelocal=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a03d89f51ab60206791830c886d62bfd0">EOMGRMHD</a>;</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(*eomtype==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a74427604dbc716cea325f65f5c927662">EOMDIDENTROPYGRMHD</a>) eomtypelocal=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a40b55e98bfcccde1a3f19d983ca7488c">EOMENTROPYGRMHD</a>;</div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(*eomtype==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a32a2f53eca0d980049cee1dd4680aa00">EOMDIDCOLDGRMHD</a>) eomtypelocal=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a757ad8b9c2c7611dad8aab853a87f61b">EOMCOLDGRMHD</a>;</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(*eomtype==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3420955bd635f2316f19b5fbd2bf9377" title="whether relativistic or nonrelativistic EOMs (speed of light limitation)">EOMDIDFFDE</a>) eomtypelocal=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6f6094bc467dc61f9490ad7e1de63580">EOMFFDE</a>;</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(*eomtype==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a74db521f4998f75d6ed72e6408d12ef4">EOMDIDFFDE2</a>) eomtypelocal=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a30a753538ac3bf4801ac123a37dfcc57">EOMFFDE2</a>;</div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;    <span class="keywordflow">else</span> eomtypelocal=*eomtype; <span class="comment">// force eomtype</span></div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;   </div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;    <span class="keywordflow">if</span>(whichmethod==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aef33cf4e6c2534137907bc2eaefdb224">MODEPICKBEST</a>){</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;      set_fracenergy(ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,dissmeasure, &amp;fracenergy);</div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;    }</div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;    <span class="keywordflow">else</span> fracenergy = (eomtypelocal==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a03d89f51ab60206791830c886d62bfd0">EOMGRMHD</a> ? 1.0 : 0.0);</div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;</div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;    <span class="keywordflow">if</span>(fracenergy&lt;=0.0 &amp;&amp; eomtypelocal==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a03d89f51ab60206791830c886d62bfd0">EOMGRMHD</a>) eomtypelocal=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a40b55e98bfcccde1a3f19d983ca7488c">EOMENTROPYGRMHD</a>; <span class="comment">// start with entropy</span></div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;    <span class="keywordflow">if</span>(fracenergy&gt;0.0 &amp;&amp; eomtypelocal==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a40b55e98bfcccde1a3f19d983ca7488c">EOMENTROPYGRMHD</a>) eomtypelocal=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a03d89f51ab60206791830c886d62bfd0">EOMGRMHD</a>; <span class="comment">// start with hot</span></div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160; </div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;    <span class="keywordflow">if</span>(eomtypelocal==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a03d89f51ab60206791830c886d62bfd0">EOMGRMHD</a>) didenergy++;</div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;    <span class="keywordflow">if</span>(eomtypelocal==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a40b55e98bfcccde1a3f19d983ca7488c">EOMENTROPYGRMHD</a>) didentropy++;</div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;    <span class="keywordflow">if</span>(eomtypelocal==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a757ad8b9c2c7611dad8aab853a87f61b">EOMCOLDGRMHD</a>) didcold++;</div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;</div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;    didsomething++;</div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;    <span class="keywordflow">if</span>(debugfail&gt;=2) <span class="keywordflow">if</span>(didsomething%(<a class="code" href="../../dd/d46/mpidefs_8h.html#a38e1083345af2cf99e31d941f18b56ad">totalzones</a>*<a class="code" href="../../d1/d3e/utoprimgen_8c.html#a29c71c132c174c4a72d398ebfc197d62">REPORTCYCLE</a>)==0) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;DIDSOMETHING: %lld : %ld %d : eomtype=%d -&gt; eomtypelocal=%d : dids: %lld %lld %lld\n&quot;</span>,didsomething,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a1a1088d87617078680f1fd0f0d707384">nstep</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a70170b90229f9fc05eebf8508a685c70">steppart</a>,*eomtype,eomtypelocal,didenergy,didentropy,didcold);</div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;  }</div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;</div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;</div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;</div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;</div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;</div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;</div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;</div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;  <span class="comment">// START INVERSION PROCESS</span></div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;</div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;</div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;</div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;</div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;</div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;</div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;</div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;</div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;</div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;  <span class="comment">// backup (in inversion routine format with already-inverted scalars)</span></div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;<span class="comment"></span>  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl){</div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;    Uold[pl]=Ugeomfree0[pl]=Ugeomfree[pl];</div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;    pr0[pl]=pr[pl];</div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;  }</div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;  </div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;</div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;</div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;</div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;</div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;</div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;</div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;</div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;  <span class="comment">// DO non-scalar INVERSION (from here after, only modify RHO,UU,U1,U2,U3,B1,B2,B3.  Any initial guess should be using pr0 that contains other interpolated quantities.)</span></div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;  <span class="comment">// defaults</span></div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;  usedhotinversion=0;</div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;  usedentropyinversion=0;</div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;  usedcoldinversion=0;</div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;  usedffdeinversion=0;</div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;</div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;</div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;  <span class="comment">// if some process already set fail flag (e.g. inversions somewhere else that wasn&#39;t reset) (e.g. like in phys.tools.rad.c for implicit or explicit solvers with radiation), then assume want to treat as failure for purposes of fixing up.  That is, get inversion, but that inversion will be for undefined 4-force and only used in worst-case scenario for fixups.</span></div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;  <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> preexistingfailgas=0;</div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;  <span class="keywordflow">if</span>(GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>)&gt;<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#abdf9e55b7b15ec0bcd386055f1787f47">UTOPRIMNOFAIL</a>) preexistingfailgas=GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>);</div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;</div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;  <span class="comment">// Also see if radiation inversion got locally corrected.  Then, might still do better to do multi-point averaging in fixups like with MHD variables.  So capture this flag for fixups.</span></div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;  <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> preexistingfailrad=0;</div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;  <span class="keywordflow">if</span>(GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>)&gt;<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6435e9609d622c9dbaf78c12658ecf8e">UTOPRIMRADNOFAIL</a>) preexistingfailrad=GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>);</div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;</div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;</div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;</div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;</div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;</div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;  <span class="keywordtype">int</span> entropytried=0,hottried=0,coldtried=0,ffdetried=0;</div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;  <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> entropypflag=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a15839e328562c450366075b401aa700a">UTOPRIMFAILGENERIC</a>,hotpflag=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a15839e328562c450366075b401aa700a">UTOPRIMFAILGENERIC</a>,coldpflag=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a15839e328562c450366075b401aa700a">UTOPRIMFAILGENERIC</a>,ffdepflag=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a15839e328562c450366075b401aa700a">UTOPRIMFAILGENERIC</a>;</div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;  <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> entropyradinvmod=1,hotradinvmod=1,coldradinvmod=1,ffderadinvmod=1;</div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;  <span class="keywordtype">int</span> entropyhardfailure=1,hothardfailure=1,coldhardfailure=1,ffdehardfailure=1;</div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> entropypr[NPR],hotpr[NPR],coldpr[NPR],ffdepr[NPR];</div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;</div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;</div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;</div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;</div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;</div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;</div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;  <span class="keywordflow">if</span>(eomtypelocal==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a03d89f51ab60206791830c886d62bfd0">EOMGRMHD</a>){</div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;</div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;</div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;<span class="comment"></span>    <span class="comment">//</span></div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;    <span class="comment">// report back that used this</span></div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;    *eomtype=eomtypelocal;</div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;</div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;    <span class="comment">// If just using pr/pr0 for guess, then fixup</span></div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;<span class="comment"></span>    <span class="keywordflow">if</span>(<a class="code" href="../../d1/d3e/utoprimgen_8c.html#a3a8adda834dd0777f2230a3d2dca2aba" title="whether to fix u_g using entropy conserved quantity, if available.">ENTROPYFIXGUESSEXTERNAL</a> &amp;&amp; modprim==1){</div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;      <span class="comment">// qptr is not final qptr, just previous from &quot;pi&quot; or at best &quot;pb&quot;</span></div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;      entropyfixguess(qptr, ptrgeom, Ugeomfree, pr);</div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;      <span class="comment">// also get highest out of current &quot;flux&quot; and &quot;initial&quot; step parts.</span></div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;      pr[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(fabs(pr[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]),fabs(pi[UU]));</div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;    }</div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;</div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;</div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;    <span class="comment">// Inversion call</span></div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;    hottried=1;</div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a538f4ebe3434f76ec67690f0651b53e7">UTOPRIMVERSION</a>!=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#adb9c446faff8c17b8cc642e79d19ae70" title="100: use 5D, but compare with ldz in runtime">UTOPRIMCOMPARE</a>) <a class="code" href="../../d1/d3e/utoprimgen_8c.html#a0a83e9e7fdd3cc595c5b8d0df88ec684" title="just picks the algorithm to invert">Utoprimgen_pick</a>(showmessages, allowlocalfailurefixandnoreport, <a class="code" href="../../d8/d5b/defs_8general_8h.html#a538f4ebe3434f76ec67690f0651b53e7">UTOPRIMVERSION</a>, eomtypelocal, whichcap, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a4a02957480e290a978d1f29992125c15" title="for WHICHENTROPYEVOLVE">EVOLVENOENTROPY</a>, Ugeomfree, ptrgeom, &amp;GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>), pr,pressure,newtonstats,&amp;GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>));</div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;    <span class="keywordflow">else</span> Utoprimgen_compare(showmessages, allowlocalfailurefixandnoreport, eomtypelocal, whichcap, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a4a02957480e290a978d1f29992125c15" title="for WHICHENTROPYEVOLVE">EVOLVENOENTROPY</a>,Ugeomfree,ptrgeom, &amp;GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>), pr,pressure,newtonstats,&amp;GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>));</div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;</div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;</div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;    <span class="comment">// try other methods (assumes all methods can handle WHICHVEL, etc. used for primary model)</span></div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;    <span class="comment">// right now, all can handle WHICHVEL==VELREL4 and energy equation evolution and REMOVERESTMASSFROMUU=0,1</span></div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;<span class="preprocessor">#if((WHICHVEL==VELREL4)&amp;&amp;(REMOVERESTMASSFROMUU&lt;=1)&amp;&amp;(UTOPRIMTRYAGAIN))</span></div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;<span class="preprocessor"></span>    Utoprimgen_tryagain(showmessages, allowlocalfailurefixandnoreport, eomtypelocal, whichcap, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a4a02957480e290a978d1f29992125c15" title="for WHICHENTROPYEVOLVE">EVOLVENOENTROPY</a>, Ugeomfree0, Ugeomfree, ptrgeom, &amp;GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>), pr0, pr,pressure,newtonstats,&amp;GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>));</div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;<span class="preprocessor">#elif((WHICHVEL==VELREL4)&amp;&amp;(REMOVERESTMASSFROMUU==2)&amp;&amp;(UTOPRIMTRYAGAIN))</span></div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;<span class="preprocessor"></span>    <span class="comment">// Can only try again using same type of U since tryagain code doesn&#39;t convert U </span></div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;    Utoprimgen_tryagain2(showmessages, allowlocalfailurefixandnoreport, eomtypelocal, whichcap, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a4a02957480e290a978d1f29992125c15" title="for WHICHENTROPYEVOLVE">EVOLVENOENTROPY</a>, Ugeomfree0, Ugeomfree, ptrgeom, &amp;GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>), pr0, pr,pressure,newtonstats,&amp;GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>));</div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;<span class="preprocessor"></span>    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) hotpr[pl]=pr[pl]; <span class="comment">// save hotpr</span></div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;</div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;</div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;    <span class="comment">// get failure flag</span></div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;    hotpflag=GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>);</div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;    hotradinvmod=GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>);</div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;    hothardfailure=(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0894a5e6c53e2e8a143d10be7a42d492">IFUTOPRIMFAIL</a>(hotpflag) &amp;&amp; <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a294c90ee60024e6f3548814e7ff10a41">IFUTOPRIMFAILSOFT</a>(hotpflag)==0);</div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;</div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;    <span class="keywordflow">if</span>(!hothardfailure){</div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;      <span class="comment">// report back that used this</span></div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;      *eomtype=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a03d89f51ab60206791830c886d62bfd0">EOMGRMHD</a>;</div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;</div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;      usedhotinversion=1;</div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;      usedentropyinversion=0;</div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;      usedcoldinversion=0;</div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;      usedffdeinversion=0;</div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;      <span class="comment">// check on hot inversion if it thinks it was successful</span></div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;      check_on_inversion(checkoninversiongas, checkoninversionrad, usedhotinversion,usedentropyinversion,usedcoldinversion,usedffdeinversion,&amp;GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>), pr0, pr, pressure, ptrgeom, Uold, Unew,newtonstats,&amp;GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>));</div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;</div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;      <span class="comment">// adjust failure flag if check on inversion found issue</span></div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;      hotpflag=GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>);</div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;      hotradinvmod=GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>);</div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;      hothardfailure=(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0894a5e6c53e2e8a143d10be7a42d492">IFUTOPRIMFAIL</a>(hotpflag) &amp;&amp; <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a294c90ee60024e6f3548814e7ff10a41">IFUTOPRIMFAILSOFT</a>(hotpflag)==0);</div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;</div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;    }</div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;    </div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;</div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;    <span class="comment">// normally don&#39;t ever do this unless really debugging inversion.</span></div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;    <span class="keywordflow">if</span>(0&amp;&amp;debugfail&gt;=2&amp;&amp;hothardfailure){ <span class="comment">// DEBUG: only report if hard failure.  Seems when gets negative density or internal energy, jon&#39;s inversion is fine.</span></div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;      <span class="comment">// first report info so can check on inversion</span></div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;      <span class="keyword">extern</span> <span class="keywordtype">int</span> mathematica_report_check(<span class="keywordtype">int</span> radinvmod, <span class="keywordtype">int</span> failtype, <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> failnum, <span class="keywordtype">int</span> gotfirstnofail, <span class="keywordtype">int</span> eomtypelocal, <span class="keywordtype">int</span> itermode, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> errorabs, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> errorabsbestexternal, <span class="keywordtype">int</span> iters, <span class="keywordtype">int</span> iterstotal, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> realdt,<span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *ppfirst, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pp, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pb, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *piin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *prtestUiin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *prtestUU0, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *uu0, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *uu, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Uiin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ufin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUf, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *q, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *dUother);</div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;      <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> failnum=0;</div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fakedt=0.0; <span class="comment">// since no 4-force</span></div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fakeCUf[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab17e7e66eb2bc86b9d61d6bb61a0a4a3" title="NUMDTCUFS also includes what&#39;s necessary for IMEX.">NUMDTCUFS</a>]={0}; <span class="comment">// fake</span></div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dUother[NPR]={0};<span class="comment">// fake</span></div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;      <span class="comment">//      struct of_state *qptr=NULL; // fake</span></div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;      failnum++;</div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;      <span class="comment">// fake ppfirst as pr</span></div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;      mathematica_report_check(0, 2, failnum, (<span class="keywordtype">int</span>)hotpflag, eomtypelocal, 0, 0.0, 0.0, -1, -1, fakedt, ptrgeom, pr, pr, pr, pr0, pr0, pr0, Ugeomfree0, Ugeomfree, Ugeomfree0, Ugeomfree0, fakeCUf, qptr, dUother);</div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;    }</div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;</div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;</div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;    <span class="comment">// If hot GRMHD failed or gets suspicious solution, revert to entropy GRMHD if solution</span></div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;    <span class="comment">// If radiation, then this redoes radiation inversion since entropy would give new velocity and local corrections in u2p_rad() might use velocity.</span></div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;<span class="comment"></span>    <span class="comment">//    int forcetryentropy=(whichmethod==MODEPICKBEST &amp;&amp; fracenergy!=1.0 || hotpflag&gt;0 &amp;&amp; whichmethod==MODEPICKBEST &amp;&amp; fracenergy!=1.0);</span></div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;    <span class="keywordtype">int</span> forcetryentropy=0; <span class="comment">// force</span></div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;    <span class="comment">//   if(HOT2ENTROPY &amp;&amp; (hotpflag&gt;0 &amp;&amp; whichmethod==MODEPICKREVERT || forcetryentropy)){</span></div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#a264372993369f0319459c6948ad8b74a" title="whether to try entropy inversion if hot fails">HOT2ENTROPY</a> &amp;&amp; <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a246f2e1318d06bf1dfb9f1dcaaea9b46">HOTANYFAIL</a>(hotpflag)){</div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;</div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;      entropytried=tryentropyinversion(showmessages, allowlocalfailurefixandnoreport,finalstep, hotpflag, forcetryentropy, whichcap, modprim, pi, pr0, pr, pressure, Ugeomfree, Ugeomfree0, qptr, ptrgeom,newtonstats,&amp;GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>));</div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) entropypr[pl]=pr[pl]; <span class="comment">// save entropypr</span></div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;      <span class="keywordflow">if</span>(entropytried){</div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;</div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;        <span class="comment">// get failure flag</span></div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;        entropypflag=GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>);</div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;        entropyradinvmod=GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>);</div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;        entropyhardfailure=(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0894a5e6c53e2e8a143d10be7a42d492">IFUTOPRIMFAIL</a>(entropypflag) &amp;&amp; <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a294c90ee60024e6f3548814e7ff10a41">IFUTOPRIMFAILSOFT</a>(entropypflag)==0);</div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;</div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;        <span class="keywordflow">if</span>(!entropyhardfailure){</div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;          <span class="comment">// report back that used this</span></div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;          *eomtype=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a40b55e98bfcccde1a3f19d983ca7488c">EOMENTROPYGRMHD</a>;</div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;        </div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;          usedhotinversion=0;</div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;          usedentropyinversion=1;</div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;          usedcoldinversion=0;</div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;          usedffdeinversion=0;</div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;        </div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;          <span class="comment">// check entropy inversion if inversion thinks it was successful</span></div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;          check_on_inversion(checkoninversiongas, checkoninversionrad, usedhotinversion,usedentropyinversion,usedcoldinversion,usedffdeinversion,&amp;GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>), pr0, pr, pressure, ptrgeom, Uold, Unew,newtonstats,&amp;GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>));</div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;</div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;          <span class="comment">// adjust failure flag</span></div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;          entropypflag=GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>);</div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;          entropyradinvmod=GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>);</div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;          entropyhardfailure=(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0894a5e6c53e2e8a143d10be7a42d492">IFUTOPRIMFAIL</a>(entropypflag) &amp;&amp; <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a294c90ee60024e6f3548814e7ff10a41">IFUTOPRIMFAILSOFT</a>(entropypflag)==0);</div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;        }</div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;      }</div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;      </div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;    }</div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;    <span class="keywordflow">else</span> entropypflag=1;</div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;</div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;</div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;</div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;    <span class="comment">//  If hot GRMHD failed or gets suspicious solution, revert to cold GRMHD if solution is cold</span></div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;<span class="comment"></span>    <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#a730f39620772fefb25012f52421bbff2" title="whether to try cold inversion if hot fails (only used if cold makes sense)">HOT2COLD</a> &amp;&amp; (<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a32110521c8189d451db71368a8248d6b">ENTROPYANYFAIL</a>(entropypflag) &amp;&amp; <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a246f2e1318d06bf1dfb9f1dcaaea9b46">HOTANYFAIL</a>(hotpflag)) ){</div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;</div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;      coldtried=trycoldinversion(showmessages, allowlocalfailurefixandnoreport,finalstep, hotpflag, 0, whichcap, modprim, pi, pr0, pr, pressure, Ugeomfree, Ugeomfree0, qptr, ptrgeom,newtonstats,&amp;GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>));</div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) coldpr[pl]=pr[pl]; <span class="comment">// save coldpr</span></div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;      <span class="keywordflow">if</span>(coldtried){</div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;</div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;        <span class="comment">// get failure flag</span></div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;        coldpflag=GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>);</div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;        coldradinvmod=GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>);</div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;        coldhardfailure=(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0894a5e6c53e2e8a143d10be7a42d492">IFUTOPRIMFAIL</a>(coldpflag) &amp;&amp; <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a294c90ee60024e6f3548814e7ff10a41">IFUTOPRIMFAILSOFT</a>(coldpflag)==0);</div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;</div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;        <span class="keywordflow">if</span>(!coldhardfailure){</div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;          usedhotinversion=0;</div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;          usedentropyinversion=0;</div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;          usedcoldinversion=1;</div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;          usedffdeinversion=0;</div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;        </div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;          <span class="comment">// report back that used this</span></div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;          *eomtype=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a757ad8b9c2c7611dad8aab853a87f61b">EOMCOLDGRMHD</a>;</div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;        </div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;          <span class="comment">// check cold inversion if inversion thinks it was successful</span></div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;          check_on_inversion(checkoninversiongas, checkoninversionrad, usedhotinversion,usedentropyinversion,usedcoldinversion,usedffdeinversion,&amp;GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>), pr0, pr, pressure, ptrgeom, Uold, Unew,newtonstats,&amp;GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>));</div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;</div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;          <span class="comment">// adjust failure flag</span></div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;          coldpflag=GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>);</div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;          coldradinvmod=GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>);</div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;          coldhardfailure=(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0894a5e6c53e2e8a143d10be7a42d492">IFUTOPRIMFAIL</a>(coldpflag) &amp;&amp; <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a294c90ee60024e6f3548814e7ff10a41">IFUTOPRIMFAILSOFT</a>(coldpflag)==0);</div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;        }</div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;      }</div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;</div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;    }</div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;    <span class="keywordflow">else</span> coldpflag=1;</div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;</div>
<div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;</div>
<div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;    <span class="comment">//  If hot GRMHD failed or gets suspicious solution, revert to FFDE GRMHD if solution is FFDE</span></div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;<span class="comment"></span>    <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#adc2841f2b50183a0dc6b8ca819fe57d0" title="whether to try FFDE inversion if hot fails (only used if FFDE makes sense)">HOT2FFDE</a> &amp;&amp; (<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#adcfc55da37bd6e82e506046aca203365">COLDANYFAIL</a>(coldpflag) &amp;&amp; <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a32110521c8189d451db71368a8248d6b">ENTROPYANYFAIL</a>(entropypflag) &amp;&amp; <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a246f2e1318d06bf1dfb9f1dcaaea9b46">HOTANYFAIL</a>(hotpflag)) ){</div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;</div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;      ffdetried=tryffdeinversion(showmessages, allowlocalfailurefixandnoreport,finalstep, hotpflag, 0, whichcap, modprim, pi, pr0, pr, pressure, Ugeomfree, Ugeomfree0, qptr, ptrgeom,newtonstats,&amp;GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>));</div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) ffdepr[pl]=pr[pl]; <span class="comment">// save ffdepr</span></div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;      <span class="keywordflow">if</span>(ffdetried){</div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;</div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;        <span class="comment">// get failure flag</span></div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;        ffdepflag=GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>);</div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;        ffderadinvmod=GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>);</div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;        ffdehardfailure=(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0894a5e6c53e2e8a143d10be7a42d492">IFUTOPRIMFAIL</a>(ffdepflag) &amp;&amp; <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a294c90ee60024e6f3548814e7ff10a41">IFUTOPRIMFAILSOFT</a>(ffdepflag)==0);</div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;</div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;        <span class="keywordflow">if</span>(!ffdehardfailure){</div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;          usedhotinversion=0;</div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;          usedentropyinversion=0;</div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;          usedcoldinversion=0;</div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;          usedffdeinversion=1;</div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;        </div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;          <span class="comment">// report back that used this</span></div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;          *eomtype=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6f6094bc467dc61f9490ad7e1de63580">EOMFFDE</a>;</div>
<div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;        </div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;          <span class="comment">// check ffde inversion if inversion thinks it was successful</span></div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;          check_on_inversion(checkoninversiongas, checkoninversionrad, usedhotinversion,usedentropyinversion,usedcoldinversion,usedffdeinversion,&amp;GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>), pr0, pr, pressure, ptrgeom, Uold, Unew,newtonstats,&amp;GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>));</div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;</div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;          <span class="comment">// adjust failure flag</span></div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;          ffdepflag=GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>);</div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;          ffderadinvmod=GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>);</div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;          ffdehardfailure=(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0894a5e6c53e2e8a143d10be7a42d492">IFUTOPRIMFAIL</a>(ffdepflag) &amp;&amp; <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a294c90ee60024e6f3548814e7ff10a41">IFUTOPRIMFAILSOFT</a>(ffdepflag)==0);</div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;        }</div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;      }</div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;</div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;    }</div>
<div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;    <span class="keywordflow">else</span> ffdepflag=1;</div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;</div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;</div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;</div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;</div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;  }</div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(eomtypelocal==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a40b55e98bfcccde1a3f19d983ca7488c">EOMENTROPYGRMHD</a>){</div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;<span class="comment"></span>    <span class="comment">//</span></div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;    <span class="comment">// direct entropy evolution (can use old Utoprim() or new code, but not all codes have entropy inversion)</span></div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;    <span class="comment">// report back that used this</span></div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;    *eomtype=eomtypelocal;</div>
<div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;</div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;    <span class="comment">// If just using pr/pr0 for guess, then fixup</span></div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;<span class="comment"></span>    <span class="keywordflow">if</span>(<a class="code" href="../../d1/d3e/utoprimgen_8c.html#a3a8adda834dd0777f2230a3d2dca2aba" title="whether to fix u_g using entropy conserved quantity, if available.">ENTROPYFIXGUESSEXTERNAL</a> &amp;&amp; modprim==1){</div>
<div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;      <span class="comment">// qptr is not final qptr, just previous from &quot;pi&quot; or at best &quot;pb&quot;</span></div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;      entropyfixguess(qptr, ptrgeom, Ugeomfree, pr);</div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;      <span class="comment">// also get highest out of current &quot;flux&quot; and &quot;initial&quot; step parts.</span></div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;      pr[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(fabs(pr[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]),fabs(pi[UU]));</div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;    }</div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;</div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;</div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;    <span class="comment">// INVERSION</span></div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;    entropytried=1;</div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;    <span class="comment">// setup as if full entropy evolution</span></div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;    whichentropy=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a437fe144346575df3a2aaaab1b3856b2">EVOLVEFULLENTROPY</a>;</div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;    <span class="comment">// get entropy evolution inversion</span></div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;    <a class="code" href="../../d1/d3e/utoprimgen_8c.html#a0a83e9e7fdd3cc595c5b8d0df88ec684" title="just picks the algorithm to invert">Utoprimgen_pick</a>(showmessages, allowlocalfailurefixandnoreport, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#abeac8c89d7fa922563d79f9278b4d44d" title="8: Jon 1D/2D final version  can handle non-rel problems">UTOPRIMJONNONRELCOMPAT</a>, eomtypelocal, whichcap, whichentropy, Ugeomfree, ptrgeom, &amp;GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>), pr,pressure,newtonstats,&amp;GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>));</div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) entropypr[pl]=pr[pl]; <span class="comment">// save entropypr</span></div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;</div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;    <span class="comment">// get failure flag</span></div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;    entropypflag=GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>);</div>
<div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;    entropyradinvmod=GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>);</div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;    entropyhardfailure=(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0894a5e6c53e2e8a143d10be7a42d492">IFUTOPRIMFAIL</a>(entropypflag) &amp;&amp; <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a294c90ee60024e6f3548814e7ff10a41">IFUTOPRIMFAILSOFT</a>(entropypflag)==0);</div>
<div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;</div>
<div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;    <span class="keywordflow">if</span>(!entropyhardfailure){</div>
<div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;</div>
<div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;      <span class="comment">// report back that used this</span></div>
<div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;      *eomtype=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a40b55e98bfcccde1a3f19d983ca7488c">EOMENTROPYGRMHD</a>;</div>
<div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;</div>
<div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;      usedhotinversion=0;</div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;      usedentropyinversion=1;</div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;      usedcoldinversion=0;</div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;      usedffdeinversion=0;</div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;      <span class="comment">// check entropy inversion</span></div>
<div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;      check_on_inversion(checkoninversiongas, checkoninversionrad, usedhotinversion,usedentropyinversion,usedcoldinversion,usedffdeinversion,&amp;GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>), pr0, pr, pressure, ptrgeom, Uold, Unew,newtonstats,&amp;GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>));</div>
<div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;</div>
<div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;      <span class="comment">// adjust failure flag</span></div>
<div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;      entropypflag=GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>);</div>
<div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;      entropyradinvmod=GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>);</div>
<div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;      entropyhardfailure=(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0894a5e6c53e2e8a143d10be7a42d492">IFUTOPRIMFAIL</a>(entropypflag) &amp;&amp; <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a294c90ee60024e6f3548814e7ff10a41">IFUTOPRIMFAILSOFT</a>(entropypflag)==0);</div>
<div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;    }</div>
<div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;</div>
<div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;</div>
<div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;</div>
<div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;    <span class="comment">//  If entropy GRMHD failed or gets suspicious solution, revert to hot GRMHD</span></div>
<div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;<span class="comment"></span>    <span class="comment">//    if(ENTROPY2HOT &amp;&amp; (entropypflag&gt;0 &amp;&amp; whichmethod==MODEPICKREVERT || (whichmethod==MODEPICKBEST))){</span></div>
<div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;    <span class="comment">// below is consistent with hot entropy forced when fracenergy=0.0 as long as entropy didn&#39;t fail to invert.</span></div>
<div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;    <span class="comment">// int forcetryhot = (whichmethod==MODEPICKBEST)&amp;&amp;(entropypflag&gt;0&amp;&amp;fracenergy==0.0 || fracenergy!=0.0);</span></div>
<div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;    <span class="comment">// override since not using fracenergy approach and above seems wrong</span></div>
<div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;    <span class="keywordtype">int</span> forcetryhot=0;</div>
<div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;    <span class="comment">//    if(ENTROPY2HOT &amp;&amp; (entropypflag&gt;0 &amp;&amp; whichmethod==MODEPICKREVERT || forcetryhot)){</span></div>
<div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#a02f1134656e7f406c0a2eb49987eb53a" title="whether to try HOT inversion if entropy fails">ENTROPY2HOT</a> &amp;&amp; <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a32110521c8189d451db71368a8248d6b">ENTROPYANYFAIL</a>(entropypflag)){</div>
<div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;</div>
<div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;      hottried=tryhotinversion(showmessages, allowlocalfailurefixandnoreport,finalstep, entropypflag, forcetryhot, whichcap, modprim, pi, pr0, pr, pressure, Ugeomfree, Ugeomfree0, qptr, ptrgeom,newtonstats,&amp;GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>));</div>
<div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) hotpr[pl]=pr[pl]; <span class="comment">// save hotpr</span></div>
<div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;      <span class="keywordflow">if</span>(hottried){</div>
<div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;        </div>
<div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;        <span class="comment">// get failure flag</span></div>
<div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;        hotpflag=GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>);</div>
<div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;        hotradinvmod=GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>);</div>
<div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;        hothardfailure=(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0894a5e6c53e2e8a143d10be7a42d492">IFUTOPRIMFAIL</a>(hotpflag) &amp;&amp; <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a294c90ee60024e6f3548814e7ff10a41">IFUTOPRIMFAILSOFT</a>(hotpflag)==0);</div>
<div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;</div>
<div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;        <span class="keywordflow">if</span>(!hothardfailure){</div>
<div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;          </div>
<div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;          <span class="comment">// report back that used this</span></div>
<div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;          *eomtype=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a03d89f51ab60206791830c886d62bfd0">EOMGRMHD</a>;</div>
<div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;          </div>
<div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;          <span class="comment">// check on hot inversion if it thinks it was successful</span></div>
<div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;          usedhotinversion=1;</div>
<div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;          usedentropyinversion=0;</div>
<div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;          usedcoldinversion=0;</div>
<div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;          usedffdeinversion=0;</div>
<div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;          <span class="comment">// check on hot inversion</span></div>
<div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;          check_on_inversion(checkoninversiongas, checkoninversionrad, usedhotinversion,usedentropyinversion,usedcoldinversion,usedffdeinversion,&amp;GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>), pr0, pr, pressure, ptrgeom, Uold, Unew,newtonstats,&amp;GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>));</div>
<div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;</div>
<div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;          <span class="comment">// adjust failure flag</span></div>
<div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;          hotpflag=GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>);</div>
<div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;          hotradinvmod=GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>);</div>
<div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;          hothardfailure=(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0894a5e6c53e2e8a143d10be7a42d492">IFUTOPRIMFAIL</a>(hotpflag) &amp;&amp; <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a294c90ee60024e6f3548814e7ff10a41">IFUTOPRIMFAILSOFT</a>(hotpflag)==0);</div>
<div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;        }</div>
<div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;      }</div>
<div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;</div>
<div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;    }</div>
<div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;    <span class="keywordflow">else</span> hotpflag=1;</div>
<div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;</div>
<div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;</div>
<div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;    <span class="comment">//  If entropy GRMHD failed or gets suspicious solution, revert to cold GRMHD if solution is cold</span></div>
<div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;    <span class="comment">//  This is the same trycoldinversion() as for HOT2COLD</span></div>
<div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;<span class="comment"></span>    <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#a867e316620aa54d73902beab2d8c08cc" title="whether to try cold inversion if entropy fails">ENTROPY2COLD</a> &amp;&amp; (<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a32110521c8189d451db71368a8248d6b">ENTROPYANYFAIL</a>(entropypflag) &amp;&amp; <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a246f2e1318d06bf1dfb9f1dcaaea9b46">HOTANYFAIL</a>(hotpflag)) ){</div>
<div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;      coldtried=trycoldinversion(showmessages, allowlocalfailurefixandnoreport,finalstep, entropypflag, 0, whichcap, modprim, pi, pr0, pr, pressure, Ugeomfree, Ugeomfree0, qptr, ptrgeom,newtonstats,&amp;GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>));</div>
<div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) coldpr[pl]=pr[pl]; <span class="comment">// save coldpr</span></div>
<div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;</div>
<div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;      <span class="keywordflow">if</span>(coldtried){</div>
<div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;</div>
<div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;        <span class="comment">// get failure flag</span></div>
<div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;        coldpflag=GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>);</div>
<div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;        coldradinvmod=GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>);</div>
<div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;        coldhardfailure=(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0894a5e6c53e2e8a143d10be7a42d492">IFUTOPRIMFAIL</a>(coldpflag) &amp;&amp; <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a294c90ee60024e6f3548814e7ff10a41">IFUTOPRIMFAILSOFT</a>(coldpflag)==0);</div>
<div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;</div>
<div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;        <span class="keywordflow">if</span>(!coldhardfailure){</div>
<div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;          <span class="comment">// report back that used this</span></div>
<div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;          *eomtype=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a757ad8b9c2c7611dad8aab853a87f61b">EOMCOLDGRMHD</a>;</div>
<div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;</div>
<div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;          usedhotinversion=0;</div>
<div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;          usedentropyinversion=0;</div>
<div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;          usedcoldinversion=1;</div>
<div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;          usedffdeinversion=0;</div>
<div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;</div>
<div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;          <span class="comment">// check cold inversion</span></div>
<div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;          check_on_inversion(checkoninversiongas, checkoninversionrad, usedhotinversion,usedentropyinversion,usedcoldinversion,usedffdeinversion,&amp;GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>), pr0, pr, pressure, ptrgeom, Uold, Unew,newtonstats,&amp;GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>));</div>
<div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;</div>
<div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;          <span class="comment">// adjust failure</span></div>
<div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;          coldpflag=GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>);</div>
<div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;          coldradinvmod=GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>);</div>
<div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;          coldhardfailure=(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0894a5e6c53e2e8a143d10be7a42d492">IFUTOPRIMFAIL</a>(coldpflag) &amp;&amp; <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a294c90ee60024e6f3548814e7ff10a41">IFUTOPRIMFAILSOFT</a>(coldpflag)==0);</div>
<div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;        }</div>
<div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;      }</div>
<div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;    }</div>
<div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;    <span class="keywordflow">else</span> coldpflag=1;</div>
<div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;</div>
<div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;</div>
<div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;    <span class="comment">//  If entropy GRMHD failed or gets suspicious solution, revert to FFDE GRMHD if solution is FFDE</span></div>
<div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;<span class="comment"></span>    <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#a3fc6b60f416d6e59dfe591e1ea7bf2fa" title="whether to try FFDE inversion if entropy fails (only used if FFDE makes sense)">ENTROPY2FFDE</a> &amp;&amp; (<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#adcfc55da37bd6e82e506046aca203365">COLDANYFAIL</a>(coldpflag) &amp;&amp; <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a32110521c8189d451db71368a8248d6b">ENTROPYANYFAIL</a>(entropypflag) &amp;&amp; <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a246f2e1318d06bf1dfb9f1dcaaea9b46">HOTANYFAIL</a>(hotpflag)) ){</div>
<div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;</div>
<div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;      ffdetried=tryffdeinversion(showmessages, allowlocalfailurefixandnoreport,finalstep, entropypflag, 0, whichcap, modprim, pi, pr0, pr, pressure, Ugeomfree, Ugeomfree0, qptr, ptrgeom,newtonstats,&amp;GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>));</div>
<div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) ffdepr[pl]=pr[pl]; <span class="comment">// save ffdepr</span></div>
<div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;</div>
<div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;      <span class="keywordflow">if</span>(ffdetried){</div>
<div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;</div>
<div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;        <span class="comment">// get failure flag</span></div>
<div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;        ffdepflag=GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>);</div>
<div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;        ffderadinvmod=GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>);</div>
<div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;        ffdehardfailure=(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0894a5e6c53e2e8a143d10be7a42d492">IFUTOPRIMFAIL</a>(ffdepflag) &amp;&amp; <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a294c90ee60024e6f3548814e7ff10a41">IFUTOPRIMFAILSOFT</a>(ffdepflag)==0);</div>
<div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;</div>
<div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;        <span class="keywordflow">if</span>(!ffdehardfailure){</div>
<div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;          usedhotinversion=0;</div>
<div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;          usedentropyinversion=0;</div>
<div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;          usedcoldinversion=0;</div>
<div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;          usedffdeinversion=1;</div>
<div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;        </div>
<div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;          <span class="comment">// report back that used this</span></div>
<div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;          *eomtype=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6f6094bc467dc61f9490ad7e1de63580">EOMFFDE</a>;</div>
<div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;        </div>
<div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;          <span class="comment">// check ffde inversion if inversion thinks it was successful</span></div>
<div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;          check_on_inversion(checkoninversiongas, checkoninversionrad, usedhotinversion,usedentropyinversion,usedcoldinversion,usedffdeinversion,&amp;GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>), pr0, pr, pressure, ptrgeom, Uold, Unew,newtonstats,&amp;GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>));</div>
<div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;</div>
<div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;          <span class="comment">// adjust failure flag</span></div>
<div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;          ffdepflag=GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>);</div>
<div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;          ffderadinvmod=GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>);</div>
<div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;          ffdehardfailure=(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0894a5e6c53e2e8a143d10be7a42d492">IFUTOPRIMFAIL</a>(ffdepflag) &amp;&amp; <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a294c90ee60024e6f3548814e7ff10a41">IFUTOPRIMFAILSOFT</a>(ffdepflag)==0);</div>
<div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;        }</div>
<div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;      }</div>
<div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;    }</div>
<div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;    <span class="keywordflow">else</span> ffdepflag=1;</div>
<div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;</div>
<div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;</div>
<div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;    </div>
<div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;  }</div>
<div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(eomtypelocal==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a757ad8b9c2c7611dad8aab853a87f61b">EOMCOLDGRMHD</a>){</div>
<div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;<span class="comment"></span>    <span class="comment">//</span></div>
<div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;    <span class="comment">// report back that used this</span></div>
<div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;    *eomtype=eomtypelocal;</div>
<div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;</div>
<div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;</div>
<div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;    <span class="keywordflow">if</span>(1){</div>
<div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;      <span class="comment">// Jon&#39;s inversion</span></div>
<div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;      <a class="code" href="../../d1/d3e/utoprimgen_8c.html#a0a83e9e7fdd3cc595c5b8d0df88ec684" title="just picks the algorithm to invert">Utoprimgen_pick</a>(showmessages, allowlocalfailurefixandnoreport, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#abeac8c89d7fa922563d79f9278b4d44d" title="8: Jon 1D/2D final version  can handle non-rel problems">UTOPRIMJONNONRELCOMPAT</a>, eomtypelocal, whichcap, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a4a02957480e290a978d1f29992125c15" title="for WHICHENTROPYEVOLVE">EVOLVENOENTROPY</a>, Ugeomfree, ptrgeom, &amp;GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>), pr,pressure,newtonstats,&amp;GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>));</div>
<div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;    }</div>
<div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(0){ <span class="comment">// not working yet</span></div>
<div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;      <a class="code" href="../../d1/d3e/utoprimgen_8c.html#a0a83e9e7fdd3cc595c5b8d0df88ec684" title="just picks the algorithm to invert">Utoprimgen_pick</a>(showmessages, allowlocalfailurefixandnoreport, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a5476db60973dd9f75630aa333f00d41e" title="20: COLDGRMHD">UTOPRIMCOLDGRMHD</a>, eomtypelocal, whichcap, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a4a02957480e290a978d1f29992125c15" title="for WHICHENTROPYEVOLVE">EVOLVENOENTROPY</a>, Ugeomfree, ptrgeom, &amp;GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>), pr,pressure,newtonstats,&amp;GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>));</div>
<div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;    }</div>
<div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) coldpr[pl]=pr[pl]; <span class="comment">// save coldpr</span></div>
<div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;    </div>
<div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;    coldpflag=GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>);</div>
<div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;    coldradinvmod=GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>);</div>
<div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;    coldhardfailure=(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0894a5e6c53e2e8a143d10be7a42d492">IFUTOPRIMFAIL</a>(coldpflag) &amp;&amp; <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a294c90ee60024e6f3548814e7ff10a41">IFUTOPRIMFAILSOFT</a>(coldpflag)==0);</div>
<div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;    </div>
<div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;    <span class="keywordflow">if</span>(!coldhardfailure){</div>
<div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;</div>
<div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;      usedhotinversion=0;</div>
<div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;      usedentropyinversion=0;</div>
<div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;      usedcoldinversion=1;</div>
<div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;      usedffdeinversion=0;</div>
<div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;      </div>
<div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;      <span class="comment">// check cold inversion</span></div>
<div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;      check_on_inversion(checkoninversiongas, checkoninversionrad, usedhotinversion,usedentropyinversion,usedcoldinversion,usedffdeinversion,&amp;GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>), pr0, pr, pressure, ptrgeom, Uold, Unew,newtonstats,&amp;GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>));</div>
<div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;</div>
<div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;      <span class="comment">// adjust failure</span></div>
<div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;      coldpflag=GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>);</div>
<div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;      coldradinvmod=GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>);</div>
<div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;      coldhardfailure=(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0894a5e6c53e2e8a143d10be7a42d492">IFUTOPRIMFAIL</a>(coldpflag) &amp;&amp; <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a294c90ee60024e6f3548814e7ff10a41">IFUTOPRIMFAILSOFT</a>(coldpflag)==0);</div>
<div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;    }</div>
<div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;</div>
<div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;</div>
<div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;</div>
<div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;    <span class="comment">//  If cold GRMHD failed or gets suspicious solution, revert to FFDE GRMHD if solution is FFDE</span></div>
<div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;<span class="comment"></span>    <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#a3fc6b60f416d6e59dfe591e1ea7bf2fa" title="whether to try FFDE inversion if entropy fails (only used if FFDE makes sense)">ENTROPY2FFDE</a> &amp;&amp; (<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#adcfc55da37bd6e82e506046aca203365">COLDANYFAIL</a>(coldpflag)) ){</div>
<div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;</div>
<div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;      ffdetried=tryffdeinversion(showmessages, allowlocalfailurefixandnoreport,finalstep, coldpflag, 0, whichcap, modprim, pi, pr0, pr, pressure, Ugeomfree, Ugeomfree0, qptr, ptrgeom,newtonstats,&amp;GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>));</div>
<div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) ffdepr[pl]=pr[pl]; <span class="comment">// save ffdepr</span></div>
<div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;</div>
<div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;      <span class="keywordflow">if</span>(ffdetried){</div>
<div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;</div>
<div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;        <span class="comment">// get failure flag</span></div>
<div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;        ffdepflag=GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>);</div>
<div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;        ffderadinvmod=GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>);</div>
<div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;        ffdehardfailure=(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0894a5e6c53e2e8a143d10be7a42d492">IFUTOPRIMFAIL</a>(ffdepflag) &amp;&amp; <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a294c90ee60024e6f3548814e7ff10a41">IFUTOPRIMFAILSOFT</a>(ffdepflag)==0);</div>
<div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;</div>
<div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;        <span class="keywordflow">if</span>(!ffdehardfailure){</div>
<div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;          usedhotinversion=0;</div>
<div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;          usedentropyinversion=0;</div>
<div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;          usedcoldinversion=0;</div>
<div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;          usedffdeinversion=1;</div>
<div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;        </div>
<div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;          <span class="comment">// report back that used this</span></div>
<div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;          *eomtype=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6f6094bc467dc61f9490ad7e1de63580">EOMFFDE</a>;</div>
<div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;        </div>
<div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;          <span class="comment">// check ffde inversion if inversion thinks it was successful</span></div>
<div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;          check_on_inversion(checkoninversiongas, checkoninversionrad, usedhotinversion,usedentropyinversion,usedcoldinversion,usedffdeinversion,&amp;GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>), pr0, pr, pressure, ptrgeom, Uold, Unew,newtonstats,&amp;GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>));</div>
<div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;          </div>
<div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;          <span class="comment">// adjust failure flag</span></div>
<div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;          ffdepflag=GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>);</div>
<div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;          ffderadinvmod=GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>);</div>
<div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;          ffdehardfailure=(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0894a5e6c53e2e8a143d10be7a42d492">IFUTOPRIMFAIL</a>(ffdepflag) &amp;&amp; <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a294c90ee60024e6f3548814e7ff10a41">IFUTOPRIMFAILSOFT</a>(ffdepflag)==0);</div>
<div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;        }</div>
<div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;      }</div>
<div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;    }</div>
<div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;    <span class="keywordflow">else</span> ffdepflag=1;</div>
<div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;</div>
<div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;</div>
<div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;</div>
<div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;</div>
<div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;  }</div>
<div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(eomtypelocal==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6f6094bc467dc61f9490ad7e1de63580">EOMFFDE</a>){</div>
<div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;<span class="comment"></span>    <span class="comment">//</span></div>
<div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;    <span class="comment">// report back that used this</span></div>
<div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;    *eomtype=eomtypelocal;</div>
<div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;</div>
<div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;</div>
<div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;</div>
<div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;    <span class="comment">// GODMARK: inversions lead to different behavior (start with torus with rho=u=0 but loop of field)!</span></div>
<div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;</div>
<div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;    ffdetried=1;</div>
<div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;    <span class="keywordflow">if</span>(0){ <span class="comment">// Jon&#39;s old inversion</span></div>
<div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;      <a class="code" href="../../d1/d3e/utoprimgen_8c.html#a0a83e9e7fdd3cc595c5b8d0df88ec684" title="just picks the algorithm to invert">Utoprimgen_pick</a>(showmessages, allowlocalfailurefixandnoreport, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a77b486c84a084158707853a7ca173cfa" title="21: FFDE">UTOPRIMFFDE</a>, eomtypelocal, whichcap, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a4a02957480e290a978d1f29992125c15" title="for WHICHENTROPYEVOLVE">EVOLVENOENTROPY</a>, Ugeomfree, ptrgeom, &amp;GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>), pr,pressure,newtonstats,&amp;GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>));</div>
<div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;    }</div>
<div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(1){</div>
<div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;      <span class="comment">// Jon&#39;s inversion</span></div>
<div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;      <a class="code" href="../../d1/d3e/utoprimgen_8c.html#a0a83e9e7fdd3cc595c5b8d0df88ec684" title="just picks the algorithm to invert">Utoprimgen_pick</a>(showmessages, allowlocalfailurefixandnoreport, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#abeac8c89d7fa922563d79f9278b4d44d" title="8: Jon 1D/2D final version  can handle non-rel problems">UTOPRIMJONNONRELCOMPAT</a>, eomtypelocal, whichcap, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a4a02957480e290a978d1f29992125c15" title="for WHICHENTROPYEVOLVE">EVOLVENOENTROPY</a>, Ugeomfree, ptrgeom, &amp;GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>), pr,pressure,newtonstats,&amp;GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>));</div>
<div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;    }</div>
<div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(0){</div>
<div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;      compare_ffde_inversions(showmessages, allowlocalfailurefixandnoreport,&amp;GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>), pr0, pr, pressure, ptrgeom, Ugeomfree0, Ugeomfree, Uold, Unew,newtonstats,&amp;GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>));</div>
<div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;    }</div>
<div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) ffdepr[pl]=pr[pl]; <span class="comment">// save ffdepr</span></div>
<div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;</div>
<div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;    <span class="keywordflow">if</span>(ffdetried){</div>
<div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;</div>
<div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;      <span class="comment">// get failure flag</span></div>
<div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;      ffdepflag=GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>);</div>
<div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;      ffderadinvmod=GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>);</div>
<div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;      ffdehardfailure=(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0894a5e6c53e2e8a143d10be7a42d492">IFUTOPRIMFAIL</a>(ffdepflag) &amp;&amp; <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a294c90ee60024e6f3548814e7ff10a41">IFUTOPRIMFAILSOFT</a>(ffdepflag)==0);</div>
<div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;</div>
<div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;      <span class="keywordflow">if</span>(!ffdehardfailure){</div>
<div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;        usedhotinversion=0;</div>
<div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;        usedentropyinversion=0;</div>
<div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;        usedcoldinversion=0;</div>
<div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;        usedffdeinversion=1;</div>
<div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;        </div>
<div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;        <span class="comment">// report back that used this</span></div>
<div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;        *eomtype=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6f6094bc467dc61f9490ad7e1de63580">EOMFFDE</a>;</div>
<div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;        </div>
<div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;        <span class="comment">// check ffde inversion if inversion thinks it was successful</span></div>
<div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;        check_on_inversion(checkoninversiongas, checkoninversionrad, usedhotinversion,usedentropyinversion,usedcoldinversion,usedffdeinversion,&amp;GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>), pr0, pr, pressure, ptrgeom, Uold, Unew,newtonstats,&amp;GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>));</div>
<div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;          </div>
<div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;        <span class="comment">// adjust failure flag</span></div>
<div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;        ffdepflag=GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>);</div>
<div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;        ffderadinvmod=GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>);</div>
<div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;        ffdehardfailure=(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0894a5e6c53e2e8a143d10be7a42d492">IFUTOPRIMFAIL</a>(ffdepflag) &amp;&amp; <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a294c90ee60024e6f3548814e7ff10a41">IFUTOPRIMFAILSOFT</a>(ffdepflag)==0);</div>
<div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;      }</div>
<div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;    }</div>
<div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;</div>
<div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;  }<span class="comment">//end if EOMFFDE</span></div>
<div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;</div>
<div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;</div>
<div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;</div>
<div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;</div>
<div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;</div>
<div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;</div>
<div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;  <span class="comment">// USED BY IMPLICIT METHOD.  BUT, currently disabled multiple tries (forcetry=0 always) since MODEPICKBEST now goes through each eomtype one at a time and we don&#39;t want to switch MHD inversions.</span></div>
<div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;  <span class="comment">// pick best or use default pr</span></div>
<div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;<span class="comment"></span>  <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> numpicks=0,didpickenergy=0,didpickentropy=0,didpicknormal=0,didpicknotbest=0;</div>
<div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;  <span class="keywordflow">if</span>((whichmethod==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aef33cf4e6c2534137907bc2eaefdb224">MODEPICKBEST</a>) &amp;&amp; hottried &amp;&amp; hothardfailure==0 &amp;&amp; entropytried &amp;&amp; entropyhardfailure==0){</div>
<div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;</div>
<div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;</div>
<div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;    <span class="comment">// then based upon conditions, choose best result</span></div>
<div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;    <span class="comment">// KORALTODO: Fake errors -- assumes these inversions always get lowest error desired.</span></div>
<div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;    <span class="keywordtype">int</span> doentropy;</div>
<div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;    doentropy=whetherdoentropy(ptrgeom, fracenergy, !entropyhardfailure, !hothardfailure, entropyradinvmod, hotradinvmod, 1<a class="code" href="../../d8/d60/init_8c.html#a07484107e6d9fdf38b53edf631d6511d">E</a>-16, 1<a class="code" href="../../d8/d60/init_8c.html#a07484107e6d9fdf38b53edf631d6511d">E</a>-9, 1<a class="code" href="../../d8/d60/init_8c.html#a07484107e6d9fdf38b53edf631d6511d">E</a>-10, 1<a class="code" href="../../d8/d60/init_8c.html#a07484107e6d9fdf38b53edf631d6511d">E</a>-18, 1<a class="code" href="../../d8/d60/init_8c.html#a07484107e6d9fdf38b53edf631d6511d">E</a>-18, entropypr, hotpr);</div>
<div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;</div>
<div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;    <span class="keywordflow">if</span>(doentropy){</div>
<div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) pr[pl]=entropypr[pl];</div>
<div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;      GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>)=entropypflag;</div>
<div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;      GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>)=entropyradinvmod;</div>
<div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;      *eomtype=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a40b55e98bfcccde1a3f19d983ca7488c">EOMENTROPYGRMHD</a>;</div>
<div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;      didpickentropy++;</div>
<div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;    }</div>
<div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!hothardfailure){</div>
<div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) pr[pl]=hotpr[pl];</div>
<div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;      GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>)=hotpflag;</div>
<div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;      GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>)=hotradinvmod;</div>
<div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;      *eomtype=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a03d89f51ab60206791830c886d62bfd0">EOMGRMHD</a>;</div>
<div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;      didpickenergy++;</div>
<div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;    }</div>
<div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;      <span class="comment">// then sequence of conditionals decides which pr to use (i.e. whether to use entropy, hot, or cold)</span></div>
<div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;      didpicknormal++;</div>
<div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;    }</div>
<div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;    numpicks++;</div>
<div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;</div>
<div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;  }</div>
<div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;    <span class="comment">// then sequence of conditionals leads to final pr[] having final desired inversion.</span></div>
<div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;    didpicknotbest++;</div>
<div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;  }</div>
<div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;</div>
<div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;  <span class="keywordflow">if</span>((whichmethod==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aef33cf4e6c2534137907bc2eaefdb224">MODEPICKBEST</a>) &amp;&amp; debugfail&gt;=2) <span class="keywordflow">if</span>(numpicks&gt;0 &amp;&amp; numpicks%(<a class="code" href="../../dd/d46/mpidefs_8h.html#a38e1083345af2cf99e31d941f18b56ad">totalzones</a>*<a class="code" href="../../d1/d3e/utoprimgen_8c.html#a29c71c132c174c4a72d398ebfc197d62">REPORTCYCLE</a>)==0) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;DIDPICKS: %lld : %lld %lld %lld : %lld : %d\n&quot;</span>,numpicks,didpickenergy,didpickentropy,didpicknormal,didpicknotbest,*eomtype);</div>
<div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;</div>
<div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;</div>
<div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;</div>
<div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;</div>
<div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;</div>
<div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;  <span class="comment">// modify failure flag if necessary</span></div>
<div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;<span class="preprocessor">#if(DOEVOLVERHO)</span></div>
<div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;<span class="preprocessor"></span>  negdensitycheck(finalstep, pr, &amp;GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>));</div>
<div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;</div>
<div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;</div>
<div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;</div>
<div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;</div>
<div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;</div>
<div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;<span class="comment"></span>  <span class="comment">//</span></div>
<div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;  <span class="comment">// complain if pflag set</span></div>
<div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;  <span class="comment">// only output if failed</span></div>
<div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;  <span class="comment">// for now only report if not just negative density failure</span></div>
<div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;  lpflag=GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>);</div>
<div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;  lpflagrad=GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>);</div>
<div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;</div>
<div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;</div>
<div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;</div>
<div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a294c90ee60024e6f3548814e7ff10a41">IFUTOPRIMFAILSOFT</a>(lpflag) || <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a781d24b3e646f7f4597b0b7004507a63">IFUTOPRIMRADFAIL</a>(lpflagrad)){</div>
<div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;    <span class="comment">// then don&#39;t report info for now SUPERGODMARK</span></div>
<div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;    <span class="keywordflow">if</span>(showmessages&amp;&amp;debugfail&gt;=1) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>, <span class="stringliteral">&quot;SOFT Failed to find a prim. var. solution on finalstep=%d!! t=%21.15g steppart=%d nstep=%ld i=%d j=%d k=%d : fail=%d : errx=%21.15g lpflagrad=%d\n&quot;</span>,finalstep,<a class="code" href="../../d8/d5b/defs_8general_8h.html#ae1ee1e1c83c3f70e2e1afed4f4f5b41e">t</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a70170b90229f9fc05eebf8508a685c70">steppart</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a0b92e4d6197989f0f9b0609c8615a46f">realnstep</a>,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[1]+ptrgeom-&gt;i,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[2]+ptrgeom-&gt;j,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[3]+ptrgeom-&gt;k,lpflag,newtonstats-&gt;<a class="code" href="../../db/d3a/structof__newtonstats.html#a02529bef0a69373dc4e7e9e7a672d1db">lerrx</a>,lpflagrad);</div>
<div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;  }</div>
<div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>((<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0894a5e6c53e2e8a143d10be7a42d492">IFUTOPRIMFAIL</a>(lpflag) || <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a16db3b3cf4bc03f044c72c62e75072db">IFUTOPRIMRADHARDFAIL</a>(lpflagrad)) &amp;&amp;(debugfail&gt;=1)){</div>
<div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;    <span class="keywordflow">if</span>(showmessages) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>, <span class="stringliteral">&quot;Failed to find a prim. var. solution on finalstep=%d!! t=%21.15g steppart=%d nstep=%ld i=%d j=%d k=%d : fail=%d : errx=%21.15g lpflagrad=%d\n&quot;</span>,finalstep,<a class="code" href="../../d8/d5b/defs_8general_8h.html#ae1ee1e1c83c3f70e2e1afed4f4f5b41e">t</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a70170b90229f9fc05eebf8508a685c70">steppart</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a0b92e4d6197989f0f9b0609c8615a46f">realnstep</a>,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[1]+ptrgeom-&gt;i,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[2]+ptrgeom-&gt;j,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[3]+ptrgeom-&gt;k,lpflag,newtonstats-&gt;<a class="code" href="../../db/d3a/structof__newtonstats.html#a02529bef0a69373dc4e7e9e7a672d1db">lerrx</a>,lpflagrad);</div>
<div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;  }</div>
<div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;    <span class="comment">//    if(showmessages) dualfprintf(fail_file, &quot;NO FAIL t=%21.15g steppart=%d nstep=%ld i=%d j=%d k=%d : fail=%d : errx=%21.15g\n&quot;,t,steppart,realnstep,startpos[1]+ptrgeom-&gt;i,startpos[2]+ptrgeom-&gt;j,startpos[3]+ptrgeom-&gt;k,lpflag,newtonstats-&gt;lerrx,lpflagrad);</span></div>
<div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;  }</div>
<div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;</div>
<div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;</div>
<div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;</div>
<div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;</div>
<div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;</div>
<div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;</div>
<div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;<span class="preprocessor">#if(PRODUCTION==0)</span></div>
<div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;<span class="comment"></span>  <span class="comment">//</span></div>
<div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;<span class="comment"></span>  debug_utoprimgen(&amp;lpflag, pr0, pr, ptrgeom, Uold, Unew);</div>
<div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;</div>
<div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;</div>
<div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;</div>
<div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;<span class="comment"></span>  <span class="comment">//</span></div>
<div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;<span class="comment"></span>  <span class="keywordflow">if</span>(0){</div>
<div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;    <span class="keywordflow">if</span>(preexistingfailgas) GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>)=preexistingfailgas;</div>
<div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;    <span class="keywordflow">if</span>(preexistingfailrad) GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>)=preexistingfailrad;</div>
<div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;  <span class="comment">// KORALTODO: Could further decide to use original pf from some point in source explicit/implicit updates instead of this no-force solution.</span></div>
<div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;  }</div>
<div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;</div>
<div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;    <span class="keywordflow">if</span>(preexistingfailgas&gt;0 || preexistingfailrad&gt;0){</div>
<div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;</div>
<div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;      <span class="comment">// then accepting explicit as solution, do see how close got solution in diagnostics</span></div>
<div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;</div>
<div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;      <span class="keywordflow">if</span>(1||finalstep==1){<span class="comment">// &amp;&amp; GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,FLAGUTOPRIMFAIL)&lt;=UTOPRIMNOFAIL &amp;&amp; GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,FLAGUTOPRIMRADFAIL)&lt;=UTOPRIMRADNOFAIL){</span></div>
<div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;        <span class="comment">// see how accurately got energy-momentum</span></div>
<div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;        <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> qb;</div>
<div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;        <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a11e17cd8b0594d1ad52e3594aa9f477e" title="find ucon, ucov, bcon, bcov from primitive variables when calling get_state, users of this function e...">get_state</a>(pr,ptrgeom,&amp;qb);</div>
<div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;        <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ub[NPR],ubabs[NPR];</div>
<div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;        <span class="keywordtype">int</span> uutype=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0339344098add3b8dbaaf3f753ed4b4f">UDIAG</a>;</div>
<div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;        <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a9a54096e4c40a15a2c1bf74266153616" title="calculate &quot;conserved&quot; quantities">primtoU</a>(uutype,pr,&amp;qb,ptrgeom,ub,ubabs);</div>
<div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;        <span class="comment">//    if((startpos[1]+ptrgeom-&gt;i==17) &amp;&amp; (startpos[2]+ptrgeom-&gt;j)==0){</span></div>
<div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;        <span class="comment">//      dualfprintf(fail_file,&quot;URHOINIMPLICIT=%21.15g\n&quot;,ub[RHO]*dx[1]*dx[2]*dx[3]);</span></div>
<div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;        <span class="comment">//    }</span></div>
<div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;</div>
<div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;        <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> utot[NPR];</div>
<div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) utot[pl] = Ugeomfree0[pl]; <span class="comment">// UNOTHING</span></div>
<div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;</div>
<div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;        <span class="comment">//    dualfprintf(fail_file,&quot;ub=%g utot=%g dU=%g\n&quot;,ub[UU],utot[UU],ub[UU]-utot[UU]);</span></div>
<div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;</div>
<div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;        <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ubdiag[NPR],utotdiag[NPR];</div>
<div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;        UtoU(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0339344098add3b8dbaaf3f753ed4b4f">UDIAG</a>,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0339344098add3b8dbaaf3f753ed4b4f">UDIAG</a>,ptrgeom,ub,ubdiag);  <span class="comment">// convert from UNOTHING -&gt; UDIAG</span></div>
<div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;        UtoU(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab2be21bd5eff40ca89c20eeecbeab5e0">UNOTHING</a>,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0339344098add3b8dbaaf3f753ed4b4f">UDIAG</a>,ptrgeom,utot,utotdiag);  <span class="comment">// convert from UNOTHING -&gt; UDIAG</span></div>
<div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;</div>
<div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;</div>
<div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) <span class="keywordflow">if</span>(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a56c640597356b6f642dd6ee1afb87e74">BPL</a>(pl)) utotdiag[pl] = ubdiag[pl]; <span class="comment">// cell center as if no change as required, but should be true already as setup these.</span></div>
<div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;</div>
<div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;        <span class="comment">// get optical depth</span></div>
<div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;        <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> tautot[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>],tautotmax;</div>
<div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;        <a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#a5943065ab3d5b4e9f4f691db499b588f" title="calculates total opacity over dx[]">calc_tautot</a>(pr, ptrgeom, &amp;qb, tautot, &amp;tautotmax);</div>
<div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;       </div>
<div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;</div>
<div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;        <span class="keywordflow">if</span>(preexistingfailgas &amp;&amp; (<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a294c90ee60024e6f3548814e7ff10a41">IFUTOPRIMFAILSOFT</a>(lpflag) || <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afaacb1c256e44ec7be2adaac65713f2b">IFUTOPRIMNOFAILORFIXED</a>(lpflag) )){<span class="comment">// then failed before but not with explicit</span></div>
<div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;</div>
<div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;          <span class="comment">// get bsqorho</span></div>
<div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;          <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> bsqorho;</div>
<div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;          <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> <a class="code" href="../../d1/d83/structof__state.html#a2b38c522ec7321af3368706fa4632834">bsq</a>; <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a41b8eacac0a4a23d6b00b670fe49629c">bsq_calc_fromq</a>(pr, ptrgeom, &amp;qb, &amp;bsq);</div>
<div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;          bsqorho=bsq/pr[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>];</div>
<div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;</div>
<div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;</div>
<div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;          <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammamaxlimit=0.9*<a class="code" href="../../d8/d5b/defs_8general_8h.html#accef7ff74daca804b9a5a3ad7d3db882">GAMMAMAX</a>;</div>
<div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;          <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gamma,qsq;</div>
<div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;          gamma_calc(pr,ptrgeom,&amp;gamma,&amp;qsq);</div>
<div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;</div>
<div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;          <span class="comment">// keep velocity if bsq/rho&gt;1</span></div>
<div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;          <span class="comment">//          if(bsqorho&gt;1.0 &amp;&amp; gamma&lt;gammamaxlimit){</span></div>
<div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;          <span class="keywordflow">if</span>(bsqorho&gt;<a class="code" href="../../d8/d5b/defs_8general_8h.html#a0fe8d3c7642e667dd8ae3635506c4273">BSQORHOLIMIT</a>/5.0 &amp;&amp; tautotmax&lt;1<a class="code" href="../../d8/d60/init_8c.html#a07484107e6d9fdf38b53edf631d6511d">E</a>-1 &amp;&amp; gamma&lt;gammamaxlimit){</div>
<div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;            <span class="comment">// only fail densities, because velocity in high mag regime controls flux of magnetic flux-energy-momentum and don&#39;t want to just average that as that would unreasonably lose energy-momentum conservation</span></div>
<div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;            GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>)=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a4fb558d7d5fa8343d7ca417d8b0bb418">UTOPRIMFAILURHO2AVG1FROMFFDE</a>;</div>
<div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;            <span class="comment">//            dualfprintf(fail_file,&quot;MHD bsqhorho=%g avoided full failure: %d %d %d preexist=%d\n&quot;,bsqorho,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,preexistingfailgas);</span></div>
<div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;          }</div>
<div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;          <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;            <span class="comment">// revert fail</span></div>
<div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;            GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>)=preexistingfailgas;</div>
<div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;            <span class="comment">//            dualfprintf(fail_file,&quot;MHD1: bsqorho=%g %d %d : %d %d %d\n&quot;,bsqorho,preexistingfailgas,lpflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k);</span></div>
<div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;          }</div>
<div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;        }</div>
<div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;        <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;          <span class="comment">//          dualfprintf(fail_file,&quot;MHD2: %d %d\n&quot;,preexistingfailgas,lpflag);</span></div>
<div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;        }</div>
<div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;</div>
<div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;</div>
<div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;        <span class="comment">//UTOPRIMRADFAILFIXEDUTOPRIMRAD</span></div>
<div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;        <span class="keywordflow">if</span>(preexistingfailrad &amp;&amp; <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aff9d5fee895617aa33f78a72612dcc9f">IFUTOPRIMRADNOFAIL</a>(lpflagrad)){<span class="comment">// then failed before but not with explicit</span></div>
<div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;          </div>
<div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;          <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> radgammamaxlimit=0.9*<a class="code" href="../../d8/d5b/defs_8general_8h.html#a51ef12e4cafc4a8fe70374c37f57d565">GAMMAMAXRAD</a>;</div>
<div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;          <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> radgamma,radqsq;</div>
<div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;          gamma_calc(&amp;pr[URAD1-<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>],ptrgeom,&amp;radgamma,&amp;radqsq);</div>
<div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;</div>
<div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;</div>
<div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;          <span class="keywordflow">if</span>(tautotmax&lt;1<a class="code" href="../../d8/d60/init_8c.html#a07484107e6d9fdf38b53edf631d6511d">E</a>-3 &amp;&amp; radgamma&lt;radgammamaxlimit){ <span class="comment">// tautotmax&lt;1 too aggressive, makes radiation go nuts.</span></div>
<div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;            <span class="comment">// fail density only</span></div>
<div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;            GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>)=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ac3b05e85d00237f2aaa8ec4ec6ff82a3">UTOPRIMFAILU2AVG1</a>;</div>
<div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;            <span class="comment">//            dualfprintf(fail_file,&quot;RAD avoided full failure: %d %d %d: preexist=%d\n&quot;,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,preexistingfailrad);</span></div>
<div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;          }</div>
<div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;          <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;            GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>)=preexistingfailrad;</div>
<div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;            <span class="comment">//            dualfprintf(fail_file,&quot;RAD1: tau=%g %d %d : %d %d %d\n&quot;,tautotmax,preexistingfailgas,lpflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k);</span></div>
<div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;          }</div>
<div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;        }</div>
<div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;        <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;          <span class="comment">//          dualfprintf(fail_file,&quot;RAD2: %d %d\n&quot;,preexistingfailgas,lpflag);</span></div>
<div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;        }</div>
<div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;        <span class="comment">// unlike gas velocity that links to both density and magnetic field, radiation is alone, so no point in making rad density averaged and not average velocity</span></div>
<div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;        GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>)=preexistingfailrad;</div>
<div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;</div>
<div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;</div>
<div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;        <span class="comment">// Get deltaUavg[] and also modify ucons if required and should</span></div>
<div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;        <span class="keywordtype">int</span> whocalled;</div>
<div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;        whocalled=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94e78a5a3dd0d93a76ee98795d9641ed">COUNTEXPLICITNORMAL</a>;</div>
<div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;    </div>
<div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;</div>
<div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;        <span class="keywordtype">int</span> docorrectuconslocal=0;</div>
<div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;        <span class="keyword">extern</span> <span class="keywordtype">int</span> diag_fixup_dUandaccount(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ui, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Uf, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *ucons, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <span class="keywordtype">int</span> finalstep, <span class="keywordtype">int</span> whocalled, <span class="keywordtype">int</span> docorrectuconslocal);</div>
<div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;        diag_fixup_dUandaccount(utotdiag, ubdiag, NULL, ptrgeom, finalstep, whocalled, docorrectuconslocal);</div>
<div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;</div>
<div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;</div>
<div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;        <span class="comment">//    FTYPE rat = fabs(utotdiag[RHO]-ubdiag[RHO])/(fabs(utotdiag[RHO])+fabs(ubdiag[RHO]));</span></div>
<div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;        <span class="comment">//    if(rat&gt;1E-13){</span></div>
<div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;        <span class="comment">//      dualfprintf(fail_file,&quot;Why not: %d %d %d :  %21.15g %21.15g: diff=%21.15g : prho=%21.15g uu0RHO=%21.15g: error=%21.15g %21.15g\n&quot;,usedenergy,usedentropy,usedcold,utotdiag[RHO],ubdiag[RHO],utotdiag[RHO]-ubdiag[RHO],pb[RHO],uu0[RHO]*ptrgeom-&gt;gdet,errorabs[0],errorabs[1]);</span></div>
<div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;        <span class="comment">//    }</span></div>
<div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;</div>
<div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;      }</div>
<div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;      <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;        <span class="comment">// no solution, reverst to explicit and then average bad values, accounting will occur there.</span></div>
<div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;      }</div>
<div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;    }</div>
<div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;  }</div>
<div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;</div>
<div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;</div>
<div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;  <span class="comment">//  if(nstep==4 &amp;&amp; steppart==0){</span></div>
<div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;  <span class="comment">//    PLOOP(pliter,pl) dualfprintf(fail_file,&quot;PRIMUTOPRIMGEN1 (%d): pl=%d pp=%21.15g uu=%21.15g\n&quot;,*eomtype,pl,pr[pl],Ugeomfree[pl]);</span></div>
<div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;  <span class="comment">//  }</span></div>
<div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;</div>
<div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;</div>
<div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;</div>
<div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;</div>
<div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;  <span class="comment">// INVERT pseudo-passive scalars</span></div>
<div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;  <span class="comment">// all pseudo-passive scalars are trivially inverted</span></div>
<div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;  <span class="comment">// So don&#39;t include passive scalars in check_on_inversion() [Since modify passive scalars]</span></div>
<div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;<span class="comment"></span>  <a class="code" href="../../d1/d3e/utoprimgen_8c.html#abfc42de6975dd4ff02f2748404e10911" title="perform U-&gt;p inversion on advected scalars">invert_scalars1</a>(ptrgeom, Ugeomfree,pr);</div>
<div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;  <span class="comment">// INVERT pseudo-passive scalars #2 (where u^t needed)</span></div>
<div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;<span class="comment"></span>  <a class="code" href="../../d1/d3e/utoprimgen_8c.html#a1118806d01e553c38ae5cf5f036f9f2e" title="perform U-&gt;p inversion on advected scalars">invert_scalars2</a>(ptrgeom, Ugeomfree,NULL, pr);</div>
<div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;</div>
<div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;     </div>
<div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;</div>
<div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;}</div>
<div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;</div>
<div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;</div>
<div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;</div>
<div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;</div>
<div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;</div>
<div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;</div>
<div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;</div>
<div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;</div>
<div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;<span class="keywordtype">int</span> tryhotinversion(<span class="keywordtype">int</span> showmessages, <span class="keywordtype">int</span> allowlocalfailurefixandnoreport, <span class="keywordtype">int</span> finalstep, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> oldpflag, <span class="keywordtype">int</span> forcetry, <span class="keywordtype">int</span> whichcap, <span class="keywordtype">int</span> modprim, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pi, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr0, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *<a class="code" href="../../dc/dd2/newcodediff_8txt.html#ae7ab77d7e616dc02fba121a009b48c27">pr</a>, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *<a class="code" href="../../d1/d83/structof__state.html#aab16dc2e08d2b2c558e1f6e06e4efada">pressure</a>, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ugeomfree, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ugeomfree0, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *qptr, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <span class="keyword">struct</span> <a class="code" href="../../db/d3a/structof__newtonstats.html">of_newtonstats</a> *newtonstats, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflagrad)</div>
<div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;{</div>
<div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160;  <span class="keywordtype">int</span> triedhot=0;</div>
<div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160;  <span class="keywordtype">int</span> pl;</div>
<div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> prentropy[NPR],prhot[NPR];</div>
<div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;  <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> hotpflag;</div>
<div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d1/d3e/utoprimgen_8c.html#a0a83e9e7fdd3cc595c5b8d0df88ec684" title="just picks the algorithm to invert">Utoprimgen_pick</a>(<span class="keywordtype">int</span> showmessages, <span class="keywordtype">int</span> allowlocalfailurefixandnoreport, <span class="keywordtype">int</span> which, <span class="keywordtype">int</span> eomtype, <span class="keywordtype">int</span> whichcap, <span class="keywordtype">int</span> parameter, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ugeomfree, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflag, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pressure, <span class="keyword">struct</span> <a class="code" href="../../db/d3a/structof__newtonstats.html">of_newtonstats</a> *newtonstats, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflagrad);</div>
<div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160;  <span class="keywordtype">int</span> eomtypelocal=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a03d89f51ab60206791830c886d62bfd0">EOMGRMHD</a>;</div>
<div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;</div>
<div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;  <span class="keywordtype">int</span> TRYNEWIFOLDUNEG=1;</div>
<div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;  <span class="keywordtype">int</span> TRYNEWIFOLDRHONEG=1;</div>
<div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;  <span class="keywordtype">int</span> TRYNEWIFOLDFAILCONV=1;</div>
<div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;</div>
<div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160;</div>
<div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;  <span class="keywordtype">int</span> badfailure;</div>
<div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;  <span class="keywordflow">if</span>( (TRYNEWIFOLDRHONEG==1 &amp;&amp; <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab883f9e4302c57b5bf243cad6d318972">IFUTOPRIMFAILSOFTRHORELATED</a>(oldpflag)) || (TRYNEWIFOLDUNEG==1 &amp;&amp; <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ac530de9aaf5536f3b22423a77cc9c391">IFUTOPRIMFAILSOFTNOTRHORELATED</a>(oldpflag)) || (TRYNEWIFOLDFAILCONV==1 &amp;&amp; <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0894a5e6c53e2e8a143d10be7a42d492">IFUTOPRIMFAIL</a>(oldpflag)) ){</div>
<div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160;    <span class="comment">// get here if want to fix up rho&lt;=0, u&lt;=0, or convergence failure</span></div>
<div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;    <span class="comment">// First if() is needed since last conditional or else if() would trigger on any failure type</span></div>
<div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;    badfailure=1;</div>
<div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;  }</div>
<div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160;    <span class="comment">// then maybe not so bad failure</span></div>
<div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;    <span class="comment">// e.g. if get here, do nothing when either rho&lt;=0 or u&lt;=0</span></div>
<div class="line"><a name="l01133"></a><span class="lineno"> 1133</span>&#160;    badfailure=0;</div>
<div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;  }</div>
<div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160;</div>
<div class="line"><a name="l01136"></a><span class="lineno"> 1136</span>&#160;</div>
<div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;  <span class="keywordflow">if</span>(badfailure || forcetry){</div>
<div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160;</div>
<div class="line"><a name="l01139"></a><span class="lineno"> 1139</span>&#160;    <span class="comment">// then bad failure or doing both energy and entropy, so try to use hot grmhd</span></div>
<div class="line"><a name="l01140"></a><span class="lineno"> 1140</span>&#160;    <span class="comment">// restore backup in case previous inversion changed things</span></div>
<div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl){</div>
<div class="line"><a name="l01142"></a><span class="lineno"> 1142</span>&#160;      prentropy[pl]=pr[pl];</div>
<div class="line"><a name="l01143"></a><span class="lineno"> 1143</span>&#160;      Ugeomfree[pl]=Ugeomfree0[pl];</div>
<div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160;</div>
<div class="line"><a name="l01145"></a><span class="lineno"> 1145</span>&#160;      <span class="comment">// setup input guess and other already-inverted solutions</span></div>
<div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160;      <span class="keywordflow">if</span>(badfailure==0 &amp;&amp; forcetry) prhot[pl]=prentropy[pl]; <span class="comment">// then use entropy as guess</span></div>
<div class="line"><a name="l01147"></a><span class="lineno"> 1147</span>&#160;      <span class="keywordflow">else</span> prhot[pl]=pr0[pl];</div>
<div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160;    }</div>
<div class="line"><a name="l01149"></a><span class="lineno"> 1149</span>&#160;</div>
<div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160;    <span class="comment">// If just using pr/pr0 for guess, then fixup</span></div>
<div class="line"><a name="l01153"></a><span class="lineno"> 1153</span>&#160;<span class="comment"></span>    <span class="keywordflow">if</span>(<a class="code" href="../../d1/d3e/utoprimgen_8c.html#a3a8adda834dd0777f2230a3d2dca2aba" title="whether to fix u_g using entropy conserved quantity, if available.">ENTROPYFIXGUESSEXTERNAL</a> &amp;&amp; modprim==1){</div>
<div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;      <span class="comment">// qptr is not final qptr, just previous from &quot;pi&quot; or at best &quot;pb&quot;</span></div>
<div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160;      entropyfixguess(qptr, ptrgeom, Ugeomfree, prhot);</div>
<div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160;      <span class="comment">// also get highest out of current &quot;flux&quot; and &quot;initial&quot; step parts.</span></div>
<div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160;      prhot[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(fabs(prhot[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]),fabs(pi[UU]));</div>
<div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160;    }</div>
<div class="line"><a name="l01159"></a><span class="lineno"> 1159</span>&#160;    </div>
<div class="line"><a name="l01160"></a><span class="lineno"> 1160</span>&#160;    </div>
<div class="line"><a name="l01161"></a><span class="lineno"> 1161</span>&#160;    <span class="comment">// get hot evolution inversion</span></div>
<div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160;    <a class="code" href="../../d1/d3e/utoprimgen_8c.html#a0a83e9e7fdd3cc595c5b8d0df88ec684" title="just picks the algorithm to invert">Utoprimgen_pick</a>(showmessages, allowlocalfailurefixandnoreport, <a class="code" href="../../d8/d5b/defs_8general_8h.html#a538f4ebe3434f76ec67690f0651b53e7">UTOPRIMVERSION</a>, eomtypelocal, whichcap, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a4a02957480e290a978d1f29992125c15" title="for WHICHENTROPYEVOLVE">EVOLVENOENTROPY</a>, Ugeomfree, ptrgeom, &amp;hotpflag, prhot,pressure,newtonstats, lpflagrad);</div>
<div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;</div>
<div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160;    </div>
<div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;    <span class="comment">// check if hot solution is good</span></div>
<div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afaacb1c256e44ec7be2adaac65713f2b">IFUTOPRIMNOFAILORFIXED</a>(hotpflag)){</div>
<div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160;</div>
<div class="line"><a name="l01170"></a><span class="lineno"> 1170</span>&#160;</div>
<div class="line"><a name="l01171"></a><span class="lineno"> 1171</span>&#160;      <span class="comment">// set pflag so diag_fixup knows used hot inversion</span></div>
<div class="line"><a name="l01172"></a><span class="lineno"> 1172</span>&#160;      GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>)=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a31984a48acce79cf07b32f0688481a66">UTOPRIMFAILFIXEDUTOPRIM</a>;</div>
<div class="line"><a name="l01173"></a><span class="lineno"> 1173</span>&#160;</div>
<div class="line"><a name="l01174"></a><span class="lineno"> 1174</span>&#160;</div>
<div class="line"><a name="l01175"></a><span class="lineno"> 1175</span>&#160;      <span class="comment">// then keep hot solution</span></div>
<div class="line"><a name="l01176"></a><span class="lineno"> 1176</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl) pr[pl]=prhot[pl];</div>
<div class="line"><a name="l01177"></a><span class="lineno"> 1177</span>&#160;</div>
<div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160;</div>
<div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160;      <span class="comment">// accounting (since fixup.c accounting doesn&#39;t know what original pr0 is and actual prhot is undefined since Uhot-&gt;prhot wasn&#39;t possible)</span></div>
<div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160;      <span class="comment">// GODMARK: For DOENOFLUX&gt;0, should modify conserved quantity in some way.  For DOENOFLUX==0, primitives form basis of conserved quantities, so once primitives are modified all is done.  So should probably pass in U[] from  Utoprimgen() or whatever is the full conserved quantity later used.</span></div>
<div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160;      <span class="keywordtype">int</span> modcons=(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a55732148d2616d6d1f5d2abbe8710850">DOENOFLUX</a> != <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#adacaaf8526353cfe870206f0cf4d2ca7" title="for DOENOFLUX: 0: no ENO flux reconstruction 1: reconstruct F for finite difference rep...">NOENOFLUX</a>);</div>
<div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Uievolve[NPR];</div>
<div class="line"><a name="l01183"></a><span class="lineno"> 1183</span>&#160;      <span class="comment">// ucons not modified (i.e. modcons=0), but ucons may be used by diag_fixup()</span></div>
<div class="line"><a name="l01184"></a><span class="lineno"> 1184</span>&#160;      UtoU(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab2be21bd5eff40ca89c20eeecbeab5e0">UNOTHING</a>,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a15d073255fcc246f09aa26337e643d22" title="defines data return types for primtoU() and primtoflux()">UEVOLVE</a>,ptrgeom,Ugeomfree0,Uievolve);</div>
<div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160;      <span class="comment">// account for change to hot MHD conserved quantities</span></div>
<div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160;      <span class="comment">//      diag_fixup_Ui_pf(modcons,Uievolve,pr,ptrgeom,finalstep,COUNTHOT);</span></div>
<div class="line"><a name="l01187"></a><span class="lineno"> 1187</span>&#160;      </div>
<div class="line"><a name="l01188"></a><span class="lineno"> 1188</span>&#160;      <span class="comment">// KORALTODO: allowlocalfailurefixandnoreport could be used below to avoid reset, but for now let implicit solver be ok with hot inversion</span></div>
<div class="line"><a name="l01189"></a><span class="lineno"> 1189</span>&#160;      <span class="comment">// reset pflag, unless still need to do some kind of averaging</span></div>
<div class="line"><a name="l01190"></a><span class="lineno"> 1190</span>&#160;      if(GLOBALMACP0A1(pflag,ptrgeom-&gt;<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>,ptrgeom-&gt;<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>)==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a31984a48acce79cf07b32f0688481a66">UTOPRIMFAILFIXEDUTOPRIM</a>){</div>
<div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;        <span class="comment">// default then is that no failure</span></div>
<div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160;        <span class="comment">// already accounted for and just a soft failure that doesn&#39;t require fixup anymore (and can&#39;t leave as UTOPRIMFAILFIXEDUTOPRIM since fixup would complain about not resetting the flag)</span></div>
<div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;        GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>)=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#abdf9e55b7b15ec0bcd386055f1787f47">UTOPRIMNOFAIL</a>;</div>
<div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160;      }</div>
<div class="line"><a name="l01195"></a><span class="lineno"> 1195</span>&#160;</div>
<div class="line"><a name="l01196"></a><span class="lineno"> 1196</span>&#160;      triedhot=1;</div>
<div class="line"><a name="l01197"></a><span class="lineno"> 1197</span>&#160;   </div>
<div class="line"><a name="l01198"></a><span class="lineno"> 1198</span>&#160;</div>
<div class="line"><a name="l01199"></a><span class="lineno"> 1199</span>&#160;    }<span class="comment">// else if hotpflag is bad</span></div>
<div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160;      <span class="comment">// then both entropy and hot are bad, so keep entropy</span></div>
<div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160;      <span class="comment">// GODMARK: Could try going to force-free and &quot;failing&quot; the parallel velocity so it gets averaged like internal energy in hot case!</span></div>
<div class="line"><a name="l01203"></a><span class="lineno"> 1203</span>&#160;      <span class="comment">// only can go to force-free if b^2/rho&gt;&gt;1 as well</span></div>
<div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;      <span class="comment">// keep entropypflag and keep entropy solution</span></div>
<div class="line"><a name="l01205"></a><span class="lineno"> 1205</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl) pr[pl]=prentropy[pl];</div>
<div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;</div>
<div class="line"><a name="l01207"></a><span class="lineno"> 1207</span>&#160;<span class="preprocessor">#if(PRODUCTION==0)      </span></div>
<div class="line"><a name="l01208"></a><span class="lineno"> 1208</span>&#160;<span class="preprocessor"></span>      <span class="keywordflow">if</span>(forcetry==0 &amp;&amp; debugfail&gt;=2 &amp;&amp; showmessages){</div>
<div class="line"><a name="l01209"></a><span class="lineno"> 1209</span>&#160;        dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;Tried hot and bad on finalstep=%d! t=%g steppart=%d nstep=%ld i=%d j=%d k=%d :: hotpflag=%d hotpflag=%d\n&quot;</span>,finalstep,<a class="code" href="../../d8/d5b/defs_8general_8h.html#ae1ee1e1c83c3f70e2e1afed4f4f5b41e">t</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a70170b90229f9fc05eebf8508a685c70">steppart</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a1a1088d87617078680f1fd0f0d707384">nstep</a>,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,hotpflag,hotpflag);</div>
<div class="line"><a name="l01210"></a><span class="lineno"> 1210</span>&#160;      }</div>
<div class="line"><a name="l01211"></a><span class="lineno"> 1211</span>&#160;</div>
<div class="line"><a name="l01212"></a><span class="lineno"> 1212</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01213"></a><span class="lineno"> 1213</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01214"></a><span class="lineno"> 1214</span>&#160;      triedhot=0;</div>
<div class="line"><a name="l01215"></a><span class="lineno"> 1215</span>&#160;</div>
<div class="line"><a name="l01216"></a><span class="lineno"> 1216</span>&#160;    }</div>
<div class="line"><a name="l01217"></a><span class="lineno"> 1217</span>&#160;        </div>
<div class="line"><a name="l01218"></a><span class="lineno"> 1218</span>&#160;  }<span class="comment">// if bad failure of some kind</span></div>
<div class="line"><a name="l01219"></a><span class="lineno"> 1219</span>&#160;</div>
<div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160;</div>
<div class="line"><a name="l01221"></a><span class="lineno"> 1221</span>&#160;</div>
<div class="line"><a name="l01222"></a><span class="lineno"> 1222</span>&#160;</div>
<div class="line"><a name="l01223"></a><span class="lineno"> 1223</span>&#160;</div>
<div class="line"><a name="l01224"></a><span class="lineno"> 1224</span>&#160;  <span class="keywordflow">return</span>(triedhot);</div>
<div class="line"><a name="l01225"></a><span class="lineno"> 1225</span>&#160;}</div>
<div class="line"><a name="l01226"></a><span class="lineno"> 1226</span>&#160;</div>
<div class="line"><a name="l01227"></a><span class="lineno"> 1227</span>&#160;</div>
<div class="line"><a name="l01228"></a><span class="lineno"> 1228</span>&#160;</div>
<div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160;</div>
<div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160;</div>
<div class="line"><a name="l01232"></a><span class="lineno"> 1232</span>&#160;<span class="keywordtype">int</span> tryentropyinversion(<span class="keywordtype">int</span> showmessages, <span class="keywordtype">int</span> allowlocalfailurefixandnoreport, <span class="keywordtype">int</span> finalstep, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> oldpflag, <span class="keywordtype">int</span> forcetry, <span class="keywordtype">int</span> whichcap, <span class="keywordtype">int</span> modprim, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pi, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr0, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pressure, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ugeomfree, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ugeomfree0, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *qptr, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <span class="keyword">struct</span> <a class="code" href="../../db/d3a/structof__newtonstats.html">of_newtonstats</a> *newtonstats, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflagrad)</div>
<div class="line"><a name="l01233"></a><span class="lineno"> 1233</span>&#160;{</div>
<div class="line"><a name="l01234"></a><span class="lineno"> 1234</span>&#160;  <span class="keywordtype">int</span> triedentropy=0;</div>
<div class="line"><a name="l01235"></a><span class="lineno"> 1235</span>&#160;  <span class="keywordtype">int</span> pl;</div>
<div class="line"><a name="l01236"></a><span class="lineno"> 1236</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> prold[NPR],prentropy[NPR];</div>
<div class="line"><a name="l01237"></a><span class="lineno"> 1237</span>&#160;  <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> entropypflag;</div>
<div class="line"><a name="l01238"></a><span class="lineno"> 1238</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d1/d3e/utoprimgen_8c.html#a0a83e9e7fdd3cc595c5b8d0df88ec684" title="just picks the algorithm to invert">Utoprimgen_pick</a>(<span class="keywordtype">int</span> showmessages, <span class="keywordtype">int</span> allowlocalfailurefixandnoreport, <span class="keywordtype">int</span> which, <span class="keywordtype">int</span> eomtype, <span class="keywordtype">int</span> whichcap, <span class="keywordtype">int</span> parameter, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ugeomfree, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflag, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pressure, <span class="keyword">struct</span> <a class="code" href="../../db/d3a/structof__newtonstats.html">of_newtonstats</a> *newtonstats, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflagrad);</div>
<div class="line"><a name="l01239"></a><span class="lineno"> 1239</span>&#160;  <span class="keywordtype">int</span> eomtypelocal=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a40b55e98bfcccde1a3f19d983ca7488c">EOMENTROPYGRMHD</a>;</div>
<div class="line"><a name="l01240"></a><span class="lineno"> 1240</span>&#160;  </div>
<div class="line"><a name="l01241"></a><span class="lineno"> 1241</span>&#160;  <span class="comment">//  dualfprintf(fail_file,&quot;Got here in tryentropyinversion: oldpflag=%d\n&quot;,oldpflag);</span></div>
<div class="line"><a name="l01242"></a><span class="lineno"> 1242</span>&#160;</div>
<div class="line"><a name="l01244"></a><span class="lineno"> 1244</span>&#160;  <span class="keywordtype">int</span> TRYNEWIFOLDUNEG=1;</div>
<div class="line"><a name="l01246"></a><span class="lineno"> 1246</span>&#160;  <span class="keywordtype">int</span> TRYNEWIFOLDRHONEG=1;</div>
<div class="line"><a name="l01248"></a><span class="lineno"> 1248</span>&#160;  <span class="keywordtype">int</span> TRYNEWIFOLDFAILCONV=1;</div>
<div class="line"><a name="l01249"></a><span class="lineno"> 1249</span>&#160;</div>
<div class="line"><a name="l01250"></a><span class="lineno"> 1250</span>&#160;  <span class="keywordtype">int</span> badfailure;</div>
<div class="line"><a name="l01251"></a><span class="lineno"> 1251</span>&#160;  <span class="keywordflow">if</span>( (TRYNEWIFOLDRHONEG==1 &amp;&amp; <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab883f9e4302c57b5bf243cad6d318972">IFUTOPRIMFAILSOFTRHORELATED</a>(oldpflag)) || (TRYNEWIFOLDUNEG==1 &amp;&amp; <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ac530de9aaf5536f3b22423a77cc9c391">IFUTOPRIMFAILSOFTNOTRHORELATED</a>(oldpflag)) || (TRYNEWIFOLDFAILCONV==1 &amp;&amp; <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0894a5e6c53e2e8a143d10be7a42d492">IFUTOPRIMFAIL</a>(oldpflag)) ){</div>
<div class="line"><a name="l01252"></a><span class="lineno"> 1252</span>&#160;    <span class="comment">// get here if want to fix up rho&lt;=0, u&lt;=0, or convergence failure</span></div>
<div class="line"><a name="l01253"></a><span class="lineno"> 1253</span>&#160;    <span class="comment">// First if() is needed since last conditional or else if() would trigger on any failure type</span></div>
<div class="line"><a name="l01254"></a><span class="lineno"> 1254</span>&#160;    badfailure=1;</div>
<div class="line"><a name="l01255"></a><span class="lineno"> 1255</span>&#160;  }</div>
<div class="line"><a name="l01256"></a><span class="lineno"> 1256</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l01257"></a><span class="lineno"> 1257</span>&#160;    <span class="comment">// then maybe not so bad failure</span></div>
<div class="line"><a name="l01258"></a><span class="lineno"> 1258</span>&#160;    <span class="comment">// e.g. if get here, do nothing when either rho&lt;=0 or u&lt;=0</span></div>
<div class="line"><a name="l01259"></a><span class="lineno"> 1259</span>&#160;    badfailure=0;</div>
<div class="line"><a name="l01260"></a><span class="lineno"> 1260</span>&#160;  }</div>
<div class="line"><a name="l01261"></a><span class="lineno"> 1261</span>&#160;</div>
<div class="line"><a name="l01262"></a><span class="lineno"> 1262</span>&#160;</div>
<div class="line"><a name="l01263"></a><span class="lineno"> 1263</span>&#160;  triedentropy=0;</div>
<div class="line"><a name="l01264"></a><span class="lineno"> 1264</span>&#160;  <span class="keywordflow">if</span>(badfailure || forcetry){</div>
<div class="line"><a name="l01265"></a><span class="lineno"> 1265</span>&#160;    triedentropy=1;</div>
<div class="line"><a name="l01266"></a><span class="lineno"> 1266</span>&#160;    </div>
<div class="line"><a name="l01267"></a><span class="lineno"> 1267</span>&#160;</div>
<div class="line"><a name="l01268"></a><span class="lineno"> 1268</span>&#160;    <span class="comment">// then bad failure, so try to use entropy grmhd</span></div>
<div class="line"><a name="l01269"></a><span class="lineno"> 1269</span>&#160;    <span class="comment">// restore backup in case previous inversion changed things</span></div>
<div class="line"><a name="l01270"></a><span class="lineno"> 1270</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl){</div>
<div class="line"><a name="l01271"></a><span class="lineno"> 1271</span>&#160;      prold[pl]=pr[pl];</div>
<div class="line"><a name="l01272"></a><span class="lineno"> 1272</span>&#160;      Ugeomfree[pl]=Ugeomfree0[pl];</div>
<div class="line"><a name="l01273"></a><span class="lineno"> 1273</span>&#160;</div>
<div class="line"><a name="l01274"></a><span class="lineno"> 1274</span>&#160;      <span class="comment">// setup input guess and other already-inverted solutions</span></div>
<div class="line"><a name="l01275"></a><span class="lineno"> 1275</span>&#160;      <span class="keywordflow">if</span>(forcetry &amp;&amp; badfailure==0) prentropy[pl]=prold[pl]; <span class="comment">// use hot as guess since hot was actually good</span></div>
<div class="line"><a name="l01276"></a><span class="lineno"> 1276</span>&#160;      <span class="keywordflow">else</span> prentropy[pl]=pr0[pl];</div>
<div class="line"><a name="l01277"></a><span class="lineno"> 1277</span>&#160;    }</div>
<div class="line"><a name="l01278"></a><span class="lineno"> 1278</span>&#160;    </div>
<div class="line"><a name="l01280"></a><span class="lineno"> 1280</span>&#160;    <span class="comment">// If just using pr/pr0 for guess, then fixup</span></div>
<div class="line"><a name="l01282"></a><span class="lineno"> 1282</span>&#160;<span class="comment"></span>    <span class="keywordflow">if</span>(<a class="code" href="../../d1/d3e/utoprimgen_8c.html#a3a8adda834dd0777f2230a3d2dca2aba" title="whether to fix u_g using entropy conserved quantity, if available.">ENTROPYFIXGUESSEXTERNAL</a> &amp;&amp; modprim==1){</div>
<div class="line"><a name="l01283"></a><span class="lineno"> 1283</span>&#160;      <span class="comment">// qptr is not final qptr, just previous from &quot;pi&quot; or at best &quot;pb&quot;</span></div>
<div class="line"><a name="l01284"></a><span class="lineno"> 1284</span>&#160;      entropyfixguess(qptr, ptrgeom, Ugeomfree, prentropy);</div>
<div class="line"><a name="l01285"></a><span class="lineno"> 1285</span>&#160;      <span class="comment">// also get highest out of current &quot;flux&quot; and &quot;initial&quot; step parts.</span></div>
<div class="line"><a name="l01286"></a><span class="lineno"> 1286</span>&#160;      prentropy[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(fabs(prentropy[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]),fabs(pi[UU]));</div>
<div class="line"><a name="l01287"></a><span class="lineno"> 1287</span>&#160;    }</div>
<div class="line"><a name="l01288"></a><span class="lineno"> 1288</span>&#160;    </div>
<div class="line"><a name="l01289"></a><span class="lineno"> 1289</span>&#160;    <span class="comment">// setup as if full entropy evolution</span></div>
<div class="line"><a name="l01290"></a><span class="lineno"> 1290</span>&#160;    <span class="keywordtype">int</span> whichentropy=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a437fe144346575df3a2aaaab1b3856b2">EVOLVEFULLENTROPY</a>;</div>
<div class="line"><a name="l01291"></a><span class="lineno"> 1291</span>&#160;    <span class="comment">// get entropy evolution inversion</span></div>
<div class="line"><a name="l01292"></a><span class="lineno"> 1292</span>&#160;    <span class="comment">// EVOLVENOENTROPY</span></div>
<div class="line"><a name="l01293"></a><span class="lineno"> 1293</span>&#160;    <a class="code" href="../../d1/d3e/utoprimgen_8c.html#a0a83e9e7fdd3cc595c5b8d0df88ec684" title="just picks the algorithm to invert">Utoprimgen_pick</a>(showmessages, allowlocalfailurefixandnoreport, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#abeac8c89d7fa922563d79f9278b4d44d" title="8: Jon 1D/2D final version  can handle non-rel problems">UTOPRIMJONNONRELCOMPAT</a>, eomtypelocal, whichcap, whichentropy, Ugeomfree, ptrgeom, &amp;entropypflag, prentropy,pressure,newtonstats, lpflagrad);</div>
<div class="line"><a name="l01294"></a><span class="lineno"> 1294</span>&#160;</div>
<div class="line"><a name="l01295"></a><span class="lineno"> 1295</span>&#160;</div>
<div class="line"><a name="l01297"></a><span class="lineno"> 1297</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01298"></a><span class="lineno"> 1298</span>&#160;    <span class="comment">// check if entropy solution is good</span></div>
<div class="line"><a name="l01299"></a><span class="lineno"> 1299</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afaacb1c256e44ec7be2adaac65713f2b">IFUTOPRIMNOFAILORFIXED</a>(entropypflag)){</div>
<div class="line"><a name="l01300"></a><span class="lineno"> 1300</span>&#160;</div>
<div class="line"><a name="l01301"></a><span class="lineno"> 1301</span>&#160;</div>
<div class="line"><a name="l01302"></a><span class="lineno"> 1302</span>&#160;      <span class="comment">// set pflag so diag_fixup knows used entropy inversion</span></div>
<div class="line"><a name="l01303"></a><span class="lineno"> 1303</span>&#160;      GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>)=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8ec47c7a495701cda2ff6a8e03eb8e8f">UTOPRIMFAILFIXEDENTROPY</a>;</div>
<div class="line"><a name="l01304"></a><span class="lineno"> 1304</span>&#160;</div>
<div class="line"><a name="l01305"></a><span class="lineno"> 1305</span>&#160;</div>
<div class="line"><a name="l01306"></a><span class="lineno"> 1306</span>&#160;      <span class="comment">// then keep entropy solution</span></div>
<div class="line"><a name="l01307"></a><span class="lineno"> 1307</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl) pr[pl]=prentropy[pl];</div>
<div class="line"><a name="l01308"></a><span class="lineno"> 1308</span>&#160;</div>
<div class="line"><a name="l01309"></a><span class="lineno"> 1309</span>&#160;</div>
<div class="line"><a name="l01310"></a><span class="lineno"> 1310</span>&#160;      <span class="comment">// accounting (since fixup.c accounting doesn&#39;t know what original pr0 is and actual prold is undefined since U-&gt;pr wasn&#39;t possible)</span></div>
<div class="line"><a name="l01311"></a><span class="lineno"> 1311</span>&#160;      <span class="comment">// GODMARK: For DOENOFLUX&gt;0, should modify conserved quantity in some way.  For DOENOFLUX==0, primitives form basis of conserved quantities, so once primitives are modified all is done.  So should probably pass in U[] from  Utoprimgen() or whatever is the full conserved quantity later used.</span></div>
<div class="line"><a name="l01312"></a><span class="lineno"> 1312</span>&#160;      <span class="keywordtype">int</span> modcons=(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a55732148d2616d6d1f5d2abbe8710850">DOENOFLUX</a> != <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#adacaaf8526353cfe870206f0cf4d2ca7" title="for DOENOFLUX: 0: no ENO flux reconstruction 1: reconstruct F for finite difference rep...">NOENOFLUX</a>);</div>
<div class="line"><a name="l01313"></a><span class="lineno"> 1313</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Uievolve[NPR];</div>
<div class="line"><a name="l01314"></a><span class="lineno"> 1314</span>&#160;      <span class="comment">// ucons not modified (i.e. modcons=0), but ucons may be used by diag_fixup()</span></div>
<div class="line"><a name="l01315"></a><span class="lineno"> 1315</span>&#160;      UtoU(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab2be21bd5eff40ca89c20eeecbeab5e0">UNOTHING</a>,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a15d073255fcc246f09aa26337e643d22" title="defines data return types for primtoU() and primtoflux()">UEVOLVE</a>,ptrgeom,Ugeomfree0,Uievolve);</div>
<div class="line"><a name="l01316"></a><span class="lineno"> 1316</span>&#160;      <span class="comment">// account for change to hot MHD conserved quantities</span></div>
<div class="line"><a name="l01317"></a><span class="lineno"> 1317</span>&#160;      <span class="comment">//      diag_fixup_Ui_pf(modcons,Uievolve,pr,ptrgeom,finalstep,COUNTENTROPY);</span></div>
<div class="line"><a name="l01318"></a><span class="lineno"> 1318</span>&#160;      </div>
<div class="line"><a name="l01319"></a><span class="lineno"> 1319</span>&#160;      <span class="comment">// KORALTODO: allowlocalfailurefixandnoreport could be used below to avoid reset, but for now let implicit solver be ok with entropy inversion</span></div>
<div class="line"><a name="l01320"></a><span class="lineno"> 1320</span>&#160;      <span class="comment">// reset pflag, unless still need to do some kind of averaging</span></div>
<div class="line"><a name="l01321"></a><span class="lineno"> 1321</span>&#160;      if(GLOBALMACP0A1(pflag,ptrgeom-&gt;<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>,ptrgeom-&gt;<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>)==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8ec47c7a495701cda2ff6a8e03eb8e8f">UTOPRIMFAILFIXEDENTROPY</a>){</div>
<div class="line"><a name="l01322"></a><span class="lineno"> 1322</span>&#160;        <span class="comment">// default then is that no failure</span></div>
<div class="line"><a name="l01323"></a><span class="lineno"> 1323</span>&#160;        <span class="comment">// already accounted for and just a soft failure that doesn&#39;t require fixup anymore (and can&#39;t leave as UTOPRIMFAILFIXEDUTOPRIM since fixup would complain about not resetting the flag)</span></div>
<div class="line"><a name="l01324"></a><span class="lineno"> 1324</span>&#160;        GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>)=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#abdf9e55b7b15ec0bcd386055f1787f47">UTOPRIMNOFAIL</a>;</div>
<div class="line"><a name="l01325"></a><span class="lineno"> 1325</span>&#160;      }</div>
<div class="line"><a name="l01326"></a><span class="lineno"> 1326</span>&#160;</div>
<div class="line"><a name="l01327"></a><span class="lineno"> 1327</span>&#160;</div>
<div class="line"><a name="l01328"></a><span class="lineno"> 1328</span>&#160;</div>
<div class="line"><a name="l01329"></a><span class="lineno"> 1329</span>&#160;      <span class="comment">// but set internal energy to previous value (should really evolve with entropy equation, but if negligible and no strong shocks, then ok )</span></div>
<div class="line"><a name="l01330"></a><span class="lineno"> 1330</span>&#160;      <span class="comment">// GODMARK: another ok way is to set special failure that only averages internal energy!  Then can evolve at least -- in some diffusive way</span></div>
<div class="line"><a name="l01331"></a><span class="lineno"> 1331</span>&#160;<span class="preprocessor">#if(PRODUCTION==0)      </span></div>
<div class="line"><a name="l01332"></a><span class="lineno"> 1332</span>&#160;<span class="preprocessor"></span>      <span class="keywordflow">if</span>(forcetry==0 &amp;&amp; debugfail&gt;=2 &amp;&amp; showmessages) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;Tried entropy and good on finalstep=%d! steppart=%d nstep=%ld i=%d j=%d k=%d :: oldpflag=%d entropypflag=%d\n&quot;</span>,finalstep,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a70170b90229f9fc05eebf8508a685c70">steppart</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a1a1088d87617078680f1fd0f0d707384">nstep</a>,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,oldpflag,entropypflag);</div>
<div class="line"><a name="l01333"></a><span class="lineno"> 1333</span>&#160;</div>
<div class="line"><a name="l01334"></a><span class="lineno"> 1334</span>&#160;      <span class="keywordflow">if</span>(debugfail&gt;=2){</div>
<div class="line"><a name="l01335"></a><span class="lineno"> 1335</span>&#160;        <span class="comment">//        int pliter;</span></div>
<div class="line"><a name="l01336"></a><span class="lineno"> 1336</span>&#160;        <span class="comment">//        if(pr[UU]&gt;1.0) dualfprintf(fail_file,&quot;PDEATH\n&quot;);</span></div>
<div class="line"><a name="l01337"></a><span class="lineno"> 1337</span>&#160;        <span class="comment">//        if(pr[UU]&lt;1E-13) dualfprintf(fail_file,&quot;PDEATH2\n&quot;);</span></div>
<div class="line"><a name="l01338"></a><span class="lineno"> 1338</span>&#160;        <span class="comment">//        if(Ugeomfree0[ENTROPY]&lt;-10) dualfprintf(fail_file,&quot;PDEATH3\n&quot;);</span></div>
<div class="line"><a name="l01339"></a><span class="lineno"> 1339</span>&#160;        <span class="comment">//        PLOOP(pliter,pl) dualfprintf(fail_file,&quot;POST GO TO ENTROPY: ijk=%d %d %d nstep=%ld steppart=%d pl=%d pr0=%g pr=%g U0=%g U=%g\n&quot;,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,nstep,steppart,pl,pr0[pl],pr[pl],Ugeomfree0[pl],Ugeomfree[pl]);</span></div>
<div class="line"><a name="l01340"></a><span class="lineno"> 1340</span>&#160;</div>
<div class="line"><a name="l01341"></a><span class="lineno"> 1341</span>&#160;      }</div>
<div class="line"><a name="l01342"></a><span class="lineno"> 1342</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01343"></a><span class="lineno"> 1343</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01344"></a><span class="lineno"> 1344</span>&#160;      </div>
<div class="line"><a name="l01345"></a><span class="lineno"> 1345</span>&#160;</div>
<div class="line"><a name="l01346"></a><span class="lineno"> 1346</span>&#160;    }<span class="comment">// else if entropypflag is bad</span></div>
<div class="line"><a name="l01347"></a><span class="lineno"> 1347</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l01348"></a><span class="lineno"> 1348</span>&#160;      <span class="comment">// then both hot and entropy are bad, so keep old</span></div>
<div class="line"><a name="l01349"></a><span class="lineno"> 1349</span>&#160;      <span class="comment">// GODMARK: Could try going to force-free and &quot;failing&quot; the parallel velocity so it gets averaged like internal energy in entropy case!</span></div>
<div class="line"><a name="l01350"></a><span class="lineno"> 1350</span>&#160;      <span class="comment">// only can go to force-free if b^2/rho&gt;&gt;1 as well</span></div>
<div class="line"><a name="l01351"></a><span class="lineno"> 1351</span>&#160;      <span class="comment">// keep oldpflag and keep old solution</span></div>
<div class="line"><a name="l01352"></a><span class="lineno"> 1352</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl) pr[pl]=prold[pl];</div>
<div class="line"><a name="l01353"></a><span class="lineno"> 1353</span>&#160;</div>
<div class="line"><a name="l01354"></a><span class="lineno"> 1354</span>&#160;      <span class="comment">// set how failed</span></div>
<div class="line"><a name="l01355"></a><span class="lineno"> 1355</span>&#160;      GLOBALMACP0A1(pflag,ptrgeom-&gt;<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>,ptrgeom-&gt;<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>)=entropypflag;</div>
<div class="line"><a name="l01356"></a><span class="lineno"> 1356</span>&#160;</div>
<div class="line"><a name="l01357"></a><span class="lineno"> 1357</span>&#160;</div>
<div class="line"><a name="l01358"></a><span class="lineno"> 1358</span>&#160;<span class="preprocessor">#if(PRODUCTION==0)      </span></div>
<div class="line"><a name="l01359"></a><span class="lineno"> 1359</span>&#160;<span class="preprocessor"></span>      <span class="keywordflow">if</span>(forcetry==0 &amp;&amp; debugfail&gt;=2 &amp;&amp; showmessages){</div>
<div class="line"><a name="l01360"></a><span class="lineno"> 1360</span>&#160;        dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;Tried entropy and bad on finalstep=%d! t=%g steppart=%d nstep=%ld i=%d j=%d k=%d :: oldpflag=%d entropypflag=%d\n&quot;</span>,finalstep,<a class="code" href="../../d8/d5b/defs_8general_8h.html#ae1ee1e1c83c3f70e2e1afed4f4f5b41e">t</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a70170b90229f9fc05eebf8508a685c70">steppart</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a1a1088d87617078680f1fd0f0d707384">nstep</a>,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,oldpflag,entropypflag);</div>
<div class="line"><a name="l01361"></a><span class="lineno"> 1361</span>&#160;        <span class="comment">//        int pliter;</span></div>
<div class="line"><a name="l01362"></a><span class="lineno"> 1362</span>&#160;        <span class="comment">//        if(pr[UU]&gt;1.0) dualfprintf(fail_file,&quot;ADEATH\n&quot;);</span></div>
<div class="line"><a name="l01363"></a><span class="lineno"> 1363</span>&#160;        <span class="comment">//        if(pr[UU]&lt;1E-13) dualfprintf(fail_file,&quot;ADEATH2\n&quot;);</span></div>
<div class="line"><a name="l01364"></a><span class="lineno"> 1364</span>&#160;        <span class="comment">//        if(Ugeomfree0[ENTROPY]&lt;-10) dualfprintf(fail_file,&quot;ADEATH3\n&quot;);</span></div>
<div class="line"><a name="l01365"></a><span class="lineno"> 1365</span>&#160;        <span class="comment">//        PLOOP(pliter,pl) dualfprintf(fail_file,&quot;POST DID NOT GO TO ENTROPY: ijk=%d %d %d nstep=%ld steppart=%d pl=%d pr0=%g pr=%g U0=%g U=%g\n&quot;,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,nstep,steppart,pl,pr0[pl],pr[pl],Ugeomfree0[pl],Ugeomfree[pl]);</span></div>
<div class="line"><a name="l01366"></a><span class="lineno"> 1366</span>&#160;      }</div>
<div class="line"><a name="l01367"></a><span class="lineno"> 1367</span>&#160;</div>
<div class="line"><a name="l01368"></a><span class="lineno"> 1368</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01369"></a><span class="lineno"> 1369</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01370"></a><span class="lineno"> 1370</span>&#160;</div>
<div class="line"><a name="l01371"></a><span class="lineno"> 1371</span>&#160;    }</div>
<div class="line"><a name="l01372"></a><span class="lineno"> 1372</span>&#160;        </div>
<div class="line"><a name="l01373"></a><span class="lineno"> 1373</span>&#160;  }<span class="comment">// if bad failure of some kind</span></div>
<div class="line"><a name="l01374"></a><span class="lineno"> 1374</span>&#160;</div>
<div class="line"><a name="l01375"></a><span class="lineno"> 1375</span>&#160;</div>
<div class="line"><a name="l01376"></a><span class="lineno"> 1376</span>&#160;</div>
<div class="line"><a name="l01377"></a><span class="lineno"> 1377</span>&#160;</div>
<div class="line"><a name="l01378"></a><span class="lineno"> 1378</span>&#160;</div>
<div class="line"><a name="l01379"></a><span class="lineno"> 1379</span>&#160;  <span class="keywordflow">return</span>(triedentropy);</div>
<div class="line"><a name="l01380"></a><span class="lineno"> 1380</span>&#160;}</div>
<div class="line"><a name="l01381"></a><span class="lineno"> 1381</span>&#160;</div>
<div class="line"><a name="l01382"></a><span class="lineno"> 1382</span>&#160;</div>
<div class="line"><a name="l01383"></a><span class="lineno"> 1383</span>&#160;</div>
<div class="line"><a name="l01384"></a><span class="lineno"> 1384</span>&#160;</div>
<div class="line"><a name="l01385"></a><span class="lineno"> 1385</span>&#160;</div>
<div class="line"><a name="l01386"></a><span class="lineno"> 1386</span>&#160;</div>
<div class="line"><a name="l01387"></a><span class="lineno"> 1387</span>&#160;</div>
<div class="line"><a name="l01388"></a><span class="lineno"> 1388</span>&#160;</div>
<div class="line"><a name="l01389"></a><span class="lineno"> 1389</span>&#160;</div>
<div class="line"><a name="l01390"></a><span class="lineno"> 1390</span>&#160;</div>
<div class="line"><a name="l01392"></a><span class="lineno"> 1392</span>&#160;<span class="keywordtype">int</span> trycoldinversion(<span class="keywordtype">int</span> showmessages, <span class="keywordtype">int</span> allowlocalfailurefixandnoreport, <span class="keywordtype">int</span> finalstep, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> oldpflag, <span class="keywordtype">int</span> forcetry, <span class="keywordtype">int</span> whichcap, <span class="keywordtype">int</span> modprim, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pi, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr0, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pressure, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ugeomfree, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ugeomfree0, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *qptr, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <span class="keyword">struct</span> <a class="code" href="../../db/d3a/structof__newtonstats.html">of_newtonstats</a> *newtonstats, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflagrad)</div>
<div class="line"><a name="l01393"></a><span class="lineno"> 1393</span>&#160;{</div>
<div class="line"><a name="l01394"></a><span class="lineno"> 1394</span>&#160;  <span class="keywordtype">int</span> coldtried;</div>
<div class="line"><a name="l01395"></a><span class="lineno"> 1395</span>&#160;  <span class="keywordtype">int</span> pl;</div>
<div class="line"><a name="l01396"></a><span class="lineno"> 1396</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> prold[NPR],prcold[NPR];</div>
<div class="line"><a name="l01397"></a><span class="lineno"> 1397</span>&#160;  <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> coldpflag;</div>
<div class="line"><a name="l01398"></a><span class="lineno"> 1398</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d1/d3e/utoprimgen_8c.html#a0a83e9e7fdd3cc595c5b8d0df88ec684" title="just picks the algorithm to invert">Utoprimgen_pick</a>(<span class="keywordtype">int</span> showmessages, <span class="keywordtype">int</span> allowlocalfailurefixandnoreport, <span class="keywordtype">int</span> which, <span class="keywordtype">int</span> eomtype, <span class="keywordtype">int</span> whichcap, <span class="keywordtype">int</span> parameter, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ugeomfree, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflag, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pressure, <span class="keyword">struct</span> <a class="code" href="../../db/d3a/structof__newtonstats.html">of_newtonstats</a> *newtonstats, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflagrad);</div>
<div class="line"><a name="l01399"></a><span class="lineno"> 1399</span>&#160;</div>
<div class="line"><a name="l01400"></a><span class="lineno"> 1400</span>&#160;  <span class="comment">//  dualfprintf(fail_file,&quot;Got here in trycoldinversion\n&quot;);</span></div>
<div class="line"><a name="l01401"></a><span class="lineno"> 1401</span>&#160;</div>
<div class="line"><a name="l01403"></a><span class="lineno"> 1403</span>&#160;  <span class="keywordtype">int</span> TRYNEWIFOLDUNEG=1;</div>
<div class="line"><a name="l01405"></a><span class="lineno"> 1405</span>&#160;  <span class="keywordtype">int</span> TRYNEWIFOLDRHONEG=1;</div>
<div class="line"><a name="l01407"></a><span class="lineno"> 1407</span>&#160;  <span class="keywordtype">int</span> TRYNEWIFOLDFAILCONV=1;</div>
<div class="line"><a name="l01408"></a><span class="lineno"> 1408</span>&#160;</div>
<div class="line"><a name="l01409"></a><span class="lineno"> 1409</span>&#160;</div>
<div class="line"><a name="l01410"></a><span class="lineno"> 1410</span>&#160;  <span class="keywordtype">int</span> badfailure;</div>
<div class="line"><a name="l01411"></a><span class="lineno"> 1411</span>&#160;  <span class="keywordflow">if</span>( (TRYNEWIFOLDRHONEG==1 &amp;&amp; <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab883f9e4302c57b5bf243cad6d318972">IFUTOPRIMFAILSOFTRHORELATED</a>(oldpflag)) || (TRYNEWIFOLDUNEG==1 &amp;&amp; <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ac530de9aaf5536f3b22423a77cc9c391">IFUTOPRIMFAILSOFTNOTRHORELATED</a>(oldpflag)) || (TRYNEWIFOLDFAILCONV==1 &amp;&amp; <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0894a5e6c53e2e8a143d10be7a42d492">IFUTOPRIMFAIL</a>(oldpflag)) ){</div>
<div class="line"><a name="l01412"></a><span class="lineno"> 1412</span>&#160;    <span class="comment">// get here if want to fix up rho&lt;=0, u&lt;=0, or convergence failure</span></div>
<div class="line"><a name="l01413"></a><span class="lineno"> 1413</span>&#160;    <span class="comment">// First if() is needed since last conditional or else if() would trigger on any failure type</span></div>
<div class="line"><a name="l01414"></a><span class="lineno"> 1414</span>&#160;    badfailure=1;</div>
<div class="line"><a name="l01415"></a><span class="lineno"> 1415</span>&#160;  }</div>
<div class="line"><a name="l01416"></a><span class="lineno"> 1416</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l01417"></a><span class="lineno"> 1417</span>&#160;    <span class="comment">// then maybe not so bad failure</span></div>
<div class="line"><a name="l01418"></a><span class="lineno"> 1418</span>&#160;    <span class="comment">// e.g. if get here, do nothing when either rho&lt;=0 or u&lt;=0</span></div>
<div class="line"><a name="l01419"></a><span class="lineno"> 1419</span>&#160;    badfailure=0;</div>
<div class="line"><a name="l01420"></a><span class="lineno"> 1420</span>&#160;  }</div>
<div class="line"><a name="l01421"></a><span class="lineno"> 1421</span>&#160;</div>
<div class="line"><a name="l01422"></a><span class="lineno"> 1422</span>&#160;</div>
<div class="line"><a name="l01423"></a><span class="lineno"> 1423</span>&#160;</div>
<div class="line"><a name="l01424"></a><span class="lineno"> 1424</span>&#160;  <span class="comment">// see if cold inversion makes sense to do</span></div>
<div class="line"><a name="l01425"></a><span class="lineno"> 1425</span>&#160;  <span class="keywordtype">int</span> includerad=0; <span class="comment">// just MHD inversion here</span></div>
<div class="line"><a name="l01426"></a><span class="lineno"> 1426</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> COLDFACTOR=0.1; <span class="comment">// try to make use cold to order unity errors</span></div>
<div class="line"><a name="l01427"></a><span class="lineno"> 1427</span>&#160;  <span class="keywordtype">int</span> iscoldflow=<a class="code" href="../../d1/d3e/utoprimgen_8c.html#a7d31362f91cd4ec3b92e15dd6bcb3908" title="includerad=1: account for fact that not only assume MHD flow is cold itself, but energy-force balance...">isflowcold</a>(COLDFACTOR, includerad, pr0, ptrgeom, qptr, NULL);</div>
<div class="line"><a name="l01428"></a><span class="lineno"> 1428</span>&#160;  <span class="keywordflow">if</span>(iscoldflow==0) <span class="keywordflow">if</span>(debugfail&gt;=2) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;in trycoldinversion but iscoldflow=0\n&quot;</span>);</div>
<div class="line"><a name="l01429"></a><span class="lineno"> 1429</span>&#160;</div>
<div class="line"><a name="l01430"></a><span class="lineno"> 1430</span>&#160;</div>
<div class="line"><a name="l01431"></a><span class="lineno"> 1431</span>&#160;  coldtried=0;</div>
<div class="line"><a name="l01432"></a><span class="lineno"> 1432</span>&#160;  <span class="keywordflow">if</span>((badfailure || forcetry)&amp;&amp;iscoldflow){</div>
<div class="line"><a name="l01433"></a><span class="lineno"> 1433</span>&#160;    coldtried=1;</div>
<div class="line"><a name="l01434"></a><span class="lineno"> 1434</span>&#160;</div>
<div class="line"><a name="l01435"></a><span class="lineno"> 1435</span>&#160;</div>
<div class="line"><a name="l01436"></a><span class="lineno"> 1436</span>&#160;    <span class="comment">// then bad failure, so try to use cold grmhd</span></div>
<div class="line"><a name="l01437"></a><span class="lineno"> 1437</span>&#160;    <span class="comment">// restore backup in case previous inversion changed things</span></div>
<div class="line"><a name="l01438"></a><span class="lineno"> 1438</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl){</div>
<div class="line"><a name="l01439"></a><span class="lineno"> 1439</span>&#160;      prold[pl]=pr[pl];</div>
<div class="line"><a name="l01440"></a><span class="lineno"> 1440</span>&#160;      Ugeomfree[pl]=Ugeomfree0[pl];</div>
<div class="line"><a name="l01441"></a><span class="lineno"> 1441</span>&#160;</div>
<div class="line"><a name="l01442"></a><span class="lineno"> 1442</span>&#160;      <span class="comment">// set guess and sets any pre-inverted quantities</span></div>
<div class="line"><a name="l01443"></a><span class="lineno"> 1443</span>&#160;      prcold[pl]=pr0[pl];</div>
<div class="line"><a name="l01444"></a><span class="lineno"> 1444</span>&#160;    }</div>
<div class="line"><a name="l01445"></a><span class="lineno"> 1445</span>&#160;    </div>
<div class="line"><a name="l01446"></a><span class="lineno"> 1446</span>&#160;    </div>
<div class="line"><a name="l01447"></a><span class="lineno"> 1447</span>&#160;    <span class="comment">// get cold inversion</span></div>
<div class="line"><a name="l01448"></a><span class="lineno"> 1448</span>&#160;    <a class="code" href="../../d1/d3e/utoprimgen_8c.html#a0a83e9e7fdd3cc595c5b8d0df88ec684" title="just picks the algorithm to invert">Utoprimgen_pick</a>(showmessages, allowlocalfailurefixandnoreport, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#abeac8c89d7fa922563d79f9278b4d44d" title="8: Jon 1D/2D final version  can handle non-rel problems">UTOPRIMJONNONRELCOMPAT</a>, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a757ad8b9c2c7611dad8aab853a87f61b">EOMCOLDGRMHD</a>, whichcap, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a4a02957480e290a978d1f29992125c15" title="for WHICHENTROPYEVOLVE">EVOLVENOENTROPY</a>, Ugeomfree, ptrgeom, &amp;coldpflag, prcold,pressure,newtonstats, lpflagrad);</div>
<div class="line"><a name="l01449"></a><span class="lineno"> 1449</span>&#160;</div>
<div class="line"><a name="l01450"></a><span class="lineno"> 1450</span>&#160;</div>
<div class="line"><a name="l01451"></a><span class="lineno"> 1451</span>&#160;    <span class="comment">// check also if gamma hit beyond maximum</span></div>
<div class="line"><a name="l01452"></a><span class="lineno"> 1452</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gamma,qsq;</div>
<div class="line"><a name="l01453"></a><span class="lineno"> 1453</span>&#160;    gamma_calc(pr,ptrgeom,&amp;gamma,&amp;qsq);</div>
<div class="line"><a name="l01454"></a><span class="lineno"> 1454</span>&#160;    <span class="keywordflow">if</span>(gamma&gt;<a class="code" href="../../d8/d5b/defs_8general_8h.html#accef7ff74daca804b9a5a3ad7d3db882">GAMMAMAX</a>) coldpflag=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a15839e328562c450366075b401aa700a">UTOPRIMFAILGENERIC</a>;</div>
<div class="line"><a name="l01455"></a><span class="lineno"> 1455</span>&#160;</div>
<div class="line"><a name="l01456"></a><span class="lineno"> 1456</span>&#160;    </div>
<div class="line"><a name="l01458"></a><span class="lineno"> 1458</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01459"></a><span class="lineno"> 1459</span>&#160;    <span class="comment">// check if cold solution is good</span></div>
<div class="line"><a name="l01460"></a><span class="lineno"> 1460</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afaacb1c256e44ec7be2adaac65713f2b">IFUTOPRIMNOFAILORFIXED</a>(coldpflag)){</div>
<div class="line"><a name="l01461"></a><span class="lineno"> 1461</span>&#160;</div>
<div class="line"><a name="l01462"></a><span class="lineno"> 1462</span>&#160;      GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>)=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab9759d44dd5fcddae024c6464ab6e769">UTOPRIMFAILFIXEDCOLD</a>; <span class="comment">// default then is that no failure (or fixed failure)</span></div>
<div class="line"><a name="l01463"></a><span class="lineno"> 1463</span>&#160;</div>
<div class="line"><a name="l01464"></a><span class="lineno"> 1464</span>&#160;      <span class="comment">// then keep cold solution</span></div>
<div class="line"><a name="l01465"></a><span class="lineno"> 1465</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl) pr[pl]=prcold[pl];</div>
<div class="line"><a name="l01466"></a><span class="lineno"> 1466</span>&#160;      <span class="comment">//  if internal energy is not negligible or unknown, then should average or evolve!</span></div>
<div class="line"><a name="l01467"></a><span class="lineno"> 1467</span>&#160;      pl=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>; pr[pl] = pr0[pl]; <span class="comment">// but keep u_g from prior hot.</span></div>
<div class="line"><a name="l01468"></a><span class="lineno"> 1468</span>&#160;</div>
<div class="line"><a name="l01469"></a><span class="lineno"> 1469</span>&#160;</div>
<div class="line"><a name="l01470"></a><span class="lineno"> 1470</span>&#160;      <span class="comment">// but set internal energy to previous value (should really evolve with entropy equation, but if negligible and no strong shocks, then ok )</span></div>
<div class="line"><a name="l01471"></a><span class="lineno"> 1471</span>&#160;      <span class="comment">// GODMARK: another ok way is to set special failure that only averages internal energy!  Then can evolve at least -- in some diffusive way</span></div>
<div class="line"><a name="l01472"></a><span class="lineno"> 1472</span>&#160;      </div>
<div class="line"><a name="l01473"></a><span class="lineno"> 1473</span>&#160;<span class="preprocessor">#if(PRODUCTION==0)      </span></div>
<div class="line"><a name="l01474"></a><span class="lineno"> 1474</span>&#160;<span class="preprocessor"></span>      <span class="keywordflow">if</span>(forcetry==0 &amp;&amp; debugfail&gt;=2) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;Tried cold and good on finalstep=%d! i=%d j=%d k=%d :: oldpflag=%d coldpflag=%d\n&quot;</span>,finalstep,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,oldpflag,coldpflag);</div>
<div class="line"><a name="l01475"></a><span class="lineno"> 1475</span>&#160;      <span class="comment">//      if(debugfail&gt;=2){</span></div>
<div class="line"><a name="l01476"></a><span class="lineno"> 1476</span>&#160;      <span class="comment">//        if(pr[RHO]&lt;0.0 || pr[UU]&lt;0.0) PALLLOOP(pl) dualfprintf(fail_file,&quot;pl=%d pr=%g\n&quot;,pl,pr[pl]);</span></div>
<div class="line"><a name="l01477"></a><span class="lineno"> 1477</span>&#160;      <span class="comment">//        if(gamma&gt;2.0) dualfprintf(fail_file,&quot;gamma=%g\n&quot;,gamma);</span></div>
<div class="line"><a name="l01478"></a><span class="lineno"> 1478</span>&#160;      <span class="comment">//      }</span></div>
<div class="line"><a name="l01479"></a><span class="lineno"> 1479</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01480"></a><span class="lineno"> 1480</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01482"></a><span class="lineno"> 1482</span>&#160;      <span class="comment">//</span></div>
<div class="line"><a name="l01483"></a><span class="lineno"> 1483</span>&#160;      <span class="comment">// decide how to use cold inversion solution    </span></div>
<div class="line"><a name="l01484"></a><span class="lineno"> 1484</span>&#160;      <span class="keywordflow">if</span>(0&amp;&amp;<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ac530de9aaf5536f3b22423a77cc9c391">IFUTOPRIMFAILSOFTNOTRHORELATED</a>(oldpflag)){ <span class="comment">// avoided now since reverting to 0 can introduce extra structure.  Want to keep to using averaging if possible that will generate better solution.</span></div>
<div class="line"><a name="l01485"></a><span class="lineno"> 1485</span>&#160;        <span class="comment">// since cold approximation is very good, then use cold solution and just set internal energy to 0</span></div>
<div class="line"><a name="l01486"></a><span class="lineno"> 1486</span>&#160;        <span class="comment">// if internal energy is actually small, then just set it to 0</span></div>
<div class="line"><a name="l01487"></a><span class="lineno"> 1487</span>&#160;        <span class="comment">// works for Hubble flow!</span></div>
<div class="line"><a name="l01488"></a><span class="lineno"> 1488</span>&#160;        pr[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a7a6f9a2927c5dc63051c63873b1fddc9">zerouuperbaryon</a>*pr[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>];</div>
<div class="line"><a name="l01489"></a><span class="lineno"> 1489</span>&#160;      }</div>
<div class="line"><a name="l01490"></a><span class="lineno"> 1490</span>&#160;      <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l01492"></a><span class="lineno"> 1492</span>&#160;        <span class="comment">// then very bad failure, so try cold inversion and average internal energy for now</span></div>
<div class="line"><a name="l01493"></a><span class="lineno"> 1493</span>&#160;        GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>)=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afc8db2dfa526f28224a0903680453240">UTOPRIMFAILU2AVG1FROMCOLD</a>; <span class="comment">// assume only internal energy needs correcting by averaging</span></div>
<div class="line"><a name="l01494"></a><span class="lineno"> 1494</span>&#160; </div>
<div class="line"><a name="l01495"></a><span class="lineno"> 1495</span>&#160;      }<span class="comment">// end if (else) trying cold inversion</span></div>
<div class="line"><a name="l01496"></a><span class="lineno"> 1496</span>&#160;</div>
<div class="line"><a name="l01497"></a><span class="lineno"> 1497</span>&#160;</div>
<div class="line"><a name="l01498"></a><span class="lineno"> 1498</span>&#160;</div>
<div class="line"><a name="l01499"></a><span class="lineno"> 1499</span>&#160;</div>
<div class="line"><a name="l01500"></a><span class="lineno"> 1500</span>&#160;</div>
<div class="line"><a name="l01501"></a><span class="lineno"> 1501</span>&#160;      <span class="comment">// accounting (since fixup.c accounting doesn&#39;t know what original pr0 is and actual prold is undefined since U-&gt;pr wasn&#39;t possible)</span></div>
<div class="line"><a name="l01502"></a><span class="lineno"> 1502</span>&#160;      <span class="comment">// GODMARK: For DOENOFLUX&gt;0, should modify conserved quantity in some way.  For DOENOFLUX==0, primitives form basis of conserved quantities, so once primitives are modified all is done.  So should probably pass in U[] from  Utoprimgen() or whatever is the full conserved quantity later used.</span></div>
<div class="line"><a name="l01503"></a><span class="lineno"> 1503</span>&#160;      <span class="keywordtype">int</span> modcons=(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a55732148d2616d6d1f5d2abbe8710850">DOENOFLUX</a> != <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#adacaaf8526353cfe870206f0cf4d2ca7" title="for DOENOFLUX: 0: no ENO flux reconstruction 1: reconstruct F for finite difference rep...">NOENOFLUX</a>);</div>
<div class="line"><a name="l01504"></a><span class="lineno"> 1504</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Ui[NPR];</div>
<div class="line"><a name="l01505"></a><span class="lineno"> 1505</span>&#160;      <span class="comment">// ucons not modified (i.e. modcons=0), but ucons may be used by diag_fixup()</span></div>
<div class="line"><a name="l01506"></a><span class="lineno"> 1506</span>&#160;      UtoU(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab2be21bd5eff40ca89c20eeecbeab5e0">UNOTHING</a>,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0339344098add3b8dbaaf3f753ed4b4f">UDIAG</a>,ptrgeom,Ugeomfree0,Ui);</div>
<div class="line"><a name="l01507"></a><span class="lineno"> 1507</span>&#160;      <span class="comment">// account for change to hot MHD conserved quantities</span></div>
<div class="line"><a name="l01508"></a><span class="lineno"> 1508</span>&#160;      <span class="keywordtype">int</span> counttype;</div>
<div class="line"><a name="l01509"></a><span class="lineno"> 1509</span>&#160;      <span class="keywordflow">if</span>(GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>)!=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab9759d44dd5fcddae024c6464ab6e769">UTOPRIMFAILFIXEDCOLD</a>) counttype=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8abe1988c6f1a6b93a649dad925ec1f0">COUNTCOLD</a>; <span class="comment">// count if not going to be counted later</span></div>
<div class="line"><a name="l01510"></a><span class="lineno"> 1510</span>&#160;      <span class="keywordflow">else</span> counttype=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aae4571e79c28a280618d20eebdb051cf" title="see failfloorcount counter">COUNTNOTHING</a>; <span class="comment">// do correction, but don&#39;t do counting until later</span></div>
<div class="line"><a name="l01511"></a><span class="lineno"> 1511</span>&#160;      <span class="comment">//      diag_fixup_Ui_pf(modcons,Ui,pr,ptrgeom,finalstep,counttype);</span></div>
<div class="line"><a name="l01512"></a><span class="lineno"> 1512</span>&#160;</div>
<div class="line"><a name="l01513"></a><span class="lineno"> 1513</span>&#160;      <span class="comment">// KORALTODO: allowlocalfailurefixandnoreport could be used below to avoid reset, but for now let implicit solver be ok with cold inversion</span></div>
<div class="line"><a name="l01514"></a><span class="lineno"> 1514</span>&#160;      <span class="comment">// reset pflag since above does full accounting, unless need to average-out internal energy still</span></div>
<div class="line"><a name="l01515"></a><span class="lineno"> 1515</span>&#160;      <span class="keywordflow">if</span>(GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>)==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab9759d44dd5fcddae024c6464ab6e769">UTOPRIMFAILFIXEDCOLD</a>){</div>
<div class="line"><a name="l01516"></a><span class="lineno"> 1516</span>&#160;        GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>)=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#abdf9e55b7b15ec0bcd386055f1787f47">UTOPRIMNOFAIL</a>;</div>
<div class="line"><a name="l01517"></a><span class="lineno"> 1517</span>&#160;      }</div>
<div class="line"><a name="l01518"></a><span class="lineno"> 1518</span>&#160;</div>
<div class="line"><a name="l01519"></a><span class="lineno"> 1519</span>&#160;    }<span class="comment">// else if coldpflag is bad</span></div>
<div class="line"><a name="l01520"></a><span class="lineno"> 1520</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l01521"></a><span class="lineno"> 1521</span>&#160;</div>
<div class="line"><a name="l01522"></a><span class="lineno"> 1522</span>&#160;      <span class="comment">// set how failed</span></div>
<div class="line"><a name="l01523"></a><span class="lineno"> 1523</span>&#160;      GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>)=coldpflag;</div>
<div class="line"><a name="l01524"></a><span class="lineno"> 1524</span>&#160;</div>
<div class="line"><a name="l01525"></a><span class="lineno"> 1525</span>&#160;</div>
<div class="line"><a name="l01526"></a><span class="lineno"> 1526</span>&#160;      <span class="comment">// then both hot and cold are bad, so keep old</span></div>
<div class="line"><a name="l01527"></a><span class="lineno"> 1527</span>&#160;      <span class="comment">// GODMARK: Could try going to force-free and &quot;failing&quot; the parallel velocity so it gets averaged like internal energy in cold case!</span></div>
<div class="line"><a name="l01528"></a><span class="lineno"> 1528</span>&#160;      <span class="comment">// only can go to force-free if b^2/rho&gt;&gt;1 as well</span></div>
<div class="line"><a name="l01529"></a><span class="lineno"> 1529</span>&#160;      <span class="comment">// keep oldpflag and keep old solution</span></div>
<div class="line"><a name="l01530"></a><span class="lineno"> 1530</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl) pr[pl]=prold[pl];</div>
<div class="line"><a name="l01531"></a><span class="lineno"> 1531</span>&#160;</div>
<div class="line"><a name="l01532"></a><span class="lineno"> 1532</span>&#160;<span class="preprocessor">#if(PRODUCTION==0)      </span></div>
<div class="line"><a name="l01533"></a><span class="lineno"> 1533</span>&#160;<span class="preprocessor"></span>      <span class="keywordflow">if</span>(forcetry==0 &amp;&amp; debugfail&gt;=2) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;Tried cold and bad on finalstep=%d! t=%g steppart=%d nstep=%ld i=%d j=%d k=%d :: oldpflag=%d coldpflag=%d\n&quot;</span>,finalstep,<a class="code" href="../../d8/d5b/defs_8general_8h.html#ae1ee1e1c83c3f70e2e1afed4f4f5b41e">t</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a70170b90229f9fc05eebf8508a685c70">steppart</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a1a1088d87617078680f1fd0f0d707384">nstep</a>,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,oldpflag,coldpflag);</div>
<div class="line"><a name="l01534"></a><span class="lineno"> 1534</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01535"></a><span class="lineno"> 1535</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01536"></a><span class="lineno"> 1536</span>&#160;</div>
<div class="line"><a name="l01537"></a><span class="lineno"> 1537</span>&#160;    }</div>
<div class="line"><a name="l01538"></a><span class="lineno"> 1538</span>&#160;        </div>
<div class="line"><a name="l01539"></a><span class="lineno"> 1539</span>&#160;  }<span class="comment">// if bad failure of some kind</span></div>
<div class="line"><a name="l01540"></a><span class="lineno"> 1540</span>&#160;</div>
<div class="line"><a name="l01541"></a><span class="lineno"> 1541</span>&#160;  <span class="keywordflow">return</span>(coldtried);</div>
<div class="line"><a name="l01542"></a><span class="lineno"> 1542</span>&#160;}</div>
<div class="line"><a name="l01543"></a><span class="lineno"> 1543</span>&#160;</div>
<div class="line"><a name="l01544"></a><span class="lineno"> 1544</span>&#160;</div>
<div class="line"><a name="l01545"></a><span class="lineno"> 1545</span>&#160;</div>
<div class="line"><a name="l01546"></a><span class="lineno"> 1546</span>&#160;</div>
<div class="line"><a name="l01547"></a><span class="lineno"> 1547</span>&#160;</div>
<div class="line"><a name="l01548"></a><span class="lineno"> 1548</span>&#160;</div>
<div class="line"><a name="l01549"></a><span class="lineno"> 1549</span>&#160;</div>
<div class="line"><a name="l01551"></a><span class="lineno"> 1551</span>&#160;<span class="keywordtype">int</span> tryffdeinversion(<span class="keywordtype">int</span> showmessages, <span class="keywordtype">int</span> allowlocalfailurefixandnoreport, <span class="keywordtype">int</span> finalstep, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> oldpflag, <span class="keywordtype">int</span> forcetry, <span class="keywordtype">int</span> whichcap, <span class="keywordtype">int</span> modprim, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pi, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr0, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pressure, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ugeomfree, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ugeomfree0, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *qptr, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <span class="keyword">struct</span> <a class="code" href="../../db/d3a/structof__newtonstats.html">of_newtonstats</a> *newtonstats, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflagrad)</div>
<div class="line"><a name="l01552"></a><span class="lineno"> 1552</span>&#160;{</div>
<div class="line"><a name="l01553"></a><span class="lineno"> 1553</span>&#160;  <span class="keywordtype">int</span> ffdetried;</div>
<div class="line"><a name="l01554"></a><span class="lineno"> 1554</span>&#160;  <span class="keywordtype">int</span> pl;</div>
<div class="line"><a name="l01555"></a><span class="lineno"> 1555</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> prold[NPR],prffde[NPR];</div>
<div class="line"><a name="l01556"></a><span class="lineno"> 1556</span>&#160;  <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> ffdepflag;</div>
<div class="line"><a name="l01557"></a><span class="lineno"> 1557</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d1/d3e/utoprimgen_8c.html#a0a83e9e7fdd3cc595c5b8d0df88ec684" title="just picks the algorithm to invert">Utoprimgen_pick</a>(<span class="keywordtype">int</span> showmessages, <span class="keywordtype">int</span> allowlocalfailurefixandnoreport, <span class="keywordtype">int</span> which, <span class="keywordtype">int</span> eomtype, <span class="keywordtype">int</span> whichcap, <span class="keywordtype">int</span> parameter, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ugeomfree, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflag, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pressure, <span class="keyword">struct</span> <a class="code" href="../../db/d3a/structof__newtonstats.html">of_newtonstats</a> *newtonstats, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflagrad);</div>
<div class="line"><a name="l01558"></a><span class="lineno"> 1558</span>&#160;</div>
<div class="line"><a name="l01559"></a><span class="lineno"> 1559</span>&#160;</div>
<div class="line"><a name="l01560"></a><span class="lineno"> 1560</span>&#160;  <span class="comment">//  dualfprintf(fail_file,&quot;Got here in tryffdeinversion\n&quot;);</span></div>
<div class="line"><a name="l01561"></a><span class="lineno"> 1561</span>&#160;</div>
<div class="line"><a name="l01563"></a><span class="lineno"> 1563</span>&#160;  <span class="keywordtype">int</span> TRYNEWIFOLDUNEG=0;</div>
<div class="line"><a name="l01565"></a><span class="lineno"> 1565</span>&#160;  <span class="keywordtype">int</span> TRYNEWIFOLDRHONEG=0;</div>
<div class="line"><a name="l01567"></a><span class="lineno"> 1567</span>&#160;  <span class="keywordtype">int</span> TRYNEWIFOLDFAILCONV=1;</div>
<div class="line"><a name="l01568"></a><span class="lineno"> 1568</span>&#160;</div>
<div class="line"><a name="l01569"></a><span class="lineno"> 1569</span>&#160;  <span class="keywordtype">int</span> badfailure;</div>
<div class="line"><a name="l01570"></a><span class="lineno"> 1570</span>&#160;  <span class="keywordflow">if</span>( (TRYNEWIFOLDRHONEG==1 &amp;&amp; <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab883f9e4302c57b5bf243cad6d318972">IFUTOPRIMFAILSOFTRHORELATED</a>(oldpflag)) || (TRYNEWIFOLDUNEG==1 &amp;&amp; <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ac530de9aaf5536f3b22423a77cc9c391">IFUTOPRIMFAILSOFTNOTRHORELATED</a>(oldpflag)) || (TRYNEWIFOLDFAILCONV==1 &amp;&amp; <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0894a5e6c53e2e8a143d10be7a42d492">IFUTOPRIMFAIL</a>(oldpflag)) ){</div>
<div class="line"><a name="l01571"></a><span class="lineno"> 1571</span>&#160;    <span class="comment">// get here if want to fix up rho&lt;=0, u&lt;=0, or convergence failure</span></div>
<div class="line"><a name="l01572"></a><span class="lineno"> 1572</span>&#160;    <span class="comment">// First if() is needed since last conditional or else if() would trigger on any failure type</span></div>
<div class="line"><a name="l01573"></a><span class="lineno"> 1573</span>&#160;    badfailure=1;</div>
<div class="line"><a name="l01574"></a><span class="lineno"> 1574</span>&#160;  }</div>
<div class="line"><a name="l01575"></a><span class="lineno"> 1575</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l01576"></a><span class="lineno"> 1576</span>&#160;    <span class="comment">// then maybe not so bad failure</span></div>
<div class="line"><a name="l01577"></a><span class="lineno"> 1577</span>&#160;    <span class="comment">// e.g. if get here, do nothing when either rho&lt;=0 or u&lt;=0</span></div>
<div class="line"><a name="l01578"></a><span class="lineno"> 1578</span>&#160;    badfailure=0;</div>
<div class="line"><a name="l01579"></a><span class="lineno"> 1579</span>&#160;  }</div>
<div class="line"><a name="l01580"></a><span class="lineno"> 1580</span>&#160;</div>
<div class="line"><a name="l01581"></a><span class="lineno"> 1581</span>&#160;</div>
<div class="line"><a name="l01582"></a><span class="lineno"> 1582</span>&#160;</div>
<div class="line"><a name="l01583"></a><span class="lineno"> 1583</span>&#160;  <span class="comment">// see if ffde inversion makes sense to do</span></div>
<div class="line"><a name="l01584"></a><span class="lineno"> 1584</span>&#160;  <span class="keywordtype">int</span> includerad=0; <span class="comment">// just MHD inversion here</span></div>
<div class="line"><a name="l01585"></a><span class="lineno"> 1585</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> FFDEFACTOR=0.5; <span class="comment">// try to make use ffde to order unity errors</span></div>
<div class="line"><a name="l01586"></a><span class="lineno"> 1586</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../d2/dbf/metric_8h.html#abd133696cea6c0c1397c24e925e5039a">ISBLACKHOLEMCOORD</a>(<a class="code" href="../../da/d3e/definit_8h.html#ab343edb2f60f3de2d654dcf1c58e06a2" title="#else define MAXBND 3 endif">MCOORD</a>)){</div>
<div class="line"><a name="l01587"></a><span class="lineno"> 1587</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> <a class="code" href="../../dc/dd2/newcodediff_8txt.html#af84f2c3bf153920b7c8d186132d39bc7">V</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l01588"></a><span class="lineno"> 1588</span>&#160;    <a class="code" href="../../d9/de9/coord_8c.html#a96290375e27d5d0aa4d843b07e228e14" title="normally-used bl_coord[i,j,k] {i,j,k} -&gt; V only">bl_coord_ijk</a>(ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8936711f57f82d1fc75c21fa2894e1c6">CENT</a>,V);</div>
<div class="line"><a name="l01589"></a><span class="lineno"> 1589</span>&#160;    <span class="keywordflow">if</span>(V[1]&lt;<a class="code" href="../../d8/d5b/defs_8general_8h.html#a20e81ef2343c6d8db701c6613cbcd279">Rhor</a>) FFDEFACTOR=5.0; <span class="comment">// more aggressive inside horizon to keep field evolving</span></div>
<div class="line"><a name="l01590"></a><span class="lineno"> 1590</span>&#160;  }</div>
<div class="line"><a name="l01591"></a><span class="lineno"> 1591</span>&#160;  <span class="keywordtype">int</span> isffdeflow=isflowffde(FFDEFACTOR, pr0, qptr);</div>
<div class="line"><a name="l01592"></a><span class="lineno"> 1592</span>&#160;  <span class="keywordflow">if</span>(isffdeflow==0) <span class="keywordflow">if</span>(debugfail&gt;=2) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;in tryffdeinversion but isffdeflow=0\n&quot;</span>);</div>
<div class="line"><a name="l01593"></a><span class="lineno"> 1593</span>&#160;</div>
<div class="line"><a name="l01594"></a><span class="lineno"> 1594</span>&#160;</div>
<div class="line"><a name="l01595"></a><span class="lineno"> 1595</span>&#160;</div>
<div class="line"><a name="l01596"></a><span class="lineno"> 1596</span>&#160;  ffdetried=0;</div>
<div class="line"><a name="l01597"></a><span class="lineno"> 1597</span>&#160;  <span class="keywordflow">if</span>((badfailure || forcetry)&amp;&amp;isffdeflow){</div>
<div class="line"><a name="l01598"></a><span class="lineno"> 1598</span>&#160;    ffdetried=1;</div>
<div class="line"><a name="l01599"></a><span class="lineno"> 1599</span>&#160;      </div>
<div class="line"><a name="l01600"></a><span class="lineno"> 1600</span>&#160;</div>
<div class="line"><a name="l01601"></a><span class="lineno"> 1601</span>&#160;    <span class="comment">// then bad failure, so try to use ffde grmhd</span></div>
<div class="line"><a name="l01602"></a><span class="lineno"> 1602</span>&#160;    <span class="comment">// restore backup in case previous inversion changed things</span></div>
<div class="line"><a name="l01603"></a><span class="lineno"> 1603</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl){</div>
<div class="line"><a name="l01604"></a><span class="lineno"> 1604</span>&#160;      prold[pl]=pr[pl];</div>
<div class="line"><a name="l01605"></a><span class="lineno"> 1605</span>&#160;      Ugeomfree[pl]=Ugeomfree0[pl];</div>
<div class="line"><a name="l01606"></a><span class="lineno"> 1606</span>&#160;</div>
<div class="line"><a name="l01607"></a><span class="lineno"> 1607</span>&#160;      <span class="comment">// set guess and sets any pre-inverted quantities</span></div>
<div class="line"><a name="l01608"></a><span class="lineno"> 1608</span>&#160;      prffde[pl]=pr0[pl];</div>
<div class="line"><a name="l01609"></a><span class="lineno"> 1609</span>&#160;    }</div>
<div class="line"><a name="l01610"></a><span class="lineno"> 1610</span>&#160;    </div>
<div class="line"><a name="l01611"></a><span class="lineno"> 1611</span>&#160;    </div>
<div class="line"><a name="l01612"></a><span class="lineno"> 1612</span>&#160;    <span class="comment">// get ffde inversion</span></div>
<div class="line"><a name="l01613"></a><span class="lineno"> 1613</span>&#160;    <span class="comment">// NOTEMARK: Note use of EOMFFDE2 instead of EOMFFDE because FFDE used always from originally having density, so using non-cleaned version that uses initial W.</span></div>
<div class="line"><a name="l01614"></a><span class="lineno"> 1614</span>&#160;    <span class="comment">// REVERT to just EOMFFDE since current EOMFFDE2 (or 2nd version in utoprim_jon.c) is worse behavior for \gamma and bsq.</span></div>
<div class="line"><a name="l01615"></a><span class="lineno"> 1615</span>&#160;    <span class="comment">// Well, as long as only include W and not Q.B, does better than including Q.B, but still worse than just EOMFFDE</span></div>
<div class="line"><a name="l01616"></a><span class="lineno"> 1616</span>&#160;    <a class="code" href="../../d1/d3e/utoprimgen_8c.html#a0a83e9e7fdd3cc595c5b8d0df88ec684" title="just picks the algorithm to invert">Utoprimgen_pick</a>(showmessages, allowlocalfailurefixandnoreport, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#abeac8c89d7fa922563d79f9278b4d44d" title="8: Jon 1D/2D final version  can handle non-rel problems">UTOPRIMJONNONRELCOMPAT</a>, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6f6094bc467dc61f9490ad7e1de63580">EOMFFDE</a>, whichcap, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a4a02957480e290a978d1f29992125c15" title="for WHICHENTROPYEVOLVE">EVOLVENOENTROPY</a>, Ugeomfree, ptrgeom, &amp;ffdepflag, prffde,pressure,newtonstats, lpflagrad);</div>
<div class="line"><a name="l01617"></a><span class="lineno"> 1617</span>&#160;</div>
<div class="line"><a name="l01618"></a><span class="lineno"> 1618</span>&#160;    </div>
<div class="line"><a name="l01620"></a><span class="lineno"> 1620</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01621"></a><span class="lineno"> 1621</span>&#160;    <span class="comment">// check if ffde solution is good</span></div>
<div class="line"><a name="l01622"></a><span class="lineno"> 1622</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afaacb1c256e44ec7be2adaac65713f2b">IFUTOPRIMNOFAILORFIXED</a>(ffdepflag)){</div>
<div class="line"><a name="l01623"></a><span class="lineno"> 1623</span>&#160;</div>
<div class="line"><a name="l01624"></a><span class="lineno"> 1624</span>&#160;      GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>)=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a106ea074dc50a3fcea35e1bcfc7726f4">UTOPRIMFAILFIXEDFFDE</a>; <span class="comment">// default then is that no failure (or fixed failure)</span></div>
<div class="line"><a name="l01625"></a><span class="lineno"> 1625</span>&#160;</div>
<div class="line"><a name="l01626"></a><span class="lineno"> 1626</span>&#160;      <span class="comment">// then keep ffde solution</span></div>
<div class="line"><a name="l01627"></a><span class="lineno"> 1627</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl) pr[pl]=prffde[pl];</div>
<div class="line"><a name="l01628"></a><span class="lineno"> 1628</span>&#160;      <span class="comment">//  if rho or u_g are not negligible or unknown, then should average or evolve!</span></div>
<div class="line"><a name="l01629"></a><span class="lineno"> 1629</span>&#160;      pl=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>; pr[pl] = pr0[pl]; <span class="comment">// but keep rho from prior hot.</span></div>
<div class="line"><a name="l01630"></a><span class="lineno"> 1630</span>&#160;      pl=UU; pr[pl] = pr0[pl]; <span class="comment">// but keep u_g from prior hot.</span></div>
<div class="line"><a name="l01631"></a><span class="lineno"> 1631</span>&#160;      <span class="comment">// EOMFFDE2 above tries to keep evolve v.B value.</span></div>
<div class="line"><a name="l01632"></a><span class="lineno"> 1632</span>&#160;      </div>
<div class="line"><a name="l01633"></a><span class="lineno"> 1633</span>&#160;</div>
<div class="line"><a name="l01634"></a><span class="lineno"> 1634</span>&#160;</div>
<div class="line"><a name="l01635"></a><span class="lineno"> 1635</span>&#160;      <span class="comment">// but set internal energy to previous value (should really evolve with entropy equation, but if negligible and no strong shocks, then ok )</span></div>
<div class="line"><a name="l01636"></a><span class="lineno"> 1636</span>&#160;      <span class="comment">// GODMARK: another ok way is to set special failure that only averages internal energy!  Then can evolve at least -- in some diffusive way</span></div>
<div class="line"><a name="l01637"></a><span class="lineno"> 1637</span>&#160;      </div>
<div class="line"><a name="l01638"></a><span class="lineno"> 1638</span>&#160;<span class="preprocessor">#if(PRODUCTION==0)      </span></div>
<div class="line"><a name="l01639"></a><span class="lineno"> 1639</span>&#160;<span class="preprocessor"></span>      <span class="keywordflow">if</span>(forcetry==0 &amp;&amp; debugfail&gt;=2) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;Tried ffde and good on finalstep=%d! i=%d j=%d k=%d :: oldpflag=%d ffdepflag=%d\n&quot;</span>,finalstep,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,oldpflag,ffdepflag);</div>
<div class="line"><a name="l01640"></a><span class="lineno"> 1640</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01641"></a><span class="lineno"> 1641</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01643"></a><span class="lineno"> 1643</span>&#160;      <span class="comment">// then very bad failure, so try ffde inversion and average internal energy for now</span></div>
<div class="line"><a name="l01644"></a><span class="lineno"> 1644</span>&#160;      GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>)=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a4fb558d7d5fa8343d7ca417d8b0bb418">UTOPRIMFAILURHO2AVG1FROMFFDE</a>; <span class="comment">// assume only internal energy needs correcting by averaging</span></div>
<div class="line"><a name="l01645"></a><span class="lineno"> 1645</span>&#160;      </div>
<div class="line"><a name="l01646"></a><span class="lineno"> 1646</span>&#160;</div>
<div class="line"><a name="l01647"></a><span class="lineno"> 1647</span>&#160;</div>
<div class="line"><a name="l01648"></a><span class="lineno"> 1648</span>&#160;</div>
<div class="line"><a name="l01649"></a><span class="lineno"> 1649</span>&#160;</div>
<div class="line"><a name="l01650"></a><span class="lineno"> 1650</span>&#160;</div>
<div class="line"><a name="l01651"></a><span class="lineno"> 1651</span>&#160;      <span class="comment">// accounting (since fixup.c accounting doesn&#39;t know what original pr0 is and actual prold is undefined since U-&gt;pr wasn&#39;t possible)</span></div>
<div class="line"><a name="l01652"></a><span class="lineno"> 1652</span>&#160;      <span class="comment">// GODMARK: For DOENOFLUX&gt;0, should modify conserved quantity in some way.  For DOENOFLUX==0, primitives form basis of conserved quantities, so once primitives are modified all is done.  So should probably pass in U[] from  Utoprimgen() or whatever is the full conserved quantity later used.</span></div>
<div class="line"><a name="l01653"></a><span class="lineno"> 1653</span>&#160;      <span class="keywordtype">int</span> modcons=(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a55732148d2616d6d1f5d2abbe8710850">DOENOFLUX</a> != <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#adacaaf8526353cfe870206f0cf4d2ca7" title="for DOENOFLUX: 0: no ENO flux reconstruction 1: reconstruct F for finite difference rep...">NOENOFLUX</a>);</div>
<div class="line"><a name="l01654"></a><span class="lineno"> 1654</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Ui[NPR];</div>
<div class="line"><a name="l01655"></a><span class="lineno"> 1655</span>&#160;      <span class="comment">// ucons not modified (i.e. modcons=0), but ucons may be used by diag_fixup()</span></div>
<div class="line"><a name="l01656"></a><span class="lineno"> 1656</span>&#160;      UtoU(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab2be21bd5eff40ca89c20eeecbeab5e0">UNOTHING</a>,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0339344098add3b8dbaaf3f753ed4b4f">UDIAG</a>,ptrgeom,Ugeomfree0,Ui);</div>
<div class="line"><a name="l01657"></a><span class="lineno"> 1657</span>&#160;      <span class="comment">// account for change to hot MHD conserved quantities</span></div>
<div class="line"><a name="l01658"></a><span class="lineno"> 1658</span>&#160;      <span class="keywordtype">int</span> counttype;</div>
<div class="line"><a name="l01659"></a><span class="lineno"> 1659</span>&#160;      <span class="keywordflow">if</span>(GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>)!=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a106ea074dc50a3fcea35e1bcfc7726f4">UTOPRIMFAILFIXEDFFDE</a>) counttype=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0dda43c4bdbf60d595e12f9f1ca81fc9">COUNTFFDE</a>;</div>
<div class="line"><a name="l01660"></a><span class="lineno"> 1660</span>&#160;      <span class="keywordflow">else</span> counttype=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aae4571e79c28a280618d20eebdb051cf" title="see failfloorcount counter">COUNTNOTHING</a>; <span class="comment">// do correction, but don&#39;t do counting until later</span></div>
<div class="line"><a name="l01661"></a><span class="lineno"> 1661</span>&#160;      <span class="comment">//      diag_fixup_Ui_pf(modcons,Ui,pr,ptrgeom,finalstep,counttype);</span></div>
<div class="line"><a name="l01662"></a><span class="lineno"> 1662</span>&#160;</div>
<div class="line"><a name="l01663"></a><span class="lineno"> 1663</span>&#160;      <span class="comment">// KORALTODO: allowlocalfailurefixandnoreport could be used below to avoid reset, but for now let implicit solver be ok with ffde inversion</span></div>
<div class="line"><a name="l01664"></a><span class="lineno"> 1664</span>&#160;      <span class="comment">// reset pflag since above does full accounting, unless need to average-out internal energy still</span></div>
<div class="line"><a name="l01665"></a><span class="lineno"> 1665</span>&#160;      <span class="keywordflow">if</span>(GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>)==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a106ea074dc50a3fcea35e1bcfc7726f4">UTOPRIMFAILFIXEDFFDE</a>){</div>
<div class="line"><a name="l01666"></a><span class="lineno"> 1666</span>&#160;        GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>)=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#abdf9e55b7b15ec0bcd386055f1787f47">UTOPRIMNOFAIL</a>;</div>
<div class="line"><a name="l01667"></a><span class="lineno"> 1667</span>&#160;      }</div>
<div class="line"><a name="l01668"></a><span class="lineno"> 1668</span>&#160;</div>
<div class="line"><a name="l01669"></a><span class="lineno"> 1669</span>&#160;</div>
<div class="line"><a name="l01670"></a><span class="lineno"> 1670</span>&#160;    }<span class="comment">// else if ffdepflag is bad</span></div>
<div class="line"><a name="l01671"></a><span class="lineno"> 1671</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l01672"></a><span class="lineno"> 1672</span>&#160;      </div>
<div class="line"><a name="l01673"></a><span class="lineno"> 1673</span>&#160;      <span class="comment">// set how failed</span></div>
<div class="line"><a name="l01674"></a><span class="lineno"> 1674</span>&#160;      GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>)=ffdepflag;</div>
<div class="line"><a name="l01675"></a><span class="lineno"> 1675</span>&#160;</div>
<div class="line"><a name="l01676"></a><span class="lineno"> 1676</span>&#160;      <span class="comment">// then both hot and ffde are bad, so keep old</span></div>
<div class="line"><a name="l01677"></a><span class="lineno"> 1677</span>&#160;      <span class="comment">// GODMARK: Could try going to force-free and &quot;failing&quot; the parallel velocity so it gets averaged like internal energy in ffde case!</span></div>
<div class="line"><a name="l01678"></a><span class="lineno"> 1678</span>&#160;      <span class="comment">// only can go to force-free if b^2/rho&gt;&gt;1 as well</span></div>
<div class="line"><a name="l01679"></a><span class="lineno"> 1679</span>&#160;      <span class="comment">// keep oldpflag and keep old solution</span></div>
<div class="line"><a name="l01680"></a><span class="lineno"> 1680</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl) pr[pl]=prold[pl];</div>
<div class="line"><a name="l01681"></a><span class="lineno"> 1681</span>&#160;</div>
<div class="line"><a name="l01682"></a><span class="lineno"> 1682</span>&#160;<span class="preprocessor">#if(PRODUCTION==0)      </span></div>
<div class="line"><a name="l01683"></a><span class="lineno"> 1683</span>&#160;<span class="preprocessor"></span>      <span class="keywordflow">if</span>(forcetry==0 &amp;&amp; debugfail&gt;=2) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;Tried ffde and bad on finalstep=%d! t=%g steppart=%d nstep=%ld i=%d j=%d k=%d :: oldpflag=%d ffdepflag=%d\n&quot;</span>,finalstep,<a class="code" href="../../d8/d5b/defs_8general_8h.html#ae1ee1e1c83c3f70e2e1afed4f4f5b41e">t</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a70170b90229f9fc05eebf8508a685c70">steppart</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a1a1088d87617078680f1fd0f0d707384">nstep</a>,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,oldpflag,ffdepflag);</div>
<div class="line"><a name="l01684"></a><span class="lineno"> 1684</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01685"></a><span class="lineno"> 1685</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01686"></a><span class="lineno"> 1686</span>&#160;</div>
<div class="line"><a name="l01687"></a><span class="lineno"> 1687</span>&#160;    }</div>
<div class="line"><a name="l01688"></a><span class="lineno"> 1688</span>&#160;        </div>
<div class="line"><a name="l01689"></a><span class="lineno"> 1689</span>&#160;  }<span class="comment">// if bad failure of some kind</span></div>
<div class="line"><a name="l01690"></a><span class="lineno"> 1690</span>&#160;</div>
<div class="line"><a name="l01691"></a><span class="lineno"> 1691</span>&#160;  <span class="keywordflow">return</span>(ffdetried);</div>
<div class="line"><a name="l01692"></a><span class="lineno"> 1692</span>&#160;}</div>
<div class="line"><a name="l01693"></a><span class="lineno"> 1693</span>&#160;</div>
<div class="line"><a name="l01694"></a><span class="lineno"> 1694</span>&#160;</div>
<div class="line"><a name="l01695"></a><span class="lineno"> 1695</span>&#160;</div>
<div class="line"><a name="l01696"></a><span class="lineno"> 1696</span>&#160;</div>
<div class="line"><a name="l01697"></a><span class="lineno"> 1697</span>&#160;</div>
<div class="line"><a name="l01698"></a><span class="lineno"> 1698</span>&#160;</div>
<div class="line"><a name="l01699"></a><span class="lineno"> 1699</span>&#160;</div>
<div class="line"><a name="l01700"></a><span class="lineno"> 1700</span>&#160;</div>
<div class="line"><a name="l01701"></a><span class="lineno"> 1701</span>&#160;</div>
<div class="line"><a name="l01702"></a><span class="lineno"> 1702</span>&#160;</div>
<div class="line"><a name="l01709"></a><span class="lineno"> 1709</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> check_on_inversion(<span class="keywordtype">int</span> checkoninversiongas, <span class="keywordtype">int</span> checkoninversionrad, <span class="keywordtype">int</span> usedhotinversion,<span class="keywordtype">int</span> usedentropyinversion,<span class="keywordtype">int</span> usedcoldinversion,<span class="keywordtype">int</span> usedffdeinversion, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflag, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr0, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pressure, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Uold, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Unew, <span class="keyword">struct</span> <a class="code" href="../../db/d3a/structof__newtonstats.html">of_newtonstats</a> *newtonstats, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflagrad)</div>
<div class="line"><a name="l01710"></a><span class="lineno"> 1710</span>&#160;{</div>
<div class="line"><a name="l01711"></a><span class="lineno"> 1711</span>&#160;  <span class="keywordtype">int</span> badinversion,badinversionfail;</div>
<div class="line"><a name="l01712"></a><span class="lineno"> 1712</span>&#160;  <span class="keywordtype">int</span> badinversionrad,badinversionfailrad;</div>
<div class="line"><a name="l01713"></a><span class="lineno"> 1713</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Unormalnew[NPR],Unormalnewabs[NPR],Unormalold[NPR];</div>
<div class="line"><a name="l01714"></a><span class="lineno"> 1714</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fdiff[NPR];</div>
<div class="line"><a name="l01715"></a><span class="lineno"> 1715</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> q;</div>
<div class="line"><a name="l01716"></a><span class="lineno"> 1716</span>&#160;  <span class="keywordtype">int</span> pl,pliter;</div>
<div class="line"><a name="l01717"></a><span class="lineno"> 1717</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>,k,jj;</div>
<div class="line"><a name="l01718"></a><span class="lineno"> 1718</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> errornorm;</div>
<div class="line"><a name="l01719"></a><span class="lineno"> 1719</span>&#160; </div>
<div class="line"><a name="l01720"></a><span class="lineno"> 1720</span>&#160;</div>
<div class="line"><a name="l01721"></a><span class="lineno"> 1721</span>&#160;  <span class="comment">// see if should check at all</span></div>
<div class="line"><a name="l01722"></a><span class="lineno"> 1722</span>&#160;  <span class="keywordflow">if</span>(checkoninversiongas==0 &amp;&amp; checkoninversionrad==0) <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l01723"></a><span class="lineno"> 1723</span>&#160;</div>
<div class="line"><a name="l01724"></a><span class="lineno"> 1724</span>&#160;</div>
<div class="line"><a name="l01725"></a><span class="lineno"> 1725</span>&#160;</div>
<div class="line"><a name="l01727"></a><span class="lineno"> 1727</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01728"></a><span class="lineno"> 1728</span>&#160;  <span class="comment">// Store extra quantities to enforce consistency when using tabulated EOS</span></div>
<div class="line"><a name="l01729"></a><span class="lineno"> 1729</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01731"></a><span class="lineno"> 1731</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01732"></a><span class="lineno"> 1732</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#ad7d4ae935d29d9f729e14124b737a430" title="which EOS (EoS) (equation of state) to use">WHICHEOS</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ac8c53bdabe3bb26474339d60e0e7b644">KAZFULL</a> &amp;&amp; ptrgeom-&gt;p==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8936711f57f82d1fc75c21fa2894e1c6">CENT</a>){</div>
<div class="line"><a name="l01733"></a><span class="lineno"> 1733</span>&#160;    <span class="comment">// then store pressure to be used by get_stateforcheckinversion()</span></div>
<div class="line"><a name="l01734"></a><span class="lineno"> 1734</span>&#160;    <span class="comment">// assume standard inversion at loc=CENT</span></div>
<div class="line"><a name="l01735"></a><span class="lineno"> 1735</span>&#160;    GLOBALMACP0A1(EOSextraglobal,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,PGASGLOBAL)=(*pressure);</div>
<div class="line"><a name="l01736"></a><span class="lineno"> 1736</span>&#160;  }</div>
<div class="line"><a name="l01737"></a><span class="lineno"> 1737</span>&#160;</div>
<div class="line"><a name="l01738"></a><span class="lineno"> 1738</span>&#160;</div>
<div class="line"><a name="l01739"></a><span class="lineno"> 1739</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> prtest[NPR];</div>
<div class="line"><a name="l01740"></a><span class="lineno"> 1740</span>&#160;  <span class="comment">// since need to modify best version of pr for different eomtype&#39;s, use prtest locally</span></div>
<div class="line"><a name="l01741"></a><span class="lineno"> 1741</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) prtest[pl] = pr[pl];</div>
<div class="line"><a name="l01742"></a><span class="lineno"> 1742</span>&#160;</div>
<div class="line"><a name="l01743"></a><span class="lineno"> 1743</span>&#160;</div>
<div class="line"><a name="l01744"></a><span class="lineno"> 1744</span>&#160;  <span class="comment">// force test to be clean true inversion</span></div>
<div class="line"><a name="l01745"></a><span class="lineno"> 1745</span>&#160;  if(usedcoldinversion || usedffdeinversion){</div>
<div class="line"><a name="l01746"></a><span class="lineno"> 1746</span>&#160;    prtest[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>] = 0.0;</div>
<div class="line"><a name="l01747"></a><span class="lineno"> 1747</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#ad7d4ae935d29d9f729e14124b737a430" title="which EOS (EoS) (equation of state) to use">WHICHEOS</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ac8c53bdabe3bb26474339d60e0e7b644">KAZFULL</a> &amp;&amp; ptrgeom-&gt;p==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8936711f57f82d1fc75c21fa2894e1c6">CENT</a>){</div>
<div class="line"><a name="l01748"></a><span class="lineno"> 1748</span>&#160;      GLOBALMACP0A1(EOSextraglobal,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,PGASGLOBAL)=0.0;</div>
<div class="line"><a name="l01749"></a><span class="lineno"> 1749</span>&#160;    }</div>
<div class="line"><a name="l01750"></a><span class="lineno"> 1750</span>&#160;  }</div>
<div class="line"><a name="l01751"></a><span class="lineno"> 1751</span>&#160;  <span class="keywordflow">if</span>(usedffdeinversion){</div>
<div class="line"><a name="l01752"></a><span class="lineno"> 1752</span>&#160;    prtest[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>]=0.0;</div>
<div class="line"><a name="l01753"></a><span class="lineno"> 1753</span>&#160;  }</div>
<div class="line"><a name="l01754"></a><span class="lineno"> 1754</span>&#160;  </div>
<div class="line"><a name="l01755"></a><span class="lineno"> 1755</span>&#160;</div>
<div class="line"><a name="l01756"></a><span class="lineno"> 1756</span>&#160;  <span class="comment">// assume not bad</span></div>
<div class="line"><a name="l01757"></a><span class="lineno"> 1757</span>&#160;  badinversion=badinversionfail=0;</div>
<div class="line"><a name="l01758"></a><span class="lineno"> 1758</span>&#160;  badinversionrad=badinversionfailrad=0;</div>
<div class="line"><a name="l01759"></a><span class="lineno"> 1759</span>&#160;</div>
<div class="line"><a name="l01760"></a><span class="lineno"> 1760</span>&#160;</div>
<div class="line"><a name="l01761"></a><span class="lineno"> 1761</span>&#160;</div>
<div class="line"><a name="l01762"></a><span class="lineno"> 1762</span>&#160;  <span class="comment">//  if(1 || !(*lpflag)){ // only report if not failure and not fixup (in which case U might differ)</span></div>
<div class="line"><a name="l01763"></a><span class="lineno"> 1763</span>&#160;  <span class="keywordflow">if</span>(*lpflag==0 || *lpflagrad==0){ <span class="comment">// only report if not failure and not fixup (in which case U might differ)</span></div>
<div class="line"><a name="l01764"></a><span class="lineno"> 1764</span>&#160;</div>
<div class="line"><a name="l01766"></a><span class="lineno"> 1766</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01767"></a><span class="lineno"> 1767</span>&#160;    <span class="comment">// get new U (only applicable if hot inversion used)</span></div>
<div class="line"><a name="l01768"></a><span class="lineno"> 1768</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01770"></a><span class="lineno"> 1770</span>&#160;<span class="comment"></span>    <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a689a0d22ad988934812b24448f9f8e91" title="used to check inversion, which has consistent pressure used to get things as functions of  instead of...">get_stateforcheckinversion</a>(prtest, ptrgeom, &amp;q),<span class="stringliteral">&quot;flux.c:fluxcalc()&quot;</span>, <span class="stringliteral">&quot;get_state()&quot;</span>, 1);</div>
<div class="line"><a name="l01771"></a><span class="lineno"> 1771</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Unewabs[NPR];</div>
<div class="line"><a name="l01772"></a><span class="lineno"> 1772</span>&#160;    <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a9a54096e4c40a15a2c1bf74266153616" title="calculate &quot;conserved&quot; quantities">primtoU</a>(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab2be21bd5eff40ca89c20eeecbeab5e0">UNOTHING</a>,prtest, &amp;q, ptrgeom, Unew, Unewabs),<span class="stringliteral">&quot;step_ch.c:advance()&quot;</span>, <span class="stringliteral">&quot;primtoU()&quot;</span>, 1); <span class="comment">// UtoU inside doesn&#39;t do anything...therefore for REMOVERESTMASSFROMUU==1, Unew[UU] will have rest-mass included</span></div>
<div class="line"><a name="l01773"></a><span class="lineno"> 1773</span>&#160;</div>
<div class="line"><a name="l01775"></a><span class="lineno"> 1775</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01776"></a><span class="lineno"> 1776</span>&#160;    <span class="comment">// Create a normalized (geometrically) conserved quantity</span></div>
<div class="line"><a name="l01777"></a><span class="lineno"> 1777</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01779"></a><span class="lineno"> 1779</span>&#160;<span class="comment"></span>    <span class="comment">// assume default value assignment for normalized version of U</span></div>
<div class="line"><a name="l01780"></a><span class="lineno"> 1780</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l01781"></a><span class="lineno"> 1781</span>&#160;      Unormalold[pl] = Uold[pl];</div>
<div class="line"><a name="l01782"></a><span class="lineno"> 1782</span>&#160;      Unormalnew[pl] = Unew[pl];</div>
<div class="line"><a name="l01783"></a><span class="lineno"> 1783</span>&#160;      Unormalnewabs[pl] = Unewabs[pl];</div>
<div class="line"><a name="l01784"></a><span class="lineno"> 1784</span>&#160;    }      </div>
<div class="line"><a name="l01785"></a><span class="lineno"> 1785</span>&#160;</div>
<div class="line"><a name="l01786"></a><span class="lineno"> 1786</span>&#160;<span class="preprocessor">#if(REMOVERESTMASSFROMUU==2)</span></div>
<div class="line"><a name="l01787"></a><span class="lineno"> 1787</span>&#160;<span class="preprocessor"></span>    <span class="comment">// now make U_0 and U_i comparable</span></div>
<div class="line"><a name="l01788"></a><span class="lineno"> 1788</span>&#160;    <span class="comment">// like \rho\gamma^2 v^2/(1+\gamma) + (u+p)\gamma^2 \sim \rho \gamma v^2 + (u+p)\gamma^2</span></div>
<div class="line"><a name="l01789"></a><span class="lineno"> 1789</span>&#160;    <span class="comment">// In the limit as v-&gt;0, this can be compared against the normalized version of the U_i terms</span></div>
<div class="line"><a name="l01790"></a><span class="lineno"> 1790</span>&#160;    Unormalold[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>] = Uold[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>];</div>
<div class="line"><a name="l01791"></a><span class="lineno"> 1791</span>&#160;    Unormalnew[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>] = Unew[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>];</div>
<div class="line"><a name="l01792"></a><span class="lineno"> 1792</span>&#160;    Unormalnewabs[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>] = Unewabs[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>];</div>
<div class="line"><a name="l01793"></a><span class="lineno"> 1793</span>&#160;</div>
<div class="line"><a name="l01794"></a><span class="lineno"> 1794</span>&#160;    <span class="comment">// No longer doing below, just use gcon or gcov to get correct dimensional comparison</span></div>
<div class="line"><a name="l01795"></a><span class="lineno"> 1795</span>&#160;    <span class="comment">// now deal with momentum terms and correct for geometry so all U_i&#39;s are comparable</span></div>
<div class="line"><a name="l01796"></a><span class="lineno"> 1796</span>&#160;    <span class="comment">// (\rho+u+p)\gamma u_i -&gt; (\rho+u+p)\gamma^2 v^2</span></div>
<div class="line"><a name="l01797"></a><span class="lineno"> 1797</span>&#160;    <span class="comment">//    SLOOPA(jj) Unormalold[UU+jj] = Uold[UU+jj]*(q.ucon[jj]/q.ucon[TT]);</span></div>
<div class="line"><a name="l01798"></a><span class="lineno"> 1798</span>&#160;    <span class="comment">//    SLOOPA(jj) Unormalnew[UU+jj] = Unew[UU+jj]*(q.ucon[jj]/q.ucon[TT]);</span></div>
<div class="line"><a name="l01799"></a><span class="lineno"> 1799</span>&#160;    <span class="comment">//    SLOOPA(jj) Unormalnewabs[UU+jj] = Unewabs[UU+jj]*(q.ucon[jj]/q.ucon[TT]);</span></div>
<div class="line"><a name="l01800"></a><span class="lineno"> 1800</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01801"></a><span class="lineno"> 1801</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01802"></a><span class="lineno"> 1802</span>&#160;</div>
<div class="line"><a name="l01803"></a><span class="lineno"> 1803</span>&#160;</div>
<div class="line"><a name="l01805"></a><span class="lineno"> 1805</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01806"></a><span class="lineno"> 1806</span>&#160;    <span class="comment">// now check for errors</span></div>
<div class="line"><a name="l01807"></a><span class="lineno"> 1807</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01809"></a><span class="lineno"> 1809</span>&#160;<span class="comment"></span>    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l01810"></a><span class="lineno"> 1810</span>&#160;</div>
<div class="line"><a name="l01811"></a><span class="lineno"> 1811</span>&#160;      <span class="keywordflow">if</span>(checkoninversiongas==0 &amp;&amp; (pl!=PRAD0 &amp;&amp; pl!=PRAD1 &amp;&amp; pl!=PRAD2 &amp;&amp; pl!=PRAD3)) <span class="keywordflow">continue</span>; <span class="comment">// don&#39;t check MHD (non-radiation) inversion if didn&#39;t want to</span></div>
<div class="line"><a name="l01812"></a><span class="lineno"> 1812</span>&#160;      <span class="keywordflow">if</span>(checkoninversionrad==0 &amp;&amp; (pl==PRAD0 &amp;&amp; pl==PRAD1 &amp;&amp; pl==PRAD2 &amp;&amp; pl==PRAD3)) <span class="keywordflow">continue</span>; <span class="comment">// don&#39;t check radiation (non-MHD) inversion if didn&#39;t want to</span></div>
<div class="line"><a name="l01813"></a><span class="lineno"> 1813</span>&#160;  </div>
<div class="line"><a name="l01814"></a><span class="lineno"> 1814</span>&#160;</div>
<div class="line"><a name="l01815"></a><span class="lineno"> 1815</span>&#160;      <span class="comment">// default is to assume nothing wrong</span></div>
<div class="line"><a name="l01816"></a><span class="lineno"> 1816</span>&#160;      fdiff[pl]=0.0;</div>
<div class="line"><a name="l01817"></a><span class="lineno"> 1817</span>&#160;</div>
<div class="line"><a name="l01818"></a><span class="lineno"> 1818</span>&#160;</div>
<div class="line"><a name="l01819"></a><span class="lineno"> 1819</span>&#160;      <span class="comment">// pl here is conserved quantity, so checking if conserved quantity not same as used to get primitive</span></div>
<div class="line"><a name="l01820"></a><span class="lineno"> 1820</span>&#160;      <span class="comment">// in force-free projection on velocity always occurs that makes momenta terms not the same</span></div>
<div class="line"><a name="l01821"></a><span class="lineno"> 1821</span>&#160;      <span class="comment">// no point checking if inversion doesn&#39;t handle or is inconsistent with conservation of that quantity</span></div>
<div class="line"><a name="l01822"></a><span class="lineno"> 1822</span>&#160;      <span class="keywordflow">if</span>(usedffdeinversion &amp;&amp; (pl==RHO || pl==UU || pl==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a> || pl==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae907e773ef038f3fc0c2ad5de0cb0f07">U2</a> || pl==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8de9104f1fffa59f057b214d74c5cfea">U3</a> || pl==ENTROPY || <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ad50f2824bc8460c8e155508477b7f31e">SCALARPL</a>(pl)) ) <span class="keywordflow">continue</span>; <span class="comment">// if ffde, no mass or thermal/hot components</span></div>
<div class="line"><a name="l01823"></a><span class="lineno"> 1823</span>&#160;      <span class="keywordflow">if</span>(usedcoldinversion  &amp;&amp; (pl==UU || pl==ENTROPY || <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ad50f2824bc8460c8e155508477b7f31e">SCALARPL</a>(pl)) ) <span class="keywordflow">continue</span>; <span class="comment">// if cold, can&#39;t evolve any hot or thermal component</span></div>
<div class="line"><a name="l01824"></a><span class="lineno"> 1824</span>&#160;      <span class="comment">// inversion either uses energy or entropy and can&#39;t use both at once inside inversion routine</span></div>
<div class="line"><a name="l01825"></a><span class="lineno"> 1825</span>&#160;      <span class="keywordflow">if</span>(usedentropyinversion  &amp;&amp; (pl==UU) ) <span class="keywordflow">continue</span>; <span class="comment">// entropy doesn&#39;t use energy equation, but does use conserved entropy</span></div>
<div class="line"><a name="l01826"></a><span class="lineno"> 1826</span>&#160;      <span class="keywordflow">if</span>(usedhotinversion &amp;&amp; (pl==ENTROPY) ) <span class="keywordflow">continue</span>; <span class="comment">// hot doesn&#39;t use entropy, but does use conserved energy</span></div>
<div class="line"><a name="l01827"></a><span class="lineno"> 1827</span>&#160;</div>
<div class="line"><a name="l01828"></a><span class="lineno"> 1828</span>&#160;      <span class="comment">//(EOMRADTYPE==EOMRADNONE &amp;&amp; (pl==URAD0 || pl==URAD1 || pl==URAD2 || pl==URAD3)) || // no need to check pl if no such pl&#39;s</span></div>
<div class="line"><a name="l01829"></a><span class="lineno"> 1829</span>&#160;      <span class="comment">// lpflagrad: Checks that if u2p placed limiter on p (e.g. velocity), then should skip this check since won&#39;t be accurate inversion</span></div>
<div class="line"><a name="l01830"></a><span class="lineno"> 1830</span>&#160;      <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#a99ba7daf58b283bc831b8f507f5873a4" title="#define EOMTYPE EOMCOLDGRMHD">EOMRADTYPE</a>!=<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a993e29ef4139116d822d89bccb92180d" title="radiation equations of motion">EOMRADNONE</a> &amp;&amp; (*lpflagrad!=0)) <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l01831"></a><span class="lineno"> 1831</span>&#160;      <span class="comment">// If doing Eddington approximation, actually ignore conserved flux evolution.</span></div>
<div class="line"><a name="l01832"></a><span class="lineno"> 1832</span>&#160;      <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#a99ba7daf58b283bc831b8f507f5873a4" title="#define EOMTYPE EOMCOLDGRMHD">EOMRADTYPE</a>==<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#aeecbb1829400fae0bc7971d41ca4222d">EOMRADEDD</a> &amp;&amp; (pl==URAD1 || pl==URAD2 || pl==URAD3)) <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l01833"></a><span class="lineno"> 1833</span>&#160;</div>
<div class="line"><a name="l01834"></a><span class="lineno"> 1834</span>&#160;</div>
<div class="line"><a name="l01835"></a><span class="lineno"> 1835</span>&#160;      <span class="keywordflow">if</span>(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ad50f2824bc8460c8e155508477b7f31e">SCALARPL</a>(pl)){</div>
<div class="line"><a name="l01836"></a><span class="lineno"> 1836</span>&#160;        <span class="comment">// only check that new U is finite</span></div>
<div class="line"><a name="l01837"></a><span class="lineno"> 1837</span>&#160;        <span class="keywordflow">if</span>(!<a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(Unormalnew[pl])){</div>
<div class="line"><a name="l01838"></a><span class="lineno"> 1838</span>&#160;          fdiff[pl]=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>; <span class="comment">// indicates was not finite</span></div>
<div class="line"><a name="l01839"></a><span class="lineno"> 1839</span>&#160;        }</div>
<div class="line"><a name="l01840"></a><span class="lineno"> 1840</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">continue</span>; <span class="comment">// then avoid checking passive scalars in case manipulated</span></div>
<div class="line"><a name="l01841"></a><span class="lineno"> 1841</span>&#160;      }</div>
<div class="line"><a name="l01842"></a><span class="lineno"> 1842</span>&#160;</div>
<div class="line"><a name="l01843"></a><span class="lineno"> 1843</span>&#160;      <span class="comment">// leave geometry out of it</span></div>
<div class="line"><a name="l01844"></a><span class="lineno"> 1844</span>&#160;      <span class="comment">//      Unormalnew[pl]*=ptrgeom-&gt;gdet;</span></div>
<div class="line"><a name="l01845"></a><span class="lineno"> 1845</span>&#160;      <span class="comment">//      Unormalold[pl]*=ptrgeom-&gt;gdet;</span></div>
<div class="line"><a name="l01846"></a><span class="lineno"> 1846</span>&#160;      <span class="keywordflow">if</span>(pl==RHO || pl==UU || pl==URAD0&amp;&amp;(*lpflagrad==0)){</div>
<div class="line"><a name="l01847"></a><span class="lineno"> 1847</span>&#160;        errornorm=(fabs(Unormalnewabs[pl])+fabs(Unormalnew[pl])+fabs(Unormalold[pl])+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a09c78d2f8feb311dd9fc969a0bf84979">SMALL</a>);</div>
<div class="line"><a name="l01848"></a><span class="lineno"> 1848</span>&#160;        <span class="comment">// KORALTODO: when URAD0&lt;&lt;UU, can&#39;t expect radiation error to be small relative to only itself when interaction between radiation and fluid. </span></div>
<div class="line"><a name="l01849"></a><span class="lineno"> 1849</span>&#160;        <span class="keywordflow">if</span>(pl==URAD0) errornorm+=(fabs(Unormalnewabs[UU])+fabs(Unormalnew[UU])+fabs(Unormalold[UU])+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a09c78d2f8feb311dd9fc969a0bf84979">SMALL</a>);</div>
<div class="line"><a name="l01850"></a><span class="lineno"> 1850</span>&#160;        fdiff[pl] = fabs(Unormalnew[pl]-Unormalold[pl])/errornorm;</div>
<div class="line"><a name="l01851"></a><span class="lineno"> 1851</span>&#160;      }</div>
<div class="line"><a name="l01852"></a><span class="lineno"> 1852</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span>(pl==ENTROPY){</div>
<div class="line"><a name="l01853"></a><span class="lineno"> 1853</span>&#160;        <span class="comment">// can be + or -, so use positive definite exp(S/rho)=exp(s) version</span></div>
<div class="line"><a name="l01854"></a><span class="lineno"> 1854</span>&#160;        <span class="comment">//        errornorm=(fabs(exp(Unormalnew[pl]/(SMALL+fabs(Unormalnew[RHO]))))+fabs(exp(Unormalold[pl]/(SMALL+fabs(Unormalold[RHO]))))+SMALL);</span></div>
<div class="line"><a name="l01855"></a><span class="lineno"> 1855</span>&#160;        <span class="comment">//        fdiff[pl] = fabs(exp(Unormalnew[pl]/(SMALL+fabs(Unormalnew[RHO])))-exp(Unormalold[pl]/(SMALL+fabs(Unormalold[RHO]))))/errornorm;</span></div>
<div class="line"><a name="l01856"></a><span class="lineno"> 1856</span>&#160;        <span class="comment">// TdS / (TdS + E)</span></div>
<div class="line"><a name="l01857"></a><span class="lineno"> 1857</span>&#160;        <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Tgasnew=compute_temp_simple(ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,ptrgeom-&gt;p,prtest[RHO],prtest[UU]);</div>
<div class="line"><a name="l01858"></a><span class="lineno"> 1858</span>&#160;        <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Tgasold=compute_temp_simple(ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,ptrgeom-&gt;p,pr0[RHO],pr0[UU]);</div>
<div class="line"><a name="l01859"></a><span class="lineno"> 1859</span>&#160;        errornorm=(fabs(Tgasnew)+fabs(Tgasold))*(fabs(Unormalnewabs[pl])+fabs(Unormalnew[pl])+fabs(Unormalold[pl])+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a09c78d2f8feb311dd9fc969a0bf84979">SMALL</a>) + (fabs(Unormalnewabs[UU])+fabs(Unormalnew[UU])+fabs(Unormalold[UU])+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a09c78d2f8feb311dd9fc969a0bf84979">SMALL</a>);</div>
<div class="line"><a name="l01860"></a><span class="lineno"> 1860</span>&#160;        fdiff[pl] = (fabs(Tgasnew)+fabs(Tgasold))*fabs(Unormalnew[pl]-Unormalold[pl])/errornorm;</div>
<div class="line"><a name="l01861"></a><span class="lineno"> 1861</span>&#160;      }</div>
<div class="line"><a name="l01862"></a><span class="lineno"> 1862</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span>(pl==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a> || pl==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae907e773ef038f3fc0c2ad5de0cb0f07">U2</a> || pl==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8de9104f1fffa59f057b214d74c5cfea">U3</a>){</div>
<div class="line"><a name="l01863"></a><span class="lineno"> 1863</span>&#160;</div>
<div class="line"><a name="l01864"></a><span class="lineno"> 1864</span>&#160;        errornorm  = <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a987db2b5d50589e097378a13c5d87fef">THIRD</a>*<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a987db2b5d50589e097378a13c5d87fef">THIRD</a>*(</div>
<div class="line"><a name="l01865"></a><span class="lineno"> 1865</span>&#160;                                  +(fabs(Unormalnewabs[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>]) + fabs(Unormalnew[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>]) + fabs(Unormalold[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>]))*sqrt(fabs(ptrgeom-&gt;gcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(1,1)]))</div>
<div class="line"><a name="l01866"></a><span class="lineno"> 1866</span>&#160;                                  +(fabs(Unormalnewabs[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae907e773ef038f3fc0c2ad5de0cb0f07">U2</a>]) + fabs(Unormalnew[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae907e773ef038f3fc0c2ad5de0cb0f07">U2</a>]) + fabs(Unormalold[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae907e773ef038f3fc0c2ad5de0cb0f07">U2</a>]))*sqrt(fabs(ptrgeom-&gt;gcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(2,2)]))</div>
<div class="line"><a name="l01867"></a><span class="lineno"> 1867</span>&#160;                                  +(fabs(Unormalnewabs[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8de9104f1fffa59f057b214d74c5cfea">U3</a>]) + fabs(Unormalnew[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8de9104f1fffa59f057b214d74c5cfea">U3</a>]) + fabs(Unormalold[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8de9104f1fffa59f057b214d74c5cfea">U3</a>]))*sqrt(fabs(ptrgeom-&gt;gcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(3,3)]))</div>
<div class="line"><a name="l01868"></a><span class="lineno"> 1868</span>&#160;                                  );</div>
<div class="line"><a name="l01869"></a><span class="lineno"> 1869</span>&#160;<span class="preprocessor">#if(REMOVERESTMASSFROMUU==2)</span></div>
<div class="line"><a name="l01870"></a><span class="lineno"> 1870</span>&#160;<span class="preprocessor"></span>        <span class="comment">// only valid comparison if rest-mass taken out of energy term and modify U_i term to be comparable with U_t term</span></div>
<div class="line"><a name="l01871"></a><span class="lineno"> 1871</span>&#160;        errornorm = <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(errornorm,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a987db2b5d50589e097378a13c5d87fef">THIRD</a>*(fabs(Unormalold[UU])+fabs(Unormalnew[UU])+fabs(Unormalnewabs[UU])));</div>
<div class="line"><a name="l01872"></a><span class="lineno"> 1872</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01873"></a><span class="lineno"> 1873</span>&#160;<span class="preprocessor"></span>        fdiff[pl] = sqrt(fabs(ptrgeom-&gt;gcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(pl-UU,pl-UU)]))*fabs(Unormalnew[pl]-Unormalold[pl]) / (errornorm+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a09c78d2f8feb311dd9fc969a0bf84979">SMALL</a>);</div>
<div class="line"><a name="l01874"></a><span class="lineno"> 1874</span>&#160;</div>
<div class="line"><a name="l01875"></a><span class="lineno"> 1875</span>&#160;      }</div>
<div class="line"><a name="l01876"></a><span class="lineno"> 1876</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span>( (pl==URAD1 || pl==URAD2 || pl==URAD3)&amp;&amp;(*lpflagrad==0) ){</div>
<div class="line"><a name="l01877"></a><span class="lineno"> 1877</span>&#160;        <span class="comment">//        errornorm  = THIRD*(fabs(Unormalnew[URAD1])+fabs(Unormalold[URAD1])+fabs(Unormalnew[URAD2])+fabs(Unormalold[URAD2])+fabs(Unormalnew[URAD3])+fabs(Unormalold[URAD3]));</span></div>
<div class="line"><a name="l01878"></a><span class="lineno"> 1878</span>&#160;        errornorm  = <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a987db2b5d50589e097378a13c5d87fef">THIRD</a>*<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a987db2b5d50589e097378a13c5d87fef">THIRD</a>*(</div>
<div class="line"><a name="l01879"></a><span class="lineno"> 1879</span>&#160;                                  +(fabs(Unormalnewabs[URAD1]) + fabs(Unormalnew[URAD1]) + fabs(Unormalold[URAD1]))*sqrt(fabs(ptrgeom-&gt;gcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(1,1)]))</div>
<div class="line"><a name="l01880"></a><span class="lineno"> 1880</span>&#160;                                  +(fabs(Unormalnewabs[URAD2]) + fabs(Unormalnew[URAD2]) + fabs(Unormalold[URAD2]))*sqrt(fabs(ptrgeom-&gt;gcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(2,2)]))</div>
<div class="line"><a name="l01881"></a><span class="lineno"> 1881</span>&#160;                                  +(fabs(Unormalnewabs[URAD3]) + fabs(Unormalnew[URAD3]) + fabs(Unormalold[URAD3]))*sqrt(fabs(ptrgeom-&gt;gcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(3,3)]))</div>
<div class="line"><a name="l01882"></a><span class="lineno"> 1882</span>&#160;                                  );</div>
<div class="line"><a name="l01883"></a><span class="lineno"> 1883</span>&#160;        <span class="comment">// KORALTODO: when URAD0&lt;&lt;UU, can&#39;t expect radiation error to be small relative to only itself when interaction between radiation and fluid. </span></div>
<div class="line"><a name="l01884"></a><span class="lineno"> 1884</span>&#160;        errornorm  += <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a987db2b5d50589e097378a13c5d87fef">THIRD</a>*<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a987db2b5d50589e097378a13c5d87fef">THIRD</a>*(</div>
<div class="line"><a name="l01885"></a><span class="lineno"> 1885</span>&#160;                                  +(fabs(Unormalnewabs[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>]) + fabs(Unormalnew[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>]) + fabs(Unormalold[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>]))*sqrt(fabs(ptrgeom-&gt;gcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(1,1)]))</div>
<div class="line"><a name="l01886"></a><span class="lineno"> 1886</span>&#160;                                  +(fabs(Unormalnewabs[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae907e773ef038f3fc0c2ad5de0cb0f07">U2</a>]) + fabs(Unormalnew[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae907e773ef038f3fc0c2ad5de0cb0f07">U2</a>]) + fabs(Unormalold[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae907e773ef038f3fc0c2ad5de0cb0f07">U2</a>]))*sqrt(fabs(ptrgeom-&gt;gcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(2,2)]))</div>
<div class="line"><a name="l01887"></a><span class="lineno"> 1887</span>&#160;                                  +(fabs(Unormalnewabs[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8de9104f1fffa59f057b214d74c5cfea">U3</a>]) + fabs(Unormalnew[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8de9104f1fffa59f057b214d74c5cfea">U3</a>]) + fabs(Unormalold[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8de9104f1fffa59f057b214d74c5cfea">U3</a>]))*sqrt(fabs(ptrgeom-&gt;gcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(3,3)]))</div>
<div class="line"><a name="l01888"></a><span class="lineno"> 1888</span>&#160;                                  );</div>
<div class="line"><a name="l01889"></a><span class="lineno"> 1889</span>&#160;        errornorm = <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(errornorm,0.5*(fabs(Unormalold[URAD0])+fabs(Unormalnew[URAD0])+fabs(Unormalnewabs[URAD0])));</div>
<div class="line"><a name="l01890"></a><span class="lineno"> 1890</span>&#160;</div>
<div class="line"><a name="l01891"></a><span class="lineno"> 1891</span>&#160;        fdiff[pl] = sqrt(fabs(ptrgeom-&gt;gcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(pl-URAD0,pl-URAD0)]))*fabs(Unormalnew[pl]-Unormalold[pl]) / (errornorm+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a09c78d2f8feb311dd9fc969a0bf84979">SMALL</a>);</div>
<div class="line"><a name="l01892"></a><span class="lineno"> 1892</span>&#160;      }</div>
<div class="line"><a name="l01893"></a><span class="lineno"> 1893</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span>(pl==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a> || pl==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a> || pl==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>){</div>
<div class="line"><a name="l01894"></a><span class="lineno"> 1894</span>&#160;        errornorm  = <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a987db2b5d50589e097378a13c5d87fef">THIRD</a>*<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a987db2b5d50589e097378a13c5d87fef">THIRD</a>*(</div>
<div class="line"><a name="l01895"></a><span class="lineno"> 1895</span>&#160;                                  +(fabs(Unormalnewabs[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>]) + fabs(Unormalnew[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>]) + fabs(Unormalold[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>]))*sqrt(fabs(ptrgeom-&gt;gcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(1,1)]))</div>
<div class="line"><a name="l01896"></a><span class="lineno"> 1896</span>&#160;                                  +(fabs(Unormalnewabs[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>]) + fabs(Unormalnew[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>]) + fabs(Unormalold[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>]))*sqrt(fabs(ptrgeom-&gt;gcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(2,2)]))</div>
<div class="line"><a name="l01897"></a><span class="lineno"> 1897</span>&#160;                                  +(fabs(Unormalnewabs[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>]) + fabs(Unormalnew[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>]) + fabs(Unormalold[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>]))*sqrt(fabs(ptrgeom-&gt;gcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(3,3)]))</div>
<div class="line"><a name="l01898"></a><span class="lineno"> 1898</span>&#160;                                  );</div>
<div class="line"><a name="l01899"></a><span class="lineno"> 1899</span>&#160;        fdiff[pl] = sqrt(fabs(ptrgeom-&gt;gcov[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(pl-<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>+1,pl-<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>+1)]))*fabs(Unormalnew[pl]-Unormalold[pl]) / (errornorm+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a917a138c5ec21bd07266281fde043723">KINDASMALL</a>); <span class="comment">// for field order 1E-100 or less, geometry division and multiplication causes this to shift in value by order unity.</span></div>
<div class="line"><a name="l01900"></a><span class="lineno"> 1900</span>&#160;      }</div>
<div class="line"><a name="l01901"></a><span class="lineno"> 1901</span>&#160;    }</div>
<div class="line"><a name="l01902"></a><span class="lineno"> 1902</span>&#160;</div>
<div class="line"><a name="l01903"></a><span class="lineno"> 1903</span>&#160;</div>
<div class="line"><a name="l01904"></a><span class="lineno"> 1904</span>&#160;    </div>
<div class="line"><a name="l01905"></a><span class="lineno"> 1905</span>&#160;    <span class="comment">// broke loop to check multiple directions</span></div>
<div class="line"><a name="l01906"></a><span class="lineno"> 1906</span>&#160;</div>
<div class="line"><a name="l01907"></a><span class="lineno"> 1907</span>&#160;</div>
<div class="line"><a name="l01908"></a><span class="lineno"> 1908</span>&#160;    <span class="keywordtype">int</span> plcheck;</div>
<div class="line"><a name="l01909"></a><span class="lineno"> 1909</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l01910"></a><span class="lineno"> 1910</span>&#160;</div>
<div class="line"><a name="l01911"></a><span class="lineno"> 1911</span>&#160;<span class="preprocessor">#if(0)</span></div>
<div class="line"><a name="l01912"></a><span class="lineno"> 1912</span>&#160;<span class="preprocessor"></span>      <span class="keywordflow">if</span>((<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0894a5e6c53e2e8a143d10be7a42d492">IFUTOPRIMFAIL</a>(*lpflag) || checkoninversiongas==0) &amp;&amp; (pl!=PRAD0 &amp;&amp; pl!=PRAD1 &amp;&amp; pl!=PRAD2 &amp;&amp; pl!=PRAD3)) <span class="keywordflow">continue</span>; <span class="comment">// don&#39;t check MHD (non-radiation) inversion if didn&#39;t want to</span></div>
<div class="line"><a name="l01913"></a><span class="lineno"> 1913</span>&#160;      <span class="keywordflow">if</span>((<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a16db3b3cf4bc03f044c72c62e75072db">IFUTOPRIMRADHARDFAIL</a>(*lpflagrad) || checkoninversionrad==0) &amp;&amp; (pl==PRAD0 &amp;&amp; pl==PRAD1 &amp;&amp; pl==PRAD2 &amp;&amp; pl==PRAD3)) <span class="keywordflow">continue</span>; <span class="comment">// don&#39;t check radiation (non-MHD) inversion if didn&#39;t want to</span></div>
<div class="line"><a name="l01914"></a><span class="lineno"> 1914</span>&#160;</div>
<div class="line"><a name="l01915"></a><span class="lineno"> 1915</span>&#160;</div>
<div class="line"><a name="l01916"></a><span class="lineno"> 1916</span>&#160;      plcheck=(pl&gt;=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>)&amp;&amp;(pl&lt;=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a> || pl&lt;=ENTROPY &amp;&amp; usedentropyinversion || (*lpflagrad==0)&amp;&amp;(<a class="code" href="../../da/d3e/definit_8h.html#a99ba7daf58b283bc831b8f507f5873a4" title="#define EOMTYPE EOMCOLDGRMHD">EOMRADTYPE</a>!=<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a993e29ef4139116d822d89bccb92180d" title="radiation equations of motion">EOMRADNONE</a> &amp;&amp; (pl==URAD0 || pl==URAD1&amp;&amp;(<a class="code" href="../../da/d3e/definit_8h.html#a99ba7daf58b283bc831b8f507f5873a4" title="#define EOMTYPE EOMCOLDGRMHD">EOMRADTYPE</a>!=<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#aeecbb1829400fae0bc7971d41ca4222d">EOMRADEDD</a>) || pl==URAD2&amp;&amp;(<a class="code" href="../../da/d3e/definit_8h.html#a99ba7daf58b283bc831b8f507f5873a4" title="#define EOMTYPE EOMCOLDGRMHD">EOMRADTYPE</a>!=<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#aeecbb1829400fae0bc7971d41ca4222d">EOMRADEDD</a>) || pl==URAD3&amp;&amp;(<a class="code" href="../../da/d3e/definit_8h.html#a99ba7daf58b283bc831b8f507f5873a4" title="#define EOMTYPE EOMCOLDGRMHD">EOMRADTYPE</a>!=<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#aeecbb1829400fae0bc7971d41ca4222d">EOMRADEDD</a>) )));</div>
<div class="line"><a name="l01917"></a><span class="lineno"> 1917</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01918"></a><span class="lineno"> 1918</span>&#160;<span class="preprocessor"></span>      <span class="comment">// if fdiff=0.0, then didn&#39;t set or no problems</span></div>
<div class="line"><a name="l01919"></a><span class="lineno"> 1919</span>&#160;      plcheck=(fdiff[pl]!=0.0);</div>
<div class="line"><a name="l01920"></a><span class="lineno"> 1920</span>&#160;</div>
<div class="line"><a name="l01921"></a><span class="lineno"> 1921</span>&#160;      <span class="comment">//      if(IFUTOPRIMFAIL(*lpflag) || fdiff[pl]&gt;CHECKONINVFRAC){</span></div>
<div class="line"><a name="l01922"></a><span class="lineno"> 1922</span>&#160;      <span class="keywordflow">if</span>(fdiff[pl]&gt;<a class="code" href="../../d1/d3e/utoprimgen_8c.html#a11db68297c24100ffe1c76e659268e5f" title="fractional error above which inversion is reported on as having made a signficant error...">CHECKONINVFRAC</a>){</div>
<div class="line"><a name="l01923"></a><span class="lineno"> 1923</span>&#160;        <span class="keywordflow">if</span>(</div>
<div class="line"><a name="l01924"></a><span class="lineno"> 1924</span>&#160;           ( (plcheck)&amp;&amp;((fabs(Unormalold[pl])&gt;<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a09c78d2f8feb311dd9fc969a0bf84979">SMALL</a>)&amp;&amp;(fabs(Unormalnew[pl])&gt;<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a09c78d2f8feb311dd9fc969a0bf84979">SMALL</a>)) )</div>
<div class="line"><a name="l01925"></a><span class="lineno"> 1925</span>&#160;           ){</div>
<div class="line"><a name="l01926"></a><span class="lineno"> 1926</span>&#160;          <span class="keywordflow">if</span>(pl&lt;URAD0 &amp;&amp; pl&gt;URAD3) badinversion++;</div>
<div class="line"><a name="l01927"></a><span class="lineno"> 1927</span>&#160;          <span class="keywordflow">else</span>  badinversionrad++;</div>
<div class="line"><a name="l01928"></a><span class="lineno"> 1928</span>&#160;</div>
<div class="line"><a name="l01929"></a><span class="lineno"> 1929</span>&#160;          <span class="keywordflow">if</span>(debugfail&gt;=2){</div>
<div class="line"><a name="l01930"></a><span class="lineno"> 1930</span>&#160;            <span class="keywordflow">if</span>(pl==ENTROPY) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;fdiff[%d]=%21.15g :: %21.15g %21.15g : %21.15g %21.15g : %21.15g %21.15g\n&quot;</span>,pl,fdiff[pl],Unormalold[pl],Unormalnew[pl],exp(Unormalold[pl]/Unormalold[RHO]),exp(Unormalnew[pl]/Unormalnew[RHO]),Unormalold[RHO],Unormalnew[RHO]);</div>
<div class="line"><a name="l01931"></a><span class="lineno"> 1931</span>&#160;            <span class="keywordflow">else</span> dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;fdiff[%d]=%21.15g :: %21.15g %21.15g\n&quot;</span>,pl,fdiff[pl],Unormalold[pl],Unormalnew[pl]);</div>
<div class="line"><a name="l01932"></a><span class="lineno"> 1932</span>&#160;          }</div>
<div class="line"><a name="l01933"></a><span class="lineno"> 1933</span>&#160;</div>
<div class="line"><a name="l01934"></a><span class="lineno"> 1934</span>&#160;        }</div>
<div class="line"><a name="l01935"></a><span class="lineno"> 1935</span>&#160;      }</div>
<div class="line"><a name="l01936"></a><span class="lineno"> 1936</span>&#160;      <span class="keywordflow">if</span>(fdiff[pl]&gt;<a class="code" href="../../d1/d3e/utoprimgen_8c.html#ac85d41f36d0739a78a1e6cc767157a8f" title="fraction upon if greater will treat as failure if FAILIFBADCHECK is triggered">CHECKONINVFRACFAIL</a>){</div>
<div class="line"><a name="l01937"></a><span class="lineno"> 1937</span>&#160;        <span class="keywordflow">if</span>( (plcheck)&amp;&amp;((fabs(Unormalold[pl])&gt;<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a09c78d2f8feb311dd9fc969a0bf84979">SMALL</a>)&amp;&amp;(fabs(Unormalnew[pl])&gt;<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a09c78d2f8feb311dd9fc969a0bf84979">SMALL</a>)) ){</div>
<div class="line"><a name="l01938"></a><span class="lineno"> 1938</span>&#160;          <span class="keywordflow">if</span>(pl&lt;URAD0 &amp;&amp; pl&gt;URAD3) badinversionfail++;</div>
<div class="line"><a name="l01939"></a><span class="lineno"> 1939</span>&#160;          <span class="keywordflow">else</span>  badinversionfailrad++;</div>
<div class="line"><a name="l01940"></a><span class="lineno"> 1940</span>&#160;        }</div>
<div class="line"><a name="l01941"></a><span class="lineno"> 1941</span>&#160;      }</div>
<div class="line"><a name="l01942"></a><span class="lineno"> 1942</span>&#160;</div>
<div class="line"><a name="l01943"></a><span class="lineno"> 1943</span>&#160;</div>
<div class="line"><a name="l01944"></a><span class="lineno"> 1944</span>&#160;      <span class="comment">//      dualfprintf(fail_file,&quot;pl=%d Uold=%26.20g Unew=%26.20g\n&quot;,pl,Unormalold[pl],Unormalnew[pl]);</span></div>
<div class="line"><a name="l01945"></a><span class="lineno"> 1945</span>&#160;</div>
<div class="line"><a name="l01946"></a><span class="lineno"> 1946</span>&#160;</div>
<div class="line"><a name="l01947"></a><span class="lineno"> 1947</span>&#160;    }</div>
<div class="line"><a name="l01948"></a><span class="lineno"> 1948</span>&#160;</div>
<div class="line"><a name="l01950"></a><span class="lineno"> 1950</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01951"></a><span class="lineno"> 1951</span>&#160;    <span class="comment">// change failure flag if really bad check</span></div>
<div class="line"><a name="l01952"></a><span class="lineno"> 1952</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01954"></a><span class="lineno"> 1954</span>&#160;<span class="comment"></span>    <span class="keywordflow">if</span>(checkoninversiongas==1 &amp;&amp; <a class="code" href="../../d1/d3e/utoprimgen_8c.html#a3a3cb87e250a02050cb52a1f1240b128" title="whether to fail if check on inversion fails">FAILIFBADCHECK</a> &amp;&amp; badinversionfail){</div>
<div class="line"><a name="l01955"></a><span class="lineno"> 1955</span>&#160;      <span class="keywordflow">if</span>(debugfail&gt;=2) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;Changing flag since sufficiently bad inversion.\n&quot;</span>);</div>
<div class="line"><a name="l01956"></a><span class="lineno"> 1956</span>&#160;      (*lpflag)=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a179f5cb85b123b8923f126fbf59b5481">UTOPRIMFAILCONVBADINVERTCOMPARE</a>;</div>
<div class="line"><a name="l01957"></a><span class="lineno"> 1957</span>&#160;    }</div>
<div class="line"><a name="l01958"></a><span class="lineno"> 1958</span>&#160;    <span class="comment">// checkoninversionrad==1 case: No, would not redo inversion since no reduction to another inversion.</span></div>
<div class="line"><a name="l01959"></a><span class="lineno"> 1959</span>&#160;</div>
<div class="line"><a name="l01960"></a><span class="lineno"> 1960</span>&#160;</div>
<div class="line"><a name="l01961"></a><span class="lineno"> 1961</span>&#160;</div>
<div class="line"><a name="l01963"></a><span class="lineno"> 1963</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01964"></a><span class="lineno"> 1964</span>&#160;    <span class="comment">// Account for any conserved quantity change (could be just difference created by primtoU, but still tells order of issue)</span></div>
<div class="line"><a name="l01965"></a><span class="lineno"> 1965</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01966"></a><span class="lineno"> 1966</span>&#160;    <span class="comment">// only makes sense to account for changes in U if inversion is treated as success</span></div>
<div class="line"><a name="l01967"></a><span class="lineno"> 1967</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01968"></a><span class="lineno"> 1968</span>&#160;    <span class="comment">// Also, only makes sense if using primitives as basis.  Since, if use U as basis, then each iteration relies upon old correct U without any error introduced due to inversion.</span></div>
<div class="line"><a name="l01969"></a><span class="lineno"> 1969</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01971"></a><span class="lineno"> 1971</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01972"></a><span class="lineno"> 1972</span>&#160;</div>
<div class="line"><a name="l01973"></a><span class="lineno"> 1973</span>&#160;</div>
<div class="line"><a name="l01975"></a><span class="lineno"> 1975</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01976"></a><span class="lineno"> 1976</span>&#160;    <span class="comment">// Report bad inversion</span></div>
<div class="line"><a name="l01977"></a><span class="lineno"> 1977</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01979"></a><span class="lineno"> 1979</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01980"></a><span class="lineno"> 1980</span>&#160;    <span class="comment">//    if(myid==5 &amp;&amp; nstep==1 &amp;&amp; steppart==0 &amp;&amp; ptrgeom-&gt;i==19 &amp;&amp; ptrgeom-&gt;j==15){</span></div>
<div class="line"><a name="l01981"></a><span class="lineno"> 1981</span>&#160;    <span class="comment">//      badinversion=1;</span></div>
<div class="line"><a name="l01982"></a><span class="lineno"> 1982</span>&#160;    <span class="comment">//    }</span></div>
<div class="line"><a name="l01983"></a><span class="lineno"> 1983</span>&#160;    </div>
<div class="line"><a name="l01984"></a><span class="lineno"> 1984</span>&#160;    <span class="keywordflow">if</span>(badinversion || badinversionrad){</div>
<div class="line"><a name="l01985"></a><span class="lineno"> 1985</span>&#160;</div>
<div class="line"><a name="l01986"></a><span class="lineno"> 1986</span>&#160;      <span class="keywordflow">if</span>(debugfail&gt;=2){</div>
<div class="line"><a name="l01987"></a><span class="lineno"> 1987</span>&#160;        dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;Bad inversion (or possibly Bad U(p) calculation):\n&quot;</span>);</div>
<div class="line"><a name="l01988"></a><span class="lineno"> 1988</span>&#160;        dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;Inversion types: %d %d %d %d\n&quot;</span>,usedffdeinversion,usedcoldinversion,usedentropyinversion,usedhotinversion);</div>
<div class="line"><a name="l01989"></a><span class="lineno"> 1989</span>&#160;</div>
<div class="line"><a name="l01990"></a><span class="lineno"> 1990</span>&#160;        dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;t=%21.15g nstep=%ld stepart=%d :: i=%d j=%d k=%d :: lntries=%d lerrx=%21.15g\n&quot;</span>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#ae1ee1e1c83c3f70e2e1afed4f4f5b41e">t</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a1a1088d87617078680f1fd0f0d707384">nstep</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a70170b90229f9fc05eebf8508a685c70">steppart</a>,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,newtonstats-&gt;<a class="code" href="../../db/d3a/structof__newtonstats.html#a83280998e47831044a7e35299495a9bb">lntries</a>,newtonstats-&gt;<a class="code" href="../../db/d3a/structof__newtonstats.html#a02529bef0a69373dc4e7e9e7a672d1db">lerrx</a>);</div>
<div class="line"><a name="l01991"></a><span class="lineno"> 1991</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,&quot;Uoldgeomfree[%d]=%21.15g Unewgeomfree[%d]=%21.15g pr[%d]=%21.15g prtest[%d]=%21.15g (pr0[%d]=%21.15g) fdiff=%21.15g\n&quot;,pl,Uold[pl],pl,Unew[pl],pl,pr[pl],prtest[pl],pl,pr0[pl],fdiff[pl]);</div>
<div class="line"><a name="l01992"></a><span class="lineno"> 1992</span>&#160;        dualfprintf(fail_file,&quot;special inversion pressure=%21.15g statepressure=%21.15g stateentropy=%21.15g\n&quot;,*pressure,q.pressure,q.<a class="code" href="../../d1/d83/structof__state.html#a01940142e21045449cb4571d5380c580">entropy</a>);</div>
<div class="line"><a name="l01993"></a><span class="lineno"> 1993</span>&#160;      </div>
<div class="line"><a name="l01994"></a><span class="lineno"> 1994</span>&#160;        dualfprintf(fail_file,&quot;g=%21.15g\n&quot;,ptrgeom-&gt;<a class="code" href="../../dc/dd2/newcodediff_8txt.html#a597ef3c829c23db3a2637f8b3aefe240">gdet</a>);</div>
<div class="line"><a name="l01995"></a><span class="lineno"> 1995</span>&#160;      </div>
<div class="line"><a name="l01996"></a><span class="lineno"> 1996</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a59b7ef1517ff22fd4dfce4cf6d380c55" title="loop over all Dimensions; second rank loop">DLOOP</a>(j,k) dualfprintf(fail_file,&quot;<a class="code" href="../../dc/dd2/newcodediff_8txt.html#a93300df7bd864b90cc8ed9f3d96515ad">gcov</a>=%21.15g <a class="code" href="../../dc/dd2/newcodediff_8txt.html#a98399a5a291e3844900ecfbacdcb2da0">gcon</a>=%21.15g\n&quot;,ptrgeom-&gt;<a class="code" href="../../dc/dd2/newcodediff_8txt.html#a93300df7bd864b90cc8ed9f3d96515ad">gcov</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(j,k)],ptrgeom-&gt;<a class="code" href="../../dc/dd2/newcodediff_8txt.html#a98399a5a291e3844900ecfbacdcb2da0">gcon</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(j,k)]);</div>
<div class="line"><a name="l01997"></a><span class="lineno"> 1997</span>&#160;</div>
<div class="line"><a name="l01998"></a><span class="lineno"> 1998</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(k) dualfprintf(fail_file,&quot;k=%d : q.<a class="code" href="../../d1/d83/structof__state.html#aab723d3c7c2c48b7246cc7d7d5379eed">ucon</a>=%21.15g q.<a class="code" href="../../d1/d83/structof__state.html#a09881c3d05809ef27f8115d02a835e11">ucov</a>=%21.15g :  q.<a class="code" href="../../d1/d83/structof__state.html#a3bf8e15ee6ae95831230791baf2fc570">uradcon</a>=%21.15g q.<a class="code" href="../../d1/d83/structof__state.html#a87c04c4f890495e87a6682643a0c7955">uradcov</a>=%21.15g  : q.<a class="code" href="../../d1/d83/structof__state.html#a9a5aa459c68ba51073dd9a245c1a7798">bcon</a>=%21.15g q.<a class="code" href="../../d1/d83/structof__state.html#a60ad0baeb54ce3584309ba5567a72f41">bcov</a>=%21.15g\n&quot;,k,q.<a class="code" href="../../d1/d83/structof__state.html#aab723d3c7c2c48b7246cc7d7d5379eed">ucon</a>[k],q.<a class="code" href="../../d1/d83/structof__state.html#a09881c3d05809ef27f8115d02a835e11">ucov</a>[k],q.<a class="code" href="../../d1/d83/structof__state.html#a3bf8e15ee6ae95831230791baf2fc570">uradcon</a>[k],q.<a class="code" href="../../d1/d83/structof__state.html#a87c04c4f890495e87a6682643a0c7955">uradcov</a>[k],q.<a class="code" href="../../d1/d83/structof__state.html#a9a5aa459c68ba51073dd9a245c1a7798">bcon</a>[k],q.<a class="code" href="../../d1/d83/structof__state.html#a60ad0baeb54ce3584309ba5567a72f41">bcov</a>[k]);</div>
<div class="line"><a name="l01999"></a><span class="lineno"> 1999</span>&#160;      }</div>
<div class="line"><a name="l02000"></a><span class="lineno"> 2000</span>&#160;</div>
<div class="line"><a name="l02001"></a><span class="lineno"> 2001</span>&#160;<span class="preprocessor">#if(0)</span></div>
<div class="line"><a name="l02002"></a><span class="lineno"> 2002</span>&#160;<span class="preprocessor"></span>      <span class="comment">// not using these anymore, and only set by utoprim_jon.c</span></div>
<div class="line"><a name="l02003"></a><span class="lineno"> 2003</span>&#160;      <span class="comment">// only really need the below quantities to check on inversion in mathematica</span></div>
<div class="line"><a name="l02004"></a><span class="lineno"> 2004</span>&#160;      <span class="comment">// Use Eprime_inversion.nb to check on utoprim_jon.c inversion</span></div>
<div class="line"><a name="l02005"></a><span class="lineno"> 2005</span>&#160;      <span class="keywordflow">for</span>(j=0;j&lt;<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aa974989f8b570e3eedaef4e80b61900a" title="number of inversion quantities to report when inversion fails if CHECKONINVERSION = 1 See utoprim_jon...">NUMINVPROPERTY</a>;j++) dualfprintf(fail_file,<span class="stringliteral">&quot;%sstr=\&quot;%21.15g\&quot;;\n&quot;</span>,newtonstats-&gt;<a class="code" href="../../db/d3a/structof__newtonstats.html#aad08f5f3c0485a3742327d18f6e7f0b3">invpropertytext</a>[j],newtonstats-&gt;<a class="code" href="../../db/d3a/structof__newtonstats.html#a60c48b8dd68a7e66ff5a570434717dc2">invproperty</a>[j]);</div>
<div class="line"><a name="l02006"></a><span class="lineno"> 2006</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02007"></a><span class="lineno"> 2007</span>&#160;<span class="preprocessor"></span>    }</div>
<div class="line"><a name="l02008"></a><span class="lineno"> 2008</span>&#160;</div>
<div class="line"><a name="l02009"></a><span class="lineno"> 2009</span>&#160;  }</div>
<div class="line"><a name="l02010"></a><span class="lineno"> 2010</span>&#160;</div>
<div class="line"><a name="l02011"></a><span class="lineno"> 2011</span>&#160;  <span class="comment">//  if(ptrgeom-&gt;i==39){</span></div>
<div class="line"><a name="l02012"></a><span class="lineno"> 2012</span>&#160;  <span class="comment">//    PLOOP(pliter,pl) dualfprintf(fail_file,&quot;i=%d : pl=%d Uold=%21.15g Unew=%21.15g pr0=%21.15g pr=%21.15g\n&quot;,ptrgeom-&gt;i,pl,Uold[pl],Unew[pl],pr0[pl],pr[pl]);</span></div>
<div class="line"><a name="l02013"></a><span class="lineno"> 2013</span>&#160;  <span class="comment">//  }</span></div>
<div class="line"><a name="l02014"></a><span class="lineno"> 2014</span>&#160;</div>
<div class="line"><a name="l02015"></a><span class="lineno"> 2015</span>&#160;</div>
<div class="line"><a name="l02016"></a><span class="lineno"> 2016</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l02017"></a><span class="lineno"> 2017</span>&#160;</div>
<div class="line"><a name="l02018"></a><span class="lineno"> 2018</span>&#160;</div>
<div class="line"><a name="l02019"></a><span class="lineno"> 2019</span>&#160;}</div>
<div class="line"><a name="l02020"></a><span class="lineno"> 2020</span>&#160;</div>
<div class="line"><a name="l02021"></a><span class="lineno"> 2021</span>&#160;</div>
<div class="line"><a name="l02022"></a><span class="lineno"> 2022</span>&#160;</div>
<div class="line"><a name="l02023"></a><span class="lineno"> 2023</span>&#160;</div>
<div class="line"><a name="l02024"></a><span class="lineno"> 2024</span>&#160;</div>
<div class="line"><a name="l02025"></a><span class="lineno"> 2025</span>&#160;</div>
<div class="line"><a name="l02026"></a><span class="lineno"> 2026</span>&#160;</div>
<div class="line"><a name="l02027"></a><span class="lineno"> 2027</span>&#160;</div>
<div class="line"><a name="l02028"></a><span class="lineno"> 2028</span>&#160;</div>
<div class="line"><a name="l02029"></a><span class="lineno"> 2029</span>&#160;</div>
<div class="line"><a name="l02030"></a><span class="lineno"> 2030</span>&#160;      </div>
<div class="line"><a name="l02031"></a><span class="lineno"> 2031</span>&#160;</div>
<div class="line"><a name="l02032"></a><span class="lineno"> 2032</span>&#160;</div>
<div class="line"><a name="l02033"></a><span class="lineno"> 2033</span>&#160;</div>
<div class="line"><a name="l02034"></a><span class="lineno"> 2034</span>&#160;</div>
<div class="line"><a name="l02035"></a><span class="lineno"> 2035</span>&#160;</div>
<div class="line"><a name="l02036"></a><span class="lineno"> 2036</span>&#160;</div>
<div class="line"><a name="l02038"></a><span class="lineno"> 2038</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> compare_ffde_inversions(<span class="keywordtype">int</span> showmessages, <span class="keywordtype">int</span> allowlocalfailurefixandnoreport, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflag, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr0, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pressure, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ugeomfree0, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a>*Ugeomfree, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Uold, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Unew, <span class="keyword">struct</span> <a class="code" href="../../db/d3a/structof__newtonstats.html">of_newtonstats</a> *newtonstats, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflagrad)</div>
<div class="line"><a name="l02039"></a><span class="lineno"> 2039</span>&#160;{</div>
<div class="line"><a name="l02040"></a><span class="lineno"> 2040</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>,k;</div>
<div class="line"><a name="l02041"></a><span class="lineno"> 2041</span>&#160;  <span class="keywordtype">int</span> pl;</div>
<div class="line"><a name="l02042"></a><span class="lineno"> 2042</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> prother[NPR];</div>
<div class="line"><a name="l02043"></a><span class="lineno"> 2043</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Upr[NPR],Uprother[NPR];</div>
<div class="line"><a name="l02044"></a><span class="lineno"> 2044</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> q;</div>
<div class="line"><a name="l02045"></a><span class="lineno"> 2045</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d1/d3e/utoprimgen_8c.html#a0a83e9e7fdd3cc595c5b8d0df88ec684" title="just picks the algorithm to invert">Utoprimgen_pick</a>(<span class="keywordtype">int</span> showmessages, <span class="keywordtype">int</span> allowlocalfailurefixandnoreport, <span class="keywordtype">int</span> which, <span class="keywordtype">int</span> eomtype, <span class="keywordtype">int</span> whichcap, <span class="keywordtype">int</span> parameter, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ugeomfree, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflag, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pressure, <span class="keyword">struct</span> <a class="code" href="../../db/d3a/structof__newtonstats.html">of_newtonstats</a> *newtonstats, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflagrad);</div>
<div class="line"><a name="l02046"></a><span class="lineno"> 2046</span>&#160;  <span class="keywordtype">int</span> eomtypelocal=<a class="code" href="../../da/d3e/definit_8h.html#a87e5572748e4cc27373e50bd78e6f2e8">EOMTYPE</a>; <span class="comment">// as chosen before introduced eomtypelocal</span></div>
<div class="line"><a name="l02047"></a><span class="lineno"> 2047</span>&#160;  <span class="keywordtype">int</span> whichcap=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a4b6c6060c025e15f1d92aae3dcb9365b" title="which cap type to place in rad inversion">CAPTYPEBASIC</a>;</div>
<div class="line"><a name="l02048"></a><span class="lineno"> 2048</span>&#160;</div>
<div class="line"><a name="l02049"></a><span class="lineno"> 2049</span>&#160;  <a class="code" href="../../d1/d3e/utoprimgen_8c.html#a0a83e9e7fdd3cc595c5b8d0df88ec684" title="just picks the algorithm to invert">Utoprimgen_pick</a>(showmessages, allowlocalfailurefixandnoreport, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a77b486c84a084158707853a7ca173cfa" title="21: FFDE">UTOPRIMFFDE</a>, eomtypelocal, whichcap, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a4a02957480e290a978d1f29992125c15" title="for WHICHENTROPYEVOLVE">EVOLVENOENTROPY</a>, Ugeomfree, ptrgeom, &amp;GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>), pr, pressure, newtonstats,lpflagrad);</div>
<div class="line"><a name="l02050"></a><span class="lineno"> 2050</span>&#160;</div>
<div class="line"><a name="l02051"></a><span class="lineno"> 2051</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl) Ugeomfree[pl]=Ugeomfree0[pl]; <span class="comment">// make sure good conserved quantity</span></div>
<div class="line"><a name="l02052"></a><span class="lineno"> 2052</span>&#160;      </div>
<div class="line"><a name="l02053"></a><span class="lineno"> 2053</span>&#160;  <a class="code" href="../../d1/d3e/utoprimgen_8c.html#a0a83e9e7fdd3cc595c5b8d0df88ec684" title="just picks the algorithm to invert">Utoprimgen_pick</a>(showmessages, allowlocalfailurefixandnoreport, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#abeac8c89d7fa922563d79f9278b4d44d" title="8: Jon 1D/2D final version  can handle non-rel problems">UTOPRIMJONNONRELCOMPAT</a>, eomtypelocal, whichcap, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a4a02957480e290a978d1f29992125c15" title="for WHICHENTROPYEVOLVE">EVOLVENOENTROPY</a>, Ugeomfree, ptrgeom, &amp;GLOBALMACP0A1(pflag,ptrgeom-&gt;<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>), prother, pressure, newtonstats, lpflagrad);</div>
<div class="line"><a name="l02054"></a><span class="lineno"> 2054</span>&#160;</div>
<div class="line"><a name="l02055"></a><span class="lineno"> 2055</span>&#160;</div>
<div class="line"><a name="l02056"></a><span class="lineno"> 2056</span>&#160;  <span class="comment">// now get conserved quantity from pr to check</span></div>
<div class="line"><a name="l02057"></a><span class="lineno"> 2057</span>&#160;  <span class="comment">// find U(p)</span></div>
<div class="line"><a name="l02058"></a><span class="lineno"> 2058</span>&#160;  <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a11e17cd8b0594d1ad52e3594aa9f477e" title="find ucon, ucov, bcon, bcov from primitive variables when calling get_state, users of this function e...">get_state</a>(pr, ptrgeom, &amp;q),&quot;<a class="code" href="../../d9/de0/step__ch_8c.html#afe241569412f22a86dea9cd91b516af8" title="take step itself">step_ch</a>.c:<a class="code" href="../../df/d22/advance_8c.html#a22dff5dc24ff389254919e70b79be489" title="pi: initial values at t=t0 to compute Ui pb: values used to compute flux/source pf: solution using fl...">advance</a>()&quot;, &quot;<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a11e17cd8b0594d1ad52e3594aa9f477e" title="find ucon, ucov, bcon, bcov from primitive variables when calling get_state, users of this function e...">get_state</a>()&quot;, 1);</div>
<div class="line"><a name="l02059"></a><span class="lineno"> 2059</span>&#160;  <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a9a54096e4c40a15a2c1bf74266153616" title="calculate &quot;conserved&quot; quantities">primtoU</a>(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab2be21bd5eff40ca89c20eeecbeab5e0">UNOTHING</a>,pr, &amp;q, ptrgeom, Upr, NULL),&quot;<a class="code" href="../../d9/de0/step__ch_8c.html#afe241569412f22a86dea9cd91b516af8" title="take step itself">step_ch</a>.c:advance()&quot;, &quot;<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a9a54096e4c40a15a2c1bf74266153616" title="calculate &quot;conserved&quot; quantities">primtoU</a>()&quot;, 1);</div>
<div class="line"><a name="l02060"></a><span class="lineno"> 2060</span>&#160;</div>
<div class="line"><a name="l02061"></a><span class="lineno"> 2061</span>&#160;  <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(get_state(prother, ptrgeom, &amp;q),&quot;<a class="code" href="../../d9/de0/step__ch_8c.html#afe241569412f22a86dea9cd91b516af8" title="take step itself">step_ch</a>.c:advance()&quot;, &quot;get_state()&quot;, 1);</div>
<div class="line"><a name="l02062"></a><span class="lineno"> 2062</span>&#160;  <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(primtoU(UNOTHING,prother, &amp;q, ptrgeom, Uprother, NULL),&quot;<a class="code" href="../../d9/de0/step__ch_8c.html#afe241569412f22a86dea9cd91b516af8" title="take step itself">step_ch</a>.c:advance()&quot;, &quot;primtoU()&quot;, 1);</div>
<div class="line"><a name="l02063"></a><span class="lineno"> 2063</span>&#160;</div>
<div class="line"><a name="l02064"></a><span class="lineno"> 2064</span>&#160;</div>
<div class="line"><a name="l02065"></a><span class="lineno"> 2065</span>&#160;  <span class="comment">// now compare</span></div>
<div class="line"><a name="l02066"></a><span class="lineno"> 2066</span>&#160;</div>
<div class="line"><a name="l02067"></a><span class="lineno"> 2067</span>&#160;  <span class="comment">//PALLLOOP(pl)</span></div>
<div class="line"><a name="l02068"></a><span class="lineno"> 2068</span>&#160;  dualfprintf(fail_file,&quot;<a class="code" href="../../d8/d5b/defs_8general_8h.html#a1a1088d87617078680f1fd0f0d707384">nstep</a>=%ld stepart=%d i=%d j=%d\n&quot;,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a1a1088d87617078680f1fd0f0d707384">nstep</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a70170b90229f9fc05eebf8508a685c70">steppart</a>,ptrgeom-&gt;i,ptrgeom-&gt;j);</div>
<div class="line"><a name="l02069"></a><span class="lineno"> 2069</span>&#160;  for(pl=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>;pl&lt;<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>;pl++){</div>
<div class="line"><a name="l02070"></a><span class="lineno"> 2070</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l02071"></a><span class="lineno"> 2071</span>&#160;<span class="comment">      if(</span></div>
<div class="line"><a name="l02072"></a><span class="lineno"> 2072</span>&#160;<span class="comment">      ((fabs(Ugeomfree[pl]-Upr[pl])/(fabs(Ugeomfree[pl])+fabs(Upr[pl])+SMALL)) &gt; 1E-12)||</span></div>
<div class="line"><a name="l02073"></a><span class="lineno"> 2073</span>&#160;<span class="comment">      ((fabs(Ugeomfree[pl]-Uprother[pl])/(fabs(Ugeomfree[pl])+fabs(Uprother[pl])+SMALL)) &gt; 1E-12)</span></div>
<div class="line"><a name="l02074"></a><span class="lineno"> 2074</span>&#160;<span class="comment">      ){</span></div>
<div class="line"><a name="l02075"></a><span class="lineno"> 2075</span>&#160;<span class="comment">      dualfprintf(fail_file,&quot;DIFF: %21.15g %21.15g ::pl=%d Ugeomfree=%21.15g prold=%21.15g prnew=%21.15g Upr=%21.15g Uprother=%21.15g\n&quot;,(fabs(Ugeomfree[pl]-Upr[pl])/(fabs(Ugeomfree[pl])+fabs(Upr[pl])+SMALL)),(fabs(Ugeomfree[pl]-Uprother[pl])/(fabs(Ugeomfree[pl])+fabs(Uprother[pl])+SMALL)),pl,Ugeomfree[pl],pr[pl],prother[pl],Upr[pl],Uprother[pl]);</span></div>
<div class="line"><a name="l02076"></a><span class="lineno"> 2076</span>&#160;<span class="comment">      }</span></div>
<div class="line"><a name="l02077"></a><span class="lineno"> 2077</span>&#160;<span class="comment">    */</span></div>
<div class="line"><a name="l02078"></a><span class="lineno"> 2078</span>&#160;    <span class="keywordflow">if</span>(</div>
<div class="line"><a name="l02079"></a><span class="lineno"> 2079</span>&#160;       ((fabs(pr[pl]-prother[pl])/(fabs(pr[pl])+fabs(prother[pl])+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a09c78d2f8feb311dd9fc969a0bf84979">SMALL</a>)) &gt; 1<a class="code" href="../../d8/d60/init_8c.html#a07484107e6d9fdf38b53edf631d6511d">E</a>-12)&amp;&amp;( (fabs(pr[pl])&gt;1<a class="code" href="../../d8/d60/init_8c.html#a07484107e6d9fdf38b53edf631d6511d">E</a>-15)||(fabs(prother[pl])&gt;1<a class="code" href="../../d8/d60/init_8c.html#a07484107e6d9fdf38b53edf631d6511d">E</a>-15) )</div>
<div class="line"><a name="l02080"></a><span class="lineno"> 2080</span>&#160;       ){</div>
<div class="line"><a name="l02081"></a><span class="lineno"> 2081</span>&#160;      dualfprintf(fail_file,<span class="stringliteral">&quot;DIFF: %21.15g :: pl=%d Ugeomfree=%21.15g prold=%21.15g prnew=%21.15g Upr=%21.15g Uprother=%21.15g\n&quot;</span>,(fabs(pr[pl]-prother[pl])/(fabs(pr[pl])+fabs(prother[pl])+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a09c78d2f8feb311dd9fc969a0bf84979">SMALL</a>)),pl,Ugeomfree[pl],pr[pl],prother[pl],Upr[pl],Uprother[pl]);</div>
<div class="line"><a name="l02082"></a><span class="lineno"> 2082</span>&#160;    }</div>
<div class="line"><a name="l02083"></a><span class="lineno"> 2083</span>&#160;  }</div>
<div class="line"><a name="l02084"></a><span class="lineno"> 2084</span>&#160;</div>
<div class="line"><a name="l02085"></a><span class="lineno"> 2085</span>&#160;</div>
<div class="line"><a name="l02086"></a><span class="lineno"> 2086</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l02087"></a><span class="lineno"> 2087</span>&#160;</div>
<div class="line"><a name="l02088"></a><span class="lineno"> 2088</span>&#160;}</div>
<div class="line"><a name="l02089"></a><span class="lineno"> 2089</span>&#160;</div>
<div class="line"><a name="l02090"></a><span class="lineno"> 2090</span>&#160;</div>
<div class="line"><a name="l02091"></a><span class="lineno"> 2091</span>&#160;</div>
<div class="line"><a name="l02092"></a><span class="lineno"> 2092</span>&#160;</div>
<div class="line"><a name="l02094"></a><span class="lineno"> 2094</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> debug_utoprimgen(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflag, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr0, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Uold, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Unew)</div>
<div class="line"><a name="l02095"></a><span class="lineno"> 2095</span>&#160;{</div>
<div class="line"><a name="l02096"></a><span class="lineno"> 2096</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>,k;</div>
<div class="line"><a name="l02097"></a><span class="lineno"> 2097</span>&#160;  <span class="keywordtype">int</span> pl;</div>
<div class="line"><a name="l02098"></a><span class="lineno"> 2098</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fdiff[NPR];</div>
<div class="line"><a name="l02099"></a><span class="lineno"> 2099</span>&#160;</div>
<div class="line"><a name="l02100"></a><span class="lineno"> 2100</span>&#160;</div>
<div class="line"><a name="l02101"></a><span class="lineno"> 2101</span>&#160;</div>
<div class="line"><a name="l02102"></a><span class="lineno"> 2102</span>&#160;</div>
<div class="line"><a name="l02103"></a><span class="lineno"> 2103</span>&#160;</div>
<div class="line"><a name="l02104"></a><span class="lineno"> 2104</span>&#160;</div>
<div class="line"><a name="l02105"></a><span class="lineno"> 2105</span>&#160;<span class="preprocessor">#define CRAZYDEBUG 0</span></div>
<div class="line"><a name="l02106"></a><span class="lineno"> 2106</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#if(CRAZYDEBUG) // begin crazy debug stuff</span></div>
<div class="line"><a name="l02107"></a><span class="lineno"> 2107</span>&#160;<span class="preprocessor"></span>  <span class="keywordflow">if</span>(1|| newtonstats-&gt;lntries&gt;3){</div>
<div class="line"><a name="l02108"></a><span class="lineno"> 2108</span>&#160;    <span class="keywordflow">if</span>(nstep==9 &amp;&amp; steppart==2 &amp;&amp; ptrgeom-&gt;i==0 &amp;&amp; ptrgeom-&gt;j==31){</div>
<div class="line"><a name="l02109"></a><span class="lineno"> 2109</span>&#160;      <span class="comment">//    if(nstep==0 &amp;&amp; steppart==0 &amp;&amp; ptrgeom-&gt;i==4 &amp;&amp; ptrgeom-&gt;j==36){</span></div>
<div class="line"><a name="l02110"></a><span class="lineno"> 2110</span>&#160;      <span class="comment">//  if(nstep==0 &amp;&amp; steppart==0 &amp;&amp; ptrgeom-&gt;i == 5 &amp;&amp; ptrgeom-&gt;j == 31 ){</span></div>
<div class="line"><a name="l02111"></a><span class="lineno"> 2111</span>&#160;      dualfprintf(fail_file,<span class="stringliteral">&quot;nstep=%ld stepart=%d :: i=%d j=%d :: lntries=%d\n&quot;</span>,nstep,steppart,ptrgeom-&gt;i,ptrgeom-&gt;j,newtonstats-&gt;lntries);</div>
<div class="line"><a name="l02112"></a><span class="lineno"> 2112</span>&#160;    </div>
<div class="line"><a name="l02113"></a><span class="lineno"> 2113</span>&#160;      <span class="comment">//    PALLLOOP(pl) dualfprintf(fail_file,&quot;Ugeomfree[%d]=%21.15g pr[%d]=%21.15g\n&quot;,pl,Ugeomfree[pl],pl,pr[pl]);</span></div>
<div class="line"><a name="l02114"></a><span class="lineno"> 2114</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl) dualfprintf(fail_file,&quot;Uoldgeomfree[%d]=%21.15g Uold[%d]=%21.15g pr[%d]=%21.15g (pr0[%d]=%21.15g)\n&quot;,pl,Uold[pl],pl,Uold[pl]*ptrgeom-&gt;gdet,pl,pr[pl],pl,pr0[pl]);</div>
<div class="line"><a name="l02115"></a><span class="lineno"> 2115</span>&#160;</div>
<div class="line"><a name="l02116"></a><span class="lineno"> 2116</span>&#160;      dualfprintf(fail_file,&quot;g=%21.15g\n&quot;,ptrgeom-&gt;gdet);</div>
<div class="line"><a name="l02117"></a><span class="lineno"> 2117</span>&#160;</div>
<div class="line"><a name="l02118"></a><span class="lineno"> 2118</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a59b7ef1517ff22fd4dfce4cf6d380c55" title="loop over all Dimensions; second rank loop">DLOOP</a>(j,k) dualfprintf(fail_file,&quot;<a class="code" href="../../dc/dd2/newcodediff_8txt.html#a98399a5a291e3844900ecfbacdcb2da0">gcon</a>=%21.15g <a class="code" href="../../dc/dd2/newcodediff_8txt.html#a93300df7bd864b90cc8ed9f3d96515ad">gcov</a>=%21.15g\n&quot;,ptrgeom-&gt;<a class="code" href="../../dc/dd2/newcodediff_8txt.html#a93300df7bd864b90cc8ed9f3d96515ad">gcov</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(j,k)],ptrgeom-&gt;<a class="code" href="../../dc/dd2/newcodediff_8txt.html#a98399a5a291e3844900ecfbacdcb2da0">gcon</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(j,k)]);</div>
<div class="line"><a name="l02119"></a><span class="lineno"> 2119</span>&#160;      <span class="comment">//    myexit(777);</span></div>
<div class="line"><a name="l02120"></a><span class="lineno"> 2120</span>&#160;      <span class="comment">//  }</span></div>
<div class="line"><a name="l02121"></a><span class="lineno"> 2121</span>&#160;    }</div>
<div class="line"><a name="l02122"></a><span class="lineno"> 2122</span>&#160;  }</div>
<div class="line"><a name="l02123"></a><span class="lineno"> 2123</span>&#160;</div>
<div class="line"><a name="l02124"></a><span class="lineno"> 2124</span>&#160;</div>
<div class="line"><a name="l02125"></a><span class="lineno"> 2125</span>&#160;  <span class="comment">// test inversion for accuracy in conservative space</span></div>
<div class="line"><a name="l02126"></a><span class="lineno"> 2126</span>&#160;  <span class="comment">//  if(nstep==0 &amp;&amp; steppart==0 &amp;&amp; ptrgeom-&gt;i == 4 &amp;&amp; ptrgeom-&gt;j == 36 ){</span></div>
<div class="line"><a name="l02127"></a><span class="lineno"> 2127</span>&#160;  if(nstep==9 &amp;&amp; steppart==2 &amp;&amp; ptrgeom-&gt;i==0 &amp;&amp; ptrgeom-&gt;j==31){</div>
<div class="line"><a name="l02128"></a><span class="lineno"> 2128</span>&#160;</div>
<div class="line"><a name="l02129"></a><span class="lineno"> 2129</span>&#160;<span class="preprocessor">#if(0)</span></div>
<div class="line"><a name="l02130"></a><span class="lineno"> 2130</span>&#160;<span class="preprocessor"></span>    pr[0]= 7.22714301361038e-06 ;</div>
<div class="line"><a name="l02131"></a><span class="lineno"> 2131</span>&#160;    pr[1]=-2.55753797775927e-07 ;</div>
<div class="line"><a name="l02132"></a><span class="lineno"> 2132</span>&#160;    pr[2]= 0.000892168434512681 ;</div>
<div class="line"><a name="l02133"></a><span class="lineno"> 2133</span>&#160;    pr[3]=  -0.0349621334882251 ;</div>
<div class="line"><a name="l02134"></a><span class="lineno"> 2134</span>&#160;    pr[4]=                   -0 ;</div>
<div class="line"><a name="l02135"></a><span class="lineno"> 2135</span>&#160;    pr[5]= -0.00101880685475446 ;</div>
<div class="line"><a name="l02136"></a><span class="lineno"> 2136</span>&#160;    pr[6]=   0.0399035382308458 ;</div>
<div class="line"><a name="l02137"></a><span class="lineno"> 2137</span>&#160;    pr[7]=                    0 ;</div>
<div class="line"><a name="l02138"></a><span class="lineno"> 2138</span>&#160;<span class="preprocessor">#elif(0)</span></div>
<div class="line"><a name="l02139"></a><span class="lineno"> 2139</span>&#160;<span class="preprocessor"></span>    pr[0]= 7.46157819677347e-06;</div>
<div class="line"><a name="l02140"></a><span class="lineno"> 2140</span>&#160;    pr[1]=  7.3407120498644e-06;</div>
<div class="line"><a name="l02141"></a><span class="lineno"> 2141</span>&#160;    pr[2]= 0.000367464781319951;</div>
<div class="line"><a name="l02142"></a><span class="lineno"> 2142</span>&#160;    pr[3]=  -0.0144105143008605;</div>
<div class="line"><a name="l02143"></a><span class="lineno"> 2143</span>&#160;    pr[4]=                    0;</div>
<div class="line"><a name="l02144"></a><span class="lineno"> 2144</span>&#160;    pr[5]= -0.00101880685475446;</div>
<div class="line"><a name="l02145"></a><span class="lineno"> 2145</span>&#160;    pr[6]=   0.0399035382308458;</div>
<div class="line"><a name="l02146"></a><span class="lineno"> 2146</span>&#160;    pr[7]=                    0;</div>
<div class="line"><a name="l02147"></a><span class="lineno"> 2147</span>&#160;<span class="preprocessor">#elif(0)</span></div>
<div class="line"><a name="l02148"></a><span class="lineno"> 2148</span>&#160;<span class="preprocessor"></span>    pr[0]=  7.5124289176258e-06 ;</div>
<div class="line"><a name="l02149"></a><span class="lineno"> 2149</span>&#160;    pr[1]= 1.33752037209996e-08 ;</div>
<div class="line"><a name="l02150"></a><span class="lineno"> 2150</span>&#160;    pr[2]= 1.33529579432262e-07 ;</div>
<div class="line"><a name="l02151"></a><span class="lineno"> 2151</span>&#160;    pr[3]=-5.23276639757274e-06 ;</div>
<div class="line"><a name="l02152"></a><span class="lineno"> 2152</span>&#160;    pr[4]=                    0 ;</div>
<div class="line"><a name="l02153"></a><span class="lineno"> 2153</span>&#160;    pr[5]= -0.00101880685475444 ;</div>
<div class="line"><a name="l02154"></a><span class="lineno"> 2154</span>&#160;    pr[6]=   0.0399035382308459 ;</div>
<div class="line"><a name="l02155"></a><span class="lineno"> 2155</span>&#160;    pr[7]=                    0 ;</div>
<div class="line"><a name="l02156"></a><span class="lineno"> 2156</span>&#160;</div>
<div class="line"><a name="l02157"></a><span class="lineno"> 2157</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02158"></a><span class="lineno"> 2158</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l02159"></a><span class="lineno"> 2159</span>&#160;    <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a11e17cd8b0594d1ad52e3594aa9f477e" title="find ucon, ucov, bcon, bcov from primitive variables when calling get_state, users of this function e...">get_state</a>(pr, ptrgeom, &amp;q),<span class="stringliteral">&quot;flux.c:fluxcalc()&quot;</span>, <span class="stringliteral">&quot;get_state()&quot;</span>, 1);</div>
<div class="line"><a name="l02160"></a><span class="lineno"> 2160</span>&#160;    <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a9a54096e4c40a15a2c1bf74266153616" title="calculate &quot;conserved&quot; quantities">primtoU</a>(UNOTHING,pr, &amp;q, ptrgeom, Unew, NULL),<span class="stringliteral">&quot;step_ch.c:advance()&quot;</span>, <span class="stringliteral">&quot;primtoU()&quot;</span>, 1); <span class="comment">// UtoU inside doesn&#39;t do anything...therefore for REMOVERESTMASSFROMUU==1, Unew[UU] will have rest-mass included</span></div>
<div class="line"><a name="l02161"></a><span class="lineno"> 2161</span>&#160;</div>
<div class="line"><a name="l02162"></a><span class="lineno"> 2162</span>&#160;    <span class="keywordflow">for</span>(k=0;k&lt;4;k++){</div>
<div class="line"><a name="l02163"></a><span class="lineno"> 2163</span>&#160;      dualfprintf(fail_file,<span class="stringliteral">&quot;q.ucon[%d]=%21.15g q.ucov[%d]=%21.15g q.bcon[%d]=%21.15g q.bcov[%d]=%21.15g\n&quot;</span>,k,q.ucon[k],k,q.ucov[k],k,q.bcon[k],k,q.bcov[k]);</div>
<div class="line"><a name="l02164"></a><span class="lineno"> 2164</span>&#160;    }</div>
<div class="line"><a name="l02165"></a><span class="lineno"> 2165</span>&#160;</div>
<div class="line"><a name="l02166"></a><span class="lineno"> 2166</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l02167"></a><span class="lineno"> 2167</span>&#160;      Unew[pl]*=ptrgeom-&gt;gdet;</div>
<div class="line"><a name="l02168"></a><span class="lineno"> 2168</span>&#160;      Uold[pl]*=ptrgeom-&gt;gdet;</div>
<div class="line"><a name="l02169"></a><span class="lineno"> 2169</span>&#160;      fdiff[pl] = fabs(Unew[pl]-Uold[pl])/(fabs(Unew[pl]+Uold[pl])+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a09c78d2f8feb311dd9fc969a0bf84979">SMALL</a>);</div>
<div class="line"><a name="l02170"></a><span class="lineno"> 2170</span>&#160;      <span class="comment">//    if(fdiff[pl]&gt;1E-10){</span></div>
<div class="line"><a name="l02171"></a><span class="lineno"> 2171</span>&#160;      <span class="keywordflow">if</span>((pl&gt;=RHO)&amp;&amp;(pl&lt;=B3)&amp;&amp;((fabs(Uold[pl])&gt;1<a class="code" href="../../d8/d60/init_8c.html#a07484107e6d9fdf38b53edf631d6511d">E</a>-20)||(fabs(Unew[pl])&gt;1<a class="code" href="../../d8/d60/init_8c.html#a07484107e6d9fdf38b53edf631d6511d">E</a>-20))){</div>
<div class="line"><a name="l02172"></a><span class="lineno"> 2172</span>&#160;        dualfprintf(fail_file,<span class="stringliteral">&quot;fdiff[%d]=%21.15g :: %21.15g %21.15g\n&quot;</span>,pl,fdiff[pl],Uold[pl],Unew[pl]);</div>
<div class="line"><a name="l02173"></a><span class="lineno"> 2173</span>&#160;      }</div>
<div class="line"><a name="l02174"></a><span class="lineno"> 2174</span>&#160;      <span class="comment">//    }</span></div>
<div class="line"><a name="l02175"></a><span class="lineno"> 2175</span>&#160;    }</div>
<div class="line"><a name="l02176"></a><span class="lineno"> 2176</span>&#160;</div>
<div class="line"><a name="l02177"></a><span class="lineno"> 2177</span>&#160;    dualfprintf(fail_file,<span class="stringliteral">&quot;dt=%21.15g\n&quot;</span>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a56db625f31229c5e8b208ff27d464931">dt</a>);</div>
<div class="line"><a name="l02178"></a><span class="lineno"> 2178</span>&#160;</div>
<div class="line"><a name="l02179"></a><span class="lineno"> 2179</span>&#160;</div>
<div class="line"><a name="l02180"></a><span class="lineno"> 2180</span>&#160;    myexit(124);</div>
<div class="line"><a name="l02181"></a><span class="lineno"> 2181</span>&#160;  }</div>
<div class="line"><a name="l02182"></a><span class="lineno"> 2182</span>&#160;<span class="preprocessor">#endif// end crazy debug stuff</span></div>
<div class="line"><a name="l02183"></a><span class="lineno"> 2183</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#undef CRAZYDEBUG</span></div>
<div class="line"><a name="l02184"></a><span class="lineno"> 2184</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l02185"></a><span class="lineno"> 2185</span>&#160;</div>
<div class="line"><a name="l02186"></a><span class="lineno"> 2186</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l02187"></a><span class="lineno"> 2187</span>&#160;</div>
<div class="line"><a name="l02188"></a><span class="lineno"> 2188</span>&#160;</div>
<div class="line"><a name="l02189"></a><span class="lineno"> 2189</span>&#160;}</div>
<div class="line"><a name="l02190"></a><span class="lineno"> 2190</span>&#160;</div>
<div class="line"><a name="l02191"></a><span class="lineno"> 2191</span>&#160;</div>
<div class="line"><a name="l02192"></a><span class="lineno"> 2192</span>&#160;</div>
<div class="line"><a name="l02193"></a><span class="lineno"> 2193</span>&#160;</div>
<div class="line"><a name="l02195"></a><span class="lineno"> 2195</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> negdensitycheck(<span class="keywordtype">int</span> finalstep, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *prim, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *pflag)</div>
<div class="line"><a name="l02196"></a><span class="lineno"> 2196</span>&#160;{</div>
<div class="line"><a name="l02197"></a><span class="lineno"> 2197</span>&#160;</div>
<div class="line"><a name="l02198"></a><span class="lineno"> 2198</span>&#160;</div>
<div class="line"><a name="l02199"></a><span class="lineno"> 2199</span>&#160;  <span class="comment">//Inversion from the average value succeeded or has a negative density or internal energy</span></div>
<div class="line"><a name="l02200"></a><span class="lineno"> 2200</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a294c90ee60024e6f3548814e7ff10a41">IFUTOPRIMFAILSOFT</a>(*pflag)) {</div>
<div class="line"><a name="l02201"></a><span class="lineno"> 2201</span>&#160;</div>
<div class="line"><a name="l02202"></a><span class="lineno"> 2202</span>&#160;    <span class="keywordflow">if</span>( prim[UU] &lt; <a class="code" href="../../d8/d5b/defs_8general_8h.html#a7a6f9a2927c5dc63051c63873b1fddc9">zerouuperbaryon</a>*prim[RHO] &amp;&amp; (finalstep&amp;&amp;<a class="code" href="../../da/d3e/definit_8h.html#a01d34fa922c4eaac94e27f2179523626" title="whether to allow negative internal energy in substep UTOPRIMFAILRETURNTYPE==UTOPRIMRETURNADJUSTED sho...">STEPOVERNEGU</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#af662b2a90aec340ab38528c25b7b5aa6">NEGDENSITY_FIXONFULLSTEP</a>) || <a class="code" href="../../da/d3e/definit_8h.html#a01d34fa922c4eaac94e27f2179523626" title="whether to allow negative internal energy in substep UTOPRIMFAILRETURNTYPE==UTOPRIMRETURNADJUSTED sho...">STEPOVERNEGU</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aadfa6222f83a05ce3739fedf420bdfea">NEGDENSITY_ALWAYSFIXUP</a>) {</div>
<div class="line"><a name="l02203"></a><span class="lineno"> 2203</span>&#160;      *pflag = <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a042dcc3162731841db25689b5f94c2ac">UTOPRIMFAILU2AVG2</a>;</div>
<div class="line"><a name="l02204"></a><span class="lineno"> 2204</span>&#160;    }</div>
<div class="line"><a name="l02205"></a><span class="lineno"> 2205</span>&#160;  }</div>
<div class="line"><a name="l02206"></a><span class="lineno"> 2206</span>&#160;</div>
<div class="line"><a name="l02207"></a><span class="lineno"> 2207</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l02208"></a><span class="lineno"> 2208</span>&#160;}</div>
<div class="line"><a name="l02209"></a><span class="lineno"> 2209</span>&#160;</div>
<div class="line"><a name="l02210"></a><span class="lineno"> 2210</span>&#160;</div>
<div class="line"><a name="l02211"></a><span class="lineno"> 2211</span>&#160;</div>
<div class="line"><a name="l02212"></a><span class="lineno"> 2212</span>&#160;</div>
<div class="line"><a name="l02213"></a><span class="lineno"> 2213</span>&#160;</div>
<div class="line"><a name="l02215"></a><span class="lineno"><a class="code" href="../../d1/d3e/utoprimgen_8c.html#abfc42de6975dd4ff02f2748404e10911"> 2215</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="../../d1/d3e/utoprimgen_8c.html#abfc42de6975dd4ff02f2748404e10911" title="perform U-&gt;p inversion on advected scalars">invert_scalars1</a>(<span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ugeomfree, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr)</div>
<div class="line"><a name="l02216"></a><span class="lineno"> 2216</span>&#160;{</div>
<div class="line"><a name="l02217"></a><span class="lineno"> 2217</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> myrhouu0,oneOmyrhouu0;</div>
<div class="line"><a name="l02218"></a><span class="lineno"> 2218</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>,<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>,k,loc;</div>
<div class="line"><a name="l02219"></a><span class="lineno"> 2219</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> prforadvect;</div>
<div class="line"><a name="l02220"></a><span class="lineno"> 2220</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ylforadvect,ynuforadvect;</div>
<div class="line"><a name="l02221"></a><span class="lineno"> 2221</span>&#160;</div>
<div class="line"><a name="l02222"></a><span class="lineno"> 2222</span>&#160;</div>
<div class="line"><a name="l02223"></a><span class="lineno"> 2223</span>&#160;</div>
<div class="line"><a name="l02224"></a><span class="lineno"> 2224</span>&#160;  i=ptrgeom-&gt;i;</div>
<div class="line"><a name="l02225"></a><span class="lineno"> 2225</span>&#160;  j=ptrgeom-&gt;j;</div>
<div class="line"><a name="l02226"></a><span class="lineno"> 2226</span>&#160;  k=ptrgeom-&gt;k;</div>
<div class="line"><a name="l02227"></a><span class="lineno"> 2227</span>&#160;  loc=ptrgeom-&gt;p;</div>
<div class="line"><a name="l02228"></a><span class="lineno"> 2228</span>&#160;  </div>
<div class="line"><a name="l02229"></a><span class="lineno"> 2229</span>&#160;</div>
<div class="line"><a name="l02230"></a><span class="lineno"> 2230</span>&#160;</div>
<div class="line"><a name="l02232"></a><span class="lineno"> 2232</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02233"></a><span class="lineno"> 2233</span>&#160;  <span class="comment">// avoid division by 0 but allow sign and 1/0 -&gt;0 assumed 0 geometry  means value can be taken to be 0</span></div>
<div class="line"><a name="l02234"></a><span class="lineno"> 2234</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02236"></a><span class="lineno"> 2236</span>&#160;<span class="comment"></span>  myrhouu0=Ugeomfree[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>];</div>
<div class="line"><a name="l02237"></a><span class="lineno"> 2237</span>&#160;  oneOmyrhouu0=<a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a1e471b644e7fd684cd5dbb144e00ee81">sign</a>(Ugeomfree[RHO])/(fabs(Ugeomfree[RHO])+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a09c78d2f8feb311dd9fc969a0bf84979">SMALL</a>);</div>
<div class="line"><a name="l02238"></a><span class="lineno"> 2238</span>&#160;</div>
<div class="line"><a name="l02239"></a><span class="lineno"> 2239</span>&#160;</div>
<div class="line"><a name="l02240"></a><span class="lineno"> 2240</span>&#160;</div>
<div class="line"><a name="l02241"></a><span class="lineno"> 2241</span>&#160;</div>
<div class="line"><a name="l02243"></a><span class="lineno"> 2243</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02244"></a><span class="lineno"> 2244</span>&#160;  <span class="comment">// Invert U-&gt;direct Primitive for scalars</span></div>
<div class="line"><a name="l02245"></a><span class="lineno"> 2245</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02247"></a><span class="lineno"> 2247</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02248"></a><span class="lineno"> 2248</span>&#160;<span class="preprocessor">#if(DOYL!=DONOYL)</span></div>
<div class="line"><a name="l02249"></a><span class="lineno"> 2249</span>&#160;<span class="preprocessor"></span>  ylforadvect = Ugeomfree[YL]*oneOmyrhouu0;</div>
<div class="line"><a name="l02250"></a><span class="lineno"> 2250</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l02251"></a><span class="lineno"> 2251</span>&#160;<span class="preprocessor"></span>  ylforadvect=0.0;</div>
<div class="line"><a name="l02252"></a><span class="lineno"> 2252</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02253"></a><span class="lineno"> 2253</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l02254"></a><span class="lineno"> 2254</span>&#160;<span class="preprocessor">#if(DOYNU!=DONOYNU)</span></div>
<div class="line"><a name="l02255"></a><span class="lineno"> 2255</span>&#160;<span class="preprocessor"></span>  ynuforadvect = Ugeomfree[YNU]*oneOmyrhouu0;</div>
<div class="line"><a name="l02256"></a><span class="lineno"> 2256</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l02257"></a><span class="lineno"> 2257</span>&#160;<span class="preprocessor"></span>  ynuforadvect=0.0;</div>
<div class="line"><a name="l02258"></a><span class="lineno"> 2258</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02259"></a><span class="lineno"> 2259</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l02261"></a><span class="lineno"> 2261</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02262"></a><span class="lineno"> 2262</span>&#160;  <span class="comment">// Invert U-&gt;P for scalars</span></div>
<div class="line"><a name="l02263"></a><span class="lineno"> 2263</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02265"></a><span class="lineno"> 2265</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02266"></a><span class="lineno"> 2266</span>&#160;</div>
<div class="line"><a name="l02267"></a><span class="lineno"> 2267</span>&#160;<span class="preprocessor">#if(DOYL!=DONOYL)</span></div>
<div class="line"><a name="l02268"></a><span class="lineno"> 2268</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#if(WHICHEOS==KAZFULL)</span></div>
<div class="line"><a name="l02269"></a><span class="lineno"> 2269</span>&#160;<span class="preprocessor"></span>  advect2yl_kazfull(<a class="code" href="../../df/d1c/global_8storage_8h.html#a5dd5a282922755d8516bcbf69ccfa767">GLOBALMAC</a>(EOSextraglobal,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k),ylforadvect,ynuforadvect,&amp;pr[YE]); <span class="comment">// pr[YE] is pr[YL] memory space</span></div>
<div class="line"><a name="l02270"></a><span class="lineno"> 2270</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l02271"></a><span class="lineno"> 2271</span>&#160;<span class="preprocessor"></span>  pr[YL] = ylforadvect;</div>
<div class="line"><a name="l02272"></a><span class="lineno"> 2272</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02273"></a><span class="lineno"> 2273</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02274"></a><span class="lineno"> 2274</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l02275"></a><span class="lineno"> 2275</span>&#160;<span class="preprocessor">#if(DOYNU!=DONOYNU)</span></div>
<div class="line"><a name="l02276"></a><span class="lineno"> 2276</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#if(WHICHEOS==KAZFULL)</span></div>
<div class="line"><a name="l02277"></a><span class="lineno"> 2277</span>&#160;<span class="preprocessor"></span>  advect2ynu_kazfull(<a class="code" href="../../df/d1c/global_8storage_8h.html#a5dd5a282922755d8516bcbf69ccfa767">GLOBALMAC</a>(EOSextraglobal,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k),ylforadvect,ynuforadvect,&amp;pr[YNU]);</div>
<div class="line"><a name="l02278"></a><span class="lineno"> 2278</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l02279"></a><span class="lineno"> 2279</span>&#160;<span class="preprocessor"></span>  pr[YNU] = ynuforadvect;</div>
<div class="line"><a name="l02280"></a><span class="lineno"> 2280</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02281"></a><span class="lineno"> 2281</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02282"></a><span class="lineno"> 2282</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l02283"></a><span class="lineno"> 2283</span>&#160;</div>
<div class="line"><a name="l02284"></a><span class="lineno"> 2284</span>&#160;</div>
<div class="line"><a name="l02286"></a><span class="lineno"> 2286</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02287"></a><span class="lineno"> 2287</span>&#160;  <span class="comment">// Change the primitives to be constrained or fixed-up.  Also perform any extra operations required by the EOS used.</span></div>
<div class="line"><a name="l02288"></a><span class="lineno"> 2288</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02290"></a><span class="lineno"> 2290</span>&#160;<span class="comment"></span>  fix_primitive_eos_scalars_simple(i,j,k,loc,pr);</div>
<div class="line"><a name="l02291"></a><span class="lineno"> 2291</span>&#160;</div>
<div class="line"><a name="l02292"></a><span class="lineno"> 2292</span>&#160;</div>
<div class="line"><a name="l02293"></a><span class="lineno"> 2293</span>&#160;</div>
<div class="line"><a name="l02295"></a><span class="lineno"> 2295</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02296"></a><span class="lineno"> 2296</span>&#160;  <span class="comment">// Adjust conserved quantities based upon fixed-up primitives</span></div>
<div class="line"><a name="l02297"></a><span class="lineno"> 2297</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02299"></a><span class="lineno"> 2299</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02300"></a><span class="lineno"> 2300</span>&#160;<span class="preprocessor">#if(DOYFL==1)</span></div>
<div class="line"><a name="l02301"></a><span class="lineno"> 2301</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l02302"></a><span class="lineno"> 2302</span>&#160;<span class="preprocessor">#if(YFL1&gt;=0)</span></div>
<div class="line"><a name="l02303"></a><span class="lineno"> 2303</span>&#160;<span class="preprocessor"></span>  pr[YFL1] = Ugeomfree[YFL1]*oneOmyrhouu0;</div>
<div class="line"><a name="l02304"></a><span class="lineno"> 2304</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02305"></a><span class="lineno"> 2305</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#if(YFL2&gt;=0)</span></div>
<div class="line"><a name="l02306"></a><span class="lineno"> 2306</span>&#160;<span class="preprocessor"></span>  pr[YFL2] = -Ugeomfree[YFL2]*oneOmyrhouu0; <span class="comment">// NOTEMARK: Same sign as in other places like fixup.c and elsewhere here in this file.</span></div>
<div class="line"><a name="l02307"></a><span class="lineno"> 2307</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02308"></a><span class="lineno"> 2308</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#if(YFL3&gt;=0)</span></div>
<div class="line"><a name="l02309"></a><span class="lineno"> 2309</span>&#160;<span class="preprocessor"></span>  pr[YFL3] = Ugeomfree[YFL3]*oneOmyrhouu0;</div>
<div class="line"><a name="l02310"></a><span class="lineno"> 2310</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02311"></a><span class="lineno"> 2311</span>&#160;<span class="preprocessor"></span>    <span class="comment">// below make no sense</span></div>
<div class="line"><a name="l02312"></a><span class="lineno"> 2312</span>&#160;    <span class="comment">//#if(YFL4&gt;=0)</span></div>
<div class="line"><a name="l02313"></a><span class="lineno"> 2313</span>&#160;    <span class="comment">//  pr[YFL4] = -Ugeomfree[YFL4]*oneOmyrhouu0;</span></div>
<div class="line"><a name="l02314"></a><span class="lineno"> 2314</span>&#160;    <span class="comment">//#endif</span></div>
<div class="line"><a name="l02315"></a><span class="lineno"> 2315</span>&#160;    <span class="comment">//#if(YFL5&gt;=0)</span></div>
<div class="line"><a name="l02316"></a><span class="lineno"> 2316</span>&#160;    <span class="comment">//  pr[YFL5] = Ugeomfree[YFL5]*oneOmyrhouu0;</span></div>
<div class="line"><a name="l02317"></a><span class="lineno"> 2317</span>&#160;    <span class="comment">//#endif</span></div>
<div class="line"><a name="l02318"></a><span class="lineno"> 2318</span>&#160;</div>
<div class="line"><a name="l02319"></a><span class="lineno"> 2319</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02320"></a><span class="lineno"> 2320</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l02321"></a><span class="lineno"> 2321</span>&#160;</div>
<div class="line"><a name="l02322"></a><span class="lineno"> 2322</span>&#160;</div>
<div class="line"><a name="l02323"></a><span class="lineno"> 2323</span>&#160;</div>
<div class="line"><a name="l02324"></a><span class="lineno"> 2324</span>&#160;<span class="preprocessor">#if(DOYL!=DONOYL)</span></div>
<div class="line"><a name="l02325"></a><span class="lineno"> 2325</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#if(WHICHEOS==KAZFULL)</span></div>
<div class="line"><a name="l02326"></a><span class="lineno"> 2326</span>&#160;<span class="preprocessor"></span>  yl2advect_kazfull(<a class="code" href="../../df/d1c/global_8storage_8h.html#a5dd5a282922755d8516bcbf69ccfa767">GLOBALMAC</a>(EOSextraglobal,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k),pr[YL],pr[YNU],&amp;prforadvect);</div>
<div class="line"><a name="l02327"></a><span class="lineno"> 2327</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l02328"></a><span class="lineno"> 2328</span>&#160;<span class="preprocessor"></span>  prforadvect = pr[YL];</div>
<div class="line"><a name="l02329"></a><span class="lineno"> 2329</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02330"></a><span class="lineno"> 2330</span>&#160;<span class="preprocessor"></span>  Ugeomfree[YL] = prforadvect*myrhouu0;</div>
<div class="line"><a name="l02331"></a><span class="lineno"> 2331</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02332"></a><span class="lineno"> 2332</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l02333"></a><span class="lineno"> 2333</span>&#160;<span class="preprocessor">#if(DOYNU!=DONOYNU)</span></div>
<div class="line"><a name="l02334"></a><span class="lineno"> 2334</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#if(WHICHEOS==KAZFULL)</span></div>
<div class="line"><a name="l02335"></a><span class="lineno"> 2335</span>&#160;<span class="preprocessor"></span>  ynu2advect_kazfull(<a class="code" href="../../df/d1c/global_8storage_8h.html#a5dd5a282922755d8516bcbf69ccfa767">GLOBALMAC</a>(EOSextraglobal,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k),pr[YL],pr[YNU],&amp;prforadvect);</div>
<div class="line"><a name="l02336"></a><span class="lineno"> 2336</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l02337"></a><span class="lineno"> 2337</span>&#160;<span class="preprocessor"></span>  prforadvect = pr[YNU];</div>
<div class="line"><a name="l02338"></a><span class="lineno"> 2338</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02339"></a><span class="lineno"> 2339</span>&#160;<span class="preprocessor"></span>  Ugeomfree[YNU] = prforadvect*myrhouu0;</div>
<div class="line"><a name="l02340"></a><span class="lineno"> 2340</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02341"></a><span class="lineno"> 2341</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l02342"></a><span class="lineno"> 2342</span>&#160;</div>
<div class="line"><a name="l02343"></a><span class="lineno"> 2343</span>&#160;  <span class="comment">// SUPER TODO: Consider if need to recompute KAZ EOSextra stuff for fluxes.  Maybe now with primitives as lookups, interpolations correct.  But need to ensure assignments to EOSextra for Y_e and Ynu0 is correctly done.  Can leave neutrino stuff as &quot;DONOR&quot; cell</span></div>
<div class="line"><a name="l02344"></a><span class="lineno"> 2344</span>&#160;</div>
<div class="line"><a name="l02345"></a><span class="lineno"> 2345</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l02346"></a><span class="lineno"> 2346</span>&#160;}</div>
<div class="line"><a name="l02347"></a><span class="lineno"> 2347</span>&#160;</div>
<div class="line"><a name="l02348"></a><span class="lineno"> 2348</span>&#160;</div>
<div class="line"><a name="l02349"></a><span class="lineno"> 2349</span>&#160;</div>
<div class="line"><a name="l02350"></a><span class="lineno"> 2350</span>&#160;</div>
<div class="line"><a name="l02351"></a><span class="lineno"> 2351</span>&#160;</div>
<div class="line"><a name="l02353"></a><span class="lineno"><a class="code" href="../../d1/d3e/utoprimgen_8c.html#a1118806d01e553c38ae5cf5f036f9f2e"> 2353</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="../../d1/d3e/utoprimgen_8c.html#a1118806d01e553c38ae5cf5f036f9f2e" title="perform U-&gt;p inversion on advected scalars">invert_scalars2</a>(<span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ugeomfree, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *q, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr)</div>
<div class="line"><a name="l02354"></a><span class="lineno"> 2354</span>&#160;{</div>
<div class="line"><a name="l02355"></a><span class="lineno"> 2355</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>,<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>,k,loc;</div>
<div class="line"><a name="l02356"></a><span class="lineno"> 2356</span>&#160;</div>
<div class="line"><a name="l02357"></a><span class="lineno"> 2357</span>&#160;  i=ptrgeom-&gt;i;</div>
<div class="line"><a name="l02358"></a><span class="lineno"> 2358</span>&#160;  j=ptrgeom-&gt;j;</div>
<div class="line"><a name="l02359"></a><span class="lineno"> 2359</span>&#160;  k=ptrgeom-&gt;k;</div>
<div class="line"><a name="l02360"></a><span class="lineno"> 2360</span>&#160;  loc=ptrgeom-&gt;p;</div>
<div class="line"><a name="l02361"></a><span class="lineno"> 2361</span>&#160;  </div>
<div class="line"><a name="l02362"></a><span class="lineno"> 2362</span>&#160;</div>
<div class="line"><a name="l02363"></a><span class="lineno"> 2363</span>&#160;  <span class="comment">// get u^t</span></div>
<div class="line"><a name="l02364"></a><span class="lineno"> 2364</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> <a class="code" href="../../d1/d83/structof__state.html#aab723d3c7c2c48b7246cc7d7d5379eed">ucon</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>],<a class="code" href="../../d1/d83/structof__state.html#aad8be02577d0aa545b36e596e8b50ee9">others</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a266c1c3ab2959dbfc603c7d3f12783fb" title="strict limit (doesn&#39;t work in general)">NUMOTHERSTATERESULTS</a>];</div>
<div class="line"><a name="l02365"></a><span class="lineno"> 2365</span>&#160;  <span class="comment">//  FTYPE uradcon[NDIM],othersrad[NUMOTHERSTATERESULTS];</span></div>
<div class="line"><a name="l02366"></a><span class="lineno"> 2366</span>&#160;  <span class="keywordflow">if</span>(q==NULL){</div>
<div class="line"><a name="l02367"></a><span class="lineno"> 2367</span>&#160;    <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#afc93fd4a6f7a2b87a9315d5fba5a529c">ucon_calc</a>(pr,ptrgeom,ucon,others);</div>
<div class="line"><a name="l02368"></a><span class="lineno"> 2368</span>&#160;    <span class="comment">//    if(EOMRADTYPE!=EOMRADNONE &amp;&amp; (YFL4&gt;=0||YFL5&gt;=0) ){</span></div>
<div class="line"><a name="l02369"></a><span class="lineno"> 2369</span>&#160;    <span class="comment">//      ucon_calc(&amp;pr[URAD1-U1],ptrgeom,uradcon,othersrad);</span></div>
<div class="line"><a name="l02370"></a><span class="lineno"> 2370</span>&#160;    <span class="comment">//    }</span></div>
<div class="line"><a name="l02371"></a><span class="lineno"> 2371</span>&#160;  }</div>
<div class="line"><a name="l02372"></a><span class="lineno"> 2372</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l02373"></a><span class="lineno"> 2373</span>&#160;    ucon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>] = q-&gt;<a class="code" href="../../d1/d83/structof__state.html#aab723d3c7c2c48b7246cc7d7d5379eed">ucon</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>];</div>
<div class="line"><a name="l02374"></a><span class="lineno"> 2374</span>&#160;    <span class="comment">//    uradcon[TT] = q-&gt;uradcon[TT];</span></div>
<div class="line"><a name="l02375"></a><span class="lineno"> 2375</span>&#160;  }</div>
<div class="line"><a name="l02376"></a><span class="lineno"> 2376</span>&#160;</div>
<div class="line"><a name="l02377"></a><span class="lineno"> 2377</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> udir[NPR]={0.0};</div>
<div class="line"><a name="l02378"></a><span class="lineno"> 2378</span>&#160;  udir[YFL1]=udir[YFL2]=udir[YFL3]=ucon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>];</div>
<div class="line"><a name="l02379"></a><span class="lineno"> 2379</span>&#160;  <span class="comment">//  udir[YFL4]=udir[YFL5]=uradcon[TT];</span></div>
<div class="line"><a name="l02380"></a><span class="lineno"> 2380</span>&#160;</div>
<div class="line"><a name="l02381"></a><span class="lineno"> 2381</span>&#160;</div>
<div class="line"><a name="l02383"></a><span class="lineno"> 2383</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02384"></a><span class="lineno"> 2384</span>&#160;  <span class="comment">// Invert U-&gt;direct Primitive for scalars (in rhopart form rather than y=rhopart/rhototal form)</span></div>
<div class="line"><a name="l02385"></a><span class="lineno"> 2385</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02387"></a><span class="lineno"> 2387</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02388"></a><span class="lineno"> 2388</span>&#160;<span class="preprocessor">#if(DOYFL==2)</span></div>
<div class="line"><a name="l02389"></a><span class="lineno"> 2389</span>&#160;<span class="preprocessor"></span>  <span class="keywordflow">if</span>(YFL1&gt;=0) pr[YFL1] = Ugeomfree[YFL1]/udir[YFL1];</div>
<div class="line"><a name="l02390"></a><span class="lineno"> 2390</span>&#160;  <span class="keywordflow">if</span>(YFL2&gt;=0){</div>
<div class="line"><a name="l02391"></a><span class="lineno"> 2391</span>&#160;    pr[YFL2] = -Ugeomfree[YFL2]/udir[YFL2]; <span class="comment">// NOTEMARK: Same sign as in other places like fixup.c and elsewhere here in this file.</span></div>
<div class="line"><a name="l02392"></a><span class="lineno"> 2392</span>&#160;    <span class="keywordflow">if</span>(pr[YFL2]&lt;<a class="code" href="../../d8/d5b/defs_8general_8h.html#aa0ed69c2bd22558a88c5030c33d90371">UULIMIT</a>) pr[YFL2]=<a class="code" href="../../d8/d5b/defs_8general_8h.html#aa0ed69c2bd22558a88c5030c33d90371">UULIMIT</a>;</div>
<div class="line"><a name="l02393"></a><span class="lineno"> 2393</span>&#160;  }</div>
<div class="line"><a name="l02394"></a><span class="lineno"> 2394</span>&#160;  <span class="keywordflow">if</span>(YFL3&gt;=0) pr[YFL3] = Ugeomfree[YFL3]/udir[YFL3];</div>
<div class="line"><a name="l02395"></a><span class="lineno"> 2395</span>&#160;  <span class="comment">//  if(YFL4&gt;=0) pr[YFL4] = -Ugeomfree[YFL4]/udir[YFL4];</span></div>
<div class="line"><a name="l02396"></a><span class="lineno"> 2396</span>&#160;  <span class="comment">//  if(YFL5&gt;=0) pr[YFL5] = Ugeomfree[YFL5]/udir[YFL5];</span></div>
<div class="line"><a name="l02397"></a><span class="lineno"> 2397</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02398"></a><span class="lineno"> 2398</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l02399"></a><span class="lineno"> 2399</span>&#160;</div>
<div class="line"><a name="l02400"></a><span class="lineno"> 2400</span>&#160;</div>
<div class="line"><a name="l02401"></a><span class="lineno"> 2401</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l02402"></a><span class="lineno"> 2402</span>&#160;}</div>
<div class="line"><a name="l02403"></a><span class="lineno"> 2403</span>&#160;</div>
<div class="line"><a name="l02404"></a><span class="lineno"> 2404</span>&#160;</div>
<div class="line"><a name="l02405"></a><span class="lineno"> 2405</span>&#160;</div>
<div class="line"><a name="l02406"></a><span class="lineno"> 2406</span>&#160;</div>
<div class="line"><a name="l02407"></a><span class="lineno"> 2407</span>&#160;</div>
<div class="line"><a name="l02409"></a><span class="lineno"> 2409</span>&#160;<span class="keywordtype">void</span> convert_U_removerestmassfromuu(<span class="keywordtype">int</span> utoprimversion, <span class="keywordtype">int</span> removerestmassfromuu, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *U)</div>
<div class="line"><a name="l02410"></a><span class="lineno"> 2410</span>&#160;{</div>
<div class="line"><a name="l02411"></a><span class="lineno"> 2411</span>&#160;</div>
<div class="line"><a name="l02413"></a><span class="lineno"> 2413</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02415"></a><span class="lineno"> 2415</span>&#160;<span class="comment"></span>  <span class="comment">//</span></div>
<div class="line"><a name="l02416"></a><span class="lineno"> 2416</span>&#160;  <span class="comment">// check if inversion is chosen consistent with REMOVERESTMASSFROMUU</span></div>
<div class="line"><a name="l02417"></a><span class="lineno"> 2417</span>&#160;  <span class="comment">// At this point, Ugeomfree[UU] in &quot;standard form with rest-mass&quot; for REMOVERESTMASSFROMUU=0,1.  If ==2, then no rest-mass</span></div>
<div class="line"><a name="l02418"></a><span class="lineno"> 2418</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02420"></a><span class="lineno"> 2420</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02421"></a><span class="lineno"> 2421</span>&#160;  <span class="keywordflow">if</span>(removerestmassfromuu==2){</div>
<div class="line"><a name="l02422"></a><span class="lineno"> 2422</span>&#160;    <span class="comment">// 5D1 handles removerestmassfromuu internally</span></div>
<div class="line"><a name="l02423"></a><span class="lineno"> 2423</span>&#160;    <span class="comment">// NONRELCOMPAT only accepts UU without rest-mass, so good to go</span></div>
<div class="line"><a name="l02424"></a><span class="lineno"> 2424</span>&#160;    <span class="keywordflow">if</span>( utoprimversion!=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#abd3dcef411a08060eddd9a17eeb655c5" title="#define FLUXB FLUXCTTOTH 0: HLL 1: FLUXCT TOTH version (toth 2000 eq.">UTOPRIM5D1</a> &amp;&amp; (utoprimversion!=UTOPRIMJONNONRELCOMPAT) ){</div>
<div class="line"><a name="l02425"></a><span class="lineno"> 2425</span>&#160;      <span class="comment">//    dualfprintf(fail_file,&quot;This code does not handle removerestmassfromuu==2: other Utoprim&#39;s besides 5D1 and 2DFINAL\n&quot;);</span></div>
<div class="line"><a name="l02426"></a><span class="lineno"> 2426</span>&#160;      <span class="comment">//    myexit(1);</span></div>
<div class="line"><a name="l02427"></a><span class="lineno"> 2427</span>&#160;      <span class="comment">// then change conserved quantity so can work</span></div>
<div class="line"><a name="l02428"></a><span class="lineno"> 2428</span>&#160;      U[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]-=U[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>]; <span class="comment">// &quot;add in rest-mass&quot; so in correct form</span></div>
<div class="line"><a name="l02429"></a><span class="lineno"> 2429</span>&#160;    }</div>
<div class="line"><a name="l02430"></a><span class="lineno"> 2430</span>&#160;  }</div>
<div class="line"><a name="l02431"></a><span class="lineno"> 2431</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(removerestmassfromuu==0 || removerestmassfromuu==1){</div>
<div class="line"><a name="l02432"></a><span class="lineno"> 2432</span>&#160;    <span class="keywordflow">if</span>(utoprimversion==UTOPRIMJONNONRELCOMPAT){</div>
<div class="line"><a name="l02433"></a><span class="lineno"> 2433</span>&#160;      <span class="comment">// then change conserved quantity so can work for UTOPRIMJONNONRELCOMPAT</span></div>
<div class="line"><a name="l02434"></a><span class="lineno"> 2434</span>&#160;      U[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]+=U[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>]; <span class="comment">// &quot;subtract out rest-mass&quot; so in correct form for NONRELCOMPAT</span></div>
<div class="line"><a name="l02435"></a><span class="lineno"> 2435</span>&#160;    }</div>
<div class="line"><a name="l02436"></a><span class="lineno"> 2436</span>&#160;  }</div>
<div class="line"><a name="l02437"></a><span class="lineno"> 2437</span>&#160;</div>
<div class="line"><a name="l02438"></a><span class="lineno"> 2438</span>&#160;</div>
<div class="line"><a name="l02439"></a><span class="lineno"> 2439</span>&#160;}</div>
<div class="line"><a name="l02440"></a><span class="lineno"> 2440</span>&#160;</div>
<div class="line"><a name="l02441"></a><span class="lineno"> 2441</span>&#160;</div>
<div class="line"><a name="l02442"></a><span class="lineno"> 2442</span>&#160;</div>
<div class="line"><a name="l02443"></a><span class="lineno"> 2443</span>&#160;</div>
<div class="line"><a name="l02444"></a><span class="lineno"> 2444</span>&#160;</div>
<div class="line"><a name="l02445"></a><span class="lineno"> 2445</span>&#160;</div>
<div class="line"><a name="l02446"></a><span class="lineno"> 2446</span>&#160;</div>
<div class="line"><a name="l02447"></a><span class="lineno"> 2447</span>&#160;</div>
<div class="line"><a name="l02448"></a><span class="lineno"> 2448</span>&#160;</div>
<div class="line"><a name="l02449"></a><span class="lineno"> 2449</span>&#160;</div>
<div class="line"><a name="l02451"></a><span class="lineno"> 2451</span>&#160;<span class="keywordtype">int</span> Utoprimdiss(<span class="keywordtype">int</span> showmessages, <span class="keywordtype">int</span> allowlocalfailurefixandnoreport, <span class="keywordtype">int</span> evolvetype, <span class="keywordtype">int</span> inputtype,<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *U,  <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *otherpflag, <span class="keyword">struct</span> <a class="code" href="../../db/d3a/structof__newtonstats.html">of_newtonstats</a> *newtonstats, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflagrad)</div>
<div class="line"><a name="l02452"></a><span class="lineno"> 2452</span>&#160;{</div>
<div class="line"><a name="l02453"></a><span class="lineno"> 2453</span>&#160;  <span class="comment">// debug</span></div>
<div class="line"><a name="l02454"></a><span class="lineno"> 2454</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>, <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>, k;</div>
<div class="line"><a name="l02455"></a><span class="lineno"> 2455</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Ugeomfree[NPR],Ugeomfree0[NPR];</div>
<div class="line"><a name="l02456"></a><span class="lineno"> 2456</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> pr0[NPR];</div>
<div class="line"><a name="l02457"></a><span class="lineno"> 2457</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> prother[NPR];</div>
<div class="line"><a name="l02458"></a><span class="lineno"> 2458</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Upr[NPR],Uprother[NPR];</div>
<div class="line"><a name="l02459"></a><span class="lineno"> 2459</span>&#160;  <span class="keywordtype">int</span> whichentropy;</div>
<div class="line"><a name="l02460"></a><span class="lineno"> 2460</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> q;</div>
<div class="line"><a name="l02461"></a><span class="lineno"> 2461</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Uold[NPR],Unew[NPR];</div>
<div class="line"><a name="l02462"></a><span class="lineno"> 2462</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fdiff[NPR];</div>
<div class="line"><a name="l02463"></a><span class="lineno"> 2463</span>&#160;  <span class="keyword">extern</span> <span class="keywordtype">void</span> UtoU(<span class="keywordtype">int</span> inputtype, <span class="keywordtype">int</span> returntype,<span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom,<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Uin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Uout);</div>
<div class="line"><a name="l02464"></a><span class="lineno"> 2464</span>&#160;  <span class="keywordtype">int</span> pl,pliter;</div>
<div class="line"><a name="l02465"></a><span class="lineno"> 2465</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> pressuremem;</div>
<div class="line"><a name="l02466"></a><span class="lineno"> 2466</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pressure=&amp;pressuremem;</div>
<div class="line"><a name="l02467"></a><span class="lineno"> 2467</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d1/d3e/utoprimgen_8c.html#a0a83e9e7fdd3cc595c5b8d0df88ec684" title="just picks the algorithm to invert">Utoprimgen_pick</a>(<span class="keywordtype">int</span> showmessages, <span class="keywordtype">int</span> allowlocalfailurefixandnoreport, <span class="keywordtype">int</span> which, <span class="keywordtype">int</span> eomtype, <span class="keywordtype">int</span> whichcap, <span class="keywordtype">int</span> parameter, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ugeomfree, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflag, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pressure, <span class="keyword">struct</span> <a class="code" href="../../db/d3a/structof__newtonstats.html">of_newtonstats</a> *newtonstats, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflagrad);</div>
<div class="line"><a name="l02468"></a><span class="lineno"> 2468</span>&#160;  <span class="keywordtype">int</span> eomtypelocal=<a class="code" href="../../da/d3e/definit_8h.html#a87e5572748e4cc27373e50bd78e6f2e8">EOMTYPE</a>; <span class="comment">// as chosen before introduced eomtypelocal</span></div>
<div class="line"><a name="l02469"></a><span class="lineno"> 2469</span>&#160;  <span class="keywordtype">int</span> whichcap=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a4b6c6060c025e15f1d92aae3dcb9365b" title="which cap type to place in rad inversion">CAPTYPEBASIC</a>;</div>
<div class="line"><a name="l02470"></a><span class="lineno"> 2470</span>&#160;</div>
<div class="line"><a name="l02471"></a><span class="lineno"> 2471</span>&#160;</div>
<div class="line"><a name="l02472"></a><span class="lineno"> 2472</span>&#160;</div>
<div class="line"><a name="l02473"></a><span class="lineno"> 2473</span>&#160;</div>
<div class="line"><a name="l02474"></a><span class="lineno"> 2474</span>&#160;  <span class="comment">// Notice that reconstruct &quot;standard&quot; geometry-free conserved quantities by first modifying the geometry prefactor and THEN dealing with rest-mass or other subtractions and additions.</span></div>
<div class="line"><a name="l02475"></a><span class="lineno"> 2475</span>&#160;  <span class="comment">// This is consistent with primtoflux() and how primtoflux() is used in source_conn().</span></div>
<div class="line"><a name="l02476"></a><span class="lineno"> 2476</span>&#160;  UtoU(inputtype,UNOTHING,ptrgeom,U,Ugeomfree);</div>
<div class="line"><a name="l02477"></a><span class="lineno"> 2477</span>&#160;</div>
<div class="line"><a name="l02478"></a><span class="lineno"> 2478</span>&#160;</div>
<div class="line"><a name="l02480"></a><span class="lineno"> 2480</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02481"></a><span class="lineno"> 2481</span>&#160;  <span class="comment">// backup</span></div>
<div class="line"><a name="l02482"></a><span class="lineno"> 2482</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02484"></a><span class="lineno"> 2484</span>&#160;<span class="comment"></span>  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl){</div>
<div class="line"><a name="l02485"></a><span class="lineno"> 2485</span>&#160;    Uold[pl]=Ugeomfree0[pl]=Ugeomfree[pl];</div>
<div class="line"><a name="l02486"></a><span class="lineno"> 2486</span>&#160;    pr0[pl]=pr[pl];</div>
<div class="line"><a name="l02487"></a><span class="lineno"> 2487</span>&#160;  }</div>
<div class="line"><a name="l02488"></a><span class="lineno"> 2488</span>&#160;  </div>
<div class="line"><a name="l02489"></a><span class="lineno"> 2489</span>&#160;</div>
<div class="line"><a name="l02491"></a><span class="lineno"> 2491</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02492"></a><span class="lineno"> 2492</span>&#160;  <span class="comment">// convert U into form appropriate for inversion routine (probably does nothing since assume UTOPRIM5D1 used) and feed Utprim Uold anyways</span></div>
<div class="line"><a name="l02493"></a><span class="lineno"> 2493</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02495"></a><span class="lineno"> 2495</span>&#160;<span class="comment"></span>  convert_U_removerestmassfromuu(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#abd3dcef411a08060eddd9a17eeb655c5" title="#define FLUXB FLUXCTTOTH 0: HLL 1: FLUXCT TOTH version (toth 2000 eq.">UTOPRIM5D1</a>,<a class="code" href="../../da/d3e/definit_8h.html#af48e1348f10b3468e425c084365f5e64" title="which velocity to compute in (init can be anything (see init.c&#39;s for transformations)">REMOVERESTMASSFROMUU</a>,Ugeomfree);</div>
<div class="line"><a name="l02496"></a><span class="lineno"> 2496</span>&#160;  convert_U_removerestmassfromuu(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#abd3dcef411a08060eddd9a17eeb655c5" title="#define FLUXB FLUXCTTOTH 0: HLL 1: FLUXCT TOTH version (toth 2000 eq.">UTOPRIM5D1</a>,<a class="code" href="../../da/d3e/definit_8h.html#af48e1348f10b3468e425c084365f5e64" title="which velocity to compute in (init can be anything (see init.c&#39;s for transformations)">REMOVERESTMASSFROMUU</a>,Ugeomfree0);</div>
<div class="line"><a name="l02497"></a><span class="lineno"> 2497</span>&#160;</div>
<div class="line"><a name="l02498"></a><span class="lineno"> 2498</span>&#160;</div>
<div class="line"><a name="l02500"></a><span class="lineno"> 2500</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02501"></a><span class="lineno"> 2501</span>&#160;  <span class="comment">// DO INVERSION</span></div>
<div class="line"><a name="l02502"></a><span class="lineno"> 2502</span>&#160;</div>
<div class="line"><a name="l02503"></a><span class="lineno"> 2503</span>&#160;  <span class="comment">// assume solution is good unless flagged as bad</span></div>
<div class="line"><a name="l02504"></a><span class="lineno"> 2504</span>&#160;  *otherpflag=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#abdf9e55b7b15ec0bcd386055f1787f47">UTOPRIMNOFAIL</a>;</div>
<div class="line"><a name="l02505"></a><span class="lineno"> 2505</span>&#160;</div>
<div class="line"><a name="l02506"></a><span class="lineno"> 2506</span>&#160;  <span class="comment">// do separate inversion for entropy version of EOMs</span></div>
<div class="line"><a name="l02507"></a><span class="lineno"> 2507</span>&#160;  <span class="comment">// only one inversion is setup to handle this</span></div>
<div class="line"><a name="l02508"></a><span class="lineno"> 2508</span>&#160;  whichentropy=<a class="code" href="../../da/d3e/definit_8h.html#ab40155224ab3e90337a8fbfea6d6d0c6" title="below only applies to dissipation inversion">WHICHENTROPYEVOLVE</a>;</div>
<div class="line"><a name="l02509"></a><span class="lineno"> 2509</span>&#160;</div>
<div class="line"><a name="l02511"></a><span class="lineno"> 2511</span>&#160;  <span class="comment">// get entropy evolution (don&#39;t use failure -- otherpflag)</span></div>
<div class="line"><a name="l02512"></a><span class="lineno"> 2512</span>&#160;  <span class="comment">// this inversion knows about global settings for DOENTROPY and increases tolerance for doing comparison</span></div>
<div class="line"><a name="l02513"></a><span class="lineno"> 2513</span>&#160;  <a class="code" href="../../d1/d3e/utoprimgen_8c.html#a0a83e9e7fdd3cc595c5b8d0df88ec684" title="just picks the algorithm to invert">Utoprimgen_pick</a>(showmessages, allowlocalfailurefixandnoreport, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#abd3dcef411a08060eddd9a17eeb655c5" title="#define FLUXB FLUXCTTOTH 0: HLL 1: FLUXCT TOTH version (toth 2000 eq.">UTOPRIM5D1</a>, eomtypelocal, whichcap, whichentropy, Uold, ptrgeom, otherpflag, pr, pressure, newtonstats, lpflagrad);</div>
<div class="line"><a name="l02514"></a><span class="lineno"> 2514</span>&#160;</div>
<div class="line"><a name="l02515"></a><span class="lineno"> 2515</span>&#160;  <span class="comment">// DEBUG:</span></div>
<div class="line"><a name="l02516"></a><span class="lineno"> 2516</span>&#160;  <span class="comment">//  PLOOP(pliter,pl) dualfprintf(fail_file,&quot;otherpflag=%d Uold[%d]=%21.15g pr0[%d]=%21.15g pr[%d]=%21.15g\n&quot;,*otherpflag,pl,Uold[pl],pl,pr0[pl], pl,pr[pl]);</span></div>
<div class="line"><a name="l02517"></a><span class="lineno"> 2517</span>&#160;</div>
<div class="line"><a name="l02518"></a><span class="lineno"> 2518</span>&#160;  </div>
<div class="line"><a name="l02519"></a><span class="lineno"> 2519</span>&#160;  <span class="comment">// now get conserved quantity from pr to check</span></div>
<div class="line"><a name="l02520"></a><span class="lineno"> 2520</span>&#160;  <span class="comment">// find U(p)</span></div>
<div class="line"><a name="l02521"></a><span class="lineno"> 2521</span>&#160;  <span class="comment">//  MYFUN(get_state(pr, ptrgeom, &amp;q),&quot;step_ch.c:advance()&quot;, &quot;get_state()&quot;, 1);</span></div>
<div class="line"><a name="l02522"></a><span class="lineno"> 2522</span>&#160;  <span class="comment">//  MYFUN(primtoU(UNOTHING,pr, &amp;q, ptrgeom, Unew, NULL),&quot;step_ch.c:advance()&quot;, &quot;primtoU()&quot;, 1);</span></div>
<div class="line"><a name="l02523"></a><span class="lineno"> 2523</span>&#160;  </div>
<div class="line"><a name="l02524"></a><span class="lineno"> 2524</span>&#160;  </div>
<div class="line"><a name="l02525"></a><span class="lineno"> 2525</span>&#160;  <span class="comment">//  if(0&amp;&amp; *otherpflag){</span></div>
<div class="line"><a name="l02526"></a><span class="lineno"> 2526</span>&#160;  <span class="comment">//    PLOOP(pliter,pl){</span></div>
<div class="line"><a name="l02527"></a><span class="lineno"> 2527</span>&#160;  <span class="comment">//  fdiff[pl] = fabs(Unew[pl]-Uold[pl])/(fabs(Unew[pl]+Uold[pl])+1E-30);</span></div>
<div class="line"><a name="l02528"></a><span class="lineno"> 2528</span>&#160;  <span class="comment">//      if(fdiff[pl]&gt;1E-10){</span></div>
<div class="line"><a name="l02529"></a><span class="lineno"> 2529</span>&#160;  <span class="comment">// if((pl&gt;=U1)&amp;&amp;(pl&lt;=B3)&amp;&amp;((fabs(Uold[pl])&gt;1E-20)||(fabs(Unew[pl])&gt;1E-20))){</span></div>
<div class="line"><a name="l02530"></a><span class="lineno"> 2530</span>&#160;  <span class="comment">//   dualfprintf(fail_file,&quot;fdiff[%d]=%21.15g :: %g %g\n&quot;,pl,fdiff[pl],Uold[pl],Unew[pl]);</span></div>
<div class="line"><a name="l02531"></a><span class="lineno"> 2531</span>&#160;  <span class="comment">// }</span></div>
<div class="line"><a name="l02532"></a><span class="lineno"> 2532</span>&#160;  <span class="comment">//      }</span></div>
<div class="line"><a name="l02533"></a><span class="lineno"> 2533</span>&#160;  <span class="comment">// }</span></div>
<div class="line"><a name="l02534"></a><span class="lineno"> 2534</span>&#160;  <span class="comment">//      }</span></div>
<div class="line"><a name="l02535"></a><span class="lineno"> 2535</span>&#160;</div>
<div class="line"><a name="l02536"></a><span class="lineno"> 2536</span>&#160;     </div>
<div class="line"><a name="l02537"></a><span class="lineno"> 2537</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l02538"></a><span class="lineno"> 2538</span>&#160;}</div>
<div class="line"><a name="l02539"></a><span class="lineno"> 2539</span>&#160;</div>
<div class="line"><a name="l02540"></a><span class="lineno"> 2540</span>&#160;</div>
<div class="line"><a name="l02541"></a><span class="lineno"> 2541</span>&#160;</div>
<div class="line"><a name="l02542"></a><span class="lineno"> 2542</span>&#160;</div>
<div class="line"><a name="l02543"></a><span class="lineno"> 2543</span>&#160;</div>
<div class="line"><a name="l02544"></a><span class="lineno"> 2544</span>&#160;</div>
<div class="line"><a name="l02548"></a><span class="lineno"> 2548</span>&#160;<span class="keywordtype">int</span> Utoprimgen_compare(<span class="keywordtype">int</span> showmessages, <span class="keywordtype">int</span> allowlocalfailurefixandnoreport, <span class="keywordtype">int</span> eomtype, <span class="keywordtype">int</span> whichcap, <span class="keywordtype">int</span> parameter, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ugeomfree, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflag, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pressure, <span class="keyword">struct</span> <a class="code" href="../../db/d3a/structof__newtonstats.html">of_newtonstats</a> *newtonstats, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflagrad)</div>
<div class="line"><a name="l02549"></a><span class="lineno"> 2549</span>&#160;{</div>
<div class="line"><a name="l02550"></a><span class="lineno"> 2550</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d1/d3e/utoprimgen_8c.html#a0a83e9e7fdd3cc595c5b8d0df88ec684" title="just picks the algorithm to invert">Utoprimgen_pick</a>(<span class="keywordtype">int</span> showmessages, <span class="keywordtype">int</span> allowlocalfailurefixandnoreport, <span class="keywordtype">int</span> which, <span class="keywordtype">int</span> eomtype, <span class="keywordtype">int</span> whichcap, <span class="keywordtype">int</span> parameter, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ugeomfree, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflag, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pressure, <span class="keyword">struct</span> <a class="code" href="../../db/d3a/structof__newtonstats.html">of_newtonstats</a> *newtonstats, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflagrad);</div>
<div class="line"><a name="l02551"></a><span class="lineno"> 2551</span>&#160;  <span class="keywordtype">int</span> pl,pliter;</div>
<div class="line"><a name="l02552"></a><span class="lineno"> 2552</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Uo1[NPR], Uo2[NPR];</div>
<div class="line"><a name="l02553"></a><span class="lineno"> 2553</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ptest1[NPR],ptest2[NPR];</div>
<div class="line"><a name="l02554"></a><span class="lineno"> 2554</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Uo[NPR], po[NPR];</div>
<div class="line"><a name="l02555"></a><span class="lineno"> 2555</span>&#160;  <span class="keywordtype">int</span> test;</div>
<div class="line"><a name="l02556"></a><span class="lineno"> 2556</span>&#160;  <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> lpflag1,lpflag2;</div>
<div class="line"><a name="l02557"></a><span class="lineno"> 2557</span>&#160;  <span class="keywordtype">int</span> lntries1,lntries2;</div>
<div class="line"><a name="l02558"></a><span class="lineno"> 2558</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> lerrx1,lerrx2;</div>
<div class="line"><a name="l02559"></a><span class="lineno"> 2559</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> pressure1mem,pressure2mem;</div>
<div class="line"><a name="l02560"></a><span class="lineno"> 2560</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pressure1=&amp;pressure1mem,*pressure2=&amp;pressure2mem;</div>
<div class="line"><a name="l02561"></a><span class="lineno"> 2561</span>&#160;</div>
<div class="line"><a name="l02562"></a><span class="lineno"> 2562</span>&#160;  <span class="comment">// backup</span></div>
<div class="line"><a name="l02563"></a><span class="lineno"> 2563</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl){</div>
<div class="line"><a name="l02564"></a><span class="lineno"> 2564</span>&#160;    ptest1[pl]=ptest2[pl]=pr[pl];</div>
<div class="line"><a name="l02565"></a><span class="lineno"> 2565</span>&#160;    Uo1[pl]=Uo2[pl]=Ugeomfree[pl];</div>
<div class="line"><a name="l02566"></a><span class="lineno"> 2566</span>&#160;  }</div>
<div class="line"><a name="l02567"></a><span class="lineno"> 2567</span>&#160;</div>
<div class="line"><a name="l02568"></a><span class="lineno"> 2568</span>&#160;  <span class="comment">// currently comparing 5D1 and LDZ</span></div>
<div class="line"><a name="l02569"></a><span class="lineno"> 2569</span>&#160;  <span class="comment">//  Utoprimgen_pick(showmessages, allowlocalfailurefixandnoreport, UTOPRIM5D1, eomtype, whichcap, EVOLVENOENTROPY, Uo1, ptrgeom, lpflag, ptest1,newtonstats, lpflagrad);</span></div>
<div class="line"><a name="l02570"></a><span class="lineno"> 2570</span>&#160;  <span class="comment">//  Utoprimgen_pick(showmessages, allowlocalfailurefixandnoreport, UTOPRIMLDZ, eomtype, whichcap, EVOLVENOENTROPY, Uo2, ptrgeom, lpflag, ptest2,newtonstats, lpflagrad);</span></div>
<div class="line"><a name="l02571"></a><span class="lineno"> 2571</span>&#160;</div>
<div class="line"><a name="l02572"></a><span class="lineno"> 2572</span>&#160;  <span class="comment">// remove rest-mass</span></div>
<div class="line"><a name="l02573"></a><span class="lineno"> 2573</span>&#160;  Uo1[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]+=Uo1[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>];</div>
<div class="line"><a name="l02574"></a><span class="lineno"> 2574</span>&#160;  <a class="code" href="../../d1/d3e/utoprimgen_8c.html#a0a83e9e7fdd3cc595c5b8d0df88ec684" title="just picks the algorithm to invert">Utoprimgen_pick</a>(showmessages, allowlocalfailurefixandnoreport, UTOPRIMJONNONRELCOMPAT, eomtype, whichcap, EVOLVENOENTROPY, Uo1, ptrgeom, &amp;lpflag1, ptest1,pressure1,newtonstats,lpflagrad);</div>
<div class="line"><a name="l02575"></a><span class="lineno"> 2575</span>&#160;  lntries1=newtonstats-&gt;<a class="code" href="../../db/d3a/structof__newtonstats.html#a83280998e47831044a7e35299495a9bb">lntries</a>; newtonstats-&gt;<a class="code" href="../../db/d3a/structof__newtonstats.html#a83280998e47831044a7e35299495a9bb">lntries</a>=0; lerrx1=newtonstats-&gt;<a class="code" href="../../db/d3a/structof__newtonstats.html#a02529bef0a69373dc4e7e9e7a672d1db">lerrx</a>;</div>
<div class="line"><a name="l02576"></a><span class="lineno"> 2576</span>&#160;  <a class="code" href="../../d1/d3e/utoprimgen_8c.html#a0a83e9e7fdd3cc595c5b8d0df88ec684" title="just picks the algorithm to invert">Utoprimgen_pick</a>(showmessages, allowlocalfailurefixandnoreport, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a43bf3e0f38b75c684c6969028b848cda" title="6: SCN 2D final and optimized and recommended by Scott">UTOPRIM2DFINAL</a>, eomtype, whichcap, EVOLVENOENTROPY, Uo2, ptrgeom, &amp;lpflag2, ptest2,pressure2,newtonstats,lpflagrad);</div>
<div class="line"><a name="l02577"></a><span class="lineno"> 2577</span>&#160;  lntries2=newtonstats-&gt;<a class="code" href="../../db/d3a/structof__newtonstats.html#a83280998e47831044a7e35299495a9bb">lntries</a>; lerrx2=newtonstats-&gt;<a class="code" href="../../db/d3a/structof__newtonstats.html#a02529bef0a69373dc4e7e9e7a672d1db">lerrx</a>;</div>
<div class="line"><a name="l02578"></a><span class="lineno"> 2578</span>&#160;</div>
<div class="line"><a name="l02579"></a><span class="lineno"> 2579</span>&#160;<span class="preprocessor">#define ERRORCONST (1E-10)</span></div>
<div class="line"><a name="l02580"></a><span class="lineno"> 2580</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l02581"></a><span class="lineno"> 2581</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl){</div>
<div class="line"><a name="l02582"></a><span class="lineno"> 2582</span>&#160;    <span class="keywordflow">if</span>(ptest1[pl]!=0.0) test=fabs(ptest1[pl]-ptest2[pl])/ptest1[pl]&gt;<a class="code" href="../../d1/d3e/utoprimgen_8c.html#a577e35c436a5d051f7cb58ae8d418237">ERRORCONST</a>;</div>
<div class="line"><a name="l02583"></a><span class="lineno"> 2583</span>&#160;    <span class="keywordflow">else</span> test=(ptest1[pl]-ptest2[pl])&gt;ERRORCONST;</div>
<div class="line"><a name="l02584"></a><span class="lineno"> 2584</span>&#160;    <span class="keywordflow">if</span>(test){</div>
<div class="line"><a name="l02585"></a><span class="lineno"> 2585</span>&#160;      dualfprintf(fail_file,<span class="stringliteral">&quot;utoprimdiff: %d %ld :: %d %d %d :: %d ::  %21.15g   %21.15g   %21.15g %21.15g :: %d %d :: %21.15g %21.15g\n&quot;</span>,steppart,nstep,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[1]+ptrgeom-&gt;i,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[2]+ptrgeom-&gt;j,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[3]+ptrgeom-&gt;k,pl,ptest1[pl]-ptest2[pl],(ptest1[pl]!=0.0) ? fabs(ptest1[pl]-ptest2[pl])/ptest1[pl] : ptest1[pl]-ptest2[pl],ptest1[pl],ptest2[pl],lntries1,lntries2,lerrx1,lerrx2);</div>
<div class="line"><a name="l02586"></a><span class="lineno"> 2586</span>&#160;    }</div>
<div class="line"><a name="l02587"></a><span class="lineno"> 2587</span>&#160;  }</div>
<div class="line"><a name="l02588"></a><span class="lineno"> 2588</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0894a5e6c53e2e8a143d10be7a42d492">IFUTOPRIMFAIL</a>(lpflag1) || <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0894a5e6c53e2e8a143d10be7a42d492">IFUTOPRIMFAIL</a>(lpflag2)){</div>
<div class="line"><a name="l02589"></a><span class="lineno"> 2589</span>&#160;    dualfprintf(fail_file,<span class="stringliteral">&quot;%d %ld :: %d %d %d :: lpflag1=%d lpflag2=%d errx1=%21.15g errx2=%21.15g\n&quot;</span>,steppart,nstep,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[1]+ptrgeom-&gt;i,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[2]+ptrgeom-&gt;j,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[3]+ptrgeom-&gt;k,lpflag1,lpflag2,lerrx1,lerrx2);</div>
<div class="line"><a name="l02590"></a><span class="lineno"> 2590</span>&#160;  }</div>
<div class="line"><a name="l02591"></a><span class="lineno"> 2591</span>&#160;  <span class="keywordflow">if</span>(lntries1&gt;10 || lntries2&gt;10){</div>
<div class="line"><a name="l02592"></a><span class="lineno"> 2592</span>&#160;    dualfprintf(fail_file,<span class="stringliteral">&quot;%d %ld :: %d %d %d :: lpflag1=%d lpflag2=%d errx1=%21.15g errx2=%21.15g lntries1=%d lntries2=%d\n&quot;</span>,steppart,nstep,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[1]+ptrgeom-&gt;i,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[2]+ptrgeom-&gt;j,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[3]+ptrgeom-&gt;k,lpflag1,lpflag2,lerrx1,lerrx2,lntries1,lntries2);</div>
<div class="line"><a name="l02593"></a><span class="lineno"> 2593</span>&#160;  }</div>
<div class="line"><a name="l02594"></a><span class="lineno"> 2594</span>&#160;</div>
<div class="line"><a name="l02595"></a><span class="lineno"> 2595</span>&#160;  </div>
<div class="line"><a name="l02596"></a><span class="lineno"> 2596</span>&#160;  <span class="comment">// always do (use old utoprim)</span></div>
<div class="line"><a name="l02597"></a><span class="lineno"> 2597</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afaacb1c256e44ec7be2adaac65713f2b">IFUTOPRIMNOFAILORFIXED</a>(lpflag1)) <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl){</div>
<div class="line"><a name="l02598"></a><span class="lineno"> 2598</span>&#160;      pr[pl]=ptest1[pl];</div>
<div class="line"><a name="l02599"></a><span class="lineno"> 2599</span>&#160;      *lpflag=lpflag1;</div>
<div class="line"><a name="l02600"></a><span class="lineno"> 2600</span>&#160;    }</div>
<div class="line"><a name="l02601"></a><span class="lineno"> 2601</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l02602"></a><span class="lineno"> 2602</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl) pr[pl]=ptest2[pl];</div>
<div class="line"><a name="l02603"></a><span class="lineno"> 2603</span>&#160;    *lpflag=lpflag2;</div>
<div class="line"><a name="l02604"></a><span class="lineno"> 2604</span>&#160;  }</div>
<div class="line"><a name="l02605"></a><span class="lineno"> 2605</span>&#160;</div>
<div class="line"><a name="l02606"></a><span class="lineno"> 2606</span>&#160;  </div>
<div class="line"><a name="l02607"></a><span class="lineno"> 2607</span>&#160;</div>
<div class="line"><a name="l02608"></a><span class="lineno"> 2608</span>&#160;  return(0);</div>
<div class="line"><a name="l02609"></a><span class="lineno"> 2609</span>&#160;}</div>
<div class="line"><a name="l02610"></a><span class="lineno"> 2610</span>&#160;</div>
<div class="line"><a name="l02611"></a><span class="lineno"> 2611</span>&#160;</div>
<div class="line"><a name="l02612"></a><span class="lineno"> 2612</span>&#160;</div>
<div class="line"><a name="l02613"></a><span class="lineno"> 2613</span>&#160;</div>
<div class="line"><a name="l02615"></a><span class="lineno"><a class="code" href="../../d1/d3e/utoprimgen_8c.html#a0a83e9e7fdd3cc595c5b8d0df88ec684"> 2615</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="../../d1/d3e/utoprimgen_8c.html#a0a83e9e7fdd3cc595c5b8d0df88ec684" title="just picks the algorithm to invert">Utoprimgen_pick</a>(<span class="keywordtype">int</span> showmessages, <span class="keywordtype">int</span> allowlocalfailurefixandnoreport, <span class="keywordtype">int</span> which, <span class="keywordtype">int</span> eomtype, <span class="keywordtype">int</span> whichcap, <span class="keywordtype">int</span> parameter, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ugeomfree, struct <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflag, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pressure, struct <a class="code" href="../../db/d3a/structof__newtonstats.html">of_newtonstats</a> *newtonstats,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflagrad)</div>
<div class="line"><a name="l02616"></a><span class="lineno"> 2616</span>&#160;{</div>
<div class="line"><a name="l02617"></a><span class="lineno"> 2617</span>&#160;  <span class="keyword">extern</span> <span class="keywordtype">int</span> Utoprim_ffde(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *U, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *geom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr);</div>
<div class="line"><a name="l02618"></a><span class="lineno"> 2618</span>&#160;  <span class="keyword">extern</span> <span class="keywordtype">int</span> Utoprim_coldgrmhd(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *U, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *geom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr, <span class="keywordtype">int</span> *positivityproblem);</div>
<div class="line"><a name="l02619"></a><span class="lineno"> 2619</span>&#160;  <span class="keywordtype">int</span> positivityproblem;</div>
<div class="line"><a name="l02620"></a><span class="lineno"> 2620</span>&#160;  <span class="keywordtype">int</span> pliter,pl;</div>
<div class="line"><a name="l02621"></a><span class="lineno"> 2621</span>&#160;</div>
<div class="line"><a name="l02622"></a><span class="lineno"> 2622</span>&#160;</div>
<div class="line"><a name="l02623"></a><span class="lineno"> 2623</span>&#160;</div>
<div class="line"><a name="l02624"></a><span class="lineno"> 2624</span>&#160;  <span class="comment">//  FTYPE Ugeomfree0[NPR];</span></div>
<div class="line"><a name="l02625"></a><span class="lineno"> 2625</span>&#160;  <span class="comment">//  if(ptrgeom-&gt;i==10 &amp;&amp; ptrgeom-&gt;k==0){</span></div>
<div class="line"><a name="l02626"></a><span class="lineno"> 2626</span>&#160;  <span class="comment">//    PLOOP(pliter,pl) Ugeomfree0[pl]=Ugeomfree[pl];</span></div>
<div class="line"><a name="l02627"></a><span class="lineno"> 2627</span>&#160;  <span class="comment">//    PLOOP(pliter,pl) dualfprintf(fail_file,&quot;before inversion: pl=%d pr=%g\n&quot;,pl,pr[pl]);</span></div>
<div class="line"><a name="l02628"></a><span class="lineno"> 2628</span>&#160;  <span class="comment">//    if(pr[UU]&gt;0.1) dualfprintf(fail_file,&quot;beforeADEATHUU: ijk=%d %d %d u=%g %g (%g)\n&quot;,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,pr[UU],Ugeomfree[UU],Ugeomfree0[UU]);</span></div>
<div class="line"><a name="l02629"></a><span class="lineno"> 2629</span>&#160;  <span class="comment">//    if(fabs(pr[U1])&gt;1.0) dualfprintf(fail_file,&quot;beforeADEATHU1: ijk=%d %d %d u=%g %g (%g)\n&quot;,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,pr[U1],Ugeomfree[U1],Ugeomfree0[U1]);</span></div>
<div class="line"><a name="l02630"></a><span class="lineno"> 2630</span>&#160;  <span class="comment">//  }</span></div>
<div class="line"><a name="l02631"></a><span class="lineno"> 2631</span>&#160;</div>
<div class="line"><a name="l02632"></a><span class="lineno"> 2632</span>&#160;</div>
<div class="line"><a name="l02634"></a><span class="lineno"> 2634</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02635"></a><span class="lineno"> 2635</span>&#160;  <span class="comment">// do fluid inversion</span></div>
<div class="line"><a name="l02636"></a><span class="lineno"> 2636</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02638"></a><span class="lineno"> 2638</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02639"></a><span class="lineno"> 2639</span>&#160;  <span class="comment">// below is only one that uses parameter to choose whether entropy inversion or not</span></div>
<div class="line"><a name="l02640"></a><span class="lineno"> 2640</span>&#160;  <span class="keywordflow">if</span>(which==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#abd3dcef411a08060eddd9a17eeb655c5" title="#define FLUXB FLUXCTTOTH 0: HLL 1: FLUXCT TOTH version (toth 2000 eq.">UTOPRIM5D1</a>){      <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(Utoprim(parameter,Ugeomfree, ptrgeom, lpflag, pr,pressure,newtonstats),<span class="stringliteral">&quot;step_ch.c:Utoprimgen()&quot;</span>, <span class="stringliteral">&quot;Utoprim&quot;</span>, 1);}</div>
<div class="line"><a name="l02641"></a><span class="lineno"> 2641</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(which==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a5104c22f5a632989b8bac61d954e12d4" title="1: ldz method">UTOPRIMLDZ</a>){ <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(Utoprim_ldz(Ugeomfree, ptrgeom, lpflag, pr,pressure,newtonstats),<span class="stringliteral">&quot;step_ch.c:Utoprimgen()&quot;</span>, <span class="stringliteral">&quot;Utoprim_ldz&quot;</span>, 1);}</div>
<div class="line"><a name="l02642"></a><span class="lineno"> 2642</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(which==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a9b424b39cdd634868f2b3f15ffc1f49e" title="2: SCN 2D method">UTOPRIM2D</a>){ <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(Utoprim_2d(Ugeomfree, ptrgeom, lpflag, pr,pressure,newtonstats),<span class="stringliteral">&quot;step_ch.c:Utoprimgen()&quot;</span>, <span class="stringliteral">&quot;Utoprim_2d&quot;</span>, 1);}</div>
<div class="line"><a name="l02643"></a><span class="lineno"> 2643</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(which==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#adf0ad23f8bb8dab2153ef704fd38cc3b" title="3: SCN 1D method">UTOPRIM1D</a>){ <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(Utoprim_1d(Ugeomfree, ptrgeom, lpflag, pr,pressure,newtonstats),<span class="stringliteral">&quot;step_ch.c:Utoprimgen()&quot;</span>, <span class="stringliteral">&quot;Utoprim_1d&quot;</span>, 1);}</div>
<div class="line"><a name="l02644"></a><span class="lineno"> 2644</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(which==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a61f783dbf23b1bc1089000ea8b3d68d8" title="4: SCN 1D OPTIMIZED method  not sure if identical to 3 otherwise">UTOPRIM1DOPT</a>){ <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(Utoprim_1d_opt(Ugeomfree, ptrgeom, lpflag, pr,pressure,newtonstats),<span class="stringliteral">&quot;step_ch.c:Utoprimgen()&quot;</span>, <span class="stringliteral">&quot;Utoprim_1d_opt&quot;</span>, 1);}</div>
<div class="line"><a name="l02645"></a><span class="lineno"> 2645</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(which==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ac59550aa9bfa2dd022e036a3f29456d4" title="5: SCN 1D final and optimized">UTOPRIM1DFINAL</a>){ <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(Utoprim_1d_final(Ugeomfree, ptrgeom, lpflag, pr,pressure,newtonstats),<span class="stringliteral">&quot;step_ch.c:Utoprimgen()&quot;</span>, <span class="stringliteral">&quot;Utoprim_1d_final&quot;</span>, 1);}</div>
<div class="line"><a name="l02646"></a><span class="lineno"> 2646</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(which==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a43bf3e0f38b75c684c6969028b848cda" title="6: SCN 2D final and optimized and recommended by Scott">UTOPRIM2DFINAL</a>){ <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(Utoprim_2d_final(Ugeomfree, ptrgeom, lpflag, pr,pressure,newtonstats),<span class="stringliteral">&quot;step_ch.c:Utoprimgen()&quot;</span>, <span class="stringliteral">&quot;Utoprim_2d_final&quot;</span>, 1);}</div>
<div class="line"><a name="l02647"></a><span class="lineno"> 2647</span>&#160;  <span class="comment">// Below Jon&#39;s method handles full  hotMHD, entropy, and coldMHD via setting eomtype (doesn&#39;t use parameter)</span></div>
<div class="line"><a name="l02648"></a><span class="lineno"> 2648</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(which==UTOPRIMJONNONRELCOMPAT){ <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(<a class="code" href="../../d1/dde/utoprim__jon_8c.html#a2c450f7c2c86203afc48f0a40c665d38" title="The ONLY global function:">Utoprim_jon_nonrelcompat_inputnorestmass</a>(showmessages,eomtype,<a class="code" href="../../df/d1c/global_8storage_8h.html#a5dd5a282922755d8516bcbf69ccfa767">GLOBALMAC</a>(EOSextraglobal,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k),Ugeomfree, ptrgeom, lpflag, pr,pressure,newtonstats),<span class="stringliteral">&quot;step_ch.c:Utoprimgen()&quot;</span>, <span class="stringliteral">&quot;Utoprim_2d_final_nonrelcompat_inputnorestmass&quot;</span>, 1);}</div>
<div class="line"><a name="l02649"></a><span class="lineno"> 2649</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(which==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afea7bd5f3409b6d8d9a93f885fa6f9a1" title="7: SCN 5D final  bit less accurate compared to 1D and 2D">UTOPRIM5D2</a>){ <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(Utoprim_5d2_final(Ugeomfree, ptrgeom, lpflag, pr,pressure,newtonstats),<span class="stringliteral">&quot;step_ch.c:Utoprimgen()&quot;</span>, <span class="stringliteral">&quot;Utoprim_5d2_final&quot;</span>, 1);}</div>
<div class="line"><a name="l02650"></a><span class="lineno"> 2650</span>&#160;  <span class="comment">// alt (not really working) inversion for coldmhd (alt compared to UTOPRIMJONNONRELCOMPAT)</span></div>
<div class="line"><a name="l02651"></a><span class="lineno"> 2651</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(which==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a5476db60973dd9f75630aa333f00d41e" title="20: COLDGRMHD">UTOPRIMCOLDGRMHD</a>){ <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(Utoprim_coldgrmhd(Ugeomfree, ptrgeom, pr,&amp;positivityproblem),<span class="stringliteral">&quot;step_ch.c:Utoprimgen()&quot;</span>, <span class="stringliteral">&quot;Utoprim_ffde&quot;</span>, 1);}</div>
<div class="line"><a name="l02652"></a><span class="lineno"> 2652</span>&#160;  <span class="comment">// alt force-free inversion (alt compared to UTOPRIMJONNONRELCOMPAT)</span></div>
<div class="line"><a name="l02653"></a><span class="lineno"> 2653</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(which==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a77b486c84a084158707853a7ca173cfa" title="21: FFDE">UTOPRIMFFDE</a>){ <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(Utoprim_ffde(Ugeomfree, ptrgeom, pr),<span class="stringliteral">&quot;step_ch.c:Utoprimgen()&quot;</span>, <span class="stringliteral">&quot;Utoprim_ffde&quot;</span>, 1);}</div>
<div class="line"><a name="l02654"></a><span class="lineno"> 2654</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l02655"></a><span class="lineno"> 2655</span>&#160;    dualfprintf(fail_file,<span class="stringliteral">&quot;No such which=%d in Utoprimgen_pick()\n&quot;</span>);</div>
<div class="line"><a name="l02656"></a><span class="lineno"> 2656</span>&#160;    myexit(1769384215);</div>
<div class="line"><a name="l02657"></a><span class="lineno"> 2657</span>&#160;  }</div>
<div class="line"><a name="l02658"></a><span class="lineno"> 2658</span>&#160;</div>
<div class="line"><a name="l02659"></a><span class="lineno"> 2659</span>&#160;</div>
<div class="line"><a name="l02660"></a><span class="lineno"> 2660</span>&#160;  <span class="comment">//  if(ptrgeom-&gt;i==10 &amp;&amp; ptrgeom-&gt;k==0){</span></div>
<div class="line"><a name="l02661"></a><span class="lineno"> 2661</span>&#160;  <span class="comment">//    PLOOP(pliter,pl) dualfprintf(fail_file,&quot;after inversion: pl=%d pr=%g\n&quot;,pl,pr[pl]);</span></div>
<div class="line"><a name="l02662"></a><span class="lineno"> 2662</span>&#160;  <span class="comment">//    if(pr[UU]&gt;0.1) dualfprintf(fail_file,&quot;ADEATHUU: ijk=%d %d %d u=%g %g (%g)\n&quot;,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,pr[UU],Ugeomfree[UU],Ugeomfree0[UU]);</span></div>
<div class="line"><a name="l02663"></a><span class="lineno"> 2663</span>&#160;  <span class="comment">//    if(fabs(pr[U1])&gt;1.0) dualfprintf(fail_file,&quot;ADEATHU1: ijk=%d %d %d u=%g %g (%g)\n&quot;,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,pr[U1],Ugeomfree[U1],Ugeomfree0[U1]);</span></div>
<div class="line"><a name="l02664"></a><span class="lineno"> 2664</span>&#160;  <span class="comment">//  }</span></div>
<div class="line"><a name="l02665"></a><span class="lineno"> 2665</span>&#160;</div>
<div class="line"><a name="l02667"></a><span class="lineno"> 2667</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02668"></a><span class="lineno"> 2668</span>&#160;  <span class="comment">// now do other non-fluid inversions</span></div>
<div class="line"><a name="l02669"></a><span class="lineno"> 2669</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02671"></a><span class="lineno"> 2671</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02672"></a><span class="lineno"> 2672</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#a99ba7daf58b283bc831b8f507f5873a4" title="#define EOMTYPE EOMCOLDGRMHD">EOMRADTYPE</a>!=<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a993e29ef4139116d822d89bccb92180d" title="radiation equations of motion">EOMRADNONE</a>){</div>
<div class="line"><a name="l02673"></a><span class="lineno"> 2673</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#a91d326fce95a4bd868862debcbf1bec0">ENFORCEMHDCONS2RADCONS</a>==1){</div>
<div class="line"><a name="l02674"></a><span class="lineno"> 2674</span>&#160;      <span class="comment">// KORAL</span></div>
<div class="line"><a name="l02675"></a><span class="lineno"> 2675</span>&#160;      <span class="comment">// NOTEMARK: u2p_rad() uses pr, which will have updated velocities in case radiation inversion wants to use fluid frame reduction.  But need to know if got good solution, so pass that flag to u2p_rad()</span></div>
<div class="line"><a name="l02676"></a><span class="lineno"> 2676</span>&#160;</div>
<div class="line"><a name="l02677"></a><span class="lineno"> 2677</span>&#160;      <span class="comment">// get MHD state</span></div>
<div class="line"><a name="l02678"></a><span class="lineno"> 2678</span>&#160;      <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> q;</div>
<div class="line"><a name="l02679"></a><span class="lineno"> 2679</span>&#160;      <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a3c69b676adf3024cd6ae832094d91fab" title="find ucon, ucov, bcon, bcov from primitive variables when calling get_state, users of this function e...">get_state_norad_part1</a>(pr, ptrgeom, &amp;q);</div>
<div class="line"><a name="l02680"></a><span class="lineno"> 2680</span>&#160;      <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#aae6a7d24b984236dae44b1a3e8ee37b6" title="find ucon, ucov, bcon, bcov from primitive variables when calling get_state, users of this function e...">get_state_norad_part2</a>(1, pr, ptrgeom, &amp;q); <span class="comment">// where entropy would be computed</span></div>
<div class="line"><a name="l02681"></a><span class="lineno"> 2681</span>&#160;</div>
<div class="line"><a name="l02682"></a><span class="lineno"> 2682</span>&#160;      <span class="comment">// get accurate UMHD[pmhd] to avoid inversion inaccuracies for MHD inversion part</span></div>
<div class="line"><a name="l02683"></a><span class="lineno"> 2683</span>&#160;      <span class="keyword">extern</span> <span class="keywordtype">int</span> <a class="code" href="../../d7/def/phys_8tools_8c.html#ad54ad99ee062beaf43518d6e9afae0a7">primtoflux_nonradonly</a>(<span class="keywordtype">int</span> needentropy, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *q, <span class="keywordtype">int</span> dir, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *geom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *flux, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *fluxabs);</div>
<div class="line"><a name="l02684"></a><span class="lineno"> 2684</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> uumhd[NPR],uumhdabs[NPR];</div>
<div class="line"><a name="l02685"></a><span class="lineno"> 2685</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) uumhd[pl] = Ugeomfree[pl];</div>
<div class="line"><a name="l02686"></a><span class="lineno"> 2686</span>&#160;      <a class="code" href="../../d7/def/phys_8tools_8c.html#ad54ad99ee062beaf43518d6e9afae0a7">primtoflux_nonradonly</a>(1,pr,&amp;q,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>,ptrgeom, uumhd, uumhdabs); <span class="comment">// anything not set is set as zero, which is rad.</span></div>
<div class="line"><a name="l02687"></a><span class="lineno"> 2687</span>&#160;</div>
<div class="line"><a name="l02688"></a><span class="lineno"> 2688</span>&#160;      <span class="comment">// enforce conservation even if inaccuracy in MHD inversion</span></div>
<div class="line"><a name="l02689"></a><span class="lineno"> 2689</span>&#160;      <span class="keywordtype">int</span> iv;</div>
<div class="line"><a name="l02690"></a><span class="lineno"> 2690</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(iv) uumhd[URAD0+iv] = Ugeomfree[URAD0+iv] - (uumhd[UU+iv]-Ugeomfree[UU+iv]);</div>
<div class="line"><a name="l02691"></a><span class="lineno"> 2691</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) Ugeomfree[pl] = uumhd[pl];</div>
<div class="line"><a name="l02692"></a><span class="lineno"> 2692</span>&#160;</div>
<div class="line"><a name="l02693"></a><span class="lineno"> 2693</span>&#160;      <a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#a9fe58e7f372421d18633c8fc5007b815">u2p_rad</a>(showmessages, allowlocalfailurefixandnoreport, <a class="code" href="../../d8/d5b/defs_8general_8h.html#a51ef12e4cafc4a8fe70374c37f57d565">GAMMAMAXRAD</a>, whichcap, Ugeomfree,pr,ptrgeom,lpflag,lpflagrad);</div>
<div class="line"><a name="l02694"></a><span class="lineno"> 2694</span>&#160;      <span class="comment">//*lpflagrad=0; // test that check_on_inversion triggered where velocity limiter applies</span></div>
<div class="line"><a name="l02695"></a><span class="lineno"> 2695</span>&#160;</div>
<div class="line"><a name="l02696"></a><span class="lineno"> 2696</span>&#160;</div>
<div class="line"><a name="l02697"></a><span class="lineno"> 2697</span>&#160;      <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a07847bede2b7ba9d0aabaea82f17f989" title="find ucon, ucov, bcon, bcov from primitive variables when calling get_state, users of this function e...">get_state_radonly</a>(pr, ptrgeom, &amp;q);</div>
<div class="line"><a name="l02698"></a><span class="lineno"> 2698</span>&#160;</div>
<div class="line"><a name="l02699"></a><span class="lineno"> 2699</span>&#160;      <span class="keyword">extern</span> <span class="keywordtype">int</span> <a class="code" href="../../d7/def/phys_8tools_8c.html#a764e6f682011d16faec0f9b71eb360d2">primtoflux_radonly</a>(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *q, <span class="keywordtype">int</span> dir, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *geom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *flux, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *fluxabs);</div>
<div class="line"><a name="l02700"></a><span class="lineno"> 2700</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> uurad[NPR],uuradabs[NPR];</div>
<div class="line"><a name="l02701"></a><span class="lineno"> 2701</span>&#160;      <a class="code" href="../../d7/def/phys_8tools_8c.html#a764e6f682011d16faec0f9b71eb360d2">primtoflux_radonly</a>(pr,&amp;q,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>,ptrgeom, uurad,uuradabs); <span class="comment">// all non-rad stuff is set to zero.</span></div>
<div class="line"><a name="l02702"></a><span class="lineno"> 2702</span>&#160;      <span class="comment">// write new uurad&#39;s to uu</span></div>
<div class="line"><a name="l02703"></a><span class="lineno"> 2703</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) <span class="keywordflow">if</span>(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a43791f6c1915cf7bfe3a02a4502510e4">RADFULLPL</a>(pl)) Ugeomfree[pl]=uurad[pl];</div>
<div class="line"><a name="l02704"></a><span class="lineno"> 2704</span>&#160;    }</div>
<div class="line"><a name="l02705"></a><span class="lineno"> 2705</span>&#160;    <span class="keywordflow">else</span>{<span class="comment">// required method when pmhd&gt;&gt;prad and small errors in pmhd swamp rad</span></div>
<div class="line"><a name="l02706"></a><span class="lineno"> 2706</span>&#160;      <a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#a9fe58e7f372421d18633c8fc5007b815">u2p_rad</a>(showmessages, allowlocalfailurefixandnoreport, <a class="code" href="../../d8/d5b/defs_8general_8h.html#a51ef12e4cafc4a8fe70374c37f57d565">GAMMAMAXRAD</a>, whichcap, Ugeomfree,pr,ptrgeom,lpflag,lpflagrad);</div>
<div class="line"><a name="l02707"></a><span class="lineno"> 2707</span>&#160;    }</div>
<div class="line"><a name="l02708"></a><span class="lineno"> 2708</span>&#160;  }</div>
<div class="line"><a name="l02709"></a><span class="lineno"> 2709</span>&#160;</div>
<div class="line"><a name="l02710"></a><span class="lineno"> 2710</span>&#160;  <span class="comment">//  if(ptrgeom-&gt;i==10 &amp;&amp; ptrgeom-&gt;k==0){</span></div>
<div class="line"><a name="l02711"></a><span class="lineno"> 2711</span>&#160;  <span class="comment">//    PLOOP(pliter,pl) dualfprintf(fail_file,&quot;after rad inversion: pl=%d pr=%g\n&quot;,pl,pr[pl]);</span></div>
<div class="line"><a name="l02712"></a><span class="lineno"> 2712</span>&#160;  <span class="comment">//    if(pr[UU]&gt;0.1) dualfprintf(fail_file,&quot;BDEATHUU: ijk=%d %d %d u=%g %g (%g)\n&quot;,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,pr[UU],Ugeomfree[UU],Ugeomfree0[UU]);</span></div>
<div class="line"><a name="l02713"></a><span class="lineno"> 2713</span>&#160;  <span class="comment">//    if(fabs(pr[U1])&gt;1.0) dualfprintf(fail_file,&quot;BDEATHU1: ijk=%d %d %d u=%g %g\n&quot;,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,pr[U1],Ugeomfree[U1],Ugeomfree0[U1]);</span></div>
<div class="line"><a name="l02714"></a><span class="lineno"> 2714</span>&#160;  <span class="comment">//  }</span></div>
<div class="line"><a name="l02715"></a><span class="lineno"> 2715</span>&#160;  </div>
<div class="line"><a name="l02716"></a><span class="lineno"> 2716</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l02717"></a><span class="lineno"> 2717</span>&#160;}</div>
<div class="line"><a name="l02718"></a><span class="lineno"> 2718</span>&#160;</div>
<div class="line"><a name="l02719"></a><span class="lineno"> 2719</span>&#160;</div>
<div class="line"><a name="l02720"></a><span class="lineno"> 2720</span>&#160;</div>
<div class="line"><a name="l02721"></a><span class="lineno"> 2721</span>&#160;</div>
<div class="line"><a name="l02723"></a><span class="lineno"> 2723</span>&#160;<span class="keywordtype">int</span> Utoprimgen_tryagain(<span class="keywordtype">int</span> showmessages, <span class="keywordtype">int</span> allowlocalfailurefixandnoreport, <span class="keywordtype">int</span> eomtype, <span class="keywordtype">int</span> whichcap, <span class="keywordtype">int</span> parameter, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ugeomfree0, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ugeomfree,<span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflag, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr0, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pressure, <span class="keyword">struct</span> <a class="code" href="../../db/d3a/structof__newtonstats.html">of_newtonstats</a> *newtonstats, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflagrad)</div>
<div class="line"><a name="l02724"></a><span class="lineno"> 2724</span>&#160;{</div>
<div class="line"><a name="l02725"></a><span class="lineno"> 2725</span>&#160;  <span class="keywordtype">int</span> Utoprimgen_tryagain_substep(<span class="keywordtype">int</span> showmessages, <span class="keywordtype">int</span> allowlocalfailurefixandnoreport, <span class="keywordtype">int</span> which, <span class="keywordtype">int</span> eomtype, <span class="keywordtype">int</span> whichcap, <span class="keywordtype">int</span> parameter, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ugeomfree0, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a>*Ugeomfree, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflag, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr0, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pressure, <span class="keyword">struct</span> <a class="code" href="../../db/d3a/structof__newtonstats.html">of_newtonstats</a> *newtonstats, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflagrad);</div>
<div class="line"><a name="l02726"></a><span class="lineno"> 2726</span>&#160;</div>
<div class="line"><a name="l02727"></a><span class="lineno"> 2727</span>&#160;  Utoprimgen_tryagain_substep(showmessages, allowlocalfailurefixandnoreport, UTOPRIMJONNONRELCOMPAT, eomtype, whichcap, parameter, Ugeomfree0, Ugeomfree, ptrgeom, lpflag, pr0, pr,pressure,newtonstats,lpflagrad);</div>
<div class="line"><a name="l02728"></a><span class="lineno"> 2728</span>&#160;  Utoprimgen_tryagain_substep(showmessages, allowlocalfailurefixandnoreport, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a43bf3e0f38b75c684c6969028b848cda" title="6: SCN 2D final and optimized and recommended by Scott">UTOPRIM2DFINAL</a>, eomtype, whichcap, parameter, Ugeomfree0, Ugeomfree, ptrgeom, lpflag, pr0, pr,pressure,newtonstats,lpflagrad);</div>
<div class="line"><a name="l02729"></a><span class="lineno"> 2729</span>&#160;  <span class="comment">// can&#39;t trust below really (causes some kind of superslow-down when doing torus problem with  MCSTEEP)</span></div>
<div class="line"><a name="l02730"></a><span class="lineno"> 2730</span>&#160;  <span class="comment">//  Utoprimgen_tryagain_substep(showmessages, allowlocalfailurefixandnoreport, UTOPRIM5D1, eomtype, whichcap, parameter, Ugeomfree0, Ugeomfree, ptrgeom, lpflag, pr0, pr,pressure,newtonstats,lpflagrad);</span></div>
<div class="line"><a name="l02731"></a><span class="lineno"> 2731</span>&#160;  <span class="comment">// LDZ as normally used generates nan&#39;s</span></div>
<div class="line"><a name="l02732"></a><span class="lineno"> 2732</span>&#160;  <span class="comment">//  Utoprimgen_tryagain_substep(showmessages, allowlocalfailurefixandnoreport, UTOPRIMLDZ, eomtype, whichcap, parameter, Ugeomfree0, Ugeomfree, ptrgeom, lpflag, pr0, pr,pressure,newtonstats,lpflagrad);</span></div>
<div class="line"><a name="l02733"></a><span class="lineno"> 2733</span>&#160;  Utoprimgen_tryagain_substep(showmessages, allowlocalfailurefixandnoreport, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ac59550aa9bfa2dd022e036a3f29456d4" title="5: SCN 1D final and optimized">UTOPRIM1DFINAL</a>, eomtype, whichcap, parameter, Ugeomfree0, Ugeomfree, ptrgeom, lpflag, pr0, pr,pressure,newtonstats,lpflagrad);</div>
<div class="line"><a name="l02734"></a><span class="lineno"> 2734</span>&#160;  Utoprimgen_tryagain_substep(showmessages, allowlocalfailurefixandnoreport, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a61f783dbf23b1bc1089000ea8b3d68d8" title="4: SCN 1D OPTIMIZED method  not sure if identical to 3 otherwise">UTOPRIM1DOPT</a>, eomtype, whichcap, parameter, Ugeomfree0, Ugeomfree, ptrgeom, lpflag, pr0, pr,pressure,newtonstats,lpflagrad);</div>
<div class="line"><a name="l02735"></a><span class="lineno"> 2735</span>&#160;  Utoprimgen_tryagain_substep(showmessages, allowlocalfailurefixandnoreport, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afea7bd5f3409b6d8d9a93f885fa6f9a1" title="7: SCN 5D final  bit less accurate compared to 1D and 2D">UTOPRIM5D2</a>, eomtype, whichcap, parameter, Ugeomfree0, Ugeomfree, ptrgeom, lpflag, pr0, pr,pressure,newtonstats,lpflagrad);</div>
<div class="line"><a name="l02736"></a><span class="lineno"> 2736</span>&#160;  Utoprimgen_tryagain_substep(showmessages, allowlocalfailurefixandnoreport, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a9b424b39cdd634868f2b3f15ffc1f49e" title="2: SCN 2D method">UTOPRIM2D</a>, eomtype, whichcap, parameter, Ugeomfree0, Ugeomfree, ptrgeom, lpflag, pr0, pr,pressure,newtonstats,lpflagrad);</div>
<div class="line"><a name="l02737"></a><span class="lineno"> 2737</span>&#160;  Utoprimgen_tryagain_substep(showmessages, allowlocalfailurefixandnoreport, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#adf0ad23f8bb8dab2153ef704fd38cc3b" title="3: SCN 1D method">UTOPRIM1D</a>, eomtype, whichcap, parameter, Ugeomfree0, Ugeomfree, ptrgeom, lpflag, pr0, pr,pressure,newtonstats,lpflagrad);</div>
<div class="line"><a name="l02738"></a><span class="lineno"> 2738</span>&#160;</div>
<div class="line"><a name="l02739"></a><span class="lineno"> 2739</span>&#160;  <span class="comment">// don&#39;t restore in the end, leave to whatever state inversion leaves it in.</span></div>
<div class="line"><a name="l02740"></a><span class="lineno"> 2740</span>&#160;</div>
<div class="line"><a name="l02741"></a><span class="lineno"> 2741</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l02742"></a><span class="lineno"> 2742</span>&#160;</div>
<div class="line"><a name="l02743"></a><span class="lineno"> 2743</span>&#160;}</div>
<div class="line"><a name="l02744"></a><span class="lineno"> 2744</span>&#160;</div>
<div class="line"><a name="l02745"></a><span class="lineno"> 2745</span>&#160;</div>
<div class="line"><a name="l02748"></a><span class="lineno"> 2748</span>&#160;<span class="keywordtype">int</span> Utoprimgen_tryagain2(<span class="keywordtype">int</span> showmessages, <span class="keywordtype">int</span> allowlocalfailurefixandnoreport, <span class="keywordtype">int</span> eomtype, <span class="keywordtype">int</span> whichcap, <span class="keywordtype">int</span> parameter, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ugeomfree0, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ugeomfree,<span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflag, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr0, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pressure, <span class="keyword">struct</span> <a class="code" href="../../db/d3a/structof__newtonstats.html">of_newtonstats</a> *newtonstats, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflagrad)</div>
<div class="line"><a name="l02749"></a><span class="lineno"> 2749</span>&#160;{</div>
<div class="line"><a name="l02750"></a><span class="lineno"> 2750</span>&#160;  <span class="keywordtype">int</span> Utoprimgen_tryagain_substep(<span class="keywordtype">int</span> showmessages, <span class="keywordtype">int</span> allowlocalfailurefixandnoreport, <span class="keywordtype">int</span> which, <span class="keywordtype">int</span> eomtype, <span class="keywordtype">int</span> whichcap, <span class="keywordtype">int</span> parameter, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ugeomfree0, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a>*Ugeomfree, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflag, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr0, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pressure, <span class="keyword">struct</span> <a class="code" href="../../db/d3a/structof__newtonstats.html">of_newtonstats</a> *newtonstats, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflagrad);</div>
<div class="line"><a name="l02751"></a><span class="lineno"> 2751</span>&#160;  <span class="keywordtype">void</span> convert_U_removerestmassfromuu(<span class="keywordtype">int</span> utoprimverison, <span class="keywordtype">int</span> removerestmassfromuu, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *U);</div>
<div class="line"><a name="l02752"></a><span class="lineno"> 2752</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Uorig0[NPR],Uorig[NPR];</div>
<div class="line"><a name="l02753"></a><span class="lineno"> 2753</span>&#160;  <span class="keywordtype">int</span> pl,pliter;</div>
<div class="line"><a name="l02754"></a><span class="lineno"> 2754</span>&#160;</div>
<div class="line"><a name="l02755"></a><span class="lineno"> 2755</span>&#160;</div>
<div class="line"><a name="l02756"></a><span class="lineno"> 2756</span>&#160;  Utoprimgen_tryagain_substep(showmessages, allowlocalfailurefixandnoreport, UTOPRIMJONNONRELCOMPAT, eomtype, whichcap, parameter, Ugeomfree0, Ugeomfree, ptrgeom, lpflag, pr0, pr,pressure,newtonstats,lpflagrad);</div>
<div class="line"><a name="l02757"></a><span class="lineno"> 2757</span>&#160;  Utoprimgen_tryagain_substep(showmessages, allowlocalfailurefixandnoreport, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#abd3dcef411a08060eddd9a17eeb655c5" title="#define FLUXB FLUXCTTOTH 0: HLL 1: FLUXCT TOTH version (toth 2000 eq.">UTOPRIM5D1</a>, eomtype, whichcap, parameter, Ugeomfree0, Ugeomfree, ptrgeom, lpflag, pr0, pr,pressure,newtonstats,lpflagrad);</div>
<div class="line"><a name="l02758"></a><span class="lineno"> 2758</span>&#160;</div>
<div class="line"><a name="l02759"></a><span class="lineno"> 2759</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl){</div>
<div class="line"><a name="l02760"></a><span class="lineno"> 2760</span>&#160;    Uorig0[pl]=Ugeomfree0[pl];</div>
<div class="line"><a name="l02761"></a><span class="lineno"> 2761</span>&#160;    Uorig[pl]=Ugeomfree[pl];</div>
<div class="line"><a name="l02762"></a><span class="lineno"> 2762</span>&#160;  }</div>
<div class="line"><a name="l02763"></a><span class="lineno"> 2763</span>&#160;  <span class="comment">// assume at this point that U is such that setup for REMOVERESTMASSFROMUU==2 so that UU has rest-mass subtracted.</span></div>
<div class="line"><a name="l02764"></a><span class="lineno"> 2764</span>&#160;  <span class="comment">// so need to add it back in for 2D FINAL method</span></div>
<div class="line"><a name="l02765"></a><span class="lineno"> 2765</span>&#160;  <span class="comment">// convert U into form appropriate for inversion routine </span></div>
<div class="line"><a name="l02766"></a><span class="lineno"> 2766</span>&#160;  convert_U_removerestmassfromuu(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a43bf3e0f38b75c684c6969028b848cda" title="6: SCN 2D final and optimized and recommended by Scott">UTOPRIM2DFINAL</a>,<a class="code" href="../../da/d3e/definit_8h.html#af48e1348f10b3468e425c084365f5e64" title="which velocity to compute in (init can be anything (see init.c&#39;s for transformations)">REMOVERESTMASSFROMUU</a>,Uorig);</div>
<div class="line"><a name="l02767"></a><span class="lineno"> 2767</span>&#160;  convert_U_removerestmassfromuu(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a43bf3e0f38b75c684c6969028b848cda" title="6: SCN 2D final and optimized and recommended by Scott">UTOPRIM2DFINAL</a>,<a class="code" href="../../da/d3e/definit_8h.html#af48e1348f10b3468e425c084365f5e64" title="which velocity to compute in (init can be anything (see init.c&#39;s for transformations)">REMOVERESTMASSFROMUU</a>,Uorig0);</div>
<div class="line"><a name="l02768"></a><span class="lineno"> 2768</span>&#160;  <span class="comment">// now in form usable by UTOPRIM2DFINAL</span></div>
<div class="line"><a name="l02769"></a><span class="lineno"> 2769</span>&#160;  Utoprimgen_tryagain_substep(showmessages, allowlocalfailurefixandnoreport, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a43bf3e0f38b75c684c6969028b848cda" title="6: SCN 2D final and optimized and recommended by Scott">UTOPRIM2DFINAL</a>, eomtype, whichcap, parameter, Uorig0, Uorig, ptrgeom, lpflag, pr0, pr,pressure,newtonstats,lpflagrad);</div>
<div class="line"><a name="l02770"></a><span class="lineno"> 2770</span>&#160;</div>
<div class="line"><a name="l02771"></a><span class="lineno"> 2771</span>&#160;</div>
<div class="line"><a name="l02772"></a><span class="lineno"> 2772</span>&#160;  <span class="comment">// don&#39;t restore in the end, leave to whatever state inversion leaves it in.</span></div>
<div class="line"><a name="l02773"></a><span class="lineno"> 2773</span>&#160;</div>
<div class="line"><a name="l02774"></a><span class="lineno"> 2774</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l02775"></a><span class="lineno"> 2775</span>&#160;</div>
<div class="line"><a name="l02776"></a><span class="lineno"> 2776</span>&#160;}</div>
<div class="line"><a name="l02777"></a><span class="lineno"> 2777</span>&#160;</div>
<div class="line"><a name="l02778"></a><span class="lineno"> 2778</span>&#160;</div>
<div class="line"><a name="l02779"></a><span class="lineno"> 2779</span>&#160;</div>
<div class="line"><a name="l02780"></a><span class="lineno"> 2780</span>&#160;</div>
<div class="line"><a name="l02781"></a><span class="lineno"> 2781</span>&#160;</div>
<div class="line"><a name="l02783"></a><span class="lineno"> 2783</span>&#160;<span class="keywordtype">int</span> Utoprimgen_tryagain_substep(<span class="keywordtype">int</span> showmessages, <span class="keywordtype">int</span> allowlocalfailurefixandnoreport, <span class="keywordtype">int</span> which, <span class="keywordtype">int</span> eomtype, <span class="keywordtype">int</span> whichcap, <span class="keywordtype">int</span> parameter, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ugeomfree0, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a>*Ugeomfree, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflag, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr0, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pressure, <span class="keyword">struct</span> <a class="code" href="../../db/d3a/structof__newtonstats.html">of_newtonstats</a> *newtonstats, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflagrad)</div>
<div class="line"><a name="l02784"></a><span class="lineno"> 2784</span>&#160;{</div>
<div class="line"><a name="l02785"></a><span class="lineno"> 2785</span>&#160;  <span class="keywordtype">int</span> pl;</div>
<div class="line"><a name="l02786"></a><span class="lineno"> 2786</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d1/d3e/utoprimgen_8c.html#a0a83e9e7fdd3cc595c5b8d0df88ec684" title="just picks the algorithm to invert">Utoprimgen_pick</a>(<span class="keywordtype">int</span> showmessages, <span class="keywordtype">int</span> allowlocalfailurefixandnoreport, <span class="keywordtype">int</span> which, <span class="keywordtype">int</span> eomtype, <span class="keywordtype">int</span> whichcap, <span class="keywordtype">int</span> parameter, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ugeomfree, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflag, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pressure, <span class="keyword">struct</span> <a class="code" href="../../db/d3a/structof__newtonstats.html">of_newtonstats</a> *newtonstats, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflagrad);</div>
<div class="line"><a name="l02787"></a><span class="lineno"> 2787</span>&#160;</div>
<div class="line"><a name="l02788"></a><span class="lineno"> 2788</span>&#160;  <span class="comment">// if really a bad failure that don&#39;t want / can&#39;t handle, then try again</span></div>
<div class="line"><a name="l02789"></a><span class="lineno"> 2789</span>&#160;  <span class="keywordflow">if</span>(</div>
<div class="line"><a name="l02790"></a><span class="lineno"> 2790</span>&#160;     (<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0894a5e6c53e2e8a143d10be7a42d492">IFUTOPRIMFAIL</a>(*lpflag))</div>
<div class="line"><a name="l02791"></a><span class="lineno"> 2791</span>&#160;     &amp;&amp;(!((<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ac530de9aaf5536f3b22423a77cc9c391">IFUTOPRIMFAILSOFTNOTRHORELATED</a>(*lpflag))&amp;&amp;(<a class="code" href="../../da/d3e/definit_8h.html#a01d34fa922c4eaac94e27f2179523626" title="whether to allow negative internal energy in substep UTOPRIMFAILRETURNTYPE==UTOPRIMRETURNADJUSTED sho...">STEPOVERNEGU</a>)))</div>
<div class="line"><a name="l02792"></a><span class="lineno"> 2792</span>&#160;     &amp;&amp;(!((*lpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ad5bd994b947d2a46102582b38e4b1529">UTOPRIMFAILRHONEG</a>)&amp;&amp;(<a class="code" href="../../da/d3e/definit_8h.html#a23eeede57657104811b4f7e5e7dda656" title="seems to make things worse (more failures, but also worse failures)">STEPOVERNEGRHO</a>)))</div>
<div class="line"><a name="l02793"></a><span class="lineno"> 2793</span>&#160;     &amp;&amp;(!((*lpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a24290f84c3e2b725f7cbbdff81da4760">UTOPRIMFAILRHOUNEG</a>)&amp;&amp;(<a class="code" href="../../d8/dc0/init_8h.html#a352ef6d348d5c3986dc77165755b8733">STEPOVERNEGRHOU</a>)))</div>
<div class="line"><a name="l02794"></a><span class="lineno"> 2794</span>&#160;     ){</div>
<div class="line"><a name="l02795"></a><span class="lineno"> 2795</span>&#160;    <span class="comment">// restore</span></div>
<div class="line"><a name="l02796"></a><span class="lineno"> 2796</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl){</div>
<div class="line"><a name="l02797"></a><span class="lineno"> 2797</span>&#160;      Ugeomfree[pl]=Ugeomfree0[pl];</div>
<div class="line"><a name="l02798"></a><span class="lineno"> 2798</span>&#160;      pr[pl]=pr0[pl];</div>
<div class="line"><a name="l02799"></a><span class="lineno"> 2799</span>&#160;    }</div>
<div class="line"><a name="l02800"></a><span class="lineno"> 2800</span>&#160;    <span class="comment">// try again</span></div>
<div class="line"><a name="l02801"></a><span class="lineno"> 2801</span>&#160;    <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(<a class="code" href="../../d1/d3e/utoprimgen_8c.html#a0a83e9e7fdd3cc595c5b8d0df88ec684" title="just picks the algorithm to invert">Utoprimgen_pick</a>(showmessages, allowlocalfailurefixandnoreport, which,eomtype, whichcap,parameter,Ugeomfree, ptrgeom, lpflag, pr,pressure,newtonstats,lpflagrad),<span class="stringliteral">&quot;step_ch.c:Utoprimgen_tryagain_substep()&quot;</span>, <span class="stringliteral">&quot;Utoprimgen_pick&quot;</span>, 1);</div>
<div class="line"><a name="l02802"></a><span class="lineno"> 2802</span>&#160;  }</div>
<div class="line"><a name="l02803"></a><span class="lineno"> 2803</span>&#160;</div>
<div class="line"><a name="l02804"></a><span class="lineno"> 2804</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l02805"></a><span class="lineno"> 2805</span>&#160;}</div>
<div class="line"><a name="l02806"></a><span class="lineno"> 2806</span>&#160;</div>
<div class="line"><a name="l02807"></a><span class="lineno"> 2807</span>&#160;</div>
<div class="line"><a name="l02808"></a><span class="lineno"> 2808</span>&#160;</div>
<div class="line"><a name="l02809"></a><span class="lineno"> 2809</span>&#160;</div>
<div class="line"><a name="l02812"></a><span class="lineno"><a class="code" href="../../db/dc8/utoprimgen_8funcdeclare_8h.html#a8db9dc7c7f52d6fcb405a74e519db5cf"> 2812</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="../../d1/d3e/utoprimgen_8c.html#a1986bb1d8ba8daf8c30863f647fb583e" title="there may be something wrong with this function  didn&#39;t work in TIMEORDER==4, had to do standard met...">Utoprimloop</a>(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*U)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*prim)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR], <span class="keyword">struct</span> <a class="code" href="../../db/d3a/structof__newtonstats.html">of_newtonstats</a> *newtonstats)</div>
<div class="line"><a name="l02813"></a><span class="lineno"> 2813</span>&#160;{</div>
<div class="line"><a name="l02814"></a><span class="lineno"> 2814</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> geomdontuse;</div>
<div class="line"><a name="l02815"></a><span class="lineno"> 2815</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom=&amp;geomdontuse;</div>
<div class="line"><a name="l02816"></a><span class="lineno"> 2816</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>,<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>,k;</div>
<div class="line"><a name="l02817"></a><span class="lineno"> 2817</span>&#160;  <span class="keywordtype">int</span> showmessages=1;</div>
<div class="line"><a name="l02818"></a><span class="lineno"> 2818</span>&#160;  <span class="keywordtype">int</span> allowlocalfailurefixandnoreport=1;</div>
<div class="line"><a name="l02819"></a><span class="lineno"> 2819</span>&#160;</div>
<div class="line"><a name="l02820"></a><span class="lineno"> 2820</span>&#160;  <a class="code" href="../../da/db2/global_8loops_8manypoints_8h.html#ac8b973bce4dcedb06b10ea23d7fe6d4a">ZLOOP</a>{</div>
<div class="line"><a name="l02821"></a><span class="lineno"> 2821</span>&#160;    <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a3059ed7bfcfb692cbe8014d55fd7c1e4">get_geometry</a>(i, j, k, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8936711f57f82d1fc75c21fa2894e1c6">CENT</a>, ptrgeom);</div>
<div class="line"><a name="l02822"></a><span class="lineno"> 2822</span>&#160;    <span class="comment">// invert True U-&gt;p</span></div>
<div class="line"><a name="l02823"></a><span class="lineno"> 2823</span>&#160;    <span class="keywordtype">int</span> eomtype=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aa28b06d889a02621b45edc716bfb2d01">EOMDEFAULT</a>;</div>
<div class="line"><a name="l02824"></a><span class="lineno"> 2824</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dissmeasure=-1.0; <span class="comment">// then assume always energy since no info here.</span></div>
<div class="line"><a name="l02825"></a><span class="lineno"> 2825</span>&#160;    <span class="keywordtype">int</span> whichcap=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a4b6c6060c025e15f1d92aae3dcb9365b" title="which cap type to place in rad inversion">CAPTYPEBASIC</a>;</div>
<div class="line"><a name="l02826"></a><span class="lineno"> 2826</span>&#160;    <span class="keywordtype">int</span> whichmethod=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a46b689a25732194a759b43d32ac1570c" title="mode for inversion">MODEDEFAULT</a>;</div>
<div class="line"><a name="l02827"></a><span class="lineno"> 2827</span>&#160;    <span class="keywordtype">int</span> modprim=0;</div>
<div class="line"><a name="l02828"></a><span class="lineno"> 2828</span>&#160;    <span class="keywordtype">int</span> checkoninversiongas=<a class="code" href="../../da/d3e/definit_8h.html#a5dc18e6d15e4420586d45d912fccebac" title="whether to check on inversion and report problem Also, use diag_fixup() to account for changes in U w...">CHECKONINVERSION</a>;</div>
<div class="line"><a name="l02829"></a><span class="lineno"> 2829</span>&#160;    <span class="keywordtype">int</span> checkoninversionrad=<a class="code" href="../../da/d3e/definit_8h.html#a70e4418eb8c6479afc202024b46ad581">CHECKONINVERSIONRAD</a>;</div>
<div class="line"><a name="l02830"></a><span class="lineno"> 2830</span>&#160;    <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(<a class="code" href="../../d1/d3e/utoprimgen_8c.html#a7e078cc9a354495bc85554d875a705d9" title="General explicit inversion of U[MHD]-&gt;P[MHD] and also inverts scalars. Inverts radiation if(EOMRADTYP...">Utoprimgen</a>(showmessages, checkoninversiongas, checkoninversionrad, allowlocalfailurefixandnoreport,0,&amp;eomtype,whichcap,whichmethod,modprim,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7d1dc231c422450f87fdb3e71b4a7aff" title="defines how Utoprimgen is used">EVOLVEUTOPRIM</a>,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a15d073255fcc246f09aa26337e643d22" title="defines data return types for primtoU() and primtoflux()">UEVOLVE</a>,<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(U,i,j,k), NULL, ptrgeom, dissmeasure, <a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(prim,i,j,k), <a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(prim,i,j,k),newtonstats),<span class="stringliteral">&quot;step_ch.c:advance()&quot;</span>, <span class="stringliteral">&quot;Utoprimgen&quot;</span>, 1);</div>
<div class="line"><a name="l02831"></a><span class="lineno"> 2831</span>&#160;  }</div>
<div class="line"><a name="l02832"></a><span class="lineno"> 2832</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l02833"></a><span class="lineno"> 2833</span>&#160;}</div>
<div class="line"><a name="l02834"></a><span class="lineno"> 2834</span>&#160;</div>
<div class="line"><a name="l02835"></a><span class="lineno"> 2835</span>&#160;</div>
<div class="line"><a name="l02836"></a><span class="lineno"> 2836</span>&#160;</div>
<div class="line"><a name="l02838"></a><span class="lineno"><a class="code" href="../../db/dc8/utoprimgen_8funcdeclare_8h.html#a58011440113d7e9adf2b0af40e531f25"> 2838</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="../../d1/d3e/utoprimgen_8c.html#aeb7f18013467d4137a8b560024e71f51" title="loop for P-&gt;U">primtoUloop</a>(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*prim)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*U)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR])</div>
<div class="line"><a name="l02839"></a><span class="lineno"> 2839</span>&#160;{</div>
<div class="line"><a name="l02840"></a><span class="lineno"> 2840</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> geomdontuse;</div>
<div class="line"><a name="l02841"></a><span class="lineno"> 2841</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom=&amp;geomdontuse;</div>
<div class="line"><a name="l02842"></a><span class="lineno"> 2842</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> q;</div>
<div class="line"><a name="l02843"></a><span class="lineno"> 2843</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>,<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>,k;</div>
<div class="line"><a name="l02844"></a><span class="lineno"> 2844</span>&#160;</div>
<div class="line"><a name="l02845"></a><span class="lineno"> 2845</span>&#160;  <a class="code" href="../../da/db2/global_8loops_8manypoints_8h.html#ac8b973bce4dcedb06b10ea23d7fe6d4a">ZLOOP</a>{</div>
<div class="line"><a name="l02846"></a><span class="lineno"> 2846</span>&#160;    <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a11e17cd8b0594d1ad52e3594aa9f477e" title="find ucon, ucov, bcon, bcov from primitive variables when calling get_state, users of this function e...">get_state</a>(<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(prim,i,j,k), ptrgeom, &amp;q),<span class="stringliteral">&quot;step_ch.c:primtoUloop()&quot;</span>, <span class="stringliteral">&quot;get_state()&quot;</span>, 1);</div>
<div class="line"><a name="l02847"></a><span class="lineno"> 2847</span>&#160;    <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a3059ed7bfcfb692cbe8014d55fd7c1e4">get_geometry</a>(i, j, k, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8936711f57f82d1fc75c21fa2894e1c6">CENT</a>, ptrgeom);</div>
<div class="line"><a name="l02848"></a><span class="lineno"> 2848</span>&#160;    <span class="comment">// forward calculate U(p)</span></div>
<div class="line"><a name="l02849"></a><span class="lineno"> 2849</span>&#160;    <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a9a54096e4c40a15a2c1bf74266153616" title="calculate &quot;conserved&quot; quantities">primtoU</a>(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a15d073255fcc246f09aa26337e643d22" title="defines data return types for primtoU() and primtoflux()">UEVOLVE</a>,<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(prim,i,j,k), &amp;q, ptrgeom, <a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(U,i,j,k), NULL),<span class="stringliteral">&quot;step_ch.c:primtoUloop()&quot;</span>, <span class="stringliteral">&quot;primtoU()&quot;</span>, 1);</div>
<div class="line"><a name="l02850"></a><span class="lineno"> 2850</span>&#160;  }</div>
<div class="line"><a name="l02851"></a><span class="lineno"> 2851</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l02852"></a><span class="lineno"> 2852</span>&#160;}</div>
<div class="line"><a name="l02853"></a><span class="lineno"> 2853</span>&#160;</div>
<div class="line"><a name="l02854"></a><span class="lineno"> 2854</span>&#160;</div>
<div class="line"><a name="l02855"></a><span class="lineno"> 2855</span>&#160;</div>
<div class="line"><a name="l02857"></a><span class="lineno"> 2857</span>&#160;<span class="keywordtype">void</span> filterffde(<span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr)</div>
<div class="line"><a name="l02858"></a><span class="lineno"> 2858</span>&#160;{</div>
<div class="line"><a name="l02859"></a><span class="lineno"> 2859</span>&#160;  <span class="keywordtype">int</span> pl,pliter;</div>
<div class="line"><a name="l02860"></a><span class="lineno"> 2860</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> geomdontuse;</div>
<div class="line"><a name="l02861"></a><span class="lineno"> 2861</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom=&amp;geomdontuse;</div>
<div class="line"><a name="l02862"></a><span class="lineno"> 2862</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> prout[NPR],prin[NPR];</div>
<div class="line"><a name="l02863"></a><span class="lineno"> 2863</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> U[NPR];</div>
<div class="line"><a name="l02864"></a><span class="lineno"> 2864</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> q;</div>
<div class="line"><a name="l02865"></a><span class="lineno"> 2865</span>&#160;  <span class="comment">//  int Utoprim_ffde(FTYPE *U, struct of_geom *geom, FTYPE *pr)  ;</span></div>
<div class="line"><a name="l02866"></a><span class="lineno"> 2866</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../db/d3a/structof__newtonstats.html">of_newtonstats</a> newtonstats; setnewtonstatsdefault(&amp;newtonstats);</div>
<div class="line"><a name="l02867"></a><span class="lineno"> 2867</span>&#160;  <span class="keywordtype">int</span> finalstep=0;</div>
<div class="line"><a name="l02868"></a><span class="lineno"> 2868</span>&#160;  <span class="keywordtype">int</span> showmessages=1;</div>
<div class="line"><a name="l02869"></a><span class="lineno"> 2869</span>&#160;  <span class="keywordtype">int</span> allowlocalfailurefixandnoreport=1;</div>
<div class="line"><a name="l02870"></a><span class="lineno"> 2870</span>&#160;</div>
<div class="line"><a name="l02871"></a><span class="lineno"> 2871</span>&#160;  <span class="comment">// now filter velocity</span></div>
<div class="line"><a name="l02872"></a><span class="lineno"> 2872</span>&#160;  <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a3059ed7bfcfb692cbe8014d55fd7c1e4">get_geometry</a>(i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8936711f57f82d1fc75c21fa2894e1c6">CENT</a>,ptrgeom);</div>
<div class="line"><a name="l02873"></a><span class="lineno"> 2873</span>&#160;  <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a11e17cd8b0594d1ad52e3594aa9f477e" title="find ucon, ucov, bcon, bcov from primitive variables when calling get_state, users of this function e...">get_state</a>(pr,ptrgeom,&amp;q);</div>
<div class="line"><a name="l02874"></a><span class="lineno"> 2874</span>&#160;  <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a9a54096e4c40a15a2c1bf74266153616" title="calculate &quot;conserved&quot; quantities">primtoU</a>(UNOTHING,pr,&amp;q,ptrgeom,U, NULL);</div>
<div class="line"><a name="l02875"></a><span class="lineno"> 2875</span>&#160;</div>
<div class="line"><a name="l02876"></a><span class="lineno"> 2876</span>&#160;  <span class="comment">//  Utoprim_ffde(U,ptrgeom,prout); // no need for initial guess since analytic inversion</span></div>
<div class="line"><a name="l02877"></a><span class="lineno"> 2877</span>&#160;  <span class="keywordtype">int</span> eomtype=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aa28b06d889a02621b45edc716bfb2d01">EOMDEFAULT</a>;</div>
<div class="line"><a name="l02878"></a><span class="lineno"> 2878</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dissmeasure=-1.0; <span class="comment">// assume energy inversion ok</span></div>
<div class="line"><a name="l02879"></a><span class="lineno"> 2879</span>&#160;  <span class="keywordtype">int</span> whichcap=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a4b6c6060c025e15f1d92aae3dcb9365b" title="which cap type to place in rad inversion">CAPTYPEBASIC</a>;</div>
<div class="line"><a name="l02880"></a><span class="lineno"> 2880</span>&#160;  <span class="keywordtype">int</span> whichmethod=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a46b689a25732194a759b43d32ac1570c" title="mode for inversion">MODEDEFAULT</a>;</div>
<div class="line"><a name="l02881"></a><span class="lineno"> 2881</span>&#160;  <span class="keywordtype">int</span> modprim=0;</div>
<div class="line"><a name="l02882"></a><span class="lineno"> 2882</span>&#160;  <span class="keywordtype">int</span> checkoninversiongas=<a class="code" href="../../da/d3e/definit_8h.html#a5dc18e6d15e4420586d45d912fccebac" title="whether to check on inversion and report problem Also, use diag_fixup() to account for changes in U w...">CHECKONINVERSION</a>;</div>
<div class="line"><a name="l02883"></a><span class="lineno"> 2883</span>&#160;  <span class="keywordtype">int</span> checkoninversionrad=<a class="code" href="../../da/d3e/definit_8h.html#a70e4418eb8c6479afc202024b46ad581">CHECKONINVERSIONRAD</a>;</div>
<div class="line"><a name="l02884"></a><span class="lineno"> 2884</span>&#160;  <a class="code" href="../../d1/d3e/utoprimgen_8c.html#a7e078cc9a354495bc85554d875a705d9" title="General explicit inversion of U[MHD]-&gt;P[MHD] and also inverts scalars. Inverts radiation if(EOMRADTYP...">Utoprimgen</a>(showmessages, checkoninversiongas, checkoninversionrad, allowlocalfailurefixandnoreport, finalstep, &amp;eomtype,whichcap,whichmethod,modprim,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7d1dc231c422450f87fdb3e71b4a7aff" title="defines how Utoprimgen is used">EVOLVEUTOPRIM</a>,UNOTHING,U,NULL,ptrgeom,dissmeasure,pr,prout,&amp;newtonstats);</div>
<div class="line"><a name="l02885"></a><span class="lineno"> 2885</span>&#160;</div>
<div class="line"><a name="l02886"></a><span class="lineno"> 2886</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl) pr[pl]=prout[pl];</div>
<div class="line"><a name="l02887"></a><span class="lineno"> 2887</span>&#160;  <span class="comment">// kill densities</span></div>
<div class="line"><a name="l02888"></a><span class="lineno"> 2888</span>&#160;  pr[RHO]=pr[UU]=0.0;</div>
<div class="line"><a name="l02889"></a><span class="lineno"> 2889</span>&#160;</div>
<div class="line"><a name="l02890"></a><span class="lineno"> 2890</span>&#160;</div>
<div class="line"><a name="l02891"></a><span class="lineno"> 2891</span>&#160;</div>
<div class="line"><a name="l02892"></a><span class="lineno"> 2892</span>&#160;}</div>
<div class="line"><a name="l02893"></a><span class="lineno"> 2893</span>&#160;</div>
<div class="line"><a name="l02894"></a><span class="lineno"> 2894</span>&#160;</div>
<div class="line"><a name="l02897"></a><span class="lineno"> 2897</span>&#160;<span class="keywordtype">int</span> badenergy(struct <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *energypr, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *entropypr)</div>
<div class="line"><a name="l02898"></a><span class="lineno"> 2898</span>&#160;{</div>
<div class="line"><a name="l02899"></a><span class="lineno"> 2899</span>&#160;  </div>
<div class="line"><a name="l02900"></a><span class="lineno"> 2900</span>&#160;  <span class="comment">//  return(BADENERGYMAC(energypr[UU],entropypr[UU]));</span></div>
<div class="line"><a name="l02901"></a><span class="lineno"> 2901</span>&#160;  <span class="comment">//  return(BADENERGY2MAC(energypr[UU],entropypr[UU]));</span></div>
<div class="line"><a name="l02902"></a><span class="lineno"> 2902</span>&#160;</div>
<div class="line"><a name="l02903"></a><span class="lineno"> 2903</span>&#160;  <span class="comment">// energy solution&#39;s specific entropy</span></div>
<div class="line"><a name="l02904"></a><span class="lineno"> 2904</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> entropy;</div>
<div class="line"><a name="l02905"></a><span class="lineno"> 2905</span>&#160;</div>
<div class="line"><a name="l02906"></a><span class="lineno"> 2906</span>&#160;  <a class="code" href="../../d2/d0e/eos_8funcdeclare_8h.html#a40d05587958104d0da46c2aa00f4f30d" title="entropy wrapper this function should NOT be called by utoprim_jon.c inversion">entropy_calc</a>(ptrgeom,energypr,&amp;entropy);</div>
<div class="line"><a name="l02907"></a><span class="lineno"> 2907</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Sspecenergy=entropy/energypr[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>];</div>
<div class="line"><a name="l02908"></a><span class="lineno"> 2908</span>&#160;</div>
<div class="line"><a name="l02909"></a><span class="lineno"> 2909</span>&#160;  <a class="code" href="../../d2/d0e/eos_8funcdeclare_8h.html#a40d05587958104d0da46c2aa00f4f30d" title="entropy wrapper this function should NOT be called by utoprim_jon.c inversion">entropy_calc</a>(ptrgeom,entropypr,&amp;entropy);</div>
<div class="line"><a name="l02910"></a><span class="lineno"> 2910</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Sspecentropy=entropy/entropypr[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>];</div>
<div class="line"><a name="l02911"></a><span class="lineno"> 2911</span>&#160;</div>
<div class="line"><a name="l02912"></a><span class="lineno"> 2912</span>&#160;  <span class="keywordflow">if</span>(Sspecenergy&gt;=Sspecentropy) <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l02913"></a><span class="lineno"> 2913</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">return</span>(1);</div>
<div class="line"><a name="l02914"></a><span class="lineno"> 2914</span>&#160;</div>
<div class="line"><a name="l02915"></a><span class="lineno"> 2915</span>&#160;</div>
<div class="line"><a name="l02916"></a><span class="lineno"> 2916</span>&#160;</div>
<div class="line"><a name="l02917"></a><span class="lineno"> 2917</span>&#160;}</div>
<div class="line"><a name="l02918"></a><span class="lineno"> 2918</span>&#160;</div>
<div class="line"><a name="l02919"></a><span class="lineno"> 2919</span>&#160;</div>
<div class="line"><a name="l02921"></a><span class="lineno"> 2921</span>&#160;<span class="keywordtype">int</span> whetherdoentropy(<span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fracenergy, <span class="keywordtype">int</span> entropynotfail, <span class="keywordtype">int</span> energynotfail, <span class="keywordtype">int</span> radinvmodentropy, <span class="keywordtype">int</span> radinvmodenergy, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> tryerror, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> okerror, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> baderror, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> entropyerror, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> energyerror, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *entropypr, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *energypr)</div>
<div class="line"><a name="l02922"></a><span class="lineno"> 2922</span>&#160;{</div>
<div class="line"><a name="l02923"></a><span class="lineno"> 2923</span>&#160;  <span class="keywordtype">int</span> doentropy=0;</div>
<div class="line"><a name="l02924"></a><span class="lineno"> 2924</span>&#160;</div>
<div class="line"><a name="l02925"></a><span class="lineno"> 2925</span>&#160;  <span class="comment">// KORALTODO: radinvmodenergy and radinvmodntropy conditions.</span></div>
<div class="line"><a name="l02926"></a><span class="lineno"> 2926</span>&#160;  doentropy=</div>
<div class="line"><a name="l02927"></a><span class="lineno"> 2927</span>&#160;    fracenergy==0.0 &amp;&amp; entropynotfail==1 ||</div>
<div class="line"><a name="l02928"></a><span class="lineno"> 2928</span>&#160;    <span class="comment">//       energynotfail==1 &amp;&amp; entropynotfail==1 &amp;&amp; (fracenergy&gt;0.0 &amp;&amp; fracenergy&lt;1.0) &amp;&amp; (entropyerror&lt;=okerror &amp;&amp; energyerror&gt;okerror) ||</span></div>
<div class="line"><a name="l02929"></a><span class="lineno"> 2929</span>&#160;    energynotfail==0 &amp;&amp; entropynotfail==1 ||</div>
<div class="line"><a name="l02930"></a><span class="lineno"> 2930</span>&#160;    entropynotfail==1 &amp;&amp; energynotfail==1 &amp;&amp; (entropyerror&lt;tryerror &amp;&amp; energyerror&gt;baderror) ||</div>
<div class="line"><a name="l02931"></a><span class="lineno"> 2931</span>&#160;    <span class="comment">//      entropynotfail==1 &amp;&amp; energynotfail==1 &amp;&amp; (badenergy(ptrgeom,energypr,entropypr) &amp;&amp; (entropyerror&lt;okerror &amp;&amp; energyerror&gt;entropyerror)) ||</span></div>
<div class="line"><a name="l02932"></a><span class="lineno"> 2932</span>&#160;    <span class="comment">//      entropynotfail==1 &amp;&amp; energynotfail==1 &amp;&amp; (badenergy(ptrgeom,energypr,entropypr) &amp;&amp; (entropyerror&lt;tryerror &amp;&amp; energyerror&gt;tryerror)) // switch to entropy if suspicious energy solution that looks approximate but mathematica checks suggest are mostly u_g&lt;0 if accurate solution found.</span></div>
<div class="line"><a name="l02933"></a><span class="lineno"> 2933</span>&#160;    entropynotfail==1 &amp;&amp; energynotfail==1 &amp;&amp; (badenergy(ptrgeom,energypr,entropypr) &amp;&amp; (entropyerror&lt;okerror &amp;&amp; energyerror&lt;okerror)) <span class="comment">// switch to entropy if ug for energy is smaller, and can trust both energy and entropy ug so can trust that comparison.</span></div>
<div class="line"><a name="l02934"></a><span class="lineno"> 2934</span>&#160;    ||entropynotfail==1 &amp;&amp; energynotfail==1 &amp;&amp; radinvmodenergy&gt;0 &amp;&amp; radinvmodentropy&lt;=0 &amp;&amp; entropyerror&lt;okerror <span class="comment">// avoid energy if it particularly leads to radiation reaching maximum gamma or minimum Erf.  Ok to do because if dissipating, that would only normally create more Erf, not less, in optically thin regions where one might worry about switching to entropy.</span></div>
<div class="line"><a name="l02935"></a><span class="lineno"> 2935</span>&#160;    ;</div>
<div class="line"><a name="l02936"></a><span class="lineno"> 2936</span>&#160;</div>
<div class="line"><a name="l02937"></a><span class="lineno"> 2937</span>&#160;  <span class="comment">// override to preserve better force balance, as long as energy solution is a good one.</span></div>
<div class="line"><a name="l02938"></a><span class="lineno"> 2938</span>&#160;  <span class="comment">// so might use energy even in expanding flows.</span></div>
<div class="line"><a name="l02939"></a><span class="lineno"> 2939</span>&#160;  <span class="keywordflow">if</span>(entropynotfail==1 &amp;&amp; energynotfail==1 &amp;&amp; radinvmodenergy&lt;=0 &amp;&amp; radinvmodentropy&gt;0 &amp;&amp; energyerror&lt;okerror){</div>
<div class="line"><a name="l02940"></a><span class="lineno"> 2940</span>&#160;    doentropy=0;</div>
<div class="line"><a name="l02941"></a><span class="lineno"> 2941</span>&#160;    <span class="keywordflow">if</span>(debugfail&gt;=3) dualfprintf(fail_file,<span class="stringliteral">&quot;Went to energy with errorabs=%g because radinvmodentropy=%d with with entropyerror=%g\n&quot;</span>,energyerror,radinvmodentropy,entropyerror);</div>
<div class="line"><a name="l02942"></a><span class="lineno"> 2942</span>&#160;  }</div>
<div class="line"><a name="l02943"></a><span class="lineno"> 2943</span>&#160;  <span class="keywordflow">if</span>(entropynotfail==1 &amp;&amp; energynotfail==1 &amp;&amp; radinvmodenergy&gt;0 &amp;&amp; radinvmodentropy&lt;=0 &amp;&amp; entropyerror&lt;okerror){</div>
<div class="line"><a name="l02944"></a><span class="lineno"> 2944</span>&#160;    <span class="keywordflow">if</span>(debugfail&gt;=3) dualfprintf(fail_file,<span class="stringliteral">&quot;Went to entropy with errorabs=%g because radinvmodenergy=%d with with energyerror=%g\n&quot;</span>,entropyerror,radinvmodenergy,energyerror);</div>
<div class="line"><a name="l02945"></a><span class="lineno"> 2945</span>&#160;  }</div>
<div class="line"><a name="l02946"></a><span class="lineno"> 2946</span>&#160;</div>
<div class="line"><a name="l02947"></a><span class="lineno"> 2947</span>&#160;  <span class="comment">//  UTOPRIMRADFAILCASE2A;</span></div>
<div class="line"><a name="l02948"></a><span class="lineno"> 2948</span>&#160;  <span class="comment">//  UTOPRIMRADFAILCASE3A;</span></div>
<div class="line"><a name="l02949"></a><span class="lineno"> 2949</span>&#160;</div>
<div class="line"><a name="l02950"></a><span class="lineno"> 2950</span>&#160;  <span class="keywordflow">return</span>(doentropy);</div>
<div class="line"><a name="l02951"></a><span class="lineno"> 2951</span>&#160;</div>
<div class="line"><a name="l02952"></a><span class="lineno"> 2952</span>&#160;}</div>
<div class="line"><a name="l02953"></a><span class="lineno"> 2953</span>&#160;</div>
<div class="line"><a name="l02954"></a><span class="lineno"> 2954</span>&#160;</div>
<div class="line"><a name="l02956"></a><span class="lineno"> 2956</span>&#160;<span class="keywordtype">int</span> set_fracenergy(<span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dissmeasure, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *fracenergy)</div>
<div class="line"><a name="l02957"></a><span class="lineno"> 2957</span>&#160;{</div>
<div class="line"><a name="l02958"></a><span class="lineno"> 2958</span>&#160;  <span class="comment">// get divcond.  Go over dimensions in case not full 3D.  Just duplicates value as per in flux.c.</span></div>
<div class="line"><a name="l02959"></a><span class="lineno"> 2959</span>&#160;  <span class="keyword">const</span> <span class="keywordtype">int</span> NxNOT1[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>]={0,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a51b48b29d7903bb94a3d7879c3ff8eb9">N1NOT1</a>,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9d8b7e3d088c68f51e7b29b95326a4ac">N2NOT1</a>,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#aabbd6bada71f73d78d57d14e9adc0c29">N3NOT1</a>};</div>
<div class="line"><a name="l02960"></a><span class="lineno"> 2960</span>&#160;  <span class="keywordtype">int</span> dir;</div>
<div class="line"><a name="l02961"></a><span class="lineno"> 2961</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> divcond;</div>
<div class="line"><a name="l02962"></a><span class="lineno"> 2962</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> DIVCONDDN=-<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>,DIVCONDUP=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>;</div>
<div class="line"><a name="l02963"></a><span class="lineno"> 2963</span>&#160;</div>
<div class="line"><a name="l02964"></a><span class="lineno"> 2964</span>&#160;</div>
<div class="line"><a name="l02965"></a><span class="lineno"> 2965</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#a4150fe547d5f22828b0e2bfca90fe6bf">DIVERGENCEMETHOD</a>==<a class="code" href="../../da/d3e/definit_8h.html#ad989250d0b24d11cdc9bfe66a3546f5f" title="which method to store divergence condition">DIVMETHODPREFLUX</a>){</div>
<div class="line"><a name="l02966"></a><span class="lineno"> 2966</span>&#160;    DIVCONDDN=0.0;</div>
<div class="line"><a name="l02967"></a><span class="lineno"> 2967</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a8cbb473515f18fcae523329c93f140dc">DIMENLOOP</a>(dir){</div>
<div class="line"><a name="l02968"></a><span class="lineno"> 2968</span>&#160;      <span class="keywordflow">if</span>(NxNOT1[dir]){</div>
<div class="line"><a name="l02969"></a><span class="lineno"> 2969</span>&#160;        <span class="comment">// problems when V small</span></div>
<div class="line"><a name="l02970"></a><span class="lineno"> 2970</span>&#160;        divcond=GLOBALMACP1A0(shockindicatorarray,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac7e27732d2f1e909e9231b5be3e1b959" title="below only for DIVERGENCEMETHOD==DIVMETHODPREFLUX">DIVPLDIR1</a>+dir-1,i,j,k);</div>
<div class="line"><a name="l02971"></a><span class="lineno"> 2971</span>&#160;      }</div>
<div class="line"><a name="l02972"></a><span class="lineno"> 2972</span>&#160;    }</div>
<div class="line"><a name="l02973"></a><span class="lineno"> 2973</span>&#160;  }</div>
<div class="line"><a name="l02974"></a><span class="lineno"> 2974</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#a4150fe547d5f22828b0e2bfca90fe6bf">DIVERGENCEMETHOD</a>==<a class="code" href="../../da/d3e/definit_8h.html#a57d5e2a84b3a093b47504a88bc7e8d63">DIVMETHODPOSTFLUX</a>){</div>
<div class="line"><a name="l02975"></a><span class="lineno"> 2975</span>&#160;    <span class="comment">//      DIVCONDDN=-0.01;</span></div>
<div class="line"><a name="l02976"></a><span class="lineno"> 2976</span>&#160;    <span class="comment">//      DIVCONDDN=-SMALL;</span></div>
<div class="line"><a name="l02977"></a><span class="lineno"> 2977</span>&#160;    <span class="comment">//      DIVCONDDN=-1E-6;</span></div>
<div class="line"><a name="l02978"></a><span class="lineno"> 2978</span>&#160;    <span class="comment">//      DIVCONDDN=-1E-3;</span></div>
<div class="line"><a name="l02979"></a><span class="lineno"> 2979</span>&#160;</div>
<div class="line"><a name="l02980"></a><span class="lineno"> 2980</span>&#160;    <span class="comment">//      DIVCONDUP=-1E-6;</span></div>
<div class="line"><a name="l02981"></a><span class="lineno"> 2981</span>&#160;    <span class="comment">//      DIVCONDUP=-100.0*NUMEPSILON;</span></div>
<div class="line"><a name="l02982"></a><span class="lineno"> 2982</span>&#160;</div>
<div class="line"><a name="l02983"></a><span class="lineno"> 2983</span>&#160;    <span class="comment">//      DIVCONDDN=-0.1;</span></div>
<div class="line"><a name="l02984"></a><span class="lineno"> 2984</span>&#160;    <span class="comment">//      DIVCONDDN=-100.0*NUMEPSILON;</span></div>
<div class="line"><a name="l02985"></a><span class="lineno"> 2985</span>&#160;    DIVCONDDN=0.0;</div>
<div class="line"><a name="l02986"></a><span class="lineno"> 2986</span>&#160;    DIVCONDUP=DIVCONDDN;</div>
<div class="line"><a name="l02987"></a><span class="lineno"> 2987</span>&#160;</div>
<div class="line"><a name="l02988"></a><span class="lineno"> 2988</span>&#160;    divcond=dissmeasure;</div>
<div class="line"><a name="l02989"></a><span class="lineno"> 2989</span>&#160;    <span class="comment">//      if(GLOBALMACP1A0(shockindicatorarray,SHOCKPLDIR1+dir-1,i,j,k);</span></div>
<div class="line"><a name="l02990"></a><span class="lineno"> 2990</span>&#160;  }</div>
<div class="line"><a name="l02991"></a><span class="lineno"> 2991</span>&#160;</div>
<div class="line"><a name="l02992"></a><span class="lineno"> 2992</span>&#160;</div>
<div class="line"><a name="l02993"></a><span class="lineno"> 2993</span>&#160;</div>
<div class="line"><a name="l02995"></a><span class="lineno"> 2995</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02996"></a><span class="lineno"> 2996</span>&#160;  <span class="comment">// then interpolate between energy and entropy solution</span></div>
<div class="line"><a name="l02997"></a><span class="lineno"> 2997</span>&#160;  <span class="comment">// below DIVCONDDN, do only energy</span></div>
<div class="line"><a name="l02998"></a><span class="lineno"> 2998</span>&#160;  <span class="comment">// above DIVCONDUP, do only entropy</span></div>
<div class="line"><a name="l02999"></a><span class="lineno"> 2999</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l03001"></a><span class="lineno"> 3001</span>&#160;<span class="comment"></span>  <span class="keywordflow">if</span>(DIVCONDDN!=DIVCONDUP){</div>
<div class="line"><a name="l03002"></a><span class="lineno"> 3002</span>&#160;    *fracenergy = (divcond-DIVCONDUP)/(DIVCONDDN-DIVCONDUP);</div>
<div class="line"><a name="l03003"></a><span class="lineno"> 3003</span>&#160;    *fracenergy=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(1.0,*fracenergy);</div>
<div class="line"><a name="l03004"></a><span class="lineno"> 3004</span>&#160;    *fracenergy=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(0.0,*fracenergy);</div>
<div class="line"><a name="l03005"></a><span class="lineno"> 3005</span>&#160;  }</div>
<div class="line"><a name="l03006"></a><span class="lineno"> 3006</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l03007"></a><span class="lineno"> 3007</span>&#160;    <span class="comment">// force so no machine error issues in switch</span></div>
<div class="line"><a name="l03008"></a><span class="lineno"> 3008</span>&#160;    <span class="keywordflow">if</span>(divcond&lt;DIVCONDDN) *fracenergy=1.0;</div>
<div class="line"><a name="l03009"></a><span class="lineno"> 3009</span>&#160;    <span class="keywordflow">else</span> *fracenergy=0.0;</div>
<div class="line"><a name="l03010"></a><span class="lineno"> 3010</span>&#160;  }</div>
<div class="line"><a name="l03011"></a><span class="lineno"> 3011</span>&#160;</div>
<div class="line"><a name="l03012"></a><span class="lineno"> 3012</span>&#160;</div>
<div class="line"><a name="l03013"></a><span class="lineno"> 3013</span>&#160;  <span class="comment">// DEBUG</span></div>
<div class="line"><a name="l03014"></a><span class="lineno"> 3014</span>&#160;  <span class="comment">//    dualfprintf(fail_file,&quot;divcond=%g fracenergy=%g\n&quot;,divcond,fracenergy);</span></div>
<div class="line"><a name="l03015"></a><span class="lineno"> 3015</span>&#160;</div>
<div class="line"><a name="l03016"></a><span class="lineno"> 3016</span>&#160;</div>
<div class="line"><a name="l03017"></a><span class="lineno"> 3017</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l03018"></a><span class="lineno"> 3018</span>&#160;}</div>
<div class="line"><a name="l03019"></a><span class="lineno"> 3019</span>&#160;</div>
<div class="line"><a name="l03020"></a><span class="lineno"> 3020</span>&#160;</div>
<div class="line"><a name="l03022"></a><span class="lineno"> 3022</span>&#160;<span class="keywordtype">int</span> entropyfixguess(<span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *q, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *uu, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pp)</div>
<div class="line"><a name="l03023"></a><span class="lineno"> 3023</span>&#160;{</div>
<div class="line"><a name="l03024"></a><span class="lineno"> 3024</span>&#160;  <span class="keywordflow">if</span>(ENTROPY&gt;=0 &amp;&amp; <a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(pp[ENTROPY]) &amp;&amp; <a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(uu[ENTROPY]) ){</div>
<div class="line"><a name="l03025"></a><span class="lineno"> 3025</span>&#160;    <span class="keywordtype">int</span> pliter,pl;</div>
<div class="line"><a name="l03026"></a><span class="lineno"> 3026</span>&#160;</div>
<div class="line"><a name="l03027"></a><span class="lineno"> 3027</span>&#160;    <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> qlocal;</div>
<div class="line"><a name="l03028"></a><span class="lineno"> 3028</span>&#160;    <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *qptr;</div>
<div class="line"><a name="l03029"></a><span class="lineno"> 3029</span>&#160;</div>
<div class="line"><a name="l03030"></a><span class="lineno"> 3030</span>&#160;    <span class="comment">// guess&#39;s entropy</span></div>
<div class="line"><a name="l03031"></a><span class="lineno"> 3031</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> entropy0,specificentropy0;</div>
<div class="line"><a name="l03032"></a><span class="lineno"> 3032</span>&#160;    <a class="code" href="../../d2/d0e/eos_8funcdeclare_8h.html#a40d05587958104d0da46c2aa00f4f30d" title="entropy wrapper this function should NOT be called by utoprim_jon.c inversion">entropy_calc</a>(ptrgeom,pp,&amp;entropy0);</div>
<div class="line"><a name="l03033"></a><span class="lineno"> 3033</span>&#160;    specificentropy0=entropy0/pp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>];</div>
<div class="line"><a name="l03034"></a><span class="lineno"> 3034</span>&#160;</div>
<div class="line"><a name="l03035"></a><span class="lineno"> 3035</span>&#160;    <span class="keywordflow">if</span>(q==NULL){</div>
<div class="line"><a name="l03036"></a><span class="lineno"> 3036</span>&#160;      qptr=&amp;qlocal;</div>
<div class="line"><a name="l03037"></a><span class="lineno"> 3037</span>&#160;      <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a12a473e24b431762af4168179e82cd08" title="Get only u^ and u_ assumine b^ and b_ not used.">get_state_uconucovonly</a>(pp, ptrgeom, qptr);</div>
<div class="line"><a name="l03038"></a><span class="lineno"> 3038</span>&#160;    }</div>
<div class="line"><a name="l03039"></a><span class="lineno"> 3039</span>&#160;    <span class="keywordflow">else</span> qptr=q;</div>
<div class="line"><a name="l03040"></a><span class="lineno"> 3040</span>&#160;</div>
<div class="line"><a name="l03041"></a><span class="lineno"> 3041</span>&#160;    <span class="comment">// conserved &quot;initial+flux&quot; estimate of entropy</span></div>
<div class="line"><a name="l03042"></a><span class="lineno"> 3042</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> rhoE,entropyE,specificentropyE;</div>
<div class="line"><a name="l03043"></a><span class="lineno"> 3043</span>&#160;    rhoE=fabs(uu[RHO]/qptr-&gt;<a class="code" href="../../d1/d83/structof__state.html#aab723d3c7c2c48b7246cc7d7d5379eed">ucon</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>]); <span class="comment">// approximate using old u^t</span></div>
<div class="line"><a name="l03044"></a><span class="lineno"> 3044</span>&#160;    <span class="comment">// modify guess for rho</span></div>
<div class="line"><a name="l03045"></a><span class="lineno"> 3045</span>&#160;    pp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>]=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a09c78d2f8feb311dd9fc969a0bf84979">SMALL</a>,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(fabs(pp[RHO]),fabs(rhoE))); <span class="comment">// start small side to make entropy higher</span></div>
<div class="line"><a name="l03046"></a><span class="lineno"> 3046</span>&#160;</div>
<div class="line"><a name="l03047"></a><span class="lineno"> 3047</span>&#160;    specificentropyE=uu[ENTROPY]/uu[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>]; <span class="comment">// no approximation</span></div>
<div class="line"><a name="l03048"></a><span class="lineno"> 3048</span>&#160;    entropyE=specificentropyE*pp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>]; <span class="comment">// worse case for entropy (i.e. highest entropy).  Approximate entropyE.</span></div>
<div class="line"><a name="l03049"></a><span class="lineno"> 3049</span>&#160;    <span class="comment">//    if(specificentropy0&lt;specificentropyE){</span></div>
<div class="line"><a name="l03050"></a><span class="lineno"> 3050</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ppnew[NPR]; <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) ppnew[pl]=pp[pl];</div>
<div class="line"><a name="l03051"></a><span class="lineno"> 3051</span>&#160;    <span class="comment">// no approximation for u_g from entropyE</span></div>
<div class="line"><a name="l03052"></a><span class="lineno"> 3052</span>&#160;    <a class="code" href="../../d2/d0e/eos_8funcdeclare_8h.html#aee18590753badffce52183e6ae69e19d" title="u from entropy (uses pr[RHO]) wrapper">ufromentropy_calc</a>(ptrgeom, entropyE, ppnew); <span class="comment">// LEAKNOTE: valgrind says use of uninit here.</span></div>
<div class="line"><a name="l03053"></a><span class="lineno"> 3053</span>&#160;    ppnew[UU]=ppnew[ENTROPY];</div>
<div class="line"><a name="l03054"></a><span class="lineno"> 3054</span>&#160;<span class="preprocessor">#define SHOWUGCHANGEDUETOENTROPY (10.0)</span></div>
<div class="line"><a name="l03055"></a><span class="lineno"> 3055</span>&#160;<span class="preprocessor"></span>    <span class="keywordflow">if</span>(debugfail&gt;=3 &amp;&amp; (fabs(ppnew[UU]/pp[UU])&gt;SHOWUGCHANGEDUETOENTROPY || ppnew[UU]&lt;pp[UU]) ) dualfprintf(fail_file,<span class="stringliteral">&quot;CHANGE : Fixed (%g/%g) entropy (%g vs. %g): guessrho=%g guessug=%g  newug=%g dug=%g\n&quot;</span>,uu[ENTROPY],uu[RHO],specificentropy0,specificentropyE,pp[RHO],pp[UU],ppnew[UU],pp[UU]-ppnew[UU]);</div>
<div class="line"><a name="l03056"></a><span class="lineno"> 3056</span>&#160;    <span class="comment">// modify guess for u_g (start higher than actual solution hopefully)</span></div>
<div class="line"><a name="l03057"></a><span class="lineno"> 3057</span>&#160;    pp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(pp[UU],ppnew[UU]);</div>
<div class="line"><a name="l03058"></a><span class="lineno"> 3058</span>&#160;</div>
<div class="line"><a name="l03059"></a><span class="lineno"> 3059</span>&#160;    <span class="comment">// recompute uu&#39;s so consistent (No, uu=uu is better approximation)</span></div>
<div class="line"><a name="l03060"></a><span class="lineno"> 3060</span>&#160;    <span class="comment">//    struct of_state req;</span></div>
<div class="line"><a name="l03061"></a><span class="lineno"> 3061</span>&#160;    <span class="comment">//    get_state(pp, ptrgeom, &amp;req);</span></div>
<div class="line"><a name="l03062"></a><span class="lineno"> 3062</span>&#160;    <span class="comment">//    primtoU(UNOTHING,pp,&amp;req,ptrgeom, uu, uuabs);</span></div>
<div class="line"><a name="l03063"></a><span class="lineno"> 3063</span>&#160;  }</div>
<div class="line"><a name="l03064"></a><span class="lineno"> 3064</span>&#160;</div>
<div class="line"><a name="l03065"></a><span class="lineno"> 3065</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l03066"></a><span class="lineno"> 3066</span>&#160;}</div>
<div class="line"><a name="l03067"></a><span class="lineno"> 3067</span>&#160;</div>
<div class="line"><a name="l03068"></a><span class="lineno"> 3068</span>&#160;</div>
<div class="line"><a name="l03069"></a><span class="lineno"> 3069</span>&#160;</div>
<div class="line"><a name="l03071"></a><span class="lineno"> 3071</span>&#160;<span class="keywordtype">int</span> setnewtonstatsdefault(<span class="keyword">struct</span> <a class="code" href="../../db/d3a/structof__newtonstats.html">of_newtonstats</a> *newtonstats)</div>
<div class="line"><a name="l03072"></a><span class="lineno"> 3072</span>&#160;{</div>
<div class="line"><a name="l03073"></a><span class="lineno"> 3073</span>&#160;</div>
<div class="line"><a name="l03074"></a><span class="lineno"> 3074</span>&#160;  newtonstats-&gt;<a class="code" href="../../db/d3a/structof__newtonstats.html#abaf99ec9e8c395755285cd9a44858314">tryconv</a>=-1.0;</div>
<div class="line"><a name="l03075"></a><span class="lineno"> 3075</span>&#160;  newtonstats-&gt;<a class="code" href="../../db/d3a/structof__newtonstats.html#a00940ef45bf3eb6e72c49ea66dd7c8b2">tryconvultrarel</a>=-1.0;</div>
<div class="line"><a name="l03076"></a><span class="lineno"> 3076</span>&#160;  newtonstats-&gt;<a class="code" href="../../db/d3a/structof__newtonstats.html#a98ac5de850a4bd5b495a8c9e1975499b">mintryconv</a>=-1.0;</div>
<div class="line"><a name="l03077"></a><span class="lineno"> 3077</span>&#160;  newtonstats-&gt;<a class="code" href="../../db/d3a/structof__newtonstats.html#a767c6b7671c51ec6db1a3d7199775588">maxiter</a>=-1;</div>
<div class="line"><a name="l03078"></a><span class="lineno"> 3078</span>&#160;  newtonstats-&gt;<a class="code" href="../../db/d3a/structof__newtonstats.html#a28c2335afb8757d40128392034402c17">extra_newt_iter</a>=-1;</div>
<div class="line"><a name="l03079"></a><span class="lineno"> 3079</span>&#160;  newtonstats-&gt;<a class="code" href="../../db/d3a/structof__newtonstats.html#a08186e529162af19adc29e62eaaf31d9">extra_newt_iter_ultrarel</a>=-1;</div>
<div class="line"><a name="l03080"></a><span class="lineno"> 3080</span>&#160;</div>
<div class="line"><a name="l03081"></a><span class="lineno"> 3081</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l03082"></a><span class="lineno"> 3082</span>&#160;}</div>
<div class="line"><a name="l03083"></a><span class="lineno"> 3083</span>&#160;</div>
<div class="line"><a name="l03084"></a><span class="lineno"> 3084</span>&#160;</div>
<div class="line"><a name="l03085"></a><span class="lineno"> 3085</span>&#160;</div>
<div class="line"><a name="l03086"></a><span class="lineno"> 3086</span>&#160;</div>
<div class="line"><a name="l03088"></a><span class="lineno"><a class="code" href="../../db/dc8/utoprimgen_8funcdeclare_8h.html#a7d31362f91cd4ec3b92e15dd6bcb3908"> 3088</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="../../d1/d3e/utoprimgen_8c.html#a7d31362f91cd4ec3b92e15dd6bcb3908" title="includerad=1: account for fact that not only assume MHD flow is cold itself, but energy-force balance...">isflowcold</a>(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> COLDFACTOR, <span class="keywordtype">int</span> includerad, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pb, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *q, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *uu0)</div>
<div class="line"><a name="l03089"></a><span class="lineno"> 3089</span>&#160;{</div>
<div class="line"><a name="l03090"></a><span class="lineno"> 3090</span>&#160;  <span class="keywordtype">int</span> iscoldflow=0;</div>
<div class="line"><a name="l03091"></a><span class="lineno"> 3091</span>&#160;</div>
<div class="line"><a name="l03092"></a><span class="lineno"> 3092</span>&#160;  <span class="comment">//#define COLDFACTOR (0.5)</span></div>
<div class="line"><a name="l03093"></a><span class="lineno"> 3093</span>&#160;</div>
<div class="line"><a name="l03094"></a><span class="lineno"> 3094</span>&#160;  <span class="keywordflow">if</span>(includerad==0 || <a class="code" href="../../da/d3e/definit_8h.html#a99ba7daf58b283bc831b8f507f5873a4" title="#define EOMTYPE EOMCOLDGRMHD">EOMRADTYPE</a>==<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a993e29ef4139116d822d89bccb92180d" title="radiation equations of motion">EOMRADNONE</a> || uu0==NULL){</div>
<div class="line"><a name="l03095"></a><span class="lineno"> 3095</span>&#160;    <span class="keywordtype">int</span> jj;</div>
<div class="line"><a name="l03096"></a><span class="lineno"> 3096</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> usq=0.0;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) usq+=q-&gt;<a class="code" href="../../d1/d83/structof__state.html#aab723d3c7c2c48b7246cc7d7d5379eed">ucon</a>[jj]*q-&gt;<a class="code" href="../../d1/d83/structof__state.html#a09881c3d05809ef27f8115d02a835e11">ucov</a>[jj];</div>
<div class="line"><a name="l03097"></a><span class="lineno"> 3097</span>&#160;    <span class="comment">//    FTYPE ucovgas[NDIM];</span></div>
<div class="line"><a name="l03098"></a><span class="lineno"> 3098</span>&#160;    <span class="comment">//    DLOOPA(jj) ucovgas[jj]=q-&gt;ucov[jj];</span></div>
<div class="line"><a name="l03099"></a><span class="lineno"> 3099</span>&#160;    <span class="comment">//    FTYPE ucongas[NDIM];</span></div>
<div class="line"><a name="l03100"></a><span class="lineno"> 3100</span>&#160;    <span class="comment">//    DLOOPA(jj) ucongas[jj]=q-&gt;ucon[jj];</span></div>
<div class="line"><a name="l03101"></a><span class="lineno"> 3101</span>&#160;    <span class="comment">//    FTYPE ugas=0.0;  SLOOPA(jj) ugas+=ucovgas[jj]*ucongas[jj];</span></div>
<div class="line"><a name="l03102"></a><span class="lineno"> 3102</span>&#160;    <span class="comment">// u_g &lt;&lt; rho u^2</span></div>
<div class="line"><a name="l03103"></a><span class="lineno"> 3103</span>&#160;    <span class="comment">//  &amp;&amp; fabs(ucongas[TT]*ucovgas[TT])&lt;COLDFACTOR*fabs(ugas)</span></div>
<div class="line"><a name="l03104"></a><span class="lineno"> 3104</span>&#160;    iscoldflow = (pb[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]&lt;COLDFACTOR*pb[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>]); <span class="comment">// IE &lt; RE</span></div>
<div class="line"><a name="l03105"></a><span class="lineno"> 3105</span>&#160;    iscoldflow = (iscoldflow &amp;&amp; pb[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]&lt;COLDFACTOR*(pb[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>]+pb[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>])*fabs(usq)); <span class="comment">// IE &lt; KE</span></div>
<div class="line"><a name="l03106"></a><span class="lineno"> 3106</span>&#160;  }</div>
<div class="line"><a name="l03107"></a><span class="lineno"> 3107</span>&#160;  <span class="keywordflow">else</span>{<span class="comment">// RAD</span></div>
<div class="line"><a name="l03108"></a><span class="lineno"> 3108</span>&#160;    <span class="keywordtype">int</span> jj;</div>
<div class="line"><a name="l03109"></a><span class="lineno"> 3109</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> usq=0.0;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) usq+=q-&gt;<a class="code" href="../../d1/d83/structof__state.html#aab723d3c7c2c48b7246cc7d7d5379eed">ucon</a>[jj]*q-&gt;<a class="code" href="../../d1/d83/structof__state.html#a09881c3d05809ef27f8115d02a835e11">ucov</a>[jj];</div>
<div class="line"><a name="l03110"></a><span class="lineno"> 3110</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ucovgas[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>],ucovrad[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l03111"></a><span class="lineno"> 3111</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) ucovgas[jj]=uu0[UU+jj];</div>
<div class="line"><a name="l03112"></a><span class="lineno"> 3112</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) ucovrad[jj]=uu0[URAD0+jj];</div>
<div class="line"><a name="l03113"></a><span class="lineno"> 3113</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ucongas[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>],uconrad[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l03114"></a><span class="lineno"> 3114</span>&#160;    raise_vec(ucovgas,ptrgeom,ucongas);</div>
<div class="line"><a name="l03115"></a><span class="lineno"> 3115</span>&#160;    raise_vec(ucovrad,ptrgeom,uconrad);</div>
<div class="line"><a name="l03116"></a><span class="lineno"> 3116</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ugas=0.0;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) ugas+=ucovgas[jj]*ucongas[jj];</div>
<div class="line"><a name="l03117"></a><span class="lineno"> 3117</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> urad=0.0;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) urad+=ucovrad[jj]*uconrad[jj];</div>
<div class="line"><a name="l03118"></a><span class="lineno"> 3118</span>&#160;    <span class="comment">// t^t_\mu = T^t_\mu + \rho_0 u^t = uu0[UU+mu] : t^t_t = \rho_0 (1+u_t) u^t + (u_g+p_g) u^t u_t + p_g  = uu0[UU]</span></div>
<div class="line"><a name="l03119"></a><span class="lineno"> 3119</span>&#160;    <span class="comment">// R^t_\mu = uu[URAD0+mu]</span></div>
<div class="line"><a name="l03120"></a><span class="lineno"> 3120</span>&#160;    <span class="comment">// u_g &lt; rho u^2 and -u^t u_t &lt; |u| and \gamma_rad^2 &lt; |urad|</span></div>
<div class="line"><a name="l03121"></a><span class="lineno"> 3121</span>&#160;    <span class="comment">// these ensure gas internal energy is small</span></div>
<div class="line"><a name="l03122"></a><span class="lineno"> 3122</span>&#160;    <span class="comment">// u_g &lt; rho u^2 and </span></div>
<div class="line"><a name="l03123"></a><span class="lineno"> 3123</span>&#160;    iscoldflow = (pb[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]&lt;COLDFACTOR*pb[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>]*fabs(usq) &amp;&amp; fabs(ucongas[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>]*ucovgas[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>])&lt;COLDFACTOR*fabs(ugas) &amp;&amp; fabs(uconrad[TT]*ucovrad[TT])&lt;COLDFACTOR*fabs(urad));</div>
<div class="line"><a name="l03124"></a><span class="lineno"> 3124</span>&#160;  }</div>
<div class="line"><a name="l03125"></a><span class="lineno"> 3125</span>&#160;</div>
<div class="line"><a name="l03126"></a><span class="lineno"> 3126</span>&#160;</div>
<div class="line"><a name="l03127"></a><span class="lineno"> 3127</span>&#160;  <span class="keywordflow">return</span>(iscoldflow);</div>
<div class="line"><a name="l03128"></a><span class="lineno"> 3128</span>&#160;}</div>
<div class="line"><a name="l03129"></a><span class="lineno"> 3129</span>&#160;</div>
<div class="line"><a name="l03130"></a><span class="lineno"> 3130</span>&#160;<span class="keywordtype">int</span> isflowffde(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> FFDEFACTOR, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pb, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *q)</div>
<div class="line"><a name="l03131"></a><span class="lineno"> 3131</span>&#160;{</div>
<div class="line"><a name="l03132"></a><span class="lineno"> 3132</span>&#160;  <span class="keywordtype">int</span> isffdeflow=0;</div>
<div class="line"><a name="l03133"></a><span class="lineno"> 3133</span>&#160;</div>
<div class="line"><a name="l03134"></a><span class="lineno"> 3134</span>&#160;  <span class="comment">//#define FFDEFACTOR (1.0) // assume if here then desparate to avoid failure.  1.0 should be when only order unity errors.</span></div>
<div class="line"><a name="l03135"></a><span class="lineno"> 3135</span>&#160;</div>
<div class="line"><a name="l03136"></a><span class="lineno"> 3136</span>&#160;  <span class="keywordtype">int</span> jj;</div>
<div class="line"><a name="l03137"></a><span class="lineno"> 3137</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> usq=0.0;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) usq+=q-&gt;<a class="code" href="../../d1/d83/structof__state.html#aab723d3c7c2c48b7246cc7d7d5379eed">ucon</a>[jj]*q-&gt;<a class="code" href="../../d1/d83/structof__state.html#a09881c3d05809ef27f8115d02a835e11">ucov</a>[jj];</div>
<div class="line"><a name="l03138"></a><span class="lineno"> 3138</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> <a class="code" href="../../d1/d83/structof__state.html#a2b38c522ec7321af3368706fa4632834">bsq</a>=0.0;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) bsq+=q-&gt;<a class="code" href="../../d1/d83/structof__state.html#a9a5aa459c68ba51073dd9a245c1a7798">bcon</a>[jj]*q-&gt;<a class="code" href="../../d1/d83/structof__state.html#a60ad0baeb54ce3584309ba5567a72f41">bcov</a>[jj];</div>
<div class="line"><a name="l03139"></a><span class="lineno"> 3139</span>&#160;  <span class="comment">// u_g &lt;&lt; rho u^2</span></div>
<div class="line"><a name="l03140"></a><span class="lineno"> 3140</span>&#160;  <span class="comment">//  &amp;&amp; fabs(ucongas[TT]*ucovgas[TT])&lt;COLDFACTOR*fabs(ugas)</span></div>
<div class="line"><a name="l03141"></a><span class="lineno"> 3141</span>&#160;  isffdeflow = (pb[RHO]&lt;FFDEFACTOR*fabs(bsq) &amp;&amp;  pb[UU]&lt;FFDEFACTOR*fabs(bsq)); <span class="comment">// RE&lt;MAGE and IE&lt;MAGE</span></div>
<div class="line"><a name="l03142"></a><span class="lineno"> 3142</span>&#160;  isffdeflow = (isffdeflow &amp;&amp; (pb[RHO]+pb[UU])*fabs(usq) &lt; FFDEFACTOR*fabs(bsq)); <span class="comment">// KE&lt;MAGE</span></div>
<div class="line"><a name="l03143"></a><span class="lineno"> 3143</span>&#160;</div>
<div class="line"><a name="l03144"></a><span class="lineno"> 3144</span>&#160;</div>
<div class="line"><a name="l03145"></a><span class="lineno"> 3145</span>&#160;  return(isffdeflow);</div>
<div class="line"><a name="l03146"></a><span class="lineno"> 3146</span>&#160;}</div>
</div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Fri May 20 2016 15:52:35 for HARM by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.8.3.1
</small></address>
</body>
</html>
