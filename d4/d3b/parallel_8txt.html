<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.3.1"/>
<title>HARM: docs/parallel.txt File Reference</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">HARM
   </div>
   <div id="projectbrief">harm and utilities</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.3.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="../../search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">docs/parallel.txt File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><div class="fragment"><div class="line"></div>
<div class="line"></div>
<div class="line">MPI Notes</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">1) Generally probably need to avoid fork() or system() calls</div>
<div class="line">2) MPI-2 not fully supported on all systems, so ROMIO not fully supported</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">OpenMP Notes</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">1) Ensure all called functions do not use global variables or else shared and data collision is possible.</div>
<div class="line">This includes avoiding statically declared variables outside functions within a file.</div>
<div class="line">2) omp construct can only be used on each part of loop, not on a multi-loop macro.</div>
<div class="line">3) Use Intel(<a class="code" href="../../d8/d5b/defs_8general_8h.html#abf002e87ba3ed4d3c9dcc98216e6d9d6">R</a>) Thread Checker ?.? for Linux to check for OpenMP correctness.</div>
<div class="line">NOT perfect: Missed &quot;static <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> <a class="code" href="../../d8/d5b/defs_8general_8h.html#a93f06eb0b7c274f722a7e09d4861a941">hslope</a>&quot; in <a class="code" href="../../d9/de9/coord_8c.html#a041e7b005310415c97d90f4b8521ed1a" title="get X(i,j,k) CENT is default position in degenerate cases">coord</a>.c when outside function</div>
<div class="line"></div>
<div class="line">a) <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a4ebf7765a6bde079a76719b89d3033b6" title="add in source terms to equations of motion ui and dUriemann in UEVOLVE form assume q(pr) so consisten...">source</a> /opt/intel/itt/tcheck/bin/32e/tcheckvars.sh</div>
<div class="line">b) Compile code [for best results compile with -O -g</div>
<div class="line">and set to run a finite number of steps]</div>
<div class="line">c) tcheck_cl ./grmhd</div>
<div class="line">Then look are report for data race conditions</div>
<div class="line"></div>
<div class="line">4) On SMP systems, use less then total CPUs since basic system processes need some CPU time.  For example, with 1024 CPUs maybe use 1022.</div>
<div class="line">On MPP or clusters, probably ok to use all systems since each system has same basic processes.</div>
<div class="line"></div>
<div class="line">5) omp parallel construct should be far outside multi-dimen loops, with (e.g.) omp for construct on inner-most loop.</div>
<div class="line"></div>
<div class="line">6) use the guided or dynamic schedule when each thread might take substantially different amounts of time, like when doing inversion.  Some threads might hit failure regions and take a <span class="keywordtype">long</span> time.  Drawback is these have higher overheads (about 3X for chunk=10) compared to a static schedule.</div>
<div class="line"></div>
<div class="line">7) Unlike in a single thread, across threads avoid cache coherence if updating nearby memory.  This is a problem known as false sharing.  If one thread updates part of memory in cache, that invalidates that cache line forcing other threads to reget the cache line from memory.</div>
<div class="line"></div>
<div class="line">8) Note that if use pointer referencing outside parallel region and make that private (e.g. for *p2interp_l or *p2interp_r) inside the parallel region, then any prior pointer assignment is not preserved.  This is necessary since otherwise each thread would point to the same <a class="code" href="../../dc/dc2/f2c_8h.html#a27c1bdb0cba23a9db2a51eed7b3b2ac1">address</a>.  So one must reassign that pointer relationship inside the parallel region.</div>
<div class="line"></div>
<div class="line">9) For a 3D <a class="code" href="../../da/db2/global_8loops_8manypoints_8h.html#a8e8f11caf539de9555d07b4e7ef5b1da">LOOP</a>, if one wants to use &quot;nowait&quot;, one has to use the &quot;static&quot; schedule so that upon leaving one loop and entering another, the thread is given the same exact seqeuence of iteration numbers.  Also assumes the loops (is,ie,js,je,ks,ke, etc.) from one construct to another are identical!  In either case, otherwise, the data set on a prior loop won&#39;<a class="code" href="../../d8/d5b/defs_8general_8h.html#ae1ee1e1c83c3f70e2e1afed4f4f5b41e">t</a> be available for the new loop for any given thread.</div>
<div class="line">So can only use nowait if both static and loop structures are identical.  This is rare.  And indeed, if static used across multiple loop blocks, then unlikely to benefit from nowait since static forces uniformity of workload.  So unlikely to be big difference in timing to reach end of prior loops.</div>
<div class="line"></div>
<div class="line">One can where *can* use nowait is when fully independent accesses.  This occurs, for example, when only 1 3D loop, but exterior loop is a <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a8cbb473515f18fcae523329c93f140dc">DIMENLOOP</a>/<a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af276566d52b9239d67b094c949e15889" title="loop over directions">DIRLOOP</a>.  In this case, each entrance to the next loop writes to totally different memory regions that depend upon dir itself (e.g. fluxvec(dir)).</div>
<div class="line"></div>
<div class="line">Again, for &quot;nowait,&quot; must ensure that each loop does not use data written on previous loop.  If everything is independent, then &quot;nowait&quot; is ok.</div>
<div class="line"></div>
<div class="line">10) Note that &quot;static&quot; variables inside functions are global in scope, so unless constant forever are not thread safe.</div>
<div class="line">Typical &quot;static <span class="keywordtype">int</span> firsttime=1;  if(firsttime){ dosomething;firsttime=0;} cannot be used!</div>
<div class="line">See metric_tools.c:<a class="code" href="../../d6/d1b/metric_8tools_8c.html#af5438dd54272eb585ff5acb06d7195d4">matrix_inverse</a>() for example of how deal with this.</div>
<div class="line">Can&#39;<a class="code" href="../../d8/d5b/defs_8general_8h.html#ae1ee1e1c83c3f70e2e1afed4f4f5b41e">t</a> have static in reconstructeno.c for memories (is then performance hit?)</div>
<div class="line">tau_neededbyharm.c from f2c: MUST remove static in front of variables!</div>
<div class="line"></div>
<div class="line">Find these by doing: grep &quot;  static&quot; *.c *.h | less</div>
<div class="line"></div>
<div class="line">Apart from static variables inside functions, static variables global to a single file can be dangerous if ever written to with multiple threads.  For example, <a class="code" href="../../d9/de9/coord_8c.html#a041e7b005310415c97d90f4b8521ed1a" title="get X(i,j,k) CENT is default position in degenerate cases">coord</a>.c has many static variables, but these should never be set when many threads are calling the <a class="code" href="../../d9/de9/coord_8c.html#a041e7b005310415c97d90f4b8521ed1a" title="get X(i,j,k) CENT is default position in degenerate cases">coord</a>.c&#39;s functions.</div>
<div class="line"></div>
<div class="line">Find these by doing: grep &quot;^static&quot; *.c *.h | grep -v &quot;(&quot; | less</div>
<div class="line"></div>
<div class="line">Ensure that all uses of static are thread safe.</div>
<div class="line"></div>
<div class="line">11) Must also ensure that &quot;global variables&quot; that aren&#39;<a class="code" href="../../d8/d5b/defs_8general_8h.html#ae1ee1e1c83c3f70e2e1afed4f4f5b41e">t</a> static (can be floating around inside files like ranc.c had &quot;<span class="keywordtype">int</span> called&quot; as global, are either defined part of the global private or avoid global variable completely.</div>
<div class="line">Must check each file for such global varaibles.</div>
<div class="line">Use codenonfunc.sh and its extractnonfunc.c to help with this.</div>
<div class="line"></div>
<div class="line">12) OpenMP Overhead:</div>
<div class="line"></div>
<div class="line">Overhead on 64x32 calculation is about 22% with 78%=zcpsopenmp1core/zcps1core=38<a class="code" href="../../d8/d5b/defs_8general_8h.html#a33aba725064a95e4c33b25ccdc2504a9">K</a>/49<a class="code" href="../../d8/d5b/defs_8general_8h.html#a33aba725064a95e4c33b25ccdc2504a9">K</a> (<a class="code" href="../../d8/d5b/defs_8general_8h.html#ae202d8b69a0ef3f07651368c3de9ca25">TIMEORDER</a>==2 <a class="code" href="../../d8/d5b/defs_8general_8h.html#a11c4e99e1493d0c1914ad1ab313ea472">FLUXB</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a5014e44c6e710d8827ef79dd18abe6ad">FLUXCTTOTH</a>).</div>
<div class="line">Saw no difference between static and guided schedules.</div>
<div class="line">No changes for static chunk size from 10 to 20 to 400.</div>
<div class="line">Currently operate at 36% efficiency with 4 cores, while 22% per core overhead would lead to a total of 78% efficiency.</div>
<div class="line">So memory contention probably accounts for the other factor of 2-3X drop in efficiency.</div>
<div class="line"></div>
<div class="line">Related to this, if number of things in loop is small, then 1 CPU can be faster than using OpenMP because of the overhead of a parallel region being introduced.  One can use the &quot;if()&quot; after &quot;schedule&quot; to avoid using the pragma if a certain condition is met.</div>
<div class="line"></div>
<div class="line"><a class="code" href="../../d8/d60/init_8c.html#a07484107e6d9fdf38b53edf631d6511d">E</a>.g. <span class="preprocessor">#pragma omp parallel for private(i__3,i__,j) schedule(guided) if(blocksize&gt;100)</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">As above, I noticed 1 core going with OpenMP is 22% slower than no-OpenMP going.  So one could eliminate the <span class="keywordflow">for</span> loop pragma <span class="keyword">using</span>:</div>
<div class="line"><a class="code" href="../../d8/d60/init_8c.html#a07484107e6d9fdf38b53edf631d6511d">E</a>.g. #pragma omp parallel <span class="keywordflow">for</span> schedule(guided) if(<a class="code" href="../../dd/d46/mpidefs_8h.html#a96e8ac8e9ae4bd597638862a4f451129">numopenmpthreads</a>&gt;1)</div>
<div class="line">But we leave this out so that we can test OpenMP overhead since <a class="code" href="../../d9/d54/other6_8txt.html#ad3c086d13a326385668d92acdb4625a6">user</a> is not expected to choose only 1 thread.</div>
<div class="line"></div>
<div class="line">13) Volatile variable not allowed in parallel region since not thread safe.</div>
<div class="line"></div>
<div class="line">14) private() and firstprivate() have overhead, so better to use scope to contain local variables.</div>
<div class="line">See: http:<span class="comment">//portal.acm.org/citation.cfm?doid=563647.563656</span></div>
<div class="line">http:<span class="comment">//www.springerlink.com/content/680171t137073007/</span></div>
<div class="line"></div>
<div class="line">15) copyin() can incur a LARGE fixed/core overhead if copyin() a large amount of data relative to work done.  Hit is 25%/core right now and that&#39;s pretty bad.</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">Some related web resources for above comments</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">http:<span class="comment">//www.kernel.org/pub/linux/kernel/v2.6/</span></div>
<div class="line">http:<span class="comment">//perfmon.sourceforge.net/</span></div>
<div class="line">http:<span class="comment">//sourceforge.net/projects/perfmon/</span></div>
<div class="line">http:<span class="comment">//perfmon2.sourceforge.net/</span></div>
<div class="line">http:<span class="comment">//perfmon2.sourceforge.net/</span></div>
<div class="line">http:<span class="comment">//perfsuite.ncsa.uiuc.edu/</span></div>
<div class="line">https:<span class="comment">//andrzejn.web.cern.ch/andrzejn/</span></div>
<div class="line">http:<span class="comment">//www.cyberciti.biz/tips/compiling-linux-kernel-26.html</span></div>
<div class="line">http:<span class="comment">//www.linuxhq.com/patch-howto.html</span></div>
<div class="line">https:<span class="comment">//andrzejn.web.cern.ch/andrzejn/#software</span></div>
<div class="line">http:<span class="comment">//www.eventhelix.com/RealtimeMantra/Basics/OptimizingCAndCPPCode.htm</span></div>
<div class="line">http:<span class="comment">//www.openwatcom.org/index.php/Performance_tuning</span></div>
<div class="line">http:<span class="comment">//www.netlib.org/eispack/</span></div>
<div class="line">http:<span class="comment">//icl.cs.utk.edu/lapack-forum/viewtopic.php?f=2&amp;t=178&amp;start=0&amp;st=0&amp;sk=t&amp;sd=a</span></div>
<div class="line">http:<span class="comment">//docs.hp.com/en/B3906-90006/index.html</span></div>
<div class="line">http:<span class="comment">//www.kde.org/</span></div>
<div class="line">http:<span class="comment">//sourceforge.net/projects/perfctr/</span></div>
<div class="line">http:<span class="comment">//perfmon2.sourceforge.net/pfmon_usersguide.html</span></div>
<div class="line">http:<span class="comment">//www.linuxjournal.com/article/7468</span></div>
<div class="line">http:<span class="comment">//brittany.nmsu.edu/~nmcac-intel/vtune/doc/users_guide/mergedProjects/analyzer_ec/mergedProjects/reference_olh/pentium4_hh/advice4_hh/dtlb_page_walk_misses.htm</span></div>
<div class="line">http:<span class="comment">//brittany.nmsu.edu/~nmcac-intel/vtune/doc/users_guide/mergedProjects/analyzer_ec/mergedProjects/reference_olh/pentium4_hh/advice4_hh/avoiding_dtlb_page_walk_misses.htm</span></div>
<div class="line">http:<span class="comment">//www.delorie.com/gnu/docs/binutils/gprof_25.html</span></div>
<div class="line">http:<span class="comment">//www.intel.com/software/products/mkl/data/vml/functions/pow.html</span></div>
<div class="line">http:<span class="comment">//www.eventhelix.com/RealtimeMantra/Basics/OptimizingCAndCPPCode.htm</span></div>
<div class="line">http:<span class="comment">//www.devx.com/SpecialReports/Door/40893</span></div>
<div class="line">http:<span class="comment">//www.ncsa.uiuc.edu/UserInfo/Resources/Software/Tools/PAPI/</span></div>
<div class="line">http:<span class="comment">//en.wikipedia.org/wiki/FLOPS</span></div>
<div class="line">http:<span class="comment">//www.maxxpi.net/pages/result-browser/top10---flops.php</span></div>
<div class="line">http:<span class="comment">//gcc.gnu.org/onlinedocs/cpp/Macros.html</span></div>
<div class="line">http:<span class="comment">//jamesthornton.com/emacs/node/emacs_97.html</span></div>
<div class="line">http:<span class="comment">//xahlee.org/emacs/find_replace_inter.html</span></div>
<div class="line">http:<span class="comment">//www.cs.utah.edu/dept/old/texinfo/emacs18/emacs_20.html</span></div>
<div class="line">http:<span class="comment">//www.emacswiki.org/emacs/SearchBuffers</span></div>
<div class="line">http:<span class="comment">//www.gnu.org/software/emacs/emacs-lisp-intro/html_node/emacs.html#Tags</span></div>
<div class="line">http:<span class="comment">//analyser.oli.tudelft.nl/regex/</span></div>
<div class="line">http:<span class="comment">//funarg.nfshost.com/r2/notes/sed-return-comma.html</span></div>
<div class="line">http:<span class="comment">//soft.zoneo.net/Linux/remove_empty_lines.php</span></div>
<div class="line">http:<span class="comment">//software.intel.com/en-us/articles/non-commercial-software-download/</span></div>
<div class="line">http:<span class="comment">//publib.boulder.ibm.com/infocenter/lnxpcomp/v7v91/index.jsp?topic=/com.ibm.vacpp7l.doc/language/ref/clrc09numnum.htm</span></div>
<div class="line">http:<span class="comment">//www.developers.net/intelisnshowcase/view/2180</span></div>
<div class="line">http:<span class="comment">//software.intel.com/en-us/intel-vtune/</span></div>
</div><!-- fragment --> 
<p>Definition in file <a class="el" href="../../d4/d3b/parallel_8txt_source.html">parallel.txt</a>.</p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Fri May 20 2016 15:52:36 for HARM by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.8.3.1
</small></address>
</body>
</html>
