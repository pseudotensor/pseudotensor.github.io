<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.3.1"/>
<title>HARM: phys.tools.rad.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">HARM
   </div>
   <div id="projectbrief">harm and utilities</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.3.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="../../search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">phys.tools.rad.c</div>  </div>
</div><!--header-->
<div class="contents">
<a href="../../d2/d72/phys_8tools_8rad_8c.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">// __WORKINGONIT__ indicates what still in development</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment">// KORALTODO: B Not setup for iter=0 2 1 0 : 1 2 : 3 13 : 14 200 : 14</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;</div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;</div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment">// KORALTODO:</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;</div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="comment">/* 1) Reorder URAD method so: */</span></div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;</div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="comment">/* a) URAD */</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="comment">/* b) URAD-&gt;PRAD */</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="comment">/* c) Re-get URAD(PRAD) in case floors/ceilings */</span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="comment">/* d) Apply relative 4-force condition using this new URAD -&gt; UGAS */</span></div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="comment">/* e) UGAS-&gt;PGAS */</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="comment">/* f) Re-get UGAS(PGAS) in case floors/celings/failures/errors/etc. */</span></div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;</div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="comment">/* As long as MHD doesn&#39;t fail, then even if RAD hits ceilings, the solution will be in relative force balance. -- i.e. total energy-momentum conservation will hold despite change in URAD. */</span></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;</div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="comment">/* Right now, I use pre-corrected URAD to get dUrad -&gt; dUgas, so if rad hits ceilings while gas does not, then relative force balance is lost when could have been maintained. */</span></div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;</div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="comment">/* Need to have Utoprimgen() call without doing radiation inversion to save time .. doradonly=-1 ? */</span></div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;</div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;</div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;</div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;</div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;</div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="comment">// include globals</span></div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="preprocessor">#include &quot;decs.h&quot;</span></div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;</div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;</div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;</div>
<div class="line"><a name="l00042"></a><span class="lineno"><a class="code" href="../../d6/dbe/structof__method.html">   42</a></span>&#160;<span class="keyword">struct </span><a class="code" href="../../d6/dbe/structof__method.html">of_method</a> {</div>
<div class="line"><a name="l00043"></a><span class="lineno"><a class="code" href="../../d6/dbe/structof__method.html#a33c830fa7eebdff213d545dc3f897cc1">   43</a></span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d6/dbe/structof__method.html#a33c830fa7eebdff213d545dc3f897cc1">iter</a>; <span class="comment">// input</span></div>
<div class="line"><a name="l00044"></a><span class="lineno"><a class="code" href="../../d6/dbe/structof__method.html#ad41cdab07476d4758111fbba2c38992b">   44</a></span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d6/dbe/structof__method.html#ad41cdab07476d4758111fbba2c38992b">eomtype</a>; <span class="comment">// input(can be output)</span></div>
<div class="line"><a name="l00045"></a><span class="lineno"><a class="code" href="../../d6/dbe/structof__method.html#af0a282a5d53c166161403727e4eebedd">   45</a></span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d6/dbe/structof__method.html#af0a282a5d53c166161403727e4eebedd">itermode</a>; <span class="comment">// input</span></div>
<div class="line"><a name="l00046"></a><span class="lineno"><a class="code" href="../../d6/dbe/structof__method.html#af9701d4b045bb8d565d534e2c7191fc2">   46</a></span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d6/dbe/structof__method.html#af9701d4b045bb8d565d534e2c7191fc2">baseitermethod</a>; <span class="comment">// input</span></div>
<div class="line"><a name="l00047"></a><span class="lineno"><a class="code" href="../../d6/dbe/structof__method.html#adb6ab1938e587bff358f9a9666a8b831">   47</a></span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> <a class="code" href="../../d6/dbe/structof__method.html#adb6ab1938e587bff358f9a9666a8b831">fracenergy</a>; <span class="comment">// input</span></div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dissmeasure; <span class="comment">// input</span></div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;  <span class="comment">// outsputs</span></div>
<div class="line"><a name="l00051"></a><span class="lineno"><a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">   51</a></span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>;</div>
<div class="line"><a name="l00052"></a><span class="lineno"><a class="code" href="../../d6/dbe/structof__method.html#a2c5c387f7161b69aad77ee5a13d30c68">   52</a></span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d6/dbe/structof__method.html#a2c5c387f7161b69aad77ee5a13d30c68">implicitferr</a>;</div>
<div class="line"><a name="l00053"></a><span class="lineno"><a class="code" href="../../d6/dbe/structof__method.html#ab82f125cc45b1d2881155d70795fbf8a">   53</a></span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d6/dbe/structof__method.html#ab82f125cc45b1d2881155d70795fbf8a">BEGINMOMSTEPS</a>;</div>
<div class="line"><a name="l00054"></a><span class="lineno"><a class="code" href="../../d6/dbe/structof__method.html#a854fcca7e3e1d7ab0a6955321ce698de">   54</a></span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d6/dbe/structof__method.html#a854fcca7e3e1d7ab0a6955321ce698de">ENDMOMSTEPS</a>;</div>
<div class="line"><a name="l00055"></a><span class="lineno"><a class="code" href="../../d6/dbe/structof__method.html#a6412a5671687f2d9f5be2fd0fafb81f1">   55</a></span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d6/dbe/structof__method.html#a6412a5671687f2d9f5be2fd0fafb81f1">BEGINENERGYSTEPS</a>;</div>
<div class="line"><a name="l00056"></a><span class="lineno"><a class="code" href="../../d6/dbe/structof__method.html#a9829068ffbaa124dda46be28c48bfccc">   56</a></span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d6/dbe/structof__method.html#a9829068ffbaa124dda46be28c48bfccc">ENDENERGYSTEPS</a>;</div>
<div class="line"><a name="l00057"></a><span class="lineno"><a class="code" href="../../d6/dbe/structof__method.html#a73849808a0b3a900c373b244089eab1f">   57</a></span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d6/dbe/structof__method.html#a73849808a0b3a900c373b244089eab1f">BEGINFULLSTEPS</a>;</div>
<div class="line"><a name="l00058"></a><span class="lineno"><a class="code" href="../../d6/dbe/structof__method.html#acda8029c6baa1a6f01a7f60bbe748ebb">   58</a></span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d6/dbe/structof__method.html#acda8029c6baa1a6f01a7f60bbe748ebb">ENDFULLSTEPS</a>;</div>
<div class="line"><a name="l00059"></a><span class="lineno"><a class="code" href="../../d6/dbe/structof__method.html#a95212a0a740e95e0e2cc94cc9f4d0f7d">   59</a></span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d6/dbe/structof__method.html#a95212a0a740e95e0e2cc94cc9f4d0f7d">BEGINNORMALSTEPS</a>;</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;};</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;</div>
<div class="line"><a name="l00062"></a><span class="lineno"><a class="code" href="../../d2/d46/structof__ref_u.html">   62</a></span>&#160;<span class="keyword">struct </span><a class="code" href="../../d2/d46/structof__ref_u.html">of_refU</a> {</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;  <span class="comment">// inputs</span></div>
<div class="line"><a name="l00064"></a><span class="lineno"><a class="code" href="../../d2/d46/structof__ref_u.html#a4ba6cd7d959ee1b393f8b18d1d638b90">   64</a></span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d2/d46/structof__ref_u.html#a4ba6cd7d959ee1b393f8b18d1d638b90">implicititer</a>;</div>
<div class="line"><a name="l00065"></a><span class="lineno"><a class="code" href="../../d2/d46/structof__ref_u.html#acfcd871cbe4f2a3c77d5ce0923e65db8">   65</a></span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d2/d46/structof__ref_u.html#acfcd871cbe4f2a3c77d5ce0923e65db8">implicitferr</a>;</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;  <span class="comment">// outputs</span></div>
<div class="line"><a name="l00068"></a><span class="lineno"><a class="code" href="../../d2/d46/structof__ref_u.html#a375d87568d49a0e8f43a7b2a756dcb8b">   68</a></span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d2/d46/structof__ref_u.html#a375d87568d49a0e8f43a7b2a756dcb8b">numdims</a>; <span class="comment">// not used yet</span></div>
<div class="line"><a name="l00069"></a><span class="lineno"><a class="code" href="../../d2/d46/structof__ref_u.html#a9f3d856dcdd8fa240dfbdcedfad888ef">   69</a></span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d2/d46/structof__ref_u.html#a9f3d856dcdd8fa240dfbdcedfad888ef">startjac</a>;</div>
<div class="line"><a name="l00070"></a><span class="lineno"><a class="code" href="../../d2/d46/structof__ref_u.html#af67164c1a42e2aefe0603597dd2ea25e">   70</a></span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d2/d46/structof__ref_u.html#af67164c1a42e2aefe0603597dd2ea25e">endjac</a>;</div>
<div class="line"><a name="l00071"></a><span class="lineno"><a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">   71</a></span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l00072"></a><span class="lineno"><a class="code" href="../../d2/d46/structof__ref_u.html#a841d43603fddda5fbcbc03d6b2f544de">   72</a></span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d2/d46/structof__ref_u.html#a841d43603fddda5fbcbc03d6b2f544de">iotherU</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l00073"></a><span class="lineno"><a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">   73</a></span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l00074"></a><span class="lineno"><a class="code" href="../../d2/d46/structof__ref_u.html#a084a661289c751902d6b9451343647a3">   74</a></span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d2/d46/structof__ref_u.html#a084a661289c751902d6b9451343647a3">eotherU</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l00075"></a><span class="lineno"><a class="code" href="../../d2/d46/structof__ref_u.html#aced783637d9ae9182ae10b44fcbac284">   75</a></span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> <a class="code" href="../../d2/d46/structof__ref_u.html#aced783637d9ae9182ae10b44fcbac284">signgd2</a>;</div>
<div class="line"><a name="l00076"></a><span class="lineno"><a class="code" href="../../d2/d46/structof__ref_u.html#a987d9cab27e21984bd25b825e523058e">   76</a></span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> <a class="code" href="../../d2/d46/structof__ref_u.html#a987d9cab27e21984bd25b825e523058e">signgd4</a>;</div>
<div class="line"><a name="l00077"></a><span class="lineno"><a class="code" href="../../d2/d46/structof__ref_u.html#a156b044c75cffc015e7228257f9924b5">   77</a></span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> <a class="code" href="../../d2/d46/structof__ref_u.html#a156b044c75cffc015e7228257f9924b5">signgd6</a>;</div>
<div class="line"><a name="l00078"></a><span class="lineno"><a class="code" href="../../d2/d46/structof__ref_u.html#ac1d5c40ee4d532cac343c1792e17c076">   78</a></span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> <a class="code" href="../../d2/d46/structof__ref_u.html#ac1d5c40ee4d532cac343c1792e17c076">signgd7</a>;</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;};</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;<span class="comment">// BEGIN: f2c stuff for Ramesh&#39;s solver code in fortran</span></div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../dc/dc2/f2c_8h.html" title="Standard Fortran to C header file.">f2c.h</a>&quot;</span></div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;<span class="preprocessor">#ifdef KR_headers</span></div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;<span class="preprocessor"></span><span class="keywordtype">double</span> <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a036eaeafe10ab8a86b900e4e7ed6d2ca" title="f2c prototype">d_sign</a>(aa,bb) <a class="code" href="../../dc/dc2/f2c_8h.html#a1e69afaa4e6077b67397e6c36454b97a">doublereal</a> *aa, *bb;</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00096"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a036eaeafe10ab8a86b900e4e7ed6d2ca">   96</a></span>&#160;<span class="preprocessor"></span><span class="keywordtype">double</span> <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a036eaeafe10ab8a86b900e4e7ed6d2ca" title="f2c prototype">d_sign</a>(<a class="code" href="../../dc/dc2/f2c_8h.html#a1e69afaa4e6077b67397e6c36454b97a">doublereal</a> *aa, <a class="code" href="../../dc/dc2/f2c_8h.html#a1e69afaa4e6077b67397e6c36454b97a">doublereal</a> *bb)</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;<span class="preprocessor"></span>{</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;<span class="keywordtype">double</span> x;</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;x = (*aa &gt;= 0 ? *aa : - *aa);</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;<span class="keywordflow">return</span>( *bb &gt;= 0 ? x : -x);</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;}</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;<span class="preprocessor">#ifdef KR_headers</span></div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;<span class="preprocessor"></span><span class="comment">//double floor();</span></div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;<a class="code" href="../../dc/dc2/f2c_8h.html#a99e088ad9e1bf72a6c0e148a6c2b7012" title="barf [ba:rf] 2.">integer</a> <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad3999e6bfafaead009c340203d8536c4">i_dnnt</a>(x) <a class="code" href="../../dc/dc2/f2c_8h.html#a1e69afaa4e6077b67397e6c36454b97a">doublereal</a> *x;</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;<span class="preprocessor"></span>                  <span class="comment">//#undef abs</span></div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;                  <span class="comment">//#include &quot;math.h&quot;</span></div>
<div class="line"><a name="l00110"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad3999e6bfafaead009c340203d8536c4">  110</a></span>&#160;<a class="code" href="../../dc/dc2/f2c_8h.html#a99e088ad9e1bf72a6c0e148a6c2b7012" title="barf [ba:rf] 2.">integer</a> <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad3999e6bfafaead009c340203d8536c4">i_dnnt</a>(<a class="code" href="../../dc/dc2/f2c_8h.html#a1e69afaa4e6077b67397e6c36454b97a">doublereal</a> *x)</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;<span class="preprocessor"></span>{</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;<span class="keywordflow">return</span>( (*x)&gt;=0 ?</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;        floor(*x + .5) : -floor(.5 - *x) );</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;}</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;</div>
<div class="line"><a name="l00117"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a2338ea9f011a6e931066393738d9153f">  117</a></span>&#160;<span class="preprocessor">#define MYEXTERN extern</span></div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;<span class="preprocessor">#ifdef KR_headers</span></div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;<span class="preprocessor"></span><span class="keyword">extern</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aef4839e129da1a151079fb1831472702">f_exit</a>();</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;<span class="keywordtype">int</span> <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a14cafc71f84f7135136caea853550f45">s_stop</a>(s, n) char *s; <a class="code" href="../../dc/dc2/f2c_8h.html#a2ad57b5f7f73e0131623aa6dbff6d3f3">ftnlen</a> n;</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#undef abs</span></div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#undef min</span></div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#undef max</span></div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#include &quot;stdlib.h&quot;</span></div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;<span class="preprocessor">#ifdef __cplusplus</span></div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;<span class="preprocessor"></span><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a2338ea9f011a6e931066393738d9153f">MYEXTERN</a> <span class="stringliteral">&quot;C&quot;</span> {</div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#ifdef __cplusplus</span></div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;<span class="preprocessor"></span><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a2338ea9f011a6e931066393738d9153f">MYEXTERN</a> <span class="stringliteral">&quot;C&quot;</span> {</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;<span class="preprocessor"></span><span class="keywordtype">void</span> <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aef4839e129da1a151079fb1831472702">f_exit</a>(<span class="keywordtype">void</span>);</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;</div>
<div class="line"><a name="l00135"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a14cafc71f84f7135136caea853550f45">  135</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a14cafc71f84f7135136caea853550f45">s_stop</a>(<span class="keywordtype">char</span> *s, <a class="code" href="../../dc/dc2/f2c_8h.html#a2ad57b5f7f73e0131623aa6dbff6d3f3">ftnlen</a> n)</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;<span class="preprocessor"></span>{</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;<span class="keywordtype">int</span> <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>;</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;<span class="keywordflow">if</span>(n &gt; 0)</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;        {</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;        fprintf(stderr, <span class="stringliteral">&quot;STOP &quot;</span>);</div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;        <span class="keywordflow">for</span>(i = 0; i&lt;n ; ++<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>)</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;                putc(*s++, stderr);</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;        fprintf(stderr, <span class="stringliteral">&quot; statement executed\n&quot;</span>);</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;        }</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;<span class="preprocessor">#ifdef NO_ONEXIT</span></div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;<span class="preprocessor"></span><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aef4839e129da1a151079fb1831472702">f_exit</a>();</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;<span class="preprocessor"></span>exit(0);</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;<span class="comment">/* We cannot avoid (useless) compiler diagnostics here:         */</span></div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;<span class="comment">/* some compilers complain if there is no return statement,     */</span></div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;<span class="comment">/* and others complain that this one cannot be reached.         */</span></div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;</div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;<span class="keywordflow">return</span> 0; <span class="comment">/* NOT REACHED */</span></div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;}</div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;<span class="preprocessor">#ifdef __cplusplus</span></div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;<span class="preprocessor"></span>}</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#ifdef __cplusplus</span></div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;<span class="preprocessor"></span>}</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;<span class="comment">// pow_dd()</span></div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;<span class="preprocessor">#ifdef KR_headers</span></div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;<span class="preprocessor"></span><span class="keywordtype">double</span> pow();</div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;<span class="keywordtype">double</span> <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a67537b759f1cfaa9e6193806cbcfc33a">pow_dd</a>(ap, bp) <a class="code" href="../../dc/dc2/f2c_8h.html#a1e69afaa4e6077b67397e6c36454b97a">doublereal</a> *ap, *bp;</div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#undef abs</span></div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#include &quot;math.h&quot;</span></div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;<span class="preprocessor">#ifdef __cplusplus</span></div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;<span class="preprocessor"></span><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a2338ea9f011a6e931066393738d9153f">MYEXTERN</a> <span class="stringliteral">&quot;C&quot;</span> {</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00175"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a67537b759f1cfaa9e6193806cbcfc33a">  175</a></span>&#160;<span class="preprocessor"></span><span class="keywordtype">double</span> <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a67537b759f1cfaa9e6193806cbcfc33a">pow_dd</a>(<a class="code" href="../../dc/dc2/f2c_8h.html#a1e69afaa4e6077b67397e6c36454b97a">doublereal</a> *ap, <a class="code" href="../../dc/dc2/f2c_8h.html#a1e69afaa4e6077b67397e6c36454b97a">doublereal</a> *bp)</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;<span class="preprocessor"></span>{</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;<span class="keywordflow">return</span>(pow(*ap, *bp) );</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;}</div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;<span class="preprocessor">#ifdef __cplusplus</span></div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;<span class="preprocessor"></span>}</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;</div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;<span class="preprocessor">#include &quot;testfpp.P&quot;</span></div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;<span class="comment">// not linking with libf2c since don&#39;t want that dependence and conversion doesn&#39;t need it since the original code was simple</span></div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;<span class="keywordtype">int</span> get_rameshsolution(<span class="keywordtype">int</span> whichcall, <span class="keywordtype">int</span> radinvmod, <span class="keywordtype">int</span> failtype, <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> failnum, <span class="keywordtype">int</span> gotfirstnofail, <span class="keywordtype">int</span> eomtypelocal, <span class="keywordtype">int</span> itermode, <span class="keywordtype">int</span> baseitermethod, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *errorabs, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *errorabsbestexternal, <span class="keywordtype">int</span> iters, <span class="keywordtype">int</span> totaliters, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> realdt, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pp, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pb, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *piin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *uu0, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *uu, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Uiin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ufin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUf, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUimp, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *q, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *ppeng, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *ppent, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *uueng, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *uuent, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *qeng, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *qent, <span class="keywordtype">int</span> *failtypeeng, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *errorabseng, <span class="keywordtype">int</span> *iterseng, <span class="keywordtype">int</span> *radinvmodeng, <span class="keywordtype">int</span> *failtypeent, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *errorabsent, <span class="keywordtype">int</span> *itersent, <span class="keywordtype">int</span> *radinvmodent);</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;<span class="keywordtype">int</span> get_rameshsolution_wrapper(<span class="keywordtype">int</span> whichcall, <span class="keywordtype">int</span> eomtype, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *errorabs, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pp, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *piin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Uiin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ufin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *dUother, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUf, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUimp, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *q, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *ppeng, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *ppent, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *uueng, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *uuent, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*dUcompeng)[NPR], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*dUcompent)[NPR], <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *qeng, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *qent, <span class="keywordtype">int</span> *failtypeeng, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *errorabseng, <span class="keywordtype">int</span> *iterseng, <span class="keywordtype">int</span> *radinvmodeng, <span class="keywordtype">int</span> *failtypeent, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *errorabsent, <span class="keywordtype">int</span> *itersent, <span class="keywordtype">int</span> *radinvmodent);</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;<span class="comment">// END: f2c stuff for Ramesh&#39;s solver code in fortran</span></div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;</div>
<div class="line"><a name="l00199"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9aa23a9a2b28d2c91e90a06c0025e91f">  199</a></span>&#160;<span class="preprocessor">#define PLOOPDYNAMICAL(pliter,pl) PLOOP(pliter,pl) if(SCALARPL(pl)==0)</span></div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;<span class="comment">// Local options (used to be in global.nondepmnemonics.rad.h)</span></div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00208"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a1f582d2dfcca528d70f908cc28394cc9">  208</a></span>&#160;<span class="preprocessor">#define AVOIDTAUFORFLOOR (1) // whether to apply optical depth calculation for floor (0) or not (1)</span></div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;</div>
<div class="line"><a name="l00211"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a05e8058a59ca22b59a8409813e650033">  211</a></span>&#160;<span class="preprocessor">#define COURRADEXPLICIT (0.1) // Effective Courant-like factor for stiff explicit radiation source term.  Required to not only avoid failure of explicit scheme, but also that explicit scheme is really accurate compared to implicit.  E.g., near \tau\sim 1, explicit won&#39;t fail with RADPULSEPLANAR but will not give same results as implicit.  So only use explicit if really in optically thin regime.</span></div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;</div>
<div class="line"><a name="l00215"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9e65ef9ae41cb84b2aabaacf7897439a">  215</a></span>&#160;<span class="preprocessor">#define IMPTRYCONVHIGHTAU (NUMEPSILON*5.0)  // for used implicit solver</span></div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;<span class="preprocessor">#if(DOPERF)</span></div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define IMPTRYCONV (1.e-9) // less greedy so doesn&#39;t slow things down so much.</span></div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#else</span></div>
<div class="line"><a name="l00221"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afc9b116343212081b674a39ac69ce6ed">  221</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define IMPTRYCONV (1.e-12) // works generally to avoid high iterations</span></div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00223"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a1ed8230cb4aee8a0c35a93613b5abcdd">  223</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define IMPTRYCONVQUICK (1.e-6) // even less greedy so doesn&#39;t slow things down so much.</span></div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;<span class="preprocessor">#if(DOPERF)</span></div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define ITERATIONMARGINAL2 (4)</span></div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define IMPTRYCONVMARGINAL2 (1.e-5) // even less greedy so doesn&#39;t slow things down so much.</span></div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#else</span></div>
<div class="line"><a name="l00229"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a0cea9304b0ed59b809486aae51f7bae4">  229</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define ITERATIONMARGINAL2 (4)</span></div>
<div class="line"><a name="l00230"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a14a313e984d9d1e9a7cc3a4cf0ada803">  230</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define IMPTRYCONVMARGINAL2 (1.e-6) // even less greedy so doesn&#39;t slow things down so much.</span></div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00233"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a2970b7302296037943041f82a6cb59fc">  233</a></span>&#160;<span class="preprocessor">#define IMPTRYCONVMARGINAL (1.e-6) // even less greedy so doesn&#39;t slow things down so much.</span></div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00235"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ac5e04595551dd07bf6f57b21d5911e81">  235</a></span>&#160;<span class="preprocessor">#define IMPTRYCONVSUPERQUICK (1.e-3) // even less greedy so doesn&#39;t slow things down so much.</span></div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00237"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a37aa5c4b7b1b481299d87bf929d13b15">  237</a></span>&#160;<span class="preprocessor">#define IMPTRYCONVABS ((FTYPE)(NDIM+2)*trueimptryconv)</span></div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;<span class="comment">//#define IMPOKCONVCONST (1E-9)</span></div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;</div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;<span class="comment">// ensure energy conservation equation used as much as possible</span></div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;<span class="comment">//#define IMPALLOWCONVCONST (1.e-7)</span></div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;<span class="comment">//#define IMPALLOWCONVCONST (1.e-6)</span></div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;<span class="comment">//#define IMPALLOWCONVCONST (1.e-5)</span></div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;<span class="preprocessor">#if(DOPERF)</span></div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define IMPALLOWCONVCONST (1.e-3)</span></div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define IMPOKCONVCONST (1E-4) // even more likely to use energy solution</span></div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#else</span></div>
<div class="line"><a name="l00252"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab1ad1aee2202922457a377be53918cdc">  252</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define IMPALLOWCONVCONST (1.e-5)</span></div>
<div class="line"><a name="l00253"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a03803ff5190d70024aafd3b27bfa2f61">  253</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define IMPOKCONVCONST (1E-6) // even more likely to use energy solution</span></div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;</div>
<div class="line"><a name="l00257"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a139b264979cff6af5a6274b4decea1d3">  257</a></span>&#160;<span class="preprocessor">#define IMPOKCONVCONSTABS ((FTYPE)(NDIM+2)*IMPOKCONVCONST)</span></div>
<div class="line"><a name="l00258"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#af7b72bf07e905af920a80341cad3ec60">  258</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define IMPOKCONV (MAX(trueimptryconv,IMPOKCONVCONST))</span></div>
<div class="line"><a name="l00259"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a0beb933bdd5a874f9fcada46b302fbff">  259</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define IMPOKCONVABS ((FTYPE)(NDIM+2)*IMPOKCONV)</span></div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;</div>
<div class="line"><a name="l00262"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8469a53eb25c0eb3b81286c364d0e7f3">  262</a></span>&#160;<span class="preprocessor">#define IMPALLOWCONVCONSTABS ((FTYPE)(NDIM+2)*IMPALLOWCONVCONST)</span></div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;<span class="preprocessor"></span><span class="comment">//#define IMPALLOWCONV (MAX(trueimptryconv,IMPALLOWCONVCONST))</span></div>
<div class="line"><a name="l00264"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aed356d684bdfb542015fcc82d0b8e46f">  264</a></span>&#160;<span class="preprocessor">#define IMPALLOWCONV (trueimpallowconv)</span></div>
<div class="line"><a name="l00265"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a24fc3f1731c370d6d2ffc3ad422e54ca">  265</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define IMPALLOWCONV2 (IMPALLOWCONV)</span></div>
<div class="line"><a name="l00266"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a87254fbd4e77d25faf8405ae2dfbd70c">  266</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define IMPALLOWCONVABS ((FTYPE)(NDIM+2)*IMPALLOWCONV)</span></div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;<span class="comment">//#define IMPBADENERGY (MIN(IMPALLOWCONV,1E-7))</span></div>
<div class="line"><a name="l00270"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a7c65c2d72d332ecc46dec0a183962ba2">  270</a></span>&#160;<span class="preprocessor">#define IMPBADENERGY (MIN(IMPALLOWCONV,1E-6))</span></div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;<span class="comment">// what optical depth in a cell to say below which can use allowed tolerance, to speed things up.</span></div>
<div class="line"><a name="l00273"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ccd98422074e3018295182279a0df12">  273</a></span>&#160;<span class="preprocessor">#define TAUTOTMAXHIGHERTOL (-1.0) // i.e. avoid this</span></div>
<div class="line"><a name="l00274"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a4dab6e92e4bf6573af2e54f9f924fcc7">  274</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define IMPTRYCONV_TAUTOTMAXHIGHERTOL (1E-4)</span></div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;<span class="comment">// tolerances tried and allowed based upon position (sometimes commented out in _mode() function)</span></div>
<div class="line"><a name="l00277"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab5b05126c0523108ae6f88d4131a6308">  277</a></span>&#160;<span class="preprocessor">#define IMPTRYCONV_RHORHIGHERTOL (1E-3) // (leads to transition)</span></div>
<div class="line"><a name="l00278"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#adfc141d6141c97938025b106e5c2484f">  278</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define IMPTRYCONV_ROUTERHIGHERTOL (1E-3) // good to have since don&#39;t care about outer region with OUTERDEATH</span></div>
<div class="line"><a name="l00279"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a69f5311b52c9fce4441c9ded33d86184">  279</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define IMPALLOWCONV_RHORHIGHERTOL (1E-2) // allow lower tol inside horizon to avoid failures (but leads to transition)  NOTEMARK: Probably don&#39;t want this &gt;1/BSQORHOLIMIT else rho will be in error by more than order unity just from G, which may be limit of acceptability.  u will be in error much more likely, but u driven by Comptonization often so by thermal equilibrium.</span></div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;</div>
<div class="line"><a name="l00283"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a27e05682d00f225ce495d59dc3e140ca">  283</a></span>&#160;<span class="preprocessor">#define ITERMHDINVTRYHARDER 5</span></div>
<div class="line"><a name="l00284"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9246a73614335644963eb4e47ec0de8c">  284</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define MINTRYCONVFORMHDINVERSION (1E-4) // assume not failure if got down to this much. -- don&#39;t have to be related to implicit allowance.</span></div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;</div>
<div class="line"><a name="l00288"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a02e53f4aca74277f18558720aba22d26">  288</a></span>&#160;<span class="preprocessor">#define ABORTBACKUPIFNOERRORREDUCE 1</span></div>
<div class="line"><a name="l00289"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a3251670ff8087f873c6cac91ca50b16d">  289</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define IMPTRYCONVALT (MAX(1E-8,IMPTRYCONVABS)) // say that if error isn&#39;t reducing, ok to abort with this error.   Only time saver, but realistic about likelihood of getting smaller error.</span></div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00292"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a62f93a82af6febdabb986b5cc9062449">  292</a></span>&#160;<span class="preprocessor">#define IMPTRYDAMPCONV (5.0*IMPTRYCONVABS)</span></div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;</div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;</div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;</div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;<span class="preprocessor">#if(REALTYPE==FLOATTYPE)</span></div>
<div class="line"><a name="l00305"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a900fca7c5effa733d936e1954b7192ee">  305</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define IMPEPSLARGE (1E-4) // on small side</span></div>
<div class="line"><a name="l00306"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aecad06ce06434289996654bfa987edbb">  306</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define IMPEPSSMALL (1E-4) // on small side</span></div>
<div class="line"><a name="l00307"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a619a303605d8ee1dbb98c199c988f275">  307</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define ERRORFORIMPEPSSMALL (1E-5)</span></div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#elif(REALTYPE==DOUBLETYPE)</span></div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define IMPEPSLARGE (1E-8) // Was 1E-6 (see next line)</span></div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define IMPEPSSMALL (1E-10) // Was 1E-7 (but with PMHD method and disk-jet problem, led to very often not getting solution.  Not sure why)</span></div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;<span class="preprocessor"></span><span class="comment">//#define IMPEPSSMALL (1E-8)</span></div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;<span class="preprocessor">#define ERRORFORIMPEPSSMALL (1E-9)</span></div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#elif(REALTYPE==LONGDOUBLETYPE)</span></div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define IMPEPSLARGE (1E-8)</span></div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define IMPEPSSMALL (1E-10)</span></div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define ERRORFORIMPEPSSMALL (1E-9)</span></div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;</div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;<span class="comment">// whether to skip computing Jacobian every step after certain condition of having done a few steps and then compute every few steps only.</span></div>
<div class="line"><a name="l00321"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a0d533cb54a9df8780a89f93455915512">  321</a></span>&#160;<span class="preprocessor">#define SKIPJACCOMPUTE (DOPERF)</span></div>
<div class="line"><a name="l00322"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a6b05d7d9b573d45e23e96b6dc931ae0f">  322</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define SKIPJACITER (4)</span></div>
<div class="line"><a name="l00323"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5db3e0d01f4eefea2276d87eee1caad1">  323</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define SKIPJACFACTOR (4)</span></div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;</div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;</div>
<div class="line"><a name="l00328"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#acc67470ff1c715385df90c64aaaa52ec">  328</a></span>&#160;<span class="preprocessor">#define MAXIMPEPS (0.3)</span></div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00331"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad08222721945a85c235d11ea56f6cc20">  331</a></span>&#160;<span class="preprocessor">#define MAXJACITER (10)</span></div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;</div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;</div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;<span class="comment">//#define IMPMAXITER (15) // for used implicit solver // For others</span></div>
<div class="line"><a name="l00336"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a58cca3253f4dfcefde5fe864699e297a">  336</a></span>&#160;<span class="preprocessor">#define IMPMAXITERLONG (100) // for used implicit solver</span></div>
<div class="line"><a name="l00337"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad666390bb51588e23136cdeccc543418">  337</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define IMPMAXITERMEDIUM (40)</span></div>
<div class="line"><a name="l00338"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a03eeb7614c6d7be8ab6fb4e6d2036ee3">  338</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define IMPMAXITERQUICK (13)</span></div>
<div class="line"><a name="l00339"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a2d8c9708802cf755a4a134bbc40f7fea">  339</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define IMPMAXITERSUPERQUICK (2)</span></div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00341"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a59bf6804cf154be810df9b1b0f83e949">  341</a></span>&#160;<span class="preprocessor">#define IMPMINABSERROR (1E-100) // minimum absolute error (or value) below which don&#39;t treat as bad error and just avoid 4-force.  Otherwise will &quot;fail&quot; implicit solver even if impossible to reach smaller relative error due to absolute machine precision issues.</span></div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00349"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a295cf01ec322211d3dcd6e2a59815628">  349</a></span>&#160;<span class="preprocessor">#define IMPLICITERRORNORM 4</span></div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;</div>
<div class="line"><a name="l00352"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a78196418cbe072d23bb7e7e5be7c6606">  352</a></span>&#160;<span class="preprocessor">#define MAXSUBCYCLES (2000) // for explicit sub-cycles when doing reversion</span></div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00355"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ac0299384734a4247a9ca4d8581b3aa72">  355</a></span>&#160;<span class="preprocessor">#define MAXSUBCYCLESFAIL (MAXSUBCYCLES*100)</span></div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;</div>
<div class="line"><a name="l00358"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ac8f7be0e2a8b0e45b7bf155cf0146c24">  358</a></span>&#160;<span class="preprocessor">#define MAXF1TRIES 20 // 20 might sound like alot, but Jacobian does 4 to 5 inversions each iteration, and that amount is only typically needed for very first iteration.</span></div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;<span class="preprocessor"></span>  <span class="comment">// goes to f1iter=10 for RADPULSE KAPPAES=1E3 case.  Might want to scale maximum iterations with \tau, although doubling of damping means exponential w.r.t. f1iter, so probably 50 is certainly enough since 2^(-50) is beyond machine precision for doubles.</span></div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;</div>
<div class="line"><a name="l00361"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a55a6521d140538925946aeb79da33b5b">  361</a></span>&#160;<span class="preprocessor">#define MAXMHDSTEPS (trueimpmaxiter*6) // limit total number of MHD inversion steps</span></div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;</div>
<div class="line"><a name="l00364"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afccf4aec740d2b23fa42d2dbc356eb31">  364</a></span>&#160;<span class="preprocessor">#define RADDAMPDELTA (0.5) // choose, but best to choose 1/Integer so no machine precision issues.</span></div>
<div class="line"><a name="l00365"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab991e76a81e787d737c9f1b755798ce9">  365</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define RADDAMPUNDELTA (1.0/RADDAMPDELTA)</span></div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;<span class="comment">// whether to try explicit first before implicit steps</span></div>
<div class="line"><a name="l00368"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a633ab6365d2cedcbb50e690e4d59d7d9">  368</a></span>&#160;<span class="preprocessor">#define TRYFIRSTEXPLICIT 1</span></div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;<span class="comment">// whether to try normal guess if explicit fails as guess</span></div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;<span class="comment">// helps avoid some failures due to guess issue</span></div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;<span class="comment">// slows the code down some, and if consistent failure in a cell (say equator near inner radial boundary), then will slow down entire run by about a factor of two.  So only use with DOPERF==0 for now, and assume fixups will be efficient enough.</span></div>
<div class="line"><a name="l00373"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad09ae1fd1b9957bada8d4ba83bcfcf75">  373</a></span>&#160;<span class="preprocessor">#define DONONEXPLICITIFFAILS ((DOPERF==0)*TRYFIRSTEXPLICIT) </span></div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;</div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;</div>
<div class="line"><a name="l00377"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a40c12b12994014b89a690050e0c8f099">  377</a></span>&#160;<span class="preprocessor">#define TAUFAILLIMIT (2.0/3.0) // at what \tau below which to assume &quot;failure1&quot; in u2p_rad() means should be moving at gammamax rather than not moving.</span></div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00379"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa4b9d982b48049810dccd1aab2565433">  379</a></span>&#160;<span class="preprocessor">#define TAUSWITCHPBVSPIIN (2.0/3.0) // at what \tau to switch using pb(uu0) vs. piin(Uiin).</span></div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;</div>
<div class="line"><a name="l00383"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a24229740b34d000bdadf74e1acf22c6e">  383</a></span>&#160;<span class="preprocessor">#define IMPLICITREVERTEXPLICIT 0 // problem.  Not a good idea. -- should try implicit again, starting out with more damping.</span></div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00386"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a036d2cbd64de942abfaf87cd4bad1863">  386</a></span>&#160;<span class="preprocessor">#define MAXEXPLICITSUBSTEPCHANGE 1.e-2</span></div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00393"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a96e9f8c7659cf4e2775a3e65536611fb">  393</a></span>&#160;<span class="preprocessor">#define TAUSUPPRESS 0 // makes physical sense, but might be wrong in some limits (i.e. Gd can still be large relative), but try to account for lambda as well.</span></div>
<div class="line"><a name="l00394"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a83fe2126d8f6ed5d51c403cc0c76e403">  394</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define SPACETIMESUBSPLITNONE 1 // DON&#39;T USE! (gets inversion failures because overly aggressive)</span></div>
<div class="line"><a name="l00395"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a4d98ec6b860124fb970995509f049ce6">  395</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define SPACETIMESUBSPLITTIME 2 // probably not ok -- need to split off mhd and rad</span></div>
<div class="line"><a name="l00396"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a0d4cb4961f7d88836e6b8761c5b616ee">  396</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define SPACETIMESUBSPLITALL 3 // probably not ok -- need to split off mhd and rad</span></div>
<div class="line"><a name="l00397"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a0f25129d2628f77ee64c975864c8a3a8">  397</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define SPACETIMESUBSPLITSUPERALL 4 // OK TO USE sometimes, but not always</span></div>
<div class="line"><a name="l00398"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a71fa85e8a367b335d86a1f6d7f214f9d">  398</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define SPACETIMESUBSPLITMHDRAD 5 // KINDA OK TO USE (generates noise in velocity where E is very small, but maybe ok since sub-dominant and don&#39;t care about velocity where E is small.  E evolves fine, but Rtx eventually shows issues.)</span></div>
<div class="line"><a name="l00399"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a6a21302ee0f8977df980aca4959a0f2e">  399</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define SPACETIMESUBSPLITTIMEMHDRAD 6 // OK TO USE sometimes (works fine and no noise in velocity because split it off.  Might have trouble in multiple dimensions if sub-dominant momentum dimension requires implicit step -- but general diffusive would suggest unlikely.  But, not efficient in optically thick regime once radiation velocity is non-trivial in magnitude)</span></div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00401"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a7166436b3364140f892e2a3775c1c281">  401</a></span>&#160;<span class="preprocessor">#define WHICHSPACETIMESUBSPLIT TAUSUPPRESS // only tausuppress works in general.</span></div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00405"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa63447acbbbc62cbedae23eac61c716e">  405</a></span>&#160;<span class="preprocessor">#define NUMERRORTYPES 2 // 0: over iterated   1: over all relevant terms</span></div>
<div class="line"><a name="l00406"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">  406</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define WHICHERROR 1 // choose, but generally should be 1.</span></div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;</div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;<span class="comment">//SPACETIMESUBSPLITTIMEMHDRAD // TAUSUPPRESS</span></div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;<span class="comment">// SPACETIMESUBSPLITTIMEMHDRAD  //  SPACETIMESUBSPLITMHDRAD // SPACETIMESUBSPLITSUPERALL // TAUSUPPRESS</span></div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;</div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;<span class="comment">//#define GETRADINVFROMUU0FORPB 3 // makes use more ITERMODESTAGES</span></div>
<div class="line"><a name="l00418"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a20ceb73955d66a10e7cebd4a1ae006b8">  418</a></span>&#160;<span class="preprocessor">#define GETRADINVFROMUU0FORPB 1  // might be expensive if uu0 has no solution for the MHD inversion.</span></div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00426"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a886aa42856b0650b3cc366405c07151b">  426</a></span>&#160;<span class="preprocessor">#define USEDUINRADUPDATE 1</span></div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00430"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ae6b95cb2bf8c9e2e610922c6e72025c2">  430</a></span>&#160;<span class="preprocessor">#define USEINPUTASGUESSIFERRORSMALL (WHICHERROR==1)</span></div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;</div>
<div class="line"><a name="l00433"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ae7c14c1dcfc1528ee3bca6c96c033a7c">  433</a></span>&#160;<span class="preprocessor">#define GAMMASMALLLIMIT (1.0-1E-10) // at what point above which assume gamma^2=1.0</span></div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;</div>
<div class="line"><a name="l00437"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a2035388bf43781f4e128080c78286d02">  437</a></span>&#160;<span class="preprocessor">#define JONCHOICE 0</span></div>
<div class="line"><a name="l00438"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#acb04a5077aeea127dfd3303bd8c62041">  438</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define OLEKCHOICE 1</span></div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00440"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a68cc613160b89aef5563b45f20a303f5">  440</a></span>&#160;<span class="preprocessor">#define CASECHOICE JONCHOICE // choose</span></div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;<span class="preprocessor"></span><span class="comment">//#define CASECHOICE OLEKCHOICE // choose</span></div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;</div>
<div class="line"><a name="l00443"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#af53a01c283ca4e72c161241264608ad4">  443</a></span>&#160;<span class="preprocessor">#define TOZAMOFRAME 0 // reduce to ZAMO gammarel=1 frame (e.g. in non-GR that would be grid frame or v=0 frame or gammarel=1).</span></div>
<div class="line"><a name="l00444"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a78f7054568cf937f1331f008edcc1fe9">  444</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define TOFLUIDFRAME 1 // reduce to using fluid frame (probably more reasonable in general).</span></div>
<div class="line"><a name="l00445"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa38f2cd6d2f5874dd2d3449d9835b9db">  445</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define TOOPACITYDEPENDENTFRAME 2</span></div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00447"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a2942d768c739b8f4c99b51a814cf7818">  447</a></span>&#160;<span class="preprocessor">#define M1REDUCE TOOPACITYDEPENDENTFRAME // choose</span></div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;<span class="comment">// KORALTODO: The below need to be chosen intelligently</span></div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;</div>
<div class="line"><a name="l00453"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a855f34b6026bfa3ccf8bf11c895f9728">  453</a></span>&#160;<span class="preprocessor">#define MINTAUSOURCE (NUMEPSILON)</span></div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;</div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;</div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;<span class="comment">// START SOME LOCAL OPTIONS</span></div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00466"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a2f83d121d53cb234469475e3e4d41c45">  466</a></span>&#160;<span class="preprocessor">#define DOSUBJAC 1</span></div>
<div class="line"><a name="l00467"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#abdcb53b729f6de6754bdff1a1b118752">  467</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define ENERGYSIMPLEFACTOR (NDIM) // NDIM=4 times simpler than full step</span></div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;</div>
<div class="line"><a name="l00470"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab9c7390f62ef08325e12b7110621d33a">  470</a></span>&#160;<span class="preprocessor">#define ITERMODENORMAL 0</span></div>
<div class="line"><a name="l00471"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a480c56e263c4874ccb40f3bbc1b32032">  471</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define ITERMODESTAGES 1</span></div>
<div class="line"><a name="l00472"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a18693ca111670c1ff38ab2206f70c81e">  472</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define ITERMODECOLD 2</span></div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;</div>
<div class="line"><a name="l00477"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a215a0f9e703918348ac4a584aa31527a">  477</a></span>&#160;<span class="preprocessor">#define BEGINMOMSTEPS0 1</span></div>
<div class="line"><a name="l00478"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad7c85ad00ab6537b38c3ef32a7c93e79">  478</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define ENDMOMSTEPS0 2</span></div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00480"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a52fd5f64bbf965a0c577b7a488beda2d">  480</a></span>&#160;<span class="preprocessor">#define BEGINENERGYSTEPS0 3</span></div>
<div class="line"><a name="l00481"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a6e0423fe97337a6136820c53f57538ff">  481</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define ENDENERGYSTEPS0 13</span></div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00483"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5534cdf286fe7b676c4dd9ba557bed49">  483</a></span>&#160;<span class="preprocessor">#define BEGINFULLSTEPS0 14</span></div>
<div class="line"><a name="l00484"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5e079c1feac0db5af63685df3ca739a5">  484</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define ENDFULLSTEPS0 (IMPMAXITERLONG*2)</span></div>
<div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00486"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#acfe830a6ff019e8ad515f620df909c69">  486</a></span>&#160;<span class="preprocessor">#define BEGINNORMALSTEPS0 BEGINFULLSTEPS0</span></div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;</div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;</div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;</div>
<div class="line"><a name="l00492"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a652ffab4e70169ef7493d1ba4663e954">  492</a></span>&#160;<span class="preprocessor">#define NUMPRIORERRORSITER0 7</span></div>
<div class="line"><a name="l00493"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab4cf497679ffe5ebf0a9020558d74067">  493</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define NUMPRIORERRORS 5</span></div>
<div class="line"><a name="l00494"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ac2f05e43b43040f8803b83374ecaba58">  494</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define PRIORERRORCHANGEREQUIRED (0.5) // damping is included below when used</span></div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00497"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a586faef01165fe8c975094a5feaca256">  497</a></span>&#160;<span class="preprocessor">#define DEBUGMAXITER (PRODUCTION==0)</span></div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00501"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8968c59c029dc64a1057992a70ef8dbd">  501</a></span>&#160;<span class="preprocessor">#define DEBUGMAXITERVELOCITY 1</span></div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00503"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a63410994d900c1c05481efc828361b3b">  503</a></span>&#160;<span class="preprocessor">#define DEBUGLEVELIMPSOLVER 3 // which debugfail&gt;=# to use for some common debug stuff</span></div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;<span class="preprocessor"></span><span class="comment">//#define DEBUGLEVELIMPSOLVER 2 // which debugfail&gt;=# to use for some common debug stuff</span></div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;</div>
<div class="line"><a name="l00506"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a969edf608c4953dd7b4b34e99dbc686c">  506</a></span>&#160;<span class="preprocessor">#define DEBUGLEVELIMPSOLVERMORE 3 // which debugfail&gt;=# to use for some common debug stuff</span></div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;<span class="preprocessor"></span><span class="comment">//#define DEBUGLEVELIMPSOLVERMORE 2 // which debugfail&gt;=# to use for some common debug stuff</span></div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;</div>
<div class="line"><a name="l00510"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ada1f75a5f358478d047ee8a8db4436a7">  510</a></span>&#160;<span class="preprocessor">#define RAMESHFIXEARLYSTEPS (DOSUBJAC==1 ? 0 : 3) // 3 if used is default</span></div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00513"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a311385191ec842a32ec2e645c2491e38">  513</a></span>&#160;<span class="preprocessor">#define JONHOLDPOS 1</span></div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00515"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8f61cd4c0fa78552cb734a45cd5aec72">  515</a></span>&#160;<span class="preprocessor">#define NEWJONHOLDPOS 0 // __WORKINGONIT__: WORKING ON IT</span></div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00518"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aceea98f8281dc4737224ea2233815318">  518</a></span>&#160;<span class="preprocessor">#define NUMHOLDTIMES 6</span></div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;</div>
<div class="line"><a name="l00522"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a69c8700ef814c6827710501cb880689b">  522</a></span>&#160;<span class="preprocessor">#define RAMESHSTOPENERGYIFTOOOFTENBELOWENTROPY 3</span></div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;<span class="comment">// Also, have found switching during iterations can lead to solution going astray</span></div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;<span class="comment">// But still currently allow Utoprimgen() to do MHD inversion of any backup, just that once out of Utoprimgen() we treat as original starting eomtype and eomtype is not changed.</span></div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;<span class="comment">//#define SWITCHTOENTROPYIFCHANGESTOENTROPY (mtd-&gt;implicitferr==QTYUMHD ? 0 : 1)</span></div>
<div class="line"><a name="l00529"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a83f34d96e4765fc9f40227de7fc65858">  529</a></span>&#160;<span class="preprocessor">#define SWITCHTOENTROPYIFCHANGESTOENTROPY (0)</span></div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;</div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;</div>
<div class="line"><a name="l00534"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a4e881a6dce34b0b9f03a77b9d9c11c9c">  534</a></span>&#160;<span class="preprocessor">#define USERAMESH 0 // too slow if used too often, and rarely result really used.</span></div>
<div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00537"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a4a0ce3856fb32518938a274adb6c3946">  537</a></span>&#160;<span class="preprocessor">#define TRYHARDERFEEDGUESSTOL (1E-4)</span></div>
<div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00540"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#abbf8da2bda1bab4cdb847a0faa6db3c1">  540</a></span>&#160;<span class="preprocessor">#define ERRORTOUSEENTROPYFORENERGYGUESS (1E-4)</span></div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;</div>
<div class="line"><a name="l00544"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a7b7fdf03aa53ba612d2d2344e4f6882a">  544</a></span>&#160;<span class="preprocessor">#define GETBEST 1</span></div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;</div>
<div class="line"><a name="l00548"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a11a23c165eeac58d97d409da3de53e0a">  548</a></span>&#160;<span class="preprocessor">#define DOFINALCHECK 1</span></div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;</div>
<div class="line"><a name="l00552"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afd4f53bb800de27cee3986b199f46f24">  552</a></span>&#160;<span class="preprocessor">#define REPORTMAXITERALLOWED (PRODUCTION==0)</span></div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00555"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a2e2505ff5f52002b4119c4e41ec4f7b8">  555</a></span>&#160;<span class="preprocessor">#define FORCEJDIFFNOCROSS 1</span></div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00560"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ae63207aeebd9e61dd18e446352b8197c">  560</a></span>&#160;<span class="preprocessor">#define POSTNEWTONCONVCHECK 1</span></div>
<div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00563"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a18a6baa85e6cc019fe0cb531923ffcbf">  563</a></span>&#160;<span class="preprocessor">#define DIFFXLIMIT (10.0*NUMEPSILON)</span></div>
<div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00565"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afa68d3b86ac65f7d19b593cd8ea61f56">  565</a></span>&#160;<span class="preprocessor">#define LOCALPREIMPCONVX (10.0*NUMEPSILON)</span></div>
<div class="line"><a name="l00566"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a2e77bdd514904b3194b3ceefe200cec3">  566</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define LOCALPREIMPCONVXABS ((FTYPE)(NDIM+2)*LOCALPREIMPCONVX)</span></div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;</div>
<div class="line"><a name="l00570"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8b8fab71a8c26738e5758912ea6c06e2">  570</a></span>&#160;<span class="preprocessor">#define NUMNOERRORREDUCE0 (5 + mtd.BEGINNORMALSTEPS)</span></div>
<div class="line"><a name="l00571"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a0c7f2a194649bb51a1957ee424aff64f">  571</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define NUMNOERRORREDUCE 5</span></div>
<div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;</div>
<div class="line"><a name="l00576"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ac640fcdc491ef83fb24e6f69193d910e">  576</a></span>&#160;<span class="preprocessor">#define SWITCHTODONOTHING 1</span></div>
<div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00579"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a00a5777dcc22797386a32f88a19cd973">  579</a></span>&#160;<span class="preprocessor">#define CHANGEDAMPFACTOR 2 // bit risky to set to 1 since changing DAMPFACTOR for no good reason limits ability to converge at normal rate.</span></div>
<div class="line"><a name="l00580"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a05f68af4806f09b5fcb143348da66be1">  580</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define NUMDAMPATTEMPTS (3*((DOPERF)==0) + 1*((DOPERF)==1))</span></div>
<div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00582"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a91061094ecbe11ec91b0999d1f243f20">  582</a></span>&#160;<span class="preprocessor">#define NUMDAMPATTEMPTSQUICK 1</span></div>
<div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;</div>
<div class="line"><a name="l00586"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a623cc9e076e87e4c1a95ea6168668e17">  586</a></span>&#160;<span class="preprocessor">#define FACTORBADJUMPERROR (1.0E2)</span></div>
<div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;</div>
<div class="line"><a name="l00591"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a7e85f0bc7e860db465c69330caf67cf3">  591</a></span>&#160;<span class="preprocessor">#define WHICHU2PRAD 1</span></div>
<div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;<span class="comment">//#define GAMMAMAXRADIMPLICITSOLVER (1E5)</span></div>
<div class="line"><a name="l00595"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#addff6a9e94a657b1acf23dbc17257475">  595</a></span>&#160;<span class="preprocessor">#define GAMMAMAXRADIMPLICITSOLVER (GAMMAMAXRAD) // for radiation, seek actual solution with this limit.  Solver can find solutions, while harder when limiting gamma_{gas} for some reason.</span></div>
<div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;</div>
<div class="line"><a name="l00599"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a842f854de025438920f9658ae820b4c6">  599</a></span>&#160;<span class="preprocessor">#define ENTROPYOPT 1</span></div>
<div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00602"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8369e50da6c81920c90b241974d34e99">  602</a></span>&#160;<span class="preprocessor">#define ALLOWUSEUUALT 0</span></div>
<div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00605"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a025eda55485f11e4e248a4521b8f2faf">  605</a></span>&#160;<span class="preprocessor">#define USECAPTYPEFIX2FORF1 1</span></div>
<div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00607"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa643cd88da48f63c35ea3fff7f4ecfc1">  607</a></span>&#160;<span class="preprocessor">#define USECAPTYPEFIX2FORFINALCHECK 1</span></div>
<div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00609"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#acb385d9ec44b11fdf8c796af627d0b41">  609</a></span>&#160;<span class="preprocessor">#define AVOIDURAD0IFRADINVMODANDPMHDMETHOD (USECAPTYPEFIX2FORF1!=0)</span></div>
<div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00611"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ae0630b7afa58e9ef8f8caf69e619787d">  611</a></span>&#160;<span class="preprocessor">#define TREATRADINVCAPASNONFAILUREFORPMHDMETHOD (USECAPTYPEFIX2FORF1!=0)</span></div>
<div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00614"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa9bac15be449bce1dc3b0a2d4a791521">  614</a></span>&#160;<span class="preprocessor">#define LETPMHDFAIL 1</span></div>
<div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00617"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a0e05f8ddd1f85dddb1432aa1941bbbd7">  617</a></span>&#160;<span class="preprocessor">#define USEPRIORITERMETHOD 0</span></div>
<div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00620"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad447e623f48316a0e519d46c213ce17f">  620</a></span>&#160;<span class="preprocessor">#define STOPIFVERYLOWERROR (1)</span></div>
<div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00622"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab65ae0cf68e3a38ad5326ae212bdd134">  622</a></span>&#160;<span class="preprocessor">#define STOPIFITERLOWERROR (0)</span></div>
<div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;</div>
<div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;</div>
<div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;</div>
<div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;</div>
<div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;</div>
<div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;</div>
<div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;</div>
<div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;</div>
<div class="line"><a name="l00632"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a04634949fd2370214f3d313c9cffa182">  632</a></span>&#160;<span class="preprocessor">#define FAILRETURNGOTRIVIALEXPLICIT -1</span></div>
<div class="line"><a name="l00633"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a3d6e4da5640133efaad94738c97e5171">  633</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define FAILRETURNNOFAIL 0</span></div>
<div class="line"><a name="l00634"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab0abd953f677a44020dc50259c410486">  634</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define FAILRETURNGENERAL 1</span></div>
<div class="line"><a name="l00635"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8e6ffbfa15bc415667f8326125aece2f">  635</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define FAILRETURNJACISSUE 2</span></div>
<div class="line"><a name="l00636"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a42e7e780e89073f5d14dfafda3bae62e">  636</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define FAILRETURNMODESWITCH 3</span></div>
<div class="line"><a name="l00637"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a45adfa493bc8ab6857a43a11d9d649d1">  637</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define FAILRETURNNOTTOLERROR 4</span></div>
<div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00639"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a6ce9f5de6e575be785e5f053882a0909">  639</a></span>&#160;<span class="preprocessor">#define ACCEPTASNOFAILURE(failreturn) (failreturn==FAILRETURNNOFAIL || failreturn==FAILRETURNNOTTOLERROR || failreturn==FAILRETURNGOTRIVIALEXPLICIT)</span></div>
<div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;<span class="preprocessor"></span><span class="comment">//#define GOODNOFAILURE(failreturn) (failreturn==FAILRETURNNOFAIL || failreturn==FAILRETURNGOTRIVIALEXPLICIT)</span></div>
<div class="line"><a name="l00641"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ac2a8331792f5389e74e3b2865c305e6e">  641</a></span>&#160;<span class="preprocessor">#define NOTACTUALFAILURE(failreturn) (failreturn==FAILRETURNNOFAIL || failreturn==FAILRETURNMODESWITCH || failreturn==FAILRETURNGOTRIVIALEXPLICIT)</span></div>
<div class="line"><a name="l00642"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a1a5416db138e03cc24de865e636341e7">  642</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define NOTBADFAILURE(failreturn) (failreturn==FAILRETURNNOFAIL || failreturn==FAILRETURNMODESWITCH  || failreturn==FAILRETURNNOTTOLERROR || failreturn==FAILRETURNGOTRIVIALEXPLICIT)</span></div>
<div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00644"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a98e2c94d4fc861c61bc8dde7b4eec734">  644</a></span>&#160;<span class="preprocessor">#define ACTUALHARDFAILURE(failreturn) (failreturn==FAILRETURNGENERAL || failreturn==FAILRETURNJACISSUE)</span></div>
<div class="line"><a name="l00645"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a7207286a043c1f65037676ebf80412e5">  645</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define ACTUALHARDORSOFTFAILURE(failreturn) (failreturn==FAILRETURNGENERAL || failreturn==FAILRETURNJACISSUE || failreturn==FAILRETURNNOTTOLERROR)</span></div>
<div class="line"><a name="l00646"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ac395c8ff6ec1c393b5081c4e54c5742e">  646</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define SWITCHGOODIDEAFAILURE(failreturn) (failreturn==FAILRETURNGENERAL || failreturn==FAILRETURNJACISSUE || failreturn==FAILRETURNNOTTOLERROR || failreturn==FAILRETURNMODESWITCH)</span></div>
<div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;</div>
<div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;</div>
<div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;<span class="comment">// NOTEMARK: for MODEENERGY type method, note that ener.out and jrdpradener (SM) can be used to track all conserved quantities for: 1) how well we have tracked all changes 2) how much each term contributes (fl tracks any changes that deviate unew from pf as well as standard floors)</span></div>
<div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;<span class="comment">// Sources of non-conservation *included* in &quot;fl&quot; term: 1) any floors 2) when no implicit solution and reverts to averaging surrounding cells in fixup_utoprim(), because applied to primitives before diag checks ucons vs. pf 3) when OUTERDEATH or POLEDEATH are applied, because comparison between ucons and pf occurs after boundary conditions are applied 4) when implicit solver reverts to having to use entropy, but ends up not able to borrow to conserve total energy, because dUrad forced to always be -dUgas regardles of primitive solution used. 5) when energy (or entropy with borrow) is used, but despite gas having good solution, still radinvmod=1 is triggered so that caps are put in place and total energy conservation not possible -- Because dUrad forced to be -dUgas.</span></div>
<div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;</div>
<div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;<span class="comment">// Do the above regarding entropy because will be tracked and for adding to ucum, if sub-step, then might recover.</span></div>
<div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;</div>
<div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;<span class="comment">// Sources of non-conservation (e.g. of energy) that are *not* tracked include 1) machine error in doubles adding up over entire grid. 2) fluxes adding up over time 3) u obtained from pf uses get_state and primtoU that has non-trivial errors sometimes, so u cumulated over time won&#39;t be perfectly matching fluxes.  Still good to know because this is true error because initial U in advance does this exact get_state and primtoU.</span></div>
<div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;<span class="comment">// NOTEMARK: u7 associated with conserved B3 that in SPC B^\phi would be conserved if ideal MHD, but dissipation of the B3-supporting currents can mean a non-zero net B3 can change without ever passing through boundaries.</span></div>
<div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;</div>
<div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;<span class="preprocessor">#if(DOPERF)</span></div>
<div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define MODEMETHOD MODEPICKBESTSIMPLE // switches with only PMHD method</span></div>
<div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#else</span></div>
<div class="line"><a name="l00669"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8eca1a0ead33f844741e3b377159d1cc">  669</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define MODEMETHOD MODEPICKBEST // general switching method</span></div>
<div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;<span class="comment">//#define MODEMETHOD MODEPICKBEST // general switching method</span></div>
<div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;<span class="comment">//#define MODEMETHOD MODEPICKBESTSIMPLE // switches with only PMHD method // NOTEFORFAST</span></div>
<div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;<span class="comment">//#define MODEMETHOD MODEPICKBESTSIMPLE2 // switches with all methods but no ITERMODESTAGES attempted</span></div>
<div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;<span class="comment">//#define MODEMETHOD MODESWITCH</span></div>
<div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;<span class="comment">//#define MODEMETHOD MODEENERGY</span></div>
<div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;<span class="comment">//#define MODEMETHOD MODEENTROPY</span></div>
<div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;<span class="comment">//#define MODEMETHOD MODEENERGYRAMESH</span></div>
<div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;</div>
<div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;</div>
<div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;<span class="comment">// END SOME LOCAL OPTIONS</span></div>
<div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;</div>
<div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;</div>
<div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;</div>
<div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;</div>
<div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;</div>
<div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a675bb3f12a77c62cf2540bc42c4867f8" title="wrapper for mode method">koral_source_rad_implicit</a>(<span class="keywordtype">int</span> *eomtype, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pb, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pf, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *piin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Uiin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ufin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUf, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUimp, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *q, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dissmeasure, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *dUother ,<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*dUcomp)[NPR]);</div>
<div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;</div>
<div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a17aede36203a236390363af78d3a86f0" title="compute changes to U (both T and R) using implicit method KORALTODO: If doing implicit, should also add geometry source term that can sometimes be stiff.">koral_source_rad_implicit_mode</a>(<span class="keywordtype">int</span> modemethodlocal, <span class="keywordtype">int</span> allowbaseitermethodswitch, <span class="keywordtype">int</span> modprim, <span class="keywordtype">int</span> havebackup, <span class="keywordtype">int</span> didentropyalready, <span class="keywordtype">int</span> *eomtype, <span class="keywordtype">int</span> whichcap, <span class="keywordtype">int</span> itermode, <span class="keywordtype">int</span> *baseitermethod, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> trueimptryconv, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> trueimpokconv, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> trueimpallowconv, <span class="keywordtype">int</span> trueimpmaxiter, <span class="keywordtype">int</span> truenumdampattempts, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fracenergy, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dissmeasure, <span class="keywordtype">int</span> *radinvmod, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pb, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *uub, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *piin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Uiin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ufin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUf, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUimp, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *q, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *dUother ,<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*dUcomp)[NPR], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *errorabs, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *errorabsbestexternal, <span class="keywordtype">int</span> *iters, <span class="keywordtype">int</span> *f1iters, <span class="keywordtype">int</span> *nummhdinvs, <span class="keywordtype">int</span> *nummhdsteps);</div>
<div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;</div>
<div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#af46d2b1cf89a70a7e2ef503146c649a9" title="uu0 - original cons.">f_implicit</a>(<span class="keywordtype">int</span> allowbaseitermethodswitch, <span class="keywordtype">int</span> iter, <span class="keywordtype">int</span> f1iter, <span class="keywordtype">int</span> failreturnallowable, <span class="keywordtype">int</span> whichcall, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> impeps, <span class="keywordtype">int</span> showmessages, <span class="keywordtype">int</span> showmessagesheavy, <span class="keywordtype">int</span> allowlocalfailurefixandnoreport, <span class="keywordtype">int</span> *eomtype, <span class="keywordtype">int</span> whichcap, <span class="keywordtype">int</span> itermode, <span class="keywordtype">int</span> *baseitermethod, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fracenergy, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dissmeasure, <span class="keywordtype">int</span> *radinvmod, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> conv, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> convabs, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> allowconvabs, <span class="keywordtype">int</span> maxiter, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> realdt, <span class="keywordtype">int</span> dimtypef, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *dimfactU, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *ppprev, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pp, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *piin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *uuprev, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Uiin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *uu0,<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *uu,<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> localdt, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *q,  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *f, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *fnorm, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *freport, <span class="keywordtype">int</span> *goexplicit, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *errorabs, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *errorallabs, <span class="keywordtype">int</span> whicherror, <span class="keywordtype">int</span> *convreturn, <span class="keywordtype">int</span> *nummhdinvsreturn, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *tautotmaxreturn, <span class="keyword">struct</span> <a class="code" href="../../d6/dbe/structof__method.html">of_method</a> *mtd, <span class="keyword">struct</span> <a class="code" href="../../d2/d46/structof__ref_u.html">of_refU</a> *ru);</div>
<div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;</div>
<div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;</div>
<div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a795959353203e99366b456b16d0d0bab" title="calculates total opacity over dx[] for given chi or chieff">calc_tautot_chieff</a>(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pp, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> chi, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *q, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *tautot, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *tautotmax);</div>
<div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;</div>
<div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;<span class="keyword">static</span> <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ae83fc4364d7c6bc0b717418cd5345297">calc_approx_ratchangeRtt</a>(<span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *q, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> chieff, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> realdt);</div>
<div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;</div>
<div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;</div>
<div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afa73a2caa3209e565a64f92447058507" title="calculating approximate Jacobian: dUresid(dUrad,G(Urad))/dUrad = dy(x)/dx then compute inverse Jacobi...">get_implicit_iJ</a>(<span class="keywordtype">int</span> allowbaseitermethodswitch, <span class="keywordtype">int</span> failreturnallowableuse, <span class="keywordtype">int</span> showmessages, <span class="keywordtype">int</span> showmessagesheavy, <span class="keywordtype">int</span> allowlocalfailurefixandnoreport, <span class="keywordtype">int</span> *eomtypelocal, <span class="keywordtype">int</span> whichcap, <span class="keywordtype">int</span> itermode, <span class="keywordtype">int</span> *baseitermethod, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fracenergy, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dissmeasure, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> impepsjac, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> trueimptryconv, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> trueimptryconvabs, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> trueimpallowconvabs, <span class="keywordtype">int</span> trueimpmaxiter, <span class="keywordtype">int</span> iter, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> errorabs, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> errorallabs, <span class="keywordtype">int</span> whicherror, <span class="keywordtype">int</span> dimtypef, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *dimfactU, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Uiin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *uu, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *uup, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *uu0, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *piin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pp, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *ppp, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fracdtG, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> realdt, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *q, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *f1, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *f1norm, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*iJ)[NPR], <span class="keywordtype">int</span> *nummhdinvsreturn, <span class="keyword">struct</span> <a class="code" href="../../d6/dbe/structof__method.html">of_method</a> *mtd, <span class="keyword">struct</span> <a class="code" href="../../d2/d46/structof__ref_u.html">of_refU</a> *ru);</div>
<div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;</div>
<div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> inverse_33matrix(<span class="keywordtype">int</span> sj, <span class="keywordtype">int</span> ej, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> aa[][<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ia[][NDIM]);</div>
<div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> inverse_11matrix(<span class="keywordtype">int</span> sj, <span class="keywordtype">int</span> ej, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> aa[][<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ia[][NDIM]);</div>
<div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;</div>
<div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;</div>
<div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> f_error_check(<span class="keywordtype">int</span> showmessages, <span class="keywordtype">int</span> showmessagesheavy, <span class="keywordtype">int</span> iter, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> conv, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> convabs, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> realdt, <span class="keywordtype">int</span> dimtypef, <span class="keywordtype">int</span> eomtype, <span class="keywordtype">int</span> radinvmod, <span class="keywordtype">int</span> itermode, <span class="keywordtype">int</span> baseitermethod, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fracenergy, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dissmeasure, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *dimfactU, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pp, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *piin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *f1, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *f1norm, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *f1report, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Uiin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *uu0, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *uu, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *errorabs, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *errorallabs, <span class="keywordtype">int</span> whicherror, <span class="keyword">struct</span> <a class="code" href="../../d6/dbe/structof__method.html">of_method</a> *mtd, <span class="keyword">struct</span> <a class="code" href="../../d2/d46/structof__ref_u.html">of_refU</a> *ru);</div>
<div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;</div>
<div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a77c546a7fb064266fef5a9e796dc63dc" title="compute ZAMO version of radiation quantities as in paper draft">compute_ZAMORAD</a>(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *uu, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Er, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Utildesq, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Utildecon);</div>
<div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;</div>
<div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;</div>
<div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> Utoprimgen_failwrapper(<span class="keywordtype">int</span> doradonly, <span class="keywordtype">int</span> *radinvmod, <span class="keywordtype">int</span> showmessages, <span class="keywordtype">int</span> checkoninversiongas, <span class="keywordtype">int</span> checkoninversionrad, <span class="keywordtype">int</span> allowlocalfailurefixandnoreport, <span class="keywordtype">int</span> finalstep, <span class="keywordtype">int</span> *eomtype, <span class="keywordtype">int</span> whichcap, <span class="keywordtype">int</span> evolvetype, <span class="keywordtype">int</span> inputtype,<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *U,  <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *qptr, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dissmeasure, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *<a class="code" href="../../dc/dd2/newcodediff_8txt.html#ae7ab77d7e616dc02fba121a009b48c27">pr</a>, <span class="keyword">struct</span> <a class="code" href="../../db/d3a/structof__newtonstats.html">of_newtonstats</a> *newtonstats);</div>
<div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;</div>
<div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> define_method(<span class="keywordtype">int</span> iter, <span class="keywordtype">int</span> *eomtype, <span class="keywordtype">int</span> itermode, <span class="keywordtype">int</span> baseitermethod, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fracenergy, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dissmeasure, <span class="keyword">struct</span> <a class="code" href="../../d6/dbe/structof__method.html">of_method</a> *mtd);</div>
<div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> get_refUs(<span class="keyword">struct</span> <a class="code" href="../../d6/dbe/structof__method.html">of_method</a> *mtd, <span class="keyword">struct</span> <a class="code" href="../../d2/d46/structof__ref_u.html">of_refU</a> *ru);</div>
<div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;</div>
<div class="line"><a name="l00721"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aacf0ccefbc7e7f1e727cab83194d5bf4">  721</a></span>&#160;<span class="preprocessor">#define MAXJACDIM (NDIM)</span></div>
<div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;<span class="preprocessor"></span><span class="comment">//#define MAXJACDIM (NDIM+1)</span></div>
<div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;</div>
<div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;<span class="comment">// debug stuff</span></div>
<div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> showdebuglist(<span class="keywordtype">int</span> debugiter, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pppreholdlist)[NPR],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*ppposholdlist)[NPR],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*f1reportlist)[NPR],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*f1list)[NPR],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *errorabsf1list,<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *errorallabsf1list, <span class="keywordtype">int</span> *realiterlist, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*jaclist)[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aacf0ccefbc7e7f1e727cab83194d5bf4">MAXJACDIM</a>][<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aacf0ccefbc7e7f1e727cab83194d5bf4">MAXJACDIM</a>], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *fracdamplist, <span class="keywordtype">int</span> *implicititerlist, <span class="keywordtype">int</span> *implicitferrlist);</div>
<div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;<span class="keywordtype">int</span> mathematica_report_check(<span class="keywordtype">int</span> radinvmod, <span class="keywordtype">int</span> failtype, <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> failnum, <span class="keywordtype">int</span> gotfirstnofail, <span class="keywordtype">int</span> eomtypelocal, <span class="keywordtype">int</span> itermode, <span class="keywordtype">int</span> baseitermethod, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *errorabs, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *errorabsbestexternal, <span class="keywordtype">int</span> iters, <span class="keywordtype">int</span> iterstotal, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> realdt,<span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *ppfirst, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pp, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pb, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *piin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *prtestUiin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *prtestUU0, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *uu0, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *uu, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Uiin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ufin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUf, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUimp, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *q, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *dUother);</div>
<div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;</div>
<div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;<span class="comment">// explicit stuff (uses CUf instead of CUf since even with sub-cycling not implicit)</span></div>
<div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> get_dtsub(<span class="keywordtype">int</span> method, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *<a class="code" href="../../dc/dd2/newcodediff_8txt.html#ae7ab77d7e616dc02fba121a009b48c27">pr</a>, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *q, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ui, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Uf, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *dUother, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUf, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUimp, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Gdpl, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> chi, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Gdplabs, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *dtsub);</div>
<div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> koral_source_dtsub_rad_calc(<span class="keywordtype">int</span> method, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *<a class="code" href="../../dc/dd2/newcodediff_8txt.html#ae7ab77d7e616dc02fba121a009b48c27">pr</a>, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ui, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Uf, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *dUother, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUf, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUimp, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Gdpl, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *dtsub);</div>
<div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> source_explicit(<span class="keywordtype">int</span> whichsc, <span class="keywordtype">int</span> whichradsourcemethod, <span class="keywordtype">int</span> methoddtsub,<span class="keywordtype">int</span> *eomtype,</div>
<div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;                           <span class="keywordtype">void</span> (*sourcefunc)(<span class="keywordtype">int</span> method, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *<a class="code" href="../../dc/dd2/newcodediff_8txt.html#ae7ab77d7e616dc02fba121a009b48c27">pr</a>, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ui, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Uf, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *dUother, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUf, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUimp, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Gpl, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *dtsub),</div>
<div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;                           <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pb, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *piin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Uiin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ufin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUf, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUimp, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *q, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *dUother, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*dUcomp)[NPR]);</div>
<div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;</div>
<div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;<span class="comment">// RAD inversion stuff</span></div>
<div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> get_m1closure_gammarel2_old(<span class="keywordtype">int</span> showmessages, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Avcon, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Avcov, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *gammarel2return, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *deltareturn, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *numeratorreturn, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *divisorreturn);</div>
<div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ac65d2f7675d8e61488e8152455f7a9df" title="get&#39;s gamma^2 for lab-frame gamma using Rd and gcon">get_m1closure_gammarel2</a>(<span class="keywordtype">int</span> showmessages, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Avcon, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Avcov, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *gammarel2return, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *deltareturn, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *numeratorreturn, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *divisorreturn);</div>
<div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;</div>
<div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> get_m1closure_gammarel2_cold_old(<span class="keywordtype">int</span> showmessages, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Avcon, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Avcov, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *gammarel2return, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *deltareturn, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *numeratorreturn, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *divisorreturn, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Erfreturn, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *urfconrel);</div>
<div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ac417e724b77704df1dc35e32071df2f2" title="get&#39;s gamma assuming fixed E rather than using original R^t_t that we assume is flawed near floor reg...">get_m1closure_gammarel2_cold</a>(<span class="keywordtype">int</span> showmessages, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Avcon, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Avcov, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *gammarel2return, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *deltareturn, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *numeratorreturn, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *divisorreturn, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Erfreturn, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *urfconrel);</div>
<div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;</div>
<div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a4f76ac5680b95db932b2cf3ee309fb07" title="get Erf">get_m1closure_Erf</a>(<span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Avcon, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammarel2, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Erfreturn);</div>
<div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;</div>
<div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> get_m1closure_urfconrel_old(<span class="keywordtype">int</span> showmessages, <span class="keywordtype">int</span> allowlocalfailurefixandnoreport, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pp, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Avcon, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Avcov, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammarel2, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#aa5ebb2763dd5546bc40222826cea731f">delta</a>, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> numerator, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> divisor, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Erfreturn, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *urfconrel, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflag, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflagrad);</div>
<div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a69289f92f5afd222ade67c4e9c60285a" title="get contravariant relative 4-velocity in lab frame">get_m1closure_urfconrel</a>(<span class="keywordtype">int</span> showmessages, <span class="keywordtype">int</span> allowlocalfailurefixandnoreport, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pp, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Avcon, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Avcov, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammarel2, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#aa5ebb2763dd5546bc40222826cea731f">delta</a>, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> numerator, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> divisor, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Erfreturn, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *urfconrel, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflag, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflagrad);</div>
<div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a56eedd5db3838b564acfd63644b07c2a" title="get contravariant relative 4-velocity in lab frame using Olek&#39;s koral choices">get_m1closure_urfconrel_olek</a>(<span class="keywordtype">int</span> showmessages, <span class="keywordtype">int</span> allowlocalfailurefixandnoreport, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pp, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Avcon, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Avcov, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammarel2, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#aa5ebb2763dd5546bc40222826cea731f">delta</a>, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Erfreturn, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *urfconrel, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflag, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflagrad);</div>
<div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;</div>
<div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a4c389f16ba2ced5143cb408ea6a39459" title="interpolate between optically thick and thin limits when no u2p_rad() inversion solution">opacity_interpolated_urfconrel</a>(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> tautotmax, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pp,<span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom,<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Avcon, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Erf,<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammarel2,<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Erfnew, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *urfconrel);</div>
<div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;</div>
<div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;<span class="comment">// general stuff</span></div>
<div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;<span class="keyword">static</span> <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5dcc789108ddf06ec44fb22770f18e90" title="compute dt for this sub-step">compute_dt</a>(<span class="keywordtype">int</span> isexplicit, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUf, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUimp, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dtin);</div>
<div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;</div>
<div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aaa32f967773a287ecb6647732157606f" title="get G_">calc_Gd</a>(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pp, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *q ,<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *<a class="code" href="../../d8/d5b/defs_8general_8h.html#a1b697356441aab8d55c753517a360792">G</a>, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Tgasreturn, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Tradreturn, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *chieffreturn, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *ndotffreturn, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *ndotffabsreturn, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Gabs);</div>
<div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab62b07a8cbcc04f20c05a468ad6de636" title="compute G^ 4-force">calc_Gu</a>(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pp, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *q ,<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Gu, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Tgasreturn, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Tradreturn, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a>* chieffreturn, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *ndotffreturn, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *ndotffabsreturn, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Gabs);</div>
<div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#abd01208ba3c5754ea5587bcaefcaa01b" title="get lab-frame 3-velocity for radiative emission in radiative frame">simplefast_rad</a>(<span class="keywordtype">int</span> dir, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *geom,<span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *q, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> vrad2,<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *vmin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *vmax);</div>
<div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;</div>
<div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;</div>
<div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a3ad3833ac14b93095e76f8d915c5c9ad">calcfull_Trad</a>(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pp, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Trad, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *nrad, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *expfactorrad);</div>
<div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8242523b45077ccd783a2867dddb731a" title="compute Trad (also computed directly in calc_Gu() above) using only primitives (not using conserved q...">calc_Trad</a>(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pp, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *q , <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Trad, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *nrad, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *expfactorrad);</div>
<div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a864793af319e70c0d099679fa81dd398" title="compute Trad (also computed directly in calc_Gu() above) using only primitives (not using conserved q...">calc_Trad_fromRuuandgamma</a>(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pp, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Ruu, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammaradgas, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Trad, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *nrad, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *expfactorrad);</div>
<div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;</div>
<div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;</div>
<div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;</div>
<div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;</div>
<div class="line"><a name="l00766"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a439b24ca8b87220703a1f950242344b7">  766</a></span>&#160;<span class="preprocessor">#define FIMPLICITCALLTYPEF1 1</span></div>
<div class="line"><a name="l00767"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aed44d99ba064f5db1486676c305f80e2">  767</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define FIMPLICITCALLTYPEFINALCHECK 2</span></div>
<div class="line"><a name="l00768"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a195d482ffa46307e2e7ed74f457d5300">  768</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define FIMPLICITCALLTYPEJAC 3</span></div>
<div class="line"><a name="l00769"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a137120b9d350a5e9706de4a7a9dde9fb">  769</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define FIMPLICITCALLTYPEFINALCHECK2 4</span></div>
<div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;</div>
<div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;</div>
<div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;</div>
<div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;</div>
<div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;<span class="comment">// KORALTODO:  If solve for full RHO+MHD+RAD solution and iterate primitives instead, then can nominally better avoid out of bounds p(U) inversion.  While involves 1+4+4=9 dimensional Newton&#39;s method, use of p(U) is avoided completely so saves lots of time.  Only ever need to call U(p).  But then doesn&#39;t take advantage of accurate(and reductions) for p(U).</span></div>
<div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;</div>
<div class="line"><a name="l00777"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a6c45d4170066340923e6ec67e05436f4">  777</a></span>&#160;<span class="preprocessor">#define DIMTYPEFCONS 0</span></div>
<div class="line"><a name="l00778"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab02ce49b9873ae6d9b33d05f1a675f0b">  778</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define DIMTYPEFPRIM 1</span></div>
<div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00782"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aca02306e49f39d9dfc81492b850fb466">  782</a></span>&#160;<span class="preprocessor">#define UTOPRIMGENWRAPPERRETURNNOFAIL  (UTOPRIMNOFAIL)</span></div>
<div class="line"><a name="l00783"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a3dc38d50c77a49ac41a760b684ad7aab">  783</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define UTOPRIMGENWRAPPERRETURNFAILRAD (1)</span></div>
<div class="line"><a name="l00784"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a37d8e953a25b51ce606f181bbc18d562">  784</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define UTOPRIMGENWRAPPERRETURNFAILMHD (2)</span></div>
<div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> Utoprimgen_failwrapper(<span class="keywordtype">int</span> doradonly, <span class="keywordtype">int</span> *radinvmod, <span class="keywordtype">int</span> showmessages, <span class="keywordtype">int</span> checkoninversiongas, <span class="keywordtype">int</span> checkoninversionrad, <span class="keywordtype">int</span> allowlocalfailurefixandnoreport, <span class="keywordtype">int</span> finalstep, <span class="keywordtype">int</span> *eomtype, <span class="keywordtype">int</span> whichcap, <span class="keywordtype">int</span> evolvetype, <span class="keywordtype">int</span> inputtype,<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *U,  <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *qptr,  <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dissmeasure, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr, <span class="keyword">struct</span> <a class="code" href="../../db/d3a/structof__newtonstats.html">of_newtonstats</a> *newtonstats)</div>
<div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;{</div>
<div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;  <span class="keywordtype">int</span> failreturn;</div>
<div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;  <span class="comment">// defaults</span></div>
<div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;  failreturn=0;</div>
<div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;</div>
<div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;</div>
<div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;  <span class="keywordtype">int</span> eomtypelocal=*eomtype;</div>
<div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;</div>
<div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;</div>
<div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;  <span class="comment">// KORALTODO: </span></div>
<div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;  <span class="comment">// flag needs to be reset to preexistingfail(gas/rad) is not a failure.  Only use preexisting catches in utoprimgen.c if done with 4-force and report error in pflag and eventually go to the final advance.c inversion.</span></div>
<div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;  GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>)=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#abdf9e55b7b15ec0bcd386055f1787f47">UTOPRIMNOFAIL</a>;</div>
<div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;  GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>)=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6435e9609d622c9dbaf78c12658ecf8e">UTOPRIMRADNOFAIL</a>;</div>
<div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;  </div>
<div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;</div>
<div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;  <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflag,*lpflagrad;</div>
<div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;  lpflag=&amp;GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>);</div>
<div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;  lpflagrad=&amp;GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>);</div>
<div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;</div>
<div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;</div>
<div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;  <span class="keywordflow">if</span>(doradonly==1){ <span class="comment">// if doradonly==1, no need to call Utoprimgen() and no use for checkoninversiongas or checkoninversionrad</span></div>
<div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;    <a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#a9fe58e7f372421d18633c8fc5007b815">u2p_rad</a>(showmessages, allowlocalfailurefixandnoreport,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#addff6a9e94a657b1acf23dbc17257475" title="during implicit solver, don&#39;t limit gamma so much as normally. Otherwise, solution may not be found a...">GAMMAMAXRADIMPLICITSOLVER</a>,whichcap,U,pr,ptrgeom,lpflag,lpflagrad);</div>
<div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;    *radinvmod=(int)(*lpflagrad);</div>
<div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;  }</div>
<div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;    <span class="comment">//calculating primitives  </span></div>
<div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;    <span class="comment">// OPTMARK: Should optimize this to  not try to get down to machine precision</span></div>
<div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;    <span class="keywordtype">int</span> whichmethod=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a46b689a25732194a759b43d32ac1570c" title="mode for inversion">MODEDEFAULT</a>; <span class="comment">// means don&#39;t change method from eomtype.</span></div>
<div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;    <span class="keywordtype">int</span> modprim=0;</div>
<div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;    <span class="comment">//    int checkoninversiongas=CHECKONINVERSION;</span></div>
<div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;    <span class="comment">//    int checkoninversionrad=CHECKONINVERSIONRAD;</span></div>
<div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;    <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(<a class="code" href="../../d1/d3e/utoprimgen_8c.html#a7e078cc9a354495bc85554d875a705d9" title="General explicit inversion of U[MHD]-&gt;P[MHD] and also inverts scalars. Inverts radiation if(EOMRADTYP...">Utoprimgen</a>(showmessages,checkoninversiongas,checkoninversionrad, allowlocalfailurefixandnoreport, finalstep, &amp;eomtypelocal, whichcap, whichmethod, modprim, evolvetype, inputtype, U, qptr, ptrgeom, dissmeasure, pr, pr, newtonstats),<span class="stringliteral">&quot;phys.tools.rad.c:Utoprimgen_failwrapper()&quot;</span>, <span class="stringliteral">&quot;Utoprimgen&quot;</span>, 1);</div>
<div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a83f34d96e4765fc9f40227de7fc65858" title="whether to allow changes in eomtype during implicit iterations generally not a good idea currently be...">SWITCHTOENTROPYIFCHANGESTOENTROPY</a>==1) *eomtype=eomtypelocal;</div>
<div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;    <span class="comment">// else don&#39;t change</span></div>
<div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;    *radinvmod=(int)(*lpflagrad);</div>
<div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;    <span class="comment">//    *radinvmod=0;  //KORALTODO: Not using method that needs this call, so for now don&#39;t pass radinvmod through to Utoprimgen().</span></div>
<div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;    <a class="code" href="../../d8/d5b/defs_8general_8h.html#a5f1c4a4bf07f7a6010404484cb9e6b50">nstroke</a>+=(newtonstats-&gt;<a class="code" href="../../db/d3a/structof__newtonstats.html#a073783ba864c07681c8999a67162202b">nstroke</a>);</div>
<div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;    <span class="comment">// this can change eomtype</span></div>
<div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;  }</div>
<div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;</div>
<div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;  <span class="comment">// check how inversion did.  If didn&#39;t succeed, then check if soft failure and pass.  Else if hard failure have to return didn&#39;t work.</span></div>
<div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a294c90ee60024e6f3548814e7ff10a41">IFUTOPRIMFAILSOFT</a>(*lpflag)){</div>
<div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;    <span class="comment">// assume soft failure ok, but reset</span></div>
<div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;    GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>)=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#abdf9e55b7b15ec0bcd386055f1787f47">UTOPRIMNOFAIL</a>;</div>
<div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;    <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a7df8286c59d491ba1117884d33499a7a">prod0dualfprintf</a>(showmessages &amp;&amp; debugfail&gt;=2,<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;Got soft MHD failure inversion failure during Utoprimgen_failwrapper: ijk=%d %d %d\n&quot;</span>,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k);</div>
<div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;  }</div>
<div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a16db3b3cf4bc03f044c72c62e75072db">IFUTOPRIMRADHARDFAIL</a>(*lpflagrad)){</div>
<div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;    <span class="comment">// can reduce Newton step if getting failure.</span></div>
<div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;    <span class="comment">// reset pflag for radiation to no failure, but treat here locally</span></div>
<div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;    GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>)=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6435e9609d622c9dbaf78c12658ecf8e">UTOPRIMRADNOFAIL</a>;</div>
<div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;    <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a7df8286c59d491ba1117884d33499a7a">prod0dualfprintf</a>(showmessages &amp;&amp; debugfail&gt;=2,<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;Got some radiation inversion failure during Utoprimgen_failwrapper: ijk=%d %d %d\n&quot;</span>,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k);</div>
<div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;    failreturn=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a3dc38d50c77a49ac41a760b684ad7aab">UTOPRIMGENWRAPPERRETURNFAILRAD</a>;</div>
<div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;  }</div>
<div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>( <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0894a5e6c53e2e8a143d10be7a42d492">IFUTOPRIMFAIL</a>(*lpflag) || <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a16db3b3cf4bc03f044c72c62e75072db">IFUTOPRIMRADHARDFAIL</a>(*lpflagrad) ){</div>
<div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;    <span class="comment">// these need to get fixed-up, but can&#39;t, so return failure</span></div>
<div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;    <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a7df8286c59d491ba1117884d33499a7a">prod0dualfprintf</a>(showmessages &amp;&amp; debugfail&gt;=2,<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;Got hard failure of inversion (MHD part only considered as hard) in f_implicit(): ijk=%d %d %d : %d %d\n&quot;</span>,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,*lpflag,*lpflagrad);</div>
<div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;    failreturn=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a37d8e953a25b51ce606f181bbc18d562">UTOPRIMGENWRAPPERRETURNFAILMHD</a>;</div>
<div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;  }</div>
<div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#a6fc838c14c5e9fc17d6d8bb3d868ec2f">PRODUCTION</a>==0){</div>
<div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;    <span class="comment">// no failure</span></div>
<div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;    <span class="comment">// prod0dualfprintf(1,fail_file,&quot;No failure in Utoprimgen_failwrapper: ijk=%d %d %d\n&quot;,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k);</span></div>
<div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;  }</div>
<div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;</div>
<div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;</div>
<div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;  <span class="comment">//DEBUG:</span></div>
<div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;<span class="preprocessor">#if(PRODUCTION==0)</span></div>
<div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;<span class="preprocessor"></span>  <span class="keywordflow">if</span>(debugfail&gt;=2 &amp;&amp; showmessages){</div>
<div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;    <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> q;</div>
<div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;    <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a689a0d22ad988934812b24448f9f8e91" title="used to check inversion, which has consistent pressure used to get things as functions of  instead of...">get_stateforcheckinversion</a>(pr, ptrgeom, &amp;q),<span class="stringliteral">&quot;flux.c:fluxcalc()&quot;</span>, <span class="stringliteral">&quot;get_state()&quot;</span>, 1);</div>
<div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;    <span class="keywordtype">int</span> outputtype=inputtype;</div>
<div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Unew[NPR];</div>
<div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;    <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a9a54096e4c40a15a2c1bf74266153616" title="calculate &quot;conserved&quot; quantities">primtoU</a>(outputtype,pr, &amp;q, ptrgeom, Unew, NULL),<span class="stringliteral">&quot;step_ch.c:advance()&quot;</span>, <span class="stringliteral">&quot;primtoU()&quot;</span>, 1); <span class="comment">// UtoU inside doesn&#39;t do anything...therefore for REMOVERESTMASSFROMUU==1, Unew[UU] will have rest-mass included</span></div>
<div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;    <span class="keywordtype">int</span> pliter,pl;</div>
<div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;COMPARE: pl=%d pr=%g U=%g Unew=%g\n&quot;</span>,pl,pr[pl],U[pl],Unew[pl]);</div>
<div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;    <span class="keywordtype">int</span> jj;</div>
<div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;COMPARE: jj=%d uradcon=%g uradcov=%g\n&quot;</span>,jj,q.<a class="code" href="../../d1/d83/structof__state.html#a3bf8e15ee6ae95831230791baf2fc570">uradcon</a>[jj],q.<a class="code" href="../../d1/d83/structof__state.html#a87c04c4f890495e87a6682643a0c7955">uradcov</a>[jj]);</div>
<div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;COMPARE: jj=%d ucon=%g ucov=%g\n&quot;</span>,jj,q.<a class="code" href="../../d1/d83/structof__state.html#aab723d3c7c2c48b7246cc7d7d5379eed">ucon</a>[jj],q.<a class="code" href="../../d1/d83/structof__state.html#a09881c3d05809ef27f8115d02a835e11">ucov</a>[jj]);</div>
<div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;  }</div>
<div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;  <span class="comment">//DEBUG:</span></div>
<div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;  <span class="keywordflow">if</span>((showmessages || debugfail&gt;=2)){</div>
<div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">int</span> maxlntries=0,maxnstroke=0;</div>
<div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;    <span class="keywordtype">int</span> diff;</div>
<div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;    diff=0;</div>
<div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;    <span class="comment">// For RADSHADOW, gets up to 5</span></div>
<div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;    <span class="keywordflow">if</span>(newtonstats-&gt;<a class="code" href="../../db/d3a/structof__newtonstats.html#a83280998e47831044a7e35299495a9bb">lntries</a>&gt;maxlntries){ maxlntries=newtonstats-&gt;<a class="code" href="../../db/d3a/structof__newtonstats.html#a83280998e47831044a7e35299495a9bb">lntries</a>; diff=1;}</div>
<div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;    <span class="keywordflow">if</span>(newtonstats-&gt;<a class="code" href="../../db/d3a/structof__newtonstats.html#a073783ba864c07681c8999a67162202b">nstroke</a>&gt;maxnstroke){ maxnstroke=newtonstats-&gt;<a class="code" href="../../db/d3a/structof__newtonstats.html#a073783ba864c07681c8999a67162202b">nstroke</a>; diff=1;}</div>
<div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;    <span class="comment">// only report if grew beyond prior maximum</span></div>
<div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;    <span class="keywordflow">if</span>(diff) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;newtonsteps: lntries=%d (max=%d) nstroke=%d (max=%d) logerror=%g\n&quot;</span>,newtonstats-&gt;<a class="code" href="../../db/d3a/structof__newtonstats.html#a83280998e47831044a7e35299495a9bb">lntries</a>,maxlntries,newtonstats-&gt;<a class="code" href="../../db/d3a/structof__newtonstats.html#a073783ba864c07681c8999a67162202b">nstroke</a>,maxnstroke,newtonstats-&gt;<a class="code" href="../../db/d3a/structof__newtonstats.html#a02529bef0a69373dc4e7e9e7a672d1db">lerrx</a>);</div>
<div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;  }</div>
<div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;  <span class="comment">// return failure mode of inversion U-&gt;P</span></div>
<div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;  <span class="keywordflow">return</span>(failreturn);</div>
<div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;}</div>
<div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;</div>
<div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;</div>
<div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;</div>
<div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;</div>
<div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;</div>
<div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;</div>
<div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;</div>
<div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;</div>
<div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;</div>
<div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;</div>
<div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;</div>
<div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;</div>
<div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;</div>
<div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;</div>
<div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;</div>
<div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;</div>
<div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;</div>
<div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;</div>
<div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;</div>
<div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;</div>
<div class="line"><a name="l00917"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aea080032b13db4a71781aee78fef9902">  917</a></span>&#160;<span class="preprocessor">#define QTYUMHD 0 // iter or ferr</span></div>
<div class="line"><a name="l00918"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a0cb9c70ab4deb85a764f6733a96e09cc">  918</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define QTYUMHDENERGYONLY 1 // ferr only for now</span></div>
<div class="line"><a name="l00919"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a37a2a0ddbf7a80e93124ce89084d89ca">  919</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define QTYUMHDMOMONLY 2 // ferr only for now</span></div>
<div class="line"><a name="l00920"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad919bedc37c48678c11e7e45cd1394cf">  920</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define QTYURAD 3 // iter or ferr</span></div>
<div class="line"><a name="l00921"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a4da30ea8bf56ef0570bf4bff5d3a0690">  921</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define QTYURADENERGYONLY 4 // ferr only for now</span></div>
<div class="line"><a name="l00922"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a40391d70529dd21b8440039934ae0481">  922</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define QTYURADMOMONLY 5 // ferr only for now</span></div>
<div class="line"><a name="l00923"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9cf5ca7f5e5aa1e0bdef53abe3f27c1c">  923</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define QTYPMHD 6 // only iter</span></div>
<div class="line"><a name="l00924"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8b10ec187cbee196f071e162563cd945">  924</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define QTYPMHDENERGYONLY 7 // iter</span></div>
<div class="line"><a name="l00925"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad1dda20c101a983834446c5c93791583">  925</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define QTYPMHDMOMONLY 8 // iter</span></div>
<div class="line"><a name="l00926"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#add9bc1d07725fe2851182eccaa8eb385">  926</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define QTYPRAD 9 // only iter</span></div>
<div class="line"><a name="l00927"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a935971192d256e2264437d7addfce8be">  927</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define QTYPRADENERGYONLY 10 // only iter</span></div>
<div class="line"><a name="l00928"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad3805d05cfc75b5288e7a7080cd6f42d">  928</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define QTYPRADMOMONLY 11 // only iter</span></div>
<div class="line"><a name="l00929"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ae83cfa7d219127e1aab2b1ccbe844bc6">  929</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define QTYENTROPYUMHD 12 // iter or ferr</span></div>
<div class="line"><a name="l00930"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a66968440681b95ca6b3d30a6d2a03c53">  930</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define QTYENTROPYUMHDENERGYONLY 13 // ferr only for now</span></div>
<div class="line"><a name="l00931"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a0ca856011b58f6beb89106ccbe6fac4e">  931</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define QTYENTROPYUMHDMOMONLY 14 // ferr only for now</span></div>
<div class="line"><a name="l00932"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a7a5a1fd5a93591755aa3e1af2019dc57">  932</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define QTYENTROPYPMHD 15 // iter (not used)</span></div>
<div class="line"><a name="l00933"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a61c603d870ef3ddc9007ad5e3e4e8175">  933</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define QTYENTROPYPMHDENERGYONLY 16 // iter (not used)</span></div>
<div class="line"><a name="l00934"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a1122ecb7b3790dd1227031b94b9a2846">  934</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define QTYENTROPYPMHDMOMONLY 17 // iter (not used)</span></div>
<div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;</div>
<div class="line"><a name="l00938"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a003b3a1fbd946c173da7ba3c6312e8e1">  938</a></span>&#160;<span class="preprocessor">#define IMPPTYPE(implicititer) (implicititer==QTYPMHD ||implicititer==QTYPMHDENERGYONLY ||implicititer==QTYPMHDMOMONLY || implicititer==QTYPRAD ||implicititer==QTYPRADENERGYONLY ||implicititer==QTYPRADMOMONLY   || implicititer==QTYENTROPYPMHD ||implicititer==QTYENTROPYPMHDENERGYONLY ||implicititer==QTYENTROPYPMHDMOMONLY)</span></div>
<div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00940"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a54453e145c6408911f60070de366b11a">  940</a></span>&#160;<span class="preprocessor">#define IMPUTYPE(implicititer) (implicititer==QTYUMHD ||implicititer==QTYUMHDENERGYONLY ||implicititer==QTYUMHDMOMONLY  || implicititer==QTYURAD ||implicititer==QTYURADENERGYONLY ||implicititer==QTYURADMOMONLY || implicititer==QTYENTROPYUMHD ||implicititer==QTYENTROPYUMHDENERGYONLY ||implicititer==QTYENTROPYUMHDMOMONLY)</span></div>
<div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00943"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a4d6b9e1b70703c6aa1d0f9dd9a7acb6b">  943</a></span>&#160;<span class="preprocessor">#define IMPMHDTYPE(implicititer) (implicititer==QTYPMHD ||implicititer==QTYPMHDENERGYONLY ||implicititer==QTYPMHDMOMONLY || implicititer==QTYUMHD ||implicititer==QTYUMHDENERGYONLY ||implicititer==QTYUMHDMOMONLY || implicititer==QTYENTROPYUMHD ||implicititer==QTYENTROPYUMHDENERGYONLY ||implicititer==QTYENTROPYUMHDMOMONLY)</span></div>
<div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00945"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afa83276da372e82e63df84146dc95411">  945</a></span>&#160;<span class="preprocessor">#define IMPRADTYPE(implicititer) (implicititer==QTYPRAD ||implicititer==QTYPRADENERGYONLY ||implicititer==QTYPRADMOMONLY || implicititer==QTYURAD ||implicititer==QTYURADENERGYONLY ||implicititer==QTYURADMOMONLY)</span></div>
<div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00948"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a33425cd25de3bba0ed1613fd419efefd">  948</a></span>&#160;<span class="preprocessor">#define IMPMHDTYPEBASE(baseitermethod) (baseitermethod==QTYPMHD || baseitermethod==QTYUMHD || baseitermethod==QTYENTROPYUMHD)</span></div>
<div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00950"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a7d3841c1f6026ab21196a7ee22a31957">  950</a></span>&#160;<span class="preprocessor">#define IMPRADTYPEBASE(baseitermethod) (baseitermethod==QTYPRAD || baseitermethod==QTYURAD)</span></div>
<div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00953"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa8c4409b81bebfe2ff9dc6f2f1c2472a">  953</a></span>&#160;<span class="preprocessor">#define IMPPMHDTYPE(implicititer) (implicititer==QTYPMHD ||implicititer==QTYPMHDENERGYONLY ||implicititer==QTYPMHDMOMONLY)</span></div>
<div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;</div>
<div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;</div>
<div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> define_method(<span class="keywordtype">int</span> iter, <span class="keywordtype">int</span> *eomtype, <span class="keywordtype">int</span> itermode, <span class="keywordtype">int</span> baseitermethod, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fracenergy, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dissmeasure, <span class="keyword">struct</span> <a class="code" href="../../d6/dbe/structof__method.html">of_method</a> *mtd)</div>
<div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;{</div>
<div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;  <span class="keywordtype">int</span> eomtypelocal=*eomtype; <span class="comment">// default, but not changing it so far.</span></div>
<div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;</div>
<div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;</div>
<div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;  <span class="keywordflow">if</span>(eomtypelocal==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aa28b06d889a02621b45edc716bfb2d01">EOMDEFAULT</a>){</div>
<div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;    eomtypelocal=<a class="code" href="../../da/d3e/definit_8h.html#a87e5572748e4cc27373e50bd78e6f2e8">EOMTYPE</a>; <span class="comment">// override</span></div>
<div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;  }</div>
<div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;</div>
<div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;</div>
<div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;<span class="preprocessor">#if(PRODUCTION==0)</span></div>
<div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;<span class="preprocessor"></span>  <span class="keywordflow">if</span>(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a764cd8d9be62c23988abfe51e269f6d3">EOMDONOTHING</a>(eomtypelocal)){</div>
<div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;    dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;Can&#39;t have EOMDONOTHING in radiation code.\n&quot;</span>);</div>
<div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;    myexit(938463651);</div>
<div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;  }</div>
<div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;</div>
<div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;  <span class="keywordflow">if</span>(itermode==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a480c56e263c4874ccb40f3bbc1b32032">ITERMODESTAGES</a>){</div>
<div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;    mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#ab82f125cc45b1d2881155d70795fbf8a">BEGINMOMSTEPS</a>=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a215a0f9e703918348ac4a584aa31527a" title="for ITERSTAGES">BEGINMOMSTEPS0</a>;</div>
<div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;    mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a854fcca7e3e1d7ab0a6955321ce698de">ENDMOMSTEPS</a>=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad7c85ad00ab6537b38c3ef32a7c93e79">ENDMOMSTEPS0</a>;</div>
<div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;</div>
<div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;    mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a6412a5671687f2d9f5be2fd0fafb81f1">BEGINENERGYSTEPS</a>=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a52fd5f64bbf965a0c577b7a488beda2d">BEGINENERGYSTEPS0</a>;</div>
<div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;    mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a9829068ffbaa124dda46be28c48bfccc">ENDENERGYSTEPS</a>=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a6e0423fe97337a6136820c53f57538ff">ENDENERGYSTEPS0</a>;</div>
<div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;</div>
<div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;    mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a73849808a0b3a900c373b244089eab1f">BEGINFULLSTEPS</a>=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5534cdf286fe7b676c4dd9ba557bed49">BEGINFULLSTEPS0</a>;</div>
<div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;    mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#acda8029c6baa1a6f01a7f60bbe748ebb">ENDFULLSTEPS</a>=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5e079c1feac0db5af63685df3ca739a5">ENDFULLSTEPS0</a>;</div>
<div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;</div>
<div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;    mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a95212a0a740e95e0e2cc94cc9f4d0f7d">BEGINNORMALSTEPS</a>=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#acfe830a6ff019e8ad515f620df909c69">BEGINNORMALSTEPS0</a>;</div>
<div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;  }</div>
<div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(itermode==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab9c7390f62ef08325e12b7110621d33a">ITERMODENORMAL</a>){</div>
<div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;    mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#ab82f125cc45b1d2881155d70795fbf8a">BEGINMOMSTEPS</a>=-1;</div>
<div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;    mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a854fcca7e3e1d7ab0a6955321ce698de">ENDMOMSTEPS</a>=-1;</div>
<div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;</div>
<div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;    mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a6412a5671687f2d9f5be2fd0fafb81f1">BEGINENERGYSTEPS</a>=-1;</div>
<div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;    mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a9829068ffbaa124dda46be28c48bfccc">ENDENERGYSTEPS</a>=-1;</div>
<div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;</div>
<div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;    mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a73849808a0b3a900c373b244089eab1f">BEGINFULLSTEPS</a>=1;</div>
<div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;    mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#acda8029c6baa1a6f01a7f60bbe748ebb">ENDFULLSTEPS</a>=(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a58cca3253f4dfcefde5fe864699e297a">IMPMAXITERLONG</a>*2);</div>
<div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;</div>
<div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;    mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a95212a0a740e95e0e2cc94cc9f4d0f7d">BEGINNORMALSTEPS</a>=1; <span class="comment">// has to be consistent with actual first iteration, which is currently 1.</span></div>
<div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;  }</div>
<div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(itermode==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a18693ca111670c1ff38ab2206f70c81e">ITERMODECOLD</a>){</div>
<div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;    mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#ab82f125cc45b1d2881155d70795fbf8a">BEGINMOMSTEPS</a>=1;</div>
<div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;    mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a854fcca7e3e1d7ab0a6955321ce698de">ENDMOMSTEPS</a>=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a58cca3253f4dfcefde5fe864699e297a">IMPMAXITERLONG</a>*2;</div>
<div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;</div>
<div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;    mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a6412a5671687f2d9f5be2fd0fafb81f1">BEGINENERGYSTEPS</a>=-1;</div>
<div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;    mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a9829068ffbaa124dda46be28c48bfccc">ENDENERGYSTEPS</a>=-1;</div>
<div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;</div>
<div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;    mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a73849808a0b3a900c373b244089eab1f">BEGINFULLSTEPS</a>=-1;</div>
<div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;    mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#acda8029c6baa1a6f01a7f60bbe748ebb">ENDFULLSTEPS</a>=-1;</div>
<div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;</div>
<div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;    mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a95212a0a740e95e0e2cc94cc9f4d0f7d">BEGINNORMALSTEPS</a>=1;</div>
<div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;  }</div>
<div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;<span class="preprocessor">#if(PRODUCTION==0)</span></div>
<div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;<span class="preprocessor"></span>    dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;No such itermode=%d\n&quot;</span>,itermode);</div>
<div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;    myexit(30486346);</div>
<div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;<span class="preprocessor"></span>  }</div>
<div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;</div>
<div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;</div>
<div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;</div>
<div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;</div>
<div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;  <span class="keywordflow">if</span>(eomtypelocal==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a03d89f51ab60206791830c886d62bfd0">EOMGRMHD</a>||eomtypelocal==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a757ad8b9c2c7611dad8aab853a87f61b">EOMCOLDGRMHD</a>){</div>
<div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;</div>
<div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;    <span class="comment">// V1: Works fine, but slow.  Gives hot fluid near jumps like torus edge.  Computing UU[ENTROPY] with or without source doesn&#39;t change much.</span></div>
<div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;    <span class="comment">//mtd-&gt;implicititer=(QTYURAD); // choice</span></div>
<div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;    <span class="comment">//mtd-&gt;implicitferr=(QTYURAD); // choice</span></div>
<div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;</div>
<div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;    <span class="comment">// V1: Ok unless entropy source added.</span></div>
<div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;    <span class="comment">//mtd-&gt;implicititer=(QTYUMHD); // choice</span></div>
<div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;    <span class="comment">//mtd-&gt;implicitferr=(QTYUMHD); // choice</span></div>
<div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;</div>
<div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;    <span class="comment">// V1: unstable with entropy source</span></div>
<div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;    <span class="comment">//mtd-&gt;implicititer=(QTYPRAD);</span></div>
<div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;    <span class="comment">//mtd-&gt;implicitferr=(QTYURAD);</span></div>
<div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;</div>
<div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;</div>
<div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a2f83d121d53cb234469475e3e4d41c45" title="whether to do subjac iter-dependent solver.">DOSUBJAC</a>==1){</div>
<div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;      <span class="comment">// assume iter=1 is first iteration</span></div>
<div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;      <span class="keywordflow">if</span>(iter&gt;=mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#ab82f125cc45b1d2881155d70795fbf8a">BEGINMOMSTEPS</a> &amp;&amp; iter&lt;=mtd-&gt;ENDMOMSTEPS){</div>
<div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;        <span class="keywordflow">if</span>(baseitermethod==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9cf5ca7f5e5aa1e0bdef53abe3f27c1c">QTYPMHD</a>){</div>
<div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;          mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>=(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad1dda20c101a983834446c5c93791583">QTYPMHDMOMONLY</a>); <span class="comment">// choice</span></div>
<div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;          mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a2c5c387f7161b69aad77ee5a13d30c68">implicitferr</a>=(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a37a2a0ddbf7a80e93124ce89084d89ca">QTYUMHDMOMONLY</a>);</div>
<div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;        }</div>
<div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(baseitermethod==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad919bedc37c48678c11e7e45cd1394cf">QTYURAD</a>){</div>
<div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;          mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>=(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a40391d70529dd21b8440039934ae0481">QTYURADMOMONLY</a>); <span class="comment">// choice</span></div>
<div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;          mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a2c5c387f7161b69aad77ee5a13d30c68">implicitferr</a>=(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a40391d70529dd21b8440039934ae0481">QTYURADMOMONLY</a>); <span class="comment">// choice</span></div>
<div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;        }</div>
<div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(baseitermethod==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#add9bc1d07725fe2851182eccaa8eb385">QTYPRAD</a>){</div>
<div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;          mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>=(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad3805d05cfc75b5288e7a7080cd6f42d">QTYPRADMOMONLY</a>); <span class="comment">// choice</span></div>
<div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;          mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a2c5c387f7161b69aad77ee5a13d30c68">implicitferr</a>=(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a40391d70529dd21b8440039934ae0481">QTYURADMOMONLY</a>); <span class="comment">// choice</span></div>
<div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;        }</div>
<div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;      }</div>
<div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span>(iter&gt;=mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a6412a5671687f2d9f5be2fd0fafb81f1">BEGINENERGYSTEPS</a> &amp;&amp; iter&lt;=mtd-&gt;ENDENERGYSTEPS){</div>
<div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;        <span class="keywordflow">if</span>(baseitermethod==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9cf5ca7f5e5aa1e0bdef53abe3f27c1c">QTYPMHD</a>){</div>
<div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;          mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>=(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8b10ec187cbee196f071e162563cd945">QTYPMHDENERGYONLY</a>); <span class="comment">// choice</span></div>
<div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;          mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a2c5c387f7161b69aad77ee5a13d30c68">implicitferr</a>=(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a0cb9c70ab4deb85a764f6733a96e09cc">QTYUMHDENERGYONLY</a>);</div>
<div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;        }</div>
<div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(baseitermethod==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad919bedc37c48678c11e7e45cd1394cf">QTYURAD</a>){</div>
<div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;          mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>=(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a4da30ea8bf56ef0570bf4bff5d3a0690">QTYURADENERGYONLY</a>); <span class="comment">// choice</span></div>
<div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;          mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a2c5c387f7161b69aad77ee5a13d30c68">implicitferr</a>=(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a4da30ea8bf56ef0570bf4bff5d3a0690">QTYURADENERGYONLY</a>);</div>
<div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;        }</div>
<div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(baseitermethod==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#add9bc1d07725fe2851182eccaa8eb385">QTYPRAD</a>){</div>
<div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;          mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>=(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a935971192d256e2264437d7addfce8be">QTYPRADENERGYONLY</a>); <span class="comment">// choice</span></div>
<div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;          mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a2c5c387f7161b69aad77ee5a13d30c68">implicitferr</a>=(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a4da30ea8bf56ef0570bf4bff5d3a0690">QTYURADENERGYONLY</a>);</div>
<div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;        }</div>
<div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;      }</div>
<div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span>(iter&gt;=mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a73849808a0b3a900c373b244089eab1f">BEGINFULLSTEPS</a> &amp;&amp; iter&lt;=mtd-&gt;ENDFULLSTEPS){</div>
<div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;        <span class="keywordflow">if</span>(baseitermethod==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9cf5ca7f5e5aa1e0bdef53abe3f27c1c">QTYPMHD</a>){</div>
<div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;          <span class="comment">// V1: noisy in atmosphere and torus edge, but otherwise ok.</span></div>
<div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;          mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>=(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9cf5ca7f5e5aa1e0bdef53abe3f27c1c">QTYPMHD</a>); <span class="comment">// choice</span></div>
<div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;          mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a2c5c387f7161b69aad77ee5a13d30c68">implicitferr</a>=(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aea080032b13db4a71781aee78fef9902" title="whether iterate or have as error function: MHD T^t_ or RAD R^t_, etc.">QTYUMHD</a>);</div>
<div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;        }</div>
<div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(baseitermethod==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad919bedc37c48678c11e7e45cd1394cf">QTYURAD</a>){</div>
<div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;          mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>=(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad919bedc37c48678c11e7e45cd1394cf">QTYURAD</a>); <span class="comment">// choice</span></div>
<div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;          mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a2c5c387f7161b69aad77ee5a13d30c68">implicitferr</a>=(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad919bedc37c48678c11e7e45cd1394cf">QTYURAD</a>); <span class="comment">// choice</span></div>
<div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;        }</div>
<div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(baseitermethod==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#add9bc1d07725fe2851182eccaa8eb385">QTYPRAD</a>){</div>
<div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;          mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>=(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#add9bc1d07725fe2851182eccaa8eb385">QTYPRAD</a>); <span class="comment">// choice</span></div>
<div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;          mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a2c5c387f7161b69aad77ee5a13d30c68">implicitferr</a>=(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad919bedc37c48678c11e7e45cd1394cf">QTYURAD</a>); <span class="comment">// choice</span></div>
<div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;        }</div>
<div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;      }</div>
<div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;      <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;<span class="preprocessor">#if(PRODUCTION==0)</span></div>
<div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;<span class="preprocessor"></span>        dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;A Not setup for iter=%d %d %d %g : %d %d : %d %d : %d %d : %d : %d\n&quot;</span>,iter, *eomtype, itermode, fracenergy, mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#ab82f125cc45b1d2881155d70795fbf8a">BEGINMOMSTEPS</a>, mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a854fcca7e3e1d7ab0a6955321ce698de">ENDMOMSTEPS</a>, mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a6412a5671687f2d9f5be2fd0fafb81f1">BEGINENERGYSTEPS</a>, mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a9829068ffbaa124dda46be28c48bfccc">ENDENERGYSTEPS</a>, mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a73849808a0b3a900c373b244089eab1f">BEGINFULLSTEPS</a>, mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#acda8029c6baa1a6f01a7f60bbe748ebb">ENDFULLSTEPS</a>, mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a95212a0a740e95e0e2cc94cc9f4d0f7d">BEGINNORMALSTEPS</a>,baseitermethod);</div>
<div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;        myexit(3498346457);</div>
<div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;<span class="preprocessor"></span>      }</div>
<div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;    }</div>
<div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;      <span class="keywordflow">if</span>(baseitermethod==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9cf5ca7f5e5aa1e0bdef53abe3f27c1c">QTYPMHD</a>){</div>
<div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;        mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>=(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9cf5ca7f5e5aa1e0bdef53abe3f27c1c">QTYPMHD</a>); <span class="comment">// choice</span></div>
<div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;        mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a2c5c387f7161b69aad77ee5a13d30c68">implicitferr</a>=(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aea080032b13db4a71781aee78fef9902" title="whether iterate or have as error function: MHD T^t_ or RAD R^t_, etc.">QTYUMHD</a>);</div>
<div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;      }</div>
<div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span>(baseitermethod==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad919bedc37c48678c11e7e45cd1394cf">QTYURAD</a>){</div>
<div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;        mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>=(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad919bedc37c48678c11e7e45cd1394cf">QTYURAD</a>); <span class="comment">// choice</span></div>
<div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;        mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a2c5c387f7161b69aad77ee5a13d30c68">implicitferr</a>=(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad919bedc37c48678c11e7e45cd1394cf">QTYURAD</a>); <span class="comment">// choice</span></div>
<div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;      }</div>
<div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span>(baseitermethod==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#add9bc1d07725fe2851182eccaa8eb385">QTYPRAD</a>){</div>
<div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;        mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>=(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#add9bc1d07725fe2851182eccaa8eb385">QTYPRAD</a>); <span class="comment">// choice</span></div>
<div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;        mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a2c5c387f7161b69aad77ee5a13d30c68">implicitferr</a>=(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad919bedc37c48678c11e7e45cd1394cf">QTYURAD</a>); <span class="comment">// choice</span></div>
<div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;      }</div>
<div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;    }</div>
<div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;  }</div>
<div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(eomtypelocal==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a40b55e98bfcccde1a3f19d983ca7488c">EOMENTROPYGRMHD</a>){</div>
<div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160;</div>
<div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;    <span class="comment">// V2: Like V1 but goes unstable.</span></div>
<div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160;    <span class="comment">//mtd-&gt;implicititer=(QTYUMHD); // choice</span></div>
<div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160;    <span class="comment">//mtd-&gt;implicitferr=(QTYENTROPYUMHD); // choice</span></div>
<div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;</div>
<div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160;</div>
<div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a2f83d121d53cb234469475e3e4d41c45" title="whether to do subjac iter-dependent solver.">DOSUBJAC</a>==1){</div>
<div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160;      <span class="comment">// assume iter=1 is first iteration</span></div>
<div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;      <span class="keywordflow">if</span>(iter&gt;=mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#ab82f125cc45b1d2881155d70795fbf8a">BEGINMOMSTEPS</a> &amp;&amp; iter&lt;=mtd-&gt;ENDMOMSTEPS){</div>
<div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;        <span class="keywordflow">if</span>(baseitermethod==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9cf5ca7f5e5aa1e0bdef53abe3f27c1c">QTYPMHD</a>){</div>
<div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;          mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>=(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad1dda20c101a983834446c5c93791583">QTYPMHDMOMONLY</a>); <span class="comment">// choice</span></div>
<div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;          mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a2c5c387f7161b69aad77ee5a13d30c68">implicitferr</a>=(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a0ca856011b58f6beb89106ccbe6fac4e">QTYENTROPYUMHDMOMONLY</a>);</div>
<div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160;        }</div>
<div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(baseitermethod==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ae83cfa7d219127e1aab2b1ccbe844bc6">QTYENTROPYUMHD</a>){</div>
<div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;          mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>=(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a0ca856011b58f6beb89106ccbe6fac4e">QTYENTROPYUMHDMOMONLY</a>);</div>
<div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160;          mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a2c5c387f7161b69aad77ee5a13d30c68">implicitferr</a>=(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a0ca856011b58f6beb89106ccbe6fac4e">QTYENTROPYUMHDMOMONLY</a>);</div>
<div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;        }</div>
<div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(baseitermethod==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad919bedc37c48678c11e7e45cd1394cf">QTYURAD</a>){</div>
<div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;          mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>=(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a40391d70529dd21b8440039934ae0481">QTYURADMOMONLY</a>); <span class="comment">// choice</span></div>
<div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;          mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a2c5c387f7161b69aad77ee5a13d30c68">implicitferr</a>=(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a40391d70529dd21b8440039934ae0481">QTYURADMOMONLY</a>); <span class="comment">// choice</span></div>
<div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160;        }</div>
<div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(baseitermethod==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#add9bc1d07725fe2851182eccaa8eb385">QTYPRAD</a>){</div>
<div class="line"><a name="l01133"></a><span class="lineno"> 1133</span>&#160;          mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>=(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad3805d05cfc75b5288e7a7080cd6f42d">QTYPRADMOMONLY</a>); <span class="comment">// choice</span></div>
<div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;          mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a2c5c387f7161b69aad77ee5a13d30c68">implicitferr</a>=(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a40391d70529dd21b8440039934ae0481">QTYURADMOMONLY</a>); <span class="comment">// choice</span></div>
<div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160;        }</div>
<div class="line"><a name="l01136"></a><span class="lineno"> 1136</span>&#160;      }</div>
<div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span>(iter&gt;=mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a6412a5671687f2d9f5be2fd0fafb81f1">BEGINENERGYSTEPS</a> &amp;&amp; iter&lt;=mtd-&gt;ENDENERGYSTEPS){</div>
<div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160;        <span class="keywordflow">if</span>(baseitermethod==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9cf5ca7f5e5aa1e0bdef53abe3f27c1c">QTYPMHD</a>){</div>
<div class="line"><a name="l01139"></a><span class="lineno"> 1139</span>&#160;          mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>=(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8b10ec187cbee196f071e162563cd945">QTYPMHDENERGYONLY</a>); <span class="comment">// choice</span></div>
<div class="line"><a name="l01140"></a><span class="lineno"> 1140</span>&#160;          mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a2c5c387f7161b69aad77ee5a13d30c68">implicitferr</a>=(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a66968440681b95ca6b3d30a6d2a03c53">QTYENTROPYUMHDENERGYONLY</a>);</div>
<div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160;        }</div>
<div class="line"><a name="l01142"></a><span class="lineno"> 1142</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(baseitermethod==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ae83cfa7d219127e1aab2b1ccbe844bc6">QTYENTROPYUMHD</a>){</div>
<div class="line"><a name="l01143"></a><span class="lineno"> 1143</span>&#160;          mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>=(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a66968440681b95ca6b3d30a6d2a03c53">QTYENTROPYUMHDENERGYONLY</a>);</div>
<div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160;          mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a2c5c387f7161b69aad77ee5a13d30c68">implicitferr</a>=(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a66968440681b95ca6b3d30a6d2a03c53">QTYENTROPYUMHDENERGYONLY</a>);</div>
<div class="line"><a name="l01145"></a><span class="lineno"> 1145</span>&#160;        }</div>
<div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(baseitermethod==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad919bedc37c48678c11e7e45cd1394cf">QTYURAD</a>){</div>
<div class="line"><a name="l01147"></a><span class="lineno"> 1147</span>&#160;          mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>=(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a4da30ea8bf56ef0570bf4bff5d3a0690">QTYURADENERGYONLY</a>); <span class="comment">// choice</span></div>
<div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160;          mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a2c5c387f7161b69aad77ee5a13d30c68">implicitferr</a>=(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a4da30ea8bf56ef0570bf4bff5d3a0690">QTYURADENERGYONLY</a>); <span class="comment">// choice</span></div>
<div class="line"><a name="l01149"></a><span class="lineno"> 1149</span>&#160;        }</div>
<div class="line"><a name="l01150"></a><span class="lineno"> 1150</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(baseitermethod==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#add9bc1d07725fe2851182eccaa8eb385">QTYPRAD</a>){</div>
<div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160;          mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>=(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a935971192d256e2264437d7addfce8be">QTYPRADENERGYONLY</a>); <span class="comment">// choice</span></div>
<div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160;          mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a2c5c387f7161b69aad77ee5a13d30c68">implicitferr</a>=(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a4da30ea8bf56ef0570bf4bff5d3a0690">QTYURADENERGYONLY</a>);</div>
<div class="line"><a name="l01153"></a><span class="lineno"> 1153</span>&#160;        }</div>
<div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;      }</div>
<div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span>(iter&gt;=mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a73849808a0b3a900c373b244089eab1f">BEGINFULLSTEPS</a> &amp;&amp; iter&lt;=mtd-&gt;ENDFULLSTEPS){</div>
<div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160;        <span class="keywordflow">if</span>(baseitermethod==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9cf5ca7f5e5aa1e0bdef53abe3f27c1c">QTYPMHD</a>){</div>
<div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160;          <span class="comment">// V2: perfectly fine as entropy method</span></div>
<div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160;          mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>=(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9cf5ca7f5e5aa1e0bdef53abe3f27c1c">QTYPMHD</a>); <span class="comment">// choice</span></div>
<div class="line"><a name="l01159"></a><span class="lineno"> 1159</span>&#160;          mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a2c5c387f7161b69aad77ee5a13d30c68">implicitferr</a>=(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ae83cfa7d219127e1aab2b1ccbe844bc6">QTYENTROPYUMHD</a>); <span class="comment">// choice</span></div>
<div class="line"><a name="l01160"></a><span class="lineno"> 1160</span>&#160;        }</div>
<div class="line"><a name="l01161"></a><span class="lineno"> 1161</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(baseitermethod==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ae83cfa7d219127e1aab2b1ccbe844bc6">QTYENTROPYUMHD</a>){</div>
<div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160;          <span class="comment">// V1: works perfectly fine and acts like PMHD,ENTROPYUMHD method just slower:</span></div>
<div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;          mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>=(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ae83cfa7d219127e1aab2b1ccbe844bc6">QTYENTROPYUMHD</a>);</div>
<div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160;          mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a2c5c387f7161b69aad77ee5a13d30c68">implicitferr</a>=(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ae83cfa7d219127e1aab2b1ccbe844bc6">QTYENTROPYUMHD</a>);</div>
<div class="line"><a name="l01165"></a><span class="lineno"> 1165</span>&#160;        }</div>
<div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(baseitermethod==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad919bedc37c48678c11e7e45cd1394cf">QTYURAD</a>){</div>
<div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;          mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>=(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad919bedc37c48678c11e7e45cd1394cf">QTYURAD</a>); <span class="comment">// choice</span></div>
<div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160;          mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a2c5c387f7161b69aad77ee5a13d30c68">implicitferr</a>=(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad919bedc37c48678c11e7e45cd1394cf">QTYURAD</a>); <span class="comment">// choice</span></div>
<div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160;        }</div>
<div class="line"><a name="l01170"></a><span class="lineno"> 1170</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(baseitermethod==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#add9bc1d07725fe2851182eccaa8eb385">QTYPRAD</a>){</div>
<div class="line"><a name="l01171"></a><span class="lineno"> 1171</span>&#160;          mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>=(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#add9bc1d07725fe2851182eccaa8eb385">QTYPRAD</a>); <span class="comment">// choice</span></div>
<div class="line"><a name="l01172"></a><span class="lineno"> 1172</span>&#160;          mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a2c5c387f7161b69aad77ee5a13d30c68">implicitferr</a>=(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad919bedc37c48678c11e7e45cd1394cf">QTYURAD</a>);</div>
<div class="line"><a name="l01173"></a><span class="lineno"> 1173</span>&#160;        }</div>
<div class="line"><a name="l01174"></a><span class="lineno"> 1174</span>&#160;      }</div>
<div class="line"><a name="l01175"></a><span class="lineno"> 1175</span>&#160;      <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l01176"></a><span class="lineno"> 1176</span>&#160;<span class="preprocessor">#if(PRODUCTION==0)</span></div>
<div class="line"><a name="l01177"></a><span class="lineno"> 1177</span>&#160;<span class="preprocessor"></span>        dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;B Not setup for iter=%d %d %d %g : %d %d : %d %d : %d %d : %d : %d\n&quot;</span>,iter, *eomtype, itermode, fracenergy, mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#ab82f125cc45b1d2881155d70795fbf8a">BEGINMOMSTEPS</a>, mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a854fcca7e3e1d7ab0a6955321ce698de">ENDMOMSTEPS</a>, mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a6412a5671687f2d9f5be2fd0fafb81f1">BEGINENERGYSTEPS</a>, mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a9829068ffbaa124dda46be28c48bfccc">ENDENERGYSTEPS</a>, mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a73849808a0b3a900c373b244089eab1f">BEGINFULLSTEPS</a>, mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#acda8029c6baa1a6f01a7f60bbe748ebb">ENDFULLSTEPS</a>, mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a95212a0a740e95e0e2cc94cc9f4d0f7d">BEGINNORMALSTEPS</a>,baseitermethod);</div>
<div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160;        myexit(3498346458);</div>
<div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160;<span class="preprocessor"></span>      }</div>
<div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160;    }</div>
<div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l01183"></a><span class="lineno"> 1183</span>&#160;      <span class="keywordflow">if</span>(baseitermethod==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9cf5ca7f5e5aa1e0bdef53abe3f27c1c">QTYPMHD</a>){</div>
<div class="line"><a name="l01184"></a><span class="lineno"> 1184</span>&#160;        mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>=(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9cf5ca7f5e5aa1e0bdef53abe3f27c1c">QTYPMHD</a>); <span class="comment">// choice</span></div>
<div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160;        mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a2c5c387f7161b69aad77ee5a13d30c68">implicitferr</a>=(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ae83cfa7d219127e1aab2b1ccbe844bc6">QTYENTROPYUMHD</a>); <span class="comment">// choice</span></div>
<div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160;      }</div>
<div class="line"><a name="l01187"></a><span class="lineno"> 1187</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span>(baseitermethod==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ae83cfa7d219127e1aab2b1ccbe844bc6">QTYENTROPYUMHD</a>){</div>
<div class="line"><a name="l01188"></a><span class="lineno"> 1188</span>&#160;        mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>=(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ae83cfa7d219127e1aab2b1ccbe844bc6">QTYENTROPYUMHD</a>);</div>
<div class="line"><a name="l01189"></a><span class="lineno"> 1189</span>&#160;        mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a2c5c387f7161b69aad77ee5a13d30c68">implicitferr</a>=(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ae83cfa7d219127e1aab2b1ccbe844bc6">QTYENTROPYUMHD</a>);</div>
<div class="line"><a name="l01190"></a><span class="lineno"> 1190</span>&#160;      }</div>
<div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span>(baseitermethod==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad919bedc37c48678c11e7e45cd1394cf">QTYURAD</a>){</div>
<div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160;        mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>=(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad919bedc37c48678c11e7e45cd1394cf">QTYURAD</a>); <span class="comment">// choice</span></div>
<div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;        mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a2c5c387f7161b69aad77ee5a13d30c68">implicitferr</a>=(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad919bedc37c48678c11e7e45cd1394cf">QTYURAD</a>); <span class="comment">// choice</span></div>
<div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160;      }</div>
<div class="line"><a name="l01195"></a><span class="lineno"> 1195</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span>(baseitermethod==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#add9bc1d07725fe2851182eccaa8eb385">QTYPRAD</a>){</div>
<div class="line"><a name="l01196"></a><span class="lineno"> 1196</span>&#160;        mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>=(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#add9bc1d07725fe2851182eccaa8eb385">QTYPRAD</a>); <span class="comment">// choice</span></div>
<div class="line"><a name="l01197"></a><span class="lineno"> 1197</span>&#160;        mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a2c5c387f7161b69aad77ee5a13d30c68">implicitferr</a>=(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad919bedc37c48678c11e7e45cd1394cf">QTYURAD</a>);</div>
<div class="line"><a name="l01198"></a><span class="lineno"> 1198</span>&#160;      }</div>
<div class="line"><a name="l01199"></a><span class="lineno"> 1199</span>&#160;    }</div>
<div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160;  }</div>
<div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160;<span class="preprocessor">#if(PRODUCTION==0)</span></div>
<div class="line"><a name="l01203"></a><span class="lineno"> 1203</span>&#160;<span class="preprocessor"></span>    dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;No such eomtypelocal=%d in define_method\n&quot;</span>,eomtypelocal);</div>
<div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;    myexit(938463653);</div>
<div class="line"><a name="l01205"></a><span class="lineno"> 1205</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;<span class="preprocessor"></span>  }</div>
<div class="line"><a name="l01207"></a><span class="lineno"> 1207</span>&#160;</div>
<div class="line"><a name="l01208"></a><span class="lineno"> 1208</span>&#160;  <span class="comment">// TESTING:</span></div>
<div class="line"><a name="l01209"></a><span class="lineno"> 1209</span>&#160;  <span class="comment">//mtd-&gt;implicititer=(QTYURAD); // choice</span></div>
<div class="line"><a name="l01210"></a><span class="lineno"> 1210</span>&#160;  <span class="comment">//mtd-&gt;implicitferr=(QTYURAD); // choice</span></div>
<div class="line"><a name="l01211"></a><span class="lineno"> 1211</span>&#160;</div>
<div class="line"><a name="l01212"></a><span class="lineno"> 1212</span>&#160;</div>
<div class="line"><a name="l01213"></a><span class="lineno"> 1213</span>&#160;}</div>
<div class="line"><a name="l01214"></a><span class="lineno"> 1214</span>&#160;</div>
<div class="line"><a name="l01215"></a><span class="lineno"> 1215</span>&#160;</div>
<div class="line"><a name="l01216"></a><span class="lineno"> 1216</span>&#160;</div>
<div class="line"><a name="l01217"></a><span class="lineno"> 1217</span>&#160;<span class="preprocessor">#if(0)</span></div>
<div class="line"><a name="l01218"></a><span class="lineno"> 1218</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define JACNPR (NDIM+1) // maximum number of terms in Jacobian</span></div>
<div class="line"><a name="l01219"></a><span class="lineno"> 1219</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define JACNUMTYPES 5</span></div>
<div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define JNORMALTYPE 0</span></div>
<div class="line"><a name="l01221"></a><span class="lineno"> 1221</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define JALTTYPE 1</span></div>
<div class="line"><a name="l01222"></a><span class="lineno"> 1222</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define JSUPERFULLTYPE 2</span></div>
<div class="line"><a name="l01223"></a><span class="lineno"> 1223</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define JFULLERRORTYPE 3</span></div>
<div class="line"><a name="l01224"></a><span class="lineno"> 1224</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define JSUBERRORTYPE 4</span></div>
<div class="line"><a name="l01225"></a><span class="lineno"> 1225</span>&#160;<span class="preprocessor"></span><span class="keywordtype">int</span> jacstart[JACNUMTYPES],jaclist[JACNUMTYPES][<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8a1b3014b620253123af842109580dfe">JACNPR</a>],jacend[JACNUMTYPES];</div>
<div class="line"><a name="l01226"></a><span class="lineno"> 1226</span>&#160;<span class="preprocessor">#define JACTYPELOOP(type) for(type=0;type&lt;JACNUMTYPES;type++)</span></div>
<div class="line"><a name="l01227"></a><span class="lineno"> 1227</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define JACALLLOOP(pl) for(pl=0;pl&lt;JACNPR;pl++)</span></div>
<div class="line"><a name="l01228"></a><span class="lineno"> 1228</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define JACLOOP(type,pliter,pl) for(pliter=jacstart[type],pl=jaclist[type][pliter];pliter&lt;=jacend[type];pliter++,pl=jaclist[type][pliter])</span></div>
<div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01231"></a><span class="lineno"> 1231</span>&#160;</div>
<div class="line"><a name="l01232"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8a1b3014b620253123af842109580dfe"> 1232</a></span>&#160;<span class="preprocessor">#define JACNPR (NDIM)</span></div>
<div class="line"><a name="l01233"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a33e29fbc91c598484cbeb76769ce1fd2"> 1233</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define JACLOOP(jj,startjj,endjj) for(jj=startjj;jj&lt;=endjj;jj++)</span></div>
<div class="line"><a name="l01234"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad362268c94979b8c041e986c54f7f59e"> 1234</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define JACLOOPALT(jj,startjj,endjj) DLOOPA(jj) //for(jj=startjj;jj&lt;=endjj;jj++) // for those things might or might not want to do all terms</span></div>
<div class="line"><a name="l01235"></a><span class="lineno"> 1235</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01236"></a><span class="lineno"> 1236</span>&#160;<span class="comment">// over f&#39;s, not primitives, to determine error</span></div>
<div class="line"><a name="l01237"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aef340eabe2a41c05add2b3d8527b0fd0"> 1237</a></span>&#160;<span class="preprocessor">#define JACLOOPSUPERFULL(pliter,pl,eomtype,baseitermethod,radinvmod) PLOOPDYNAMICAL(pliter,pl) if(\</span></div>
<div class="line"><a name="l01238"></a><span class="lineno"> 1238</span>&#160;<span class="preprocessor">pl!=ENTROPY &amp;&amp; pl!=UU &amp;&amp; pl!=URAD0 \</span></div>
<div class="line"><a name="l01239"></a><span class="lineno"> 1239</span>&#160;<span class="preprocessor">|| (eomtype==EOMDEFAULT &amp;&amp; EOMTYPE==EOMENTROPYGRMHD || eomtype==EOMENTROPYGRMHD || eomtype==EOMDIDENTROPYGRMHD) \</span></div>
<div class="line"><a name="l01240"></a><span class="lineno"> 1240</span>&#160;<span class="preprocessor">      &amp;&amp; (pl==ENTROPY || pl==URAD0 &amp;&amp; IMPMHDTYPEBASE(baseitermethod)==0 || IMPMHDTYPEBASE(baseitermethod)==1 &amp;&amp; (pl==URAD0 &amp;&amp; AVOIDURAD0IFRADINVMODANDPMHDMETHOD==0 || pl==URAD0 &amp;&amp; AVOIDURAD0IFRADINVMODANDPMHDMETHOD==1 &amp;&amp; radinvmod==0)) \</span></div>
<div class="line"><a name="l01241"></a><span class="lineno"> 1241</span>&#160;<span class="preprocessor">|| (eomtype==EOMDEFAULT &amp;&amp; EOMTYPE==EOMGRMHD || eomtype==EOMGRMHD || eomtype==EOMDIDGRMHD) \</span></div>
<div class="line"><a name="l01242"></a><span class="lineno"> 1242</span>&#160;<span class="preprocessor">      &amp;&amp; (pl==UU || pl==URAD0 &amp;&amp; IMPMHDTYPEBASE(baseitermethod)==0 || IMPMHDTYPEBASE(baseitermethod)==1 &amp;&amp; (pl==URAD0 &amp;&amp; AVOIDURAD0IFRADINVMODANDPMHDMETHOD==0 || pl==URAD0 &amp;&amp; AVOIDURAD0IFRADINVMODANDPMHDMETHOD==1 &amp;&amp; radinvmod==0) ) \</span></div>
<div class="line"><a name="l01243"></a><span class="lineno"> 1243</span>&#160;<span class="preprocessor">)</span></div>
<div class="line"><a name="l01244"></a><span class="lineno"> 1244</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01245"></a><span class="lineno"> 1245</span>&#160;<span class="comment">//#define JACLOOPSUPERFULL(pliter,pl,eomtype,baseitermethod,radinvmod) PLOOP(pliter,pl) if(pl!=ENTROPY &amp;&amp; pl!=UU &amp;&amp; pl!=URAD0 &amp;&amp; !SCALARPL(pl) || (eomtype==EOMDEFAULT &amp;&amp; EOMTYPE==EOMENTROPYGRMHD || eomtype==EOMENTROPYGRMHD || eomtype==EOMDIDENTROPYGRMHD) &amp;&amp; (pl==ENTROPY || pl==URAD0 &amp;&amp; IMPMHDTYPEBASE(baseitermethod)==0 || IMPMHDTYPEBASE(baseitermethod)==1 &amp;&amp; (pl==URAD0 &amp;&amp; AVOIDURAD0IFRADINVMODANDPMHDMETHOD==0 || pl==URAD0 &amp;&amp; AVOIDURAD0IFRADINVMODANDPMHDMETHOD==1 &amp;&amp; radinvmod==0)) || (eomtype==EOMDEFAULT &amp;&amp; EOMTYPE==EOMGRMHD || eomtype==EOMGRMHD || eomtype==EOMDIDGRMHD) &amp;&amp; (pl==UU || pl==URAD0 &amp;&amp; IMPMHDTYPEBASE(baseitermethod)==0 || IMPMHDTYPEBASE(baseitermethod)==1 &amp;&amp; (pl==URAD0 &amp;&amp; AVOIDURAD0IFRADINVMODANDPMHDMETHOD==0 || pl==URAD0 &amp;&amp; AVOIDURAD0IFRADINVMODANDPMHDMETHOD==1 &amp;&amp; radinvmod==0) )) // over f&#39;s, not primitives.</span></div>
<div class="line"><a name="l01246"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a60eea34b552378df229a78747fda6857"> 1246</a></span>&#160;<span class="preprocessor">#define JACLOOPFULLERROR(itermode,jj,startjj,endjj) for(jj=(itermode==ITERMODECOLD ? startjj : 0);jj&lt;=(itermode==ITERMODECOLD ? endjj : NDIM-1);jj++)</span></div>
<div class="line"><a name="l01247"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a72fc248e1a3a074c499fa4dfe283db6d"> 1247</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define JACLOOPSUBERROR(jj,startjj,endjj) JACLOOP(jj,startjj,endjj)</span></div>
<div class="line"><a name="l01248"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a06f52b18202ad535ff7c470055f5cb02"> 1248</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define JACLOOP2D(ii,jj,startjj,endjj) JACLOOP(ii,startjj,endjj) JACLOOP(jj,startjj,endjj)</span></div>
<div class="line"><a name="l01249"></a><span class="lineno"> 1249</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01250"></a><span class="lineno"> 1250</span>&#160;<span class="preprocessor">#if(0)</span></div>
<div class="line"><a name="l01251"></a><span class="lineno"> 1251</span>&#160;<span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">void</span> get_refUs(<span class="keywordtype">int</span> *numdims, <span class="keywordtype">int</span> *startjac, <span class="keywordtype">int</span> *endjac, <span class="keywordtype">int</span> *implicititer, <span class="keywordtype">int</span> *implicitferr, <span class="keywordtype">int</span> *irefU, <span class="keywordtype">int</span> *iotherU, <span class="keywordtype">int</span> *erefU, <span class="keywordtype">int</span> *eotherU, <span class="keywordtype">int</span> *signgd2, <span class="keywordtype">int</span> *signgd4, <span class="keywordtype">int</span> *signgd6, <span class="keywordtype">int</span> *signgd7)</div>
<div class="line"><a name="l01252"></a><span class="lineno"> 1252</span>&#160;{</div>
<div class="line"><a name="l01253"></a><span class="lineno"> 1253</span>&#160;  <span class="keywordtype">int</span> jj;</div>
<div class="line"><a name="l01254"></a><span class="lineno"> 1254</span>&#160;  <span class="keywordtype">int</span> type;</div>
<div class="line"><a name="l01255"></a><span class="lineno"> 1255</span>&#160;</div>
<div class="line"><a name="l01256"></a><span class="lineno"> 1256</span>&#160;</div>
<div class="line"><a name="l01257"></a><span class="lineno"> 1257</span>&#160;  <span class="comment">// default</span></div>
<div class="line"><a name="l01258"></a><span class="lineno"> 1258</span>&#160;</div>
<div class="line"><a name="l01259"></a><span class="lineno"> 1259</span>&#160;  <span class="comment">// default</span></div>
<div class="line"><a name="l01260"></a><span class="lineno"> 1260</span>&#160;  *numdims=jacend[JNORMALTYPE];</div>
<div class="line"><a name="l01261"></a><span class="lineno"> 1261</span>&#160;  *signgd7= (+1.0); <span class="comment">// not used for PMHD</span></div>
<div class="line"><a name="l01262"></a><span class="lineno"> 1262</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) irefU[jj]=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>+jj;</div>
<div class="line"><a name="l01263"></a><span class="lineno"> 1263</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) iotherU[jj]=URAD0+jj;</div>
<div class="line"><a name="l01264"></a><span class="lineno"> 1264</span>&#160;  <span class="comment">//  *startjac=0; *endjac=NDIM-1;</span></div>
<div class="line"><a name="l01265"></a><span class="lineno"> 1265</span>&#160;</div>
<div class="line"><a name="l01266"></a><span class="lineno"> 1266</span>&#160;  <span class="comment">// same list and numbers in array for both primitives and conserved</span></div>
<div class="line"><a name="l01267"></a><span class="lineno"> 1267</span>&#160;  <span class="keywordflow">if</span>(*implicititer==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aea080032b13db4a71781aee78fef9902" title="whether iterate or have as error function: MHD T^t_ or RAD R^t_, etc.">QTYUMHD</a> || *implicititer==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9cf5ca7f5e5aa1e0bdef53abe3f27c1c">QTYPMHD</a>){</div>
<div class="line"><a name="l01268"></a><span class="lineno"> 1268</span>&#160;    JACTYPELOOP(type){ jacstart[type]=0; jacend[type]=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>-1; <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) jaclist[type][jj]=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>+jj; }</div>
<div class="line"><a name="l01269"></a><span class="lineno"> 1269</span>&#160;  }</div>
<div class="line"><a name="l01270"></a><span class="lineno"> 1270</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(*implicititer==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a0cb9c70ab4deb85a764f6733a96e09cc">QTYUMHDENERGYONLY</a> || *implicititer==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8b10ec187cbee196f071e162563cd945">QTYPMHDENERGYONLY</a>){</div>
<div class="line"><a name="l01271"></a><span class="lineno"> 1271</span>&#160;    <span class="comment">//    *startjac=0; *endjac=0;</span></div>
<div class="line"><a name="l01272"></a><span class="lineno"> 1272</span>&#160;    JACTYPELOOP(type){ jacstart[type]=0; jacend[type]=0; jaclist[type][0]=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>; }</div>
<div class="line"><a name="l01273"></a><span class="lineno"> 1273</span>&#160;  }</div>
<div class="line"><a name="l01274"></a><span class="lineno"> 1274</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(*implicititer==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a37a2a0ddbf7a80e93124ce89084d89ca">QTYUMHDMOMONLY</a> || *implicititer==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad1dda20c101a983834446c5c93791583">QTYPMHDMOMONLY</a>){</div>
<div class="line"><a name="l01275"></a><span class="lineno"> 1275</span>&#160;    <span class="comment">//    *startjac=1; *endjac=3;</span></div>
<div class="line"><a name="l01276"></a><span class="lineno"> 1276</span>&#160;    JACTYPELOOP(type){ jacstart[type]=0; jacend[type]=2; <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) jaclist[type][jj]=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>+jj-1; }</div>
<div class="line"><a name="l01277"></a><span class="lineno"> 1277</span>&#160;  }</div>
<div class="line"><a name="l01278"></a><span class="lineno"> 1278</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(*implicititer==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ae83cfa7d219127e1aab2b1ccbe844bc6">QTYENTROPYUMHD</a> || *implicititer==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a7a5a1fd5a93591755aa3e1af2019dc57">QTYENTROPYPMHD</a>){</div>
<div class="line"><a name="l01279"></a><span class="lineno"> 1279</span>&#160;    irefU[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>]=ENTROPY;</div>
<div class="line"><a name="l01280"></a><span class="lineno"> 1280</span>&#160;  }</div>
<div class="line"><a name="l01281"></a><span class="lineno"> 1281</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(*implicititer==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a66968440681b95ca6b3d30a6d2a03c53">QTYENTROPYUMHDENERGYONLY</a>){</div>
<div class="line"><a name="l01282"></a><span class="lineno"> 1282</span>&#160;    irefU[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>]=ENTROPY;</div>
<div class="line"><a name="l01283"></a><span class="lineno"> 1283</span>&#160;    *startjac=0; *endjac=0;</div>
<div class="line"><a name="l01284"></a><span class="lineno"> 1284</span>&#160;  }</div>
<div class="line"><a name="l01285"></a><span class="lineno"> 1285</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(*implicititer==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a0ca856011b58f6beb89106ccbe6fac4e">QTYENTROPYUMHDMOMONLY</a>){</div>
<div class="line"><a name="l01286"></a><span class="lineno"> 1286</span>&#160;    irefU[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>]=ENTROPY;</div>
<div class="line"><a name="l01287"></a><span class="lineno"> 1287</span>&#160;    *startjac=1; *endjac=3;</div>
<div class="line"><a name="l01288"></a><span class="lineno"> 1288</span>&#160;  }</div>
<div class="line"><a name="l01289"></a><span class="lineno"> 1289</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(*implicititer==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad919bedc37c48678c11e7e45cd1394cf">QTYURAD</a> || *implicititer==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#add9bc1d07725fe2851182eccaa8eb385">QTYPRAD</a>){</div>
<div class="line"><a name="l01290"></a><span class="lineno"> 1290</span>&#160;    *numdims=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>;</div>
<div class="line"><a name="l01291"></a><span class="lineno"> 1291</span>&#160;    *signgd7= (+1.0); <span class="comment">// required to make URAD method work for (e.g.) RADSHADOW if using Gddt-based GS</span></div>
<div class="line"><a name="l01292"></a><span class="lineno"> 1292</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) irefU[jj]=URAD0+jj;</div>
<div class="line"><a name="l01293"></a><span class="lineno"> 1293</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) iotherU[jj]=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>+jj;</div>
<div class="line"><a name="l01294"></a><span class="lineno"> 1294</span>&#160;    *startjac=0; *endjac=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>-1;</div>
<div class="line"><a name="l01295"></a><span class="lineno"> 1295</span>&#160;  }</div>
<div class="line"><a name="l01296"></a><span class="lineno"> 1296</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(*implicititer==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a4da30ea8bf56ef0570bf4bff5d3a0690">QTYURADENERGYONLY</a> || *implicititer==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a935971192d256e2264437d7addfce8be">QTYPRADENERGYONLY</a>){</div>
<div class="line"><a name="l01297"></a><span class="lineno"> 1297</span>&#160;    *numdims=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>;</div>
<div class="line"><a name="l01298"></a><span class="lineno"> 1298</span>&#160;    *signgd7= (+1.0);</div>
<div class="line"><a name="l01299"></a><span class="lineno"> 1299</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) irefU[jj]=URAD0+jj;</div>
<div class="line"><a name="l01300"></a><span class="lineno"> 1300</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) iotherU[jj]=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>+jj;</div>
<div class="line"><a name="l01301"></a><span class="lineno"> 1301</span>&#160;    *startjac=0; *endjac=0;</div>
<div class="line"><a name="l01302"></a><span class="lineno"> 1302</span>&#160;  }</div>
<div class="line"><a name="l01303"></a><span class="lineno"> 1303</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(*implicititer==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a40391d70529dd21b8440039934ae0481">QTYURADMOMONLY</a> || *implicititer==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad3805d05cfc75b5288e7a7080cd6f42d">QTYPRADMOMONLY</a>){</div>
<div class="line"><a name="l01304"></a><span class="lineno"> 1304</span>&#160;    *numdims=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>;</div>
<div class="line"><a name="l01305"></a><span class="lineno"> 1305</span>&#160;    *signgd7= (+1.0);</div>
<div class="line"><a name="l01306"></a><span class="lineno"> 1306</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) irefU[jj]=URAD0+jj;</div>
<div class="line"><a name="l01307"></a><span class="lineno"> 1307</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) iotherU[jj]=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>+jj;</div>
<div class="line"><a name="l01308"></a><span class="lineno"> 1308</span>&#160;    *startjac=1; *endjac=3;</div>
<div class="line"><a name="l01309"></a><span class="lineno"> 1309</span>&#160;  }</div>
<div class="line"><a name="l01310"></a><span class="lineno"> 1310</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#a6fc838c14c5e9fc17d6d8bb3d868ec2f">PRODUCTION</a>==0){</div>
<div class="line"><a name="l01311"></a><span class="lineno"> 1311</span>&#160;    dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;No such implicititer=%d\n&quot;</span>,*implicititer);</div>
<div class="line"><a name="l01312"></a><span class="lineno"> 1312</span>&#160;    myexit(468346321);</div>
<div class="line"><a name="l01313"></a><span class="lineno"> 1313</span>&#160;  }</div>
<div class="line"><a name="l01314"></a><span class="lineno"> 1314</span>&#160;</div>
<div class="line"><a name="l01315"></a><span class="lineno"> 1315</span>&#160;  <span class="comment">// same list and numbers in array for both primitives and conserved</span></div>
<div class="line"><a name="l01316"></a><span class="lineno"> 1316</span>&#160;  </div>
<div class="line"><a name="l01317"></a><span class="lineno"> 1317</span>&#160;  <span class="comment">//default</span></div>
<div class="line"><a name="l01318"></a><span class="lineno"> 1318</span>&#160;  *numdims=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>;</div>
<div class="line"><a name="l01319"></a><span class="lineno"> 1319</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) erefU[jj]=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>+jj;</div>
<div class="line"><a name="l01320"></a><span class="lineno"> 1320</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) eotherU[jj]=URAD0+jj;</div>
<div class="line"><a name="l01321"></a><span class="lineno"> 1321</span>&#160;</div>
<div class="line"><a name="l01322"></a><span class="lineno"> 1322</span>&#160;  <span class="keywordflow">if</span>(*implicitferr==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aea080032b13db4a71781aee78fef9902" title="whether iterate or have as error function: MHD T^t_ or RAD R^t_, etc.">QTYUMHD</a>){</div>
<div class="line"><a name="l01323"></a><span class="lineno"> 1323</span>&#160;  }</div>
<div class="line"><a name="l01324"></a><span class="lineno"> 1324</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(*implicitferr==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a0cb9c70ab4deb85a764f6733a96e09cc">QTYUMHDENERGYONLY</a>){</div>
<div class="line"><a name="l01325"></a><span class="lineno"> 1325</span>&#160;  }</div>
<div class="line"><a name="l01326"></a><span class="lineno"> 1326</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(*implicitferr==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a37a2a0ddbf7a80e93124ce89084d89ca">QTYUMHDMOMONLY</a>){</div>
<div class="line"><a name="l01327"></a><span class="lineno"> 1327</span>&#160;  }</div>
<div class="line"><a name="l01328"></a><span class="lineno"> 1328</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(*implicitferr==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ae83cfa7d219127e1aab2b1ccbe844bc6">QTYENTROPYUMHD</a>){</div>
<div class="line"><a name="l01329"></a><span class="lineno"> 1329</span>&#160;    erefU[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>]=ENTROPY;</div>
<div class="line"><a name="l01330"></a><span class="lineno"> 1330</span>&#160;  }</div>
<div class="line"><a name="l01331"></a><span class="lineno"> 1331</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(*implicitferr==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a66968440681b95ca6b3d30a6d2a03c53">QTYENTROPYUMHDENERGYONLY</a>){</div>
<div class="line"><a name="l01332"></a><span class="lineno"> 1332</span>&#160;    erefU[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>]=ENTROPY;</div>
<div class="line"><a name="l01333"></a><span class="lineno"> 1333</span>&#160;  }</div>
<div class="line"><a name="l01334"></a><span class="lineno"> 1334</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(*implicitferr==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a0ca856011b58f6beb89106ccbe6fac4e">QTYENTROPYUMHDMOMONLY</a>){</div>
<div class="line"><a name="l01335"></a><span class="lineno"> 1335</span>&#160;    erefU[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>]=ENTROPY;</div>
<div class="line"><a name="l01336"></a><span class="lineno"> 1336</span>&#160;  }</div>
<div class="line"><a name="l01337"></a><span class="lineno"> 1337</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(*implicitferr==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad919bedc37c48678c11e7e45cd1394cf">QTYURAD</a>){</div>
<div class="line"><a name="l01338"></a><span class="lineno"> 1338</span>&#160;    *numdims=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>;</div>
<div class="line"><a name="l01339"></a><span class="lineno"> 1339</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) erefU[jj]=URAD0+jj;</div>
<div class="line"><a name="l01340"></a><span class="lineno"> 1340</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) eotherU[jj]=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>+jj;</div>
<div class="line"><a name="l01341"></a><span class="lineno"> 1341</span>&#160;  }</div>
<div class="line"><a name="l01342"></a><span class="lineno"> 1342</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(*implicitferr==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a4da30ea8bf56ef0570bf4bff5d3a0690">QTYURADENERGYONLY</a>){</div>
<div class="line"><a name="l01343"></a><span class="lineno"> 1343</span>&#160;    *numdims=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>;</div>
<div class="line"><a name="l01344"></a><span class="lineno"> 1344</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) erefU[jj]=URAD0+jj;</div>
<div class="line"><a name="l01345"></a><span class="lineno"> 1345</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) eotherU[jj]=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>+jj;</div>
<div class="line"><a name="l01346"></a><span class="lineno"> 1346</span>&#160;  }</div>
<div class="line"><a name="l01347"></a><span class="lineno"> 1347</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(*implicitferr==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a40391d70529dd21b8440039934ae0481">QTYURADMOMONLY</a>){</div>
<div class="line"><a name="l01348"></a><span class="lineno"> 1348</span>&#160;    *numdims=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>;</div>
<div class="line"><a name="l01349"></a><span class="lineno"> 1349</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) erefU[jj]=URAD0+jj;</div>
<div class="line"><a name="l01350"></a><span class="lineno"> 1350</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) eotherU[jj]=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>+jj;</div>
<div class="line"><a name="l01351"></a><span class="lineno"> 1351</span>&#160;  }</div>
<div class="line"><a name="l01352"></a><span class="lineno"> 1352</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#a6fc838c14c5e9fc17d6d8bb3d868ec2f">PRODUCTION</a>==0){</div>
<div class="line"><a name="l01353"></a><span class="lineno"> 1353</span>&#160;    dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;No such implicitferr=%d\n&quot;</span>,*implicitferr);</div>
<div class="line"><a name="l01354"></a><span class="lineno"> 1354</span>&#160;    myexit(468346322);</div>
<div class="line"><a name="l01355"></a><span class="lineno"> 1355</span>&#160;  }</div>
<div class="line"><a name="l01356"></a><span class="lineno"> 1356</span>&#160;</div>
<div class="line"><a name="l01357"></a><span class="lineno"> 1357</span>&#160;  <span class="comment">// sign that goes into implicit differencer that&#39;s consistent with sign for *signgd of -1 when using the radiative uu to measure f.</span></div>
<div class="line"><a name="l01358"></a><span class="lineno"> 1358</span>&#160;  *signgd2=(+1.0);</div>
<div class="line"><a name="l01359"></a><span class="lineno"> 1359</span>&#160;  *signgd4=(+1.0); <span class="comment">// for entropy alone for Gdpl in error function // Appears for QTYUMHD,QTYENTROPYUMHD this sign is the right one.  But both cases have lots of cold MHD inversions.</span></div>
<div class="line"><a name="l01360"></a><span class="lineno"> 1360</span>&#160;  *signgd6=(-1.0); <span class="comment">// for entropy as goes into GS from dUrad or dUmhd  //  // KORALTODO SUPERGODMARK:  -- unsure about sign!</span></div>
<div class="line"><a name="l01361"></a><span class="lineno"> 1361</span>&#160;</div>
<div class="line"><a name="l01362"></a><span class="lineno"> 1362</span>&#160;</div>
<div class="line"><a name="l01364"></a><span class="lineno"> 1364</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01365"></a><span class="lineno"> 1365</span>&#160;  <span class="comment">// Fix jacobian lists for including NRAD, which must always be included when doing full steps.</span></div>
<div class="line"><a name="l01366"></a><span class="lineno"> 1366</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01368"></a><span class="lineno"> 1368</span>&#160;<span class="comment"></span>  <span class="keywordflow">if</span>(NRAD&gt;=0){</div>
<div class="line"><a name="l01369"></a><span class="lineno"> 1369</span>&#160;    JACTYPELOOP(type){</div>
<div class="line"><a name="l01370"></a><span class="lineno"> 1370</span>&#160;      jacend[type]++;</div>
<div class="line"><a name="l01371"></a><span class="lineno"> 1371</span>&#160;      jaclist[type][jacend[type]-1]=NRAD;</div>
<div class="line"><a name="l01372"></a><span class="lineno"> 1372</span>&#160;    }</div>
<div class="line"><a name="l01373"></a><span class="lineno"> 1373</span>&#160;  }</div>
<div class="line"><a name="l01374"></a><span class="lineno"> 1374</span>&#160;</div>
<div class="line"><a name="l01375"></a><span class="lineno"> 1375</span>&#160;</div>
<div class="line"><a name="l01376"></a><span class="lineno"> 1376</span>&#160;}</div>
<div class="line"><a name="l01377"></a><span class="lineno"> 1377</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01378"></a><span class="lineno"> 1378</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01379"></a><span class="lineno"> 1379</span>&#160;</div>
<div class="line"><a name="l01380"></a><span class="lineno"> 1380</span>&#160;</div>
<div class="line"><a name="l01381"></a><span class="lineno"> 1381</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> get_refUs(<span class="keyword">struct</span> <a class="code" href="../../d6/dbe/structof__method.html">of_method</a> *mtd, <span class="keyword">struct</span> <a class="code" href="../../d2/d46/structof__ref_u.html">of_refU</a> *ru)</div>
<div class="line"><a name="l01382"></a><span class="lineno"> 1382</span>&#160;{</div>
<div class="line"><a name="l01383"></a><span class="lineno"> 1383</span>&#160;  <span class="keywordtype">int</span> jj;</div>
<div class="line"><a name="l01384"></a><span class="lineno"> 1384</span>&#160;</div>
<div class="line"><a name="l01385"></a><span class="lineno"> 1385</span>&#160;  <span class="comment">// default</span></div>
<div class="line"><a name="l01386"></a><span class="lineno"> 1386</span>&#160;  ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#a375d87568d49a0e8f43a7b2a756dcb8b">numdims</a>=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>;</div>
<div class="line"><a name="l01387"></a><span class="lineno"> 1387</span>&#160;  ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#ac1d5c40ee4d532cac343c1792e17c076">signgd7</a>= (+1.0); <span class="comment">// not used for PMHD</span></div>
<div class="line"><a name="l01388"></a><span class="lineno"> 1388</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) ru-&gt;irefU[jj]=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>+jj;</div>
<div class="line"><a name="l01389"></a><span class="lineno"> 1389</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) ru-&gt;iotherU[jj]=URAD0+jj;</div>
<div class="line"><a name="l01390"></a><span class="lineno"> 1390</span>&#160;  ru-&gt;startjac=0; ru-&gt;endjac=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>-1;</div>
<div class="line"><a name="l01391"></a><span class="lineno"> 1391</span>&#160;</div>
<div class="line"><a name="l01392"></a><span class="lineno"> 1392</span>&#160;  <span class="comment">// same list and numbers in array for both primitives and conserved</span></div>
<div class="line"><a name="l01393"></a><span class="lineno"> 1393</span>&#160;  if(mtd-&gt;implicititer==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aea080032b13db4a71781aee78fef9902" title="whether iterate or have as error function: MHD T^t_ or RAD R^t_, etc.">QTYUMHD</a> || mtd-&gt;implicititer==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9cf5ca7f5e5aa1e0bdef53abe3f27c1c">QTYPMHD</a>){</div>
<div class="line"><a name="l01394"></a><span class="lineno"> 1394</span>&#160;  }</div>
<div class="line"><a name="l01395"></a><span class="lineno"> 1395</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a0cb9c70ab4deb85a764f6733a96e09cc">QTYUMHDENERGYONLY</a> || mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8b10ec187cbee196f071e162563cd945">QTYPMHDENERGYONLY</a>){</div>
<div class="line"><a name="l01396"></a><span class="lineno"> 1396</span>&#160;    ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#a9f3d856dcdd8fa240dfbdcedfad888ef">startjac</a>=0; ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#af67164c1a42e2aefe0603597dd2ea25e">endjac</a>=0;</div>
<div class="line"><a name="l01397"></a><span class="lineno"> 1397</span>&#160;  }</div>
<div class="line"><a name="l01398"></a><span class="lineno"> 1398</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a37a2a0ddbf7a80e93124ce89084d89ca">QTYUMHDMOMONLY</a> || mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad1dda20c101a983834446c5c93791583">QTYPMHDMOMONLY</a>){</div>
<div class="line"><a name="l01399"></a><span class="lineno"> 1399</span>&#160;    ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#a9f3d856dcdd8fa240dfbdcedfad888ef">startjac</a>=1; ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#af67164c1a42e2aefe0603597dd2ea25e">endjac</a>=3;</div>
<div class="line"><a name="l01400"></a><span class="lineno"> 1400</span>&#160;  }</div>
<div class="line"><a name="l01401"></a><span class="lineno"> 1401</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ae83cfa7d219127e1aab2b1ccbe844bc6">QTYENTROPYUMHD</a> || mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a7a5a1fd5a93591755aa3e1af2019dc57">QTYENTROPYPMHD</a>){</div>
<div class="line"><a name="l01402"></a><span class="lineno"> 1402</span>&#160;    ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>]=ENTROPY;</div>
<div class="line"><a name="l01403"></a><span class="lineno"> 1403</span>&#160;  }</div>
<div class="line"><a name="l01404"></a><span class="lineno"> 1404</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a66968440681b95ca6b3d30a6d2a03c53">QTYENTROPYUMHDENERGYONLY</a>){</div>
<div class="line"><a name="l01405"></a><span class="lineno"> 1405</span>&#160;    ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>]=ENTROPY;</div>
<div class="line"><a name="l01406"></a><span class="lineno"> 1406</span>&#160;    ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#a9f3d856dcdd8fa240dfbdcedfad888ef">startjac</a>=0; ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#af67164c1a42e2aefe0603597dd2ea25e">endjac</a>=0;</div>
<div class="line"><a name="l01407"></a><span class="lineno"> 1407</span>&#160;  }</div>
<div class="line"><a name="l01408"></a><span class="lineno"> 1408</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a0ca856011b58f6beb89106ccbe6fac4e">QTYENTROPYUMHDMOMONLY</a>){</div>
<div class="line"><a name="l01409"></a><span class="lineno"> 1409</span>&#160;    ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>]=ENTROPY;</div>
<div class="line"><a name="l01410"></a><span class="lineno"> 1410</span>&#160;    ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#a9f3d856dcdd8fa240dfbdcedfad888ef">startjac</a>=1; ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#af67164c1a42e2aefe0603597dd2ea25e">endjac</a>=3;</div>
<div class="line"><a name="l01411"></a><span class="lineno"> 1411</span>&#160;  }</div>
<div class="line"><a name="l01412"></a><span class="lineno"> 1412</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad919bedc37c48678c11e7e45cd1394cf">QTYURAD</a> || mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#add9bc1d07725fe2851182eccaa8eb385">QTYPRAD</a>){</div>
<div class="line"><a name="l01413"></a><span class="lineno"> 1413</span>&#160;    ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#a375d87568d49a0e8f43a7b2a756dcb8b">numdims</a>=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>;</div>
<div class="line"><a name="l01414"></a><span class="lineno"> 1414</span>&#160;    ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#ac1d5c40ee4d532cac343c1792e17c076">signgd7</a>= (+1.0); <span class="comment">// required to make URAD method work for (e.g.) RADSHADOW if using Gddt-based GS</span></div>
<div class="line"><a name="l01415"></a><span class="lineno"> 1415</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) ru-&gt;irefU[jj]=URAD0+jj;</div>
<div class="line"><a name="l01416"></a><span class="lineno"> 1416</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) ru-&gt;iotherU[jj]=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>+jj;</div>
<div class="line"><a name="l01417"></a><span class="lineno"> 1417</span>&#160;    ru-&gt;startjac=0; ru-&gt;endjac=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>-1;</div>
<div class="line"><a name="l01418"></a><span class="lineno"> 1418</span>&#160;  }</div>
<div class="line"><a name="l01419"></a><span class="lineno"> 1419</span>&#160;  else if(mtd-&gt;implicititer==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a4da30ea8bf56ef0570bf4bff5d3a0690">QTYURADENERGYONLY</a> || mtd-&gt;implicititer==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a935971192d256e2264437d7addfce8be">QTYPRADENERGYONLY</a>){</div>
<div class="line"><a name="l01420"></a><span class="lineno"> 1420</span>&#160;    ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#a375d87568d49a0e8f43a7b2a756dcb8b">numdims</a>=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>;</div>
<div class="line"><a name="l01421"></a><span class="lineno"> 1421</span>&#160;    ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#ac1d5c40ee4d532cac343c1792e17c076">signgd7</a>= (+1.0);</div>
<div class="line"><a name="l01422"></a><span class="lineno"> 1422</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) ru-&gt;irefU[jj]=URAD0+jj;</div>
<div class="line"><a name="l01423"></a><span class="lineno"> 1423</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) ru-&gt;iotherU[jj]=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>+jj;</div>
<div class="line"><a name="l01424"></a><span class="lineno"> 1424</span>&#160;    ru-&gt;startjac=0; ru-&gt;endjac=0;</div>
<div class="line"><a name="l01425"></a><span class="lineno"> 1425</span>&#160;  }</div>
<div class="line"><a name="l01426"></a><span class="lineno"> 1426</span>&#160;  else if(mtd-&gt;implicititer==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a40391d70529dd21b8440039934ae0481">QTYURADMOMONLY</a> || mtd-&gt;implicititer==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad3805d05cfc75b5288e7a7080cd6f42d">QTYPRADMOMONLY</a>){</div>
<div class="line"><a name="l01427"></a><span class="lineno"> 1427</span>&#160;    ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#a375d87568d49a0e8f43a7b2a756dcb8b">numdims</a>=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>;</div>
<div class="line"><a name="l01428"></a><span class="lineno"> 1428</span>&#160;    ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#ac1d5c40ee4d532cac343c1792e17c076">signgd7</a>= (+1.0);</div>
<div class="line"><a name="l01429"></a><span class="lineno"> 1429</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) ru-&gt;irefU[jj]=URAD0+jj;</div>
<div class="line"><a name="l01430"></a><span class="lineno"> 1430</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) ru-&gt;iotherU[jj]=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>+jj;</div>
<div class="line"><a name="l01431"></a><span class="lineno"> 1431</span>&#160;    ru-&gt;startjac=1; ru-&gt;endjac=3;</div>
<div class="line"><a name="l01432"></a><span class="lineno"> 1432</span>&#160;  }</div>
<div class="line"><a name="l01433"></a><span class="lineno"> 1433</span>&#160;  else{</div>
<div class="line"><a name="l01434"></a><span class="lineno"> 1434</span>&#160;<span class="preprocessor">#if(PRODUCTION==0)</span></div>
<div class="line"><a name="l01435"></a><span class="lineno"> 1435</span>&#160;<span class="preprocessor"></span>    dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;No such implicititer=%d\n&quot;</span>,mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>);</div>
<div class="line"><a name="l01436"></a><span class="lineno"> 1436</span>&#160;    myexit(468346321);</div>
<div class="line"><a name="l01437"></a><span class="lineno"> 1437</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01438"></a><span class="lineno"> 1438</span>&#160;<span class="preprocessor"></span>  }</div>
<div class="line"><a name="l01439"></a><span class="lineno"> 1439</span>&#160;</div>
<div class="line"><a name="l01440"></a><span class="lineno"> 1440</span>&#160;  <span class="comment">// same list and numbers in array for both primitives and conserved</span></div>
<div class="line"><a name="l01441"></a><span class="lineno"> 1441</span>&#160;  </div>
<div class="line"><a name="l01442"></a><span class="lineno"> 1442</span>&#160;  <span class="comment">//default</span></div>
<div class="line"><a name="l01443"></a><span class="lineno"> 1443</span>&#160;  ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#a375d87568d49a0e8f43a7b2a756dcb8b">numdims</a>=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>;</div>
<div class="line"><a name="l01444"></a><span class="lineno"> 1444</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) ru-&gt;erefU[jj]=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>+jj;</div>
<div class="line"><a name="l01445"></a><span class="lineno"> 1445</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) ru-&gt;eotherU[jj]=URAD0+jj;</div>
<div class="line"><a name="l01446"></a><span class="lineno"> 1446</span>&#160;</div>
<div class="line"><a name="l01447"></a><span class="lineno"> 1447</span>&#160;  if(mtd-&gt;implicitferr==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aea080032b13db4a71781aee78fef9902" title="whether iterate or have as error function: MHD T^t_ or RAD R^t_, etc.">QTYUMHD</a>){</div>
<div class="line"><a name="l01448"></a><span class="lineno"> 1448</span>&#160;  }</div>
<div class="line"><a name="l01449"></a><span class="lineno"> 1449</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a2c5c387f7161b69aad77ee5a13d30c68">implicitferr</a>==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a0cb9c70ab4deb85a764f6733a96e09cc">QTYUMHDENERGYONLY</a>){</div>
<div class="line"><a name="l01450"></a><span class="lineno"> 1450</span>&#160;  }</div>
<div class="line"><a name="l01451"></a><span class="lineno"> 1451</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a2c5c387f7161b69aad77ee5a13d30c68">implicitferr</a>==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a37a2a0ddbf7a80e93124ce89084d89ca">QTYUMHDMOMONLY</a>){</div>
<div class="line"><a name="l01452"></a><span class="lineno"> 1452</span>&#160;  }</div>
<div class="line"><a name="l01453"></a><span class="lineno"> 1453</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a2c5c387f7161b69aad77ee5a13d30c68">implicitferr</a>==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ae83cfa7d219127e1aab2b1ccbe844bc6">QTYENTROPYUMHD</a>){</div>
<div class="line"><a name="l01454"></a><span class="lineno"> 1454</span>&#160;    ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>]=ENTROPY;</div>
<div class="line"><a name="l01455"></a><span class="lineno"> 1455</span>&#160;  }</div>
<div class="line"><a name="l01456"></a><span class="lineno"> 1456</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a2c5c387f7161b69aad77ee5a13d30c68">implicitferr</a>==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a66968440681b95ca6b3d30a6d2a03c53">QTYENTROPYUMHDENERGYONLY</a>){</div>
<div class="line"><a name="l01457"></a><span class="lineno"> 1457</span>&#160;    ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>]=ENTROPY;</div>
<div class="line"><a name="l01458"></a><span class="lineno"> 1458</span>&#160;  }</div>
<div class="line"><a name="l01459"></a><span class="lineno"> 1459</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a2c5c387f7161b69aad77ee5a13d30c68">implicitferr</a>==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a0ca856011b58f6beb89106ccbe6fac4e">QTYENTROPYUMHDMOMONLY</a>){</div>
<div class="line"><a name="l01460"></a><span class="lineno"> 1460</span>&#160;    ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>]=ENTROPY;</div>
<div class="line"><a name="l01461"></a><span class="lineno"> 1461</span>&#160;  }</div>
<div class="line"><a name="l01462"></a><span class="lineno"> 1462</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a2c5c387f7161b69aad77ee5a13d30c68">implicitferr</a>==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad919bedc37c48678c11e7e45cd1394cf">QTYURAD</a>){</div>
<div class="line"><a name="l01463"></a><span class="lineno"> 1463</span>&#160;    ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#a375d87568d49a0e8f43a7b2a756dcb8b">numdims</a>=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>;</div>
<div class="line"><a name="l01464"></a><span class="lineno"> 1464</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) ru-&gt;erefU[jj]=URAD0+jj;</div>
<div class="line"><a name="l01465"></a><span class="lineno"> 1465</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) ru-&gt;eotherU[jj]=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>+jj;</div>
<div class="line"><a name="l01466"></a><span class="lineno"> 1466</span>&#160;  }</div>
<div class="line"><a name="l01467"></a><span class="lineno"> 1467</span>&#160;  else if(mtd-&gt;implicitferr==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a4da30ea8bf56ef0570bf4bff5d3a0690">QTYURADENERGYONLY</a>){</div>
<div class="line"><a name="l01468"></a><span class="lineno"> 1468</span>&#160;    ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#a375d87568d49a0e8f43a7b2a756dcb8b">numdims</a>=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>;</div>
<div class="line"><a name="l01469"></a><span class="lineno"> 1469</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) ru-&gt;erefU[jj]=URAD0+jj;</div>
<div class="line"><a name="l01470"></a><span class="lineno"> 1470</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) ru-&gt;eotherU[jj]=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>+jj;</div>
<div class="line"><a name="l01471"></a><span class="lineno"> 1471</span>&#160;  }</div>
<div class="line"><a name="l01472"></a><span class="lineno"> 1472</span>&#160;  else if(mtd-&gt;implicitferr==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a40391d70529dd21b8440039934ae0481">QTYURADMOMONLY</a>){</div>
<div class="line"><a name="l01473"></a><span class="lineno"> 1473</span>&#160;    ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#a375d87568d49a0e8f43a7b2a756dcb8b">numdims</a>=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>;</div>
<div class="line"><a name="l01474"></a><span class="lineno"> 1474</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) ru-&gt;erefU[jj]=URAD0+jj;</div>
<div class="line"><a name="l01475"></a><span class="lineno"> 1475</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) ru-&gt;eotherU[jj]=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>+jj;</div>
<div class="line"><a name="l01476"></a><span class="lineno"> 1476</span>&#160;  }</div>
<div class="line"><a name="l01477"></a><span class="lineno"> 1477</span>&#160;  else{</div>
<div class="line"><a name="l01478"></a><span class="lineno"> 1478</span>&#160;<span class="preprocessor">#if(PRODUCTION==0)</span></div>
<div class="line"><a name="l01479"></a><span class="lineno"> 1479</span>&#160;<span class="preprocessor"></span>    dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;No such implicitferr=%d\n&quot;</span>,mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a2c5c387f7161b69aad77ee5a13d30c68">implicitferr</a>);</div>
<div class="line"><a name="l01480"></a><span class="lineno"> 1480</span>&#160;    myexit(468346322);</div>
<div class="line"><a name="l01481"></a><span class="lineno"> 1481</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01482"></a><span class="lineno"> 1482</span>&#160;<span class="preprocessor"></span>  }</div>
<div class="line"><a name="l01483"></a><span class="lineno"> 1483</span>&#160;</div>
<div class="line"><a name="l01484"></a><span class="lineno"> 1484</span>&#160;  <span class="comment">// sign that goes into implicit differencer that&#39;s consistent with sign for signgd of -1 when using the radiative uu to measure f.</span></div>
<div class="line"><a name="l01485"></a><span class="lineno"> 1485</span>&#160;  ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aced783637d9ae9182ae10b44fcbac284">signgd2</a>=(+1.0);</div>
<div class="line"><a name="l01486"></a><span class="lineno"> 1486</span>&#160;  ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#a987d9cab27e21984bd25b825e523058e">signgd4</a>=(+1.0); <span class="comment">// for entropy alone for Gdpl in error function // Appears for QTYUMHD,QTYENTROPYUMHD this sign is the right one.  But both cases have lots of cold MHD inversions.</span></div>
<div class="line"><a name="l01487"></a><span class="lineno"> 1487</span>&#160;  ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#a156b044c75cffc015e7228257f9924b5">signgd6</a>=(-1.0); <span class="comment">// for entropy as goes into GS from dUrad or dUmhd  //  // KORALTODO SUPERGODMARK:  -- unsure about sign!</span></div>
<div class="line"><a name="l01488"></a><span class="lineno"> 1488</span>&#160;</div>
<div class="line"><a name="l01489"></a><span class="lineno"> 1489</span>&#160;}</div>
<div class="line"><a name="l01490"></a><span class="lineno"> 1490</span>&#160;</div>
<div class="line"><a name="l01491"></a><span class="lineno"> 1491</span>&#160;</div>
<div class="line"><a name="l01492"></a><span class="lineno"> 1492</span>&#160;</div>
<div class="line"><a name="l01493"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a0a4c88ebd712c11eee70dda4d75288cf"> 1493</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a0a4c88ebd712c11eee70dda4d75288cf">setgasinversionstuff</a>(<span class="keywordtype">int</span> iter, <span class="keywordtype">int</span> whichcall, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> impeps, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> errorabs, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> convabs, <span class="keywordtype">int</span> maxiter, <span class="keyword">struct</span> <a class="code" href="../../db/d3a/structof__newtonstats.html">of_newtonstats</a> *newtonstats, <span class="keywordtype">int</span> *checkoninversiongas, <span class="keywordtype">int</span> *checkoninversionrad)</div>
<div class="line"><a name="l01494"></a><span class="lineno"> 1494</span>&#160;{</div>
<div class="line"><a name="l01495"></a><span class="lineno"> 1495</span>&#160; setnewtonstatsdefault(newtonstats);</div>
<div class="line"><a name="l01496"></a><span class="lineno"> 1496</span>&#160;  <span class="comment">// initialize counters</span></div>
<div class="line"><a name="l01497"></a><span class="lineno"> 1497</span>&#160;  newtonstats-&gt;<a class="code" href="../../db/d3a/structof__newtonstats.html#a073783ba864c07681c8999a67162202b">nstroke</a>=newtonstats-&gt;<a class="code" href="../../db/d3a/structof__newtonstats.html#a83280998e47831044a7e35299495a9bb">lntries</a>=0;</div>
<div class="line"><a name="l01498"></a><span class="lineno"> 1498</span>&#160;  <span class="comment">// set inputs for errors, maxiters, etc.</span></div>
<div class="line"><a name="l01499"></a><span class="lineno"> 1499</span>&#160;  <span class="keywordflow">if</span>(iter&gt;=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a27e05682d00f225ce495d59dc3e140ca" title="how many iterations before we try harder to get better 1D MHD inversion solution">ITERMHDINVTRYHARDER</a> || whichcall==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aed44d99ba064f5db1486676c305f80e2">FIMPLICITCALLTYPEFINALCHECK</a> || whichcall==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a137120b9d350a5e9706de4a7a9dde9fb">FIMPLICITCALLTYPEFINALCHECK2</a>){</div>
<div class="line"><a name="l01500"></a><span class="lineno"> 1500</span>&#160;    <span class="comment">// try lowest error allowed, may be raised a bit in MHD inversion code.</span></div>
<div class="line"><a name="l01501"></a><span class="lineno"> 1501</span>&#160;    <span class="comment">// min between normal desired error and iterated-quantity error.  This seeks low error if iterated got low error, while avoids excessive attempt if not.</span></div>
<div class="line"><a name="l01502"></a><span class="lineno"> 1502</span>&#160;    newtonstats-&gt;<a class="code" href="../../db/d3a/structof__newtonstats.html#abaf99ec9e8c395755285cd9a44858314">tryconv</a>=1<a class="code" href="../../d8/d60/init_8c.html#a07484107e6d9fdf38b53edf631d6511d">E</a>-2*<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(convabs,errorabs); <span class="comment">// NUMEPSILON</span></div>
<div class="line"><a name="l01503"></a><span class="lineno"> 1503</span>&#160;    newtonstats-&gt;<a class="code" href="../../db/d3a/structof__newtonstats.html#a00940ef45bf3eb6e72c49ea66dd7c8b2">tryconvultrarel</a>=1<a class="code" href="../../d8/d60/init_8c.html#a07484107e6d9fdf38b53edf631d6511d">E</a>-2*<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(convabs,errorabs); <span class="comment">// NUMEPSILON</span></div>
<div class="line"><a name="l01504"></a><span class="lineno"> 1504</span>&#160;    newtonstats-&gt;<a class="code" href="../../db/d3a/structof__newtonstats.html#a28c2335afb8757d40128392034402c17">extra_newt_iter</a>=1; <span class="comment">// KORALNOTE: apparently should keep this as &gt;=1 to ensure error really drops</span></div>
<div class="line"><a name="l01505"></a><span class="lineno"> 1505</span>&#160;    newtonstats-&gt;<a class="code" href="../../db/d3a/structof__newtonstats.html#a08186e529162af19adc29e62eaaf31d9">extra_newt_iter_ultrarel</a>=2; <span class="comment">// KORALNOTE: apparently should keep this as &gt;=1 to ensure error really drops</span></div>
<div class="line"><a name="l01506"></a><span class="lineno"> 1506</span>&#160;  }</div>
<div class="line"><a name="l01507"></a><span class="lineno"> 1507</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l01508"></a><span class="lineno"> 1508</span>&#160;    <span class="comment">// KORALNOTE: If make newtonstats-&gt;tryconv~convabs, then if convabs~1E-12, then MHD inversion may return error~1E-10 in terms of how measured with f_error_check(), so must try harder than expected.</span></div>
<div class="line"><a name="l01509"></a><span class="lineno"> 1509</span>&#160;    newtonstats-&gt;<a class="code" href="../../db/d3a/structof__newtonstats.html#abaf99ec9e8c395755285cd9a44858314">tryconv</a>=convabs*1<a class="code" href="../../d8/d60/init_8c.html#a07484107e6d9fdf38b53edf631d6511d">E</a>-2;</div>
<div class="line"><a name="l01510"></a><span class="lineno"> 1510</span>&#160;    newtonstats-&gt;<a class="code" href="../../db/d3a/structof__newtonstats.html#a00940ef45bf3eb6e72c49ea66dd7c8b2">tryconvultrarel</a>=convabs*1E-2; <span class="comment">// just bit smaller, not as extreme as default</span></div>
<div class="line"><a name="l01511"></a><span class="lineno"> 1511</span>&#160;    newtonstats-&gt;<a class="code" href="../../db/d3a/structof__newtonstats.html#a28c2335afb8757d40128392034402c17">extra_newt_iter</a>=1; <span class="comment">// KORALNOTE: apparently should keep this as &gt;=1 to ensure error really drops</span></div>
<div class="line"><a name="l01512"></a><span class="lineno"> 1512</span>&#160;    newtonstats-&gt;<a class="code" href="../../db/d3a/structof__newtonstats.html#a08186e529162af19adc29e62eaaf31d9">extra_newt_iter_ultrarel</a>=1; <span class="comment">// KORALNOTE: apparently should keep this as &gt;=1 to ensure error really drops</span></div>
<div class="line"><a name="l01513"></a><span class="lineno"> 1513</span>&#160;  }</div>
<div class="line"><a name="l01514"></a><span class="lineno"> 1514</span>&#160;  <span class="comment">//  newtonstats-&gt;mintryconv=allowconvabs;</span></div>
<div class="line"><a name="l01515"></a><span class="lineno"> 1515</span>&#160;  newtonstats-&gt;<a class="code" href="../../db/d3a/structof__newtonstats.html#a98ac5de850a4bd5b495a8c9e1975499b">mintryconv</a>=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9246a73614335644963eb4e47ec0de8c">MINTRYCONVFORMHDINVERSION</a>;</div>
<div class="line"><a name="l01516"></a><span class="lineno"> 1516</span>&#160;  newtonstats-&gt;<a class="code" href="../../db/d3a/structof__newtonstats.html#a767c6b7671c51ec6db1a3d7199775588">maxiter</a>=maxiter;</div>
<div class="line"><a name="l01517"></a><span class="lineno"> 1517</span>&#160;  <span class="comment">// override with less strict error for Jacobian calculation</span></div>
<div class="line"><a name="l01518"></a><span class="lineno"> 1518</span>&#160;  <span class="keywordflow">if</span>(whichcall==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a195d482ffa46307e2e7ed74f457d5300">FIMPLICITCALLTYPEJAC</a>){</div>
<div class="line"><a name="l01519"></a><span class="lineno"> 1519</span>&#160;    newtonstats-&gt;<a class="code" href="../../db/d3a/structof__newtonstats.html#abaf99ec9e8c395755285cd9a44858314">tryconv</a>=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(impeps*1<a class="code" href="../../d8/d60/init_8c.html#a07484107e6d9fdf38b53edf631d6511d">E</a>-2,newtonstats-&gt;<a class="code" href="../../db/d3a/structof__newtonstats.html#abaf99ec9e8c395755285cd9a44858314">tryconv</a>);</div>
<div class="line"><a name="l01520"></a><span class="lineno"> 1520</span>&#160;    newtonstats-&gt;<a class="code" href="../../db/d3a/structof__newtonstats.html#a00940ef45bf3eb6e72c49ea66dd7c8b2">tryconvultrarel</a>=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(impeps*1<a class="code" href="../../d8/d60/init_8c.html#a07484107e6d9fdf38b53edf631d6511d">E</a>-3,newtonstats-&gt;<a class="code" href="../../db/d3a/structof__newtonstats.html#a00940ef45bf3eb6e72c49ea66dd7c8b2">tryconvultrarel</a>);</div>
<div class="line"><a name="l01521"></a><span class="lineno"> 1521</span>&#160;  }</div>
<div class="line"><a name="l01522"></a><span class="lineno"> 1522</span>&#160;</div>
<div class="line"><a name="l01523"></a><span class="lineno"> 1523</span>&#160;</div>
<div class="line"><a name="l01524"></a><span class="lineno"> 1524</span>&#160;  <span class="comment">// set whether should check inversion result inside Utoprimgen()</span></div>
<div class="line"><a name="l01525"></a><span class="lineno"> 1525</span>&#160;  <span class="keywordflow">if</span>(whichcall==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aed44d99ba064f5db1486676c305f80e2">FIMPLICITCALLTYPEFINALCHECK</a> || whichcall==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a137120b9d350a5e9706de4a7a9dde9fb">FIMPLICITCALLTYPEFINALCHECK2</a>){</div>
<div class="line"><a name="l01526"></a><span class="lineno"> 1526</span>&#160;    *checkoninversiongas=*checkoninversionrad=1;</div>
<div class="line"><a name="l01527"></a><span class="lineno"> 1527</span>&#160;  }</div>
<div class="line"><a name="l01528"></a><span class="lineno"> 1528</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l01529"></a><span class="lineno"> 1529</span>&#160;    <span class="comment">// don&#39;t check since slows down code and could be good enough solution if original error says ok.</span></div>
<div class="line"><a name="l01530"></a><span class="lineno"> 1530</span>&#160;    *checkoninversiongas=*checkoninversionrad=0;</div>
<div class="line"><a name="l01531"></a><span class="lineno"> 1531</span>&#160;  }</div>
<div class="line"><a name="l01532"></a><span class="lineno"> 1532</span>&#160;</div>
<div class="line"><a name="l01533"></a><span class="lineno"> 1533</span>&#160;}</div>
<div class="line"><a name="l01534"></a><span class="lineno"> 1534</span>&#160;</div>
<div class="line"><a name="l01535"></a><span class="lineno"> 1535</span>&#160;</div>
<div class="line"><a name="l01536"></a><span class="lineno"> 1536</span>&#160;</div>
<div class="line"><a name="l01554"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#af46d2b1cf89a70a7e2ef503146c649a9"> 1554</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#af46d2b1cf89a70a7e2ef503146c649a9" title="uu0 - original cons.">f_implicit</a>(<span class="keywordtype">int</span> allowbaseitermethodswitch, <span class="keywordtype">int</span> iter, <span class="keywordtype">int</span> f1iter, <span class="keywordtype">int</span> failreturnallowable, <span class="keywordtype">int</span> whichcall, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> impeps, <span class="keywordtype">int</span> showmessages, <span class="keywordtype">int</span> showmessagesheavy, <span class="keywordtype">int</span> allowlocalfailurefixandnoreport, <span class="keywordtype">int</span> *eomtype, <span class="keywordtype">int</span> whichcap, <span class="keywordtype">int</span> itermode, <span class="keywordtype">int</span> *baseitermethod, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fracenergy, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dissmeasure, <span class="keywordtype">int</span> *radinvmod, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> conv, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> convabs, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> allowconvabs, <span class="keywordtype">int</span> maxiter, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> realdt, <span class="keywordtype">int</span> dimtypef, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *dimfactU, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *ppprev, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pp, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *piin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *uuprev, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Uiin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *uu0,<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *uu,<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> localdt, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *q,  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *f, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *fnorm, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *freport, <span class="keywordtype">int</span> *goexplicit, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *errorabs, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *errorallabs, <span class="keywordtype">int</span> whicherror, <span class="keywordtype">int</span> *convreturn, <span class="keywordtype">int</span> *nummhdinvsreturn, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *tautotmaxreturn, <span class="keyword">struct</span> <a class="code" href="../../d6/dbe/structof__method.html">of_method</a> *mtd, <span class="keyword">struct</span> <a class="code" href="../../d2/d46/structof__ref_u.html">of_refU</a> *ru)</div>
<div class="line"><a name="l01555"></a><span class="lineno"> 1555</span>&#160;{</div>
<div class="line"><a name="l01556"></a><span class="lineno"> 1556</span>&#160;  <span class="keywordtype">int</span> pliter, pl;</div>
<div class="line"><a name="l01557"></a><span class="lineno"> 1557</span>&#160;  <span class="keywordtype">int</span> iv;</div>
<div class="line"><a name="l01558"></a><span class="lineno"> 1558</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../db/d3a/structof__newtonstats.html">of_newtonstats</a> newtonstats;</div>
<div class="line"><a name="l01559"></a><span class="lineno"> 1559</span>&#160;  <span class="keywordtype">int</span> checkoninversiongas=0;</div>
<div class="line"><a name="l01560"></a><span class="lineno"> 1560</span>&#160;  <span class="keywordtype">int</span> checkoninversionrad=0;</div>
<div class="line"><a name="l01561"></a><span class="lineno"> 1561</span>&#160;  <span class="keywordtype">int</span> finalstep = 0;  <span class="comment">//can choose either 1 or 0 depending on whether want floor-like fixups (1) or not (0).  unclear which one would work best since for Newton method to converge might want to allow negative density on the way to the correct solution, on the other hand want to prevent runaway into rho &lt; 0 region and so want floors.</span></div>
<div class="line"><a name="l01562"></a><span class="lineno"> 1562</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Gdpl[NPR]={0.0},Gdplabs[NPR]={0.0}, Tgas={0.0},Trad={0.0};</div>
<div class="line"><a name="l01563"></a><span class="lineno"> 1563</span>&#160;  <span class="keywordtype">int</span> failreturn;</div>
<div class="line"><a name="l01564"></a><span class="lineno"> 1564</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> uuabs[NPR]={0.0};</div>
<div class="line"><a name="l01565"></a><span class="lineno"> 1565</span>&#160;</div>
<div class="line"><a name="l01566"></a><span class="lineno"> 1566</span>&#160;</div>
<div class="line"><a name="l01567"></a><span class="lineno"> 1567</span>&#160;</div>
<div class="line"><a name="l01568"></a><span class="lineno"> 1568</span>&#160;</div>
<div class="line"><a name="l01569"></a><span class="lineno"> 1569</span>&#160;</div>
<div class="line"><a name="l01570"></a><span class="lineno"> 1570</span>&#160;  <span class="comment">// default is no failure</span></div>
<div class="line"><a name="l01571"></a><span class="lineno"> 1571</span>&#160;  failreturn=0;</div>
<div class="line"><a name="l01572"></a><span class="lineno"> 1572</span>&#160;</div>
<div class="line"><a name="l01573"></a><span class="lineno"> 1573</span>&#160;</div>
<div class="line"><a name="l01574"></a><span class="lineno"> 1574</span>&#160;</div>
<div class="line"><a name="l01576"></a><span class="lineno"> 1576</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01577"></a><span class="lineno"> 1577</span>&#160;  <span class="comment">// 0) backup pp and uu and prepare alternative versions</span></div>
<div class="line"><a name="l01578"></a><span class="lineno"> 1578</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01580"></a><span class="lineno"> 1580</span>&#160;<span class="comment"></span>  <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> qbackup;</div>
<div class="line"><a name="l01581"></a><span class="lineno"> 1581</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ppbackup[NPR],uubackup[NPR]={0.0};</div>
<div class="line"><a name="l01582"></a><span class="lineno"> 1582</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ppalt[NPR]={0.0},uualt[NPR]={0.0};</div>
<div class="line"><a name="l01583"></a><span class="lineno"> 1583</span>&#160;  <span class="keywordtype">int</span> radinvmodbackup,radinvmodalt,failreturnalt;</div>
<div class="line"><a name="l01584"></a><span class="lineno"> 1584</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l01585"></a><span class="lineno"> 1585</span>&#160;    ppalt[pl]=ppbackup[pl]=pp[pl];</div>
<div class="line"><a name="l01586"></a><span class="lineno"> 1586</span>&#160;    uualt[pl]=uubackup[pl]=uu[pl];</div>
<div class="line"><a name="l01587"></a><span class="lineno"> 1587</span>&#160;  }</div>
<div class="line"><a name="l01588"></a><span class="lineno"> 1588</span>&#160;  qbackup=*q;</div>
<div class="line"><a name="l01589"></a><span class="lineno"> 1589</span>&#160;  radinvmodbackup=*radinvmod;</div>
<div class="line"><a name="l01590"></a><span class="lineno"> 1590</span>&#160;</div>
<div class="line"><a name="l01591"></a><span class="lineno"> 1591</span>&#160;  </div>
<div class="line"><a name="l01592"></a><span class="lineno"> 1592</span>&#160;</div>
<div class="line"><a name="l01593"></a><span class="lineno"> 1593</span>&#160;</div>
<div class="line"><a name="l01594"></a><span class="lineno"> 1594</span>&#160;<span class="preprocessor">#if(MODEMETHOD==MODEENERGY ||MODEMETHOD==MODEENTROPY ||MODEMETHOD==MODESWITCH) // currently only ones that allow change</span></div>
<div class="line"><a name="l01595"></a><span class="lineno"> 1595</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01596"></a><span class="lineno"> 1596</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01597"></a><span class="lineno"> 1597</span>&#160;  <span class="comment">// setup method and signs (only needed per f_implicit if baseitermethod can change, because already do per iter in main implicit loop</span></div>
<div class="line"><a name="l01598"></a><span class="lineno"> 1598</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01600"></a><span class="lineno"> 1600</span>&#160;<span class="comment"></span>  define_method(iter, eomtype, itermode, *baseitermethod, fracenergy, dissmeasure, &amp;mtd);</div>
<div class="line"><a name="l01601"></a><span class="lineno"> 1601</span>&#160;  get_refUs(&amp;mtd, &amp;ru);</div>
<div class="line"><a name="l01602"></a><span class="lineno"> 1602</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01603"></a><span class="lineno"> 1603</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01604"></a><span class="lineno"> 1604</span>&#160;</div>
<div class="line"><a name="l01605"></a><span class="lineno"> 1605</span>&#160;</div>
<div class="line"><a name="l01606"></a><span class="lineno"> 1606</span>&#160;</div>
<div class="line"><a name="l01607"></a><span class="lineno"> 1607</span>&#160;</div>
<div class="line"><a name="l01608"></a><span class="lineno"> 1608</span>&#160;</div>
<div class="line"><a name="l01609"></a><span class="lineno"> 1609</span>&#160;  <span class="comment">// optimize whether need to really compute entropy with log/pow so slow</span></div>
<div class="line"><a name="l01610"></a><span class="lineno"> 1610</span>&#160;  <span class="keywordtype">int</span> needentropy=1; <span class="comment">// default get uu[entropy] and q-&gt;entropy</span></div>
<div class="line"><a name="l01611"></a><span class="lineno"> 1611</span>&#160;<span class="preprocessor">#if(ENTROPYOPT)</span></div>
<div class="line"><a name="l01612"></a><span class="lineno"> 1612</span>&#160;<span class="preprocessor"></span>  <span class="comment">// whichcall==FIMPLICITCALLTYPEFINALCHECK means final check where if wasn&#39;t computing entropy during iterations, need at end so next RK substeps have it ready</span></div>
<div class="line"><a name="l01613"></a><span class="lineno"> 1613</span>&#160;  <span class="keywordflow">if</span>(whichcall==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aed44d99ba064f5db1486676c305f80e2">FIMPLICITCALLTYPEFINALCHECK</a> || whichcall==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a137120b9d350a5e9706de4a7a9dde9fb">FIMPLICITCALLTYPEFINALCHECK2</a> || *eomtype==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a40b55e98bfcccde1a3f19d983ca7488c">EOMENTROPYGRMHD</a> || (mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a0ca856011b58f6beb89106ccbe6fac4e">QTYENTROPYUMHDMOMONLY</a>)||(mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a66968440681b95ca6b3d30a6d2a03c53">QTYENTROPYUMHDENERGYONLY</a>)||(mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ae83cfa7d219127e1aab2b1ccbe844bc6">QTYENTROPYUMHD</a> || mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a7a5a1fd5a93591755aa3e1af2019dc57">QTYENTROPYPMHD</a>) || (mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a2c5c387f7161b69aad77ee5a13d30c68">implicitferr</a>==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ae83cfa7d219127e1aab2b1ccbe844bc6">QTYENTROPYUMHD</a> || mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a2c5c387f7161b69aad77ee5a13d30c68">implicitferr</a>==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a66968440681b95ca6b3d30a6d2a03c53">QTYENTROPYUMHDENERGYONLY</a> || mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a2c5c387f7161b69aad77ee5a13d30c68">implicitferr</a>==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a0ca856011b58f6beb89106ccbe6fac4e">QTYENTROPYUMHDMOMONLY</a>) || (fracenergy&gt;0.0 &amp;&amp; fracenergy&lt;1.0)){</div>
<div class="line"><a name="l01614"></a><span class="lineno"> 1614</span>&#160;    needentropy=1;</div>
<div class="line"><a name="l01615"></a><span class="lineno"> 1615</span>&#160;  }</div>
<div class="line"><a name="l01616"></a><span class="lineno"> 1616</span>&#160;  <span class="keywordflow">else</span> needentropy=0;</div>
<div class="line"><a name="l01617"></a><span class="lineno"> 1617</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l01618"></a><span class="lineno"> 1618</span>&#160;<span class="preprocessor"></span>  <span class="comment">// then assume might need entropy generally</span></div>
<div class="line"><a name="l01619"></a><span class="lineno"> 1619</span>&#160;  needentropy=1;</div>
<div class="line"><a name="l01620"></a><span class="lineno"> 1620</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01621"></a><span class="lineno"> 1621</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01622"></a><span class="lineno"> 1622</span>&#160;</div>
<div class="line"><a name="l01623"></a><span class="lineno"> 1623</span>&#160;</div>
<div class="line"><a name="l01624"></a><span class="lineno"> 1624</span>&#160;</div>
<div class="line"><a name="l01625"></a><span class="lineno"> 1625</span>&#160;</div>
<div class="line"><a name="l01626"></a><span class="lineno"> 1626</span>&#160;  <span class="comment">//1) Reorder URAD method so:</span></div>
<div class="line"><a name="l01627"></a><span class="lineno"> 1627</span>&#160;  <span class="comment">// a) URAD</span></div>
<div class="line"><a name="l01628"></a><span class="lineno"> 1628</span>&#160;  <span class="comment">// b) URAD-&gt;PRAD</span></div>
<div class="line"><a name="l01629"></a><span class="lineno"> 1629</span>&#160;  <span class="comment">// c) Re-get URAD(PRAD) in case floors/ceilings</span></div>
<div class="line"><a name="l01630"></a><span class="lineno"> 1630</span>&#160;  <span class="comment">// d) Apply relative 4-force condition using this new URAD -&gt; UGAS</span></div>
<div class="line"><a name="l01631"></a><span class="lineno"> 1631</span>&#160;  <span class="comment">// e) UGAS-&gt;PGAS</span></div>
<div class="line"><a name="l01632"></a><span class="lineno"> 1632</span>&#160;  <span class="comment">// f) Re-get UGAS(PGAS) in case floors/celings/failures/errors/etc.</span></div>
<div class="line"><a name="l01633"></a><span class="lineno"> 1633</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01634"></a><span class="lineno"> 1634</span>&#160;  <span class="comment">// As long as MHD doesn&#39;t fail, then even if RAD hits ceilings, the solution will be in relative force balance. -- i.e. total energy-momentum conservation will hold despite change in URAD.</span></div>
<div class="line"><a name="l01635"></a><span class="lineno"> 1635</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01636"></a><span class="lineno"> 1636</span>&#160;  <span class="comment">// Right now, I use pre-corrected URAD to get dUrad -&gt; dUgas, so if rad hits ceilings while gas does not, then relative force balance is lost when could have been maintained.</span></div>
<div class="line"><a name="l01637"></a><span class="lineno"> 1637</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01638"></a><span class="lineno"> 1638</span>&#160;  <span class="comment">// Need to have Utoprimgen() call without doing radiation inversion to save time .. doradonly=-1 ?</span></div>
<div class="line"><a name="l01639"></a><span class="lineno"> 1639</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01640"></a><span class="lineno"> 1640</span>&#160;  <span class="comment">// BUT, if hit radinvmod with change in energy, then change in U would be dumped into GAS even if gas&lt;&lt;rad or tau\sim 0.</span></div>
<div class="line"><a name="l01641"></a><span class="lineno"> 1641</span>&#160;</div>
<div class="line"><a name="l01642"></a><span class="lineno"> 1642</span>&#160;</div>
<div class="line"><a name="l01643"></a><span class="lineno"> 1643</span>&#160;  <span class="comment">// f_implicit_umhdurad(iter,uu,uu0,pp,q</span></div>
<div class="line"><a name="l01644"></a><span class="lineno"> 1644</span>&#160;</div>
<div class="line"><a name="l01645"></a><span class="lineno"> 1645</span>&#160;</div>
<div class="line"><a name="l01646"></a><span class="lineno"> 1646</span>&#160;</div>
<div class="line"><a name="l01648"></a><span class="lineno"> 1648</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01649"></a><span class="lineno"> 1649</span>&#160;  <span class="comment">// UMHD and URAD</span></div>
<div class="line"><a name="l01650"></a><span class="lineno"> 1650</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01652"></a><span class="lineno"> 1652</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01653"></a><span class="lineno"> 1653</span>&#160;</div>
<div class="line"><a name="l01654"></a><span class="lineno"> 1654</span>&#160;  <span class="keywordflow">if</span>(</div>
<div class="line"><a name="l01655"></a><span class="lineno"> 1655</span>&#160;     mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aea080032b13db4a71781aee78fef9902" title="whether iterate or have as error function: MHD T^t_ or RAD R^t_, etc.">QTYUMHD</a> || mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a0cb9c70ab4deb85a764f6733a96e09cc">QTYUMHDENERGYONLY</a> || mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a37a2a0ddbf7a80e93124ce89084d89ca">QTYUMHDMOMONLY</a></div>
<div class="line"><a name="l01656"></a><span class="lineno"> 1656</span>&#160;     || mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad919bedc37c48678c11e7e45cd1394cf">QTYURAD</a> || mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>==QTYURADENERGYONLY || mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a40391d70529dd21b8440039934ae0481">QTYURADMOMONLY</a></div>
<div class="line"><a name="l01657"></a><span class="lineno"> 1657</span>&#160;     ){ <span class="comment">// then don&#39;t yet have updated primitives, so invert to get them</span></div>
<div class="line"><a name="l01658"></a><span class="lineno"> 1658</span>&#160;    <span class="comment">// 1) get change in conserved quantity between fluid and radiation (equal and opposite 4-force)</span></div>
<div class="line"><a name="l01659"></a><span class="lineno"> 1659</span>&#160;    <span class="comment">// required for inversion to get P(U) for MHD and RAD variables</span></div>
<div class="line"><a name="l01660"></a><span class="lineno"> 1660</span>&#160;    <span class="comment">// this preserves machine accurate conservation instead of applying 4-force on each fluid and radiation separately that can accumulate errors</span></div>
<div class="line"><a name="l01661"></a><span class="lineno"> 1661</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Gddt[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>]; <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(iv) Gddt[iv]=(uu[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[iv]]-uu0[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[iv]]);</div>
<div class="line"><a name="l01662"></a><span class="lineno"> 1662</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(iv) uu[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#a841d43603fddda5fbcbc03d6b2f544de">iotherU</a>[iv]] = uu0[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#a841d43603fddda5fbcbc03d6b2f544de">iotherU</a>[iv]] - Gddt[iv];</div>
<div class="line"><a name="l01663"></a><span class="lineno"> 1663</span>&#160;    <span class="comment">// reject what radiation says gas should be if forced into T^t_t&lt;0 regime.</span></div>
<div class="line"><a name="l01664"></a><span class="lineno"> 1664</span>&#160;    <span class="keywordtype">int</span> badchange=0;</div>
<div class="line"><a name="l01665"></a><span class="lineno"> 1665</span>&#160;    <span class="keywordflow">if</span>(mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad919bedc37c48678c11e7e45cd1394cf">QTYURAD</a> || mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>==QTYURADENERGYONLY || mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a40391d70529dd21b8440039934ae0481">QTYURADMOMONLY</a>){</div>
<div class="line"><a name="l01666"></a><span class="lineno"> 1666</span>&#160;      <span class="keywordflow">if</span>(</div>
<div class="line"><a name="l01667"></a><span class="lineno"> 1667</span>&#160;         <a class="code" href="../../da/d3e/definit_8h.html#af48e1348f10b3468e425c084365f5e64" title="which velocity to compute in (init can be anything (see init.c&#39;s for transformations)">REMOVERESTMASSFROMUU</a>==2 &amp;&amp; (uu[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>]-uu[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#a841d43603fddda5fbcbc03d6b2f544de">iotherU</a>[0]]&lt;=0.0)</div>
<div class="line"><a name="l01668"></a><span class="lineno"> 1668</span>&#160;         ||<a class="code" href="../../da/d3e/definit_8h.html#af48e1348f10b3468e425c084365f5e64" title="which velocity to compute in (init can be anything (see init.c&#39;s for transformations)">REMOVERESTMASSFROMUU</a>!=2 &amp;&amp; (-uu[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#a841d43603fddda5fbcbc03d6b2f544de">iotherU</a>[0]]&lt;=0.0)</div>
<div class="line"><a name="l01669"></a><span class="lineno"> 1669</span>&#160;         ){</div>
<div class="line"><a name="l01670"></a><span class="lineno"> 1670</span>&#160;        badchange=1;</div>
<div class="line"><a name="l01671"></a><span class="lineno"> 1671</span>&#160;      }</div>
<div class="line"><a name="l01672"></a><span class="lineno"> 1672</span>&#160;      <span class="comment">// can also go bad when momentum exceeds energy, but more complicated check for GRMHD -- so just do inversion</span></div>
<div class="line"><a name="l01673"></a><span class="lineno"> 1673</span>&#160;    }</div>
<div class="line"><a name="l01674"></a><span class="lineno"> 1674</span>&#160;    <span class="keywordflow">if</span>(mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aea080032b13db4a71781aee78fef9902" title="whether iterate or have as error function: MHD T^t_ or RAD R^t_, etc.">QTYUMHD</a> || mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a0cb9c70ab4deb85a764f6733a96e09cc">QTYUMHDENERGYONLY</a> || mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a37a2a0ddbf7a80e93124ce89084d89ca">QTYUMHDMOMONLY</a>){</div>
<div class="line"><a name="l01675"></a><span class="lineno"> 1675</span>&#160;      <span class="keywordflow">if</span>(-uu[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#a841d43603fddda5fbcbc03d6b2f544de">iotherU</a>[0]]&lt;=0.0){</div>
<div class="line"><a name="l01676"></a><span class="lineno"> 1676</span>&#160;        badchange=1;</div>
<div class="line"><a name="l01677"></a><span class="lineno"> 1677</span>&#160;      }</div>
<div class="line"><a name="l01678"></a><span class="lineno"> 1678</span>&#160;      <span class="comment">// inversion will catch when momentum exceeds energy.</span></div>
<div class="line"><a name="l01679"></a><span class="lineno"> 1679</span>&#160;    }</div>
<div class="line"><a name="l01680"></a><span class="lineno"> 1680</span>&#160;    <span class="comment">// &quot;revert&quot; uu and ignore 4-force if badchange and just fail directly without expense of inversion.</span></div>
<div class="line"><a name="l01681"></a><span class="lineno"> 1681</span>&#160;    <span class="keywordflow">if</span>(badchange &amp;&amp; iter==1){</div>
<div class="line"><a name="l01682"></a><span class="lineno"> 1682</span>&#160;      <span class="comment">// if first iteration, assume guess as (e.g.) Uiin, but can now change to uu0.</span></div>
<div class="line"><a name="l01683"></a><span class="lineno"> 1683</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) uu[pl] = uu0[pl];</div>
<div class="line"><a name="l01684"></a><span class="lineno"> 1684</span>&#160;    }</div>
<div class="line"><a name="l01685"></a><span class="lineno"> 1685</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(badchange){</div>
<div class="line"><a name="l01686"></a><span class="lineno"> 1686</span>&#160;      <span class="comment">// only change other to uubackup (i.e. before 4-force applied)</span></div>
<div class="line"><a name="l01687"></a><span class="lineno"> 1687</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(iv) uu[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#a841d43603fddda5fbcbc03d6b2f544de">iotherU</a>[iv]] = uubackup[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#a841d43603fddda5fbcbc03d6b2f544de">iotherU</a>[iv]];</div>
<div class="line"><a name="l01688"></a><span class="lineno"> 1688</span>&#160;    }</div>
<div class="line"><a name="l01689"></a><span class="lineno"> 1689</span>&#160;    <span class="comment">// 2) Get estimated U[entropy]</span></div>
<div class="line"><a name="l01690"></a><span class="lineno"> 1690</span>&#160;    <span class="comment">// mathematica has Sc = Sc0 + dt *GS with GS = -u.G/T</span></div>
<div class="line"><a name="l01691"></a><span class="lineno"> 1691</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> GS=0.0;</div>
<div class="line"><a name="l01692"></a><span class="lineno"> 1692</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Tgaslocal=0.0,Tradlocal=0.0;</div>
<div class="line"><a name="l01693"></a><span class="lineno"> 1693</span>&#160;    <span class="keywordflow">if</span>(badchange==0){</div>
<div class="line"><a name="l01694"></a><span class="lineno"> 1694</span>&#160;      <span class="keywordflow">if</span>(0){</div>
<div class="line"><a name="l01695"></a><span class="lineno"> 1695</span>&#160;        Tgaslocal=compute_temp_simple(ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,ptrgeom-&gt;p,pp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>],pp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]);</div>
<div class="line"><a name="l01696"></a><span class="lineno"> 1696</span>&#160;        <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a11e17cd8b0594d1ad52e3594aa9f477e" title="find ucon, ucov, bcon, bcov from primitive variables when calling get_state, users of this function e...">get_state</a>(pp, ptrgeom, q);</div>
<div class="line"><a name="l01697"></a><span class="lineno"> 1697</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(iv) GS += (-q-&gt;<a class="code" href="../../d1/d83/structof__state.html#aab723d3c7c2c48b7246cc7d7d5379eed">ucon</a>[iv]*(ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aced783637d9ae9182ae10b44fcbac284">signgd2</a>)*( (ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#ac1d5c40ee4d532cac343c1792e17c076">signgd7</a>)*Gddt[iv]))/(Tgaslocal+<a class="code" href="../../da/d04/global_8depmnemonics_8rad_8h.html#a213757d7585988f6c552da30cc6fcc39">TEMPMIN</a>); <span class="comment">// maybe more accurate than just using entropy from pp and ucon[TT] from state from pp. __WORKINGONIT__: Can&#39;t be right that this is the same (signgd2=signgd7=1) for both URAD and UMHD methods.</span></div>
<div class="line"><a name="l01698"></a><span class="lineno"> 1698</span>&#160;      }</div>
<div class="line"><a name="l01699"></a><span class="lineno"> 1699</span>&#160;      <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l01700"></a><span class="lineno"> 1700</span>&#160;        <span class="comment">// Get GS completely consisent with primitives, in case using entropy error function, because then shouldn&#39;t use Gddt[TT] related to energy equation.</span></div>
<div class="line"><a name="l01701"></a><span class="lineno"> 1701</span>&#160;        <span class="comment">// Below rad inv may not be completely necessary, but not too expensive, so ok.</span></div>
<div class="line"><a name="l01702"></a><span class="lineno"> 1702</span>&#160;        <span class="keywordtype">int</span> doradonly=1; failreturn=Utoprimgen_failwrapper(doradonly,radinvmod,showmessages,checkoninversiongas,checkoninversionrad,allowlocalfailurefixandnoreport, finalstep, eomtype, whichcap, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7d1dc231c422450f87fdb3e71b4a7aff" title="defines how Utoprimgen is used">EVOLVEUTOPRIM</a>, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab2be21bd5eff40ca89c20eeecbeab5e0">UNOTHING</a>, uu, q, ptrgeom, dissmeasure, pp, &amp;newtonstats);</div>
<div class="line"><a name="l01703"></a><span class="lineno"> 1703</span>&#160;        <span class="keywordtype">int</span> computestate=1;</div>
<div class="line"><a name="l01704"></a><span class="lineno"> 1704</span>&#160;        <span class="keywordtype">int</span> computeentropy=1;</div>
<div class="line"><a name="l01705"></a><span class="lineno"> 1705</span>&#160;        <a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#a0a9afe086334630c217cca3b3dbf7f7d" title="get 4-force for all pl&#39;s">koral_source_rad_calc</a>(computestate,computeentropy,pp, ptrgeom, Gdpl, Gdplabs, NULL, &amp;Tgaslocal, &amp;Tradlocal, q);</div>
<div class="line"><a name="l01706"></a><span class="lineno"> 1706</span>&#160;        GS = - (ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#a987d9cab27e21984bd25b825e523058e">signgd4</a>) * localdt * Gdpl[ENTROPY]/(ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#a156b044c75cffc015e7228257f9924b5">signgd6</a>); <span class="comment">// Consistent with uu = uu0 + signgd6*GS and how used when getting error function later</span></div>
<div class="line"><a name="l01707"></a><span class="lineno"> 1707</span>&#160;      }</div>
<div class="line"><a name="l01708"></a><span class="lineno"> 1708</span>&#160;    }</div>
<div class="line"><a name="l01709"></a><span class="lineno"> 1709</span>&#160;    uu[ENTROPY] = uu0[ENTROPY] + (ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#a156b044c75cffc015e7228257f9924b5">signgd6</a>)*GS; <span class="comment">// KORALTODO SUPERGODMARK: Problem with UMHD,UMHD no matter signgd7.  Ok with URAD,URAD.   Ok with UMHD,ENTROPYUMHD if signgd7 +1 and signgd4 +1.</span></div>
<div class="line"><a name="l01710"></a><span class="lineno"> 1710</span>&#160;    <span class="comment">// 3) Do MHD+RAD Inversion</span></div>
<div class="line"><a name="l01711"></a><span class="lineno"> 1711</span>&#160;    <span class="comment">//    PLOOP(pliter,pl) dualfprintf(fail_file,&quot;BEFORE: pl=%d pr=%g\n&quot;,pl,pp[pl]);</span></div>
<div class="line"><a name="l01712"></a><span class="lineno"> 1712</span>&#160;    <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a0a4c88ebd712c11eee70dda4d75288cf">setgasinversionstuff</a>(iter,whichcall,impeps,*errorabs,convabs,maxiter,&amp;newtonstats,&amp;checkoninversiongas,&amp;checkoninversionrad);</div>
<div class="line"><a name="l01713"></a><span class="lineno"> 1713</span>&#160;    <span class="keywordtype">int</span> doradonly=0; failreturn=Utoprimgen_failwrapper(doradonly,radinvmod,showmessages,checkoninversiongas,checkoninversionrad,allowlocalfailurefixandnoreport, finalstep, eomtype, whichcap, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7d1dc231c422450f87fdb3e71b4a7aff" title="defines how Utoprimgen is used">EVOLVEUTOPRIM</a>, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab2be21bd5eff40ca89c20eeecbeab5e0">UNOTHING</a>, uu, q, ptrgeom, dissmeasure, pp, &amp;newtonstats);</div>
<div class="line"><a name="l01714"></a><span class="lineno"> 1714</span>&#160;    *nummhdinvsreturn++;</div>
<div class="line"><a name="l01715"></a><span class="lineno"> 1715</span>&#160;</div>
<div class="line"><a name="l01716"></a><span class="lineno"> 1716</span>&#160;    <span class="keywordflow">if</span>(failreturn==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a3dc38d50c77a49ac41a760b684ad7aab">UTOPRIMGENWRAPPERRETURNFAILRAD</a> &amp;&amp; whichcall==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a195d482ffa46307e2e7ed74f457d5300">FIMPLICITCALLTYPEJAC</a>){</div>
<div class="line"><a name="l01717"></a><span class="lineno"> 1717</span>&#160;      <span class="comment">// then try other uu, even if total energy is not conserved, better than raditive failure leading to problems or innacuracy.</span></div>
<div class="line"><a name="l01718"></a><span class="lineno"> 1718</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) uu[pl] = uuprev[pl];</div>
<div class="line"><a name="l01719"></a><span class="lineno"> 1719</span>&#160;      doradonly=1; failreturn=Utoprimgen_failwrapper(doradonly,radinvmod,showmessages,checkoninversiongas,checkoninversionrad,allowlocalfailurefixandnoreport, finalstep, eomtype, whichcap, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7d1dc231c422450f87fdb3e71b4a7aff" title="defines how Utoprimgen is used">EVOLVEUTOPRIM</a>, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab2be21bd5eff40ca89c20eeecbeab5e0">UNOTHING</a>, uu, q, ptrgeom, dissmeasure, pp, &amp;newtonstats);</div>
<div class="line"><a name="l01720"></a><span class="lineno"> 1720</span>&#160;      <span class="keywordflow">if</span>(failreturn==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aca02306e49f39d9dfc81492b850fb466" title="mnemonics for return modes so schemes know how failed and what to do.">UTOPRIMGENWRAPPERRETURNNOFAIL</a>){</div>
<div class="line"><a name="l01721"></a><span class="lineno"> 1721</span>&#160;        <span class="keywordtype">int</span> jjj;</div>
<div class="line"><a name="l01722"></a><span class="lineno"> 1722</span>&#160;        <span class="comment">//        DLOOPA(jjj) dualfprintf(fail_file,&quot;DIDIT: jjj=%d uu=%21.15g\n&quot;,jjj,uu[URAD0+jjj]);</span></div>
<div class="line"><a name="l01723"></a><span class="lineno"> 1723</span>&#160;      }</div>
<div class="line"><a name="l01724"></a><span class="lineno"> 1724</span>&#160;      <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l01725"></a><span class="lineno"> 1725</span>&#160;        <span class="comment">//        dualfprintf(fail_file,&quot;DIDITNOT\n&quot;);      </span></div>
<div class="line"><a name="l01726"></a><span class="lineno"> 1726</span>&#160;        <span class="keywordtype">int</span> jjj;</div>
<div class="line"><a name="l01727"></a><span class="lineno"> 1727</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jjj){</div>
<div class="line"><a name="l01728"></a><span class="lineno"> 1728</span>&#160;          uu[URAD0+jjj]*=0.1;</div>
<div class="line"><a name="l01729"></a><span class="lineno"> 1729</span>&#160;        }</div>
<div class="line"><a name="l01730"></a><span class="lineno"> 1730</span>&#160;        <span class="comment">//        DLOOPA(jjj) dualfprintf(fail_file,&quot;trying: jjj=%d uu=%21.15g\n&quot;,jjj,uu[URAD0+jjj]);</span></div>
<div class="line"><a name="l01731"></a><span class="lineno"> 1731</span>&#160;        doradonly=1; failreturn=Utoprimgen_failwrapper(doradonly,radinvmod,showmessages,checkoninversiongas,checkoninversionrad,allowlocalfailurefixandnoreport, finalstep, eomtype, whichcap, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7d1dc231c422450f87fdb3e71b4a7aff" title="defines how Utoprimgen is used">EVOLVEUTOPRIM</a>, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab2be21bd5eff40ca89c20eeecbeab5e0">UNOTHING</a>, uu, q, ptrgeom, dissmeasure, pp, &amp;newtonstats);</div>
<div class="line"><a name="l01732"></a><span class="lineno"> 1732</span>&#160;        <span class="comment">//doradonly=1; failreturn=Utoprimgen_failwrapper(doradonly,radinvmod,showmessages,checkoninversiongas,checkoninversionrad,allowlocalfailurefixandnoreport, finalstep, eomtype, whichcap, EVOLVEUTOPRIM, UNOTHING, uu0, q, ptrgeom, dissmeasure, pp, &amp;newtonstats);</span></div>
<div class="line"><a name="l01733"></a><span class="lineno"> 1733</span>&#160;        <span class="comment">//        if(failreturn==UTOPRIMGENWRAPPERRETURNNOFAIL) dualfprintf(fail_file,&quot;DIDIT02\n&quot;);</span></div>
<div class="line"><a name="l01734"></a><span class="lineno"> 1734</span>&#160;        <span class="comment">//        else dualfprintf(fail_file,&quot;DIDITNOT02\n&quot;);      </span></div>
<div class="line"><a name="l01735"></a><span class="lineno"> 1735</span>&#160;      }</div>
<div class="line"><a name="l01736"></a><span class="lineno"> 1736</span>&#160;    }</div>
<div class="line"><a name="l01737"></a><span class="lineno"> 1737</span>&#160;</div>
<div class="line"><a name="l01738"></a><span class="lineno"> 1738</span>&#160;</div>
<div class="line"><a name="l01739"></a><span class="lineno"> 1739</span>&#160;</div>
<div class="line"><a name="l01740"></a><span class="lineno"> 1740</span>&#160;    <span class="comment">// When failreturn==UTOPRIMGENWRAPPERRETURNFAILMHD, Utoprimgen() passes back pp as initial guess, and when u(pp) is computed below, effectively didn&#39;t move uu[gas] away from uu0[gas]</span></div>
<div class="line"><a name="l01741"></a><span class="lineno"> 1741</span>&#160;    <span class="keywordflow">if</span>(badchange) failreturn=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a37d8e953a25b51ce606f181bbc18d562">UTOPRIMGENWRAPPERRETURNFAILMHD</a>; <span class="comment">// indicate that messed-up MHD inversion, without having to do the inversion.</span></div>
<div class="line"><a name="l01742"></a><span class="lineno"> 1742</span>&#160;    <span class="comment">//    PLOOP(pliter,pl) dualfprintf(fail_file,&quot;AFTER: pl=%d pr=%g\n&quot;,pl,pp[pl]);</span></div>
<div class="line"><a name="l01743"></a><span class="lineno"> 1743</span>&#160;    <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a7df8286c59d491ba1117884d33499a7a">prod0dualfprintf</a>(debugfail&gt;=3,<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;NEWTON: %d : ijk=%d %d %d : %d %g\n&quot;</span>,iter,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a83280998e47831044a7e35299495a9bb">lntries</a>,newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a02529bef0a69373dc4e7e9e7a672d1db">lerrx</a>);</div>
<div class="line"><a name="l01744"></a><span class="lineno"> 1744</span>&#160;    radinvmodalt=*radinvmod; <span class="comment">// default</span></div>
<div class="line"><a name="l01745"></a><span class="lineno"> 1745</span>&#160;    failreturnalt=failreturn; <span class="comment">// default</span></div>
<div class="line"><a name="l01746"></a><span class="lineno"> 1746</span>&#160;</div>
<div class="line"><a name="l01747"></a><span class="lineno"> 1747</span>&#160;    <span class="keywordflow">if</span>(*eomtype==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a757ad8b9c2c7611dad8aab853a87f61b">EOMCOLDGRMHD</a>){<span class="comment">// restore uu because this inversion assumes u=0 and sets u=0, but if cold valid then ok to keep u~0 and constant as long as fixups applied.</span></div>
<div class="line"><a name="l01748"></a><span class="lineno"> 1748</span>&#160;      pp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]=ppbackup[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>];</div>
<div class="line"><a name="l01749"></a><span class="lineno"> 1749</span>&#160;      <span class="keywordflow">if</span>(ENTROPY&gt;=0) pp[ENTROPY]=pp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>];</div>
<div class="line"><a name="l01750"></a><span class="lineno"> 1750</span>&#160;    }</div>
<div class="line"><a name="l01751"></a><span class="lineno"> 1751</span>&#160;    <span class="comment">// KORALTODO: now can check if actually did eomtype==EOMGRMHD or EOMENTROPYGRMHD or EOMCOLDGRMHD and apply correct error function if using QTYUMHD.</span></div>
<div class="line"><a name="l01752"></a><span class="lineno"> 1752</span>&#160;    <span class="comment">// 4) now get consistent uu[] based upon actual final primitives.</span></div>
<div class="line"><a name="l01753"></a><span class="lineno"> 1753</span>&#160;    <span class="comment">// Needed in case inversion reduced to entropy or cold.</span></div>
<div class="line"><a name="l01754"></a><span class="lineno"> 1754</span>&#160;    <span class="comment">// Also needed to get correct UU[ENTROPY] if did full MHD inversion or get correct U[UU] if did entropy inversion, etc.</span></div>
<div class="line"><a name="l01755"></a><span class="lineno"> 1755</span>&#160;    <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a11e17cd8b0594d1ad52e3594aa9f477e" title="find ucon, ucov, bcon, bcov from primitive variables when calling get_state, users of this function e...">get_state</a>(pp, ptrgeom, q);</div>
<div class="line"><a name="l01756"></a><span class="lineno"> 1756</span>&#160;    <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a9a54096e4c40a15a2c1bf74266153616" title="calculate &quot;conserved&quot; quantities">primtoU</a>(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab2be21bd5eff40ca89c20eeecbeab5e0">UNOTHING</a>,pp,q,ptrgeom, uu, uuabs);</div>
<div class="line"><a name="l01757"></a><span class="lineno"> 1757</span>&#160;    <span class="comment">// now have full primitives and full U including entropy and these are consistent with each other.</span></div>
<div class="line"><a name="l01758"></a><span class="lineno"> 1758</span>&#160;    <span class="comment">// 5)</span></div>
<div class="line"><a name="l01759"></a><span class="lineno"> 1759</span>&#160;    <span class="comment">// set alternative that doesn&#39;t keep any changes to iterated quantities</span></div>
<div class="line"><a name="l01760"></a><span class="lineno"> 1760</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) ppalt[pl] = pp[pl];</div>
<div class="line"><a name="l01761"></a><span class="lineno"> 1761</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) uualt[pl] = uu[pl];</div>
<div class="line"><a name="l01762"></a><span class="lineno"> 1762</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(iv) uualt[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[iv]] = uubackup[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[iv]];</div>
<div class="line"><a name="l01763"></a><span class="lineno"> 1763</span>&#160;    <span class="keywordflow">if</span>(mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad919bedc37c48678c11e7e45cd1394cf">QTYURAD</a> || mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>==QTYURADENERGYONLY || mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a40391d70529dd21b8440039934ae0481">QTYURADMOMONLY</a>){</div>
<div class="line"><a name="l01764"></a><span class="lineno"> 1764</span>&#160;      radinvmodalt=0; <span class="comment">// if iterating URAD, then ignore radinvmod==1 for alternative error but need to still use new primitives.</span></div>
<div class="line"><a name="l01765"></a><span class="lineno"> 1765</span>&#160;      <span class="keywordflow">if</span>(failreturn==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a3dc38d50c77a49ac41a760b684ad7aab">UTOPRIMGENWRAPPERRETURNFAILRAD</a>) failreturnalt=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aca02306e49f39d9dfc81492b850fb466" title="mnemonics for return modes so schemes know how failed and what to do.">UTOPRIMGENWRAPPERRETURNNOFAIL</a>; <span class="comment">// only change failure if only rad failure</span></div>
<div class="line"><a name="l01766"></a><span class="lineno"> 1766</span>&#160;    }</div>
<div class="line"><a name="l01767"></a><span class="lineno"> 1767</span>&#160;  }</div>
<div class="line"><a name="l01768"></a><span class="lineno"> 1768</span>&#160;</div>
<div class="line"><a name="l01769"></a><span class="lineno"> 1769</span>&#160;</div>
<div class="line"><a name="l01770"></a><span class="lineno"> 1770</span>&#160;</div>
<div class="line"><a name="l01772"></a><span class="lineno"> 1772</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01773"></a><span class="lineno"> 1773</span>&#160;  <span class="comment">// ENTROPYUMHD</span></div>
<div class="line"><a name="l01774"></a><span class="lineno"> 1774</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01776"></a><span class="lineno"> 1776</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01777"></a><span class="lineno"> 1777</span>&#160;</div>
<div class="line"><a name="l01778"></a><span class="lineno"> 1778</span>&#160;</div>
<div class="line"><a name="l01779"></a><span class="lineno"> 1779</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ae83cfa7d219127e1aab2b1ccbe844bc6">QTYENTROPYUMHD</a> || mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a66968440681b95ca6b3d30a6d2a03c53">QTYENTROPYUMHDENERGYONLY</a> || mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a0ca856011b58f6beb89106ccbe6fac4e">QTYENTROPYUMHDMOMONLY</a>){</div>
<div class="line"><a name="l01780"></a><span class="lineno"> 1780</span>&#160;    <span class="comment">// so iterating U[ENTROPY,U1,U2,U3]</span></div>
<div class="line"><a name="l01781"></a><span class="lineno"> 1781</span>&#160;    <span class="comment">//    FTYPE uuorig[NPR]; PLOOP(pliter,pl) uuorig[pl]=uu[pl];</span></div>
<div class="line"><a name="l01782"></a><span class="lineno"> 1782</span>&#160;    <span class="comment">// 1) Do pure ENTROPYMHD inversion to get pmhd</span></div>
<div class="line"><a name="l01783"></a><span class="lineno"> 1783</span>&#160;    <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a0a4c88ebd712c11eee70dda4d75288cf">setgasinversionstuff</a>(iter,whichcall,impeps,*errorabs,convabs,maxiter,&amp;newtonstats,&amp;checkoninversiongas,&amp;checkoninversionrad);</div>
<div class="line"><a name="l01784"></a><span class="lineno"> 1784</span>&#160;    <span class="keywordtype">int</span> doradonly=0; <span class="keywordtype">int</span> eomtypetemp=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a40b55e98bfcccde1a3f19d983ca7488c">EOMENTROPYGRMHD</a>; failreturn=Utoprimgen_failwrapper(doradonly,radinvmod,showmessages,checkoninversiongas,checkoninversionrad,allowlocalfailurefixandnoreport, finalstep, &amp;eomtypetemp, whichcap, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7d1dc231c422450f87fdb3e71b4a7aff" title="defines how Utoprimgen is used">EVOLVEUTOPRIM</a>, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab2be21bd5eff40ca89c20eeecbeab5e0">UNOTHING</a>, uu, q, ptrgeom, dissmeasure, pp, &amp;newtonstats);</div>
<div class="line"><a name="l01785"></a><span class="lineno"> 1785</span>&#160;    *nummhdinvsreturn++;</div>
<div class="line"><a name="l01786"></a><span class="lineno"> 1786</span>&#160;    radinvmodalt=*radinvmod; <span class="comment">// default</span></div>
<div class="line"><a name="l01787"></a><span class="lineno"> 1787</span>&#160;    failreturnalt=failreturn; <span class="comment">// default</span></div>
<div class="line"><a name="l01788"></a><span class="lineno"> 1788</span>&#160;    <span class="keywordflow">if</span>(*eomtype==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a757ad8b9c2c7611dad8aab853a87f61b">EOMCOLDGRMHD</a>){<span class="comment">// restore uu because this inversion assumes u=0 and sets u=0, but if cold valid then ok to keep u~0 and constant as long as fixups applied.</span></div>
<div class="line"><a name="l01789"></a><span class="lineno"> 1789</span>&#160;      pp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]=ppbackup[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>];</div>
<div class="line"><a name="l01790"></a><span class="lineno"> 1790</span>&#160;      <span class="keywordflow">if</span>(ENTROPY&gt;=0) pp[ENTROPY]=pp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>];</div>
<div class="line"><a name="l01791"></a><span class="lineno"> 1791</span>&#160;    }</div>
<div class="line"><a name="l01792"></a><span class="lineno"> 1792</span>&#160;    <span class="comment">// set eomtype!  So for entire process for this cell, the entropy equations are used.</span></div>
<div class="line"><a name="l01793"></a><span class="lineno"> 1793</span>&#160;    *eomtype=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a40b55e98bfcccde1a3f19d983ca7488c">EOMENTROPYGRMHD</a>;</div>
<div class="line"><a name="l01794"></a><span class="lineno"> 1794</span>&#160;    <span class="comment">// KORALTODO: now can check if actually did eomtypetemp==EOMENTROPYGRMHD or EOMCOLDGRMHD and apply correct error function in case reduced to cold MHD (maybe G=0?)</span></div>
<div class="line"><a name="l01795"></a><span class="lineno"> 1795</span>&#160;    <span class="comment">// 2) get state (mhd and entropy are up-to-date, while rad is out-of-date, but fixed below)</span></div>
<div class="line"><a name="l01796"></a><span class="lineno"> 1796</span>&#160;    <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a11e17cd8b0594d1ad52e3594aa9f477e" title="find ucon, ucov, bcon, bcov from primitive variables when calling get_state, users of this function e...">get_state</a>(pp, ptrgeom, q);</div>
<div class="line"><a name="l01797"></a><span class="lineno"> 1797</span>&#160;    <span class="comment">// 3) Compute U[UU] so have it for below (computes U[Ui,ENTROPY,RAD], but those not used or already known.)</span></div>
<div class="line"><a name="l01798"></a><span class="lineno"> 1798</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> uuentropy[NPR],uuentropyabs[NPR];</div>
<div class="line"><a name="l01799"></a><span class="lineno"> 1799</span>&#160;    <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a9a54096e4c40a15a2c1bf74266153616" title="calculate &quot;conserved&quot; quantities">primtoU</a>(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab2be21bd5eff40ca89c20eeecbeab5e0">UNOTHING</a>,pp,q,ptrgeom, uuentropy, uuentropyabs);</div>
<div class="line"><a name="l01800"></a><span class="lineno"> 1800</span>&#160;    uu[ENTROPY]=uuentropy[ENTROPY];</div>
<div class="line"><a name="l01801"></a><span class="lineno"> 1801</span>&#160;    uuabs[ENTROPY]=uuentropyabs[ENTROPY];</div>
<div class="line"><a name="l01802"></a><span class="lineno"> 1802</span>&#160;    <span class="comment">//    PLOOP(pliter,pl) if(pl==U1||pl==U2||pl==U3||pl==ENTROPY) pp[pl]=pporig[pl]; // get back U[ENTROPY,Ui] so no machine error introduced from u(p(u)) for actually known quantities that won&#39;t change due to fixups or anything. -- no, primitives from Utoprimgen might change things and act as Newton step fix.</span></div>
<div class="line"><a name="l01803"></a><span class="lineno"> 1803</span>&#160;    <span class="comment">// 4) Get actual Urad [note uses UU not irefU that is ENTROPY for irefU[0]]</span></div>
<div class="line"><a name="l01804"></a><span class="lineno"> 1804</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(iv) uu[URAD0+iv] = uu0[URAD0+iv] - (uu[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>+iv]-uu0[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>+iv]);</div>
<div class="line"><a name="l01805"></a><span class="lineno"> 1805</span>&#160;    <span class="comment">// 5) Do RAD-ONLY inversion</span></div>
<div class="line"><a name="l01806"></a><span class="lineno"> 1806</span>&#160;    <span class="keywordtype">int</span> failreturn2;  <span class="keywordtype">int</span> doradonly2=1; failreturn2=Utoprimgen_failwrapper(doradonly2,radinvmod,showmessages,checkoninversiongas,checkoninversionrad,allowlocalfailurefixandnoreport, finalstep, eomtype, whichcap, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7d1dc231c422450f87fdb3e71b4a7aff" title="defines how Utoprimgen is used">EVOLVEUTOPRIM</a>, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab2be21bd5eff40ca89c20eeecbeab5e0">UNOTHING</a>, uu, q, ptrgeom, dissmeasure, pp, &amp;newtonstats);</div>
<div class="line"><a name="l01807"></a><span class="lineno"> 1807</span>&#160;    <span class="comment">//  no need to concern with eomtype in RAD only case.  i.e. eomtype won&#39;t change.</span></div>
<div class="line"><a name="l01808"></a><span class="lineno"> 1808</span>&#160;    <span class="keywordflow">if</span>(failreturn2&gt;failreturn) failreturn=failreturn2; <span class="comment">// use worst case.</span></div>
<div class="line"><a name="l01809"></a><span class="lineno"> 1809</span>&#160;    <span class="comment">// 6) now get consistent uu[] based upon actual final primitives.</span></div>
<div class="line"><a name="l01810"></a><span class="lineno"> 1810</span>&#160;    <span class="comment">// Needed in case inversion reduced to entropy or cold or radiative inversion used fixups.</span></div>
<div class="line"><a name="l01811"></a><span class="lineno"> 1811</span>&#160;    <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a11e17cd8b0594d1ad52e3594aa9f477e" title="find ucon, ucov, bcon, bcov from primitive variables when calling get_state, users of this function e...">get_state</a>(pp, ptrgeom, q);</div>
<div class="line"><a name="l01812"></a><span class="lineno"> 1812</span>&#160;    <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a9a54096e4c40a15a2c1bf74266153616" title="calculate &quot;conserved&quot; quantities">primtoU</a>(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab2be21bd5eff40ca89c20eeecbeab5e0">UNOTHING</a>,pp,q,ptrgeom, uu, uuabs);</div>
<div class="line"><a name="l01813"></a><span class="lineno"> 1813</span>&#160;    <span class="comment">// now have full primitives and full U including entropy and these are consistent with each other.</span></div>
<div class="line"><a name="l01814"></a><span class="lineno"> 1814</span>&#160;    <span class="comment">// 7)</span></div>
<div class="line"><a name="l01815"></a><span class="lineno"> 1815</span>&#160;    <span class="comment">// set alternative that doesn&#39;t keep any changes to iterated quantities</span></div>
<div class="line"><a name="l01816"></a><span class="lineno"> 1816</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) ppalt[pl] = pp[pl];</div>
<div class="line"><a name="l01817"></a><span class="lineno"> 1817</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) uualt[pl] = uu[pl];</div>
<div class="line"><a name="l01818"></a><span class="lineno"> 1818</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(iv) uualt[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[iv]] = uubackup[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[iv]];</div>
<div class="line"><a name="l01819"></a><span class="lineno"> 1819</span>&#160;  }</div>
<div class="line"><a name="l01820"></a><span class="lineno"> 1820</span>&#160;</div>
<div class="line"><a name="l01821"></a><span class="lineno"> 1821</span>&#160;</div>
<div class="line"><a name="l01822"></a><span class="lineno"> 1822</span>&#160;</div>
<div class="line"><a name="l01824"></a><span class="lineno"> 1824</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01825"></a><span class="lineno"> 1825</span>&#160;  <span class="comment">// ENTROPYPMHD</span></div>
<div class="line"><a name="l01826"></a><span class="lineno"> 1826</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01828"></a><span class="lineno"> 1828</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01829"></a><span class="lineno"> 1829</span>&#160;</div>
<div class="line"><a name="l01830"></a><span class="lineno"> 1830</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a7a5a1fd5a93591755aa3e1af2019dc57">QTYENTROPYPMHD</a>){</div>
<div class="line"><a name="l01831"></a><span class="lineno"> 1831</span>&#160;    <span class="comment">// not setup</span></div>
<div class="line"><a name="l01832"></a><span class="lineno"> 1832</span>&#160;    myexit(92846534);</div>
<div class="line"><a name="l01833"></a><span class="lineno"> 1833</span>&#160;  }</div>
<div class="line"><a name="l01834"></a><span class="lineno"> 1834</span>&#160;</div>
<div class="line"><a name="l01835"></a><span class="lineno"> 1835</span>&#160;</div>
<div class="line"><a name="l01836"></a><span class="lineno"> 1836</span>&#160;</div>
<div class="line"><a name="l01838"></a><span class="lineno"> 1838</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01839"></a><span class="lineno"> 1839</span>&#160;  <span class="comment">// PMHD</span></div>
<div class="line"><a name="l01840"></a><span class="lineno"> 1840</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01842"></a><span class="lineno"> 1842</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01843"></a><span class="lineno"> 1843</span>&#160;</div>
<div class="line"><a name="l01844"></a><span class="lineno"> 1844</span>&#160;</div>
<div class="line"><a name="l01845"></a><span class="lineno"> 1845</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9cf5ca7f5e5aa1e0bdef53abe3f27c1c">QTYPMHD</a> || mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8b10ec187cbee196f071e162563cd945">QTYPMHDENERGYONLY</a> || mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad1dda20c101a983834446c5c93791583">QTYPMHDMOMONLY</a>){</div>
<div class="line"><a name="l01846"></a><span class="lineno"> 1846</span>&#160;    <span class="comment">// 0) Have pmhd={ug,uvel1,uvel2,uvel3}</span></div>
<div class="line"><a name="l01847"></a><span class="lineno"> 1847</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01848"></a><span class="lineno"> 1848</span>&#160;    <span class="comment">// 0.5) trivially invert field</span></div>
<div class="line"><a name="l01849"></a><span class="lineno"> 1849</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a9afde1f1647e18e733406a1566b8b550">PLOOPBONLY</a>(pl) pp[pl] = uu0[pl];</div>
<div class="line"><a name="l01850"></a><span class="lineno"> 1850</span>&#160;    <span class="comment">// set p[ENTROPY] in case evaluated as a diagnostic.</span></div>
<div class="line"><a name="l01851"></a><span class="lineno"> 1851</span>&#160;    <span class="keywordflow">if</span>(ENTROPY&gt;=0) pp[ENTROPY] = pp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>];</div>
<div class="line"><a name="l01852"></a><span class="lineno"> 1852</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01853"></a><span class="lineno"> 1853</span>&#160;    <span class="comment">// 1) get state of non-density related things (mhd state needed for q-&gt;ucon[TT] and primtoU) and Umhd, Uentropy [also computes Urad, but overwritten next and not expensive]</span></div>
<div class="line"><a name="l01854"></a><span class="lineno"> 1854</span>&#160;    <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a3c69b676adf3024cd6ae832094d91fab" title="find ucon, ucov, bcon, bcov from primitive variables when calling get_state, users of this function e...">get_state_norad_part1</a>(pp, ptrgeom, q);</div>
<div class="line"><a name="l01855"></a><span class="lineno"> 1855</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01856"></a><span class="lineno"> 1856</span>&#160;    <span class="comment">// 2) trivially invert to get rho</span></div>
<div class="line"><a name="l01857"></a><span class="lineno"> 1857</span>&#160;    pp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>]= uu0[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>]/q-&gt;<a class="code" href="../../d1/d83/structof__state.html#aab723d3c7c2c48b7246cc7d7d5379eed">ucon</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>];</div>
<div class="line"><a name="l01858"></a><span class="lineno"> 1858</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01859"></a><span class="lineno"> 1859</span>&#160;    <span class="keywordflow">if</span>(1){</div>
<div class="line"><a name="l01860"></a><span class="lineno"> 1860</span>&#160;      <span class="comment">// Don&#39;t restrict rho or u_g except as by iteration catches.  Don&#39;t restrict gamma or gammarad during iterations so can smoothly go out of bounds if required temporarily.</span></div>
<div class="line"><a name="l01861"></a><span class="lineno"> 1861</span>&#160;      <span class="comment">// KORALTODO: SUPERGODMARK: causes many more high error - high iteration events.  fixup1zone() has no radiation, so not consistent.  But eventually applied!  Is it due to limit_gamma() or density floors?</span></div>
<div class="line"><a name="l01862"></a><span class="lineno"> 1862</span>&#160;      <span class="comment">// 3) Apply any fixups, like floors or limit_gamma&#39;s.  Won&#39;t help reduce error, but even if solution with high fluid gamma, later apply limit_gamma, but then balance between fluid and radiation lost.  So better to see as high error event than accurate high gamma event.</span></div>
<div class="line"><a name="l01863"></a><span class="lineno"> 1863</span>&#160;      <span class="keywordtype">int</span> finalstepfixup=0; <span class="comment">// treat as if not needing to diagnose, just act.  KORALTODO: Although, Utoprimgen(finalstep) used to get change in fluid primitives.</span></div>
<div class="line"><a name="l01864"></a><span class="lineno"> 1864</span>&#160;      <span class="comment">// Note, uu is old, but only used for diagnostics, and don&#39;t care about diagnostics in this stepping.</span></div>
<div class="line"><a name="l01865"></a><span class="lineno"> 1865</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ppfixup[NPR],ppfloor[NPR],uufixup[NPR],prceiling[NPR];</div>
<div class="line"><a name="l01866"></a><span class="lineno"> 1866</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l01867"></a><span class="lineno"> 1867</span>&#160;        ppfixup[pl]=ppfloor[pl]=pp[pl];</div>
<div class="line"><a name="l01868"></a><span class="lineno"> 1868</span>&#160;        uufixup[pl]=uu[pl];</div>
<div class="line"><a name="l01869"></a><span class="lineno"> 1869</span>&#160;      }</div>
<div class="line"><a name="l01870"></a><span class="lineno"> 1870</span>&#160;      <span class="comment">// bsq is accurate using below</span></div>
<div class="line"><a name="l01871"></a><span class="lineno"> 1871</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> <a class="code" href="../../d1/d83/structof__state.html#a2b38c522ec7321af3368706fa4632834">bsq</a>; <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a41b8eacac0a4a23d6b00b670fe49629c">bsq_calc_fromq</a>(ppfixup, ptrgeom, q, &amp;bsq);</div>
<div class="line"><a name="l01872"></a><span class="lineno"> 1872</span>&#160;      <span class="comment">// uu isn&#39;t exactly like pfixup here, but close enough</span></div>
<div class="line"><a name="l01873"></a><span class="lineno"> 1873</span>&#160;      set_density_floors_alt(ptrgeom, q, ppfixup, uu, bsq, ppfloor, prceiling);</div>
<div class="line"><a name="l01874"></a><span class="lineno"> 1874</span>&#160;      <span class="comment">//      fixup1zone(1,ppfloor,uufixup, ptrgeom,finalstepfixup); // too complicated for implicit stepping given how rare should be used.</span></div>
<div class="line"><a name="l01875"></a><span class="lineno"> 1875</span>&#160;      <span class="keywordflow">if</span>(pp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>]&lt;0.0) pp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>]=ppfloor[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>]; <span class="comment">// only fix RHO if really went negative.  Not smooth, but avoids problems in difficult regimes.</span></div>
<div class="line"><a name="l01876"></a><span class="lineno"> 1876</span>&#160;</div>
<div class="line"><a name="l01877"></a><span class="lineno"> 1877</span>&#160;      <span class="comment">//      limit_gamma(0,GAMMAMAX,GAMMAMAXRADIMPLICITSOLVER,pp,NULL,ptrgeom,0);</span></div>
<div class="line"><a name="l01878"></a><span class="lineno"> 1878</span>&#160;      <span class="comment">// fix uu[RHO] to be consistent, since uu[RHO] used to get inverted scalars</span></div>
<div class="line"><a name="l01879"></a><span class="lineno"> 1879</span>&#160;      uu[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>] = pp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>]*q-&gt;<a class="code" href="../../d1/d83/structof__state.html#aab723d3c7c2c48b7246cc7d7d5379eed">ucon</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>];</div>
<div class="line"><a name="l01880"></a><span class="lineno"> 1880</span>&#160;      <span class="comment">// NOTEMARK:  If uu0[RHO]&lt;=0, then really no formal solution, but can still get solution to some error as long as adjust rho to be some &quot;floor&quot; value that is not unexpected when otherwise rho&lt;0 would be implied and cause the radiation terms to be ill-defined or complex.</span></div>
<div class="line"><a name="l01881"></a><span class="lineno"> 1881</span>&#160;      <span class="comment">// NOTEMARK: If happens to be on sub-step, then really not crucial and better to have had approximate solution for sub-step so perhaps final step can be regular with RHO and all terms.  If only issue on sub-step, won&#39;t shown up in final diagnostics.</span></div>
<div class="line"><a name="l01882"></a><span class="lineno"> 1882</span>&#160;    }</div>
<div class="line"><a name="l01883"></a><span class="lineno"> 1883</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01884"></a><span class="lineno"> 1884</span>&#160;    <span class="comment">// 4) Invert other scalars (only uses uu[RHO], not pp[RHO])</span></div>
<div class="line"><a name="l01885"></a><span class="lineno"> 1885</span>&#160;    <span class="keyword">extern</span> <span class="keywordtype">int</span> <a class="code" href="../../d1/d3e/utoprimgen_8c.html#abfc42de6975dd4ff02f2748404e10911" title="perform U-&gt;p inversion on advected scalars">invert_scalars1</a>(<span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ugeomfree, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr);</div>
<div class="line"><a name="l01886"></a><span class="lineno"> 1886</span>&#160;    <a class="code" href="../../d1/d3e/utoprimgen_8c.html#abfc42de6975dd4ff02f2748404e10911" title="perform U-&gt;p inversion on advected scalars">invert_scalars1</a>(ptrgeom, uu,pp);</div>
<div class="line"><a name="l01887"></a><span class="lineno"> 1887</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01888"></a><span class="lineno"> 1888</span>&#160;    <span class="comment">// save final fixed-up pp&#39;s</span></div>
<div class="line"><a name="l01889"></a><span class="lineno"> 1889</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> pporig[NPR]; <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) pporig[pl]=pp[pl];</div>
<div class="line"><a name="l01890"></a><span class="lineno"> 1890</span>&#160;    <span class="comment">// NOW all MHD pp&#39;s are set and backed-up</span></div>
<div class="line"><a name="l01891"></a><span class="lineno"> 1891</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01892"></a><span class="lineno"> 1892</span>&#160;    <span class="comment">// 5) Do rest of get_state that used rho, and other scalars, in case used.</span></div>
<div class="line"><a name="l01893"></a><span class="lineno"> 1893</span>&#160;    <span class="comment">// This computes pressure (as required for T^t_\mu) and entropy (as required for primtoflux_nonradonly below for entropy flux)</span></div>
<div class="line"><a name="l01894"></a><span class="lineno"> 1894</span>&#160;    <span class="comment">// KORALTODO: Although, don&#39;t need entropy if doing mtd-&gt;implicitferr==UMHD</span></div>
<div class="line"><a name="l01895"></a><span class="lineno"> 1895</span>&#160;    <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#aae6a7d24b984236dae44b1a3e8ee37b6" title="find ucon, ucov, bcon, bcov from primitive variables when calling get_state, users of this function e...">get_state_norad_part2</a>(needentropy, pp, ptrgeom, q); <span class="comment">// where entropy would be computed</span></div>
<div class="line"><a name="l01896"></a><span class="lineno"> 1896</span>&#160;</div>
<div class="line"><a name="l01897"></a><span class="lineno"> 1897</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01898"></a><span class="lineno"> 1898</span>&#160;    <span class="comment">// 6) Compute Umhd and Uentropy (keeps Urad as zero, but Urad set next)</span></div>
<div class="line"><a name="l01899"></a><span class="lineno"> 1899</span>&#160;    <span class="comment">//primtoU(UNOTHING,pp,q,ptrgeom, uu, uuabs);</span></div>
<div class="line"><a name="l01900"></a><span class="lineno"> 1900</span>&#160;    <span class="keyword">extern</span> <span class="keywordtype">int</span> <a class="code" href="../../d7/def/phys_8tools_8c.html#ad54ad99ee062beaf43518d6e9afae0a7">primtoflux_nonradonly</a>(<span class="keywordtype">int</span> needentropy, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *q, <span class="keywordtype">int</span> dir, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *geom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *flux, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *fluxabs);</div>
<div class="line"><a name="l01901"></a><span class="lineno"> 1901</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> uumhd[NPR],uumhdabs[NPR];</div>
<div class="line"><a name="l01902"></a><span class="lineno"> 1902</span>&#160;    <a class="code" href="../../d7/def/phys_8tools_8c.html#ad54ad99ee062beaf43518d6e9afae0a7">primtoflux_nonradonly</a>(needentropy,pp,q,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>,ptrgeom, uumhd, uumhdabs); <span class="comment">// anything not set is set as zero, which is rad.</span></div>
<div class="line"><a name="l01903"></a><span class="lineno"> 1903</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) <span class="keywordflow">if</span>(!<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a43791f6c1915cf7bfe3a02a4502510e4">RADFULLPL</a>(pl)) uu[pl]=uumhd[pl];</div>
<div class="line"><a name="l01904"></a><span class="lineno"> 1904</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) <span class="keywordflow">if</span>(!<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a43791f6c1915cf7bfe3a02a4502510e4">RADFULLPL</a>(pl)) uuabs[pl]=uumhdabs[pl];</div>
<div class="line"><a name="l01905"></a><span class="lineno"> 1905</span>&#160;    <span class="comment">//    primtoflux_nonradonly(1,pp,q,TT,ptrgeom, uu, uuabs); // doesn&#39;t actually compute entropy again, just multiplies existing things.</span></div>
<div class="line"><a name="l01906"></a><span class="lineno"> 1906</span>&#160;    <span class="comment">//    if(needentropy==0) uu[ENTROPY]=sqrt(-1.0);</span></div>
<div class="line"><a name="l01907"></a><span class="lineno"> 1907</span>&#160;    </div>
<div class="line"><a name="l01908"></a><span class="lineno"> 1908</span>&#160;    <span class="comment">// 7) Get actual Urad(G) via energy conservation (correct even if using entropy as error function, because just computed correct U[ENTROPY] consistent with U[UU].</span></div>
<div class="line"><a name="l01909"></a><span class="lineno"> 1909</span>&#160;    <span class="comment">// KORALNOTE: uu set by p-&gt;uu, which has an error of order machice precision.  So even if primitives didn&#39;t change, uu-uu0 can be order machine precision.  So when fluid uu&gt;&gt;rad uu, this can lead to the below giving huge radiation changes even if actually fluid background is not changing.</span></div>
<div class="line"><a name="l01910"></a><span class="lineno"> 1910</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(iv) uu[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#a841d43603fddda5fbcbc03d6b2f544de">iotherU</a>[iv]] = uu0[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#a841d43603fddda5fbcbc03d6b2f544de">iotherU</a>[iv]] - (uu[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[iv]]-uu0[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[iv]]);</div>
<div class="line"><a name="l01911"></a><span class="lineno"> 1911</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(iv) uuabs[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#a841d43603fddda5fbcbc03d6b2f544de">iotherU</a>[iv]] = fabs(uu0[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#a841d43603fddda5fbcbc03d6b2f544de">iotherU</a>[iv]]) + fabs(uu[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[iv]]) + fabs(uu0[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[iv]]);</div>
<div class="line"><a name="l01912"></a><span class="lineno"> 1912</span>&#160;</div>
<div class="line"><a name="l01913"></a><span class="lineno"> 1913</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01914"></a><span class="lineno"> 1914</span>&#160;    <span class="comment">// 8) Do RAD-ONLY Inversion (eomtype not used)</span></div>
<div class="line"><a name="l01915"></a><span class="lineno"> 1915</span>&#160;    <span class="keywordtype">int</span> whichcapnew;</div>
<div class="line"><a name="l01916"></a><span class="lineno"> 1916</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a025eda55485f11e4e248a4521b8f2faf" title="whether to use CAPTYPEFIX2 for f1 (central Jac and error estimate). Still will use CAPTYPEBASIC for f...">USECAPTYPEFIX2FORF1</a> &amp;&amp; whichcall==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a439b24ca8b87220703a1f950242344b7" title="f_implicit() call types">FIMPLICITCALLTYPEF1</a>) whichcapnew=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#af4a8ea9a61541490ee05c096ae984f20">CAPTYPEFIX2</a>;</div>
<div class="line"><a name="l01917"></a><span class="lineno"> 1917</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa643cd88da48f63c35ea3fff7f4ecfc1" title="&quot;&quot; for final check.">USECAPTYPEFIX2FORFINALCHECK</a> &amp;&amp; whichcall==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aed44d99ba064f5db1486676c305f80e2">FIMPLICITCALLTYPEFINALCHECK</a>) whichcapnew=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#af4a8ea9a61541490ee05c096ae984f20">CAPTYPEFIX2</a>;</div>
<div class="line"><a name="l01918"></a><span class="lineno"> 1918</span>&#160;    <span class="keywordflow">else</span> whichcapnew=whichcap; <span class="comment">// for jacobian, likely to be CAPTYPEFIX2 anyways.</span></div>
<div class="line"><a name="l01919"></a><span class="lineno"> 1919</span>&#160;    <span class="keywordtype">int</span> doradonly=1; failreturn=Utoprimgen_failwrapper(doradonly,radinvmod,showmessages,checkoninversiongas,checkoninversionrad,allowlocalfailurefixandnoreport, finalstep, eomtype, whichcapnew, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7d1dc231c422450f87fdb3e71b4a7aff" title="defines how Utoprimgen is used">EVOLVEUTOPRIM</a>, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab2be21bd5eff40ca89c20eeecbeab5e0">UNOTHING</a>, uu, q, ptrgeom, dissmeasure, pp, &amp;newtonstats);</div>
<div class="line"><a name="l01920"></a><span class="lineno"> 1920</span>&#160;    radinvmodalt=*radinvmod; <span class="comment">// default</span></div>
<div class="line"><a name="l01921"></a><span class="lineno"> 1921</span>&#160;    failreturnalt=failreturn; <span class="comment">// default</span></div>
<div class="line"><a name="l01922"></a><span class="lineno"> 1922</span>&#160;    <span class="comment">//  no need to concern with eomtype in RAD only case.  i.e. eomtype won&#39;t change.</span></div>
<div class="line"><a name="l01923"></a><span class="lineno"> 1923</span>&#160;    <span class="comment">//    if(*radinvmod&gt;0) dualfprintf(fail_file,&quot;radinvmodinside=%d  whichcall=%d : u=%g Erf=%g\n&quot;,*radinvmod,whichcall,pp[UU],pp[PRAD0]);</span></div>
<div class="line"><a name="l01924"></a><span class="lineno"> 1924</span>&#160;</div>
<div class="line"><a name="l01925"></a><span class="lineno"> 1925</span>&#160;</div>
<div class="line"><a name="l01926"></a><span class="lineno"> 1926</span>&#160;<span class="preprocessor">#if(0)</span></div>
<div class="line"><a name="l01927"></a><span class="lineno"> 1927</span>&#160;<span class="preprocessor"></span>    <span class="comment">// deal with Erf&lt;0 and possibly gammarad caps or E_r&lt;0 issues</span></div>
<div class="line"><a name="l01928"></a><span class="lineno"> 1928</span>&#160;    <span class="keywordflow">if</span>(iter&lt;mtd-&gt;BEGINNORMALSTEPS+4 &amp;&amp; pp[PRAD0]&lt;10.0*<a class="code" href="../../d8/d5b/defs_8general_8h.html#a5bd9da451f108352614cbc457524c5b0">ERADLIMIT</a> &amp;&amp; ppbackup[PRAD0]&gt;10.0*<a class="code" href="../../d8/d5b/defs_8general_8h.html#a5bd9da451f108352614cbc457524c5b0">ERADLIMIT</a>){</div>
<div class="line"><a name="l01929"></a><span class="lineno"> 1929</span>&#160;      <span class="comment">// then can play with Erf in case negative E_r to avoid bad NR due to floor on Erf.</span></div>
<div class="line"><a name="l01930"></a><span class="lineno"> 1930</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) <span class="keywordflow">if</span>(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a43791f6c1915cf7bfe3a02a4502510e4">RADFULLPL</a>(pl)) pp[pl]=ppbackup[pl]; <span class="comment">// only concern is error might coincidentally be small</span></div>
<div class="line"><a name="l01931"></a><span class="lineno"> 1931</span>&#160;      dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;Caught\n&quot;</span>);</div>
<div class="line"><a name="l01932"></a><span class="lineno"> 1932</span>&#160;    }</div>
<div class="line"><a name="l01933"></a><span class="lineno"> 1933</span>&#160;    <span class="keywordflow">if</span>(myid==8){</div>
<div class="line"><a name="l01934"></a><span class="lineno"> 1934</span>&#160;      dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;bob: iter=%d (%d) %g %g (%g)\n&quot;</span>,iter,mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#a95212a0a740e95e0e2cc94cc9f4d0f7d">BEGINNORMALSTEPS</a>+4,pp[PRAD0],ppbackup[PRAD0],10.0*<a class="code" href="../../d8/d5b/defs_8general_8h.html#a5bd9da451f108352614cbc457524c5b0">ERADLIMIT</a>);</div>
<div class="line"><a name="l01935"></a><span class="lineno"> 1935</span>&#160;    }</div>
<div class="line"><a name="l01936"></a><span class="lineno"> 1936</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01937"></a><span class="lineno"> 1937</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01938"></a><span class="lineno"> 1938</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01939"></a><span class="lineno"> 1939</span>&#160;    <span class="comment">// 9) Get consistent RAD state</span></div>
<div class="line"><a name="l01940"></a><span class="lineno"> 1940</span>&#160;    <span class="comment">// only changes radiation state, not fluid state, but keeps old q&#39;s for fluid state for next step.</span></div>
<div class="line"><a name="l01941"></a><span class="lineno"> 1941</span>&#160;    <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a07847bede2b7ba9d0aabaea82f17f989" title="find ucon, ucov, bcon, bcov from primitive variables when calling get_state, users of this function e...">get_state_radonly</a>(pp, ptrgeom, q);</div>
<div class="line"><a name="l01942"></a><span class="lineno"> 1942</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01943"></a><span class="lineno"> 1943</span>&#160;    <span class="comment">// fix-up primitives to avoid violent steps in temperature</span></div>
<div class="line"><a name="l01944"></a><span class="lineno"> 1944</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01945"></a><span class="lineno"> 1945</span>&#160;    <span class="comment">// 10) Get new uu[RAD] since original uu[RAD]-&gt;pp[RAD] might have had fixups applied and then uu[RAD] no longer consistent.</span></div>
<div class="line"><a name="l01946"></a><span class="lineno"> 1946</span>&#160;    <span class="comment">// This violates total energy conservation in favor of consistency of radiative quantities between pp and uu</span></div>
<div class="line"><a name="l01947"></a><span class="lineno"> 1947</span>&#160;    <span class="comment">//    primtoU(UNOTHING,pp,q,ptrgeom, uu, uuabs);</span></div>
<div class="line"><a name="l01948"></a><span class="lineno"> 1948</span>&#160;    <span class="keyword">extern</span> <span class="keywordtype">int</span> <a class="code" href="../../d7/def/phys_8tools_8c.html#a764e6f682011d16faec0f9b71eb360d2">primtoflux_radonly</a>(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *q, <span class="keywordtype">int</span> dir, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *geom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *flux, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *fluxabs);</div>
<div class="line"><a name="l01949"></a><span class="lineno"> 1949</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> uurad[NPR],uuradabs[NPR];</div>
<div class="line"><a name="l01950"></a><span class="lineno"> 1950</span>&#160;    <a class="code" href="../../d7/def/phys_8tools_8c.html#a764e6f682011d16faec0f9b71eb360d2">primtoflux_radonly</a>(pp,q,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>,ptrgeom, uurad,uuradabs); <span class="comment">// all non-rad stuff is set to zero.</span></div>
<div class="line"><a name="l01951"></a><span class="lineno"> 1951</span>&#160;    <span class="comment">// write new uurad&#39;s to uu</span></div>
<div class="line"><a name="l01952"></a><span class="lineno"> 1952</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) <span class="keywordflow">if</span>(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a43791f6c1915cf7bfe3a02a4502510e4">RADFULLPL</a>(pl)) uu[pl]=uurad[pl];</div>
<div class="line"><a name="l01953"></a><span class="lineno"> 1953</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) <span class="keywordflow">if</span>(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a43791f6c1915cf7bfe3a02a4502510e4">RADFULLPL</a>(pl)) uuabs[pl]=uuradabs[pl];</div>
<div class="line"><a name="l01954"></a><span class="lineno"> 1954</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01955"></a><span class="lineno"> 1955</span>&#160;    <span class="comment">// 11) Recover actual iterated pmhd to avoid machine related differences between original pp and pp(U(pp)) for pmhd quantities</span></div>
<div class="line"><a name="l01956"></a><span class="lineno"> 1956</span>&#160;    <span class="comment">// This assumes that iterated pmhd is optimal and not modified except by iteration by Newton step, which is currently true.</span></div>
<div class="line"><a name="l01957"></a><span class="lineno"> 1957</span>&#160;    <span class="comment">// This gives machine error priority to mhd primitives rather than mhd U&#39;s.</span></div>
<div class="line"><a name="l01958"></a><span class="lineno"> 1958</span>&#160;    <span class="comment">// below not necessary since don&#39;t overwrite pp[non-rad]</span></div>
<div class="line"><a name="l01959"></a><span class="lineno"> 1959</span>&#160;    <span class="comment">//PLOOP(pliter,pl) if(!RADFULLPL(pl)) pp[pl]=pporig[pl];</span></div>
<div class="line"><a name="l01960"></a><span class="lineno"> 1960</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01961"></a><span class="lineno"> 1961</span>&#160;    <span class="comment">// 12) overwrite any setting of uu[B1,B2,B3], so machine accurate field</span></div>
<div class="line"><a name="l01962"></a><span class="lineno"> 1962</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a9afde1f1647e18e733406a1566b8b550">PLOOPBONLY</a>(pl) uu[pl]=pp[pl];</div>
<div class="line"><a name="l01963"></a><span class="lineno"> 1963</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01964"></a><span class="lineno"> 1964</span>&#160;    <span class="comment">// now have full primitives (pp) and full U (uu) including entropy and these (pp and uu) are fully consistent with each other.</span></div>
<div class="line"><a name="l01965"></a><span class="lineno"> 1965</span>&#160;</div>
<div class="line"><a name="l01966"></a><span class="lineno"> 1966</span>&#160;</div>
<div class="line"><a name="l01967"></a><span class="lineno"> 1967</span>&#160;    <span class="keyword">extern</span> <span class="keywordtype">int</span> <a class="code" href="../../d1/d3e/utoprimgen_8c.html#a1118806d01e553c38ae5cf5f036f9f2e" title="perform U-&gt;p inversion on advected scalars">invert_scalars2</a>(<span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ugeomfree, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *q, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr);</div>
<div class="line"><a name="l01968"></a><span class="lineno"> 1968</span>&#160;    <a class="code" href="../../d1/d3e/utoprimgen_8c.html#a1118806d01e553c38ae5cf5f036f9f2e" title="perform U-&gt;p inversion on advected scalars">invert_scalars2</a>(ptrgeom, uu,q,pp);</div>
<div class="line"><a name="l01969"></a><span class="lineno"> 1969</span>&#160;</div>
<div class="line"><a name="l01970"></a><span class="lineno"> 1970</span>&#160;</div>
<div class="line"><a name="l01971"></a><span class="lineno"> 1971</span>&#160;    <span class="comment">// 13)</span></div>
<div class="line"><a name="l01972"></a><span class="lineno"> 1972</span>&#160;    <span class="comment">// set alternative that doesn&#39;t keep any changes to iterated quantities</span></div>
<div class="line"><a name="l01973"></a><span class="lineno"> 1973</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) ppalt[pl] = pp[pl];</div>
<div class="line"><a name="l01974"></a><span class="lineno"> 1974</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(iv) ppalt[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[iv]] = ppbackup[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[iv]];</div>
<div class="line"><a name="l01975"></a><span class="lineno"> 1975</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) uualt[pl] = uu[pl];</div>
<div class="line"><a name="l01976"></a><span class="lineno"> 1976</span>&#160;</div>
<div class="line"><a name="l01977"></a><span class="lineno"> 1977</span>&#160;  }</div>
<div class="line"><a name="l01978"></a><span class="lineno"> 1978</span>&#160;</div>
<div class="line"><a name="l01979"></a><span class="lineno"> 1979</span>&#160;</div>
<div class="line"><a name="l01980"></a><span class="lineno"> 1980</span>&#160;</div>
<div class="line"><a name="l01982"></a><span class="lineno"> 1982</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01983"></a><span class="lineno"> 1983</span>&#160;  <span class="comment">// PRAD</span></div>
<div class="line"><a name="l01984"></a><span class="lineno"> 1984</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01986"></a><span class="lineno"> 1986</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01987"></a><span class="lineno"> 1987</span>&#160;</div>
<div class="line"><a name="l01988"></a><span class="lineno"> 1988</span>&#160;</div>
<div class="line"><a name="l01989"></a><span class="lineno"> 1989</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#add9bc1d07725fe2851182eccaa8eb385">QTYPRAD</a> || mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>==QTYPRADENERGYONLY || mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>==QTYPRADMOMONLY){</div>
<div class="line"><a name="l01990"></a><span class="lineno"> 1990</span>&#160;    <span class="comment">// 0.5) trivially invert field</span></div>
<div class="line"><a name="l01991"></a><span class="lineno"> 1991</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a9afde1f1647e18e733406a1566b8b550">PLOOPBONLY</a>(pl) pp[pl] = uu0[pl];</div>
<div class="line"><a name="l01992"></a><span class="lineno"> 1992</span>&#160;    <span class="comment">// Have prad={Erf,uradvel1,uradvel2,uradvel3}</span></div>
<div class="line"><a name="l01993"></a><span class="lineno"> 1993</span>&#160;    <span class="comment">// 1) get state (rad state needed for mhd_calc_rad, while old mhd state needed to estimate uu[ENTROPY] below)</span></div>
<div class="line"><a name="l01994"></a><span class="lineno"> 1994</span>&#160;    <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a11e17cd8b0594d1ad52e3594aa9f477e" title="find ucon, ucov, bcon, bcov from primitive variables when calling get_state, users of this function e...">get_state</a>(pp, ptrgeom, q);</div>
<div class="line"><a name="l01995"></a><span class="lineno"> 1995</span>&#160;    <span class="comment">// 2) Compute Urad[prad0,uradcon,uradcov] [also computes old Umhd and old Uentropy, but not used]</span></div>
<div class="line"><a name="l01996"></a><span class="lineno"> 1996</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> uurad[NPR],uuradabs[NPR];</div>
<div class="line"><a name="l01997"></a><span class="lineno"> 1997</span>&#160;    <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a9a54096e4c40a15a2c1bf74266153616" title="calculate &quot;conserved&quot; quantities">primtoU</a>(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab2be21bd5eff40ca89c20eeecbeab5e0">UNOTHING</a>,pp,q,ptrgeom, uurad, uuradabs);</div>
<div class="line"><a name="l01998"></a><span class="lineno"> 1998</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) <span class="keywordflow">if</span>(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a43791f6c1915cf7bfe3a02a4502510e4">RADFULLPL</a>(pl)){</div>
<div class="line"><a name="l01999"></a><span class="lineno"> 1999</span>&#160;      uu[pl]=uurad[pl];</div>
<div class="line"><a name="l02000"></a><span class="lineno"> 2000</span>&#160;      uuabs[pl]=uuradabs[pl];</div>
<div class="line"><a name="l02001"></a><span class="lineno"> 2001</span>&#160;    }</div>
<div class="line"><a name="l02002"></a><span class="lineno"> 2002</span>&#160;    <span class="comment">// 3) Get actual Umhd(G) via energy conservation:</span></div>
<div class="line"><a name="l02003"></a><span class="lineno"> 2003</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Gddt[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>]; <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(iv) Gddt[iv]=(uu[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[iv]]-uu0[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[iv]]);</div>
<div class="line"><a name="l02004"></a><span class="lineno"> 2004</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(iv) uu[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#a841d43603fddda5fbcbc03d6b2f544de">iotherU</a>[iv]] = uu0[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#a841d43603fddda5fbcbc03d6b2f544de">iotherU</a>[iv]] - Gddt[iv];</div>
<div class="line"><a name="l02005"></a><span class="lineno"> 2005</span>&#160;    <span class="comment">// uu0[RHO] doesn&#39;t change</span></div>
<div class="line"><a name="l02006"></a><span class="lineno"> 2006</span>&#160;    <span class="comment">// 4) Estimate U[ENTROPY](G) using old rho,u</span></div>
<div class="line"><a name="l02007"></a><span class="lineno"> 2007</span>&#160;    <span class="comment">// UNSURE what to do, since blows up either way:</span></div>
<div class="line"><a name="l02008"></a><span class="lineno"> 2008</span>&#160;    <span class="comment">//    FTYPE GS=0.0; DLOOPA(iv) GS += (-q-&gt;ucon[iv]*(ru-&gt;signgd2)*( (ru-&gt;signgd7)*Gddt[iv]))/(Tgaslocal+TEMPMIN); // more accurate than just using entropy from pp and ucon[TT] from state from pp.</span></div>
<div class="line"><a name="l02009"></a><span class="lineno"> 2009</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> GS=0.0;</div>
<div class="line"><a name="l02010"></a><span class="lineno"> 2010</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Tgaslocal=0.0,Tradlocal=0.0;</div>
<div class="line"><a name="l02011"></a><span class="lineno"> 2011</span>&#160;    <span class="keywordflow">if</span>(0){</div>
<div class="line"><a name="l02012"></a><span class="lineno"> 2012</span>&#160;      Tgaslocal=compute_temp_simple(ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,ptrgeom-&gt;p,pp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>],pp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]);</div>
<div class="line"><a name="l02013"></a><span class="lineno"> 2013</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(iv) GS += (-q-&gt;<a class="code" href="../../d1/d83/structof__state.html#aab723d3c7c2c48b7246cc7d7d5379eed">ucon</a>[iv]*(ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aced783637d9ae9182ae10b44fcbac284">signgd2</a>)*( (ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#ac1d5c40ee4d532cac343c1792e17c076">signgd7</a>)*Gddt[iv]))/(Tgaslocal+<a class="code" href="../../da/d04/global_8depmnemonics_8rad_8h.html#a213757d7585988f6c552da30cc6fcc39">TEMPMIN</a>); <span class="comment">// more accurate than just using entropy from pp and ucon[TT] from state from pp.</span></div>
<div class="line"><a name="l02014"></a><span class="lineno"> 2014</span>&#160;    }</div>
<div class="line"><a name="l02015"></a><span class="lineno"> 2015</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l02016"></a><span class="lineno"> 2016</span>&#160;      <span class="comment">// Get GS completely consisent with primitives, in case using entropy error function, because then shouldn&#39;t use Gddt[TT] related to energy equation.</span></div>
<div class="line"><a name="l02017"></a><span class="lineno"> 2017</span>&#160;      <span class="comment">// Below rad inv may not be completely necessary, but not too expensive, so ok.</span></div>
<div class="line"><a name="l02018"></a><span class="lineno"> 2018</span>&#160;      <span class="keywordtype">int</span> computestate=0; <span class="comment">// already computed above</span></div>
<div class="line"><a name="l02019"></a><span class="lineno"> 2019</span>&#160;      <span class="keywordtype">int</span> computeentropy=1;</div>
<div class="line"><a name="l02020"></a><span class="lineno"> 2020</span>&#160;      <a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#a0a9afe086334630c217cca3b3dbf7f7d" title="get 4-force for all pl&#39;s">koral_source_rad_calc</a>(computestate,computeentropy,pp, ptrgeom, Gdpl, Gdplabs, NULL, &amp;Tgaslocal, &amp;Tradlocal, q);</div>
<div class="line"><a name="l02021"></a><span class="lineno"> 2021</span>&#160;      GS = - (ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#a987d9cab27e21984bd25b825e523058e">signgd4</a>) * localdt * Gdpl[ENTROPY]/(ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#a156b044c75cffc015e7228257f9924b5">signgd6</a>); <span class="comment">// so uu = uu0 + signgd6*GS is consistent with how Gdpl included in error function later.</span></div>
<div class="line"><a name="l02022"></a><span class="lineno"> 2022</span>&#160;    }</div>
<div class="line"><a name="l02023"></a><span class="lineno"> 2023</span>&#160;    uu[ENTROPY] = uu0[ENTROPY] + (ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#a156b044c75cffc015e7228257f9924b5">signgd6</a>)*GS;</div>
<div class="line"><a name="l02024"></a><span class="lineno"> 2024</span>&#160;    <span class="comment">// 5) Invert to get pmhd (also does rad inversion, but not expensive so ok)</span></div>
<div class="line"><a name="l02025"></a><span class="lineno"> 2025</span>&#160;    <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a0a4c88ebd712c11eee70dda4d75288cf">setgasinversionstuff</a>(iter,whichcall,impeps,*errorabs,convabs,maxiter,&amp;newtonstats,&amp;checkoninversiongas,&amp;checkoninversionrad);</div>
<div class="line"><a name="l02026"></a><span class="lineno"> 2026</span>&#160;    <span class="keywordtype">int</span> doradonly=0; failreturn=Utoprimgen_failwrapper(doradonly,radinvmod,showmessages,checkoninversiongas,checkoninversionrad,allowlocalfailurefixandnoreport, finalstep, eomtype, whichcap, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7d1dc231c422450f87fdb3e71b4a7aff" title="defines how Utoprimgen is used">EVOLVEUTOPRIM</a>, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab2be21bd5eff40ca89c20eeecbeab5e0">UNOTHING</a>, uu, q, ptrgeom, dissmeasure, pp, &amp;newtonstats);</div>
<div class="line"><a name="l02027"></a><span class="lineno"> 2027</span>&#160;    *nummhdinvsreturn++;</div>
<div class="line"><a name="l02028"></a><span class="lineno"> 2028</span>&#160;    radinvmodalt=*radinvmod; <span class="comment">// default</span></div>
<div class="line"><a name="l02029"></a><span class="lineno"> 2029</span>&#160;    failreturnalt=failreturn; <span class="comment">// default</span></div>
<div class="line"><a name="l02030"></a><span class="lineno"> 2030</span>&#160;    <span class="keywordflow">if</span>(*eomtype==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a757ad8b9c2c7611dad8aab853a87f61b">EOMCOLDGRMHD</a>){<span class="comment">// restore uu because this inversion assumes u=0 and sets u=0, but if cold valid then ok to keep u~0 and constant as long as fixups applied.</span></div>
<div class="line"><a name="l02031"></a><span class="lineno"> 2031</span>&#160;      pp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]=ppbackup[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>];</div>
<div class="line"><a name="l02032"></a><span class="lineno"> 2032</span>&#160;      <span class="keywordflow">if</span>(ENTROPY&gt;=0) pp[ENTROPY]=pp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>];</div>
<div class="line"><a name="l02033"></a><span class="lineno"> 2033</span>&#160;    }</div>
<div class="line"><a name="l02034"></a><span class="lineno"> 2034</span>&#160;    <span class="comment">// KORALTODO: now can check if actually did eomtype==EOMGRMHD or EOMENTROPYGRMHD or EOMCOLDGRMHD and apply correct error function</span></div>
<div class="line"><a name="l02035"></a><span class="lineno"> 2035</span>&#160;    <span class="comment">// 6) Recover actual iterated prad to avoid machine related differences between original pp and pp(U(pp)) for prad quantities</span></div>
<div class="line"><a name="l02036"></a><span class="lineno"> 2036</span>&#160;    <span class="comment">// This assumes that iterated prad is optimal and not modified except by iteration by Newton step</span></div>
<div class="line"><a name="l02037"></a><span class="lineno"> 2037</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) <span class="keywordflow">if</span>(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a43791f6c1915cf7bfe3a02a4502510e4">RADFULLPL</a>(pl)) pp[pl]=ppbackup[pl];</div>
<div class="line"><a name="l02038"></a><span class="lineno"> 2038</span>&#160;    <span class="comment">// 7) Get consistent Urad [also computes Umhd and Uentropy, which is ok]</span></div>
<div class="line"><a name="l02039"></a><span class="lineno"> 2039</span>&#160;    <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a11e17cd8b0594d1ad52e3594aa9f477e" title="find ucon, ucov, bcon, bcov from primitive variables when calling get_state, users of this function e...">get_state</a>(pp, ptrgeom, q);</div>
<div class="line"><a name="l02040"></a><span class="lineno"> 2040</span>&#160;    <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a9a54096e4c40a15a2c1bf74266153616" title="calculate &quot;conserved&quot; quantities">primtoU</a>(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab2be21bd5eff40ca89c20eeecbeab5e0">UNOTHING</a>,pp,q,ptrgeom, uu, uuabs);</div>
<div class="line"><a name="l02041"></a><span class="lineno"> 2041</span>&#160;    <span class="comment">// 8) overwrite any setting of uu[B1,B2,B3], so machine accurate field</span></div>
<div class="line"><a name="l02042"></a><span class="lineno"> 2042</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a9afde1f1647e18e733406a1566b8b550">PLOOPBONLY</a>(pl) uu[pl]=pp[pl];</div>
<div class="line"><a name="l02043"></a><span class="lineno"> 2043</span>&#160;    <span class="comment">// now have full primitives and full U including entropy and these are consistent with each other.</span></div>
<div class="line"><a name="l02044"></a><span class="lineno"> 2044</span>&#160;    <span class="comment">// 9) </span></div>
<div class="line"><a name="l02045"></a><span class="lineno"> 2045</span>&#160;    <span class="comment">// set alternative that doesn&#39;t keep any changes to iterated quantities</span></div>
<div class="line"><a name="l02046"></a><span class="lineno"> 2046</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) ppalt[pl] = pp[pl];</div>
<div class="line"><a name="l02047"></a><span class="lineno"> 2047</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(iv) ppalt[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[iv]] = ppbackup[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[iv]];</div>
<div class="line"><a name="l02048"></a><span class="lineno"> 2048</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) uualt[pl] = uu[pl];</div>
<div class="line"><a name="l02049"></a><span class="lineno"> 2049</span>&#160;  }</div>
<div class="line"><a name="l02050"></a><span class="lineno"> 2050</span>&#160;</div>
<div class="line"><a name="l02051"></a><span class="lineno"> 2051</span>&#160;</div>
<div class="line"><a name="l02052"></a><span class="lineno"> 2052</span>&#160;</div>
<div class="line"><a name="l02053"></a><span class="lineno"> 2053</span>&#160;</div>
<div class="line"><a name="l02054"></a><span class="lineno"> 2054</span>&#160;</div>
<div class="line"><a name="l02055"></a><span class="lineno"> 2055</span>&#160;</div>
<div class="line"><a name="l02056"></a><span class="lineno"> 2056</span>&#160;</div>
<div class="line"><a name="l02057"></a><span class="lineno"> 2057</span>&#160;</div>
<div class="line"><a name="l02058"></a><span class="lineno"> 2058</span>&#160;<span class="preprocessor">#if(MODEMETHOD==MODEENERGY ||MODEMETHOD==MODEENTROPY ||MODEMETHOD==MODESWITCH) // currently only ones that allow change</span></div>
<div class="line"><a name="l02059"></a><span class="lineno"> 2059</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l02060"></a><span class="lineno"> 2060</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02061"></a><span class="lineno"> 2061</span>&#160;  <span class="comment">// check which baseitermethod we should really be using based upon any inversions done above</span></div>
<div class="line"><a name="l02062"></a><span class="lineno"> 2062</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02064"></a><span class="lineno"> 2064</span>&#160;<span class="comment"></span>  <span class="comment">// only check if not in Jacobian or final check</span></div>
<div class="line"><a name="l02065"></a><span class="lineno"> 2065</span>&#160;  <span class="keywordflow">if</span>(allowbaseitermethodswitch &amp;&amp; whichcall==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a439b24ca8b87220703a1f950242344b7" title="f_implicit() call types">FIMPLICITCALLTYPEF1</a>){<span class="comment">//FIMPLICITCALLTYPEJAC</span></div>
<div class="line"><a name="l02066"></a><span class="lineno"> 2066</span>&#160;</div>
<div class="line"><a name="l02067"></a><span class="lineno"> 2067</span>&#160;    <span class="keywordtype">int</span> doswitchbaseitermethod=0;</div>
<div class="line"><a name="l02068"></a><span class="lineno"> 2068</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> rdU[NPR];</div>
<div class="line"><a name="l02069"></a><span class="lineno"> 2069</span>&#160;    <span class="comment">//  PLOOP(pliter,pl) rdU[pl]=Gallabs[pl]/uuallabs[pl];</span></div>
<div class="line"><a name="l02070"></a><span class="lineno"> 2070</span>&#160;    <span class="comment">// Note that we use uu-uu0 since that&#39;s exactly what&#39;s pushed into other non-iterated set of equations.</span></div>
<div class="line"><a name="l02071"></a><span class="lineno"> 2071</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> uuallabs1;</div>
<div class="line"><a name="l02072"></a><span class="lineno"> 2072</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l02073"></a><span class="lineno"> 2073</span>&#160;      uuallabs1 = <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a987db2b5d50589e097378a13c5d87fef">THIRD</a>*(fabs(uuabs[pl]) + fabs(uu[pl]) + fabs(uu0[pl]));</div>
<div class="line"><a name="l02074"></a><span class="lineno"> 2074</span>&#160;      rdU[pl]=(uu[pl]-uu0[pl])/uuallabs1;</div>
<div class="line"><a name="l02075"></a><span class="lineno"> 2075</span>&#160;    }</div>
<div class="line"><a name="l02076"></a><span class="lineno"> 2076</span>&#160;    <span class="comment">// if dU[UU] changes relatively near machine precision, then could be fake change induced by machine precision errors.  Then actual real evolution of URAD? would be destroyed by those machine errors.</span></div>
<div class="line"><a name="l02077"></a><span class="lineno"> 2077</span>&#160;    <span class="comment">// For iter=1, using initial guess&#39;s uu.  But by second iteration, have used Jacobian to move iterates.  If dU[UU]/U[UU] near machine precision but dU[URAD0]/U[URAD0] far from it, then should use radiation iterate.</span></div>
<div class="line"><a name="l02078"></a><span class="lineno"> 2078</span>&#160;    <span class="keywordflow">if</span>(iter&gt;1){</div>
<div class="line"><a name="l02079"></a><span class="lineno"> 2079</span>&#160;      <span class="keywordflow">if</span>(rdU[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]&lt;rdU[URAD0] &amp;&amp; <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a33425cd25de3bba0ed1613fd419efefd" title="MHD or RAD baseitermethod types.">IMPMHDTYPEBASE</a>(*baseitermethod)==1){</div>
<div class="line"><a name="l02080"></a><span class="lineno"> 2080</span>&#160;        <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a7df8286c59d491ba1117884d33499a7a">prod0dualfprintf</a>(debugfail&gt;=3,<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;Should switch base to QTYURAD or QTYPRAD\n&quot;</span>);</div>
<div class="line"><a name="l02081"></a><span class="lineno"> 2081</span>&#160;      }</div>
<div class="line"><a name="l02082"></a><span class="lineno"> 2082</span>&#160;      <span class="keywordflow">if</span>(rdU[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]&gt;rdU[URAD0] &amp;&amp; (*baseitermethod==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad919bedc37c48678c11e7e45cd1394cf">QTYURAD</a>||*baseitermethod==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#add9bc1d07725fe2851182eccaa8eb385">QTYPRAD</a>)){</div>
<div class="line"><a name="l02083"></a><span class="lineno"> 2083</span>&#160;        <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a7df8286c59d491ba1117884d33499a7a">prod0dualfprintf</a>(debugfail&gt;=3,<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;Should switch base to QTYPMHD\n&quot;</span>);</div>
<div class="line"><a name="l02084"></a><span class="lineno"> 2084</span>&#160;      }</div>
<div class="line"><a name="l02085"></a><span class="lineno"> 2085</span>&#160;    }</div>
<div class="line"><a name="l02086"></a><span class="lineno"> 2086</span>&#160;    <span class="keywordflow">if</span>(pp[URAD0]&lt;10.0*<a class="code" href="../../d8/d5b/defs_8general_8h.html#a5bd9da451f108352614cbc457524c5b0">ERADLIMIT</a> &amp;&amp; <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a33425cd25de3bba0ed1613fd419efefd" title="MHD or RAD baseitermethod types.">IMPMHDTYPEBASE</a>(*baseitermethod)==1){</div>
<div class="line"><a name="l02087"></a><span class="lineno"> 2087</span>&#160;      <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a7df8286c59d491ba1117884d33499a7a">prod0dualfprintf</a>(debugfail&gt;=3,<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;Should switch base to QTYURAD or QTYPRAD: Erf=%21.15g&lt;10*%21.15g baseitermethod=%d\n&quot;</span>,pp[URAD0],<a class="code" href="../../d8/d5b/defs_8general_8h.html#a5bd9da451f108352614cbc457524c5b0">ERADLIMIT</a>,*baseitermethod);</div>
<div class="line"><a name="l02088"></a><span class="lineno"> 2088</span>&#160;      <span class="keywordflow">if</span>(1){</div>
<div class="line"><a name="l02089"></a><span class="lineno"> 2089</span>&#160;        <span class="comment">// then Erf dropped-out.  Probably because using QTYPMHD and too big change</span></div>
<div class="line"><a name="l02090"></a><span class="lineno"> 2090</span>&#160;        *baseitermethod=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#add9bc1d07725fe2851182eccaa8eb385">QTYPRAD</a>; <span class="comment">// prad safest and fastest</span></div>
<div class="line"><a name="l02091"></a><span class="lineno"> 2091</span>&#160;        <span class="comment">//*baseitermethod=QTYURAD; // URAD somehow more robust (e.g. on RADTUBE PRAD methods fails a few times if switched from QTYPMHD, but fails more if used directly!)</span></div>
<div class="line"><a name="l02092"></a><span class="lineno"> 2092</span>&#160;        doswitchbaseitermethod=1;</div>
<div class="line"><a name="l02093"></a><span class="lineno"> 2093</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l02094"></a><span class="lineno"> 2094</span>&#160;          pp[pl] = ppprev[pl]; <span class="comment">// revert primitives from old primitive iteration to new primitive iteration</span></div>
<div class="line"><a name="l02095"></a><span class="lineno"> 2095</span>&#160;          uu[pl] = uuprev[pl]; <span class="comment">// start with previous uu&#39;s before any pp-&gt;uu calculations</span></div>
<div class="line"><a name="l02096"></a><span class="lineno"> 2096</span>&#160;        }</div>
<div class="line"><a name="l02097"></a><span class="lineno"> 2097</span>&#160;        <span class="comment">// get state since not synched with q necessarily</span></div>
<div class="line"><a name="l02098"></a><span class="lineno"> 2098</span>&#160;        <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a11e17cd8b0594d1ad52e3594aa9f477e" title="find ucon, ucov, bcon, bcov from primitive variables when calling get_state, users of this function e...">get_state</a>(pp, ptrgeom, q);</div>
<div class="line"><a name="l02099"></a><span class="lineno"> 2099</span>&#160;        <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a9a54096e4c40a15a2c1bf74266153616" title="calculate &quot;conserved&quot; quantities">primtoU</a>(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab2be21bd5eff40ca89c20eeecbeab5e0">UNOTHING</a>,pp,q,ptrgeom, uu, uuabs);</div>
<div class="line"><a name="l02100"></a><span class="lineno"> 2100</span>&#160;        <span class="comment">//*q=qbackup; // revert to q before any pp-&gt;q calculations</span></div>
<div class="line"><a name="l02101"></a><span class="lineno"> 2101</span>&#160;        *radinvmod=radinvmodbackup; <span class="comment">// revert to previous radinvmod</span></div>
<div class="line"><a name="l02102"></a><span class="lineno"> 2102</span>&#160;      }</div>
<div class="line"><a name="l02103"></a><span class="lineno"> 2103</span>&#160;      <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l02104"></a><span class="lineno"> 2104</span>&#160;        <span class="comment">// problem with switching for RADTUBE, so just report if want.  If had backup method that was radiation iterate, then might want to break, but not always as QTYPMHD method can recover.  So just stick with normal backup procedure...?</span></div>
<div class="line"><a name="l02105"></a><span class="lineno"> 2105</span>&#160;      }</div>
<div class="line"><a name="l02106"></a><span class="lineno"> 2106</span>&#160;    }</div>
<div class="line"><a name="l02107"></a><span class="lineno"> 2107</span>&#160;    <span class="keywordflow">if</span>(pp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]&lt;10.0*<a class="code" href="../../d8/d5b/defs_8general_8h.html#a13f615d7832e3abc6abd54325112daf3">UUMINLIMIT</a> &amp;&amp;  (*baseitermethod==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad919bedc37c48678c11e7e45cd1394cf">QTYURAD</a>||*baseitermethod==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#add9bc1d07725fe2851182eccaa8eb385">QTYPRAD</a>)){</div>
<div class="line"><a name="l02108"></a><span class="lineno"> 2108</span>&#160;      <span class="comment">// Then u_g dropped-out.  Probably because iteration radiation quantity</span></div>
<div class="line"><a name="l02109"></a><span class="lineno"> 2109</span>&#160;      <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a7df8286c59d491ba1117884d33499a7a">prod0dualfprintf</a>(debugfail&gt;=3,<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;Should switch base to QTYMHD: ug=%21.15g\n&quot;</span>,pp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]);</div>
<div class="line"><a name="l02110"></a><span class="lineno"> 2110</span>&#160;    }</div>
<div class="line"><a name="l02111"></a><span class="lineno"> 2111</span>&#160;</div>
<div class="line"><a name="l02112"></a><span class="lineno"> 2112</span>&#160;    <span class="keywordflow">if</span>(doswitchbaseitermethod){</div>
<div class="line"><a name="l02113"></a><span class="lineno"> 2113</span>&#160;      <span class="comment">// in case required, change settings</span></div>
<div class="line"><a name="l02114"></a><span class="lineno"> 2114</span>&#160;      define_method(iter, eomtype, itermode, *baseitermethod, fracenergy, dissmeasure, &amp;mtd);</div>
<div class="line"><a name="l02115"></a><span class="lineno"> 2115</span>&#160;      get_refUs(&amp;mtd, &amp;ru);</div>
<div class="line"><a name="l02116"></a><span class="lineno"> 2116</span>&#160;    }</div>
<div class="line"><a name="l02117"></a><span class="lineno"> 2117</span>&#160;  }</div>
<div class="line"><a name="l02118"></a><span class="lineno"> 2118</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02119"></a><span class="lineno"> 2119</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l02120"></a><span class="lineno"> 2120</span>&#160;</div>
<div class="line"><a name="l02121"></a><span class="lineno"> 2121</span>&#160;</div>
<div class="line"><a name="l02122"></a><span class="lineno"> 2122</span>&#160;</div>
<div class="line"><a name="l02123"></a><span class="lineno"> 2123</span>&#160;</div>
<div class="line"><a name="l02124"></a><span class="lineno"> 2124</span>&#160;</div>
<div class="line"><a name="l02126"></a><span class="lineno"> 2126</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02127"></a><span class="lineno"> 2127</span>&#160;  <span class="comment">// At this point, must have pp, uu, uuabs, and q all consistent and defined</span></div>
<div class="line"><a name="l02128"></a><span class="lineno"> 2128</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02130"></a><span class="lineno"> 2130</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02131"></a><span class="lineno"> 2131</span>&#160;</div>
<div class="line"><a name="l02132"></a><span class="lineno"> 2132</span>&#160;</div>
<div class="line"><a name="l02133"></a><span class="lineno"> 2133</span>&#160;</div>
<div class="line"><a name="l02134"></a><span class="lineno"> 2134</span>&#160;</div>
<div class="line"><a name="l02135"></a><span class="lineno"> 2135</span>&#160;</div>
<div class="line"><a name="l02137"></a><span class="lineno"> 2137</span>&#160;  <span class="comment">// get 4-force for all pl due to radiation as due to pp[uu]</span></div>
<div class="line"><a name="l02139"></a><span class="lineno"> 2139</span>&#160;<span class="comment"></span>  <span class="keywordtype">int</span> computestate=0;<span class="comment">// already computed above</span></div>
<div class="line"><a name="l02140"></a><span class="lineno"> 2140</span>&#160;  <span class="keywordtype">int</span> computeentropy=needentropy;</div>
<div class="line"><a name="l02141"></a><span class="lineno"> 2141</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> chieff;</div>
<div class="line"><a name="l02142"></a><span class="lineno"> 2142</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> tautot,tautotmax;</div>
<div class="line"><a name="l02143"></a><span class="lineno"> 2143</span>&#160;  <a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#a0a9afe086334630c217cca3b3dbf7f7d" title="get 4-force for all pl&#39;s">koral_source_rad_calc</a>(computestate,computeentropy,pp, ptrgeom, Gdpl, Gdplabs, &amp;chieff, &amp;Tgas, &amp;Trad, q);</div>
<div class="line"><a name="l02144"></a><span class="lineno"> 2144</span>&#160;  <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a795959353203e99366b456b16d0d0bab" title="calculates total opacity over dx[] for given chi or chieff">calc_tautot_chieff</a>(pp, chieff, ptrgeom, q, &amp;tautot, &amp;tautotmax);</div>
<div class="line"><a name="l02145"></a><span class="lineno"> 2145</span>&#160;  *tautotmaxreturn=tautotmax;</div>
<div class="line"><a name="l02146"></a><span class="lineno"> 2146</span>&#160;</div>
<div class="line"><a name="l02147"></a><span class="lineno"> 2147</span>&#160;</div>
<div class="line"><a name="l02148"></a><span class="lineno"> 2148</span>&#160;</div>
<div class="line"><a name="l02149"></a><span class="lineno"> 2149</span>&#160;</div>
<div class="line"><a name="l02150"></a><span class="lineno"> 2150</span>&#160;</div>
<div class="line"><a name="l02152"></a><span class="lineno"> 2152</span>&#160;  <span class="comment">// GET ERROR FUNCTION</span></div>
<div class="line"><a name="l02153"></a><span class="lineno"> 2153</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02154"></a><span class="lineno"> 2154</span>&#160;  <span class="comment">// NOTEMARK: Error is normalized by sum of any terms that can be formed separately as an absolute magnitude.  For gas, error *includes* MA+EM but not rest-mass (at least when REMOVERESTMASSFROMUU=2 is set, which is default).  While one might think error should only include MA due to MA&lt;-&gt;RAD force G, the force G affects the full T and changes the (e.g.) EM energy flux by changing the velocity.  So even if RAD only directly affects particles=MA, that MA involves changes in velocity that affects EM as well, so indirectly RAD affects EM.  E.g., it&#39;s possible that MA energy flux doesn&#39;t change at all, but RAD&lt;-&gt;EM conversion occurs.  E.g., just as scattering provides force from gas to radiation, velocity changes provide force between MA and EM.  So keep uu[Ux] full MA+EM in normalization of error.</span></div>
<div class="line"><a name="l02155"></a><span class="lineno"> 2155</span>&#160;  <span class="comment">// NOTEMARK: Of course, possible field is background uniform and strong and has no force role at all, in which case should have just MA in error norm.</span></div>
<div class="line"><a name="l02156"></a><span class="lineno"> 2156</span>&#160;  <span class="comment">// NOTEMARK: But of course, if (say) b^2/rho&gt;&gt;1, then can&#39;t expect to get rho very accurate anyways, so focus on total error so that as b^2/rho gets bigger, error in rho gets worse.  However, error in velocity will still be preserved since those appear as separate error terms (i.e. uu[U1-U3]).</span></div>
<div class="line"><a name="l02157"></a><span class="lineno"> 2157</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02159"></a><span class="lineno"> 2159</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02160"></a><span class="lineno"> 2160</span>&#160;  <span class="comment">// prepare for error or explicit step</span></div>
<div class="line"><a name="l02161"></a><span class="lineno"> 2161</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> <a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a1e471b644e7fd684cd5dbb144e00ee81">sign</a>[NPR];</div>
<div class="line"><a name="l02162"></a><span class="lineno"> 2162</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l02163"></a><span class="lineno"> 2163</span>&#160;    sign[pl]=ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aced783637d9ae9182ae10b44fcbac284">signgd2</a>;</div>
<div class="line"><a name="l02164"></a><span class="lineno"> 2164</span>&#160;  }</div>
<div class="line"><a name="l02165"></a><span class="lineno"> 2165</span>&#160;  <span class="keywordflow">if</span>(ENTROPY&gt;=0){</div>
<div class="line"><a name="l02166"></a><span class="lineno"> 2166</span>&#160;    pl=ENTROPY;</div>
<div class="line"><a name="l02167"></a><span class="lineno"> 2167</span>&#160;    sign[pl]=ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#a987d9cab27e21984bd25b825e523058e">signgd4</a>;</div>
<div class="line"><a name="l02168"></a><span class="lineno"> 2168</span>&#160;  }</div>
<div class="line"><a name="l02169"></a><span class="lineno"> 2169</span>&#160;</div>
<div class="line"><a name="l02170"></a><span class="lineno"> 2170</span>&#160;</div>
<div class="line"><a name="l02171"></a><span class="lineno"> 2171</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> extrafactor[NPR];</div>
<div class="line"><a name="l02172"></a><span class="lineno"> 2172</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l02173"></a><span class="lineno"> 2173</span>&#160;    extrafactor[pl]=1.0;</div>
<div class="line"><a name="l02174"></a><span class="lineno"> 2174</span>&#160;  }</div>
<div class="line"><a name="l02175"></a><span class="lineno"> 2175</span>&#160;  <span class="keywordflow">if</span>(ENTROPY&gt;=0){</div>
<div class="line"><a name="l02176"></a><span class="lineno"> 2176</span>&#160;    pl=ENTROPY;</div>
<div class="line"><a name="l02177"></a><span class="lineno"> 2177</span>&#160;    <span class="comment">// replace original equation with dS*T equation</span></div>
<div class="line"><a name="l02178"></a><span class="lineno"> 2178</span>&#160;    <span class="comment">// error function is T*dS so no actual division by T.  Found in mathematica that this works best in difficult precision cases.</span></div>
<div class="line"><a name="l02179"></a><span class="lineno"> 2179</span>&#160;    extrafactor[pl]=fabs(Tgas)+<a class="code" href="../../da/d04/global_8depmnemonics_8rad_8h.html#a213757d7585988f6c552da30cc6fcc39">TEMPMIN</a>;</div>
<div class="line"><a name="l02180"></a><span class="lineno"> 2180</span>&#160;  }</div>
<div class="line"><a name="l02181"></a><span class="lineno"> 2181</span>&#160;</div>
<div class="line"><a name="l02182"></a><span class="lineno"> 2182</span>&#160;  <span class="comment">// get f, uuallabs, Gallabs, and fnorm</span></div>
<div class="line"><a name="l02183"></a><span class="lineno"> 2183</span>&#160;  <span class="comment">// also get falt that uses (in case iterated) originally iterated value of uu -- instead of post-inversion modified version that would be consistent with primitives.</span></div>
<div class="line"><a name="l02184"></a><span class="lineno"> 2184</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> falt[NPR];</div>
<div class="line"><a name="l02185"></a><span class="lineno"> 2185</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> uuallabs[NPR]={0.0},Gallabs[NPR]={0.0};</div>
<div class="line"><a name="l02186"></a><span class="lineno"> 2186</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02187"></a><span class="lineno"> 2187</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l02188"></a><span class="lineno"> 2188</span>&#160;    f[pl] = ((uu[pl] - uu0[pl]) + (sign[pl] * localdt * Gdpl[pl]))*extrafactor[pl];</div>
<div class="line"><a name="l02189"></a><span class="lineno"> 2189</span>&#160;</div>
<div class="line"><a name="l02190"></a><span class="lineno"> 2190</span>&#160;    falt[pl] = ((uualt[pl] - uu0[pl]) + (sign[pl] * localdt * Gdpl[pl]))*extrafactor[pl];</div>
<div class="line"><a name="l02191"></a><span class="lineno"> 2191</span>&#160;</div>
<div class="line"><a name="l02192"></a><span class="lineno"> 2192</span>&#160;    <span class="comment">// get error normalization that involves actual things being differenced</span></div>
<div class="line"><a name="l02193"></a><span class="lineno"> 2193</span>&#160;    <span class="comment">// KORALNOTE: Use Gdplabs to ensure absolute value over more terms in source in case coincidental cancellation without physical significance.</span></div>
<div class="line"><a name="l02194"></a><span class="lineno"> 2194</span>&#160;    uuallabs[pl] = <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a987db2b5d50589e097378a13c5d87fef">THIRD</a>*(fabs(uuabs[pl]) + fabs(uu[pl]) + fabs(uu0[pl]))*extrafactor[pl];</div>
<div class="line"><a name="l02195"></a><span class="lineno"> 2195</span>&#160;    Gallabs[pl] = fabs(sign[pl] * localdt * Gdplabs[pl])*extrafactor[pl];</div>
<div class="line"><a name="l02196"></a><span class="lineno"> 2196</span>&#160;    fnorm[pl] = uuallabs[pl] + Gallabs[pl];</div>
<div class="line"><a name="l02197"></a><span class="lineno"> 2197</span>&#160;  }</div>
<div class="line"><a name="l02198"></a><span class="lineno"> 2198</span>&#160;</div>
<div class="line"><a name="l02199"></a><span class="lineno"> 2199</span>&#160;</div>
<div class="line"><a name="l02200"></a><span class="lineno"> 2200</span>&#160;</div>
<div class="line"><a name="l02201"></a><span class="lineno"> 2201</span>&#160;  <span class="keywordflow">if</span>(whichcall!=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a195d482ffa46307e2e7ed74f457d5300">FIMPLICITCALLTYPEJAC</a>){</div>
<div class="line"><a name="l02203"></a><span class="lineno"> 2203</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02204"></a><span class="lineno"> 2204</span>&#160;    <span class="comment">// get single number that measures error for iterated quantities</span></div>
<div class="line"><a name="l02205"></a><span class="lineno"> 2205</span>&#160;    <span class="comment">// only do if using error, which don&#39;t for Jacobian</span></div>
<div class="line"><a name="l02206"></a><span class="lineno"> 2206</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02208"></a><span class="lineno"> 2208</span>&#160;<span class="comment"></span>    *convreturn=f_error_check(showmessages, showmessagesheavy, iter, conv, convabs, realdt, dimtypef,*eomtype , *radinvmod, itermode,*baseitermethod,fracenergy,dissmeasure,dimfactU,pp,piin,f,fnorm,freport,Uiin,uu0,uu,ptrgeom,errorabs,errorallabs,whicherror,mtd,ru);</div>
<div class="line"><a name="l02209"></a><span class="lineno"> 2209</span>&#160;  }</div>
<div class="line"><a name="l02210"></a><span class="lineno"> 2210</span>&#160;</div>
<div class="line"><a name="l02211"></a><span class="lineno"> 2211</span>&#160;</div>
<div class="line"><a name="l02212"></a><span class="lineno"> 2212</span>&#160;</div>
<div class="line"><a name="l02213"></a><span class="lineno"> 2213</span>&#160;</div>
<div class="line"><a name="l02214"></a><span class="lineno"> 2214</span>&#160;</div>
<div class="line"><a name="l02215"></a><span class="lineno"> 2215</span>&#160;</div>
<div class="line"><a name="l02216"></a><span class="lineno"> 2216</span>&#160;  <span class="comment">// get fractional change in |R^t_t| as estimate from \tau, as soft backup to Gdplabs</span></div>
<div class="line"><a name="l02217"></a><span class="lineno"> 2217</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ratchangeRtt;</div>
<div class="line"><a name="l02218"></a><span class="lineno"> 2218</span>&#160;  <span class="keywordflow">if</span>(1){</div>
<div class="line"><a name="l02219"></a><span class="lineno"> 2219</span>&#160;    <span class="keywordflow">if</span>(whichcall==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a439b24ca8b87220703a1f950242344b7" title="f_implicit() call types">FIMPLICITCALLTYPEF1</a>){<span class="comment">//FIMPLICITCALLTYPEJAC)</span></div>
<div class="line"><a name="l02220"></a><span class="lineno"> 2220</span>&#160;      <span class="comment">// ratchangeRtt1 covers generic opacity control of G_t vs R^t_t</span></div>
<div class="line"><a name="l02221"></a><span class="lineno"> 2221</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ratchangeRtt1=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ae83fc4364d7c6bc0b717418cd5345297">calc_approx_ratchangeRtt</a>(q, chieff, realdt);</div>
<div class="line"><a name="l02222"></a><span class="lineno"> 2222</span>&#160;</div>
<div class="line"><a name="l02223"></a><span class="lineno"> 2223</span>&#160;      pl=URAD0;</div>
<div class="line"><a name="l02224"></a><span class="lineno"> 2224</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> uuallabsURAD0 = <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a987db2b5d50589e097378a13c5d87fef">THIRD</a>*(fabs(uuabs[pl]) + fabs(uu[pl]) + fabs(uu0[pl]));</div>
<div class="line"><a name="l02225"></a><span class="lineno"> 2225</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ratchangeRtt2=fabs(Gdplabs[pl]*realdt)/uuallabsURAD0;</div>
<div class="line"><a name="l02226"></a><span class="lineno"> 2226</span>&#160;</div>
<div class="line"><a name="l02227"></a><span class="lineno"> 2227</span>&#160;      pl=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>;</div>
<div class="line"><a name="l02228"></a><span class="lineno"> 2228</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> uuallabsUU = <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a987db2b5d50589e097378a13c5d87fef">THIRD</a>*(fabs(uuabs[pl]) + fabs(uu[pl]) + fabs(uu0[pl]));</div>
<div class="line"><a name="l02229"></a><span class="lineno"> 2229</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ratchangeRtt3=fabs(Gdplabs[pl]*realdt)/uuallabsUU;</div>
<div class="line"><a name="l02230"></a><span class="lineno"> 2230</span>&#160;</div>
<div class="line"><a name="l02231"></a><span class="lineno"> 2231</span>&#160;      <span class="comment">// take bigger of change to be most conservative to force most implicit approach</span></div>
<div class="line"><a name="l02232"></a><span class="lineno"> 2232</span>&#160;      ratchangeRtt = <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(ratchangeRtt1,ratchangeRtt2),ratchangeRtt3);</div>
<div class="line"><a name="l02233"></a><span class="lineno"> 2233</span>&#160;</div>
<div class="line"><a name="l02234"></a><span class="lineno"> 2234</span>&#160;      <span class="comment">//      get_dtsub(int method, pp, q, uu0, uu, FTYPE *dUother,  FTYPE *CUf, FTYPE *CUimp, FTYPE *Gdpl, FTYPE chi, FTYPE *Gdplabs, struct of_geom *ptrgeom, FTYPE *dtsub)</span></div>
<div class="line"><a name="l02235"></a><span class="lineno"> 2235</span>&#160;    }</div>
<div class="line"><a name="l02236"></a><span class="lineno"> 2236</span>&#160;  }</div>
<div class="line"><a name="l02237"></a><span class="lineno"> 2237</span>&#160;</div>
<div class="line"><a name="l02238"></a><span class="lineno"> 2238</span>&#160;</div>
<div class="line"><a name="l02239"></a><span class="lineno"> 2239</span>&#160;</div>
<div class="line"><a name="l02240"></a><span class="lineno"> 2240</span>&#160;</div>
<div class="line"><a name="l02241"></a><span class="lineno"> 2241</span>&#160;</div>
<div class="line"><a name="l02242"></a><span class="lineno"> 2242</span>&#160;</div>
<div class="line"><a name="l02243"></a><span class="lineno"> 2243</span>&#160;</div>
<div class="line"><a name="l02244"></a><span class="lineno"> 2244</span>&#160;  <span class="comment">// try doing 1 explicit step when doing first implicit iteration.</span></div>
<div class="line"><a name="l02245"></a><span class="lineno"> 2245</span>&#160;  <span class="comment">// Needed if rho,u&lt;&lt;urad and want to resolve regions that are optically thin like the jet.  Else would have to have overall small error and that woudld be slower.</span></div>
<div class="line"><a name="l02246"></a><span class="lineno"> 2246</span>&#160;  <span class="keywordtype">int</span> didexplicit=0;</div>
<div class="line"><a name="l02247"></a><span class="lineno"> 2247</span>&#160;<span class="preprocessor">#if(TRYFIRSTEXPLICIT)</span></div>
<div class="line"><a name="l02248"></a><span class="lineno"> 2248</span>&#160;<span class="preprocessor"></span>  <span class="keywordflow">if</span>(whichcall==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a439b24ca8b87220703a1f950242344b7" title="f_implicit() call types">FIMPLICITCALLTYPEF1</a>){<span class="comment">//FIMPLICITCALLTYPEJAC)</span></div>
<div class="line"><a name="l02249"></a><span class="lineno"> 2249</span>&#160;</div>
<div class="line"><a name="l02250"></a><span class="lineno"> 2250</span>&#160;    <span class="keywordflow">if</span>(iter==1 &amp;&amp; f1iter==0 &amp;&amp;  (mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9cf5ca7f5e5aa1e0bdef53abe3f27c1c">QTYPMHD</a> || mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8b10ec187cbee196f071e162563cd945">QTYPMHDENERGYONLY</a> || mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad1dda20c101a983834446c5c93791583">QTYPMHDMOMONLY</a>)){ <span class="comment">// GODMARK: Not currently working for other QTY methods like QTYURAD.</span></div>
<div class="line"><a name="l02251"></a><span class="lineno"> 2251</span>&#160;</div>
<div class="line"><a name="l02252"></a><span class="lineno"> 2252</span>&#160;</div>
<div class="line"><a name="l02253"></a><span class="lineno"> 2253</span>&#160;</div>
<div class="line"><a name="l02254"></a><span class="lineno"> 2254</span>&#160;</div>
<div class="line"><a name="l02255"></a><span class="lineno"> 2255</span>&#160;</div>
<div class="line"><a name="l02256"></a><span class="lineno"> 2256</span>&#160;<span class="preprocessor">#if(0)</span></div>
<div class="line"><a name="l02257"></a><span class="lineno"> 2257</span>&#160;<span class="preprocessor"></span>      <span class="comment">// initial</span></div>
<div class="line"><a name="l02258"></a><span class="lineno"> 2258</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Gdpli[NPR]={0.0},Gdplabsi[NPR]={0.0}, Tgasi={0.0},Tradi={0.0};</div>
<div class="line"><a name="l02259"></a><span class="lineno"> 2259</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ppi[NPR],uui[NPR];</div>
<div class="line"><a name="l02260"></a><span class="lineno"> 2260</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> uuabsi[NPR]={0.0};</div>
<div class="line"><a name="l02261"></a><span class="lineno"> 2261</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) uuabsi[pl]=uuabs[pl];</div>
<div class="line"><a name="l02262"></a><span class="lineno"> 2262</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> chieffi=0.0;</div>
<div class="line"><a name="l02263"></a><span class="lineno"> 2263</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> extrafactori[NPR];</div>
<div class="line"><a name="l02264"></a><span class="lineno"> 2264</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fi[NPR]={0.0},fnormi[NPR]={0.0};</div>
<div class="line"><a name="l02265"></a><span class="lineno"> 2265</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> uuallabsi[NPR]={0.0},Gallabsi[NPR]={0.0};</div>
<div class="line"><a name="l02266"></a><span class="lineno"> 2266</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> errorabsi=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>,errorallabsi=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>;</div>
<div class="line"><a name="l02267"></a><span class="lineno"> 2267</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> freporti[NPR];</div>
<div class="line"><a name="l02268"></a><span class="lineno"> 2268</span>&#160;      <span class="keywordtype">int</span> convreturni;</div>
<div class="line"><a name="l02269"></a><span class="lineno"> 2269</span>&#160;      <span class="keywordtype">int</span> didinitial=0;</div>
<div class="line"><a name="l02270"></a><span class="lineno"> 2270</span>&#160;      <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> qi;</div>
<div class="line"><a name="l02271"></a><span class="lineno"> 2271</span>&#160;      qi=*q;</div>
<div class="line"><a name="l02272"></a><span class="lineno"> 2272</span>&#160;        </div>
<div class="line"><a name="l02273"></a><span class="lineno"> 2273</span>&#160;      <span class="keywordflow">if</span>(1){</div>
<div class="line"><a name="l02274"></a><span class="lineno"> 2274</span>&#160;        <span class="comment">// begin</span></div>
<div class="line"><a name="l02275"></a><span class="lineno"> 2275</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) ppi[pl]=piin[pl];</div>
<div class="line"><a name="l02276"></a><span class="lineno"> 2276</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l02277"></a><span class="lineno"> 2277</span>&#160;          <span class="keywordflow">if</span>(pl&gt;=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a> &amp;&amp; pl&lt;=U3 || pl&gt;=URAD0 &amp;&amp; pl&lt;=URAD3) uui[pl]=Uiin[pl];</div>
<div class="line"><a name="l02278"></a><span class="lineno"> 2278</span>&#160;          <span class="keywordflow">else</span> uui[pl]=uu0[pl];</div>
<div class="line"><a name="l02279"></a><span class="lineno"> 2279</span>&#160;        }</div>
<div class="line"><a name="l02280"></a><span class="lineno"> 2280</span>&#160;        <span class="comment">//PLOOP(pliter,pl) ppi[pl]=pp[pl];</span></div>
<div class="line"><a name="l02281"></a><span class="lineno"> 2281</span>&#160;        <span class="comment">//        PLOOP(pliter,pl) uui[pl]=uu0[pl];</span></div>
<div class="line"><a name="l02282"></a><span class="lineno"> 2282</span>&#160;</div>
<div class="line"><a name="l02283"></a><span class="lineno"> 2283</span>&#160;        <span class="keywordtype">int</span> failreturni=1;</div>
<div class="line"><a name="l02284"></a><span class="lineno"> 2284</span>&#160;        <span class="keywordflow">if</span>(1){</div>
<div class="line"><a name="l02285"></a><span class="lineno"> 2285</span>&#160;          <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a0a4c88ebd712c11eee70dda4d75288cf">setgasinversionstuff</a>(iter,whichcall,impeps,*errorabs,convabs,maxiter,&amp;newtonstats,&amp;checkoninversiongas,&amp;checkoninversionrad);</div>
<div class="line"><a name="l02286"></a><span class="lineno"> 2286</span>&#160;          <span class="comment">//newtonstats.tryconv=MIN(1E-6,convabs)*1E-2;</span></div>
<div class="line"><a name="l02287"></a><span class="lineno"> 2287</span>&#160;          <span class="comment">//          newtonstats.tryconvultrarel=MIN(1E-6,convabs)*1E-2;</span></div>
<div class="line"><a name="l02288"></a><span class="lineno"> 2288</span>&#160;          <span class="comment">//          newtonstats.maxiter=20;</span></div>
<div class="line"><a name="l02289"></a><span class="lineno"> 2289</span>&#160;          newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#abaf99ec9e8c395755285cd9a44858314">tryconv</a>=1<a class="code" href="../../d8/d60/init_8c.html#a07484107e6d9fdf38b53edf631d6511d">E</a>-12;</div>
<div class="line"><a name="l02290"></a><span class="lineno"> 2290</span>&#160;          newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a00940ef45bf3eb6e72c49ea66dd7c8b2">tryconvultrarel</a>=1<a class="code" href="../../d8/d60/init_8c.html#a07484107e6d9fdf38b53edf631d6511d">E</a>-12;</div>
<div class="line"><a name="l02291"></a><span class="lineno"> 2291</span>&#160;          newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a767c6b7671c51ec6db1a3d7199775588">maxiter</a>=40;</div>
<div class="line"><a name="l02292"></a><span class="lineno"> 2292</span>&#160;          <span class="keywordtype">int</span> eomtypei=*eomtype;</div>
<div class="line"><a name="l02293"></a><span class="lineno"> 2293</span>&#160;          <span class="keywordtype">int</span> radinvmodi;</div>
<div class="line"><a name="l02294"></a><span class="lineno"> 2294</span>&#160;          <span class="keywordtype">int</span> doradonlyi=0; failreturni=Utoprimgen_failwrapper(doradonlyi,&amp;radinvmodi,showmessages,checkoninversiongas,checkoninversionrad,allowlocalfailurefixandnoreport, finalstep, &amp;eomtypei, whichcap, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7d1dc231c422450f87fdb3e71b4a7aff" title="defines how Utoprimgen is used">EVOLVEUTOPRIM</a>, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab2be21bd5eff40ca89c20eeecbeab5e0">UNOTHING</a>, uui, &amp;qi, ptrgeom, dissmeasure, ppi, &amp;newtonstats);</div>
<div class="line"><a name="l02295"></a><span class="lineno"> 2295</span>&#160;          <span class="comment">//          *nummhdinvsreturn++;</span></div>
<div class="line"><a name="l02296"></a><span class="lineno"> 2296</span>&#160;          <span class="comment">// completed inversion so that ppi=ppi(uu0)</span></div>
<div class="line"><a name="l02297"></a><span class="lineno"> 2297</span>&#160;        }</div>
<div class="line"><a name="l02298"></a><span class="lineno"> 2298</span>&#160;</div>
<div class="line"><a name="l02299"></a><span class="lineno"> 2299</span>&#160;        <span class="keywordflow">if</span>(failreturni!=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a37d8e953a25b51ce606f181bbc18d562">UTOPRIMGENWRAPPERRETURNFAILMHD</a>){</div>
<div class="line"><a name="l02300"></a><span class="lineno"> 2300</span>&#160;          didinitial=1;</div>
<div class="line"><a name="l02301"></a><span class="lineno"> 2301</span>&#160;</div>
<div class="line"><a name="l02302"></a><span class="lineno"> 2302</span>&#160;          <span class="comment">// get other things usually needed at end of f_implicit()</span></div>
<div class="line"><a name="l02303"></a><span class="lineno"> 2303</span>&#160;          <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a11e17cd8b0594d1ad52e3594aa9f477e" title="find ucon, ucov, bcon, bcov from primitive variables when calling get_state, users of this function e...">get_state</a>(ppi, ptrgeom, &amp;qi);</div>
<div class="line"><a name="l02304"></a><span class="lineno"> 2304</span>&#160;</div>
<div class="line"><a name="l02305"></a><span class="lineno"> 2305</span>&#160;          <a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#a0a9afe086334630c217cca3b3dbf7f7d" title="get 4-force for all pl&#39;s">koral_source_rad_calc</a>(computestate,computeentropy,ppi, ptrgeom, Gdpli, Gdplabsi, &amp;chieffi, &amp;Tgasi, &amp;Tradi, &amp;qi);</div>
<div class="line"><a name="l02306"></a><span class="lineno"> 2306</span>&#160;          <span class="comment">//        FTYPE tautoti,tautotmaxi;</span></div>
<div class="line"><a name="l02307"></a><span class="lineno"> 2307</span>&#160;          <span class="comment">//        calc_tautot_chieff(ppi, chieffi, ptrgeom, q, &amp;tautoti, &amp;tautotmaxi);</span></div>
<div class="line"><a name="l02308"></a><span class="lineno"> 2308</span>&#160;</div>
<div class="line"><a name="l02309"></a><span class="lineno"> 2309</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l02310"></a><span class="lineno"> 2310</span>&#160;            extrafactori[pl]=1.0;</div>
<div class="line"><a name="l02311"></a><span class="lineno"> 2311</span>&#160;          }</div>
<div class="line"><a name="l02312"></a><span class="lineno"> 2312</span>&#160;          <span class="comment">// get new extrafactor for entropy</span></div>
<div class="line"><a name="l02313"></a><span class="lineno"> 2313</span>&#160;          <span class="keywordflow">if</span>(ENTROPY&gt;=0){</div>
<div class="line"><a name="l02314"></a><span class="lineno"> 2314</span>&#160;            pl=ENTROPY;</div>
<div class="line"><a name="l02315"></a><span class="lineno"> 2315</span>&#160;            extrafactori[pl]=fabs(Tgasi)+<a class="code" href="../../da/d04/global_8depmnemonics_8rad_8h.html#a213757d7585988f6c552da30cc6fcc39">TEMPMIN</a>;</div>
<div class="line"><a name="l02316"></a><span class="lineno"> 2316</span>&#160;          }</div>
<div class="line"><a name="l02317"></a><span class="lineno"> 2317</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l02318"></a><span class="lineno"> 2318</span>&#160;            fi[pl] = ((uui[pl] - uu0[pl]) + (sign[pl] * localdt * Gdpli[pl]))*extrafactori[pl];</div>
<div class="line"><a name="l02319"></a><span class="lineno"> 2319</span>&#160;</div>
<div class="line"><a name="l02320"></a><span class="lineno"> 2320</span>&#160;            uuallabsi[pl] = <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a987db2b5d50589e097378a13c5d87fef">THIRD</a>*(fabs(uuabsi[pl]) + fabs(uui[pl]) + fabs(uu0[pl]))*extrafactori[pl];</div>
<div class="line"><a name="l02321"></a><span class="lineno"> 2321</span>&#160;            Gallabsi[pl] = fabs(sign[pl] * localdt * Gdplabsi[pl])*extrafactori[pl];</div>
<div class="line"><a name="l02322"></a><span class="lineno"> 2322</span>&#160;            fnormi[pl] = uuallabsi[pl] + Gallabsi[pl];</div>
<div class="line"><a name="l02323"></a><span class="lineno"> 2323</span>&#160;</div>
<div class="line"><a name="l02324"></a><span class="lineno"> 2324</span>&#160;          }</div>
<div class="line"><a name="l02325"></a><span class="lineno"> 2325</span>&#160;</div>
<div class="line"><a name="l02326"></a><span class="lineno"> 2326</span>&#160;          convreturni=f_error_check(showmessages, showmessagesheavy, iter, conv, convabs, realdt, dimtypef,*eomtype , *radinvmod, itermode,*baseitermethod,fracenergy,dissmeasure,dimfactU,ppi,piin,fi,fnormi,freporti,Uiin,uu0,uui,ptrgeom,&amp;errorabsi,&amp;errorallabsi,whicherror);</div>
<div class="line"><a name="l02327"></a><span class="lineno"> 2327</span>&#160;        }  </div>
<div class="line"><a name="l02328"></a><span class="lineno"> 2328</span>&#160;      }</div>
<div class="line"><a name="l02329"></a><span class="lineno"> 2329</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02330"></a><span class="lineno"> 2330</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l02331"></a><span class="lineno"> 2331</span>&#160;</div>
<div class="line"><a name="l02332"></a><span class="lineno"> 2332</span>&#160;</div>
<div class="line"><a name="l02333"></a><span class="lineno"> 2333</span>&#160;</div>
<div class="line"><a name="l02334"></a><span class="lineno"> 2334</span>&#160;</div>
<div class="line"><a name="l02335"></a><span class="lineno"> 2335</span>&#160;</div>
<div class="line"><a name="l02336"></a><span class="lineno"> 2336</span>&#160;</div>
<div class="line"><a name="l02337"></a><span class="lineno"> 2337</span>&#160;      <span class="comment">// then do explicit step</span></div>
<div class="line"><a name="l02338"></a><span class="lineno"> 2338</span>&#160;      <span class="comment">// explicit step using explicit-like dt</span></div>
<div class="line"><a name="l02339"></a><span class="lineno"> 2339</span>&#160;      <span class="comment">//FTYPE idtsub0=SMALL+fabs(ratchangeRtt)/realdt;</span></div>
<div class="line"><a name="l02340"></a><span class="lineno"> 2340</span>&#160;      <span class="comment">//FTYPE explicitdt=MIN(localdt,1.0/idtsub0);</span></div>
<div class="line"><a name="l02341"></a><span class="lineno"> 2341</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> uue[NPR],uueabs[NPR],ppe[NPR];</div>
<div class="line"><a name="l02342"></a><span class="lineno"> 2342</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> errorabse=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>,errorallabse=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>;</div>
<div class="line"><a name="l02343"></a><span class="lineno"> 2343</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fe[NPR]={0.0},fnorme[NPR]={0.0};</div>
<div class="line"><a name="l02344"></a><span class="lineno"> 2344</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> uuallabse[NPR]={0.0},Gallabse[NPR]={0.0};</div>
<div class="line"><a name="l02345"></a><span class="lineno"> 2345</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> freporte[NPR];</div>
<div class="line"><a name="l02346"></a><span class="lineno"> 2346</span>&#160;      <span class="keywordtype">int</span> convreturne;</div>
<div class="line"><a name="l02347"></a><span class="lineno"> 2347</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Gdple[NPR]={0.0},Gdplabse[NPR]={0.0}, Tgase={0.0},Trade={0.0};</div>
<div class="line"><a name="l02348"></a><span class="lineno"> 2348</span>&#160;      <span class="comment">//          FTYPE uuabse[NPR]={0.0};</span></div>
<div class="line"><a name="l02349"></a><span class="lineno"> 2349</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> chieffe=0.0;</div>
<div class="line"><a name="l02350"></a><span class="lineno"> 2350</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> extrafactore[NPR];</div>
<div class="line"><a name="l02351"></a><span class="lineno"> 2351</span>&#160;      <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> qe;</div>
<div class="line"><a name="l02352"></a><span class="lineno"> 2352</span>&#160;      qe=*q;</div>
<div class="line"><a name="l02353"></a><span class="lineno"> 2353</span>&#160;</div>
<div class="line"><a name="l02354"></a><span class="lineno"> 2354</span>&#160;      <span class="keywordflow">if</span>(1){</div>
<div class="line"><a name="l02355"></a><span class="lineno"> 2355</span>&#160;        <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> explicitdt=localdt;</div>
<div class="line"><a name="l02356"></a><span class="lineno"> 2356</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l02357"></a><span class="lineno"> 2357</span>&#160;          ppe[pl] = pp[pl];</div>
<div class="line"><a name="l02358"></a><span class="lineno"> 2358</span>&#160;          uue[pl] = -((0- uu0[pl]) + (sign[pl] * explicitdt * Gdpl[pl])); <span class="comment">// uses Gdpl[pp(uu)]</span></div>
<div class="line"><a name="l02359"></a><span class="lineno"> 2359</span>&#160;          uueabs[pl] = uuabs[pl]; <span class="comment">// estimate</span></div>
<div class="line"><a name="l02360"></a><span class="lineno"> 2360</span>&#160;        }</div>
<div class="line"><a name="l02361"></a><span class="lineno"> 2361</span>&#160;            </div>
<div class="line"><a name="l02362"></a><span class="lineno"> 2362</span>&#160;</div>
<div class="line"><a name="l02363"></a><span class="lineno"> 2363</span>&#160;        <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a0a4c88ebd712c11eee70dda4d75288cf">setgasinversionstuff</a>(iter,whichcall,impeps,*errorabs,convabs,maxiter,&amp;newtonstats,&amp;checkoninversiongas,&amp;checkoninversionrad);</div>
<div class="line"><a name="l02364"></a><span class="lineno"> 2364</span>&#160;        <span class="comment">//newtonstats.tryconv=MIN(1E-6,convabs)*1E-2;</span></div>
<div class="line"><a name="l02365"></a><span class="lineno"> 2365</span>&#160;        <span class="comment">//newtonstats.tryconvultrarel=MIN(1E-6,convabs)*1E-2;</span></div>
<div class="line"><a name="l02366"></a><span class="lineno"> 2366</span>&#160;        <span class="comment">//newtonstats.maxiter=20;</span></div>
<div class="line"><a name="l02367"></a><span class="lineno"> 2367</span>&#160;        <span class="keywordflow">if</span>(maxiter&lt;=1){</div>
<div class="line"><a name="l02368"></a><span class="lineno"> 2368</span>&#160;          newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#abaf99ec9e8c395755285cd9a44858314">tryconv</a>=1<a class="code" href="../../d8/d60/init_8c.html#a07484107e6d9fdf38b53edf631d6511d">E</a>-1;</div>
<div class="line"><a name="l02369"></a><span class="lineno"> 2369</span>&#160;          newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a00940ef45bf3eb6e72c49ea66dd7c8b2">tryconvultrarel</a>=1<a class="code" href="../../d8/d60/init_8c.html#a07484107e6d9fdf38b53edf631d6511d">E</a>-1;</div>
<div class="line"><a name="l02370"></a><span class="lineno"> 2370</span>&#160;          newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a767c6b7671c51ec6db1a3d7199775588">maxiter</a>=1;</div>
<div class="line"><a name="l02371"></a><span class="lineno"> 2371</span>&#160;          newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a28c2335afb8757d40128392034402c17">extra_newt_iter</a>=0;</div>
<div class="line"><a name="l02372"></a><span class="lineno"> 2372</span>&#160;          newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a08186e529162af19adc29e62eaaf31d9">extra_newt_iter_ultrarel</a>=0;</div>
<div class="line"><a name="l02373"></a><span class="lineno"> 2373</span>&#160;        }</div>
<div class="line"><a name="l02374"></a><span class="lineno"> 2374</span>&#160;        <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l02375"></a><span class="lineno"> 2375</span>&#160;          newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#abaf99ec9e8c395755285cd9a44858314">tryconv</a>=(1E3*<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a8913cb5d64cfec23ae1a3052930ec468">NUMEPSILON</a>);</div>
<div class="line"><a name="l02376"></a><span class="lineno"> 2376</span>&#160;          newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a00940ef45bf3eb6e72c49ea66dd7c8b2">tryconvultrarel</a>=(5*<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a8913cb5d64cfec23ae1a3052930ec468">NUMEPSILON</a>);</div>
<div class="line"><a name="l02377"></a><span class="lineno"> 2377</span>&#160;          newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a767c6b7671c51ec6db1a3d7199775588">maxiter</a>=100;</div>
<div class="line"><a name="l02378"></a><span class="lineno"> 2378</span>&#160;          newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a28c2335afb8757d40128392034402c17">extra_newt_iter</a>=2;</div>
<div class="line"><a name="l02379"></a><span class="lineno"> 2379</span>&#160;          newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a08186e529162af19adc29e62eaaf31d9">extra_newt_iter_ultrarel</a>=2;</div>
<div class="line"><a name="l02380"></a><span class="lineno"> 2380</span>&#160;        }</div>
<div class="line"><a name="l02381"></a><span class="lineno"> 2381</span>&#160;        <span class="keywordtype">int</span> eomtypee=*eomtype;</div>
<div class="line"><a name="l02382"></a><span class="lineno"> 2382</span>&#160;        <span class="keywordtype">int</span> radinvmode;</div>
<div class="line"><a name="l02383"></a><span class="lineno"> 2383</span>&#160;        <span class="keywordtype">int</span> finalstepe=0;</div>
<div class="line"><a name="l02384"></a><span class="lineno"> 2384</span>&#160;        <span class="keywordtype">int</span> doradonly=0; <span class="keywordtype">int</span> failreturne=Utoprimgen_failwrapper(doradonly,&amp;radinvmode,showmessages,checkoninversiongas,checkoninversionrad,allowlocalfailurefixandnoreport, finalstepe, &amp;eomtypee, whichcap, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7d1dc231c422450f87fdb3e71b4a7aff" title="defines how Utoprimgen is used">EVOLVEUTOPRIM</a>, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab2be21bd5eff40ca89c20eeecbeab5e0">UNOTHING</a>, uue, &amp;qe, ptrgeom, dissmeasure, ppe, &amp;newtonstats);</div>
<div class="line"><a name="l02385"></a><span class="lineno"> 2385</span>&#160;        <span class="comment">// if switches to entropy (*eomtype=EOMGRMHD -&gt; eomtypee=EOMENTROPYGRMHD), then uue won&#39;t be changed, but ppe will be entropy inversion solution.  So below error test using uue and Gple uses uue from energy and Gple from entropy primitives, which is fine because Gpl still computed as perfectly conservative and uue still conservative.  So good error check.</span></div>
<div class="line"><a name="l02386"></a><span class="lineno"> 2386</span>&#160;        <span class="comment">// However, final primitives (ppe) not consistent with conserved (uue), like normally would be.</span></div>
<div class="line"><a name="l02387"></a><span class="lineno"> 2387</span>&#160;        <span class="comment">// However, if really error ended up small, then would drop out of f1 loop and still do FINALCHECK that would recompute f1 and ensure primitives and conserves are consistent *and* based upon original emptype because Utoprimgen not used.  At that point, entropy gas solution would be used to compute UUgas and then radiation would be computed as UUrad=uu0rad-dUgas  with dUgas=uu0-UUgas, so that radiation bears brunt of error of using entropy in gas -- but total energy conserved.  In optically thick or high radiation regions, this is fine.  In optically thin regions or gas-dominated regions, this is an issue -- acts like effective opacity even though no opacity -- like numerical opacity.  So this acts like automatic borrow operation.</span></div>
<div class="line"><a name="l02388"></a><span class="lineno"> 2388</span>&#160;</div>
<div class="line"><a name="l02389"></a><span class="lineno"> 2389</span>&#160;        <span class="comment">//*nummhdinvsreturn++;</span></div>
<div class="line"><a name="l02390"></a><span class="lineno"> 2390</span>&#160;        <span class="comment">// completed explicit step</span></div>
<div class="line"><a name="l02391"></a><span class="lineno"> 2391</span>&#160;</div>
<div class="line"><a name="l02392"></a><span class="lineno"> 2392</span>&#160;        <span class="comment">// get MHD state</span></div>
<div class="line"><a name="l02393"></a><span class="lineno"> 2393</span>&#160;        <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a3c69b676adf3024cd6ae832094d91fab" title="find ucon, ucov, bcon, bcov from primitive variables when calling get_state, users of this function e...">get_state_norad_part1</a>(ppe, ptrgeom, &amp;qe);</div>
<div class="line"><a name="l02394"></a><span class="lineno"> 2394</span>&#160;        <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#aae6a7d24b984236dae44b1a3e8ee37b6" title="find ucon, ucov, bcon, bcov from primitive variables when calling get_state, users of this function e...">get_state_norad_part2</a>(needentropy, ppe, ptrgeom, &amp;qe); <span class="comment">// where entropy would be computed</span></div>
<div class="line"><a name="l02395"></a><span class="lineno"> 2395</span>&#160;        </div>
<div class="line"><a name="l02396"></a><span class="lineno"> 2396</span>&#160;        <span class="comment">// get accurate UMHD[pmhd] to avoid inversion inaccuracies for MHD inversion part</span></div>
<div class="line"><a name="l02397"></a><span class="lineno"> 2397</span>&#160;        <span class="keyword">extern</span> <span class="keywordtype">int</span> <a class="code" href="../../d7/def/phys_8tools_8c.html#ad54ad99ee062beaf43518d6e9afae0a7">primtoflux_nonradonly</a>(<span class="keywordtype">int</span> needentropy, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *q, <span class="keywordtype">int</span> dir, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *geom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *flux, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *fluxabs);</div>
<div class="line"><a name="l02398"></a><span class="lineno"> 2398</span>&#160;        <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> uumhd[NPR],uumhdabs[NPR];</div>
<div class="line"><a name="l02399"></a><span class="lineno"> 2399</span>&#160;        <a class="code" href="../../d7/def/phys_8tools_8c.html#ad54ad99ee062beaf43518d6e9afae0a7">primtoflux_nonradonly</a>(needentropy,ppe,&amp;qe,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>,ptrgeom, uumhd, uumhdabs); <span class="comment">// anything not set is set as zero, which is rad.</span></div>
<div class="line"><a name="l02400"></a><span class="lineno"> 2400</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) <span class="keywordflow">if</span>(!<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a43791f6c1915cf7bfe3a02a4502510e4">RADFULLPL</a>(pl)) uue[pl]=uumhd[pl];</div>
<div class="line"><a name="l02401"></a><span class="lineno"> 2401</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) <span class="keywordflow">if</span>(!<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a43791f6c1915cf7bfe3a02a4502510e4">RADFULLPL</a>(pl)) uueabs[pl]=uumhdabs[pl];</div>
<div class="line"><a name="l02402"></a><span class="lineno"> 2402</span>&#160;</div>
<div class="line"><a name="l02403"></a><span class="lineno"> 2403</span>&#160;</div>
<div class="line"><a name="l02404"></a><span class="lineno"> 2404</span>&#160;</div>
<div class="line"><a name="l02405"></a><span class="lineno"> 2405</span>&#160;        didexplicit=0;</div>
<div class="line"><a name="l02406"></a><span class="lineno"> 2406</span>&#160;        <span class="keywordflow">if</span>(failreturne!=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a37d8e953a25b51ce606f181bbc18d562">UTOPRIMGENWRAPPERRETURNFAILMHD</a>){</div>
<div class="line"><a name="l02407"></a><span class="lineno"> 2407</span>&#160;          didexplicit=1;</div>
<div class="line"><a name="l02408"></a><span class="lineno"> 2408</span>&#160;</div>
<div class="line"><a name="l02409"></a><span class="lineno"> 2409</span>&#160;          </div>
<div class="line"><a name="l02410"></a><span class="lineno"> 2410</span>&#160;<span class="preprocessor">#if(1)</span></div>
<div class="line"><a name="l02411"></a><span class="lineno"> 2411</span>&#160;<span class="preprocessor"></span>          <span class="comment">// might think not needed because pgas(entropy) and uue(energy) will be used below in error and error used will be for eomtype so any error that exists will be seen in use of Gpl(pgas(entropy) as compared to uue and uu0 and that Gpl. So good error estimate.  No use of rad errors for whicherror=0, but *is* used for whicherror=1</span></div>
<div class="line"><a name="l02412"></a><span class="lineno"> 2412</span>&#160;</div>
<div class="line"><a name="l02413"></a><span class="lineno"> 2413</span>&#160;          <span class="keywordflow">if</span>(mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9cf5ca7f5e5aa1e0bdef53abe3f27c1c">QTYPMHD</a> || mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8b10ec187cbee196f071e162563cd945">QTYPMHDENERGYONLY</a> || mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad1dda20c101a983834446c5c93791583">QTYPMHDMOMONLY</a>){</div>
<div class="line"><a name="l02414"></a><span class="lineno"> 2414</span>&#160;            <span class="comment">// then ensure total energy conservation version of primitives obtained here, and total consistent p/uu used in error estimate</span></div>
<div class="line"><a name="l02415"></a><span class="lineno"> 2415</span>&#160;            <span class="comment">// matters to get whicherror=1 error estimate valid/constent.</span></div>
<div class="line"><a name="l02416"></a><span class="lineno"> 2416</span>&#160;            <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(iv) uue[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#a841d43603fddda5fbcbc03d6b2f544de">iotherU</a>[iv]] = uu0[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#a841d43603fddda5fbcbc03d6b2f544de">iotherU</a>[iv]] - (uue[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[iv]]-uu0[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[iv]]);</div>
<div class="line"><a name="l02417"></a><span class="lineno"> 2417</span>&#160;            <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(iv) uuabs[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#a841d43603fddda5fbcbc03d6b2f544de">iotherU</a>[iv]] = fabs(uu0[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#a841d43603fddda5fbcbc03d6b2f544de">iotherU</a>[iv]]) + fabs(uue[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[iv]]) + fabs(uu0[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[iv]]); <span class="comment">// assume uuabs ok as same</span></div>
<div class="line"><a name="l02418"></a><span class="lineno"> 2418</span>&#160;</div>
<div class="line"><a name="l02419"></a><span class="lineno"> 2419</span>&#160;            <span class="keywordtype">int</span> eomtypee2=*eomtype; <span class="comment">// back to original, but doing radiation below so doesn&#39;t matter.</span></div>
<div class="line"><a name="l02420"></a><span class="lineno"> 2420</span>&#160;            <span class="keywordtype">int</span> radinvmode2;</div>
<div class="line"><a name="l02421"></a><span class="lineno"> 2421</span>&#160;            <span class="keywordtype">int</span> doradonly2=1; <span class="keywordtype">int</span> failreturne2=Utoprimgen_failwrapper(doradonly2,&amp;radinvmode2,showmessages,checkoninversiongas,checkoninversionrad,allowlocalfailurefixandnoreport, finalstepe, &amp;eomtypee2, whichcap, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7d1dc231c422450f87fdb3e71b4a7aff" title="defines how Utoprimgen is used">EVOLVEUTOPRIM</a>, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab2be21bd5eff40ca89c20eeecbeab5e0">UNOTHING</a>, uue, &amp;qe, ptrgeom, dissmeasure, ppe, &amp;newtonstats);</div>
<div class="line"><a name="l02422"></a><span class="lineno"> 2422</span>&#160;            <span class="comment">// if radinvmode==0 and radinvmode2!=0, should we abort explicit?</span></div>
<div class="line"><a name="l02423"></a><span class="lineno"> 2423</span>&#160;            <span class="comment">// as long as radinvmode2==0, then all uu and pp&#39;s are now consistent</span></div>
<div class="line"><a name="l02424"></a><span class="lineno"> 2424</span>&#160;</div>
<div class="line"><a name="l02425"></a><span class="lineno"> 2425</span>&#160;          }</div>
<div class="line"><a name="l02426"></a><span class="lineno"> 2426</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02427"></a><span class="lineno"> 2427</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l02428"></a><span class="lineno"> 2428</span>&#160;          <span class="comment">// get other things usually needed at end of f_implicit()</span></div>
<div class="line"><a name="l02429"></a><span class="lineno"> 2429</span>&#160;          <span class="comment">//          get_state(ppe, ptrgeom, &amp;qe);</span></div>
<div class="line"><a name="l02430"></a><span class="lineno"> 2430</span>&#160;</div>
<div class="line"><a name="l02431"></a><span class="lineno"> 2431</span>&#160;          <span class="comment">// ensure uue is exactly consistent with ppe despite inversion inaccuracies.</span></div>
<div class="line"><a name="l02432"></a><span class="lineno"> 2432</span>&#160;          <span class="comment">//            primtoU(UNOTHING,ppe,&amp;qe,ptrgeom, uue, uueabs);</span></div>
<div class="line"><a name="l02433"></a><span class="lineno"> 2433</span>&#160;          </div>
<div class="line"><a name="l02434"></a><span class="lineno"> 2434</span>&#160;          <span class="keyword">extern</span> <span class="keywordtype">int</span> <a class="code" href="../../d7/def/phys_8tools_8c.html#a764e6f682011d16faec0f9b71eb360d2">primtoflux_radonly</a>(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *q, <span class="keywordtype">int</span> dir, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *geom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *flux, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *fluxabs);</div>
<div class="line"><a name="l02435"></a><span class="lineno"> 2435</span>&#160;          <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> uurad[NPR],uuradabs[NPR];</div>
<div class="line"><a name="l02436"></a><span class="lineno"> 2436</span>&#160;          <a class="code" href="../../d7/def/phys_8tools_8c.html#a764e6f682011d16faec0f9b71eb360d2">primtoflux_radonly</a>(ppe,&amp;qe,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>,ptrgeom, uurad,uuradabs); <span class="comment">// all non-rad stuff is set to zero.</span></div>
<div class="line"><a name="l02437"></a><span class="lineno"> 2437</span>&#160;          <span class="comment">// write new uurad&#39;s to uu</span></div>
<div class="line"><a name="l02438"></a><span class="lineno"> 2438</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) <span class="keywordflow">if</span>(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a43791f6c1915cf7bfe3a02a4502510e4">RADFULLPL</a>(pl)) uue[pl]=uurad[pl];</div>
<div class="line"><a name="l02439"></a><span class="lineno"> 2439</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) <span class="keywordflow">if</span>(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a43791f6c1915cf7bfe3a02a4502510e4">RADFULLPL</a>(pl)) uueabs[pl]=uuradabs[pl];</div>
<div class="line"><a name="l02440"></a><span class="lineno"> 2440</span>&#160;</div>
<div class="line"><a name="l02441"></a><span class="lineno"> 2441</span>&#160;</div>
<div class="line"><a name="l02442"></a><span class="lineno"> 2442</span>&#160;          </div>
<div class="line"><a name="l02443"></a><span class="lineno"> 2443</span>&#160;          <a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#a0a9afe086334630c217cca3b3dbf7f7d" title="get 4-force for all pl&#39;s">koral_source_rad_calc</a>(computestate,computeentropy,ppe, ptrgeom, Gdple, Gdplabse, &amp;chieffe, &amp;Tgase, &amp;Trade, &amp;qe);</div>
<div class="line"><a name="l02444"></a><span class="lineno"> 2444</span>&#160;          </div>
<div class="line"><a name="l02445"></a><span class="lineno"> 2445</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l02446"></a><span class="lineno"> 2446</span>&#160;            extrafactore[pl]=1.0;</div>
<div class="line"><a name="l02447"></a><span class="lineno"> 2447</span>&#160;          }</div>
<div class="line"><a name="l02448"></a><span class="lineno"> 2448</span>&#160;          <span class="comment">// get new extrafactor for entropy</span></div>
<div class="line"><a name="l02449"></a><span class="lineno"> 2449</span>&#160;          <span class="keywordflow">if</span>(ENTROPY&gt;=0){</div>
<div class="line"><a name="l02450"></a><span class="lineno"> 2450</span>&#160;            pl=ENTROPY;</div>
<div class="line"><a name="l02451"></a><span class="lineno"> 2451</span>&#160;            extrafactore[pl]=fabs(Tgase)+<a class="code" href="../../da/d04/global_8depmnemonics_8rad_8h.html#a213757d7585988f6c552da30cc6fcc39">TEMPMIN</a>;</div>
<div class="line"><a name="l02452"></a><span class="lineno"> 2452</span>&#160;          }</div>
<div class="line"><a name="l02453"></a><span class="lineno"> 2453</span>&#160;          </div>
<div class="line"><a name="l02454"></a><span class="lineno"> 2454</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l02455"></a><span class="lineno"> 2455</span>&#160;            fe[pl] = ((uue[pl] - uu0[pl]) + (sign[pl] * localdt * Gdple[pl]))*extrafactore[pl];</div>
<div class="line"><a name="l02456"></a><span class="lineno"> 2456</span>&#160;</div>
<div class="line"><a name="l02457"></a><span class="lineno"> 2457</span>&#160;            uuallabse[pl] = <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a987db2b5d50589e097378a13c5d87fef">THIRD</a>*(fabs(uueabs[pl]) + fabs(uue[pl]) + fabs(uu0[pl]))*extrafactore[pl];</div>
<div class="line"><a name="l02458"></a><span class="lineno"> 2458</span>&#160;            Gallabse[pl] = fabs(sign[pl] * localdt * Gdplabse[pl])*extrafactore[pl];</div>
<div class="line"><a name="l02459"></a><span class="lineno"> 2459</span>&#160;            fnorme[pl] = uuallabse[pl] + Gallabse[pl];</div>
<div class="line"><a name="l02460"></a><span class="lineno"> 2460</span>&#160;          }</div>
<div class="line"><a name="l02461"></a><span class="lineno"> 2461</span>&#160;</div>
<div class="line"><a name="l02462"></a><span class="lineno"> 2462</span>&#160;          convreturne=f_error_check(showmessages, showmessagesheavy, iter, conv, convabs, realdt, dimtypef,*eomtype , *radinvmod, itermode,*baseitermethod,fracenergy,dissmeasure,dimfactU,ppe,piin,fe,fnorme,freporte,Uiin,uu0,uue,ptrgeom,&amp;errorabse,&amp;errorallabse,whicherror,mtd,ru);</div>
<div class="line"><a name="l02463"></a><span class="lineno"> 2463</span>&#160;        }</div>
<div class="line"><a name="l02464"></a><span class="lineno"> 2464</span>&#160;        <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l02465"></a><span class="lineno"> 2465</span>&#160;          <span class="comment">//            if(ptrgeom-&gt;i==8 &amp;&amp; ptrgeom-&gt;j==10) dualfprintf(fail_file,&quot;explicitnotwork\n&quot;);</span></div>
<div class="line"><a name="l02466"></a><span class="lineno"> 2466</span>&#160;        }</div>
<div class="line"><a name="l02467"></a><span class="lineno"> 2467</span>&#160;      }</div>
<div class="line"><a name="l02468"></a><span class="lineno"> 2468</span>&#160;</div>
<div class="line"><a name="l02469"></a><span class="lineno"> 2469</span>&#160;</div>
<div class="line"><a name="l02470"></a><span class="lineno"> 2470</span>&#160;</div>
<div class="line"><a name="l02471"></a><span class="lineno"> 2471</span>&#160;      <span class="comment">// choose best guess</span></div>
<div class="line"><a name="l02472"></a><span class="lineno"> 2472</span>&#160;      <span class="comment">//        if(fabs(errorallabse)&lt;fabs(*errorallabs) &amp;&amp; fabs(errorallabsi)&gt;fabs(errorallabse)){</span></div>
<div class="line"><a name="l02473"></a><span class="lineno"> 2473</span>&#160;      <span class="comment">//if(errorallabse&lt;0.1 &amp;&amp; fabs(errorallabse)&lt;fabs(*errorallabs) &amp;&amp; fabs(errorallabsi)&gt;fabs(errorallabse)){</span></div>
<div class="line"><a name="l02474"></a><span class="lineno"> 2474</span>&#160;      <span class="comment">//if(0){</span></div>
<div class="line"><a name="l02475"></a><span class="lineno"> 2475</span>&#160;      <span class="keywordflow">if</span>(fabs(errorallabse)&lt;fabs(*errorallabs)){</div>
<div class="line"><a name="l02476"></a><span class="lineno"> 2476</span>&#160;        <span class="comment">//          if(ptrgeom-&gt;i==8 &amp;&amp; ptrgeom-&gt;j==10) dualfprintf(fail_file,&quot;explicitchosenasguess: %21.15g over %21.15g and %21.15g\n&quot;,errorallabse,*errorallabs,errorallabsi);</span></div>
<div class="line"><a name="l02477"></a><span class="lineno"> 2477</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l02478"></a><span class="lineno"> 2478</span>&#160;          <span class="comment">//            if(ptrgeom-&gt;i==8 &amp;&amp; ptrgeom-&gt;j==10) dualfprintf(fail_file,&quot;fr=%21.15g %21.15g %21.15g : uu=%21.15g %21.15g %21.15g pp=%21.15g %21.15g %21.15g\n&quot;,f[pl],fe[pl],fi[pl],uu[pl],uue[pl],uui[pl],pp[pl],ppe[pl],ppi[pl]);</span></div>
<div class="line"><a name="l02479"></a><span class="lineno"> 2479</span>&#160;          f[pl]=fe[pl];</div>
<div class="line"><a name="l02480"></a><span class="lineno"> 2480</span>&#160;          uuallabs[pl]=uuallabse[pl];</div>
<div class="line"><a name="l02481"></a><span class="lineno"> 2481</span>&#160;          Gdpl[pl]=Gdple[pl];</div>
<div class="line"><a name="l02482"></a><span class="lineno"> 2482</span>&#160;          Gallabs[pl]=Gallabse[pl];</div>
<div class="line"><a name="l02483"></a><span class="lineno"> 2483</span>&#160;</div>
<div class="line"><a name="l02484"></a><span class="lineno"> 2484</span>&#160;          fnorm[pl]=fnorme[pl];</div>
<div class="line"><a name="l02485"></a><span class="lineno"> 2485</span>&#160;          freport[pl]=freporte[pl];</div>
<div class="line"><a name="l02486"></a><span class="lineno"> 2486</span>&#160;          uu[pl]=uue[pl];</div>
<div class="line"><a name="l02487"></a><span class="lineno"> 2487</span>&#160;          pp[pl]=ppe[pl];</div>
<div class="line"><a name="l02488"></a><span class="lineno"> 2488</span>&#160;        }</div>
<div class="line"><a name="l02489"></a><span class="lineno"> 2489</span>&#160;</div>
<div class="line"><a name="l02490"></a><span class="lineno"> 2490</span>&#160;        Tgas=Tgase;</div>
<div class="line"><a name="l02491"></a><span class="lineno"> 2491</span>&#160;        Trad=Trade;</div>
<div class="line"><a name="l02492"></a><span class="lineno"> 2492</span>&#160;        chieff=chieffe;</div>
<div class="line"><a name="l02493"></a><span class="lineno"> 2493</span>&#160;            </div>
<div class="line"><a name="l02494"></a><span class="lineno"> 2494</span>&#160;        *errorabs=errorabse;</div>
<div class="line"><a name="l02495"></a><span class="lineno"> 2495</span>&#160;        *errorallabs=errorallabse;</div>
<div class="line"><a name="l02496"></a><span class="lineno"> 2496</span>&#160;        *convreturn=convreturne;</div>
<div class="line"><a name="l02497"></a><span class="lineno"> 2497</span>&#160;        *q=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a204451e8ec20e7512e65a0b10cd19797">qe</a>;</div>
<div class="line"><a name="l02498"></a><span class="lineno"> 2498</span>&#160;            </div>
<div class="line"><a name="l02499"></a><span class="lineno"> 2499</span>&#160;        <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> tautote,tautotmaxe;</div>
<div class="line"><a name="l02500"></a><span class="lineno"> 2500</span>&#160;        <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a795959353203e99366b456b16d0d0bab" title="calculates total opacity over dx[] for given chi or chieff">calc_tautot_chieff</a>(ppe, chieffe, ptrgeom, q, &amp;tautote, &amp;tautotmaxe);</div>
<div class="line"><a name="l02501"></a><span class="lineno"> 2501</span>&#160;            </div>
<div class="line"><a name="l02502"></a><span class="lineno"> 2502</span>&#160;        tautot=tautote;</div>
<div class="line"><a name="l02503"></a><span class="lineno"> 2503</span>&#160;        tautotmax=tautotmaxe;</div>
<div class="line"><a name="l02504"></a><span class="lineno"> 2504</span>&#160;        *tautotmaxreturn=tautotmaxe;</div>
<div class="line"><a name="l02505"></a><span class="lineno"> 2505</span>&#160;            </div>
<div class="line"><a name="l02506"></a><span class="lineno"> 2506</span>&#160;      }</div>
<div class="line"><a name="l02507"></a><span class="lineno"> 2507</span>&#160;<span class="preprocessor">#if(0)</span></div>
<div class="line"><a name="l02508"></a><span class="lineno"> 2508</span>&#160;<span class="preprocessor"></span>      <span class="keywordflow">else</span> <span class="keywordflow">if</span>(fabs(errorallabsi)&lt;fabs(*errorallabs)){</div>
<div class="line"><a name="l02509"></a><span class="lineno"> 2509</span>&#160;        <span class="comment">//          if(ptrgeom-&gt;i==8 &amp;&amp; ptrgeom-&gt;j==10) dualfprintf(fail_file,&quot;initialchosenasguess: %g over %g and %g\n&quot;,errorallabse,*errorallabs,errorallabsi);</span></div>
<div class="line"><a name="l02510"></a><span class="lineno"> 2510</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l02511"></a><span class="lineno"> 2511</span>&#160;          <span class="comment">//if(ptrgeom-&gt;i==8 &amp;&amp; ptrgeom-&gt;j==10) dualfprintf(fail_file,&quot;fr=%21.15g %21.15g %21.15g : uu=%21.15g %21.15g %21.15g pp=%21.15g %21.15g %21.15g\n&quot;,f[pl],fe[pl],fi[pl],uu[pl],uue[pl],uui[pl],pp[pl],ppe[pl],ppi[pl]);</span></div>
<div class="line"><a name="l02512"></a><span class="lineno"> 2512</span>&#160;          f[pl]=fi[pl];</div>
<div class="line"><a name="l02513"></a><span class="lineno"> 2513</span>&#160;          uuallabs[pl]=uuallabsi[pl];</div>
<div class="line"><a name="l02514"></a><span class="lineno"> 2514</span>&#160;          Gdpl[pl]=Gdpli[pl];</div>
<div class="line"><a name="l02515"></a><span class="lineno"> 2515</span>&#160;          Gallabs[pl]=Gallabsi[pl];</div>
<div class="line"><a name="l02516"></a><span class="lineno"> 2516</span>&#160;</div>
<div class="line"><a name="l02517"></a><span class="lineno"> 2517</span>&#160;          fnorm[pl]=fnormi[pl];</div>
<div class="line"><a name="l02518"></a><span class="lineno"> 2518</span>&#160;          freport[pl]=freporti[pl];</div>
<div class="line"><a name="l02519"></a><span class="lineno"> 2519</span>&#160;          uu[pl]=uui[pl];</div>
<div class="line"><a name="l02520"></a><span class="lineno"> 2520</span>&#160;          pp[pl]=ppi[pl];</div>
<div class="line"><a name="l02521"></a><span class="lineno"> 2521</span>&#160;        }</div>
<div class="line"><a name="l02522"></a><span class="lineno"> 2522</span>&#160;</div>
<div class="line"><a name="l02523"></a><span class="lineno"> 2523</span>&#160;        Tgas=Tgasi;</div>
<div class="line"><a name="l02524"></a><span class="lineno"> 2524</span>&#160;        Trad=Tradi;</div>
<div class="line"><a name="l02525"></a><span class="lineno"> 2525</span>&#160;        chieff=chieffi;</div>
<div class="line"><a name="l02526"></a><span class="lineno"> 2526</span>&#160;            </div>
<div class="line"><a name="l02527"></a><span class="lineno"> 2527</span>&#160;        *errorabs=errorabsi;</div>
<div class="line"><a name="l02528"></a><span class="lineno"> 2528</span>&#160;        *errorallabs=errorallabsi;</div>
<div class="line"><a name="l02529"></a><span class="lineno"> 2529</span>&#160;        *convreturn=convreturni;</div>
<div class="line"><a name="l02530"></a><span class="lineno"> 2530</span>&#160;        *q=qi;</div>
<div class="line"><a name="l02531"></a><span class="lineno"> 2531</span>&#160;            </div>
<div class="line"><a name="l02532"></a><span class="lineno"> 2532</span>&#160;        <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> tautoti,tautotmaxi;</div>
<div class="line"><a name="l02533"></a><span class="lineno"> 2533</span>&#160;        <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a795959353203e99366b456b16d0d0bab" title="calculates total opacity over dx[] for given chi or chieff">calc_tautot_chieff</a>(ppi, chieffi, ptrgeom, q, &amp;tautoti, &amp;tautotmaxi);</div>
<div class="line"><a name="l02534"></a><span class="lineno"> 2534</span>&#160;            </div>
<div class="line"><a name="l02535"></a><span class="lineno"> 2535</span>&#160;        tautot=tautoti;</div>
<div class="line"><a name="l02536"></a><span class="lineno"> 2536</span>&#160;        tautotmax=tautotmaxi;</div>
<div class="line"><a name="l02537"></a><span class="lineno"> 2537</span>&#160;        *tautotmaxreturn=tautotmaxi;</div>
<div class="line"><a name="l02538"></a><span class="lineno"> 2538</span>&#160;            </div>
<div class="line"><a name="l02539"></a><span class="lineno"> 2539</span>&#160;      }</div>
<div class="line"><a name="l02540"></a><span class="lineno"> 2540</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02541"></a><span class="lineno"> 2541</span>&#160;<span class="preprocessor"></span>      <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l02542"></a><span class="lineno"> 2542</span>&#160;        <span class="comment">//          if(ptrgeom-&gt;i==8 &amp;&amp; ptrgeom-&gt;j==10) dualfprintf(fail_file,&quot;originalguesserror: %g over %g\n&quot;,errorallabse,*errorallabs);</span></div>
<div class="line"><a name="l02543"></a><span class="lineno"> 2543</span>&#160;      }</div>
<div class="line"><a name="l02544"></a><span class="lineno"> 2544</span>&#160;    }</div>
<div class="line"><a name="l02545"></a><span class="lineno"> 2545</span>&#160;  }</div>
<div class="line"><a name="l02546"></a><span class="lineno"> 2546</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02547"></a><span class="lineno"> 2547</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l02548"></a><span class="lineno"> 2548</span>&#160;</div>
<div class="line"><a name="l02549"></a><span class="lineno"> 2549</span>&#160;</div>
<div class="line"><a name="l02550"></a><span class="lineno"> 2550</span>&#160;</div>
<div class="line"><a name="l02551"></a><span class="lineno"> 2551</span>&#160;</div>
<div class="line"><a name="l02552"></a><span class="lineno"> 2552</span>&#160;</div>
<div class="line"><a name="l02553"></a><span class="lineno"> 2553</span>&#160;</div>
<div class="line"><a name="l02554"></a><span class="lineno"> 2554</span>&#160;</div>
<div class="line"><a name="l02555"></a><span class="lineno"> 2555</span>&#160;</div>
<div class="line"><a name="l02556"></a><span class="lineno"> 2556</span>&#160;</div>
<div class="line"><a name="l02557"></a><span class="lineno"> 2557</span>&#160;</div>
<div class="line"><a name="l02558"></a><span class="lineno"> 2558</span>&#160;</div>
<div class="line"><a name="l02560"></a><span class="lineno"> 2560</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02561"></a><span class="lineno"> 2561</span>&#160;  <span class="comment">// See if can do &quot;trivial&quot; explicit corresponding to machine level version of G=0 (i.e. when changes to u would be not noticible even if G is non-zero)</span></div>
<div class="line"><a name="l02562"></a><span class="lineno"> 2562</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02563"></a><span class="lineno"> 2563</span>&#160;  <span class="comment">// At this point, even if first iteration, know whether source term is what contributes to changes in uu.</span></div>
<div class="line"><a name="l02564"></a><span class="lineno"> 2564</span>&#160;  <span class="comment">// If no absolute force to machine precision for each absolute uu, then implicit stepping can be avoided.</span></div>
<div class="line"><a name="l02565"></a><span class="lineno"> 2565</span>&#160;  <span class="comment">// Even if inversions led to no consistent inversion (e.g. raditive inversion uses ceilings and so uu!=uu0 even for G=0), the below is correct.</span></div>
<div class="line"><a name="l02566"></a><span class="lineno"> 2566</span>&#160;  <span class="comment">// This even accounts for case where entropy or energy suggest need implicit</span></div>
<div class="line"><a name="l02567"></a><span class="lineno"> 2567</span>&#160;  <span class="comment">// This even accounts for when RAD quantities or MHD quantities differ on whether need explicit, since go over all pl always.</span></div>
<div class="line"><a name="l02568"></a><span class="lineno"> 2568</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02569"></a><span class="lineno"> 2569</span>&#160;  <span class="comment">// NO: Apparently guess can lead to small G, but next iteration may not.  But generally iterations can slowly grow G, so can&#39;t use any iter condition either.</span></div>
<div class="line"><a name="l02570"></a><span class="lineno"> 2570</span>&#160;  <span class="comment">// Ok, if iter=1, then check both tau and G (not either, but both) and also ensure only rad inversion changes, no gas inversion changes/issues/failures.</span></div>
<div class="line"><a name="l02572"></a><span class="lineno"> 2572</span>&#160;<span class="comment"></span>  *goexplicit=0; <span class="comment">// default</span></div>
<div class="line"><a name="l02573"></a><span class="lineno"> 2573</span>&#160;<span class="preprocessor">#define ITERCHECKEXPLICITSAFE 1 // iteration by which assume G has settled and can test if can go explicit.</span></div>
<div class="line"><a name="l02574"></a><span class="lineno"> 2574</span>&#160;<span class="preprocessor"></span>  <span class="keywordflow">if</span>(1){</div>
<div class="line"><a name="l02575"></a><span class="lineno"> 2575</span>&#160;    <span class="keywordflow">if</span>(whichcall==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a439b24ca8b87220703a1f950242344b7" title="f_implicit() call types">FIMPLICITCALLTYPEF1</a>){<span class="comment">//FIMPLICITCALLTYPEJAC)</span></div>
<div class="line"><a name="l02576"></a><span class="lineno"> 2576</span>&#160;      <span class="comment">//      if( (iter&gt;ITERCHECKEXPLICITSAFE || iter==1 &amp;&amp; tautotmax&lt;NUMEPSILON ) &amp;&amp; failreturn&lt;=UTOPRIMGENWRAPPERRETURNFAILRAD){</span></div>
<div class="line"><a name="l02577"></a><span class="lineno"> 2577</span>&#160;      <span class="keywordflow">if</span>( (iter&gt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a50245380f036ce5b587a1ca7f74c679d">ITERCHECKEXPLICITSAFE</a> || iter==1 &amp;&amp; tautotmax&lt;<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a8913cb5d64cfec23ae1a3052930ec468">NUMEPSILON</a> ) ){</div>
<div class="line"><a name="l02578"></a><span class="lineno"> 2578</span>&#160;        <span class="comment">// iter&gt;1 so at least have estimate of G even if not great.</span></div>
<div class="line"><a name="l02579"></a><span class="lineno"> 2579</span>&#160;        <span class="comment">// At iter=1, U-&gt;p-&gt;G can give G=0, while dUrad=-dUgas can still lead to changes that upon next iteration lead to G!=0.</span></div>
<div class="line"><a name="l02580"></a><span class="lineno"> 2580</span>&#160;        *goexplicit=1;</div>
<div class="line"><a name="l02581"></a><span class="lineno"> 2581</span>&#160;        <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9aa23a9a2b28d2c91e90a06c0025e91f">PLOOPDYNAMICAL</a>(pliter,pl) <span class="keywordflow">if</span>(fabs(Gallabs[pl])&gt;<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a8913cb5d64cfec23ae1a3052930ec468">NUMEPSILON</a>*fabs(uuallabs[pl])) *goexplicit=0;</div>
<div class="line"><a name="l02582"></a><span class="lineno"> 2582</span>&#160;        pl=URAD0;</div>
<div class="line"><a name="l02583"></a><span class="lineno"> 2583</span>&#160;        <span class="keywordflow">if</span>(fabs(ratchangeRtt*uu[pl])&gt;<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a8913cb5d64cfec23ae1a3052930ec468">NUMEPSILON</a>*fabs(uuallabs[pl])) *goexplicit=0;</div>
<div class="line"><a name="l02584"></a><span class="lineno"> 2584</span>&#160;        <span class="keywordflow">if</span>(fabs(ratchangeRtt*uu0[pl])&gt;<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a8913cb5d64cfec23ae1a3052930ec468">NUMEPSILON</a>*fabs(uuallabs[pl])) *goexplicit=0;</div>
<div class="line"><a name="l02585"></a><span class="lineno"> 2585</span>&#160;        <span class="comment">//  if(*goexplicit) dualfprintf(fail_file,&quot;Went explicit\n&quot;);</span></div>
<div class="line"><a name="l02586"></a><span class="lineno"> 2586</span>&#160;        <span class="comment">//  else dualfprintf(fail_file,&quot;Stayed implicit\n&quot;);</span></div>
<div class="line"><a name="l02587"></a><span class="lineno"> 2587</span>&#160;      }</div>
<div class="line"><a name="l02588"></a><span class="lineno"> 2588</span>&#160;    }</div>
<div class="line"><a name="l02589"></a><span class="lineno"> 2589</span>&#160;  }</div>
<div class="line"><a name="l02590"></a><span class="lineno"> 2590</span>&#160;</div>
<div class="line"><a name="l02591"></a><span class="lineno"> 2591</span>&#160;</div>
<div class="line"><a name="l02592"></a><span class="lineno"> 2592</span>&#160;</div>
<div class="line"><a name="l02593"></a><span class="lineno"> 2593</span>&#160;</div>
<div class="line"><a name="l02594"></a><span class="lineno"> 2594</span>&#160;</div>
<div class="line"><a name="l02595"></a><span class="lineno"> 2595</span>&#160;</div>
<div class="line"><a name="l02596"></a><span class="lineno"> 2596</span>&#160;<span class="preprocessor">#if(0)</span></div>
<div class="line"><a name="l02597"></a><span class="lineno"> 2597</span>&#160;<span class="preprocessor"></span>  <span class="comment">// compute difference vector between original and new 4-force&#39;s effect on conserved radiative quantities</span></div>
<div class="line"><a name="l02598"></a><span class="lineno"> 2598</span>&#160;  <span class="comment">// NR1992 Eq. 16.6.16: y_{n+1} = y_n + h f(y_{n+1}) , so error function is f = (y_{n+1} - y_n) - h f(y_{n+1})</span></div>
<div class="line"><a name="l02599"></a><span class="lineno"> 2599</span>&#160;  <span class="comment">// i.e. f-&gt;0 as change in conserved quantity approaches the updated value of 4-force</span></div>
<div class="line"><a name="l02600"></a><span class="lineno"> 2600</span>&#160;  <span class="keywordflow">if</span>(0){</div>
<div class="line"><a name="l02601"></a><span class="lineno"> 2601</span>&#160;    <span class="keywordflow">if</span>(fracenergy&gt;0.0 &amp;&amp; fracenergy&lt;1.0){ <span class="comment">// NOT USED!</span></div>
<div class="line"><a name="l02602"></a><span class="lineno"> 2602</span>&#160;      <span class="comment">// then erefU=UU is set as default error term, so add entropy to this.</span></div>
<div class="line"><a name="l02603"></a><span class="lineno"> 2603</span>&#160;</div>
<div class="line"><a name="l02604"></a><span class="lineno"> 2604</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fentropy[NPR];</div>
<div class="line"><a name="l02605"></a><span class="lineno"> 2605</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fnormentropy[NPR];</div>
<div class="line"><a name="l02606"></a><span class="lineno"> 2606</span>&#160;</div>
<div class="line"><a name="l02607"></a><span class="lineno"> 2607</span>&#160;      <span class="comment">//    fracenergy=1.0;</span></div>
<div class="line"><a name="l02608"></a><span class="lineno"> 2608</span>&#160;      <span class="keywordflow">if</span>(ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#a9f3d856dcdd8fa240dfbdcedfad888ef">startjac</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>){</div>
<div class="line"><a name="l02609"></a><span class="lineno"> 2609</span>&#160;        <span class="comment">// Get final interpolated energy-entropy-term error function</span></div>
<div class="line"><a name="l02610"></a><span class="lineno"> 2610</span>&#160;        <span class="comment">//      dualfprintf(fail_file,&quot;fracenergy=%g fUU=%g fnormUU=%g fE=%g fnormE=%g\n&quot;,fracenergy,f[UU],fnorm[UU],fentropy[ENTROPY],fnormentropy[ENTROPY]);</span></div>
<div class="line"><a name="l02611"></a><span class="lineno"> 2611</span>&#160;        f[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>] = fracenergy*fabs(f[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]) + (1.0-fracenergy)*fabs(f[ENTROPY]);</div>
<div class="line"><a name="l02612"></a><span class="lineno"> 2612</span>&#160;        fnorm[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>] = fracenergy*fnorm[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>] + (1.0-fracenergy)*fnorm[ENTROPY];</div>
<div class="line"><a name="l02613"></a><span class="lineno"> 2613</span>&#160;      }</div>
<div class="line"><a name="l02614"></a><span class="lineno"> 2614</span>&#160;    }</div>
<div class="line"><a name="l02615"></a><span class="lineno"> 2615</span>&#160;  }</div>
<div class="line"><a name="l02616"></a><span class="lineno"> 2616</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02617"></a><span class="lineno"> 2617</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l02618"></a><span class="lineno"> 2618</span>&#160;</div>
<div class="line"><a name="l02619"></a><span class="lineno"> 2619</span>&#160;</div>
<div class="line"><a name="l02620"></a><span class="lineno"> 2620</span>&#160;</div>
<div class="line"><a name="l02621"></a><span class="lineno"> 2621</span>&#160;</div>
<div class="line"><a name="l02622"></a><span class="lineno"> 2622</span>&#160;</div>
<div class="line"><a name="l02623"></a><span class="lineno"> 2623</span>&#160;</div>
<div class="line"><a name="l02625"></a><span class="lineno"> 2625</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02626"></a><span class="lineno"> 2626</span>&#160;  <span class="comment">// get alternative error</span></div>
<div class="line"><a name="l02627"></a><span class="lineno"> 2627</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02628"></a><span class="lineno"> 2628</span>&#160;  <span class="comment">// Used in case optically thin and no interaction between RAD and GAS and radiation hits ceiling/floor and then must treat as ok since no force balance will help since no G and dUgas from dUrad will be wrong (and if u_g&lt;&lt;Erf, then would wrongly affect gas despite actually G&lt;&lt;U -- and if u_g&gt;&gt;Erf would no effect on gas be caused by that happening).</span></div>
<div class="line"><a name="l02629"></a><span class="lineno"> 2629</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02631"></a><span class="lineno"> 2631</span>&#160;<span class="comment"></span><span class="preprocessor">#if(ALLOWUSEUUALT) // purpose of this is equivalent to whether one can go explicit, but overly complicated and if reduces to using alternative when not desired, then not energy-momentum conserving</span></div>
<div class="line"><a name="l02632"></a><span class="lineno"> 2632</span>&#160;<span class="preprocessor"></span>  <span class="keywordflow">if</span>(whichcall==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a439b24ca8b87220703a1f950242344b7" title="f_implicit() call types">FIMPLICITCALLTYPEF1</a> &amp;&amp; (iter==1 &amp;&amp; tautotmax&lt;<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a8913cb5d64cfec23ae1a3052930ec468">NUMEPSILON</a>) &amp;&amp; failreturn&lt;=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a3dc38d50c77a49ac41a760b684ad7aab">UTOPRIMGENWRAPPERRETURNFAILRAD</a>){<span class="comment">//FIMPLICITCALLTYPEJAC</span></div>
<div class="line"><a name="l02633"></a><span class="lineno"> 2633</span>&#160;    <span class="comment">// Have to check if really small error for alternative error, since otherwise f1iter loop won&#39;t work.</span></div>
<div class="line"><a name="l02634"></a><span class="lineno"> 2634</span>&#160;    <span class="comment">// Only check on iter==1 since if moved beyond iter=1, then must be relevant 4-force.  Only check if f1iter&gt;1 because for f1iter=1 4-force is not set yet.</span></div>
<div class="line"><a name="l02635"></a><span class="lineno"> 2635</span>&#160;</div>
<div class="line"><a name="l02636"></a><span class="lineno"> 2636</span>&#160;    <span class="comment">// have to check if unmodified iterated quantities actually have smaller error, in which case probably U-&gt;P-&gt;Unew led to Unew different from U for iterated quantities due to no normal solution without fixups.  When gas~rad in energy density, the other compnent can abosorb that error, but in limit that (say) RAD&lt;&lt;GAS, then dRAD won&#39;t register to GAS values and RAD will never converge if iterated on.</span></div>
<div class="line"><a name="l02637"></a><span class="lineno"> 2637</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> errorabsalt,errorallabsalt;</div>
<div class="line"><a name="l02638"></a><span class="lineno"> 2638</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> faltreport[NPR];</div>
<div class="line"><a name="l02639"></a><span class="lineno"> 2639</span>&#160;    <span class="keywordtype">int</span> convreturnalt=f_error_check(showmessages, showmessagesheavy, iter, conv, convabs, realdt, dimtypef,*eomtype , *radinvmod, itermode,*baseitermethod,fracenergy,dissmeasure,dimfactU,pp,piin,falt,fnorm,faltreport,Uiin,uu0,uualt,ptrgeom,&amp;errorabsalt,&amp;errorallabsalt,whicherror,mtd,ru);</div>
<div class="line"><a name="l02640"></a><span class="lineno"> 2640</span>&#160;</div>
<div class="line"><a name="l02641"></a><span class="lineno"> 2641</span>&#160;    <span class="comment">//  if(nstep&gt;=32 &amp;&amp; nstep&lt;=46){</span></div>
<div class="line"><a name="l02642"></a><span class="lineno"> 2642</span>&#160;    <span class="comment">//    PLOOP(pliter,pl) dualfprintf(fail_file,&quot;DEBUGIT: wc=%d iter=%d pl=%d uu0=%21.15g uu=%21.15g uualt=%21.15g Gdpl=%21.15g f=%21.15g falt=%21.15g errorabs=%21.15g errorabsalt=%21.15g radinvmod=%d radinvmodalt=%d failreturn=%d\n&quot;,whichcall,iter,pl,uu0[pl],uu[pl],uualt[pl],sign[pl]*localdt*Gdpl[pl],f[pl],falt[pl],*errorabs,errorabsalt,*radinvmod,radinvmodalt,failreturn);</span></div>
<div class="line"><a name="l02643"></a><span class="lineno"> 2643</span>&#160;    <span class="comment">//  }</span></div>
<div class="line"><a name="l02644"></a><span class="lineno"> 2644</span>&#160;</div>
<div class="line"><a name="l02645"></a><span class="lineno"> 2645</span>&#160;</div>
<div class="line"><a name="l02646"></a><span class="lineno"> 2646</span>&#160;</div>
<div class="line"><a name="l02647"></a><span class="lineno"> 2647</span>&#160;    <span class="comment">// see if alternative error is smaller *and* in converged limit.  Catches cases when optically thin and ok that hits radiation ceiling.</span></div>
<div class="line"><a name="l02648"></a><span class="lineno"> 2648</span>&#160;    <span class="keywordflow">if</span>(errorabsalt&lt;*errorabs &amp;&amp; convreturnalt==1){</div>
<div class="line"><a name="l02649"></a><span class="lineno"> 2649</span>&#160;      <span class="comment">//dualfprintf(fail_file,&quot;UsingALT\n&quot;);</span></div>
<div class="line"><a name="l02650"></a><span class="lineno"> 2650</span>&#160;</div>
<div class="line"><a name="l02651"></a><span class="lineno"> 2651</span>&#160;      <span class="comment">// then switch to use falt.</span></div>
<div class="line"><a name="l02652"></a><span class="lineno"> 2652</span>&#160;      <span class="comment">// This typically controls what uu is used for the error</span></div>
<div class="line"><a name="l02653"></a><span class="lineno"> 2653</span>&#160;      <span class="comment">// Eventually want uu to be consistent with pp</span></div>
<div class="line"><a name="l02654"></a><span class="lineno"> 2654</span>&#160;      <span class="comment">// But allow for possible iteration upon uualt, so want to keep uu=uualt even though not consistent with pp</span></div>
<div class="line"><a name="l02655"></a><span class="lineno"> 2655</span>&#160;      <span class="comment">// So have to fix uu(pp) once iterations are done.</span></div>
<div class="line"><a name="l02656"></a><span class="lineno"> 2656</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l02657"></a><span class="lineno"> 2657</span>&#160;        uu[pl]=uualt[pl];</div>
<div class="line"><a name="l02658"></a><span class="lineno"> 2658</span>&#160;        pp[pl]=ppalt[pl];</div>
<div class="line"><a name="l02659"></a><span class="lineno"> 2659</span>&#160;        f[pl]=falt[pl];</div>
<div class="line"><a name="l02660"></a><span class="lineno"> 2660</span>&#160;        freport[pl]=faltreport[pl];</div>
<div class="line"><a name="l02661"></a><span class="lineno"> 2661</span>&#160;      }</div>
<div class="line"><a name="l02662"></a><span class="lineno"> 2662</span>&#160;      <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a54453e145c6408911f60070de366b11a">IMPUTYPE</a>(mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>)){</div>
<div class="line"><a name="l02663"></a><span class="lineno"> 2663</span>&#160;        <span class="comment">// q based upon primitives, so if uu-method, then stuck with that q</span></div>
<div class="line"><a name="l02664"></a><span class="lineno"> 2664</span>&#160;      }</div>
<div class="line"><a name="l02665"></a><span class="lineno"> 2665</span>&#160;      <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l02666"></a><span class="lineno"> 2666</span>&#160;        <span class="comment">// get new q(ppalt) now q(pp)</span></div>
<div class="line"><a name="l02667"></a><span class="lineno"> 2667</span>&#160;        <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a11e17cd8b0594d1ad52e3594aa9f477e" title="find ucon, ucov, bcon, bcov from primitive variables when calling get_state, users of this function e...">get_state</a>(pp, ptrgeom, q);</div>
<div class="line"><a name="l02668"></a><span class="lineno"> 2668</span>&#160;        <span class="comment">// get new uu(ppalt) now uu(pp)</span></div>
<div class="line"><a name="l02669"></a><span class="lineno"> 2669</span>&#160;        <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a9a54096e4c40a15a2c1bf74266153616" title="calculate &quot;conserved&quot; quantities">primtoU</a>(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab2be21bd5eff40ca89c20eeecbeab5e0">UNOTHING</a>,pp,q,ptrgeom, uu, uuabs);</div>
<div class="line"><a name="l02670"></a><span class="lineno"> 2670</span>&#160;      }</div>
<div class="line"><a name="l02671"></a><span class="lineno"> 2671</span>&#160;      *convreturn=convreturnalt;</div>
<div class="line"><a name="l02672"></a><span class="lineno"> 2672</span>&#160;      *errorabs=errorabsalt;</div>
<div class="line"><a name="l02673"></a><span class="lineno"> 2673</span>&#160;      *errorallabs=errorallabsalt;</div>
<div class="line"><a name="l02674"></a><span class="lineno"> 2674</span>&#160;      *radinvmod=radinvmodalt;</div>
<div class="line"><a name="l02675"></a><span class="lineno"> 2675</span>&#160;      failreturn=failreturnalt;</div>
<div class="line"><a name="l02676"></a><span class="lineno"> 2676</span>&#160;    }</div>
<div class="line"><a name="l02677"></a><span class="lineno"> 2677</span>&#160;  }</div>
<div class="line"><a name="l02678"></a><span class="lineno"> 2678</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02679"></a><span class="lineno"> 2679</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l02680"></a><span class="lineno"> 2680</span>&#160;</div>
<div class="line"><a name="l02681"></a><span class="lineno"> 2681</span>&#160;</div>
<div class="line"><a name="l02682"></a><span class="lineno"> 2682</span>&#160;</div>
<div class="line"><a name="l02683"></a><span class="lineno"> 2683</span>&#160;</div>
<div class="line"><a name="l02684"></a><span class="lineno"> 2684</span>&#160;</div>
<div class="line"><a name="l02685"></a><span class="lineno"> 2685</span>&#160;</div>
<div class="line"><a name="l02686"></a><span class="lineno"> 2686</span>&#160;<span class="preprocessor">#if(PRODUCTION==0)</span></div>
<div class="line"><a name="l02687"></a><span class="lineno"> 2687</span>&#160;<span class="preprocessor"></span>  <span class="keywordflow">if</span>(debugfail&gt;=3){</div>
<div class="line"><a name="l02689"></a><span class="lineno"> 2689</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02690"></a><span class="lineno"> 2690</span>&#160;    <span class="comment">// get stats on any Utoprimgen() newton calls</span></div>
<div class="line"><a name="l02691"></a><span class="lineno"> 2691</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02693"></a><span class="lineno"> 2693</span>&#160;<span class="comment"></span>    <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> newtoncounttotal=0;</div>
<div class="line"><a name="l02694"></a><span class="lineno"> 2694</span>&#160;    newtoncounttotal+=newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a83280998e47831044a7e35299495a9bb">lntries</a>;</div>
<div class="line"><a name="l02695"></a><span class="lineno"> 2695</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> newtoncounthere=0;</div>
<div class="line"><a name="l02696"></a><span class="lineno"> 2696</span>&#160;    newtoncounthere++;</div>
<div class="line"><a name="l02697"></a><span class="lineno"> 2697</span>&#160;    dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;Newtonstat: local=%d total=%d average=%21.15g\n&quot;</span>,newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a83280998e47831044a7e35299495a9bb">lntries</a>,newtoncounttotal,(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a>)newtoncounttotal/(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a>)newtoncounthere);</div>
<div class="line"><a name="l02698"></a><span class="lineno"> 2698</span>&#160;  }  </div>
<div class="line"><a name="l02699"></a><span class="lineno"> 2699</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02700"></a><span class="lineno"> 2700</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l02701"></a><span class="lineno"> 2701</span>&#160;</div>
<div class="line"><a name="l02702"></a><span class="lineno"> 2702</span>&#160;</div>
<div class="line"><a name="l02703"></a><span class="lineno"> 2703</span>&#160;  <span class="keywordflow">if</span>(failreturn &amp;&amp; failreturn&gt;failreturnallowable){</div>
<div class="line"><a name="l02704"></a><span class="lineno"> 2704</span>&#160;    <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a7df8286c59d491ba1117884d33499a7a">prod0dualfprintf</a>(showmessages &amp;&amp; debugfail&gt;=2,<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;Utoprimgen_wrapper() failed, must return out of f_implicit(): %d vs. %d\n&quot;</span>,failreturn,failreturnallowable);</div>
<div class="line"><a name="l02705"></a><span class="lineno"> 2705</span>&#160;    <span class="keywordflow">return</span>(failreturn);</div>
<div class="line"><a name="l02706"></a><span class="lineno"> 2706</span>&#160;  }</div>
<div class="line"><a name="l02707"></a><span class="lineno"> 2707</span>&#160;</div>
<div class="line"><a name="l02708"></a><span class="lineno"> 2708</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l02709"></a><span class="lineno"> 2709</span>&#160;  <span class="comment">//  else{</span></div>
<div class="line"><a name="l02710"></a><span class="lineno"> 2710</span>&#160;  <span class="comment">//    // save better guess for later inversion (including this inversion above) from this inversion</span></div>
<div class="line"><a name="l02711"></a><span class="lineno"> 2711</span>&#160;  <span class="comment">//    PLOOP(pliter,pl) pp0[pl]=pp[pl];</span></div>
<div class="line"><a name="l02712"></a><span class="lineno"> 2712</span>&#160;  <span class="comment">//  }</span></div>
<div class="line"><a name="l02713"></a><span class="lineno"> 2713</span>&#160;} </div>
<div class="line"><a name="l02714"></a><span class="lineno"> 2714</span>&#160;</div>
<div class="line"><a name="l02715"></a><span class="lineno"> 2715</span>&#160;</div>
<div class="line"><a name="l02716"></a><span class="lineno"> 2716</span>&#160;</div>
<div class="line"><a name="l02717"></a><span class="lineno"> 2717</span>&#160;</div>
<div class="line"><a name="l02719"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5dcc789108ddf06ec44fb22770f18e90"> 2719</a></span>&#160;<span class="keyword">static</span> <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5dcc789108ddf06ec44fb22770f18e90" title="compute dt for this sub-step">compute_dt</a>(<span class="keywordtype">int</span> isexplicit, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUf, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUimp, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dtin)</div>
<div class="line"><a name="l02720"></a><span class="lineno"> 2720</span>&#160;{</div>
<div class="line"><a name="l02721"></a><span class="lineno"> 2721</span>&#160;  <span class="comment">// what&#39;s applied to source and flux terms to get update (see global.stepch.h and step_ch.c:get_truetime_fluxdt() and step_ch.c:setup_rktimestep()) to get Uf</span></div>
<div class="line"><a name="l02722"></a><span class="lineno"> 2722</span>&#160;  <span class="comment">// We don&#39;t use the ucum update version of dt.  As part of the RK method, the ucum update is separate from the substeps used to get information on updates(?). GODMARK.</span></div>
<div class="line"><a name="l02723"></a><span class="lineno"> 2723</span>&#160;</div>
<div class="line"><a name="l02724"></a><span class="lineno"> 2724</span>&#160;  <span class="keywordflow">if</span>(isexplicit==1 || isexplicit==0 &amp;&amp; <a class="code" href="../../d8/d5b/defs_8general_8h.html#a10228b0cb639e1d94eded72900312334">TIMETYPE</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a56de233d8b42babd780f075b155863fa">TIMEEXPLICIT</a>){</div>
<div class="line"><a name="l02725"></a><span class="lineno"> 2725</span>&#160;    <span class="keywordflow">return</span>(CUf[2]*dtin);</div>
<div class="line"><a name="l02726"></a><span class="lineno"> 2726</span>&#160;  }</div>
<div class="line"><a name="l02727"></a><span class="lineno"> 2727</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l02728"></a><span class="lineno"> 2728</span>&#160;    <span class="comment">// if TIMETYPE==TIMEIMPLICIT and isexplicit==0, then use implicit dt</span></div>
<div class="line"><a name="l02729"></a><span class="lineno"> 2729</span>&#160;    <span class="comment">// [0] because was fed single value at correct current stage.</span></div>
<div class="line"><a name="l02730"></a><span class="lineno"> 2730</span>&#160;    <span class="keywordflow">return</span>(CUimp[0]*dtin);</div>
<div class="line"><a name="l02731"></a><span class="lineno"> 2731</span>&#160;  }</div>
<div class="line"><a name="l02732"></a><span class="lineno"> 2732</span>&#160;}</div>
<div class="line"><a name="l02733"></a><span class="lineno"> 2733</span>&#160;</div>
<div class="line"><a name="l02734"></a><span class="lineno"> 2734</span>&#160;</div>
<div class="line"><a name="l02735"></a><span class="lineno"> 2735</span>&#160;</div>
<div class="line"><a name="l02736"></a><span class="lineno"> 2736</span>&#160;</div>
<div class="line"><a name="l02737"></a><span class="lineno"> 2737</span>&#160;</div>
<div class="line"><a name="l02738"></a><span class="lineno"> 2738</span>&#160;</div>
<div class="line"><a name="l02739"></a><span class="lineno"> 2739</span>&#160;</div>
<div class="line"><a name="l02740"></a><span class="lineno"> 2740</span>&#160;<span class="comment">// KORALTODOMAYBE: average good neighbor if can.  only use alternative backup if no good neighbor.</span></div>
<div class="line"><a name="l02741"></a><span class="lineno"> 2741</span>&#160;</div>
<div class="line"><a name="l02742"></a><span class="lineno"> 2742</span>&#160;</div>
<div class="line"><a name="l02744"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a675bb3f12a77c62cf2540bc42c4867f8"> 2744</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a675bb3f12a77c62cf2540bc42c4867f8" title="wrapper for mode method">koral_source_rad_implicit</a>(<span class="keywordtype">int</span> *eomtype, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pb, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pf, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *piin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Uiin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ufin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUf, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUimp, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *q, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dissmeasure, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *dUother ,<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*dUcomp)[NPR])</div>
<div class="line"><a name="l02745"></a><span class="lineno"> 2745</span>&#160;{</div>
<div class="line"><a name="l02746"></a><span class="lineno"> 2746</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>=ptrgeom-&gt;i;</div>
<div class="line"><a name="l02747"></a><span class="lineno"> 2747</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>=ptrgeom-&gt;j;</div>
<div class="line"><a name="l02748"></a><span class="lineno"> 2748</span>&#160;  <span class="keywordtype">int</span> k=ptrgeom-&gt;k;</div>
<div class="line"><a name="l02749"></a><span class="lineno"> 2749</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d9/d54/other6_8txt.html#a4c46d2d3bb1db943c0dce6af1c779ff5">p</a>=ptrgeom-&gt;p;</div>
<div class="line"><a name="l02750"></a><span class="lineno"> 2750</span>&#160;</div>
<div class="line"><a name="l02751"></a><span class="lineno"> 2751</span>&#160;  </div>
<div class="line"><a name="l02752"></a><span class="lineno"> 2752</span>&#160;</div>
<div class="line"><a name="l02753"></a><span class="lineno"> 2753</span>&#160;  <span class="comment">// whether SPC</span></div>
<div class="line"><a name="l02754"></a><span class="lineno"> 2754</span>&#160;  <span class="keywordtype">int</span> isspc=<a class="code" href="../../d2/dbf/metric_8h.html#a720c791e54d46bbf744b0e3ed7050947">ISSPCMCOORD</a>(<a class="code" href="../../da/d3e/definit_8h.html#ab343edb2f60f3de2d654dcf1c58e06a2" title="#else define MAXBND 3 endif">MCOORD</a>);</div>
<div class="line"><a name="l02755"></a><span class="lineno"> 2755</span>&#160;  <span class="comment">// whether SPC with BH</span></div>
<div class="line"><a name="l02756"></a><span class="lineno"> 2756</span>&#160;  <span class="keywordtype">int</span> isbhspc=<a class="code" href="../../d2/dbf/metric_8h.html#a720c791e54d46bbf744b0e3ed7050947">ISSPCMCOORD</a>(<a class="code" href="../../da/d3e/definit_8h.html#ab343edb2f60f3de2d654dcf1c58e06a2" title="#else define MAXBND 3 endif">MCOORD</a>) &amp;&amp; <a class="code" href="../../d2/dbf/metric_8h.html#abd133696cea6c0c1397c24e925e5039a">ISBLACKHOLEMCOORD</a>(<a class="code" href="../../da/d3e/definit_8h.html#ab343edb2f60f3de2d654dcf1c58e06a2" title="#else define MAXBND 3 endif">MCOORD</a>);</div>
<div class="line"><a name="l02757"></a><span class="lineno"> 2757</span>&#160;</div>
<div class="line"><a name="l02759"></a><span class="lineno"> 2759</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02760"></a><span class="lineno"> 2760</span>&#160;  <span class="comment">// get coordinate position of cell</span></div>
<div class="line"><a name="l02761"></a><span class="lineno"> 2761</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02763"></a><span class="lineno"> 2763</span>&#160;<span class="comment"></span>  <span class="keywordtype">int</span> iiii=ptrgeom-&gt;i;</div>
<div class="line"><a name="l02764"></a><span class="lineno"> 2764</span>&#160;  <span class="keywordtype">int</span> jjjj=ptrgeom-&gt;j;</div>
<div class="line"><a name="l02765"></a><span class="lineno"> 2765</span>&#160;  <span class="keywordtype">int</span> kkkk=ptrgeom-&gt;k;</div>
<div class="line"><a name="l02766"></a><span class="lineno"> 2766</span>&#160;  <span class="keywordtype">int</span> llloc=ptrgeom-&gt;p;</div>
<div class="line"><a name="l02767"></a><span class="lineno"> 2767</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> <a class="code" href="../../dc/dd2/newcodediff_8txt.html#af84f2c3bf153920b7c8d186132d39bc7">V</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>]={0.0};</div>
<div class="line"><a name="l02768"></a><span class="lineno"> 2768</span>&#160;  <a class="code" href="../../d9/de9/coord_8c.html#a96290375e27d5d0aa4d843b07e228e14" title="normally-used bl_coord[i,j,k] {i,j,k} -&gt; V only">bl_coord_ijk</a>(iiii,jjjj,kkkk,llloc,V);</div>
<div class="line"><a name="l02769"></a><span class="lineno"> 2769</span>&#160;</div>
<div class="line"><a name="l02770"></a><span class="lineno"> 2770</span>&#160;</div>
<div class="line"><a name="l02771"></a><span class="lineno"> 2771</span>&#160;  <span class="keywordtype">int</span> modemethodlocal=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8eca1a0ead33f844741e3b377159d1cc" title="choose to switch to entropy only if energy fails or gives u_g&lt;0.">MODEMETHOD</a>;</div>
<div class="line"><a name="l02772"></a><span class="lineno"> 2772</span>&#160;  <span class="keywordtype">int</span> reducetoquick=0;</div>
<div class="line"><a name="l02773"></a><span class="lineno"> 2773</span>&#160;</div>
<div class="line"><a name="l02774"></a><span class="lineno"> 2774</span>&#160;  <span class="keywordflow">if</span>(isspc){</div>
<div class="line"><a name="l02775"></a><span class="lineno"> 2775</span>&#160;    <span class="comment">// tj=-2,-1,0,1 work</span></div>
<div class="line"><a name="l02776"></a><span class="lineno"> 2776</span>&#160;    <span class="comment">// tj=ts2+1,ts2,ts2-1,ts2-2 work</span></div>
<div class="line"><a name="l02777"></a><span class="lineno"> 2777</span>&#160;    <span class="comment">// revert to simple mode if POLEDEATH is active because then anyways solution near pole is inaccurate and whatever generated here would be overwritten.</span></div>
<div class="line"><a name="l02778"></a><span class="lineno"> 2778</span>&#160;    <span class="comment">// doing this because with or without poledeath active, the poles often find no solution at all or at least not with the fast PMHD method, so the pole alone causes things to slow down alot for the whole code.</span></div>
<div class="line"><a name="l02779"></a><span class="lineno"> 2779</span>&#160;    <span class="keywordtype">int</span> EXTRAPOLEDEATH=0,localpoledeath=0;</div>
<div class="line"><a name="l02780"></a><span class="lineno"> 2780</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> tj=(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a>)(<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[2]+j);</div>
<div class="line"><a name="l02781"></a><span class="lineno"> 2781</span>&#160;</div>
<div class="line"><a name="l02782"></a><span class="lineno"> 2782</span>&#160;    EXTRAPOLEDEATH=<a class="code" href="../../da/d3e/definit_8h.html#a88cb3506d0a1bef85a81d360800da67a">POLEDEATH</a>;</div>
<div class="line"><a name="l02783"></a><span class="lineno"> 2783</span>&#160;    localpoledeath=<a class="code" href="../../da/d3e/definit_8h.html#a88cb3506d0a1bef85a81d360800da67a">POLEDEATH</a> + EXTRAPOLEDEATH;</div>
<div class="line"><a name="l02784"></a><span class="lineno"> 2784</span>&#160;    <span class="keywordflow">if</span>(fabs(tj+0.5 - (<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a>)(0))&lt;(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a>)localpoledeath || fabs(tj+0.5-(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a>)<a class="code" href="../../dd/d46/mpidefs_8h.html#ab3efab8b1f2dffc5907e0b0a5aa3988f">totalsize</a>[2])&lt;(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a>)localpoledeath){</div>
<div class="line"><a name="l02785"></a><span class="lineno"> 2785</span>&#160;      modemethodlocal=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a861070760a7e713342da86a4c8bfa660">MODEPICKBESTSIMPLE</a>;</div>
<div class="line"><a name="l02786"></a><span class="lineno"> 2786</span>&#160;      reducetoquick=2;</div>
<div class="line"><a name="l02787"></a><span class="lineno"> 2787</span>&#160;      <span class="comment">//    dualfprintf(fail_file,&quot;j=%d modechange\n&quot;,j); // debug</span></div>
<div class="line"><a name="l02788"></a><span class="lineno"> 2788</span>&#160;    }</div>
<div class="line"><a name="l02789"></a><span class="lineno"> 2789</span>&#160;</div>
<div class="line"><a name="l02790"></a><span class="lineno"> 2790</span>&#160;</div>
<div class="line"><a name="l02791"></a><span class="lineno"> 2791</span>&#160;</div>
<div class="line"><a name="l02792"></a><span class="lineno"> 2792</span>&#160;    EXTRAPOLEDEATH=1;</div>
<div class="line"><a name="l02793"></a><span class="lineno"> 2793</span>&#160;    localpoledeath=<a class="code" href="../../da/d3e/definit_8h.html#a88cb3506d0a1bef85a81d360800da67a">POLEDEATH</a> + EXTRAPOLEDEATH;</div>
<div class="line"><a name="l02794"></a><span class="lineno"> 2794</span>&#160;    <span class="keywordflow">if</span>(fabs(tj+0.5 - (<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a>)(0))&lt;(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a>)localpoledeath || fabs(tj+0.5-(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a>)<a class="code" href="../../dd/d46/mpidefs_8h.html#ab3efab8b1f2dffc5907e0b0a5aa3988f">totalsize</a>[2])&lt;(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a>)localpoledeath){</div>
<div class="line"><a name="l02795"></a><span class="lineno"> 2795</span>&#160;      modemethodlocal=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a861070760a7e713342da86a4c8bfa660">MODEPICKBESTSIMPLE</a>;</div>
<div class="line"><a name="l02796"></a><span class="lineno"> 2796</span>&#160;      reducetoquick=2;</div>
<div class="line"><a name="l02797"></a><span class="lineno"> 2797</span>&#160;      <span class="comment">//    dualfprintf(fail_file,&quot;j=%d modechange\n&quot;,j); // debug</span></div>
<div class="line"><a name="l02798"></a><span class="lineno"> 2798</span>&#160;    }</div>
<div class="line"><a name="l02799"></a><span class="lineno"> 2799</span>&#160;</div>
<div class="line"><a name="l02800"></a><span class="lineno"> 2800</span>&#160;    <span class="keywordflow">if</span>(fabs(tj+0.5 - (<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a>)(0))&lt;(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a>)<a class="code" href="../../da/d3e/definit_8h.html#a88cb3506d0a1bef85a81d360800da67a">POLEDEATH</a> || fabs(tj+0.5-(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a>)<a class="code" href="../../dd/d46/mpidefs_8h.html#ab3efab8b1f2dffc5907e0b0a5aa3988f">totalsize</a>[2])&lt;(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a>)<a class="code" href="../../da/d3e/definit_8h.html#a88cb3506d0a1bef85a81d360800da67a">POLEDEATH</a>){</div>
<div class="line"><a name="l02801"></a><span class="lineno"> 2801</span>&#160;      modemethodlocal=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a861070760a7e713342da86a4c8bfa660">MODEPICKBESTSIMPLE</a>;</div>
<div class="line"><a name="l02802"></a><span class="lineno"> 2802</span>&#160;      <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#af3ef7e5751424f76e939639f0e8b53f5">LIMITEDPOLEDEATHINRADIUS</a> &amp;&amp; isbhspc){</div>
<div class="line"><a name="l02803"></a><span class="lineno"> 2803</span>&#160;        <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Rhorref=rhor_calc(0);</div>
<div class="line"><a name="l02804"></a><span class="lineno"> 2804</span>&#160;      </div>
<div class="line"><a name="l02805"></a><span class="lineno"> 2805</span>&#160;        <span class="keywordflow">if</span>( (1||V[1]&gt;0.9*Rhorref) &amp;&amp; (V[1]&lt;<a class="code" href="../../da/d3e/definit_8h.html#a96144cf19084532e7fa17366b1b4b5b9">OUTERDEATHRADIUS</a> &amp;&amp; <a class="code" href="../../da/d3e/definit_8h.html#aa2b0c5dd91e7e776f8944c26ff7ecf0b">OUTERDEATH</a>==1 || <a class="code" href="../../da/d3e/definit_8h.html#aa2b0c5dd91e7e776f8944c26ff7ecf0b">OUTERDEATH</a>==0)) reducetoquick=2;</div>
<div class="line"><a name="l02806"></a><span class="lineno"> 2806</span>&#160;        <span class="keywordflow">else</span> reducetoquick=1;</div>
<div class="line"><a name="l02807"></a><span class="lineno"> 2807</span>&#160;      }</div>
<div class="line"><a name="l02808"></a><span class="lineno"> 2808</span>&#160;      <span class="keywordflow">else</span> reducetoquick=1;</div>
<div class="line"><a name="l02809"></a><span class="lineno"> 2809</span>&#160;    }</div>
<div class="line"><a name="l02810"></a><span class="lineno"> 2810</span>&#160;  }<span class="comment">// end if isspc</span></div>
<div class="line"><a name="l02811"></a><span class="lineno"> 2811</span>&#160;</div>
<div class="line"><a name="l02812"></a><span class="lineno"> 2812</span>&#160;</div>
<div class="line"><a name="l02813"></a><span class="lineno"> 2813</span>&#160;</div>
<div class="line"><a name="l02814"></a><span class="lineno"> 2814</span>&#160;</div>
<div class="line"><a name="l02815"></a><span class="lineno"> 2815</span>&#160;</div>
<div class="line"><a name="l02816"></a><span class="lineno"> 2816</span>&#160; </div>
<div class="line"><a name="l02817"></a><span class="lineno"> 2817</span>&#160;</div>
<div class="line"><a name="l02818"></a><span class="lineno"> 2818</span>&#160;</div>
<div class="line"><a name="l02819"></a><span class="lineno"> 2819</span>&#160;</div>
<div class="line"><a name="l02820"></a><span class="lineno"> 2820</span>&#160;  <span class="keywordtype">int</span> pliter,pl;</div>
<div class="line"><a name="l02821"></a><span class="lineno"> 2821</span>&#160;  <span class="keywordtype">int</span> sc;</div>
<div class="line"><a name="l02822"></a><span class="lineno"> 2822</span>&#160;</div>
<div class="line"><a name="l02823"></a><span class="lineno"> 2823</span>&#160;  <span class="keywordtype">int</span> failreturn,noprims;</div>
<div class="line"><a name="l02824"></a><span class="lineno"> 2824</span>&#160;  <span class="keywordtype">int</span> havebackup,didentropyalready;</div>
<div class="line"><a name="l02825"></a><span class="lineno"> 2825</span>&#160;  <span class="keywordtype">int</span> usedenergy=0,usedentropy=0,usedboth=0,usedcold=0,usedimplicit=0,usedexplicitgood=0,usedexplicitkindabad=0,usedexplicitbad=0;</div>
<div class="line"><a name="l02826"></a><span class="lineno"> 2826</span>&#160;  <span class="keywordtype">int</span> methodindex[<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#acb843c30a487185fc9ae1e5460a19284" title="array indices for prioritermethod">NUMPRIORITERMETHODINDEX</a>]={0};</div>
<div class="line"><a name="l02827"></a><span class="lineno"> 2827</span>&#160;  <span class="keywordtype">int</span> ooo;</div>
<div class="line"><a name="l02828"></a><span class="lineno"> 2828</span>&#160;  <span class="keywordflow">for</span>(ooo=0;ooo&lt;<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#acb843c30a487185fc9ae1e5460a19284" title="array indices for prioritermethod">NUMPRIORITERMETHODINDEX</a>;ooo++){</div>
<div class="line"><a name="l02829"></a><span class="lineno"> 2829</span>&#160;    methodindex[ooo]=<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a5b3bcf4eaf08299f68268d75a01a0f9b">PRIORITERMETHODNOTSET</a>;</div>
<div class="line"><a name="l02830"></a><span class="lineno"> 2830</span>&#160;  }</div>
<div class="line"><a name="l02831"></a><span class="lineno"> 2831</span>&#160;</div>
<div class="line"><a name="l02832"></a><span class="lineno"> 2832</span>&#160;  <span class="comment">// set backups that might change and contaminate a fresh start</span></div>
<div class="line"><a name="l02833"></a><span class="lineno"> 2833</span>&#160;  <span class="comment">// piin, Uiin, Ufin, CUf, CUimp, ptrgeom, dUother don&#39;t change, rest can.</span></div>
<div class="line"><a name="l02834"></a><span class="lineno"> 2834</span>&#160;  <span class="keywordtype">int</span> failfinalreturn;</div>
<div class="line"><a name="l02835"></a><span class="lineno"> 2835</span>&#160;  <span class="keywordtype">int</span> eomtypelocal;</div>
<div class="line"><a name="l02836"></a><span class="lineno"> 2836</span>&#160;</div>
<div class="line"><a name="l02837"></a><span class="lineno"> 2837</span>&#160;</div>
<div class="line"><a name="l02838"></a><span class="lineno"> 2838</span>&#160;</div>
<div class="line"><a name="l02840"></a><span class="lineno"> 2840</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02841"></a><span class="lineno"> 2841</span>&#160;  <span class="comment">// Setup pb and uub that hold final primitive and conserved solutions</span></div>
<div class="line"><a name="l02842"></a><span class="lineno"> 2842</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02844"></a><span class="lineno"> 2844</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02846"></a><span class="lineno"> 2846</span>&#160;  <span class="comment">// set full uu0</span></div>
<div class="line"><a name="l02847"></a><span class="lineno"> 2847</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fracdtuu0=1.0;</div>
<div class="line"><a name="l02848"></a><span class="lineno"> 2848</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> uu0[NPR],dUtot[NPR],rdUtot[NPR];</div>
<div class="line"><a name="l02849"></a><span class="lineno"> 2849</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dUnongeomall[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0a72db4856620ff1b9551c885f1b32b5">MAXTIMEORDER</a>]={0.0};</div>
<div class="line"><a name="l02850"></a><span class="lineno"> 2850</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l02851"></a><span class="lineno"> 2851</span>&#160;    uu0[pl]=UFSET(CUf,fracdtuu0*<a class="code" href="../../d8/d5b/defs_8general_8h.html#a56db625f31229c5e8b208ff27d464931">dt</a>,Uiin[pl],Ufin[pl],dUother[pl],0.0,dUnongeomall); <span class="comment">// initial+flux value of U.  Only feed in full CUf, not CUimp</span></div>
<div class="line"><a name="l02852"></a><span class="lineno"> 2852</span>&#160;    dUtot[pl] = uu0[pl]-Uiin[pl]; <span class="comment">// absolute change due to flux-advection step</span></div>
<div class="line"><a name="l02853"></a><span class="lineno"> 2853</span>&#160;    rdUtot[pl] = fabs(uu0[pl]-Uiin[pl])/(fabs(uu0[pl])+fabs(Uiin[pl])); <span class="comment">// relative change to energy due to flux-advection step</span></div>
<div class="line"><a name="l02854"></a><span class="lineno"> 2854</span>&#160;  }</div>
<div class="line"><a name="l02855"></a><span class="lineno"> 2855</span>&#160;</div>
<div class="line"><a name="l02856"></a><span class="lineno"> 2856</span>&#160;  <span class="comment">// but we end up modifying pb, not pf.</span></div>
<div class="line"><a name="l02857"></a><span class="lineno"> 2857</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> uub[NPR]; <span class="comment">// holds returned uu from implicit solver</span></div>
<div class="line"><a name="l02858"></a><span class="lineno"> 2858</span>&#160;  <span class="comment">// for implicit scheme, set pf-&gt;pb in case pf contains final time information like the magnetic field</span></div>
<div class="line"><a name="l02859"></a><span class="lineno"> 2859</span>&#160;  <span class="comment">// at this point, pb=pf was used to compute Flux(pb=pf), while uu0 is result of that flux.  Best for optically thin regime, but better guess limits used in actual solver.</span></div>
<div class="line"><a name="l02860"></a><span class="lineno"> 2860</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l02861"></a><span class="lineno"> 2861</span>&#160;    pb[pl] = pf[pl]; <span class="comment">// piin[pl];</span></div>
<div class="line"><a name="l02862"></a><span class="lineno"> 2862</span>&#160;    uub[pl] = uu0[pl]; <span class="comment">//Uiin[pl];  // at this point, best approximation can make, but do better in solver itself</span></div>
<div class="line"><a name="l02863"></a><span class="lineno"> 2863</span>&#160;  }</div>
<div class="line"><a name="l02864"></a><span class="lineno"> 2864</span>&#160;</div>
<div class="line"><a name="l02865"></a><span class="lineno"> 2865</span>&#160;</div>
<div class="line"><a name="l02866"></a><span class="lineno"> 2866</span>&#160;</div>
<div class="line"><a name="l02868"></a><span class="lineno"> 2868</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02869"></a><span class="lineno"> 2869</span>&#160;  <span class="comment">// setup backup&#39;s for reversions of starting guess or solution</span></div>
<div class="line"><a name="l02870"></a><span class="lineno"> 2870</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02872"></a><span class="lineno"> 2872</span>&#160;<span class="comment"></span>  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> pbbackup[NPR];</div>
<div class="line"><a name="l02873"></a><span class="lineno"> 2873</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> uubbackup[NPR];</div>
<div class="line"><a name="l02874"></a><span class="lineno"> 2874</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dUcompbackup[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ac34589654a83c911addd1fda0898e738">NUMSOURCES</a>][NPR];</div>
<div class="line"><a name="l02875"></a><span class="lineno"> 2875</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> qbackup;</div>
<div class="line"><a name="l02876"></a><span class="lineno"> 2876</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l02877"></a><span class="lineno"> 2877</span>&#160;    pbbackup[pl]=pb[pl];  <span class="comment">// at this point, best approximation can make, but do better in solver itself</span></div>
<div class="line"><a name="l02878"></a><span class="lineno"> 2878</span>&#160;    uubbackup[pl]=uub[pl]; <span class="comment">// at this point, best approximation can make, but do better in solver itself</span></div>
<div class="line"><a name="l02879"></a><span class="lineno"> 2879</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a2da8b12fca78064531b9b64e5699e4fc" title="loop over ALL sources (including geometry)">SCLOOP</a>(sc) dUcompbackup[sc][pl]=dUcomp[sc][pl]; <span class="comment">// stores dUcomp so far computed from other physical terms</span></div>
<div class="line"><a name="l02880"></a><span class="lineno"> 2880</span>&#160;  }</div>
<div class="line"><a name="l02881"></a><span class="lineno"> 2881</span>&#160;  qbackup=*q;  <span class="comment">// at this point, best approximation can make, but do better in solver itself</span></div>
<div class="line"><a name="l02882"></a><span class="lineno"> 2882</span>&#160;</div>
<div class="line"><a name="l02883"></a><span class="lineno"> 2883</span>&#160;</div>
<div class="line"><a name="l02885"></a><span class="lineno"> 2885</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02886"></a><span class="lineno"> 2886</span>&#160;  <span class="comment">// It&#39;s up to inversion method to set failure flags, not utoprimgen() that just checks them mostly (it might modify them based upon doing reductions).</span></div>
<div class="line"><a name="l02887"></a><span class="lineno"> 2887</span>&#160;  <span class="comment">// setup pflags</span></div>
<div class="line"><a name="l02888"></a><span class="lineno"> 2888</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02890"></a><span class="lineno"> 2890</span>&#160;<span class="comment"></span>  <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflag,*lpflagrad;</div>
<div class="line"><a name="l02891"></a><span class="lineno"> 2891</span>&#160;  lpflag=&amp;GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>);</div>
<div class="line"><a name="l02892"></a><span class="lineno"> 2892</span>&#160;  lpflagrad=&amp;GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>);</div>
<div class="line"><a name="l02893"></a><span class="lineno"> 2893</span>&#160;  <span class="comment">// set default</span></div>
<div class="line"><a name="l02894"></a><span class="lineno"> 2894</span>&#160;  *lpflag=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#abdf9e55b7b15ec0bcd386055f1787f47">UTOPRIMNOFAIL</a>;</div>
<div class="line"><a name="l02895"></a><span class="lineno"> 2895</span>&#160;  *lpflagrad=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6435e9609d622c9dbaf78c12658ecf8e">UTOPRIMRADNOFAIL</a>;</div>
<div class="line"><a name="l02896"></a><span class="lineno"> 2896</span>&#160;</div>
<div class="line"><a name="l02897"></a><span class="lineno"> 2897</span>&#160;</div>
<div class="line"><a name="l02899"></a><span class="lineno"> 2899</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02900"></a><span class="lineno"> 2900</span>&#160;  <span class="comment">// default is didn&#39;t get good primitives.  Similar, but slightly different from, failreturn</span></div>
<div class="line"><a name="l02901"></a><span class="lineno"> 2901</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02903"></a><span class="lineno"> 2903</span>&#160;<span class="comment"></span>  failreturn=1;</div>
<div class="line"><a name="l02904"></a><span class="lineno"> 2904</span>&#160;  noprims=1;</div>
<div class="line"><a name="l02905"></a><span class="lineno"> 2905</span>&#160;  usedenergy=0;</div>
<div class="line"><a name="l02906"></a><span class="lineno"> 2906</span>&#160;  usedentropy=0;</div>
<div class="line"><a name="l02907"></a><span class="lineno"> 2907</span>&#160;  usedboth=0;</div>
<div class="line"><a name="l02908"></a><span class="lineno"> 2908</span>&#160;  usedcold=0;</div>
<div class="line"><a name="l02909"></a><span class="lineno"> 2909</span>&#160;  usedimplicit=0;</div>
<div class="line"><a name="l02910"></a><span class="lineno"> 2910</span>&#160;</div>
<div class="line"><a name="l02911"></a><span class="lineno"> 2911</span>&#160;</div>
<div class="line"><a name="l02912"></a><span class="lineno"> 2912</span>&#160;  <span class="comment">// whether doing energy at all</span></div>
<div class="line"><a name="l02913"></a><span class="lineno"> 2913</span>&#160;  <span class="keywordtype">int</span> eomtypecond[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a09cb09ce3ceea3f2bfc212d30027898a">NUMEOMTYPES</a>];</div>
<div class="line"><a name="l02914"></a><span class="lineno"> 2914</span>&#160;  eomtypecond[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6f6094bc467dc61f9490ad7e1de63580">EOMFFDE</a>]=(*eomtype==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6f6094bc467dc61f9490ad7e1de63580">EOMFFDE</a> || *eomtype==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aa28b06d889a02621b45edc716bfb2d01">EOMDEFAULT</a> &amp;&amp; <a class="code" href="../../da/d3e/definit_8h.html#a87e5572748e4cc27373e50bd78e6f2e8">EOMTYPE</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6f6094bc467dc61f9490ad7e1de63580">EOMFFDE</a>);</div>
<div class="line"><a name="l02915"></a><span class="lineno"> 2915</span>&#160;  eomtypecond[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a30a753538ac3bf4801ac123a37dfcc57">EOMFFDE2</a>]=(*eomtype==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a30a753538ac3bf4801ac123a37dfcc57">EOMFFDE2</a> || *eomtype==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aa28b06d889a02621b45edc716bfb2d01">EOMDEFAULT</a> &amp;&amp; EOMTYPE==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a30a753538ac3bf4801ac123a37dfcc57">EOMFFDE2</a>);</div>
<div class="line"><a name="l02916"></a><span class="lineno"> 2916</span>&#160;  eomtypecond[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a757ad8b9c2c7611dad8aab853a87f61b">EOMCOLDGRMHD</a>]=(*eomtype==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a757ad8b9c2c7611dad8aab853a87f61b">EOMCOLDGRMHD</a> || *eomtype==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aa28b06d889a02621b45edc716bfb2d01">EOMDEFAULT</a> &amp;&amp; EOMTYPE==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a757ad8b9c2c7611dad8aab853a87f61b">EOMCOLDGRMHD</a>);</div>
<div class="line"><a name="l02917"></a><span class="lineno"> 2917</span>&#160;  eomtypecond[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a40b55e98bfcccde1a3f19d983ca7488c">EOMENTROPYGRMHD</a>]=(*eomtype==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a40b55e98bfcccde1a3f19d983ca7488c">EOMENTROPYGRMHD</a> || *eomtype==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aa28b06d889a02621b45edc716bfb2d01">EOMDEFAULT</a> &amp;&amp; EOMTYPE==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a40b55e98bfcccde1a3f19d983ca7488c">EOMENTROPYGRMHD</a>);</div>
<div class="line"><a name="l02918"></a><span class="lineno"> 2918</span>&#160;  eomtypecond[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a03d89f51ab60206791830c886d62bfd0">EOMGRMHD</a>]=(*eomtype==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a03d89f51ab60206791830c886d62bfd0">EOMGRMHD</a> || *eomtype==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aa28b06d889a02621b45edc716bfb2d01">EOMDEFAULT</a> &amp;&amp; EOMTYPE==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a03d89f51ab60206791830c886d62bfd0">EOMGRMHD</a>);</div>
<div class="line"><a name="l02919"></a><span class="lineno"> 2919</span>&#160;  <span class="keywordtype">int</span> testeom,counteom=0;</div>
<div class="line"><a name="l02920"></a><span class="lineno"> 2920</span>&#160;  <span class="keywordflow">for</span>(testeom=0;testeom&lt;<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a09cb09ce3ceea3f2bfc212d30027898a">NUMEOMTYPES</a>;testeom++) <span class="keywordflow">if</span>(eomtypecond[testeom]) counteom++;</div>
<div class="line"><a name="l02921"></a><span class="lineno"> 2921</span>&#160;  <span class="keywordflow">if</span>(counteom&gt;1){</div>
<div class="line"><a name="l02922"></a><span class="lineno"> 2922</span>&#160;    dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;Too many default eomtypeconds\n&quot;</span>);</div>
<div class="line"><a name="l02923"></a><span class="lineno"> 2923</span>&#160;    <span class="keywordflow">for</span>(testeom=0;testeom&lt;<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a09cb09ce3ceea3f2bfc212d30027898a">NUMEOMTYPES</a>;testeom++) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;%d %d\n&quot;</span>,testeom,eomtypecond[testeom]);</div>
<div class="line"><a name="l02924"></a><span class="lineno"> 2924</span>&#160;    myexit(843968364);</div>
<div class="line"><a name="l02925"></a><span class="lineno"> 2925</span>&#160;  }</div>
<div class="line"><a name="l02926"></a><span class="lineno"> 2926</span>&#160;</div>
<div class="line"><a name="l02927"></a><span class="lineno"> 2927</span>&#160;</div>
<div class="line"><a name="l02929"></a><span class="lineno"> 2929</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02930"></a><span class="lineno"> 2930</span>&#160;  <span class="comment">// diags</span></div>
<div class="line"><a name="l02931"></a><span class="lineno"> 2931</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02933"></a><span class="lineno"> 2933</span>&#160;<span class="comment"></span>  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> errorabs[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa63447acbbbc62cbedae23eac61c716e" title="determine which error will use when deciding if converged or not.">NUMERRORTYPES</a>]={1}; <span class="comment">// 0: over iterated pl and 1: over full relavant pl</span></div>
<div class="line"><a name="l02934"></a><span class="lineno"> 2934</span>&#160;  <span class="keywordtype">int</span> iters=0;</div>
<div class="line"><a name="l02935"></a><span class="lineno"> 2935</span>&#160;  <span class="keywordtype">int</span> f1iters=0;</div>
<div class="line"><a name="l02936"></a><span class="lineno"> 2936</span>&#160;  <span class="keywordtype">int</span> nummhdinvs=0;</div>
<div class="line"><a name="l02937"></a><span class="lineno"> 2937</span>&#160;  <span class="keywordtype">int</span> nummhdsteps=0;</div>
<div class="line"><a name="l02938"></a><span class="lineno"> 2938</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fracenergy;</div>
<div class="line"><a name="l02939"></a><span class="lineno"> 2939</span>&#160;  <span class="keywordtype">int</span> itermode;</div>
<div class="line"><a name="l02940"></a><span class="lineno"> 2940</span>&#160;  <span class="keywordtype">int</span> baseitermethod;</div>
<div class="line"><a name="l02941"></a><span class="lineno"> 2941</span>&#160;  <span class="keywordtype">int</span> radinvmod=0;</div>
<div class="line"><a name="l02942"></a><span class="lineno"> 2942</span>&#160;  <span class="keywordtype">int</span> whichcap;</div>
<div class="line"><a name="l02943"></a><span class="lineno"> 2943</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> trueimptryconv=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afc9b116343212081b674a39ac69ce6ed" title="Funny, even 1E-5 does ok with torus, no worse at Erf~ERADLIMIT instances. Also, does ~3 iterations...">IMPTRYCONV</a>;</div>
<div class="line"><a name="l02944"></a><span class="lineno"> 2944</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> trueimpokconv=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#af7b72bf07e905af920a80341cad3ec60">IMPOKCONV</a>;</div>
<div class="line"><a name="l02945"></a><span class="lineno"> 2945</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> trueimpallowconv=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab1ad1aee2202922457a377be53918cdc" title="what tolerance to use for saying can switch to entropy when u_g is suggested to be bad for energy...">IMPALLOWCONVCONST</a>;</div>
<div class="line"><a name="l02946"></a><span class="lineno"> 2946</span>&#160;  <span class="keywordtype">int</span> trueimpmaxiter=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a58cca3253f4dfcefde5fe864699e297a">IMPMAXITERLONG</a>;</div>
<div class="line"><a name="l02947"></a><span class="lineno"> 2947</span>&#160;  <span class="keywordtype">int</span> truenumdampattempts=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a05f68af4806f09b5fcb143348da66be1">NUMDAMPATTEMPTS</a>;</div>
<div class="line"><a name="l02948"></a><span class="lineno"> 2948</span>&#160;  <span class="keywordtype">int</span> goexplicit;</div>
<div class="line"><a name="l02949"></a><span class="lineno"> 2949</span>&#160;</div>
<div class="line"><a name="l02950"></a><span class="lineno"> 2950</span>&#160;</div>
<div class="line"><a name="l02951"></a><span class="lineno"> 2951</span>&#160;</div>
<div class="line"><a name="l02952"></a><span class="lineno"> 2952</span>&#160;</div>
<div class="line"><a name="l02953"></a><span class="lineno"> 2953</span>&#160;</div>
<div class="line"><a name="l02954"></a><span class="lineno"> 2954</span>&#160;</div>
<div class="line"><a name="l02956"></a><span class="lineno"> 2956</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02957"></a><span class="lineno"> 2957</span>&#160;  <span class="comment">// MODEENERGY</span></div>
<div class="line"><a name="l02958"></a><span class="lineno"> 2958</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02960"></a><span class="lineno"> 2960</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02961"></a><span class="lineno"> 2961</span>&#160;  <span class="keywordflow">if</span>(modemethodlocal==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a1709aa547ab47de8fe7217642a226eb1">MODEENERGY</a> &amp;&amp; eomtypecond[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a03d89f51ab60206791830c886d62bfd0">EOMGRMHD</a>]==1 || modemethodlocal==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a46b689a25732194a759b43d32ac1570c" title="mode for inversion">MODEDEFAULT</a> &amp;&amp; *eomtype==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a03d89f51ab60206791830c886d62bfd0">EOMGRMHD</a>){</div>
<div class="line"><a name="l02962"></a><span class="lineno"> 2962</span>&#160;    havebackup=0;</div>
<div class="line"><a name="l02963"></a><span class="lineno"> 2963</span>&#160;    didentropyalready=0;</div>
<div class="line"><a name="l02964"></a><span class="lineno"> 2964</span>&#160;    eomtypelocal=*eomtype;</div>
<div class="line"><a name="l02965"></a><span class="lineno"> 2965</span>&#160;    errorabs[0]=errorabs[1]=1.0;</div>
<div class="line"><a name="l02966"></a><span class="lineno"> 2966</span>&#160;    fracenergy=1.0;</div>
<div class="line"><a name="l02967"></a><span class="lineno"> 2967</span>&#160;    itermode=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a480c56e263c4874ccb40f3bbc1b32032">ITERMODESTAGES</a>;</div>
<div class="line"><a name="l02968"></a><span class="lineno"> 2968</span>&#160;    baseitermethod=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9cf5ca7f5e5aa1e0bdef53abe3f27c1c">QTYPMHD</a>;</div>
<div class="line"><a name="l02969"></a><span class="lineno"> 2969</span>&#160;    <span class="comment">//itermode=ITERMODENORMAL;</span></div>
<div class="line"><a name="l02970"></a><span class="lineno"> 2970</span>&#160;    <span class="comment">//    baseitermethod=QTYURAD;</span></div>
<div class="line"><a name="l02971"></a><span class="lineno"> 2971</span>&#160;</div>
<div class="line"><a name="l02972"></a><span class="lineno"> 2972</span>&#160;    <span class="comment">// NOTES: ITERMODESTAGES with QTYPMHD always goes to damp and sometimes fails with RADTUBE.  Lots of Jsub issues, etc.  Probably not right.  Compared to ramesh code, settles on different u -- far too large even though error in f1[0] small.</span></div>
<div class="line"><a name="l02973"></a><span class="lineno"> 2973</span>&#160;    <span class="comment">// Actually, if don&#39;t switch to PRAD, goes kinda ok with only 2 early failures, but needs to damp every time.  Can&#39;t be right.  So 2 issues.  Very broad iteration tail.</span></div>
<div class="line"><a name="l02974"></a><span class="lineno"> 2974</span>&#160;</div>
<div class="line"><a name="l02975"></a><span class="lineno"> 2975</span>&#160;    <span class="comment">// but, ITERMODESTAGES with QTYURAD does fine, even if takes more iterations.</span></div>
<div class="line"><a name="l02976"></a><span class="lineno"> 2976</span>&#160;    <span class="comment">// but, ITERMODESTAGES with QTYPRAD does kinda ok, 6 early bads and ~20 damps, but then settles.</span></div>
<div class="line"><a name="l02977"></a><span class="lineno"> 2977</span>&#160;</div>
<div class="line"><a name="l02978"></a><span class="lineno"> 2978</span>&#160;    whichcap=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a4b6c6060c025e15f1d92aae3dcb9365b" title="which cap type to place in rad inversion">CAPTYPEBASIC</a>;</div>
<div class="line"><a name="l02979"></a><span class="lineno"> 2979</span>&#160;    failreturn=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a17aede36203a236390363af78d3a86f0" title="compute changes to U (both T and R) using implicit method KORALTODO: If doing implicit, should also add geometry source term that can sometimes be stiff.">koral_source_rad_implicit_mode</a>(modemethodlocal,1,0,havebackup, didentropyalready, &amp;eomtypelocal, whichcap, itermode, &amp;baseitermethod, trueimptryconv, trueimpokconv, trueimpallowconv, trueimpmaxiter,  truenumdampattempts, fracenergy, dissmeasure, &amp;radinvmod, pb, uub, piin, Uiin, Ufin, CUf, CUimp, ptrgeom, q, dUother ,dUcomp, errorabs, errorabs, &amp;iters, &amp;f1iters, &amp;nummhdinvs, &amp;nummhdsteps);</div>
<div class="line"><a name="l02980"></a><span class="lineno"> 2980</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a98e2c94d4fc861c61bc8dde7b4eec734">ACTUALHARDFAILURE</a>(failreturn)){</div>
<div class="line"><a name="l02981"></a><span class="lineno"> 2981</span>&#160;      failfinalreturn=1;</div>
<div class="line"><a name="l02982"></a><span class="lineno"> 2982</span>&#160;      *lpflag=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2de5944abdafe2f29ef970d24869a883">UTOPRIMFAILCONV</a>;</div>
<div class="line"><a name="l02983"></a><span class="lineno"> 2983</span>&#160;      *lpflagrad=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aba9c5f566b4227c5e5d8faef0f62e4e6" title="locally fixed inversion problems (as possible sometimes with radiation): see phys.tools.rad.c:u2p_rad()">UTOPRIMRADFAILCASE1A</a>;</div>
<div class="line"><a name="l02984"></a><span class="lineno"> 2984</span>&#160;      <span class="comment">// restore backups in case got contaminated</span></div>
<div class="line"><a name="l02985"></a><span class="lineno"> 2985</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l02986"></a><span class="lineno"> 2986</span>&#160;        pb[pl]=pbbackup[pl];</div>
<div class="line"><a name="l02987"></a><span class="lineno"> 2987</span>&#160;        uub[pl]=uubbackup[pl];</div>
<div class="line"><a name="l02988"></a><span class="lineno"> 2988</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a2da8b12fca78064531b9b64e5699e4fc" title="loop over ALL sources (including geometry)">SCLOOP</a>(sc) dUcomp[sc][pl]=dUcompbackup[sc][pl];</div>
<div class="line"><a name="l02989"></a><span class="lineno"> 2989</span>&#160;      }</div>
<div class="line"><a name="l02990"></a><span class="lineno"> 2990</span>&#160;      *q=qbackup;</div>
<div class="line"><a name="l02991"></a><span class="lineno"> 2991</span>&#160;      goexplicit=0;</div>
<div class="line"><a name="l02992"></a><span class="lineno"> 2992</span>&#160;      usedimplicit=1;</div>
<div class="line"><a name="l02993"></a><span class="lineno"> 2993</span>&#160;    }</div>
<div class="line"><a name="l02994"></a><span class="lineno"> 2994</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(failreturn&gt;=0){</div>
<div class="line"><a name="l02995"></a><span class="lineno"> 2995</span>&#160;      failfinalreturn=0;</div>
<div class="line"><a name="l02996"></a><span class="lineno"> 2996</span>&#160;      noprims=0;</div>
<div class="line"><a name="l02997"></a><span class="lineno"> 2997</span>&#160;      *eomtype=eomtypelocal; <span class="comment">// can be EOMDONOTHING if successful and small enough error</span></div>
<div class="line"><a name="l02998"></a><span class="lineno"> 2998</span>&#160;      usedenergy=1;</div>
<div class="line"><a name="l02999"></a><span class="lineno"> 2999</span>&#160;      goexplicit=0;</div>
<div class="line"><a name="l03000"></a><span class="lineno"> 3000</span>&#160;      usedimplicit=1;</div>
<div class="line"><a name="l03001"></a><span class="lineno"> 3001</span>&#160;    }</div>
<div class="line"><a name="l03002"></a><span class="lineno"> 3002</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l03003"></a><span class="lineno"> 3003</span>&#160;      failfinalreturn=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a04634949fd2370214f3d313c9cffa182">FAILRETURNGOTRIVIALEXPLICIT</a>; <span class="comment">// indicates to koral_source_rad() that implicit says just do trivial explicit</span></div>
<div class="line"><a name="l03004"></a><span class="lineno"> 3004</span>&#160;      noprims=1;</div>
<div class="line"><a name="l03005"></a><span class="lineno"> 3005</span>&#160;      *eomtype=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a03d89f51ab60206791830c886d62bfd0">EOMGRMHD</a>;</div>
<div class="line"><a name="l03006"></a><span class="lineno"> 3006</span>&#160;      goexplicit=1;</div>
<div class="line"><a name="l03007"></a><span class="lineno"> 3007</span>&#160;      usedexplicitgood=1;</div>
<div class="line"><a name="l03008"></a><span class="lineno"> 3008</span>&#160;    }</div>
<div class="line"><a name="l03009"></a><span class="lineno"> 3009</span>&#160;  }</div>
<div class="line"><a name="l03010"></a><span class="lineno"> 3010</span>&#160;</div>
<div class="line"><a name="l03012"></a><span class="lineno"> 3012</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l03013"></a><span class="lineno"> 3013</span>&#160;  <span class="comment">// MODEENTROPY</span></div>
<div class="line"><a name="l03014"></a><span class="lineno"> 3014</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l03016"></a><span class="lineno"> 3016</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03017"></a><span class="lineno"> 3017</span>&#160;  <span class="keywordflow">if</span>(modemethodlocal==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a4a43b43a71e57c3e1b7ede96343723d4">MODEENTROPY</a> || modemethodlocal==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a46b689a25732194a759b43d32ac1570c" title="mode for inversion">MODEDEFAULT</a> &amp;&amp; *eomtype==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a40b55e98bfcccde1a3f19d983ca7488c">EOMENTROPYGRMHD</a>){</div>
<div class="line"><a name="l03018"></a><span class="lineno"> 3018</span>&#160;    havebackup=0;</div>
<div class="line"><a name="l03019"></a><span class="lineno"> 3019</span>&#160;    didentropyalready=0;</div>
<div class="line"><a name="l03020"></a><span class="lineno"> 3020</span>&#160;    eomtypelocal=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a40b55e98bfcccde1a3f19d983ca7488c">EOMENTROPYGRMHD</a>;</div>
<div class="line"><a name="l03021"></a><span class="lineno"> 3021</span>&#160;    errorabs[0]=errorabs[1]=1.0;</div>
<div class="line"><a name="l03022"></a><span class="lineno"> 3022</span>&#160;    fracenergy=0.0;</div>
<div class="line"><a name="l03023"></a><span class="lineno"> 3023</span>&#160;    itermode=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a480c56e263c4874ccb40f3bbc1b32032">ITERMODESTAGES</a>;</div>
<div class="line"><a name="l03024"></a><span class="lineno"> 3024</span>&#160;    whichcap=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a4b6c6060c025e15f1d92aae3dcb9365b" title="which cap type to place in rad inversion">CAPTYPEBASIC</a>;</div>
<div class="line"><a name="l03025"></a><span class="lineno"> 3025</span>&#160;    baseitermethod=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9cf5ca7f5e5aa1e0bdef53abe3f27c1c">QTYPMHD</a>;</div>
<div class="line"><a name="l03026"></a><span class="lineno"> 3026</span>&#160;    failreturn=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a17aede36203a236390363af78d3a86f0" title="compute changes to U (both T and R) using implicit method KORALTODO: If doing implicit, should also add geometry source term that can sometimes be stiff.">koral_source_rad_implicit_mode</a>(modemethodlocal,1,0,havebackup, didentropyalready, &amp;eomtypelocal, whichcap, itermode, &amp;baseitermethod, trueimptryconv, trueimpokconv, trueimpallowconv, trueimpmaxiter,  truenumdampattempts, fracenergy, dissmeasure, &amp;radinvmod, pb, uub, piin, Uiin, Ufin, CUf, CUimp, ptrgeom, q, dUother ,dUcomp, errorabs, errorabs, &amp;iters, &amp;f1iters, &amp;nummhdinvs, &amp;nummhdsteps);</div>
<div class="line"><a name="l03027"></a><span class="lineno"> 3027</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a98e2c94d4fc861c61bc8dde7b4eec734">ACTUALHARDFAILURE</a>(failreturn)){</div>
<div class="line"><a name="l03028"></a><span class="lineno"> 3028</span>&#160;      failfinalreturn=1;</div>
<div class="line"><a name="l03029"></a><span class="lineno"> 3029</span>&#160;      *lpflag=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2de5944abdafe2f29ef970d24869a883">UTOPRIMFAILCONV</a>;</div>
<div class="line"><a name="l03030"></a><span class="lineno"> 3030</span>&#160;      *lpflagrad=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aba9c5f566b4227c5e5d8faef0f62e4e6" title="locally fixed inversion problems (as possible sometimes with radiation): see phys.tools.rad.c:u2p_rad()">UTOPRIMRADFAILCASE1A</a>;</div>
<div class="line"><a name="l03031"></a><span class="lineno"> 3031</span>&#160;      <span class="comment">// restore backups in case got contaminated</span></div>
<div class="line"><a name="l03032"></a><span class="lineno"> 3032</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l03033"></a><span class="lineno"> 3033</span>&#160;        pb[pl]=pbbackup[pl];</div>
<div class="line"><a name="l03034"></a><span class="lineno"> 3034</span>&#160;        uub[pl]=uubbackup[pl];</div>
<div class="line"><a name="l03035"></a><span class="lineno"> 3035</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a2da8b12fca78064531b9b64e5699e4fc" title="loop over ALL sources (including geometry)">SCLOOP</a>(sc) dUcomp[sc][pl]=dUcompbackup[sc][pl];</div>
<div class="line"><a name="l03036"></a><span class="lineno"> 3036</span>&#160;      }</div>
<div class="line"><a name="l03037"></a><span class="lineno"> 3037</span>&#160;      *q=qbackup;</div>
<div class="line"><a name="l03038"></a><span class="lineno"> 3038</span>&#160;      goexplicit=0;</div>
<div class="line"><a name="l03039"></a><span class="lineno"> 3039</span>&#160;      usedimplicit=1;</div>
<div class="line"><a name="l03040"></a><span class="lineno"> 3040</span>&#160;    }</div>
<div class="line"><a name="l03041"></a><span class="lineno"> 3041</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(failreturn&gt;=0){</div>
<div class="line"><a name="l03042"></a><span class="lineno"> 3042</span>&#160;      failfinalreturn=0;</div>
<div class="line"><a name="l03043"></a><span class="lineno"> 3043</span>&#160;      noprims=0;</div>
<div class="line"><a name="l03044"></a><span class="lineno"> 3044</span>&#160;      *eomtype=eomtypelocal; <span class="comment">// can be EOMDONOTHING if successful and small enough error</span></div>
<div class="line"><a name="l03045"></a><span class="lineno"> 3045</span>&#160;      usedentropy=1;</div>
<div class="line"><a name="l03046"></a><span class="lineno"> 3046</span>&#160;      goexplicit=0;</div>
<div class="line"><a name="l03047"></a><span class="lineno"> 3047</span>&#160;      usedimplicit=1;</div>
<div class="line"><a name="l03048"></a><span class="lineno"> 3048</span>&#160;    }</div>
<div class="line"><a name="l03049"></a><span class="lineno"> 3049</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l03050"></a><span class="lineno"> 3050</span>&#160;      failfinalreturn=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a04634949fd2370214f3d313c9cffa182">FAILRETURNGOTRIVIALEXPLICIT</a>; <span class="comment">// indicates to koral_source_rad() that implicit says just do trivial explicit</span></div>
<div class="line"><a name="l03051"></a><span class="lineno"> 3051</span>&#160;      noprims=1;</div>
<div class="line"><a name="l03052"></a><span class="lineno"> 3052</span>&#160;      *eomtype=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a40b55e98bfcccde1a3f19d983ca7488c">EOMENTROPYGRMHD</a>;</div>
<div class="line"><a name="l03053"></a><span class="lineno"> 3053</span>&#160;      goexplicit=1;</div>
<div class="line"><a name="l03054"></a><span class="lineno"> 3054</span>&#160;      usedexplicitgood=1;</div>
<div class="line"><a name="l03055"></a><span class="lineno"> 3055</span>&#160;    }</div>
<div class="line"><a name="l03056"></a><span class="lineno"> 3056</span>&#160;  }</div>
<div class="line"><a name="l03057"></a><span class="lineno"> 3057</span>&#160;</div>
<div class="line"><a name="l03058"></a><span class="lineno"> 3058</span>&#160;</div>
<div class="line"><a name="l03059"></a><span class="lineno"> 3059</span>&#160;</div>
<div class="line"><a name="l03060"></a><span class="lineno"> 3060</span>&#160;</div>
<div class="line"><a name="l03061"></a><span class="lineno"> 3061</span>&#160;</div>
<div class="line"><a name="l03062"></a><span class="lineno"> 3062</span>&#160;  <span class="keywordflow">if</span>(modemethodlocal==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a815a98f4901ee0860cd4123eb6489c73">MODEENERGYRAMESH</a>&amp;&amp;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a4e881a6dce34b0b9f03a77b9d9c11c9c" title="whether to use ramesh solver as backup">USERAMESH</a>){</div>
<div class="line"><a name="l03063"></a><span class="lineno"> 3063</span>&#160;    <span class="comment">// these ramesh solutions are here so both entropy and energy can have chance to fill them.</span></div>
<div class="line"><a name="l03064"></a><span class="lineno"> 3064</span>&#160;    <span class="keywordtype">int</span> gotrameshsolution=0;</div>
<div class="line"><a name="l03065"></a><span class="lineno"> 3065</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ppeng[NPR]={0},ppent[NPR]={0},errorabseng[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa63447acbbbc62cbedae23eac61c716e" title="determine which error will use when deciding if converged or not.">NUMERRORTYPES</a>],errorabsent[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa63447acbbbc62cbedae23eac61c716e" title="determine which error will use when deciding if converged or not.">NUMERRORTYPES</a>];</div>
<div class="line"><a name="l03066"></a><span class="lineno"> 3066</span>&#160;    set_array(errorabseng,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa63447acbbbc62cbedae23eac61c716e" title="determine which error will use when deciding if converged or not.">NUMERRORTYPES</a>,MPI_FTYPE,1.0);</div>
<div class="line"><a name="l03067"></a><span class="lineno"> 3067</span>&#160;    set_array(errorabsent,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa63447acbbbc62cbedae23eac61c716e" title="determine which error will use when deciding if converged or not.">NUMERRORTYPES</a>,MPI_FTYPE,1.0);</div>
<div class="line"><a name="l03068"></a><span class="lineno"> 3068</span>&#160;    <span class="keywordtype">int</span> failtypeeng=1,failtypeent=1,iterseng=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a58cca3253f4dfcefde5fe864699e297a">IMPMAXITERLONG</a>,itersent=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a58cca3253f4dfcefde5fe864699e297a">IMPMAXITERLONG</a>,radinvmodeng=-1,radinvmodent=-1;</div>
<div class="line"><a name="l03069"></a><span class="lineno"> 3069</span>&#160;    <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> qeng, qent;</div>
<div class="line"><a name="l03070"></a><span class="lineno"> 3070</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> uueng[NPR]={0.0},uuent[NPR]={0.0};</div>
<div class="line"><a name="l03071"></a><span class="lineno"> 3071</span>&#160;    qeng=qbackup;</div>
<div class="line"><a name="l03072"></a><span class="lineno"> 3072</span>&#160;    qent=qbackup;</div>
<div class="line"><a name="l03073"></a><span class="lineno"> 3073</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dUcompeng[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ac34589654a83c911addd1fda0898e738">NUMSOURCES</a>][NPR],dUcompent[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ac34589654a83c911addd1fda0898e738">NUMSOURCES</a>][NPR];</div>
<div class="line"><a name="l03074"></a><span class="lineno"> 3074</span>&#160;</div>
<div class="line"><a name="l03075"></a><span class="lineno"> 3075</span>&#160;</div>
<div class="line"><a name="l03076"></a><span class="lineno"> 3076</span>&#160;    goexplicit=0; <span class="comment">// force since no explicit check</span></div>
<div class="line"><a name="l03077"></a><span class="lineno"> 3077</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> errorabsforramesh[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa63447acbbbc62cbedae23eac61c716e" title="determine which error will use when deciding if converged or not.">NUMERRORTYPES</a>];</div>
<div class="line"><a name="l03078"></a><span class="lineno"> 3078</span>&#160;    set_array(errorabsforramesh,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa63447acbbbc62cbedae23eac61c716e" title="determine which error will use when deciding if converged or not.">NUMERRORTYPES</a>,MPI_FTYPE,1.0);</div>
<div class="line"><a name="l03079"></a><span class="lineno"> 3079</span>&#160;</div>
<div class="line"><a name="l03080"></a><span class="lineno"> 3080</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l03081"></a><span class="lineno"> 3081</span>&#160;      pb[pl]=pbbackup[pl];</div>
<div class="line"><a name="l03082"></a><span class="lineno"> 3082</span>&#160;      uub[pl]=uubbackup[pl];</div>
<div class="line"><a name="l03083"></a><span class="lineno"> 3083</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a2da8b12fca78064531b9b64e5699e4fc" title="loop over ALL sources (including geometry)">SCLOOP</a>(sc) dUcompeng[sc][pl]=dUcomp[sc][pl]=dUcompbackup[sc][pl];</div>
<div class="line"><a name="l03084"></a><span class="lineno"> 3084</span>&#160;    }</div>
<div class="line"><a name="l03085"></a><span class="lineno"> 3085</span>&#160;    *q=qbackup;</div>
<div class="line"><a name="l03086"></a><span class="lineno"> 3086</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l03087"></a><span class="lineno"> 3087</span>&#160;    <span class="comment">// BEGIN GET RAMESH SOLUTION</span></div>
<div class="line"><a name="l03088"></a><span class="lineno"> 3088</span>&#160;    failreturn=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab0abd953f677a44020dc50259c410486">FAILRETURNGENERAL</a>;<span class="comment">// default to fail</span></div>
<div class="line"><a name="l03089"></a><span class="lineno"> 3089</span>&#160;    *eomtype=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a03d89f51ab60206791830c886d62bfd0">EOMGRMHD</a>;</div>
<div class="line"><a name="l03090"></a><span class="lineno"> 3090</span>&#160;    <span class="keywordtype">int</span> whichcall=*eomtype;</div>
<div class="line"><a name="l03091"></a><span class="lineno"> 3091</span>&#160;    get_rameshsolution_wrapper(whichcall, *eomtype, errorabsforramesh, ptrgeom, pb, piin, Uiin, Ufin, dUother, CUf, CUimp, q, ppeng, ppent, uueng, uuent, dUcompeng, dUcompent, &amp;qeng, &amp;qent, &amp;failtypeeng, errorabseng, &amp;iterseng, &amp;radinvmodeng, &amp;failtypeent, errorabsent, &amp;itersent, &amp;radinvmodent);</div>
<div class="line"><a name="l03092"></a><span class="lineno"> 3092</span>&#160;    gotrameshsolution=1; <span class="comment">// indicates did at least attempt ramesh soltion call</span></div>
<div class="line"><a name="l03093"></a><span class="lineno"> 3093</span>&#160;    <span class="comment">// translate</span></div>
<div class="line"><a name="l03094"></a><span class="lineno"> 3094</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l03095"></a><span class="lineno"> 3095</span>&#160;      pb[pl]=ppeng[pl];</div>
<div class="line"><a name="l03096"></a><span class="lineno"> 3096</span>&#160;      uub[pl]=uueng[pl];</div>
<div class="line"><a name="l03097"></a><span class="lineno"> 3097</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a2da8b12fca78064531b9b64e5699e4fc" title="loop over ALL sources (including geometry)">SCLOOP</a>(sc) dUcomp[sc][pl]=dUcompeng[sc][pl];</div>
<div class="line"><a name="l03098"></a><span class="lineno"> 3098</span>&#160;    }</div>
<div class="line"><a name="l03099"></a><span class="lineno"> 3099</span>&#160;    *q=qeng;</div>
<div class="line"><a name="l03100"></a><span class="lineno"> 3100</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l03101"></a><span class="lineno"> 3101</span>&#160;    *lpflag=*lpflagrad=(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a>)failtypeeng; <span class="comment">// need better translation</span></div>
<div class="line"><a name="l03102"></a><span class="lineno"> 3102</span>&#160;    radinvmod=radinvmodeng;</div>
<div class="line"><a name="l03103"></a><span class="lineno"> 3103</span>&#160;    <span class="comment">//    radErfneg=0; // not allowed, considered BADNEG type</span></div>
<div class="line"><a name="l03104"></a><span class="lineno"> 3104</span>&#160;    iters=iterseng;</div>
<div class="line"><a name="l03105"></a><span class="lineno"> 3105</span>&#160;    errorabs[0]=errorabseng[0];</div>
<div class="line"><a name="l03106"></a><span class="lineno"> 3106</span>&#160;    errorabs[1]=errorabseng[1];</div>
<div class="line"><a name="l03107"></a><span class="lineno"> 3107</span>&#160;    <span class="keywordflow">if</span>(failtypeeng || errorabs[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>]&gt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8469a53eb25c0eb3b81286c364d0e7f3">IMPALLOWCONVCONSTABS</a>){</div>
<div class="line"><a name="l03108"></a><span class="lineno"> 3108</span>&#160;      failfinalreturn=1;</div>
<div class="line"><a name="l03109"></a><span class="lineno"> 3109</span>&#160;      failreturn=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab0abd953f677a44020dc50259c410486">FAILRETURNGENERAL</a>; *eomtype=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a03d89f51ab60206791830c886d62bfd0">EOMGRMHD</a>;</div>
<div class="line"><a name="l03110"></a><span class="lineno"> 3110</span>&#160;      <span class="comment">// restore backups in case got contaminated</span></div>
<div class="line"><a name="l03111"></a><span class="lineno"> 3111</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l03112"></a><span class="lineno"> 3112</span>&#160;        pb[pl]=pbbackup[pl];</div>
<div class="line"><a name="l03113"></a><span class="lineno"> 3113</span>&#160;        uub[pl]=uubbackup[pl];</div>
<div class="line"><a name="l03114"></a><span class="lineno"> 3114</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a2da8b12fca78064531b9b64e5699e4fc" title="loop over ALL sources (including geometry)">SCLOOP</a>(sc) dUcomp[sc][pl]=dUcompbackup[sc][pl];</div>
<div class="line"><a name="l03115"></a><span class="lineno"> 3115</span>&#160;      }</div>
<div class="line"><a name="l03116"></a><span class="lineno"> 3116</span>&#160;      *q=qbackup;</div>
<div class="line"><a name="l03117"></a><span class="lineno"> 3117</span>&#160;      goexplicit=0;</div>
<div class="line"><a name="l03118"></a><span class="lineno"> 3118</span>&#160;      usedimplicit=1;</div>
<div class="line"><a name="l03119"></a><span class="lineno"> 3119</span>&#160;    }</div>
<div class="line"><a name="l03120"></a><span class="lineno"> 3120</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(errorabs[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>]&lt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a37aa5c4b7b1b481299d87bf929d13b15" title="error for comparing to sum over all absolute errors">IMPTRYCONVABS</a>){</div>
<div class="line"><a name="l03121"></a><span class="lineno"> 3121</span>&#160;      failfinalreturn=0;</div>
<div class="line"><a name="l03122"></a><span class="lineno"> 3122</span>&#160;      failreturn=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a3d6e4da5640133efaad94738c97e5171">FAILRETURNNOFAIL</a>;</div>
<div class="line"><a name="l03123"></a><span class="lineno"> 3123</span>&#160;      noprims=0;</div>
<div class="line"><a name="l03124"></a><span class="lineno"> 3124</span>&#160;      *eomtype=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a04d93d33dd8dba356800fa12cb80064e">EOMDIDGRMHD</a>;</div>
<div class="line"><a name="l03125"></a><span class="lineno"> 3125</span>&#160;      usedenergy=1;</div>
<div class="line"><a name="l03126"></a><span class="lineno"> 3126</span>&#160;      goexplicit=0;</div>
<div class="line"><a name="l03127"></a><span class="lineno"> 3127</span>&#160;      usedimplicit=1;</div>
<div class="line"><a name="l03128"></a><span class="lineno"> 3128</span>&#160;    }</div>
<div class="line"><a name="l03129"></a><span class="lineno"> 3129</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l03130"></a><span class="lineno"> 3130</span>&#160;      failreturn=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a45adfa493bc8ab6857a43a11d9d649d1">FAILRETURNNOTTOLERROR</a>; *eomtype=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a04d93d33dd8dba356800fa12cb80064e">EOMDIDGRMHD</a>;</div>
<div class="line"><a name="l03131"></a><span class="lineno"> 3131</span>&#160;      failfinalreturn=1;</div>
<div class="line"><a name="l03132"></a><span class="lineno"> 3132</span>&#160;      noprims=1;</div>
<div class="line"><a name="l03133"></a><span class="lineno"> 3133</span>&#160;      *eomtype=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a03d89f51ab60206791830c886d62bfd0">EOMGRMHD</a>;</div>
<div class="line"><a name="l03134"></a><span class="lineno"> 3134</span>&#160;      usedenergy=1;</div>
<div class="line"><a name="l03135"></a><span class="lineno"> 3135</span>&#160;      goexplicit=0;</div>
<div class="line"><a name="l03136"></a><span class="lineno"> 3136</span>&#160;      usedimplicit=1;</div>
<div class="line"><a name="l03137"></a><span class="lineno"> 3137</span>&#160;    }</div>
<div class="line"><a name="l03138"></a><span class="lineno"> 3138</span>&#160;    <span class="comment">// END GET RAMESH SOLUTION</span></div>
<div class="line"><a name="l03139"></a><span class="lineno"> 3139</span>&#160;  }</div>
<div class="line"><a name="l03140"></a><span class="lineno"> 3140</span>&#160;</div>
<div class="line"><a name="l03141"></a><span class="lineno"> 3141</span>&#160;</div>
<div class="line"><a name="l03142"></a><span class="lineno"> 3142</span>&#160;</div>
<div class="line"><a name="l03143"></a><span class="lineno"> 3143</span>&#160;</div>
<div class="line"><a name="l03145"></a><span class="lineno"> 3145</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l03146"></a><span class="lineno"> 3146</span>&#160;  <span class="comment">// MODESWITCH</span></div>
<div class="line"><a name="l03147"></a><span class="lineno"> 3147</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l03149"></a><span class="lineno"> 3149</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03150"></a><span class="lineno"> 3150</span>&#160;  <span class="keywordflow">if</span>(modemethodlocal==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a043322c33ae57b6a9e693b469d89ed61">MODESWITCH</a> &amp;&amp; eomtypecond[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a03d89f51ab60206791830c886d62bfd0">EOMGRMHD</a>]==1){</div>
<div class="line"><a name="l03151"></a><span class="lineno"> 3151</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> errorabsenergy[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa63447acbbbc62cbedae23eac61c716e" title="determine which error will use when deciding if converged or not.">NUMERRORTYPES</a>],errorabsentropy[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa63447acbbbc62cbedae23eac61c716e" title="determine which error will use when deciding if converged or not.">NUMERRORTYPES</a>];</div>
<div class="line"><a name="l03152"></a><span class="lineno"> 3152</span>&#160;    set_array(errorabsenergy,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa63447acbbbc62cbedae23eac61c716e" title="determine which error will use when deciding if converged or not.">NUMERRORTYPES</a>,MPI_FTYPE,1.0);</div>
<div class="line"><a name="l03153"></a><span class="lineno"> 3153</span>&#160;    set_array(errorabsentropy,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa63447acbbbc62cbedae23eac61c716e" title="determine which error will use when deciding if converged or not.">NUMERRORTYPES</a>,MPI_FTYPE,1.0);</div>
<div class="line"><a name="l03154"></a><span class="lineno"> 3154</span>&#160;</div>
<div class="line"><a name="l03155"></a><span class="lineno"> 3155</span>&#160;    <span class="keywordtype">int</span> itersenergy=0,itersentropy=0;</div>
<div class="line"><a name="l03156"></a><span class="lineno"> 3156</span>&#160;    <span class="keywordtype">int</span> f1itersenergy=0,f1itersentropy=0;</div>
<div class="line"><a name="l03157"></a><span class="lineno"> 3157</span>&#160;    <span class="keywordtype">int</span> nummhdinvsenergy=0,nummhdinvsentropy=0;</div>
<div class="line"><a name="l03158"></a><span class="lineno"> 3158</span>&#160;    <span class="keywordtype">int</span> nummhdstepsenergy=0,nummhdstepsentropy=0;</div>
<div class="line"><a name="l03159"></a><span class="lineno"> 3159</span>&#160;    <span class="keywordtype">int</span> itermodeenergy,itermodeentropy;</div>
<div class="line"><a name="l03160"></a><span class="lineno"> 3160</span>&#160;    <span class="keywordtype">int</span> baseitermethodenergy,baseitermethodentropy;</div>
<div class="line"><a name="l03161"></a><span class="lineno"> 3161</span>&#160;    <span class="keywordtype">int</span> whichcapenergy,whichcapentropy;</div>
<div class="line"><a name="l03162"></a><span class="lineno"> 3162</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> trueimptryconvenergy,trueimptryconventropy;</div>
<div class="line"><a name="l03163"></a><span class="lineno"> 3163</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> trueimpokconvenergy,trueimpokconventropy;</div>
<div class="line"><a name="l03164"></a><span class="lineno"> 3164</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> trueimpallowconvenergy,trueimpallowconventropy;</div>
<div class="line"><a name="l03165"></a><span class="lineno"> 3165</span>&#160;    <span class="keywordtype">int</span> trueimpmaxiterenergy,trueimpmaxiterentropy;</div>
<div class="line"><a name="l03166"></a><span class="lineno"> 3166</span>&#160;    <span class="keywordtype">int</span> truenumdampattemptsenergy,truenumdampattemptsentropy;</div>
<div class="line"><a name="l03167"></a><span class="lineno"> 3167</span>&#160;    <span class="keywordtype">int</span> failreturnenergy=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab0abd953f677a44020dc50259c410486">FAILRETURNGENERAL</a>; <span class="comment">// default</span></div>
<div class="line"><a name="l03168"></a><span class="lineno"> 3168</span>&#160;    <span class="keywordtype">int</span> failreturnentropy=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab0abd953f677a44020dc50259c410486">FAILRETURNGENERAL</a>; <span class="comment">// default</span></div>
<div class="line"><a name="l03169"></a><span class="lineno"> 3169</span>&#160;</div>
<div class="line"><a name="l03170"></a><span class="lineno"> 3170</span>&#160;    eomtypelocal=*eomtype;</div>
<div class="line"><a name="l03171"></a><span class="lineno"> 3171</span>&#160;    havebackup=1; <span class="comment">// only time this is used is here where we tell energy that we have backup method, so can give up quickly.</span></div>
<div class="line"><a name="l03172"></a><span class="lineno"> 3172</span>&#160;    didentropyalready=0;</div>
<div class="line"><a name="l03173"></a><span class="lineno"> 3173</span>&#160;    fracenergy=1.0;</div>
<div class="line"><a name="l03174"></a><span class="lineno"> 3174</span>&#160;    errorabsenergy[0]=errorabsenergy[1]=1.0;</div>
<div class="line"><a name="l03175"></a><span class="lineno"> 3175</span>&#160;    itermodeenergy=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a480c56e263c4874ccb40f3bbc1b32032">ITERMODESTAGES</a>;</div>
<div class="line"><a name="l03176"></a><span class="lineno"> 3176</span>&#160;    whichcapenergy=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a4b6c6060c025e15f1d92aae3dcb9365b" title="which cap type to place in rad inversion">CAPTYPEBASIC</a>;</div>
<div class="line"><a name="l03177"></a><span class="lineno"> 3177</span>&#160;    trueimptryconvenergy=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afc9b116343212081b674a39ac69ce6ed" title="Funny, even 1E-5 does ok with torus, no worse at Erf~ERADLIMIT instances. Also, does ~3 iterations...">IMPTRYCONV</a>;</div>
<div class="line"><a name="l03178"></a><span class="lineno"> 3178</span>&#160;    trueimpokconvenergy=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a03803ff5190d70024aafd3b27bfa2f61">IMPOKCONVCONST</a>;</div>
<div class="line"><a name="l03179"></a><span class="lineno"> 3179</span>&#160;    trueimpallowconvenergy=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab1ad1aee2202922457a377be53918cdc" title="what tolerance to use for saying can switch to entropy when u_g is suggested to be bad for energy...">IMPALLOWCONVCONST</a>;</div>
<div class="line"><a name="l03180"></a><span class="lineno"> 3180</span>&#160;    trueimpmaxiterenergy=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a58cca3253f4dfcefde5fe864699e297a">IMPMAXITERLONG</a>;</div>
<div class="line"><a name="l03181"></a><span class="lineno"> 3181</span>&#160;    truenumdampattemptsenergy=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a05f68af4806f09b5fcb143348da66be1">NUMDAMPATTEMPTS</a>;</div>
<div class="line"><a name="l03182"></a><span class="lineno"> 3182</span>&#160;    baseitermethodenergy=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9cf5ca7f5e5aa1e0bdef53abe3f27c1c">QTYPMHD</a>;</div>
<div class="line"><a name="l03183"></a><span class="lineno"> 3183</span>&#160;    failreturnenergy=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a17aede36203a236390363af78d3a86f0" title="compute changes to U (both T and R) using implicit method KORALTODO: If doing implicit, should also add geometry source term that can sometimes be stiff.">koral_source_rad_implicit_mode</a>(modemethodlocal,1,0,havebackup, didentropyalready, &amp;eomtypelocal, whichcapenergy, itermodeenergy, &amp;baseitermethodenergy, trueimptryconvenergy, trueimpokconvenergy, trueimpallowconvenergy, trueimpmaxiterenergy,  truenumdampattemptsenergy, fracenergy, dissmeasure, &amp;radinvmod, pb, uub, piin, Uiin, Ufin, CUf, CUimp, ptrgeom, q, dUother ,dUcomp, errorabsenergy, errorabsenergy, &amp;itersenergy, &amp;f1itersenergy, &amp;nummhdinvsenergy, &amp;nummhdstepsenergy);</div>
<div class="line"><a name="l03184"></a><span class="lineno"> 3184</span>&#160;    nummhdsteps+=nummhdstepsenergy;</div>
<div class="line"><a name="l03185"></a><span class="lineno"> 3185</span>&#160;</div>
<div class="line"><a name="l03186"></a><span class="lineno"> 3186</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ac395c8ff6ec1c393b5081c4e54c5742e">SWITCHGOODIDEAFAILURE</a>(failreturn) &amp;&amp; eomtypecond[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a03d89f51ab60206791830c886d62bfd0">EOMGRMHD</a>]){</div>
<div class="line"><a name="l03187"></a><span class="lineno"> 3187</span>&#160;      <span class="comment">// if failed with GRMHD or return reported switching to entropy is preferred, then do entropy method</span></div>
<div class="line"><a name="l03188"></a><span class="lineno"> 3188</span>&#160;      eomtypelocal=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a40b55e98bfcccde1a3f19d983ca7488c">EOMENTROPYGRMHD</a>;</div>
<div class="line"><a name="l03189"></a><span class="lineno"> 3189</span>&#160;      <span class="comment">// restore backups for fresh start</span></div>
<div class="line"><a name="l03190"></a><span class="lineno"> 3190</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l03191"></a><span class="lineno"> 3191</span>&#160;        pb[pl]=pbbackup[pl];</div>
<div class="line"><a name="l03192"></a><span class="lineno"> 3192</span>&#160;        uub[pl]=uubbackup[pl];</div>
<div class="line"><a name="l03193"></a><span class="lineno"> 3193</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a2da8b12fca78064531b9b64e5699e4fc" title="loop over ALL sources (including geometry)">SCLOOP</a>(sc) dUcomp[sc][pl]=dUcompbackup[sc][pl];</div>
<div class="line"><a name="l03194"></a><span class="lineno"> 3194</span>&#160;      }</div>
<div class="line"><a name="l03195"></a><span class="lineno"> 3195</span>&#160;      *q=qbackup;</div>
<div class="line"><a name="l03196"></a><span class="lineno"> 3196</span>&#160;      <span class="comment">// get fresh start entropy solution</span></div>
<div class="line"><a name="l03197"></a><span class="lineno"> 3197</span>&#160;      havebackup=0;</div>
<div class="line"><a name="l03198"></a><span class="lineno"> 3198</span>&#160;      didentropyalready=0;</div>
<div class="line"><a name="l03199"></a><span class="lineno"> 3199</span>&#160;      fracenergy=0.0;</div>
<div class="line"><a name="l03200"></a><span class="lineno"> 3200</span>&#160;      errorabsentropy[0]=errorabsentropy[1]=1.0;</div>
<div class="line"><a name="l03201"></a><span class="lineno"> 3201</span>&#160;      itermodeentropy=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a480c56e263c4874ccb40f3bbc1b32032">ITERMODESTAGES</a>;</div>
<div class="line"><a name="l03202"></a><span class="lineno"> 3202</span>&#160;      whichcapentropy=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a4b6c6060c025e15f1d92aae3dcb9365b" title="which cap type to place in rad inversion">CAPTYPEBASIC</a>;</div>
<div class="line"><a name="l03203"></a><span class="lineno"> 3203</span>&#160;      trueimptryconventropy=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afc9b116343212081b674a39ac69ce6ed" title="Funny, even 1E-5 does ok with torus, no worse at Erf~ERADLIMIT instances. Also, does ~3 iterations...">IMPTRYCONV</a>;</div>
<div class="line"><a name="l03204"></a><span class="lineno"> 3204</span>&#160;      trueimpokconventropy=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a03803ff5190d70024aafd3b27bfa2f61">IMPOKCONVCONST</a>;</div>
<div class="line"><a name="l03205"></a><span class="lineno"> 3205</span>&#160;      trueimpallowconventropy=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab1ad1aee2202922457a377be53918cdc" title="what tolerance to use for saying can switch to entropy when u_g is suggested to be bad for energy...">IMPALLOWCONVCONST</a>;</div>
<div class="line"><a name="l03206"></a><span class="lineno"> 3206</span>&#160;      trueimpmaxiterentropy=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a58cca3253f4dfcefde5fe864699e297a">IMPMAXITERLONG</a>;</div>
<div class="line"><a name="l03207"></a><span class="lineno"> 3207</span>&#160;      truenumdampattemptsentropy=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a05f68af4806f09b5fcb143348da66be1">NUMDAMPATTEMPTS</a>;</div>
<div class="line"><a name="l03208"></a><span class="lineno"> 3208</span>&#160;      baseitermethodentropy=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9cf5ca7f5e5aa1e0bdef53abe3f27c1c">QTYPMHD</a>;</div>
<div class="line"><a name="l03209"></a><span class="lineno"> 3209</span>&#160;      failreturnentropy=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a17aede36203a236390363af78d3a86f0" title="compute changes to U (both T and R) using implicit method KORALTODO: If doing implicit, should also add geometry source term that can sometimes be stiff.">koral_source_rad_implicit_mode</a>(modemethodlocal,1,0,havebackup, didentropyalready, &amp;eomtypelocal, whichcapentropy, itermodeentropy, &amp;baseitermethodentropy, trueimptryconventropy, trueimpokconventropy, trueimpallowconventropy, trueimpmaxiterentropy,  truenumdampattemptsentropy, fracenergy, dissmeasure, &amp;radinvmod, pb, uub, piin, Uiin, Ufin, CUf, CUimp, ptrgeom, q, dUother ,dUcomp, errorabsentropy, errorabsentropy, &amp;itersentropy, &amp;f1itersentropy, &amp;nummhdinvsentropy, &amp;nummhdstepsentropy);</div>
<div class="line"><a name="l03210"></a><span class="lineno"> 3210</span>&#160;      nummhdsteps+=nummhdstepsentropy;</div>
<div class="line"><a name="l03211"></a><span class="lineno"> 3211</span>&#160;      </div>
<div class="line"><a name="l03212"></a><span class="lineno"> 3212</span>&#160;      <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a98e2c94d4fc861c61bc8dde7b4eec734">ACTUALHARDFAILURE</a>(failreturnentropy)){</div>
<div class="line"><a name="l03213"></a><span class="lineno"> 3213</span>&#160;        failfinalreturn=1;</div>
<div class="line"><a name="l03214"></a><span class="lineno"> 3214</span>&#160;        *lpflag=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2de5944abdafe2f29ef970d24869a883">UTOPRIMFAILCONV</a>;</div>
<div class="line"><a name="l03215"></a><span class="lineno"> 3215</span>&#160;        *lpflagrad=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aba9c5f566b4227c5e5d8faef0f62e4e6" title="locally fixed inversion problems (as possible sometimes with radiation): see phys.tools.rad.c:u2p_rad()">UTOPRIMRADFAILCASE1A</a>;</div>
<div class="line"><a name="l03216"></a><span class="lineno"> 3216</span>&#160;        goexplicit=0;</div>
<div class="line"><a name="l03217"></a><span class="lineno"> 3217</span>&#160;        usedimplicit=1;</div>
<div class="line"><a name="l03218"></a><span class="lineno"> 3218</span>&#160;        <span class="keywordflow">if</span>(debugfail&gt;=2) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;Entropy also failed: energy=%d entropy=%d\n&quot;</span>,failreturnenergy,failreturnentropy);</div>
<div class="line"><a name="l03219"></a><span class="lineno"> 3219</span>&#160;      }</div>
<div class="line"><a name="l03220"></a><span class="lineno"> 3220</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span>(failreturnentropy&gt;=0){</div>
<div class="line"><a name="l03221"></a><span class="lineno"> 3221</span>&#160;        <span class="comment">// use entropy</span></div>
<div class="line"><a name="l03222"></a><span class="lineno"> 3222</span>&#160;        failfinalreturn=0;</div>
<div class="line"><a name="l03223"></a><span class="lineno"> 3223</span>&#160;        usedentropy=1;</div>
<div class="line"><a name="l03224"></a><span class="lineno"> 3224</span>&#160;        noprims=0;</div>
<div class="line"><a name="l03225"></a><span class="lineno"> 3225</span>&#160;        errorabs[0]=errorabsentropy[0];</div>
<div class="line"><a name="l03226"></a><span class="lineno"> 3226</span>&#160;        errorabs[1]=errorabsentropy[1];</div>
<div class="line"><a name="l03227"></a><span class="lineno"> 3227</span>&#160;        iters=itersentropy;</div>
<div class="line"><a name="l03228"></a><span class="lineno"> 3228</span>&#160;        f1iters=f1itersentropy;</div>
<div class="line"><a name="l03229"></a><span class="lineno"> 3229</span>&#160;        <span class="comment">// tell an externals to switch to entropy</span></div>
<div class="line"><a name="l03230"></a><span class="lineno"> 3230</span>&#160;        <span class="comment">//*eomtype=EOMENTROPYGRMHD;</span></div>
<div class="line"><a name="l03231"></a><span class="lineno"> 3231</span>&#160;        *eomtype=eomtypelocal; <span class="comment">// EOMDONOTHING if successful call to koral_source_rad_implicit_mode()</span></div>
<div class="line"><a name="l03232"></a><span class="lineno"> 3232</span>&#160;        goexplicit=0;</div>
<div class="line"><a name="l03233"></a><span class="lineno"> 3233</span>&#160;        usedimplicit=1;</div>
<div class="line"><a name="l03234"></a><span class="lineno"> 3234</span>&#160;      }</div>
<div class="line"><a name="l03235"></a><span class="lineno"> 3235</span>&#160;      <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l03236"></a><span class="lineno"> 3236</span>&#160;        failfinalreturn=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a04634949fd2370214f3d313c9cffa182">FAILRETURNGOTRIVIALEXPLICIT</a>; <span class="comment">// indicates to koral_source_rad() that implicit says just do trivial explicit</span></div>
<div class="line"><a name="l03237"></a><span class="lineno"> 3237</span>&#160;        noprims=1;</div>
<div class="line"><a name="l03238"></a><span class="lineno"> 3238</span>&#160;        *eomtype=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aa28b06d889a02621b45edc716bfb2d01">EOMDEFAULT</a>;</div>
<div class="line"><a name="l03239"></a><span class="lineno"> 3239</span>&#160;        iters=itersentropy;</div>
<div class="line"><a name="l03240"></a><span class="lineno"> 3240</span>&#160;        f1iters=f1itersentropy;</div>
<div class="line"><a name="l03241"></a><span class="lineno"> 3241</span>&#160;        goexplicit=1;</div>
<div class="line"><a name="l03242"></a><span class="lineno"> 3242</span>&#160;        usedexplicitgood=1;</div>
<div class="line"><a name="l03243"></a><span class="lineno"> 3243</span>&#160;      }</div>
<div class="line"><a name="l03244"></a><span class="lineno"> 3244</span>&#160;    }</div>
<div class="line"><a name="l03245"></a><span class="lineno"> 3245</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(failreturnenergy&gt;=0){<span class="comment">// failreturnenergy==0 or eomtypecond[EOMGRMHD]==0</span></div>
<div class="line"><a name="l03246"></a><span class="lineno"> 3246</span>&#160;      <span class="comment">// can stick with energy</span></div>
<div class="line"><a name="l03247"></a><span class="lineno"> 3247</span>&#160;      failfinalreturn=0;</div>
<div class="line"><a name="l03248"></a><span class="lineno"> 3248</span>&#160;      usedenergy=1;</div>
<div class="line"><a name="l03249"></a><span class="lineno"> 3249</span>&#160;      noprims=0;</div>
<div class="line"><a name="l03250"></a><span class="lineno"> 3250</span>&#160;      errorabs[0]=errorabsenergy[0];</div>
<div class="line"><a name="l03251"></a><span class="lineno"> 3251</span>&#160;      errorabs[1]=errorabsenergy[1];</div>
<div class="line"><a name="l03252"></a><span class="lineno"> 3252</span>&#160;      iters=itersenergy;</div>
<div class="line"><a name="l03253"></a><span class="lineno"> 3253</span>&#160;      f1iters=f1itersenergy;</div>
<div class="line"><a name="l03254"></a><span class="lineno"> 3254</span>&#160;      <span class="comment">// switch to whatever solver suggested if didn&#39;t meet go-entropy condition</span></div>
<div class="line"><a name="l03255"></a><span class="lineno"> 3255</span>&#160;      *eomtype=eomtypelocal; <span class="comment">// can also be EOMDONOTHING if successful and good enough error.</span></div>
<div class="line"><a name="l03256"></a><span class="lineno"> 3256</span>&#160;      goexplicit=0;</div>
<div class="line"><a name="l03257"></a><span class="lineno"> 3257</span>&#160;      usedimplicit=1;</div>
<div class="line"><a name="l03258"></a><span class="lineno"> 3258</span>&#160;      <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a98e2c94d4fc861c61bc8dde7b4eec734">ACTUALHARDFAILURE</a>(failreturnenergy) &amp;&amp; debugfail&gt;=2) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;Decided didn&#39;t meet go-entropy condition but failed: failreturn=%d eomtypelocal=%d\n&quot;</span>,failreturn,eomtypelocal);</div>
<div class="line"><a name="l03259"></a><span class="lineno"> 3259</span>&#160;    }</div>
<div class="line"><a name="l03260"></a><span class="lineno"> 3260</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l03261"></a><span class="lineno"> 3261</span>&#160;      failfinalreturn=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a04634949fd2370214f3d313c9cffa182">FAILRETURNGOTRIVIALEXPLICIT</a>; <span class="comment">// indicates to koral_source_rad() that implicit says just do trivial explicit</span></div>
<div class="line"><a name="l03262"></a><span class="lineno"> 3262</span>&#160;      noprims=1;</div>
<div class="line"><a name="l03263"></a><span class="lineno"> 3263</span>&#160;      *eomtype=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aa28b06d889a02621b45edc716bfb2d01">EOMDEFAULT</a>;</div>
<div class="line"><a name="l03264"></a><span class="lineno"> 3264</span>&#160;      iters=itersentropy;</div>
<div class="line"><a name="l03265"></a><span class="lineno"> 3265</span>&#160;      f1iters=f1itersentropy;</div>
<div class="line"><a name="l03266"></a><span class="lineno"> 3266</span>&#160;      goexplicit=1;</div>
<div class="line"><a name="l03267"></a><span class="lineno"> 3267</span>&#160;      usedexplicitgood=1;</div>
<div class="line"><a name="l03268"></a><span class="lineno"> 3268</span>&#160;    }</div>
<div class="line"><a name="l03269"></a><span class="lineno"> 3269</span>&#160;  }</div>
<div class="line"><a name="l03270"></a><span class="lineno"> 3270</span>&#160;</div>
<div class="line"><a name="l03271"></a><span class="lineno"> 3271</span>&#160;</div>
<div class="line"><a name="l03272"></a><span class="lineno"> 3272</span>&#160;</div>
<div class="line"><a name="l03273"></a><span class="lineno"> 3273</span>&#160;</div>
<div class="line"><a name="l03274"></a><span class="lineno"> 3274</span>&#160;</div>
<div class="line"><a name="l03275"></a><span class="lineno"> 3275</span>&#160;<span class="comment">// KORALTODO: SUPERGODMARK: run normal koral tests.  Figure out all entropy signs.</span></div>
<div class="line"><a name="l03276"></a><span class="lineno"> 3276</span>&#160;<span class="comment">// KORALTODO: SUPERGODMARK: Need backup to entropy since really dies if no backup.  E.g. cold backup.   But maybe using high accurate cold bad compared to lower accuracy entropy or lower accuracy energy.  Not sure should always prefer entropy if didn&#39;t reach desired tolerance.  But, currently if allowed tolerance, treated as ok solution and not failure to reject.  So this issue is ok relative to chosen IMPALLOWCONV.</span></div>
<div class="line"><a name="l03277"></a><span class="lineno"> 3277</span>&#160;</div>
<div class="line"><a name="l03278"></a><span class="lineno"> 3278</span>&#160;</div>
<div class="line"><a name="l03279"></a><span class="lineno"> 3279</span>&#160;</div>
<div class="line"><a name="l03280"></a><span class="lineno"> 3280</span>&#160;</div>
<div class="line"><a name="l03281"></a><span class="lineno"> 3281</span>&#160;</div>
<div class="line"><a name="l03282"></a><span class="lineno"> 3282</span>&#160;</div>
<div class="line"><a name="l03283"></a><span class="lineno"> 3283</span>&#160;</div>
<div class="line"><a name="l03285"></a><span class="lineno"> 3285</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l03286"></a><span class="lineno"> 3286</span>&#160;  <span class="comment">// MODEPICKBEST / MODEPICKBESTSIMPLE / MODEPICKBESTSIMPLE2</span></div>
<div class="line"><a name="l03287"></a><span class="lineno"> 3287</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l03288"></a><span class="lineno"> 3288</span>&#160;  <span class="comment">// KORALTODO: SUPERGODMARK: Need to still think of energy-entropy implicit solver for intermediate regime.  Also, need to add conditions to avoid entropy or energy if Erf&lt;0 or gammarad reaches limit or entropy-based effective absorption opacity is too large.&quot;</span></div>
<div class="line"><a name="l03289"></a><span class="lineno"> 3289</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l03291"></a><span class="lineno"> 3291</span>&#160;<span class="comment"></span>  <span class="comment">// 1) start with entropy</span></div>
<div class="line"><a name="l03292"></a><span class="lineno"> 3292</span>&#160;  <span class="comment">// 2) Then if entropy didn&#39;t fail, use as guess for energy.</span></div>
<div class="line"><a name="l03293"></a><span class="lineno"> 3293</span>&#160;  <span class="comment">//    During energy iteration, stop if repeatedly have u_g[entropy]&gt;2*u_g[energy] using entropy guess stored for reference.</span></div>
<div class="line"><a name="l03294"></a><span class="lineno"> 3294</span>&#160;  <span class="comment">// 3) If energy failed, stick with non-failed entropy.  If both failed, revert to failure modes or G=0</span></div>
<div class="line"><a name="l03295"></a><span class="lineno"> 3295</span>&#160;  <span class="comment">//    If both succeeded, use entropy if u_g[entropy]&gt;2*u_g[energy]</span></div>
<div class="line"><a name="l03296"></a><span class="lineno"> 3296</span>&#160;</div>
<div class="line"><a name="l03297"></a><span class="lineno"> 3297</span>&#160;  <span class="comment">// NEW ORDER (because entropy dies too much in shocks and takes too many trials)</span></div>
<div class="line"><a name="l03298"></a><span class="lineno"> 3298</span>&#160;  <span class="comment">// 1) Try energy with QTYPMHD, QTYURAD, QTYPRAD.  Try quickly with no damping, ITERMODENORMAL.  Only try URAD/PRAD if PMHD fails or gives radinv=1</span></div>
<div class="line"><a name="l03299"></a><span class="lineno"> 3299</span>&#160;  <span class="comment">// 2) Following #1, but then use ITERMODESTAGES, damping, higher uu if applicable.</span></div>
<div class="line"><a name="l03300"></a><span class="lineno"> 3300</span>&#160;</div>
<div class="line"><a name="l03301"></a><span class="lineno"> 3301</span>&#160;<span class="preprocessor">#define NUMPHASES (6)</span></div>
<div class="line"><a name="l03302"></a><span class="lineno"> 3302</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define NUMPHASESENT (8)</span></div>
<div class="line"><a name="l03303"></a><span class="lineno"> 3303</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define NUMPHASESCOLD (1)</span></div>
<div class="line"><a name="l03304"></a><span class="lineno"> 3304</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l03305"></a><span class="lineno"> 3305</span>&#160;  <span class="comment">// counters for which method was *attempted* even if not used</span></div>
<div class="line"><a name="l03306"></a><span class="lineno"> 3306</span>&#160;  <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> tryphaselistenergy[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8076bfd08bb8012f9711601a7364d93c">NUMPHASES</a>]={0};</div>
<div class="line"><a name="l03307"></a><span class="lineno"> 3307</span>&#160;  <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> tryphaselistentropy[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a490d03249c544ac789d91c742057394e">NUMPHASESENT</a>]={0};</div>
<div class="line"><a name="l03308"></a><span class="lineno"> 3308</span>&#160;  <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> tryphaselistcold[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a12af67299c9e98e2eeef308ad46e3e0e">NUMPHASESCOLD</a>]={0};</div>
<div class="line"><a name="l03309"></a><span class="lineno"> 3309</span>&#160;</div>
<div class="line"><a name="l03310"></a><span class="lineno"> 3310</span>&#160;</div>
<div class="line"><a name="l03311"></a><span class="lineno"> 3311</span>&#160;  <span class="keywordtype">int</span> gotrameshsolution=0,usedrameshenergy=0,usedrameshentropy=0;</div>
<div class="line"><a name="l03312"></a><span class="lineno"> 3312</span>&#160;  <span class="keywordflow">if</span>(modemethodlocal==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aef33cf4e6c2534137907bc2eaefdb224">MODEPICKBEST</a> || modemethodlocal==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a861070760a7e713342da86a4c8bfa660">MODEPICKBESTSIMPLE</a>  || modemethodlocal==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a4a773e56e52c24230ab87c41877f241e">MODEPICKBESTSIMPLE2</a>){</div>
<div class="line"><a name="l03313"></a><span class="lineno"> 3313</span>&#160;</div>
<div class="line"><a name="l03314"></a><span class="lineno"> 3314</span>&#160;</div>
<div class="line"><a name="l03315"></a><span class="lineno"> 3315</span>&#160;</div>
<div class="line"><a name="l03317"></a><span class="lineno"> 3317</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l03318"></a><span class="lineno"> 3318</span>&#160;    <span class="comment">// ENTROPY VARIABLES</span></div>
<div class="line"><a name="l03319"></a><span class="lineno"> 3319</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l03321"></a><span class="lineno"> 3321</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03322"></a><span class="lineno"> 3322</span>&#160;    <span class="comment">// choices per attempt</span></div>
<div class="line"><a name="l03323"></a><span class="lineno"> 3323</span>&#160;    <span class="keywordtype">int</span> itermodeentropy=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab9c7390f62ef08325e12b7110621d33a">ITERMODENORMAL</a>; <span class="comment">// start with normal</span></div>
<div class="line"><a name="l03324"></a><span class="lineno"> 3324</span>&#160;    <span class="keywordtype">int</span> baseitermethodentropy=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9cf5ca7f5e5aa1e0bdef53abe3f27c1c">QTYPMHD</a>; <span class="comment">// default</span></div>
<div class="line"><a name="l03325"></a><span class="lineno"> 3325</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> trueimptryconventropy;</div>
<div class="line"><a name="l03326"></a><span class="lineno"> 3326</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> trueimpokconventropy;</div>
<div class="line"><a name="l03327"></a><span class="lineno"> 3327</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> trueimpallowconventropy;</div>
<div class="line"><a name="l03328"></a><span class="lineno"> 3328</span>&#160;    <span class="keywordtype">int</span> trueimpmaxiterentropy;</div>
<div class="line"><a name="l03329"></a><span class="lineno"> 3329</span>&#160;    <span class="keywordtype">int</span> truenumdampattemptsentropy;</div>
<div class="line"><a name="l03330"></a><span class="lineno"> 3330</span>&#160;    <span class="keywordtype">int</span> whichcapentropy;</div>
<div class="line"><a name="l03331"></a><span class="lineno"> 3331</span>&#160;</div>
<div class="line"><a name="l03332"></a><span class="lineno"> 3332</span>&#160;    <span class="comment">// hold error and iterations from last attempt</span></div>
<div class="line"><a name="l03333"></a><span class="lineno"> 3333</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> errorabsentropyold[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa63447acbbbc62cbedae23eac61c716e" title="determine which error will use when deciding if converged or not.">NUMERRORTYPES</a>];</div>
<div class="line"><a name="l03334"></a><span class="lineno"> 3334</span>&#160;    set_array(errorabsentropyold,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa63447acbbbc62cbedae23eac61c716e" title="determine which error will use when deciding if converged or not.">NUMERRORTYPES</a>,MPI_FTYPE,1.0);</div>
<div class="line"><a name="l03335"></a><span class="lineno"> 3335</span>&#160;</div>
<div class="line"><a name="l03336"></a><span class="lineno"> 3336</span>&#160;    <span class="keywordtype">int</span> radinvmodentropyold=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ad987489760e6592057a80faf09588c88" title="unfixable inversion problems">UTOPRIMRADFAILBAD1</a>;</div>
<div class="line"><a name="l03337"></a><span class="lineno"> 3337</span>&#160;    <span class="keywordtype">int</span> itersentropyold=0;</div>
<div class="line"><a name="l03338"></a><span class="lineno"> 3338</span>&#160;    <span class="comment">// hold iterations for total entropy attempts</span></div>
<div class="line"><a name="l03339"></a><span class="lineno"> 3339</span>&#160;    <span class="keywordtype">int</span> itersentropy=0;</div>
<div class="line"><a name="l03340"></a><span class="lineno"> 3340</span>&#160;    <span class="keywordtype">int</span> f1itersentropy=0;</div>
<div class="line"><a name="l03341"></a><span class="lineno"> 3341</span>&#160;    <span class="keywordtype">int</span> nummhdinvsentropy=0;</div>
<div class="line"><a name="l03342"></a><span class="lineno"> 3342</span>&#160;    <span class="keywordtype">int</span> nummhdstepsentropy=0;</div>
<div class="line"><a name="l03343"></a><span class="lineno"> 3343</span>&#160;</div>
<div class="line"><a name="l03344"></a><span class="lineno"> 3344</span>&#160;</div>
<div class="line"><a name="l03345"></a><span class="lineno"> 3345</span>&#160;    <span class="comment">// set that no entropy backup yet.</span></div>
<div class="line"><a name="l03346"></a><span class="lineno"> 3346</span>&#160;    havebackup=0;</div>
<div class="line"><a name="l03347"></a><span class="lineno"> 3347</span>&#160;    didentropyalready=0;</div>
<div class="line"><a name="l03348"></a><span class="lineno"> 3348</span>&#160;    fracenergy=0.0;</div>
<div class="line"><a name="l03349"></a><span class="lineno"> 3349</span>&#160;</div>
<div class="line"><a name="l03350"></a><span class="lineno"> 3350</span>&#160;    <span class="comment">// default in case no best solution with no error below 1.0 that is set as default best</span></div>
<div class="line"><a name="l03351"></a><span class="lineno"> 3351</span>&#160;</div>
<div class="line"><a name="l03352"></a><span class="lineno"> 3352</span>&#160;    <span class="comment">// holds best entropy solution</span></div>
<div class="line"><a name="l03353"></a><span class="lineno"> 3353</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> pbentropybest[NPR]; <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) pbentropybest[pl]=pbbackup[pl];</div>
<div class="line"><a name="l03354"></a><span class="lineno"> 3354</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> uubentropybest[NPR]; <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) uubentropybest[pl]=uubbackup[pl];</div>
<div class="line"><a name="l03355"></a><span class="lineno"> 3355</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dUcompentropybest[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ac34589654a83c911addd1fda0898e738">NUMSOURCES</a>][NPR]; <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a2da8b12fca78064531b9b64e5699e4fc" title="loop over ALL sources (including geometry)">SCLOOP</a>(sc) dUcompentropybest[sc][pl]=dUcompbackup[sc][pl];</div>
<div class="line"><a name="l03356"></a><span class="lineno"> 3356</span>&#160;    <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> qentropybest=qbackup;</div>
<div class="line"><a name="l03357"></a><span class="lineno"> 3357</span>&#160;    <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> lpflagentropybest=1;</div>
<div class="line"><a name="l03358"></a><span class="lineno"> 3358</span>&#160;    <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> lpflagradentropybest=1;</div>
<div class="line"><a name="l03359"></a><span class="lineno"> 3359</span>&#160;    <span class="keywordtype">int</span> radinvmodentropybest=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ad987489760e6592057a80faf09588c88" title="unfixable inversion problems">UTOPRIMRADFAILBAD1</a>;</div>
<div class="line"><a name="l03360"></a><span class="lineno"> 3360</span>&#160;    <span class="keywordtype">int</span> radErfnegentropybest=1;</div>
<div class="line"><a name="l03361"></a><span class="lineno"> 3361</span>&#160;    <span class="keywordtype">int</span> failreturnentropybest=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab0abd953f677a44020dc50259c410486">FAILRETURNGENERAL</a>;</div>
<div class="line"><a name="l03362"></a><span class="lineno"> 3362</span>&#160;    <span class="keywordtype">int</span> eomtypeentropybest=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a40b55e98bfcccde1a3f19d983ca7488c">EOMENTROPYGRMHD</a>;</div>
<div class="line"><a name="l03363"></a><span class="lineno"> 3363</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> errorabsentropybest[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa63447acbbbc62cbedae23eac61c716e" title="determine which error will use when deciding if converged or not.">NUMERRORTYPES</a>];</div>
<div class="line"><a name="l03364"></a><span class="lineno"> 3364</span>&#160;    set_array(errorabsentropybest,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa63447acbbbc62cbedae23eac61c716e" title="determine which error will use when deciding if converged or not.">NUMERRORTYPES</a>,MPI_FTYPE,1.0);</div>
<div class="line"><a name="l03365"></a><span class="lineno"> 3365</span>&#160;    <span class="keywordtype">int</span> goexplicitentropybest=0;</div>
<div class="line"><a name="l03366"></a><span class="lineno"> 3366</span>&#160;</div>
<div class="line"><a name="l03367"></a><span class="lineno"> 3367</span>&#160;    <span class="comment">// holds latest entropy solution</span></div>
<div class="line"><a name="l03368"></a><span class="lineno"> 3368</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> pbentropy[NPR];</div>
<div class="line"><a name="l03369"></a><span class="lineno"> 3369</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> uubentropy[NPR]; <span class="comment">// holds returned uu from implicit solver</span></div>
<div class="line"><a name="l03370"></a><span class="lineno"> 3370</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dUcompentropy[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ac34589654a83c911addd1fda0898e738">NUMSOURCES</a>][NPR]={{<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>}};</div>
<div class="line"><a name="l03371"></a><span class="lineno"> 3371</span>&#160;    <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> qentropy=qbackup;</div>
<div class="line"><a name="l03372"></a><span class="lineno"> 3372</span>&#160;    <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> lpflagentropy=1;</div>
<div class="line"><a name="l03373"></a><span class="lineno"> 3373</span>&#160;    <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> lpflagradentropy=1;</div>
<div class="line"><a name="l03374"></a><span class="lineno"> 3374</span>&#160;    <span class="keywordtype">int</span> radinvmodentropy=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ad987489760e6592057a80faf09588c88" title="unfixable inversion problems">UTOPRIMRADFAILBAD1</a>;</div>
<div class="line"><a name="l03375"></a><span class="lineno"> 3375</span>&#160;    <span class="keywordtype">int</span> radErfnegentropy=1;</div>
<div class="line"><a name="l03376"></a><span class="lineno"> 3376</span>&#160;    <span class="keywordtype">int</span> failreturnentropy=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab0abd953f677a44020dc50259c410486">FAILRETURNGENERAL</a>;  <span class="comment">// default to fail in case energy not to be done at all</span></div>
<div class="line"><a name="l03377"></a><span class="lineno"> 3377</span>&#160;    <span class="keywordtype">int</span> eomtypeentropy=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a40b55e98bfcccde1a3f19d983ca7488c">EOMENTROPYGRMHD</a>;</div>
<div class="line"><a name="l03378"></a><span class="lineno"> 3378</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> errorabsentropy[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa63447acbbbc62cbedae23eac61c716e" title="determine which error will use when deciding if converged or not.">NUMERRORTYPES</a>]; <span class="comment">// default is high error</span></div>
<div class="line"><a name="l03379"></a><span class="lineno"> 3379</span>&#160;    set_array(errorabsentropy,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa63447acbbbc62cbedae23eac61c716e" title="determine which error will use when deciding if converged or not.">NUMERRORTYPES</a>,MPI_FTYPE,1.0);</div>
<div class="line"><a name="l03380"></a><span class="lineno"> 3380</span>&#160;    <span class="keywordtype">int</span> goexplicitentropy=0;</div>
<div class="line"><a name="l03381"></a><span class="lineno"> 3381</span>&#160;</div>
<div class="line"><a name="l03382"></a><span class="lineno"> 3382</span>&#160;</div>
<div class="line"><a name="l03383"></a><span class="lineno"> 3383</span>&#160;</div>
<div class="line"><a name="l03384"></a><span class="lineno"> 3384</span>&#160;</div>
<div class="line"><a name="l03385"></a><span class="lineno"> 3385</span>&#160;</div>
<div class="line"><a name="l03386"></a><span class="lineno"> 3386</span>&#160;   </div>
<div class="line"><a name="l03388"></a><span class="lineno"> 3388</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l03389"></a><span class="lineno"> 3389</span>&#160;    <span class="comment">// set fracenergy</span></div>
<div class="line"><a name="l03390"></a><span class="lineno"> 3390</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l03392"></a><span class="lineno"> 3392</span>&#160;<span class="comment"></span>    set_fracenergy(ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,dissmeasure, &amp;fracenergy);</div>
<div class="line"><a name="l03393"></a><span class="lineno"> 3393</span>&#160;</div>
<div class="line"><a name="l03394"></a><span class="lineno"> 3394</span>&#160;</div>
<div class="line"><a name="l03396"></a><span class="lineno"> 3396</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l03397"></a><span class="lineno"> 3397</span>&#160;    <span class="comment">// ENERGY VARIABLES</span></div>
<div class="line"><a name="l03398"></a><span class="lineno"> 3398</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l03400"></a><span class="lineno"> 3400</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03401"></a><span class="lineno"> 3401</span>&#160;    <span class="comment">// hold old error and iterations</span></div>
<div class="line"><a name="l03402"></a><span class="lineno"> 3402</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> errorabsenergyold[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa63447acbbbc62cbedae23eac61c716e" title="determine which error will use when deciding if converged or not.">NUMERRORTYPES</a>];</div>
<div class="line"><a name="l03403"></a><span class="lineno"> 3403</span>&#160;    set_array(errorabsenergyold,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa63447acbbbc62cbedae23eac61c716e" title="determine which error will use when deciding if converged or not.">NUMERRORTYPES</a>,MPI_FTYPE,1.0);</div>
<div class="line"><a name="l03404"></a><span class="lineno"> 3404</span>&#160;    <span class="keywordtype">int</span> radinvmodenergyold=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ad987489760e6592057a80faf09588c88" title="unfixable inversion problems">UTOPRIMRADFAILBAD1</a>;</div>
<div class="line"><a name="l03405"></a><span class="lineno"> 3405</span>&#160;    <span class="keywordtype">int</span> itersenergyold;</div>
<div class="line"><a name="l03406"></a><span class="lineno"> 3406</span>&#160;</div>
<div class="line"><a name="l03407"></a><span class="lineno"> 3407</span>&#160;    <span class="comment">// latest energy iterations</span></div>
<div class="line"><a name="l03408"></a><span class="lineno"> 3408</span>&#160;    <span class="keywordtype">int</span> itersenergy=0;</div>
<div class="line"><a name="l03409"></a><span class="lineno"> 3409</span>&#160;    <span class="keywordtype">int</span> f1itersenergy=0;</div>
<div class="line"><a name="l03410"></a><span class="lineno"> 3410</span>&#160;    <span class="keywordtype">int</span> nummhdinvsenergy=0;</div>
<div class="line"><a name="l03411"></a><span class="lineno"> 3411</span>&#160;    <span class="keywordtype">int</span> nummhdstepsenergy=0;</div>
<div class="line"><a name="l03412"></a><span class="lineno"> 3412</span>&#160;</div>
<div class="line"><a name="l03413"></a><span class="lineno"> 3413</span>&#160;    <span class="comment">// setting for each attempt</span></div>
<div class="line"><a name="l03414"></a><span class="lineno"> 3414</span>&#160;    <span class="keywordtype">int</span> itermodeenergy=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab9c7390f62ef08325e12b7110621d33a">ITERMODENORMAL</a>; <span class="comment">// start with normal</span></div>
<div class="line"><a name="l03415"></a><span class="lineno"> 3415</span>&#160;    <span class="keywordtype">int</span> baseitermethodenergy=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9cf5ca7f5e5aa1e0bdef53abe3f27c1c">QTYPMHD</a>; <span class="comment">// default</span></div>
<div class="line"><a name="l03416"></a><span class="lineno"> 3416</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> trueimptryconvenergy;</div>
<div class="line"><a name="l03417"></a><span class="lineno"> 3417</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> trueimpokconvenergy;</div>
<div class="line"><a name="l03418"></a><span class="lineno"> 3418</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> trueimpallowconvenergy;</div>
<div class="line"><a name="l03419"></a><span class="lineno"> 3419</span>&#160;    <span class="keywordtype">int</span> trueimpmaxiterenergy;</div>
<div class="line"><a name="l03420"></a><span class="lineno"> 3420</span>&#160;    <span class="keywordtype">int</span> truenumdampattemptsenergy;</div>
<div class="line"><a name="l03421"></a><span class="lineno"> 3421</span>&#160;    <span class="keywordtype">int</span> whichcapenergy;</div>
<div class="line"><a name="l03422"></a><span class="lineno"> 3422</span>&#160;</div>
<div class="line"><a name="l03423"></a><span class="lineno"> 3423</span>&#160;</div>
<div class="line"><a name="l03424"></a><span class="lineno"> 3424</span>&#160;    <span class="comment">// holds best result from implicit solver</span></div>
<div class="line"><a name="l03425"></a><span class="lineno"> 3425</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> pbenergybest[NPR]; <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) pbenergybest[pl]=pbbackup[pl];</div>
<div class="line"><a name="l03426"></a><span class="lineno"> 3426</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> uubenergybest[NPR]; <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) uubenergybest[pl]=uubbackup[pl];</div>
<div class="line"><a name="l03427"></a><span class="lineno"> 3427</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dUcompenergybest[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ac34589654a83c911addd1fda0898e738">NUMSOURCES</a>][NPR];  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a2da8b12fca78064531b9b64e5699e4fc" title="loop over ALL sources (including geometry)">SCLOOP</a>(sc) dUcompenergybest[sc][pl]=dUcompbackup[sc][pl];</div>
<div class="line"><a name="l03428"></a><span class="lineno"> 3428</span>&#160;    <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> qenergybest=qbackup;</div>
<div class="line"><a name="l03429"></a><span class="lineno"> 3429</span>&#160;    <span class="comment">// default is best is fail situation</span></div>
<div class="line"><a name="l03430"></a><span class="lineno"> 3430</span>&#160;    <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> lpflagenergybest=1;</div>
<div class="line"><a name="l03431"></a><span class="lineno"> 3431</span>&#160;    <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> lpflagradenergybest=1;</div>
<div class="line"><a name="l03432"></a><span class="lineno"> 3432</span>&#160;    <span class="keywordtype">int</span> radinvmodenergybest=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ad987489760e6592057a80faf09588c88" title="unfixable inversion problems">UTOPRIMRADFAILBAD1</a>;</div>
<div class="line"><a name="l03433"></a><span class="lineno"> 3433</span>&#160;    <span class="keywordtype">int</span> radErfnegenergybest=1;</div>
<div class="line"><a name="l03434"></a><span class="lineno"> 3434</span>&#160;    <span class="keywordtype">int</span> failreturnenergybest=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab0abd953f677a44020dc50259c410486">FAILRETURNGENERAL</a>;</div>
<div class="line"><a name="l03435"></a><span class="lineno"> 3435</span>&#160;    <span class="keywordtype">int</span> eomtypeenergybest=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a03d89f51ab60206791830c886d62bfd0">EOMGRMHD</a>;</div>
<div class="line"><a name="l03436"></a><span class="lineno"> 3436</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> errorabsenergybest[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa63447acbbbc62cbedae23eac61c716e" title="determine which error will use when deciding if converged or not.">NUMERRORTYPES</a>];</div>
<div class="line"><a name="l03437"></a><span class="lineno"> 3437</span>&#160;    set_array(errorabsenergybest,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa63447acbbbc62cbedae23eac61c716e" title="determine which error will use when deciding if converged or not.">NUMERRORTYPES</a>,MPI_FTYPE,1.0);</div>
<div class="line"><a name="l03438"></a><span class="lineno"> 3438</span>&#160;    <span class="keywordtype">int</span> goexplicitenergybest=0;</div>
<div class="line"><a name="l03439"></a><span class="lineno"> 3439</span>&#160;</div>
<div class="line"><a name="l03440"></a><span class="lineno"> 3440</span>&#160;    <span class="comment">// holds result from implicit solver</span></div>
<div class="line"><a name="l03441"></a><span class="lineno"> 3441</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> pbenergy[NPR];</div>
<div class="line"><a name="l03442"></a><span class="lineno"> 3442</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> uubenergy[NPR];</div>
<div class="line"><a name="l03443"></a><span class="lineno"> 3443</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dUcompenergy[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ac34589654a83c911addd1fda0898e738">NUMSOURCES</a>][NPR];</div>
<div class="line"><a name="l03444"></a><span class="lineno"> 3444</span>&#160;    set_array(dUcompenergy,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ac34589654a83c911addd1fda0898e738">NUMSOURCES</a>*NPR,MPI_FTYPE,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>);</div>
<div class="line"><a name="l03445"></a><span class="lineno"> 3445</span>&#160;    <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> qenergy=qbackup;</div>
<div class="line"><a name="l03446"></a><span class="lineno"> 3446</span>&#160;    <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> lpflagenergy=1;</div>
<div class="line"><a name="l03447"></a><span class="lineno"> 3447</span>&#160;    <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> lpflagradenergy=1;</div>
<div class="line"><a name="l03448"></a><span class="lineno"> 3448</span>&#160;    <span class="keywordtype">int</span> radinvmodenergy=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ad987489760e6592057a80faf09588c88" title="unfixable inversion problems">UTOPRIMRADFAILBAD1</a>;</div>
<div class="line"><a name="l03449"></a><span class="lineno"> 3449</span>&#160;    <span class="keywordtype">int</span> radErfnegenergy=1;</div>
<div class="line"><a name="l03450"></a><span class="lineno"> 3450</span>&#160;    <span class="keywordtype">int</span> failreturnenergy=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab0abd953f677a44020dc50259c410486">FAILRETURNGENERAL</a>; <span class="comment">// default</span></div>
<div class="line"><a name="l03451"></a><span class="lineno"> 3451</span>&#160;    <span class="keywordtype">int</span> eomtypeenergy=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a03d89f51ab60206791830c886d62bfd0">EOMGRMHD</a>;</div>
<div class="line"><a name="l03452"></a><span class="lineno"> 3452</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> errorabsenergy[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa63447acbbbc62cbedae23eac61c716e" title="determine which error will use when deciding if converged or not.">NUMERRORTYPES</a>];</div>
<div class="line"><a name="l03453"></a><span class="lineno"> 3453</span>&#160;    set_array(errorabsenergy,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa63447acbbbc62cbedae23eac61c716e" title="determine which error will use when deciding if converged or not.">NUMERRORTYPES</a>,MPI_FTYPE,1.0);</div>
<div class="line"><a name="l03454"></a><span class="lineno"> 3454</span>&#160;    <span class="keywordtype">int</span> goexplicitenergy=0;</div>
<div class="line"><a name="l03455"></a><span class="lineno"> 3455</span>&#160;</div>
<div class="line"><a name="l03456"></a><span class="lineno"> 3456</span>&#160;</div>
<div class="line"><a name="l03457"></a><span class="lineno"> 3457</span>&#160;</div>
<div class="line"><a name="l03459"></a><span class="lineno"> 3459</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l03460"></a><span class="lineno"> 3460</span>&#160;    <span class="comment">// RAMESH VARIABLES AND DEFAULTS</span></div>
<div class="line"><a name="l03461"></a><span class="lineno"> 3461</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l03462"></a><span class="lineno"> 3462</span>&#160;    <span class="comment">// these ramesh solutions are here so both entropy and energy can have chance to fill them.</span></div>
<div class="line"><a name="l03463"></a><span class="lineno"> 3463</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l03465"></a><span class="lineno"> 3465</span>&#160;<span class="comment"></span>    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ppeng[NPR],ppent[NPR];</div>
<div class="line"><a name="l03466"></a><span class="lineno"> 3466</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> uueng[NPR],uuent[NPR];</div>
<div class="line"><a name="l03467"></a><span class="lineno"> 3467</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dUcompeng[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ac34589654a83c911addd1fda0898e738">NUMSOURCES</a>][NPR],dUcompent[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ac34589654a83c911addd1fda0898e738">NUMSOURCES</a>][NPR];</div>
<div class="line"><a name="l03468"></a><span class="lineno"> 3468</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l03469"></a><span class="lineno"> 3469</span>&#160;      ppeng[pl]=ppent[pl]=pbbackup[pl];</div>
<div class="line"><a name="l03470"></a><span class="lineno"> 3470</span>&#160;      uueng[pl]=uuent[pl]=uubbackup[pl];</div>
<div class="line"><a name="l03471"></a><span class="lineno"> 3471</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a2da8b12fca78064531b9b64e5699e4fc" title="loop over ALL sources (including geometry)">SCLOOP</a>(sc) dUcompeng[sc][pl]=dUcompent[sc][pl]=dUcompbackup[sc][pl];</div>
<div class="line"><a name="l03472"></a><span class="lineno"> 3472</span>&#160;    }</div>
<div class="line"><a name="l03473"></a><span class="lineno"> 3473</span>&#160;    <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> qeng=qbackup, qent=qbackup;</div>
<div class="line"><a name="l03474"></a><span class="lineno"> 3474</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> errorabseng[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa63447acbbbc62cbedae23eac61c716e" title="determine which error will use when deciding if converged or not.">NUMERRORTYPES</a>],errorabsent[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa63447acbbbc62cbedae23eac61c716e" title="determine which error will use when deciding if converged or not.">NUMERRORTYPES</a>];</div>
<div class="line"><a name="l03475"></a><span class="lineno"> 3475</span>&#160;    set_array(errorabseng,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa63447acbbbc62cbedae23eac61c716e" title="determine which error will use when deciding if converged or not.">NUMERRORTYPES</a>,MPI_FTYPE,1.0);</div>
<div class="line"><a name="l03476"></a><span class="lineno"> 3476</span>&#160;    set_array(errorabsent,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa63447acbbbc62cbedae23eac61c716e" title="determine which error will use when deciding if converged or not.">NUMERRORTYPES</a>,MPI_FTYPE,1.0);</div>
<div class="line"><a name="l03477"></a><span class="lineno"> 3477</span>&#160;    <span class="keywordtype">int</span> failtypeeng=1,failtypeent=1,iterseng=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a58cca3253f4dfcefde5fe864699e297a">IMPMAXITERLONG</a>,itersent=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a58cca3253f4dfcefde5fe864699e297a">IMPMAXITERLONG</a>,radinvmodeng=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ad987489760e6592057a80faf09588c88" title="unfixable inversion problems">UTOPRIMRADFAILBAD1</a>,radinvmodent=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ad987489760e6592057a80faf09588c88" title="unfixable inversion problems">UTOPRIMRADFAILBAD1</a>;</div>
<div class="line"><a name="l03478"></a><span class="lineno"> 3478</span>&#160;</div>
<div class="line"><a name="l03479"></a><span class="lineno"> 3479</span>&#160;</div>
<div class="line"><a name="l03480"></a><span class="lineno"> 3480</span>&#160;</div>
<div class="line"><a name="l03481"></a><span class="lineno"> 3481</span>&#160;</div>
<div class="line"><a name="l03482"></a><span class="lineno"> 3482</span>&#160;</div>
<div class="line"><a name="l03484"></a><span class="lineno"> 3484</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l03485"></a><span class="lineno"> 3485</span>&#160;    <span class="comment">// check if should re-order method attempt list in case where primary evolving quantity is radiation.</span></div>
<div class="line"><a name="l03486"></a><span class="lineno"> 3486</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l03487"></a><span class="lineno"> 3487</span>&#160;    <span class="comment">// assume at this stage that radiation primarily evolves if Erf sufficiently large compared to u_g or changes in URAD0 are sufficiently large</span></div>
<div class="line"><a name="l03488"></a><span class="lineno"> 3488</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l03489"></a><span class="lineno"> 3489</span>&#160;    <span class="comment">// check</span></div>
<div class="line"><a name="l03490"></a><span class="lineno"> 3490</span>&#160;    <span class="keyword">static</span> <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> sqrtnumepsilon1;</div>
<div class="line"><a name="l03491"></a><span class="lineno"> 3491</span>&#160;    <span class="keyword">static</span> <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> sqrtnumepsilon2;</div>
<div class="line"><a name="l03492"></a><span class="lineno"> 3492</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">int</span> firsttimeset=1;</div>
<div class="line"><a name="l03493"></a><span class="lineno"> 3493</span>&#160;    <span class="keywordflow">if</span>(firsttimeset){</div>
<div class="line"><a name="l03494"></a><span class="lineno"> 3494</span>&#160;      <span class="comment">//      sqrtnumepsilon=10.0*pow(NUMEPSILON,1.0/3.0);</span></div>
<div class="line"><a name="l03495"></a><span class="lineno"> 3495</span>&#160;      <span class="comment">//      sqrtnumepsilon=1E-1; // playing -- required for RADBONDI to be fast by using QTYURAD method first as QTYPMHD method fails more.</span></div>
<div class="line"><a name="l03496"></a><span class="lineno"> 3496</span>&#160;      sqrtnumepsilon1=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(1.0,10.0*<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a8913cb5d64cfec23ae1a3052930ec468">NUMEPSILON</a>/<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afc9b116343212081b674a39ac69ce6ed" title="Funny, even 1E-5 does ok with torus, no worse at Erf~ERADLIMIT instances. Also, does ~3 iterations...">IMPTRYCONV</a>);</div>
<div class="line"><a name="l03497"></a><span class="lineno"> 3497</span>&#160;      sqrtnumepsilon2=pow(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a8913cb5d64cfec23ae1a3052930ec468">NUMEPSILON</a>,1.0/3.0);</div>
<div class="line"><a name="l03498"></a><span class="lineno"> 3498</span>&#160;      firsttimeset=0;</div>
<div class="line"><a name="l03499"></a><span class="lineno"> 3499</span>&#160;    }</div>
<div class="line"><a name="l03500"></a><span class="lineno"> 3500</span>&#160;    <span class="keywordtype">int</span> radprimaryevolves=0;</div>
<div class="line"><a name="l03501"></a><span class="lineno"> 3501</span>&#160;    <span class="keywordflow">if</span>(fabs(rdUtot[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>])&lt;sqrtnumepsilon1*fabs(rdUtot[URAD0]) || fabs(uu0[URAD0])&lt;sqrtnumepsilon1*fabs(uu0[UU]) || fabs(pb[URAD0])&lt;sqrtnumepsilon1*fabs(pb[UU])){</div>
<div class="line"><a name="l03502"></a><span class="lineno"> 3502</span>&#160;      radprimaryevolves=1;</div>
<div class="line"><a name="l03503"></a><span class="lineno"> 3503</span>&#160;    }</div>
<div class="line"><a name="l03504"></a><span class="lineno"> 3504</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l03505"></a><span class="lineno"> 3505</span>&#160;      radprimaryevolves=0;</div>
<div class="line"><a name="l03506"></a><span class="lineno"> 3506</span>&#160;    }</div>
<div class="line"><a name="l03507"></a><span class="lineno"> 3507</span>&#160;    <span class="keywordtype">int</span> radextremeprimaryevolves=0;</div>
<div class="line"><a name="l03508"></a><span class="lineno"> 3508</span>&#160;    <span class="keywordflow">if</span>(fabs(rdUtot[UU])&lt;10.0*<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a8913cb5d64cfec23ae1a3052930ec468">NUMEPSILON</a>*fabs(dUtot[URAD0]) || fabs(uu0[URAD0])&lt;10.0*<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a8913cb5d64cfec23ae1a3052930ec468">NUMEPSILON</a>*fabs(uu0[UU]) || fabs(pb[URAD0])&lt;10.0*<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a8913cb5d64cfec23ae1a3052930ec468">NUMEPSILON</a>*fabs(pb[UU])){</div>
<div class="line"><a name="l03509"></a><span class="lineno"> 3509</span>&#160;      radextremeprimaryevolves=1;</div>
<div class="line"><a name="l03510"></a><span class="lineno"> 3510</span>&#160;    }</div>
<div class="line"><a name="l03511"></a><span class="lineno"> 3511</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l03512"></a><span class="lineno"> 3512</span>&#160;      radextremeprimaryevolves=0;</div>
<div class="line"><a name="l03513"></a><span class="lineno"> 3513</span>&#160;    }</div>
<div class="line"><a name="l03514"></a><span class="lineno"> 3514</span>&#160;    <span class="keywordtype">int</span> gasprimaryevolves=0;</div>
<div class="line"><a name="l03515"></a><span class="lineno"> 3515</span>&#160;    <span class="comment">//    if(radprimaryevolves==0 &amp;&amp; (pb[URAD0]&lt;sqrtnumepsilon2*pb[UU] || (-uu0[URAD0])&lt;sqrtnumepsilon2*(-uu0[UU]))){</span></div>
<div class="line"><a name="l03516"></a><span class="lineno"> 3516</span>&#160;    <span class="comment">//    if(pb[URAD0]&lt;sqrtnumepsilon2*pb[UU] || fabs(dUtot[URAD0])&lt;sqrtnumepsilon2*fabs(dUtot[UU])){</span></div>
<div class="line"><a name="l03517"></a><span class="lineno"> 3517</span>&#160;    <span class="keywordflow">if</span>(radprimaryevolves==0 &amp;&amp; (fabs(rdUtot[URAD0])&lt;sqrtnumepsilon2*fabs(rdUtot[UU]) || fabs(uu0[UU])&lt;sqrtnumepsilon2*fabs(uu0[URAD0]) || fabs(pb[UU])&lt;sqrtnumepsilon2*fabs(pb[URAD0]) )){</div>
<div class="line"><a name="l03518"></a><span class="lineno"> 3518</span>&#160;      gasprimaryevolves=1;</div>
<div class="line"><a name="l03519"></a><span class="lineno"> 3519</span>&#160;    }</div>
<div class="line"><a name="l03520"></a><span class="lineno"> 3520</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l03521"></a><span class="lineno"> 3521</span>&#160;      gasprimaryevolves=0;</div>
<div class="line"><a name="l03522"></a><span class="lineno"> 3522</span>&#160;    }</div>
<div class="line"><a name="l03523"></a><span class="lineno"> 3523</span>&#160;    <span class="keywordtype">int</span> gasextremeprimaryevolves=0;</div>
<div class="line"><a name="l03524"></a><span class="lineno"> 3524</span>&#160;    <span class="keywordflow">if</span>(radprimaryevolves==0 &amp;&amp; radextremeprimaryevolves==0 &amp;&amp; (fabs(rdUtot[URAD0])&lt;10.0*<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a8913cb5d64cfec23ae1a3052930ec468">NUMEPSILON</a>*fabs(dUtot[UU]) || fabs(uu0[UU])&lt;10.0*<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a8913cb5d64cfec23ae1a3052930ec468">NUMEPSILON</a>*fabs(uu0[URAD0]) || fabs(pb[UU])&lt;10.0*<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a8913cb5d64cfec23ae1a3052930ec468">NUMEPSILON</a>*fabs(pb[URAD0]) )){</div>
<div class="line"><a name="l03525"></a><span class="lineno"> 3525</span>&#160;      gasextremeprimaryevolves=1;</div>
<div class="line"><a name="l03526"></a><span class="lineno"> 3526</span>&#160;    }</div>
<div class="line"><a name="l03527"></a><span class="lineno"> 3527</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l03528"></a><span class="lineno"> 3528</span>&#160;      gasextremeprimaryevolves=0;</div>
<div class="line"><a name="l03529"></a><span class="lineno"> 3529</span>&#160;    }</div>
<div class="line"><a name="l03530"></a><span class="lineno"> 3530</span>&#160;</div>
<div class="line"><a name="l03531"></a><span class="lineno"> 3531</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa9bac15be449bce1dc3b0a2d4a791521" title="whether to just let PMHD fail and try it first no matter whether primary considerations say otherwise...">LETPMHDFAIL</a>){</div>
<div class="line"><a name="l03532"></a><span class="lineno"> 3532</span>&#160;      <span class="comment">// just let pmhd fail or use total error in way that is setup now...</span></div>
<div class="line"><a name="l03533"></a><span class="lineno"> 3533</span>&#160;      <span class="comment">// still allow extreme catches</span></div>
<div class="line"><a name="l03534"></a><span class="lineno"> 3534</span>&#160;      radprimaryevolves=0;</div>
<div class="line"><a name="l03535"></a><span class="lineno"> 3535</span>&#160;      gasprimaryevolves=0;</div>
<div class="line"><a name="l03536"></a><span class="lineno"> 3536</span>&#160;    }</div>
<div class="line"><a name="l03537"></a><span class="lineno"> 3537</span>&#160;</div>
<div class="line"><a name="l03538"></a><span class="lineno"> 3538</span>&#160;    <span class="keywordflow">if</span>(modemethodlocal==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a861070760a7e713342da86a4c8bfa660">MODEPICKBESTSIMPLE</a>){</div>
<div class="line"><a name="l03539"></a><span class="lineno"> 3539</span>&#160;      <span class="comment">// forcing PMHD method, so must use gas</span></div>
<div class="line"><a name="l03540"></a><span class="lineno"> 3540</span>&#160;      radprimaryevolves=radextremeprimaryevolves=0;</div>
<div class="line"><a name="l03541"></a><span class="lineno"> 3541</span>&#160;      gasprimaryevolves=gasextremeprimaryevolves=1;</div>
<div class="line"><a name="l03542"></a><span class="lineno"> 3542</span>&#160;    }</div>
<div class="line"><a name="l03543"></a><span class="lineno"> 3543</span>&#160;</div>
<div class="line"><a name="l03544"></a><span class="lineno"> 3544</span>&#160;    </div>
<div class="line"><a name="l03545"></a><span class="lineno"> 3545</span>&#160;    <span class="keywordtype">int</span> bsqorhocond=0,funnelcond=0;</div>
<div class="line"><a name="l03546"></a><span class="lineno"> 3546</span>&#160;<span class="preprocessor">#if(DOPERF)</span></div>
<div class="line"><a name="l03547"></a><span class="lineno"> 3547</span>&#160;<span class="preprocessor"></span>    <span class="keywordflow">if</span>(isspc){</div>
<div class="line"><a name="l03548"></a><span class="lineno"> 3548</span>&#160;      <span class="comment">// HACK to force more use of PMHD method to avoid slowdown.</span></div>
<div class="line"><a name="l03549"></a><span class="lineno"> 3549</span>&#160;      <span class="keywordflow">if</span>(q-&gt;<a class="code" href="../../d1/d83/structof__state.html#a2b38c522ec7321af3368706fa4632834">bsq</a>/pb[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>]&gt;1.0){</div>
<div class="line"><a name="l03550"></a><span class="lineno"> 3550</span>&#160;        bsqorhocond=1;</div>
<div class="line"><a name="l03551"></a><span class="lineno"> 3551</span>&#160;      }</div>
<div class="line"><a name="l03552"></a><span class="lineno"> 3552</span>&#160;      <span class="keywordflow">if</span>(q-&gt;<a class="code" href="../../d1/d83/structof__state.html#a2b38c522ec7321af3368706fa4632834">bsq</a>/pb[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>]&gt;0.2*<a class="code" href="../../d8/d5b/defs_8general_8h.html#a0fe8d3c7642e667dd8ae3635506c4273">BSQORHOLIMIT</a> || q-&gt;<a class="code" href="../../d1/d83/structof__state.html#a2b38c522ec7321af3368706fa4632834">bsq</a>/pb[UU]&gt;0.2*<a class="code" href="../../d8/d5b/defs_8general_8h.html#a2ac5e41aa897e1fa82d748b7e38b9c6a">BSQOULIMIT</a> || pb[UU]/pb[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>]&gt;0.1*<a class="code" href="../../d8/d5b/defs_8general_8h.html#a29e0b9f4e26a839ec5b98c698e90ca17">UORHOLIMIT</a>){</div>
<div class="line"><a name="l03553"></a><span class="lineno"> 3553</span>&#160;        radprimaryevolves=radextremeprimaryevolves=0;</div>
<div class="line"><a name="l03554"></a><span class="lineno"> 3554</span>&#160;        gasprimaryevolves=gasextremeprimaryevolves=1;      </div>
<div class="line"><a name="l03555"></a><span class="lineno"> 3555</span>&#160;      }</div>
<div class="line"><a name="l03556"></a><span class="lineno"> 3556</span>&#160;      <span class="keywordflow">if</span>(q-&gt;<a class="code" href="../../d1/d83/structof__state.html#a2b38c522ec7321af3368706fa4632834">bsq</a>/pb[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>]&gt;0.2*<a class="code" href="../../d8/d5b/defs_8general_8h.html#a0fe8d3c7642e667dd8ae3635506c4273">BSQORHOLIMIT</a>){</div>
<div class="line"><a name="l03557"></a><span class="lineno"> 3557</span>&#160;        funnelcond=1;</div>
<div class="line"><a name="l03558"></a><span class="lineno"> 3558</span>&#160;      }</div>
<div class="line"><a name="l03559"></a><span class="lineno"> 3559</span>&#160;    }</div>
<div class="line"><a name="l03560"></a><span class="lineno"> 3560</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03561"></a><span class="lineno"> 3561</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l03562"></a><span class="lineno"> 3562</span>&#160;  </div>
<div class="line"><a name="l03563"></a><span class="lineno"> 3563</span>&#160;</div>
<div class="line"><a name="l03564"></a><span class="lineno"> 3564</span>&#160;</div>
<div class="line"><a name="l03565"></a><span class="lineno"> 3565</span>&#160;    <span class="comment">// DEBUG:</span></div>
<div class="line"><a name="l03566"></a><span class="lineno"> 3566</span>&#160;    <span class="comment">//    dualfprintf(fail_file,&quot;PRIMARYEVOLVES: %d %d %d %d : pb=%g %g uu0=%g %g dUtot=%g %g : sqrtnumepsilon1=%g sqrtnumepsilon2=%g\n&quot;,radprimaryevolves,radextremeprimaryevolves,gasprimaryevolves,gasextremeprimaryevolves,pb[UU],pb[URAD0],-uu0[UU],-uu0[URAD0],dUtot[UU],dUtot[URAD0],sqrtnumepsilon1,sqrtnumepsilon2);</span></div>
<div class="line"><a name="l03567"></a><span class="lineno"> 3567</span>&#160;</div>
<div class="line"><a name="l03568"></a><span class="lineno"> 3568</span>&#160;</div>
<div class="line"><a name="l03569"></a><span class="lineno"> 3569</span>&#160;</div>
<div class="line"><a name="l03571"></a><span class="lineno"> 3571</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l03572"></a><span class="lineno"> 3572</span>&#160;    <span class="comment">// store prior itermethod, before we change it.</span></div>
<div class="line"><a name="l03573"></a><span class="lineno"> 3573</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l03575"></a><span class="lineno"> 3575</span>&#160;<span class="comment"></span>    <span class="keywordtype">int</span> prioritermethodlist[<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#acb843c30a487185fc9ae1e5460a19284" title="array indices for prioritermethod">NUMPRIORITERMETHODINDEX</a>];</div>
<div class="line"><a name="l03576"></a><span class="lineno"> 3576</span>&#160;    <span class="keywordtype">int</span> oo;</div>
<div class="line"><a name="l03577"></a><span class="lineno"> 3577</span>&#160;    <span class="keywordflow">for</span>(oo=0;oo&lt;<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#acb843c30a487185fc9ae1e5460a19284" title="array indices for prioritermethod">NUMPRIORITERMETHODINDEX</a>;oo++){</div>
<div class="line"><a name="l03578"></a><span class="lineno"> 3578</span>&#160;      prioritermethodlist[oo]=GLOBALMACP0A1(prioritermethod,i,j,k,oo);</div>
<div class="line"><a name="l03579"></a><span class="lineno"> 3579</span>&#160;    }</div>
<div class="line"><a name="l03580"></a><span class="lineno"> 3580</span>&#160;</div>
<div class="line"><a name="l03581"></a><span class="lineno"> 3581</span>&#160;</div>
<div class="line"><a name="l03582"></a><span class="lineno"> 3582</span>&#160;</div>
<div class="line"><a name="l03584"></a><span class="lineno"> 3584</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l03585"></a><span class="lineno"> 3585</span>&#160;    <span class="comment">// GET ENERGY</span></div>
<div class="line"><a name="l03586"></a><span class="lineno"> 3586</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l03587"></a><span class="lineno"> 3587</span>&#160;    <span class="comment">// Now do energy if would use only energy or if doing interpolation</span></div>
<div class="line"><a name="l03588"></a><span class="lineno"> 3588</span>&#160;    <span class="comment">// also check energy if entropy thinks we should do explicit</span></div>
<div class="line"><a name="l03589"></a><span class="lineno"> 3589</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l03591"></a><span class="lineno"> 3591</span>&#160;<span class="comment"></span>    <span class="comment">//    if(prioritermethodlist[EOMINDEX] == EOMGRMHD || prioritermethodlist[EOMINDEX] == PRIORITERMETHODNOTSET &amp;&amp; eomtypecond[EOMGRMHD] &amp;&amp; (fracenergy!=0.0 || RADINVBAD(radinvmodentropy) ||  ACTUALHARDORSOFTFAILURE(failreturnentropy)==1 || goexplicitentropy==1)){</span></div>
<div class="line"><a name="l03592"></a><span class="lineno"> 3592</span>&#160;    <span class="keywordflow">if</span>(eomtypecond[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a03d89f51ab60206791830c886d62bfd0">EOMGRMHD</a>] &amp;&amp; (fracenergy!=0.0 || <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0685d01c4383c1608a7ea72cb7ce3791">RADINVBAD</a>(radinvmodentropy) ||  <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a7207286a043c1f65037676ebf80412e5">ACTUALHARDORSOFTFAILURE</a>(failreturnentropy)==1 || goexplicitentropy==1)){</div>
<div class="line"><a name="l03593"></a><span class="lineno"> 3593</span>&#160;</div>
<div class="line"><a name="l03594"></a><span class="lineno"> 3594</span>&#160;</div>
<div class="line"><a name="l03595"></a><span class="lineno"> 3595</span>&#160;      <span class="comment">// quickly try QTYPMHD then QTYURAD</span></div>
<div class="line"><a name="l03596"></a><span class="lineno"> 3596</span>&#160;      <span class="keywordtype">int</span> tryphase1;</div>
<div class="line"><a name="l03597"></a><span class="lineno"> 3597</span>&#160;</div>
<div class="line"><a name="l03598"></a><span class="lineno"> 3598</span>&#160;      <span class="keywordtype">int</span> baseitermethodlist[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8076bfd08bb8012f9711601a7364d93c">NUMPHASES</a>]={<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9cf5ca7f5e5aa1e0bdef53abe3f27c1c">QTYPMHD</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad919bedc37c48678c11e7e45cd1394cf">QTYURAD</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#add9bc1d07725fe2851182eccaa8eb385">QTYPRAD</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9cf5ca7f5e5aa1e0bdef53abe3f27c1c">QTYPMHD</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad919bedc37c48678c11e7e45cd1394cf">QTYURAD</a>,QTYPRAD}; <span class="keywordtype">int</span> whichfirstpmhd=0,whichfirsturad=1,whichfirstprad=2;</div>
<div class="line"><a name="l03599"></a><span class="lineno"> 3599</span>&#160;      <span class="keywordtype">int</span> itermodelist[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8076bfd08bb8012f9711601a7364d93c">NUMPHASES</a>]={<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab9c7390f62ef08325e12b7110621d33a">ITERMODENORMAL</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab9c7390f62ef08325e12b7110621d33a">ITERMODENORMAL</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab9c7390f62ef08325e12b7110621d33a">ITERMODENORMAL</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a480c56e263c4874ccb40f3bbc1b32032">ITERMODESTAGES</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a480c56e263c4874ccb40f3bbc1b32032">ITERMODESTAGES</a>,ITERMODESTAGES};</div>
<div class="line"><a name="l03600"></a><span class="lineno"> 3600</span>&#160;<span class="preprocessor">#if(DOPERF)</span></div>
<div class="line"><a name="l03601"></a><span class="lineno"> 3601</span>&#160;<span class="preprocessor"></span>      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> trueimptryconvlist[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8076bfd08bb8012f9711601a7364d93c">NUMPHASES</a>]={<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afc9b116343212081b674a39ac69ce6ed" title="Funny, even 1E-5 does ok with torus, no worse at Erf~ERADLIMIT instances. Also, does ~3 iterations...">IMPTRYCONV</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a1ed8230cb4aee8a0c35a93613b5abcdd">IMPTRYCONVQUICK</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a1ed8230cb4aee8a0c35a93613b5abcdd">IMPTRYCONVQUICK</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a1ed8230cb4aee8a0c35a93613b5abcdd">IMPTRYCONVQUICK</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a1ed8230cb4aee8a0c35a93613b5abcdd">IMPTRYCONVQUICK</a>,IMPTRYCONVQUICK};</div>
<div class="line"><a name="l03602"></a><span class="lineno"> 3602</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> trueimpokconvlist[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8076bfd08bb8012f9711601a7364d93c">NUMPHASES</a>]={<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a1ed8230cb4aee8a0c35a93613b5abcdd">IMPTRYCONVQUICK</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a1ed8230cb4aee8a0c35a93613b5abcdd">IMPTRYCONVQUICK</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a1ed8230cb4aee8a0c35a93613b5abcdd">IMPTRYCONVQUICK</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a1ed8230cb4aee8a0c35a93613b5abcdd">IMPTRYCONVQUICK</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a1ed8230cb4aee8a0c35a93613b5abcdd">IMPTRYCONVQUICK</a>,IMPTRYCONVQUICK};</div>
<div class="line"><a name="l03603"></a><span class="lineno"> 3603</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> trueimpallowconvconstlist[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8076bfd08bb8012f9711601a7364d93c">NUMPHASES</a>]={<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab1ad1aee2202922457a377be53918cdc" title="what tolerance to use for saying can switch to entropy when u_g is suggested to be bad for energy...">IMPALLOWCONVCONST</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab1ad1aee2202922457a377be53918cdc" title="what tolerance to use for saying can switch to entropy when u_g is suggested to be bad for energy...">IMPALLOWCONVCONST</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab1ad1aee2202922457a377be53918cdc" title="what tolerance to use for saying can switch to entropy when u_g is suggested to be bad for energy...">IMPALLOWCONVCONST</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab1ad1aee2202922457a377be53918cdc" title="what tolerance to use for saying can switch to entropy when u_g is suggested to be bad for energy...">IMPALLOWCONVCONST</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab1ad1aee2202922457a377be53918cdc" title="what tolerance to use for saying can switch to entropy when u_g is suggested to be bad for energy...">IMPALLOWCONVCONST</a>,IMPALLOWCONVCONST};</div>
<div class="line"><a name="l03604"></a><span class="lineno"> 3604</span>&#160;      <span class="keywordtype">int</span> trueimpmaxiterlist[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8076bfd08bb8012f9711601a7364d93c">NUMPHASES</a>]={<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a03eeb7614c6d7be8ab6fb4e6d2036ee3">IMPMAXITERQUICK</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a03eeb7614c6d7be8ab6fb4e6d2036ee3">IMPMAXITERQUICK</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a03eeb7614c6d7be8ab6fb4e6d2036ee3">IMPMAXITERQUICK</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad666390bb51588e23136cdeccc543418">IMPMAXITERMEDIUM</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad666390bb51588e23136cdeccc543418">IMPMAXITERMEDIUM</a>,IMPMAXITERMEDIUM};</div>
<div class="line"><a name="l03605"></a><span class="lineno"> 3605</span>&#160;      <span class="keywordtype">int</span> truenumdampattemptslist[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8076bfd08bb8012f9711601a7364d93c">NUMPHASES</a>]={<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a91061094ecbe11ec91b0999d1f243f20">NUMDAMPATTEMPTSQUICK</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a91061094ecbe11ec91b0999d1f243f20">NUMDAMPATTEMPTSQUICK</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a91061094ecbe11ec91b0999d1f243f20">NUMDAMPATTEMPTSQUICK</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a91061094ecbe11ec91b0999d1f243f20">NUMDAMPATTEMPTSQUICK</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a91061094ecbe11ec91b0999d1f243f20">NUMDAMPATTEMPTSQUICK</a>,NUMDAMPATTEMPTSQUICK};</div>
<div class="line"><a name="l03606"></a><span class="lineno"> 3606</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l03607"></a><span class="lineno"> 3607</span>&#160;<span class="preprocessor"></span>      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> trueimptryconvlist[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8076bfd08bb8012f9711601a7364d93c">NUMPHASES</a>]={<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afc9b116343212081b674a39ac69ce6ed" title="Funny, even 1E-5 does ok with torus, no worse at Erf~ERADLIMIT instances. Also, does ~3 iterations...">IMPTRYCONV</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afc9b116343212081b674a39ac69ce6ed" title="Funny, even 1E-5 does ok with torus, no worse at Erf~ERADLIMIT instances. Also, does ~3 iterations...">IMPTRYCONV</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afc9b116343212081b674a39ac69ce6ed" title="Funny, even 1E-5 does ok with torus, no worse at Erf~ERADLIMIT instances. Also, does ~3 iterations...">IMPTRYCONV</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afc9b116343212081b674a39ac69ce6ed" title="Funny, even 1E-5 does ok with torus, no worse at Erf~ERADLIMIT instances. Also, does ~3 iterations...">IMPTRYCONV</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afc9b116343212081b674a39ac69ce6ed" title="Funny, even 1E-5 does ok with torus, no worse at Erf~ERADLIMIT instances. Also, does ~3 iterations...">IMPTRYCONV</a>,IMPTRYCONV};</div>
<div class="line"><a name="l03608"></a><span class="lineno"> 3608</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> trueimpokconvlist[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8076bfd08bb8012f9711601a7364d93c">NUMPHASES</a>]={<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afc9b116343212081b674a39ac69ce6ed" title="Funny, even 1E-5 does ok with torus, no worse at Erf~ERADLIMIT instances. Also, does ~3 iterations...">IMPTRYCONV</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afc9b116343212081b674a39ac69ce6ed" title="Funny, even 1E-5 does ok with torus, no worse at Erf~ERADLIMIT instances. Also, does ~3 iterations...">IMPTRYCONV</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afc9b116343212081b674a39ac69ce6ed" title="Funny, even 1E-5 does ok with torus, no worse at Erf~ERADLIMIT instances. Also, does ~3 iterations...">IMPTRYCONV</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afc9b116343212081b674a39ac69ce6ed" title="Funny, even 1E-5 does ok with torus, no worse at Erf~ERADLIMIT instances. Also, does ~3 iterations...">IMPTRYCONV</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afc9b116343212081b674a39ac69ce6ed" title="Funny, even 1E-5 does ok with torus, no worse at Erf~ERADLIMIT instances. Also, does ~3 iterations...">IMPTRYCONV</a>,IMPTRYCONV};</div>
<div class="line"><a name="l03609"></a><span class="lineno"> 3609</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> trueimpallowconvconstlist[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8076bfd08bb8012f9711601a7364d93c">NUMPHASES</a>]={<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab1ad1aee2202922457a377be53918cdc" title="what tolerance to use for saying can switch to entropy when u_g is suggested to be bad for energy...">IMPALLOWCONVCONST</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab1ad1aee2202922457a377be53918cdc" title="what tolerance to use for saying can switch to entropy when u_g is suggested to be bad for energy...">IMPALLOWCONVCONST</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab1ad1aee2202922457a377be53918cdc" title="what tolerance to use for saying can switch to entropy when u_g is suggested to be bad for energy...">IMPALLOWCONVCONST</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab1ad1aee2202922457a377be53918cdc" title="what tolerance to use for saying can switch to entropy when u_g is suggested to be bad for energy...">IMPALLOWCONVCONST</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab1ad1aee2202922457a377be53918cdc" title="what tolerance to use for saying can switch to entropy when u_g is suggested to be bad for energy...">IMPALLOWCONVCONST</a>,IMPALLOWCONVCONST};</div>
<div class="line"><a name="l03610"></a><span class="lineno"> 3610</span>&#160;      <span class="keywordtype">int</span> trueimpmaxiterlist[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8076bfd08bb8012f9711601a7364d93c">NUMPHASES</a>]={<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a03eeb7614c6d7be8ab6fb4e6d2036ee3">IMPMAXITERQUICK</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a03eeb7614c6d7be8ab6fb4e6d2036ee3">IMPMAXITERQUICK</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a03eeb7614c6d7be8ab6fb4e6d2036ee3">IMPMAXITERQUICK</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad666390bb51588e23136cdeccc543418">IMPMAXITERMEDIUM</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad666390bb51588e23136cdeccc543418">IMPMAXITERMEDIUM</a>,IMPMAXITERMEDIUM};</div>
<div class="line"><a name="l03611"></a><span class="lineno"> 3611</span>&#160;      <span class="keywordtype">int</span> truenumdampattemptslist[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8076bfd08bb8012f9711601a7364d93c">NUMPHASES</a>]={<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a05f68af4806f09b5fcb143348da66be1">NUMDAMPATTEMPTS</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a05f68af4806f09b5fcb143348da66be1">NUMDAMPATTEMPTS</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a05f68af4806f09b5fcb143348da66be1">NUMDAMPATTEMPTS</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a05f68af4806f09b5fcb143348da66be1">NUMDAMPATTEMPTS</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a05f68af4806f09b5fcb143348da66be1">NUMDAMPATTEMPTS</a>,NUMDAMPATTEMPTS};</div>
<div class="line"><a name="l03612"></a><span class="lineno"> 3612</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03613"></a><span class="lineno"> 3613</span>&#160;<span class="preprocessor"></span>      <span class="keywordtype">int</span> modprimlist[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8076bfd08bb8012f9711601a7364d93c">NUMPHASES</a>]={0,0,0,1,0,0};</div>
<div class="line"><a name="l03614"></a><span class="lineno"> 3614</span>&#160;      <span class="keywordtype">int</span> checkradinvlist[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8076bfd08bb8012f9711601a7364d93c">NUMPHASES</a>]={0,1,1,0,1,1};</div>
<div class="line"><a name="l03615"></a><span class="lineno"> 3615</span>&#160;      <span class="keywordtype">int</span> eomtypelist[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8076bfd08bb8012f9711601a7364d93c">NUMPHASES</a>]={<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a03d89f51ab60206791830c886d62bfd0">EOMGRMHD</a>,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a03d89f51ab60206791830c886d62bfd0">EOMGRMHD</a>,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a03d89f51ab60206791830c886d62bfd0">EOMGRMHD</a>,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a03d89f51ab60206791830c886d62bfd0">EOMGRMHD</a>,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a03d89f51ab60206791830c886d62bfd0">EOMGRMHD</a>,EOMGRMHD};</div>
<div class="line"><a name="l03616"></a><span class="lineno"> 3616</span>&#160;</div>
<div class="line"><a name="l03617"></a><span class="lineno"> 3617</span>&#160;      <span class="comment">// results in list</span></div>
<div class="line"><a name="l03618"></a><span class="lineno"> 3618</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> errorabslist[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8076bfd08bb8012f9711601a7364d93c">NUMPHASES</a>][<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa63447acbbbc62cbedae23eac61c716e" title="determine which error will use when deciding if converged or not.">NUMERRORTYPES</a>];</div>
<div class="line"><a name="l03619"></a><span class="lineno"> 3619</span>&#160;      set_array(errorabslist,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8076bfd08bb8012f9711601a7364d93c">NUMPHASES</a>*<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa63447acbbbc62cbedae23eac61c716e" title="determine which error will use when deciding if converged or not.">NUMERRORTYPES</a>,MPI_FTYPE,1.0);</div>
<div class="line"><a name="l03620"></a><span class="lineno"> 3620</span>&#160;      <span class="keywordtype">int</span> radinvmodlist[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8076bfd08bb8012f9711601a7364d93c">NUMPHASES</a>];</div>
<div class="line"><a name="l03621"></a><span class="lineno"> 3621</span>&#160;      set_array(radinvmodlist,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8076bfd08bb8012f9711601a7364d93c">NUMPHASES</a>,MPI_INT,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ad987489760e6592057a80faf09588c88" title="unfixable inversion problems">UTOPRIMRADFAILBAD1</a>);</div>
<div class="line"><a name="l03622"></a><span class="lineno"> 3622</span>&#160;</div>
<div class="line"><a name="l03623"></a><span class="lineno"> 3623</span>&#160;      <span class="comment">// reorder method if desired</span></div>
<div class="line"><a name="l03624"></a><span class="lineno"> 3624</span>&#160;      <span class="comment">// KORALNOTE: radinv check would nominally catch if PMHD method failed due to machine errors in GAS leading to huge changes in RAD leading to E_r&lt;0 or gamma&gt;gammaradmax, but might as well use desired method first.</span></div>
<div class="line"><a name="l03625"></a><span class="lineno"> 3625</span>&#160;      <span class="comment">// normal checkradinvlist will catch if prad method doesn&#39;t lead to radinv but urad method does.</span></div>
<div class="line"><a name="l03626"></a><span class="lineno"> 3626</span>&#160;      <span class="comment">// normal checkradinvlist will catch if somehow rad method leads to radinv but gas method doesn&#39;t.</span></div>
<div class="line"><a name="l03627"></a><span class="lineno"> 3627</span>&#160;      <span class="keywordflow">if</span>(gasprimaryevolves==0){ <span class="comment">// if gas primary evolves, then keep original order because PMHD is fastest method.</span></div>
<div class="line"><a name="l03628"></a><span class="lineno"> 3628</span>&#160;        <span class="keywordflow">if</span>(radprimaryevolves){</div>
<div class="line"><a name="l03629"></a><span class="lineno"> 3629</span>&#160;          <span class="keywordflow">if</span>(</div>
<div class="line"><a name="l03630"></a><span class="lineno"> 3630</span>&#160;             (<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a0e05f8ddd1f85dddb1432aa1941bbbd7" title="whether to use history of methods to determine current method  KORALTODO: Needs work.">USEPRIORITERMETHOD</a> &amp;&amp; (prioritermethodlist[<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a19f0668a5075a4ca1061348f26a4fc13">BASEITERMETHODINDEX</a>] == <a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a5b3bcf4eaf08299f68268d75a01a0f9b">PRIORITERMETHODNOTSET</a> ||  prioritermethodlist[<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a19f0668a5075a4ca1061348f26a4fc13">BASEITERMETHODINDEX</a>] == <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad919bedc37c48678c11e7e45cd1394cf">QTYURAD</a>))</div>
<div class="line"><a name="l03631"></a><span class="lineno"> 3631</span>&#160;             || <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a0e05f8ddd1f85dddb1432aa1941bbbd7" title="whether to use history of methods to determine current method  KORALTODO: Needs work.">USEPRIORITERMETHOD</a>==0</div>
<div class="line"><a name="l03632"></a><span class="lineno"> 3632</span>&#160;             ){</div>
<div class="line"><a name="l03633"></a><span class="lineno"> 3633</span>&#160;            tryphase1=-1;</div>
<div class="line"><a name="l03634"></a><span class="lineno"> 3634</span>&#160;            tryphase1++; baseitermethodlist[tryphase1]=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad919bedc37c48678c11e7e45cd1394cf">QTYURAD</a>; modprimlist[tryphase1]=0; whichfirsturad=tryphase1;</div>
<div class="line"><a name="l03635"></a><span class="lineno"> 3635</span>&#160;            tryphase1++; baseitermethodlist[tryphase1]=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#add9bc1d07725fe2851182eccaa8eb385">QTYPRAD</a>; modprimlist[tryphase1]=0; whichfirstprad=tryphase1;</div>
<div class="line"><a name="l03636"></a><span class="lineno"> 3636</span>&#160;            tryphase1++; baseitermethodlist[tryphase1]=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9cf5ca7f5e5aa1e0bdef53abe3f27c1c">QTYPMHD</a>; modprimlist[tryphase1]=0; whichfirstpmhd=tryphase1;</div>
<div class="line"><a name="l03637"></a><span class="lineno"> 3637</span>&#160;            tryphase1++; baseitermethodlist[tryphase1]=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad919bedc37c48678c11e7e45cd1394cf">QTYURAD</a>; modprimlist[tryphase1]=0;</div>
<div class="line"><a name="l03638"></a><span class="lineno"> 3638</span>&#160;            tryphase1++; baseitermethodlist[tryphase1]=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#add9bc1d07725fe2851182eccaa8eb385">QTYPRAD</a>; modprimlist[tryphase1]=0;</div>
<div class="line"><a name="l03639"></a><span class="lineno"> 3639</span>&#160;            tryphase1++; baseitermethodlist[tryphase1]=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9cf5ca7f5e5aa1e0bdef53abe3f27c1c">QTYPMHD</a>; modprimlist[tryphase1]=1;</div>
<div class="line"><a name="l03640"></a><span class="lineno"> 3640</span>&#160;          }</div>
<div class="line"><a name="l03641"></a><span class="lineno"> 3641</span>&#160;          <span class="keywordflow">if</span>(</div>
<div class="line"><a name="l03642"></a><span class="lineno"> 3642</span>&#160;             <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a0e05f8ddd1f85dddb1432aa1941bbbd7" title="whether to use history of methods to determine current method  KORALTODO: Needs work.">USEPRIORITERMETHOD</a> &amp;&amp; prioritermethodlist[<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a19f0668a5075a4ca1061348f26a4fc13">BASEITERMETHODINDEX</a>] == <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#add9bc1d07725fe2851182eccaa8eb385">QTYPRAD</a></div>
<div class="line"><a name="l03643"></a><span class="lineno"> 3643</span>&#160;             ){</div>
<div class="line"><a name="l03644"></a><span class="lineno"> 3644</span>&#160;            tryphase1=-1;</div>
<div class="line"><a name="l03645"></a><span class="lineno"> 3645</span>&#160;            tryphase1++; baseitermethodlist[tryphase1]=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#add9bc1d07725fe2851182eccaa8eb385">QTYPRAD</a>; modprimlist[tryphase1]=0; whichfirstprad=tryphase1;</div>
<div class="line"><a name="l03646"></a><span class="lineno"> 3646</span>&#160;            tryphase1++; baseitermethodlist[tryphase1]=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad919bedc37c48678c11e7e45cd1394cf">QTYURAD</a>; modprimlist[tryphase1]=0; whichfirsturad=tryphase1;</div>
<div class="line"><a name="l03647"></a><span class="lineno"> 3647</span>&#160;            tryphase1++; baseitermethodlist[tryphase1]=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9cf5ca7f5e5aa1e0bdef53abe3f27c1c">QTYPMHD</a>; modprimlist[tryphase1]=0; whichfirstpmhd=tryphase1;</div>
<div class="line"><a name="l03648"></a><span class="lineno"> 3648</span>&#160;            tryphase1++; baseitermethodlist[tryphase1]=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#add9bc1d07725fe2851182eccaa8eb385">QTYPRAD</a>; modprimlist[tryphase1]=0;</div>
<div class="line"><a name="l03649"></a><span class="lineno"> 3649</span>&#160;            tryphase1++; baseitermethodlist[tryphase1]=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad919bedc37c48678c11e7e45cd1394cf">QTYURAD</a>; modprimlist[tryphase1]=0;</div>
<div class="line"><a name="l03650"></a><span class="lineno"> 3650</span>&#160;            tryphase1++; baseitermethodlist[tryphase1]=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9cf5ca7f5e5aa1e0bdef53abe3f27c1c">QTYPMHD</a>; modprimlist[tryphase1]=1;</div>
<div class="line"><a name="l03651"></a><span class="lineno"> 3651</span>&#160;          }</div>
<div class="line"><a name="l03652"></a><span class="lineno"> 3652</span>&#160;        }<span class="comment">// if rad is expected to need to be evolved</span></div>
<div class="line"><a name="l03653"></a><span class="lineno"> 3653</span>&#160;      }</div>
<div class="line"><a name="l03654"></a><span class="lineno"> 3654</span>&#160;</div>
<div class="line"><a name="l03655"></a><span class="lineno"> 3655</span>&#160;      </div>
<div class="line"><a name="l03656"></a><span class="lineno"> 3656</span>&#160;</div>
<div class="line"><a name="l03657"></a><span class="lineno"> 3657</span>&#160;</div>
<div class="line"><a name="l03658"></a><span class="lineno"> 3658</span>&#160;    </div>
<div class="line"><a name="l03659"></a><span class="lineno"> 3659</span>&#160;</div>
<div class="line"><a name="l03660"></a><span class="lineno"> 3660</span>&#160;      <span class="comment">// ENERGY PHASE LOOP</span></div>
<div class="line"><a name="l03661"></a><span class="lineno"> 3661</span>&#160;      <span class="keywordtype">int</span> firsttryphase1used=-1;</div>
<div class="line"><a name="l03662"></a><span class="lineno"> 3662</span>&#160;      <span class="keywordflow">for</span>(tryphase1=0;tryphase1&lt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8076bfd08bb8012f9711601a7364d93c">NUMPHASES</a>;tryphase1++){</div>
<div class="line"><a name="l03663"></a><span class="lineno"> 3663</span>&#160;</div>
<div class="line"><a name="l03664"></a><span class="lineno"> 3664</span>&#160;        <span class="comment">//        dualfprintf(fail_file,&quot;TRYING: tryphase1=%d : %d %d %d\n&quot;,tryphase1,gasextremeprimaryevolves,radextremeprimaryevolves,baseitermethodlist[tryphase1]);</span></div>
<div class="line"><a name="l03665"></a><span class="lineno"> 3665</span>&#160;</div>
<div class="line"><a name="l03666"></a><span class="lineno"> 3666</span>&#160;        <span class="comment">// pick best simple method avoids all solvers except PMHD</span></div>
<div class="line"><a name="l03667"></a><span class="lineno"> 3667</span>&#160;        <span class="keywordflow">if</span>(modemethodlocal==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a861070760a7e713342da86a4c8bfa660">MODEPICKBESTSIMPLE</a> &amp;&amp; baseitermethodlist[tryphase1]!=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9cf5ca7f5e5aa1e0bdef53abe3f27c1c">QTYPMHD</a>) <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l03668"></a><span class="lineno"> 3668</span>&#160;</div>
<div class="line"><a name="l03669"></a><span class="lineno"> 3669</span>&#160;<span class="preprocessor">#if(DOPERF)</span></div>
<div class="line"><a name="l03670"></a><span class="lineno"> 3670</span>&#160;<span class="preprocessor"></span>        <span class="comment">// pick best simple 2 method avoids all itermodestages methods</span></div>
<div class="line"><a name="l03671"></a><span class="lineno"> 3671</span>&#160;        <span class="keywordflow">if</span>(modemethodlocal==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a861070760a7e713342da86a4c8bfa660">MODEPICKBESTSIMPLE</a> &amp;&amp; itermodelist[tryphase1]==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a480c56e263c4874ccb40f3bbc1b32032">ITERMODESTAGES</a>) <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l03672"></a><span class="lineno"> 3672</span>&#160;        <span class="keywordflow">if</span>(funnelcond){ <span class="comment">// then don&#39;t expect to treat density accurate anyways, just need ok accuracy and stability</span></div>
<div class="line"><a name="l03673"></a><span class="lineno"> 3673</span>&#160;          trueimptryconvlist[tryphase1]=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(trueimptryconvlist[tryphase1],<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a2970b7302296037943041f82a6cb59fc">IMPTRYCONVMARGINAL</a>);</div>
<div class="line"><a name="l03674"></a><span class="lineno"> 3674</span>&#160;        }</div>
<div class="line"><a name="l03675"></a><span class="lineno"> 3675</span>&#160;        <span class="comment">// allow tolerance to be higher if...</span></div>
<div class="line"><a name="l03676"></a><span class="lineno"> 3676</span>&#160;        <span class="keywordflow">if</span>(V[1]&lt;<a class="code" href="../../d8/d5b/defs_8general_8h.html#a20e81ef2343c6d8db701c6613cbcd279">Rhor</a> &amp;&amp; isbhspc){</div>
<div class="line"><a name="l03677"></a><span class="lineno"> 3677</span>&#160;          <span class="comment">//trueimptryconvlist[tryphase1]=MAX(trueimptryconvlist[tryphase1],IMPTRYCONV_RHORHIGHERTOL);</span></div>
<div class="line"><a name="l03678"></a><span class="lineno"> 3678</span>&#160;          trueimpallowconvconstlist[tryphase1]=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(trueimpallowconvconstlist[tryphase1],<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a69f5311b52c9fce4441c9ded33d86184">IMPALLOWCONV_RHORHIGHERTOL</a>);</div>
<div class="line"><a name="l03679"></a><span class="lineno"> 3679</span>&#160;        }</div>
<div class="line"><a name="l03680"></a><span class="lineno"> 3680</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(V[1]&gt;<a class="code" href="../../da/d3e/definit_8h.html#a96144cf19084532e7fa17366b1b4b5b9">OUTERDEATHRADIUS</a> &amp;&amp; <a class="code" href="../../da/d3e/definit_8h.html#aa2b0c5dd91e7e776f8944c26ff7ecf0b">OUTERDEATH</a>==1){</div>
<div class="line"><a name="l03681"></a><span class="lineno"> 3681</span>&#160;          trueimptryconvlist[tryphase1]=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(trueimptryconvlist[tryphase1],<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#adfc141d6141c97938025b106e5c2484f">IMPTRYCONV_ROUTERHIGHERTOL</a>);</div>
<div class="line"><a name="l03682"></a><span class="lineno"> 3682</span>&#160;        } </div>
<div class="line"><a name="l03683"></a><span class="lineno"> 3683</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l03684"></a><span class="lineno"> 3684</span>&#160;<span class="preprocessor"></span>        <span class="comment">// pick best simple 2 method avoids all itermodestages methods </span></div>
<div class="line"><a name="l03685"></a><span class="lineno"> 3685</span>&#160;        <span class="keywordflow">if</span>(modemethodlocal==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a4a773e56e52c24230ab87c41877f241e">MODEPICKBESTSIMPLE2</a> &amp;&amp; itermodelist[tryphase1]==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a480c56e263c4874ccb40f3bbc1b32032">ITERMODESTAGES</a>) <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l03686"></a><span class="lineno"> 3686</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03687"></a><span class="lineno"> 3687</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l03688"></a><span class="lineno"> 3688</span>&#160;        <span class="comment">// avoid method in case very non-dominant since then would give errorneous (critically bad even) results.  If methods that can use fail, have to revert to entropy or fixups.</span></div>
<div class="line"><a name="l03689"></a><span class="lineno"> 3689</span>&#160;        <span class="keywordflow">if</span>(radextremeprimaryevolves &amp;&amp; baseitermethodlist[tryphase1]==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9cf5ca7f5e5aa1e0bdef53abe3f27c1c">QTYPMHD</a>) <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l03690"></a><span class="lineno"> 3690</span>&#160;        <span class="keywordflow">if</span>(gasextremeprimaryevolves &amp;&amp; (baseitermethodlist[tryphase1]==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad919bedc37c48678c11e7e45cd1394cf">QTYURAD</a> || baseitermethodlist[tryphase1]==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#add9bc1d07725fe2851182eccaa8eb385">QTYPRAD</a>)) <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l03691"></a><span class="lineno"> 3691</span>&#160;        </div>
<div class="line"><a name="l03692"></a><span class="lineno"> 3692</span>&#160;        <span class="keywordflow">if</span>(radextremeprimaryevolves==0 &amp;&amp; (baseitermethodlist[tryphase1]==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad919bedc37c48678c11e7e45cd1394cf">QTYURAD</a> || baseitermethodlist[tryphase1]==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#add9bc1d07725fe2851182eccaa8eb385">QTYPRAD</a>) ){</div>
<div class="line"><a name="l03693"></a><span class="lineno"> 3693</span>&#160;          <span class="comment">// if not in extreme radiative regime, then don&#39;t do damping for raditive schemes that are slow.</span></div>
<div class="line"><a name="l03694"></a><span class="lineno"> 3694</span>&#160;          truenumdampattemptslist[tryphase1]=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a91061094ecbe11ec91b0999d1f243f20">NUMDAMPATTEMPTSQUICK</a>;</div>
<div class="line"><a name="l03695"></a><span class="lineno"> 3695</span>&#160;          <span class="comment">// and don&#39;t try to get too good of error.</span></div>
<div class="line"><a name="l03696"></a><span class="lineno"> 3696</span>&#160;          trueimptryconvlist[tryphase1]=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a1ed8230cb4aee8a0c35a93613b5abcdd">IMPTRYCONVQUICK</a>;</div>
<div class="line"><a name="l03697"></a><span class="lineno"> 3697</span>&#160;          <span class="comment">// and avoid stages</span></div>
<div class="line"><a name="l03698"></a><span class="lineno"> 3698</span>&#160;          itermodelist[tryphase1]=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab9c7390f62ef08325e12b7110621d33a">ITERMODENORMAL</a>;</div>
<div class="line"><a name="l03699"></a><span class="lineno"> 3699</span>&#160;        }</div>
<div class="line"><a name="l03700"></a><span class="lineno"> 3700</span>&#160;        <span class="keywordflow">if</span>(gasextremeprimaryevolves==0 &amp;&amp; (baseitermethodlist[tryphase1]==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9cf5ca7f5e5aa1e0bdef53abe3f27c1c">QTYPMHD</a>)){</div>
<div class="line"><a name="l03701"></a><span class="lineno"> 3701</span>&#160;          <span class="comment">// then still try to get good error since fast method, so no changes.</span></div>
<div class="line"><a name="l03702"></a><span class="lineno"> 3702</span>&#160;        }</div>
<div class="line"><a name="l03703"></a><span class="lineno"> 3703</span>&#160;</div>
<div class="line"><a name="l03704"></a><span class="lineno"> 3704</span>&#160;</div>
<div class="line"><a name="l03705"></a><span class="lineno"> 3705</span>&#160;        <span class="keywordflow">if</span>(modemethodlocal==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a861070760a7e713342da86a4c8bfa660">MODEPICKBESTSIMPLE</a>){</div>
<div class="line"><a name="l03706"></a><span class="lineno"> 3706</span>&#160;          <span class="comment">// do nothing, don&#39;t skip stages.  Even when iteration-error is small, often stages can get both iteration and total errors to be small.</span></div>
<div class="line"><a name="l03707"></a><span class="lineno"> 3707</span>&#160;        }</div>
<div class="line"><a name="l03708"></a><span class="lineno"> 3708</span>&#160;        <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l03709"></a><span class="lineno"> 3709</span>&#160;          <span class="comment">// If already tried QTYPMHD and that got error(0)&lt;tol but error(1)&gt;tol, then skip QTYPMHD with stages since should switch to QTYURAD or QTYPRAD because STAGES won&#39;t improve on error(1) if error(0)&lt;tol.</span></div>
<div class="line"><a name="l03710"></a><span class="lineno"> 3710</span>&#160;          <span class="comment">// independent of radinvmod.  If ==0 or ==1, still should skip if error in that condition.</span></div>
<div class="line"><a name="l03711"></a><span class="lineno"> 3711</span>&#160;          <span class="keywordflow">if</span>(baseitermethodlist[tryphase1]==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9cf5ca7f5e5aa1e0bdef53abe3f27c1c">QTYPMHD</a> &amp;&amp; errorabslist[whichfirstpmhd][0]&lt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afc9b116343212081b674a39ac69ce6ed" title="Funny, even 1E-5 does ok with torus, no worse at Erf~ERADLIMIT instances. Also, does ~3 iterations...">IMPTRYCONV</a> &amp;&amp; errorabslist[whichfirstpmhd][1]&gt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afc9b116343212081b674a39ac69ce6ed" title="Funny, even 1E-5 does ok with torus, no worse at Erf~ERADLIMIT instances. Also, does ~3 iterations...">IMPTRYCONV</a> &amp;&amp; <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>==1){</div>
<div class="line"><a name="l03712"></a><span class="lineno"> 3712</span>&#160;            <span class="comment">// then should skip this case and rely upon radiative solvers</span></div>
<div class="line"><a name="l03713"></a><span class="lineno"> 3713</span>&#160;            <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l03714"></a><span class="lineno"> 3714</span>&#160;          }</div>
<div class="line"><a name="l03715"></a><span class="lineno"> 3715</span>&#160;</div>
<div class="line"><a name="l03716"></a><span class="lineno"> 3716</span>&#160;          <span class="keywordflow">if</span>(baseitermethodlist[tryphase1]==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad919bedc37c48678c11e7e45cd1394cf">QTYURAD</a> &amp;&amp; errorabslist[whichfirsturad][0]&lt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afc9b116343212081b674a39ac69ce6ed" title="Funny, even 1E-5 does ok with torus, no worse at Erf~ERADLIMIT instances. Also, does ~3 iterations...">IMPTRYCONV</a> &amp;&amp; errorabslist[whichfirsturad][1]&gt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afc9b116343212081b674a39ac69ce6ed" title="Funny, even 1E-5 does ok with torus, no worse at Erf~ERADLIMIT instances. Also, does ~3 iterations...">IMPTRYCONV</a> &amp;&amp; <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>==1){</div>
<div class="line"><a name="l03717"></a><span class="lineno"> 3717</span>&#160;            <span class="comment">// then should skip this case and rely upon pmhd or prad</span></div>
<div class="line"><a name="l03718"></a><span class="lineno"> 3718</span>&#160;            <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l03719"></a><span class="lineno"> 3719</span>&#160;          }</div>
<div class="line"><a name="l03720"></a><span class="lineno"> 3720</span>&#160;</div>
<div class="line"><a name="l03721"></a><span class="lineno"> 3721</span>&#160;          <span class="keywordflow">if</span>(baseitermethodlist[tryphase1]==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#add9bc1d07725fe2851182eccaa8eb385">QTYPRAD</a> &amp;&amp; errorabslist[whichfirstprad][0]&lt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afc9b116343212081b674a39ac69ce6ed" title="Funny, even 1E-5 does ok with torus, no worse at Erf~ERADLIMIT instances. Also, does ~3 iterations...">IMPTRYCONV</a> &amp;&amp; errorabslist[whichfirstprad][1]&gt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afc9b116343212081b674a39ac69ce6ed" title="Funny, even 1E-5 does ok with torus, no worse at Erf~ERADLIMIT instances. Also, does ~3 iterations...">IMPTRYCONV</a> &amp;&amp; <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>==1){</div>
<div class="line"><a name="l03722"></a><span class="lineno"> 3722</span>&#160;            <span class="comment">// then should skip this case and rely upon pmhd or urad</span></div>
<div class="line"><a name="l03723"></a><span class="lineno"> 3723</span>&#160;            <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l03724"></a><span class="lineno"> 3724</span>&#160;          }</div>
<div class="line"><a name="l03725"></a><span class="lineno"> 3725</span>&#160;</div>
<div class="line"><a name="l03726"></a><span class="lineno"> 3726</span>&#160;          <span class="comment">//        if(prioritermethodlist[EOMTYPEINDEX]==EOMENTROPYGRMHD &amp;&amp; itermodelist[tryphase1]==ITERMODESTAGES &amp;&amp; errorabsenergybest[0]&lt;IMPTRYCONV &amp;&amp; errorabsenergybest[1]&gt;IMPTRYCONV &amp;&amp; WHICHERROR==1){</span></div>
<div class="line"><a name="l03727"></a><span class="lineno"> 3727</span>&#160;          <span class="comment">//          // then assume went through all ITERMODENORMAL cases and best error had good iteration tolerance, but best error has bad total error, and previous solution was entropy, so skip itermodestages.</span></div>
<div class="line"><a name="l03728"></a><span class="lineno"> 3728</span>&#160;          <span class="comment">//          // this assumes ITERMODESTAGES is expensive and should only do if ........</span></div>
<div class="line"><a name="l03729"></a><span class="lineno"> 3729</span>&#160;          <span class="comment">//          continue;</span></div>
<div class="line"><a name="l03730"></a><span class="lineno"> 3730</span>&#160;          <span class="comment">//        }</span></div>
<div class="line"><a name="l03731"></a><span class="lineno"> 3731</span>&#160;        }</div>
<div class="line"><a name="l03732"></a><span class="lineno"> 3732</span>&#160;</div>
<div class="line"><a name="l03733"></a><span class="lineno"> 3733</span>&#160;</div>
<div class="line"><a name="l03734"></a><span class="lineno"> 3734</span>&#160;        <span class="comment">//        dualfprintf(fail_file,&quot;MAYBEREALLYTRYING: tryphase1=%d : %d %d %d\n&quot;,tryphase1,radinvmodenergybest,checkradinvlist[tryphase1],failreturnenergybest);</span></div>
<div class="line"><a name="l03735"></a><span class="lineno"> 3735</span>&#160;</div>
<div class="line"><a name="l03736"></a><span class="lineno"> 3736</span>&#160;</div>
<div class="line"><a name="l03737"></a><span class="lineno"> 3737</span>&#160;</div>
<div class="line"><a name="l03738"></a><span class="lineno"> 3738</span>&#160;        <span class="comment">// __WORKINGONIT__</span></div>
<div class="line"><a name="l03739"></a><span class="lineno"> 3739</span>&#160;        <span class="comment">//        if(baseitermethodlist[tryphase1]==QTYURAD || baseitermethodlist[tryphase1]==QTYPRAD) continue; // skip this method for now.</span></div>
<div class="line"><a name="l03740"></a><span class="lineno"> 3740</span>&#160;</div>
<div class="line"><a name="l03741"></a><span class="lineno"> 3741</span>&#160;</div>
<div class="line"><a name="l03742"></a><span class="lineno"> 3742</span>&#160;        <span class="keywordflow">if</span>(reducetoquick){</div>
<div class="line"><a name="l03743"></a><span class="lineno"> 3743</span>&#160;          <span class="keywordflow">if</span>(reducetoquick==1){</div>
<div class="line"><a name="l03744"></a><span class="lineno"> 3744</span>&#160;            trueimptryconvlist[tryphase1]=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ac5e04595551dd07bf6f57b21d5911e81">IMPTRYCONVSUPERQUICK</a>;</div>
<div class="line"><a name="l03745"></a><span class="lineno"> 3745</span>&#160;            trueimpmaxiterlist[tryphase1]=1;</div>
<div class="line"><a name="l03746"></a><span class="lineno"> 3746</span>&#160;          }</div>
<div class="line"><a name="l03747"></a><span class="lineno"> 3747</span>&#160;          <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l03748"></a><span class="lineno"> 3748</span>&#160;            trueimptryconvlist[tryphase1]=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a1ed8230cb4aee8a0c35a93613b5abcdd">IMPTRYCONVQUICK</a>;</div>
<div class="line"><a name="l03749"></a><span class="lineno"> 3749</span>&#160;            trueimpmaxiterlist[tryphase1]=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a03eeb7614c6d7be8ab6fb4e6d2036ee3">IMPMAXITERQUICK</a>;</div>
<div class="line"><a name="l03750"></a><span class="lineno"> 3750</span>&#160;          }</div>
<div class="line"><a name="l03751"></a><span class="lineno"> 3751</span>&#160;          <span class="keywordflow">if</span>(firsttryphase1used!=-1) <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l03752"></a><span class="lineno"> 3752</span>&#160;        }</div>
<div class="line"><a name="l03753"></a><span class="lineno"> 3753</span>&#160;</div>
<div class="line"><a name="l03754"></a><span class="lineno"> 3754</span>&#160;</div>
<div class="line"><a name="l03755"></a><span class="lineno"> 3755</span>&#160;        <span class="comment">// consider radinvmod only if error bad for original approach.  Avoids excessive attempts when should hit radiative ceiling and error is small.</span></div>
<div class="line"><a name="l03756"></a><span class="lineno"> 3756</span>&#160;        <span class="comment">// KORALTODO: KORALNOTE: If explicit was triggered (failreturnenergy) then could move on, but go ahead and test using other methods in case radinvmod!=0 can be avoided.</span></div>
<div class="line"><a name="l03757"></a><span class="lineno"> 3757</span>&#160;        <span class="comment">//radinvmodenergybest!=0</span></div>
<div class="line"><a name="l03758"></a><span class="lineno"> 3758</span>&#160;</div>
<div class="line"><a name="l03759"></a><span class="lineno"> 3759</span>&#160;        <span class="keywordtype">int</span> needtotry;</div>
<div class="line"><a name="l03760"></a><span class="lineno"> 3760</span>&#160;        needtotry=(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0685d01c4383c1608a7ea72cb7ce3791">RADINVBAD</a>(radinvmodenergybest) &amp;&amp; checkradinvlist[tryphase1] || <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a7207286a043c1f65037676ebf80412e5">ACTUALHARDORSOFTFAILURE</a>(failreturnenergybest) &amp;&amp; failreturnenergybest!=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a42e7e780e89073f5d14dfafda3bae62e">FAILRETURNMODESWITCH</a>);</div>
<div class="line"><a name="l03761"></a><span class="lineno"> 3761</span>&#160;</div>
<div class="line"><a name="l03762"></a><span class="lineno"> 3762</span>&#160;        <span class="keywordflow">if</span>(needtotry){</div>
<div class="line"><a name="l03763"></a><span class="lineno"> 3763</span>&#160;          <span class="keywordflow">if</span>(firsttryphase1used==-1) firsttryphase1used=tryphase1;</div>
<div class="line"><a name="l03764"></a><span class="lineno"> 3764</span>&#160;          tryphaselistenergy[tryphase1]++;</div>
<div class="line"><a name="l03765"></a><span class="lineno"> 3765</span>&#160;</div>
<div class="line"><a name="l03766"></a><span class="lineno"> 3766</span>&#160;          <span class="comment">//          dualfprintf(fail_file,&quot;REALLYTRYING: tryphase1=%d\n&quot;,tryphase1);</span></div>
<div class="line"><a name="l03767"></a><span class="lineno"> 3767</span>&#160;     </div>
<div class="line"><a name="l03768"></a><span class="lineno"> 3768</span>&#160;</div>
<div class="line"><a name="l03769"></a><span class="lineno"> 3769</span>&#160;          errorabsenergyold[0]=errorabsenergy[0];</div>
<div class="line"><a name="l03770"></a><span class="lineno"> 3770</span>&#160;          errorabsenergyold[1]=errorabsenergy[1];</div>
<div class="line"><a name="l03771"></a><span class="lineno"> 3771</span>&#160;          radinvmodenergyold=radinvmodenergy;</div>
<div class="line"><a name="l03772"></a><span class="lineno"> 3772</span>&#160;          itersenergyold=itersenergy;</div>
<div class="line"><a name="l03773"></a><span class="lineno"> 3773</span>&#160;          <span class="comment">//</span></div>
<div class="line"><a name="l03774"></a><span class="lineno"> 3774</span>&#160;          whichcapenergy=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a4b6c6060c025e15f1d92aae3dcb9365b" title="which cap type to place in rad inversion">CAPTYPEBASIC</a>;</div>
<div class="line"><a name="l03775"></a><span class="lineno"> 3775</span>&#160;          <span class="comment">//whichcapenergy=CAPTYPEBASIC;</span></div>
<div class="line"><a name="l03776"></a><span class="lineno"> 3776</span>&#160;          baseitermethodenergy=baseitermethodlist[tryphase1];</div>
<div class="line"><a name="l03777"></a><span class="lineno"> 3777</span>&#160;          itermodeenergy=itermodelist[tryphase1];</div>
<div class="line"><a name="l03778"></a><span class="lineno"> 3778</span>&#160;          trueimptryconvenergy=trueimptryconvlist[tryphase1];</div>
<div class="line"><a name="l03779"></a><span class="lineno"> 3779</span>&#160;          trueimpokconvenergy=(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(trueimptryconvlist[tryphase1],trueimpokconvlist[tryphase1]));</div>
<div class="line"><a name="l03780"></a><span class="lineno"> 3780</span>&#160;          trueimpallowconvenergy=(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(trueimptryconvlist[tryphase1],trueimpallowconvconstlist[tryphase1]));</div>
<div class="line"><a name="l03781"></a><span class="lineno"> 3781</span>&#160;          trueimpmaxiterenergy=trueimpmaxiterlist[tryphase1];</div>
<div class="line"><a name="l03782"></a><span class="lineno"> 3782</span>&#160;          truenumdampattemptsenergy=truenumdampattemptslist[tryphase1];</div>
<div class="line"><a name="l03783"></a><span class="lineno"> 3783</span>&#160;          <span class="keywordtype">int</span> modprim=0;</div>
<div class="line"><a name="l03784"></a><span class="lineno"> 3784</span>&#160;          <span class="keywordflow">if</span>(havebackup==0) modprim=modprimlist[tryphase1];</div>
<div class="line"><a name="l03785"></a><span class="lineno"> 3785</span>&#160;          <span class="comment">//</span></div>
<div class="line"><a name="l03786"></a><span class="lineno"> 3786</span>&#160;          <span class="comment">// start fresh</span></div>
<div class="line"><a name="l03787"></a><span class="lineno"> 3787</span>&#160;          *lpflag=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#abdf9e55b7b15ec0bcd386055f1787f47">UTOPRIMNOFAIL</a>;</div>
<div class="line"><a name="l03788"></a><span class="lineno"> 3788</span>&#160;          *lpflagrad=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6435e9609d622c9dbaf78c12658ecf8e">UTOPRIMRADNOFAIL</a>;</div>
<div class="line"><a name="l03789"></a><span class="lineno"> 3789</span>&#160;          radinvmodenergy=0;</div>
<div class="line"><a name="l03790"></a><span class="lineno"> 3790</span>&#160;          radErfnegenergy=0;</div>
<div class="line"><a name="l03791"></a><span class="lineno"> 3791</span>&#160;          failreturnenergy=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab0abd953f677a44020dc50259c410486">FAILRETURNGENERAL</a>; <span class="comment">// default to fail in case energy not to be done at all</span></div>
<div class="line"><a name="l03792"></a><span class="lineno"> 3792</span>&#160;          eomtypeenergy=eomtypelist[tryphase1];</div>
<div class="line"><a name="l03793"></a><span class="lineno"> 3793</span>&#160;          errorabsenergy[0]=errorabsenergy[1]=1.0;</div>
<div class="line"><a name="l03794"></a><span class="lineno"> 3794</span>&#160;        </div>
<div class="line"><a name="l03795"></a><span class="lineno"> 3795</span>&#160;          <span class="comment">// setup solver conditions for existence of backup solutions or entropy solution</span></div>
<div class="line"><a name="l03796"></a><span class="lineno"> 3796</span>&#160;          <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a98e2c94d4fc861c61bc8dde7b4eec734">ACTUALHARDFAILURE</a>(failreturnentropy)==1){</div>
<div class="line"><a name="l03797"></a><span class="lineno"> 3797</span>&#160;            havebackup=0; <span class="comment">// no entropy solver solution, so no backup.</span></div>
<div class="line"><a name="l03798"></a><span class="lineno"> 3798</span>&#160;            didentropyalready=0;</div>
<div class="line"><a name="l03799"></a><span class="lineno"> 3799</span>&#160;          }</div>
<div class="line"><a name="l03800"></a><span class="lineno"> 3800</span>&#160;          <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l03801"></a><span class="lineno"> 3801</span>&#160;            havebackup=1; <span class="comment">// here havebackup=1 means can break out of energy solver early if issues, since we do have entropy solver solution as backup.</span></div>
<div class="line"><a name="l03802"></a><span class="lineno"> 3802</span>&#160;            didentropyalready=1; <span class="comment">// so can use entropy solution as reference for whether to stop energy iteration</span></div>
<div class="line"><a name="l03803"></a><span class="lineno"> 3803</span>&#160;          }</div>
<div class="line"><a name="l03804"></a><span class="lineno"> 3804</span>&#160;</div>
<div class="line"><a name="l03805"></a><span class="lineno"> 3805</span>&#160;          <span class="comment">// setup guess</span></div>
<div class="line"><a name="l03806"></a><span class="lineno"> 3806</span>&#160;          <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a98e2c94d4fc861c61bc8dde7b4eec734">ACTUALHARDFAILURE</a>(failreturnentropy)==1 || errorabsentropy[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>]&gt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#abbf8da2bda1bab4cdb847a0faa6db3c1" title="error below which will use entropy as guess for energy if entropy didn&#39;t hard fail.">ERRORTOUSEENTROPYFORENERGYGUESS</a>){</div>
<div class="line"><a name="l03807"></a><span class="lineno"> 3807</span>&#160;            <span class="keywordflow">if</span>(errorabsenergybest[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>]&gt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a4a0ce3856fb32518938a274adb6c3946" title="error below which to feed best guess into next attempt">TRYHARDERFEEDGUESSTOL</a>){</div>
<div class="line"><a name="l03808"></a><span class="lineno"> 3808</span>&#160;              <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l03809"></a><span class="lineno"> 3809</span>&#160;                pbenergy[pl]=pbbackup[pl];</div>
<div class="line"><a name="l03810"></a><span class="lineno"> 3810</span>&#160;                uubenergy[pl]=uubbackup[pl];</div>
<div class="line"><a name="l03811"></a><span class="lineno"> 3811</span>&#160;                <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a2da8b12fca78064531b9b64e5699e4fc" title="loop over ALL sources (including geometry)">SCLOOP</a>(sc) dUcompenergy[sc][pl]=dUcompbackup[sc][pl];</div>
<div class="line"><a name="l03812"></a><span class="lineno"> 3812</span>&#160;              }</div>
<div class="line"><a name="l03813"></a><span class="lineno"> 3813</span>&#160;              qenergy=qbackup;</div>
<div class="line"><a name="l03814"></a><span class="lineno"> 3814</span>&#160;              errorabsenergy[0]=errorabsenergy[1]=1.0;</div>
<div class="line"><a name="l03815"></a><span class="lineno"> 3815</span>&#160;              radinvmodenergy=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ad987489760e6592057a80faf09588c88" title="unfixable inversion problems">UTOPRIMRADFAILBAD1</a>;</div>
<div class="line"><a name="l03816"></a><span class="lineno"> 3816</span>&#160;            }</div>
<div class="line"><a name="l03817"></a><span class="lineno"> 3817</span>&#160;            <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l03818"></a><span class="lineno"> 3818</span>&#160;              <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l03819"></a><span class="lineno"> 3819</span>&#160;                pbenergy[pl]=pbenergybest[pl];</div>
<div class="line"><a name="l03820"></a><span class="lineno"> 3820</span>&#160;                uubenergy[pl]=uubenergybest[pl];</div>
<div class="line"><a name="l03821"></a><span class="lineno"> 3821</span>&#160;                <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a2da8b12fca78064531b9b64e5699e4fc" title="loop over ALL sources (including geometry)">SCLOOP</a>(sc) dUcompenergy[sc][pl]=dUcompbackup[sc][pl];</div>
<div class="line"><a name="l03822"></a><span class="lineno"> 3822</span>&#160;              }</div>
<div class="line"><a name="l03823"></a><span class="lineno"> 3823</span>&#160;              qenergy=qenergybest;</div>
<div class="line"><a name="l03824"></a><span class="lineno"> 3824</span>&#160;              errorabsenergy[0]=errorabsenergybest[0];</div>
<div class="line"><a name="l03825"></a><span class="lineno"> 3825</span>&#160;              errorabsenergy[1]=errorabsenergybest[1];</div>
<div class="line"><a name="l03826"></a><span class="lineno"> 3826</span>&#160;              radinvmodenergy=radinvmodenergybest;</div>
<div class="line"><a name="l03827"></a><span class="lineno"> 3827</span>&#160;            }</div>
<div class="line"><a name="l03828"></a><span class="lineno"> 3828</span>&#160;          }</div>
<div class="line"><a name="l03829"></a><span class="lineno"> 3829</span>&#160;          <span class="keywordflow">else</span>{ <span class="comment">// start with entropy</span></div>
<div class="line"><a name="l03830"></a><span class="lineno"> 3830</span>&#160;            <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l03831"></a><span class="lineno"> 3831</span>&#160;              pbenergy[pl]=pbentropy[pl];</div>
<div class="line"><a name="l03832"></a><span class="lineno"> 3832</span>&#160;              uubenergy[pl]=uubentropy[pl];</div>
<div class="line"><a name="l03833"></a><span class="lineno"> 3833</span>&#160;              <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a2da8b12fca78064531b9b64e5699e4fc" title="loop over ALL sources (including geometry)">SCLOOP</a>(sc) dUcompenergy[sc][pl]=dUcompbackup[sc][pl];</div>
<div class="line"><a name="l03834"></a><span class="lineno"> 3834</span>&#160;            }</div>
<div class="line"><a name="l03835"></a><span class="lineno"> 3835</span>&#160;            qenergy=qentropy;</div>
<div class="line"><a name="l03836"></a><span class="lineno"> 3836</span>&#160;            errorabsenergy[0]=errorabsentropy[0]; <span class="comment">// assume error estimate only used to decide if guess is used, not if converged with energy</span></div>
<div class="line"><a name="l03837"></a><span class="lineno"> 3837</span>&#160;            errorabsenergy[1]=errorabsentropy[1]; <span class="comment">// assume error estimate only used to decide if guess is used, not if converged with energy</span></div>
<div class="line"><a name="l03838"></a><span class="lineno"> 3838</span>&#160;            radinvmodenergy=radinvmodentropy;</div>
<div class="line"><a name="l03839"></a><span class="lineno"> 3839</span>&#160;          }</div>
<div class="line"><a name="l03840"></a><span class="lineno"> 3840</span>&#160;          <span class="comment">//</span></div>
<div class="line"><a name="l03841"></a><span class="lineno"> 3841</span>&#160;          failreturnenergy=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a17aede36203a236390363af78d3a86f0" title="compute changes to U (both T and R) using implicit method KORALTODO: If doing implicit, should also add geometry source term that can sometimes be stiff.">koral_source_rad_implicit_mode</a>(modemethodlocal,0,modprim,havebackup, didentropyalready, &amp;eomtypeenergy, whichcapenergy, itermodeenergy, &amp;baseitermethodenergy, trueimptryconvenergy, trueimpokconvenergy, trueimpallowconvenergy, trueimpmaxiterenergy,  truenumdampattemptsenergy, fracenergy, dissmeasure, &amp;radinvmodenergy, pbenergy, uubenergy, piin, Uiin, Ufin, CUf, CUimp, ptrgeom, &amp;qenergy, dUother ,dUcompenergy, errorabsenergy, errorabsenergybest, &amp;itersenergy, &amp;f1itersenergy, &amp;nummhdinvsenergy, &amp;nummhdstepsenergy);</div>
<div class="line"><a name="l03842"></a><span class="lineno"> 3842</span>&#160;          nummhdsteps+=nummhdstepsenergy;</div>
<div class="line"><a name="l03843"></a><span class="lineno"> 3843</span>&#160;          </div>
<div class="line"><a name="l03844"></a><span class="lineno"> 3844</span>&#160;          <span class="comment">// store error, no matter if using solution or not or even if explicit</span></div>
<div class="line"><a name="l03845"></a><span class="lineno"> 3845</span>&#160;          errorabslist[tryphase1][0]=errorabsenergy[0];</div>
<div class="line"><a name="l03846"></a><span class="lineno"> 3846</span>&#160;          errorabslist[tryphase1][1]=errorabsenergy[1];</div>
<div class="line"><a name="l03847"></a><span class="lineno"> 3847</span>&#160;</div>
<div class="line"><a name="l03848"></a><span class="lineno"> 3848</span>&#160;          <span class="keywordflow">if</span>(failreturnenergy==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a04634949fd2370214f3d313c9cffa182">FAILRETURNGOTRIVIALEXPLICIT</a>){</div>
<div class="line"><a name="l03849"></a><span class="lineno"> 3849</span>&#160;            lpflagenergybest=*lpflag;</div>
<div class="line"><a name="l03850"></a><span class="lineno"> 3850</span>&#160;            lpflagradenergybest=*lpflagrad;</div>
<div class="line"><a name="l03851"></a><span class="lineno"> 3851</span>&#160;            radinvmodenergybest=radinvmodenergy;</div>
<div class="line"><a name="l03852"></a><span class="lineno"> 3852</span>&#160;            radErfnegenergybest=radErfnegenergy;</div>
<div class="line"><a name="l03853"></a><span class="lineno"> 3853</span>&#160;            failreturnenergybest=failreturnenergy;</div>
<div class="line"><a name="l03854"></a><span class="lineno"> 3854</span>&#160;            eomtypeenergybest=eomtypelist[tryphase1];</div>
<div class="line"><a name="l03855"></a><span class="lineno"> 3855</span>&#160;            goexplicitenergybest=1;</div>
<div class="line"><a name="l03856"></a><span class="lineno"> 3856</span>&#160;</div>
<div class="line"><a name="l03857"></a><span class="lineno"> 3857</span>&#160;            <span class="comment">// save which method ended up using</span></div>
<div class="line"><a name="l03858"></a><span class="lineno"> 3858</span>&#160;            <span class="keywordtype">int</span> prioriter; <span class="keywordflow">for</span>(prioriter=0;prioriter&lt;<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#acb843c30a487185fc9ae1e5460a19284" title="array indices for prioritermethod">NUMPRIORITERMETHODINDEX</a>;prioriter++){</div>
<div class="line"><a name="l03859"></a><span class="lineno"> 3859</span>&#160;              methodindex[prioriter] = <a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a5b3bcf4eaf08299f68268d75a01a0f9b">PRIORITERMETHODNOTSET</a>; <span class="comment">// back to unknown</span></div>
<div class="line"><a name="l03860"></a><span class="lineno"> 3860</span>&#160;            }</div>
<div class="line"><a name="l03861"></a><span class="lineno"> 3861</span>&#160;          }</div>
<div class="line"><a name="l03862"></a><span class="lineno"> 3862</span>&#160;          <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l03863"></a><span class="lineno"> 3863</span>&#160;            <span class="comment">// see if want to keep</span></div>
<div class="line"><a name="l03864"></a><span class="lineno"> 3864</span>&#160;            <span class="comment">//        if(errorabsenergy[WHICHERROR]&lt;errorabsenergybest[WHICHERROR] &amp;&amp; ACTUALHARDFAILURE(failreturnenergy)==0 || failreturnenergy==FAILRETURNMODESWITCH){</span></div>
<div class="line"><a name="l03865"></a><span class="lineno"> 3865</span>&#160;            <span class="comment">//        if((errorabsenergy[WHICHERROR]&lt;errorabsenergybest[WHICHERROR] &amp;&amp; (RADINVBAD(radinvmodenergy)==0 || RADINVBAD(radinvmodenergybest) &amp;&amp; RADINVBAD(radinvmodenergy)) || RADINVBAD(radinvmodenergybest) &amp;&amp; RADINVBAD(radinvmodenergy)==0 &amp;&amp; (errorabsenergy[WHICHERROR]&lt;errorabsenergybest[WHICHERROR]||errorabsenergy[WHICHERROR]&lt;IMPOKCONVABS)) &amp;&amp; ACTUALHARDFAILURE(failreturnenergy)==0 || failreturnenergy==FAILRETURNMODESWITCH){</span></div>
<div class="line"><a name="l03866"></a><span class="lineno"> 3866</span>&#160;            <span class="keywordflow">if</span>(</div>
<div class="line"><a name="l03867"></a><span class="lineno"> 3867</span>&#160;               (</div>
<div class="line"><a name="l03868"></a><span class="lineno"> 3868</span>&#160;                <span class="comment">// best and no radinv problem</span></div>
<div class="line"><a name="l03869"></a><span class="lineno"> 3869</span>&#160;                errorabsenergy[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>]&lt;errorabsenergybest[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>] &amp;&amp; <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0685d01c4383c1608a7ea72cb7ce3791">RADINVBAD</a>(radinvmodenergy)==0</div>
<div class="line"><a name="l03870"></a><span class="lineno"> 3870</span>&#160;                <span class="comment">// best because prior best also had radinv problem and still smaller error</span></div>
<div class="line"><a name="l03871"></a><span class="lineno"> 3871</span>&#160;                || errorabsenergy[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>]&lt;errorabsenergybest[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>] &amp;&amp; (<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0685d01c4383c1608a7ea72cb7ce3791">RADINVBAD</a>(radinvmodenergy) &amp;&amp; <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0685d01c4383c1608a7ea72cb7ce3791">RADINVBAD</a>(radinvmodenergybest))</div>
<div class="line"><a name="l03872"></a><span class="lineno"> 3872</span>&#160;                <span class="comment">// best because even though has radinv problem (while best doesn&#39;t) much smaller error</span></div>
<div class="line"><a name="l03873"></a><span class="lineno"> 3873</span>&#160;                || errorabsenergy[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>]&lt;errorabsenergybest[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>] &amp;&amp; errorabsenergy[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>]&lt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a0beb933bdd5a874f9fcada46b302fbff">IMPOKCONVABS</a> &amp;&amp; errorabsenergybest[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>]&gt;100.0*<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a0beb933bdd5a874f9fcada46b302fbff">IMPOKCONVABS</a> &amp;&amp; (<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0685d01c4383c1608a7ea72cb7ce3791">RADINVBAD</a>(radinvmodenergy) &amp;&amp; <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0685d01c4383c1608a7ea72cb7ce3791">RADINVBAD</a>(radinvmodenergybest)==0)</div>
<div class="line"><a name="l03874"></a><span class="lineno"> 3874</span>&#160;                )</div>
<div class="line"><a name="l03875"></a><span class="lineno"> 3875</span>&#160;               &amp;&amp; <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a98e2c94d4fc861c61bc8dde7b4eec734">ACTUALHARDFAILURE</a>(failreturnenergy)==0){</div>
<div class="line"><a name="l03876"></a><span class="lineno"> 3876</span>&#160;              <span class="comment">// store result in case better than latter results</span></div>
<div class="line"><a name="l03877"></a><span class="lineno"> 3877</span>&#160;              lpflagenergybest=*lpflag;</div>
<div class="line"><a name="l03878"></a><span class="lineno"> 3878</span>&#160;              lpflagradenergybest=*lpflagrad;</div>
<div class="line"><a name="l03879"></a><span class="lineno"> 3879</span>&#160;              radinvmodenergybest=radinvmodenergy;</div>
<div class="line"><a name="l03880"></a><span class="lineno"> 3880</span>&#160;              radErfnegenergybest=radErfnegenergy;</div>
<div class="line"><a name="l03881"></a><span class="lineno"> 3881</span>&#160;              failreturnenergybest=failreturnenergy;</div>
<div class="line"><a name="l03882"></a><span class="lineno"> 3882</span>&#160;              eomtypeenergybest=eomtypeenergy;</div>
<div class="line"><a name="l03883"></a><span class="lineno"> 3883</span>&#160;              goexplicitenergybest=0;</div>
<div class="line"><a name="l03884"></a><span class="lineno"> 3884</span>&#160;              errorabsenergybest[0]=errorabsenergy[0];</div>
<div class="line"><a name="l03885"></a><span class="lineno"> 3885</span>&#160;              errorabsenergybest[1]=errorabsenergy[1];</div>
<div class="line"><a name="l03886"></a><span class="lineno"> 3886</span>&#160;              <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l03887"></a><span class="lineno"> 3887</span>&#160;                pbenergybest[pl]=pbenergy[pl];</div>
<div class="line"><a name="l03888"></a><span class="lineno"> 3888</span>&#160;                uubenergybest[pl]=uubenergy[pl];</div>
<div class="line"><a name="l03889"></a><span class="lineno"> 3889</span>&#160;                <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a2da8b12fca78064531b9b64e5699e4fc" title="loop over ALL sources (including geometry)">SCLOOP</a>(sc) dUcompenergybest[sc][pl]=dUcompenergy[sc][pl];</div>
<div class="line"><a name="l03890"></a><span class="lineno"> 3890</span>&#160;              }</div>
<div class="line"><a name="l03891"></a><span class="lineno"> 3891</span>&#160;              qenergybest=qenergy;</div>
<div class="line"><a name="l03892"></a><span class="lineno"> 3892</span>&#160;</div>
<div class="line"><a name="l03893"></a><span class="lineno"> 3893</span>&#160;              <span class="comment">// save which method ended up using</span></div>
<div class="line"><a name="l03894"></a><span class="lineno"> 3894</span>&#160;              methodindex[<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a19f0668a5075a4ca1061348f26a4fc13">BASEITERMETHODINDEX</a>] = baseitermethodlist[tryphase1];</div>
<div class="line"><a name="l03895"></a><span class="lineno"> 3895</span>&#160;              methodindex[<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a698402bc5dc720863bbf11c90786520d">ITERMODEINDEX</a>] = itermodelist[tryphase1];</div>
<div class="line"><a name="l03896"></a><span class="lineno"> 3896</span>&#160;              methodindex[<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#ae8652406acc776eaa231ffc6eb9fbcb5">IMPTRYCONVINDEX</a>] = (trueimptryconvlist[tryphase1]==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afc9b116343212081b674a39ac69ce6ed" title="Funny, even 1E-5 does ok with torus, no worse at Erf~ERADLIMIT instances. Also, does ~3 iterations...">IMPTRYCONV</a>);</div>
<div class="line"><a name="l03897"></a><span class="lineno"> 3897</span>&#160;              methodindex[<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a8f7ffa366fb45fd76a8a991ac9f4c43b">IMPMAXITERINDEX</a>] = trueimpmaxiterlist[tryphase1];</div>
<div class="line"><a name="l03898"></a><span class="lineno"> 3898</span>&#160;              methodindex[NUMDAMPINDEX] = truenumdampattemptslist[tryphase1];</div>
<div class="line"><a name="l03899"></a><span class="lineno"> 3899</span>&#160;              methodindex[<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a0f8cccff59db9d8325aa44b8cb389a44">MODPRIMINDEX</a>] = modprimlist[tryphase1];</div>
<div class="line"><a name="l03900"></a><span class="lineno"> 3900</span>&#160;              methodindex[<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a86a2418b187397a6fdf2cfd790a0ddeb">CHECKRADINVINDEX</a>] = checkradinvlist[tryphase1];</div>
<div class="line"><a name="l03901"></a><span class="lineno"> 3901</span>&#160;              methodindex[<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a4681062d53a43e7fcb647275649f05ef">EOMTYPEINDEX</a>] = eomtypelist[tryphase1];</div>
<div class="line"><a name="l03902"></a><span class="lineno"> 3902</span>&#160;            }</div>
<div class="line"><a name="l03903"></a><span class="lineno"> 3903</span>&#160;          }</div>
<div class="line"><a name="l03904"></a><span class="lineno"> 3904</span>&#160;</div>
<div class="line"><a name="l03905"></a><span class="lineno"> 3905</span>&#160;          <span class="comment">// still cost more iters</span></div>
<div class="line"><a name="l03906"></a><span class="lineno"> 3906</span>&#160;          itersenergy+=itersenergyold;</div>
<div class="line"><a name="l03907"></a><span class="lineno"> 3907</span>&#160;          </div>
<div class="line"><a name="l03908"></a><span class="lineno"> 3908</span>&#160;          <span class="keywordtype">int</span> noproblem=(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a7207286a043c1f65037676ebf80412e5">ACTUALHARDORSOFTFAILURE</a>(failreturnenergy)==0 || failreturnenergy==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a42e7e780e89073f5d14dfafda3bae62e">FAILRETURNMODESWITCH</a>);</div>
<div class="line"><a name="l03909"></a><span class="lineno"> 3909</span>&#160;</div>
<div class="line"><a name="l03910"></a><span class="lineno"> 3910</span>&#160;          </div>
<div class="line"><a name="l03911"></a><span class="lineno"> 3911</span>&#160;          <span class="keywordflow">if</span>(tryphase1!=firsttryphase1used &amp;&amp; noproblem){</div>
<div class="line"><a name="l03912"></a><span class="lineno"> 3912</span>&#160;            <span class="keywordflow">if</span>(debugfail&gt;=2) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;Recovered using tryphase1=%d (energy: failreturnenergy=%d radinvmod=%d -&gt; %d): ijknstepsteppart=%d %d %d %ld %d : error: %21.15g-&gt;%21.15g (best=%21.15g) iters: %d-&gt;%d baseitermethod=%d eomtype=%d\n&quot;</span>,tryphase1,failreturnenergy,radinvmodenergyold,radinvmodenergy,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a1a1088d87617078680f1fd0f0d707384">nstep</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a70170b90229f9fc05eebf8508a685c70">steppart</a>,errorabsenergyold[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>],errorabsenergy[WHICHERROR],errorabsenergybest[WHICHERROR],itersenergyold,itersenergy,baseitermethodenergy,eomtypeenergy);</div>
<div class="line"><a name="l03913"></a><span class="lineno"> 3913</span>&#160;          }</div>
<div class="line"><a name="l03914"></a><span class="lineno"> 3914</span>&#160;          <span class="keywordflow">if</span>(noproblem==0){</div>
<div class="line"><a name="l03915"></a><span class="lineno"> 3915</span>&#160;            <span class="keywordflow">if</span>(debugfail&gt;=2) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;Failed to: &lt;Recovered&gt; using tryphase1=%d (energy: failreturnenergy=%d radinvmod=%d): ijknstepsteppart=%d %d %d %ld %d : error: %21.15g-&gt;%21.15g (best=%21.15g) iters: %d-&gt;%d baseitermethod=%d eomtype=%d\n&quot;</span>,tryphase1,failreturnenergy,radinvmodenergy,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a1a1088d87617078680f1fd0f0d707384">nstep</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a70170b90229f9fc05eebf8508a685c70">steppart</a>,errorabsenergyold[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>],errorabsenergy[WHICHERROR],errorabsenergybest[WHICHERROR],itersenergyold,itersenergy,baseitermethodenergy,eomtypeenergy);</div>
<div class="line"><a name="l03916"></a><span class="lineno"> 3916</span>&#160;          }</div>
<div class="line"><a name="l03917"></a><span class="lineno"> 3917</span>&#160;</div>
<div class="line"><a name="l03918"></a><span class="lineno"> 3918</span>&#160;         </div>
<div class="line"><a name="l03919"></a><span class="lineno"> 3919</span>&#160;        }<span class="comment">// end if doing _mode() call</span></div>
<div class="line"><a name="l03920"></a><span class="lineno"> 3920</span>&#160;</div>
<div class="line"><a name="l03921"></a><span class="lineno"> 3921</span>&#160;</div>
<div class="line"><a name="l03922"></a><span class="lineno"> 3922</span>&#160;      }<span class="comment">// end over try loop</span></div>
<div class="line"><a name="l03923"></a><span class="lineno"> 3923</span>&#160;</div>
<div class="line"><a name="l03924"></a><span class="lineno"> 3924</span>&#160;</div>
<div class="line"><a name="l03925"></a><span class="lineno"> 3925</span>&#160;</div>
<div class="line"><a name="l03926"></a><span class="lineno"> 3926</span>&#160;</div>
<div class="line"><a name="l03927"></a><span class="lineno"> 3927</span>&#160;</div>
<div class="line"><a name="l03928"></a><span class="lineno"> 3928</span>&#160;</div>
<div class="line"><a name="l03929"></a><span class="lineno"> 3929</span>&#160;</div>
<div class="line"><a name="l03930"></a><span class="lineno"> 3930</span>&#160;</div>
<div class="line"><a name="l03931"></a><span class="lineno"> 3931</span>&#160;      <span class="comment">// see if want to try harder</span></div>
<div class="line"><a name="l03932"></a><span class="lineno"> 3932</span>&#160;      <span class="keywordflow">if</span>(</div>
<div class="line"><a name="l03933"></a><span class="lineno"> 3933</span>&#160;         !(modemethodlocal==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a4a773e56e52c24230ab87c41877f241e">MODEPICKBESTSIMPLE2</a>) <span class="comment">// Ramesh method is like stages, so avoid if simple2 method</span></div>
<div class="line"><a name="l03934"></a><span class="lineno"> 3934</span>&#160;         &amp;&amp; (<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a7207286a043c1f65037676ebf80412e5">ACTUALHARDORSOFTFAILURE</a>(failreturnenergy) &amp;&amp; failreturn!=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a42e7e780e89073f5d14dfafda3bae62e">FAILRETURNMODESWITCH</a> &amp;&amp; <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a4e881a6dce34b0b9f03a77b9d9c11c9c" title="whether to use ramesh solver as backup">USERAMESH</a> &amp;&amp; radextremeprimaryevolves==0)</div>
<div class="line"><a name="l03935"></a><span class="lineno"> 3935</span>&#160;         &amp;&amp; !(errorabslist[whichfirstpmhd][0]&lt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afc9b116343212081b674a39ac69ce6ed" title="Funny, even 1E-5 does ok with torus, no worse at Erf~ERADLIMIT instances. Also, does ~3 iterations...">IMPTRYCONV</a> &amp;&amp; errorabslist[whichfirstpmhd][1]&gt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afc9b116343212081b674a39ac69ce6ed" title="Funny, even 1E-5 does ok with torus, no worse at Erf~ERADLIMIT instances. Also, does ~3 iterations...">IMPTRYCONV</a>) <span class="comment">// avoid ramesh (pmhd-type) method if already did it and got iterate-small error.</span></div>
<div class="line"><a name="l03936"></a><span class="lineno"> 3936</span>&#160;         ){</div>
<div class="line"><a name="l03937"></a><span class="lineno"> 3937</span>&#160;        errorabsenergyold[0]=errorabsenergy[0];</div>
<div class="line"><a name="l03938"></a><span class="lineno"> 3938</span>&#160;        errorabsenergyold[1]=errorabsenergy[1];</div>
<div class="line"><a name="l03939"></a><span class="lineno"> 3939</span>&#160;        radinvmodenergyold=radinvmodenergy;</div>
<div class="line"><a name="l03940"></a><span class="lineno"> 3940</span>&#160;        itersenergyold=itersenergy;</div>
<div class="line"><a name="l03941"></a><span class="lineno"> 3941</span>&#160;        goexplicitenergy=0; <span class="comment">// force since no explicit check</span></div>
<div class="line"><a name="l03942"></a><span class="lineno"> 3942</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l03943"></a><span class="lineno"> 3943</span>&#160;        <span class="keywordflow">if</span>(gotrameshsolution){<span class="comment">// then just recall solution</span></div>
<div class="line"><a name="l03944"></a><span class="lineno"> 3944</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l03945"></a><span class="lineno"> 3945</span>&#160;            pbenergy[pl]=ppeng[pl];</div>
<div class="line"><a name="l03946"></a><span class="lineno"> 3946</span>&#160;            uubenergy[pl]=uueng[pl];</div>
<div class="line"><a name="l03947"></a><span class="lineno"> 3947</span>&#160;            <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a2da8b12fca78064531b9b64e5699e4fc" title="loop over ALL sources (including geometry)">SCLOOP</a>(sc) dUcompenergy[sc][pl]=dUcompeng[sc][pl];</div>
<div class="line"><a name="l03948"></a><span class="lineno"> 3948</span>&#160;          }</div>
<div class="line"><a name="l03949"></a><span class="lineno"> 3949</span>&#160;          qenergy=qeng;</div>
<div class="line"><a name="l03950"></a><span class="lineno"> 3950</span>&#160;          <span class="comment">//</span></div>
<div class="line"><a name="l03951"></a><span class="lineno"> 3951</span>&#160;          *lpflag=*lpflagrad=(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a>)failtypeeng; <span class="comment">// need better translation</span></div>
<div class="line"><a name="l03952"></a><span class="lineno"> 3952</span>&#160;          radinvmodenergy=radinvmodeng;</div>
<div class="line"><a name="l03953"></a><span class="lineno"> 3953</span>&#160;          radErfnegenergy=0; <span class="comment">// not allowed, considered BADNEG type</span></div>
<div class="line"><a name="l03954"></a><span class="lineno"> 3954</span>&#160;          itersenergy=iterseng;</div>
<div class="line"><a name="l03955"></a><span class="lineno"> 3955</span>&#160;          errorabsenergy[0]=errorabseng[0];</div>
<div class="line"><a name="l03956"></a><span class="lineno"> 3956</span>&#160;          errorabsenergy[1]=errorabseng[1];</div>
<div class="line"><a name="l03957"></a><span class="lineno"> 3957</span>&#160;          <span class="keywordflow">if</span>(failtypeeng || errorabsenergy[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>]&gt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8469a53eb25c0eb3b81286c364d0e7f3">IMPALLOWCONVCONSTABS</a>){ failreturnenergy=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab0abd953f677a44020dc50259c410486">FAILRETURNGENERAL</a>; eomtypeenergy=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a03d89f51ab60206791830c886d62bfd0">EOMGRMHD</a>; }</div>
<div class="line"><a name="l03958"></a><span class="lineno"> 3958</span>&#160;          <span class="keywordflow">else</span> <span class="keywordflow">if</span>(errorabsenergy[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>]&lt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a37aa5c4b7b1b481299d87bf929d13b15" title="error for comparing to sum over all absolute errors">IMPTRYCONVABS</a>){ failreturnenergy=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a3d6e4da5640133efaad94738c97e5171">FAILRETURNNOFAIL</a>; eomtypeenergy=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a04d93d33dd8dba356800fa12cb80064e">EOMDIDGRMHD</a>;}</div>
<div class="line"><a name="l03959"></a><span class="lineno"> 3959</span>&#160;          <span class="keywordflow">else</span>{ failreturnenergy=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a45adfa493bc8ab6857a43a11d9d649d1">FAILRETURNNOTTOLERROR</a>; eomtypeenergy=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a04d93d33dd8dba356800fa12cb80064e">EOMDIDGRMHD</a>;}</div>
<div class="line"><a name="l03960"></a><span class="lineno"> 3960</span>&#160;        }</div>
<div class="line"><a name="l03961"></a><span class="lineno"> 3961</span>&#160;        <span class="keywordflow">else</span>{ <span class="comment">// else get new ramesh solution</span></div>
<div class="line"><a name="l03962"></a><span class="lineno"> 3962</span>&#160;          <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> errorabsforramesh[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa63447acbbbc62cbedae23eac61c716e" title="determine which error will use when deciding if converged or not.">NUMERRORTYPES</a>];</div>
<div class="line"><a name="l03963"></a><span class="lineno"> 3963</span>&#160;          set_array(errorabsforramesh,NUMERRORTYPES,MPI_FTYPE,1.0);</div>
<div class="line"><a name="l03964"></a><span class="lineno"> 3964</span>&#160;          <span class="comment">// start fresh with ramesh</span></div>
<div class="line"><a name="l03965"></a><span class="lineno"> 3965</span>&#160;          <span class="keywordflow">if</span>(errorabsenergy[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>]&gt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a4a0ce3856fb32518938a274adb6c3946" title="error below which to feed best guess into next attempt">TRYHARDERFEEDGUESSTOL</a>){</div>
<div class="line"><a name="l03966"></a><span class="lineno"> 3966</span>&#160;            <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a98e2c94d4fc861c61bc8dde7b4eec734">ACTUALHARDFAILURE</a>(failreturnentropy)==1 || errorabsentropy[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>]&gt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#abbf8da2bda1bab4cdb847a0faa6db3c1" title="error below which will use entropy as guess for energy if entropy didn&#39;t hard fail.">ERRORTOUSEENTROPYFORENERGYGUESS</a>){</div>
<div class="line"><a name="l03967"></a><span class="lineno"> 3967</span>&#160;              <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l03968"></a><span class="lineno"> 3968</span>&#160;                pbenergy[pl]=pbbackup[pl];</div>
<div class="line"><a name="l03969"></a><span class="lineno"> 3969</span>&#160;                uubenergy[pl]=uubbackup[pl];</div>
<div class="line"><a name="l03970"></a><span class="lineno"> 3970</span>&#160;                <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a2da8b12fca78064531b9b64e5699e4fc" title="loop over ALL sources (including geometry)">SCLOOP</a>(sc) dUcompeng[sc][pl]=dUcompenergy[sc][pl]=dUcompbackup[sc][pl];</div>
<div class="line"><a name="l03971"></a><span class="lineno"> 3971</span>&#160;              }</div>
<div class="line"><a name="l03972"></a><span class="lineno"> 3972</span>&#160;              qenergy=qbackup;</div>
<div class="line"><a name="l03973"></a><span class="lineno"> 3973</span>&#160;              errorabseng[0]=errorabseng[1]=1.0;</div>
<div class="line"><a name="l03974"></a><span class="lineno"> 3974</span>&#160;              errorabsforramesh[0]=errorabsforramesh[1]=1.0;</div>
<div class="line"><a name="l03975"></a><span class="lineno"> 3975</span>&#160;              radinvmodeng=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ad987489760e6592057a80faf09588c88" title="unfixable inversion problems">UTOPRIMRADFAILBAD1</a>;</div>
<div class="line"><a name="l03976"></a><span class="lineno"> 3976</span>&#160;            }</div>
<div class="line"><a name="l03977"></a><span class="lineno"> 3977</span>&#160;            <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l03978"></a><span class="lineno"> 3978</span>&#160;              <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l03979"></a><span class="lineno"> 3979</span>&#160;                pbenergy[pl]=pbentropy[pl];</div>
<div class="line"><a name="l03980"></a><span class="lineno"> 3980</span>&#160;                uubenergy[pl]=uubentropy[pl];</div>
<div class="line"><a name="l03981"></a><span class="lineno"> 3981</span>&#160;                <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a2da8b12fca78064531b9b64e5699e4fc" title="loop over ALL sources (including geometry)">SCLOOP</a>(sc) dUcompeng[sc][pl]=dUcompenergy[sc][pl]=dUcompbackup[sc][pl];</div>
<div class="line"><a name="l03982"></a><span class="lineno"> 3982</span>&#160;              }</div>
<div class="line"><a name="l03983"></a><span class="lineno"> 3983</span>&#160;              qenergy=qentropy;</div>
<div class="line"><a name="l03984"></a><span class="lineno"> 3984</span>&#160;              errorabseng[0]=errorabsentropybest[0];</div>
<div class="line"><a name="l03985"></a><span class="lineno"> 3985</span>&#160;              errorabseng[1]=errorabsentropybest[1];</div>
<div class="line"><a name="l03986"></a><span class="lineno"> 3986</span>&#160;              errorabsforramesh[0]=errorabsforramesh[1]=1.0;</div>
<div class="line"><a name="l03987"></a><span class="lineno"> 3987</span>&#160;              radinvmodeng=radinvmodentropybest;</div>
<div class="line"><a name="l03988"></a><span class="lineno"> 3988</span>&#160;            }</div>
<div class="line"><a name="l03989"></a><span class="lineno"> 3989</span>&#160;          }</div>
<div class="line"><a name="l03990"></a><span class="lineno"> 3990</span>&#160;          <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l03991"></a><span class="lineno"> 3991</span>&#160;            <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l03992"></a><span class="lineno"> 3992</span>&#160;              pbenergy[pl]=pbenergybest[pl];</div>
<div class="line"><a name="l03993"></a><span class="lineno"> 3993</span>&#160;              uubenergy[pl]=uubenergybest[pl];</div>
<div class="line"><a name="l03994"></a><span class="lineno"> 3994</span>&#160;              <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a2da8b12fca78064531b9b64e5699e4fc" title="loop over ALL sources (including geometry)">SCLOOP</a>(sc) dUcompeng[sc][pl]=dUcompenergy[sc][pl]=dUcompbackup[sc][pl]; <span class="comment">// always backup</span></div>
<div class="line"><a name="l03995"></a><span class="lineno"> 3995</span>&#160;            }</div>
<div class="line"><a name="l03996"></a><span class="lineno"> 3996</span>&#160;            qenergy=qenergybest;</div>
<div class="line"><a name="l03997"></a><span class="lineno"> 3997</span>&#160;            errorabseng[0]=errorabsenergybest[0];</div>
<div class="line"><a name="l03998"></a><span class="lineno"> 3998</span>&#160;            errorabseng[1]=errorabsenergybest[1];</div>
<div class="line"><a name="l03999"></a><span class="lineno"> 3999</span>&#160;            errorabsforramesh[0]=errorabsenergybest[0];</div>
<div class="line"><a name="l04000"></a><span class="lineno"> 4000</span>&#160;            errorabsforramesh[1]=errorabsenergybest[1];</div>
<div class="line"><a name="l04001"></a><span class="lineno"> 4001</span>&#160;            radinvmodeng=radinvmodenergybest;</div>
<div class="line"><a name="l04002"></a><span class="lineno"> 4002</span>&#160;          }</div>
<div class="line"><a name="l04003"></a><span class="lineno"> 4003</span>&#160;          <span class="comment">//</span></div>
<div class="line"><a name="l04004"></a><span class="lineno"> 4004</span>&#160;          <span class="comment">// BEGIN GET RAMESH SOLUTION</span></div>
<div class="line"><a name="l04005"></a><span class="lineno"> 4005</span>&#160;          failreturnenergy=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab0abd953f677a44020dc50259c410486">FAILRETURNGENERAL</a>;<span class="comment">// default to fail</span></div>
<div class="line"><a name="l04006"></a><span class="lineno"> 4006</span>&#160;          eomtypeenergy=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a03d89f51ab60206791830c886d62bfd0">EOMGRMHD</a>;</div>
<div class="line"><a name="l04007"></a><span class="lineno"> 4007</span>&#160;          <span class="keywordtype">int</span> whichcall=eomtypeenergy;</div>
<div class="line"><a name="l04008"></a><span class="lineno"> 4008</span>&#160;          get_rameshsolution_wrapper(whichcall, eomtypeenergy, errorabsforramesh, ptrgeom, pbenergy, piin, Uiin, Ufin, dUother, CUf, CUimp, q, ppeng, ppent, uueng, uuent, dUcompeng, dUcompent, &amp;qeng, &amp;qent, &amp;failtypeeng, errorabseng, &amp;iterseng, &amp;radinvmodeng, &amp;failtypeent, errorabsent, &amp;itersent, &amp;radinvmodent);</div>
<div class="line"><a name="l04009"></a><span class="lineno"> 4009</span>&#160;          gotrameshsolution=1; <span class="comment">// indicates did at least attempt ramesh soltion call</span></div>
<div class="line"><a name="l04010"></a><span class="lineno"> 4010</span>&#160;          <span class="comment">// translate</span></div>
<div class="line"><a name="l04011"></a><span class="lineno"> 4011</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l04012"></a><span class="lineno"> 4012</span>&#160;            pbenergy[pl]=ppeng[pl];</div>
<div class="line"><a name="l04013"></a><span class="lineno"> 4013</span>&#160;            uubenergy[pl]=uueng[pl];</div>
<div class="line"><a name="l04014"></a><span class="lineno"> 4014</span>&#160;            <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a2da8b12fca78064531b9b64e5699e4fc" title="loop over ALL sources (including geometry)">SCLOOP</a>(sc) dUcompenergy[sc][pl]=dUcompeng[sc][pl];</div>
<div class="line"><a name="l04015"></a><span class="lineno"> 4015</span>&#160;          }</div>
<div class="line"><a name="l04016"></a><span class="lineno"> 4016</span>&#160;          qenergy=qeng;</div>
<div class="line"><a name="l04017"></a><span class="lineno"> 4017</span>&#160;          <span class="comment">//</span></div>
<div class="line"><a name="l04018"></a><span class="lineno"> 4018</span>&#160;          *lpflag=*lpflagrad=(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a>)failtypeeng; <span class="comment">// need better translation</span></div>
<div class="line"><a name="l04019"></a><span class="lineno"> 4019</span>&#160;          radinvmodenergy=radinvmodeng;</div>
<div class="line"><a name="l04020"></a><span class="lineno"> 4020</span>&#160;          radErfnegenergy=0; <span class="comment">// not allowed, considered BADNEG type</span></div>
<div class="line"><a name="l04021"></a><span class="lineno"> 4021</span>&#160;          itersenergy=iterseng;</div>
<div class="line"><a name="l04022"></a><span class="lineno"> 4022</span>&#160;          errorabsenergy[0]=errorabseng[0];</div>
<div class="line"><a name="l04023"></a><span class="lineno"> 4023</span>&#160;          errorabsenergy[1]=errorabseng[1];</div>
<div class="line"><a name="l04024"></a><span class="lineno"> 4024</span>&#160;          <span class="keywordflow">if</span>(failtypeeng || errorabsenergy[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>]&gt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8469a53eb25c0eb3b81286c364d0e7f3">IMPALLOWCONVCONSTABS</a>){ failreturnenergy=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab0abd953f677a44020dc50259c410486">FAILRETURNGENERAL</a>; eomtypeenergy=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a03d89f51ab60206791830c886d62bfd0">EOMGRMHD</a>; }</div>
<div class="line"><a name="l04025"></a><span class="lineno"> 4025</span>&#160;          <span class="keywordflow">else</span> <span class="keywordflow">if</span>(errorabsenergy[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>]&lt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a37aa5c4b7b1b481299d87bf929d13b15" title="error for comparing to sum over all absolute errors">IMPTRYCONVABS</a>){ failreturnenergy=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a3d6e4da5640133efaad94738c97e5171">FAILRETURNNOFAIL</a>; eomtypeenergy=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a04d93d33dd8dba356800fa12cb80064e">EOMDIDGRMHD</a>;}</div>
<div class="line"><a name="l04026"></a><span class="lineno"> 4026</span>&#160;          <span class="keywordflow">else</span>{ failreturnenergy=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a45adfa493bc8ab6857a43a11d9d649d1">FAILRETURNNOTTOLERROR</a>; eomtypeenergy=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a04d93d33dd8dba356800fa12cb80064e">EOMDIDGRMHD</a>;}</div>
<div class="line"><a name="l04027"></a><span class="lineno"> 4027</span>&#160;          <span class="comment">// END GET RAMESH SOLUTION</span></div>
<div class="line"><a name="l04028"></a><span class="lineno"> 4028</span>&#160;        }<span class="comment">// end else if need to get ramesh solution</span></div>
<div class="line"><a name="l04029"></a><span class="lineno"> 4029</span>&#160;</div>
<div class="line"><a name="l04030"></a><span class="lineno"> 4030</span>&#160;        <span class="comment">// see if want to keep</span></div>
<div class="line"><a name="l04031"></a><span class="lineno"> 4031</span>&#160;        <span class="comment">//        if(errorabsenergy[WHICHERROR]&lt;errorabsenergybest[WHICHERROR] &amp;&amp; ACTUALHARDFAILURE(failreturnenergy)==0){// || failreturnenergy==FAILRETURNMODESWITCH){ // no switch mode in ramesh solver yet.</span></div>
<div class="line"><a name="l04032"></a><span class="lineno"> 4032</span>&#160;        <span class="comment">//        if((errorabsenergy[WHICHERROR]&lt;errorabsenergybest[WHICHERROR] &amp;&amp; (RADINVBAD(radinvmodenergy)==0 || RADINVBAD(radinvmodenergybest) &amp;&amp; RADINVBAD(radinvmodenergy)) || RADINVBAD(radinvmodenergybest) &amp;&amp; RADINVBAD(radinvmodenergy)==0 &amp;&amp; (errorabsenergy[WHICHERROR]&lt;errorabsenergybest[WHICHERROR]||errorabsenergy[WHICHERROR]&lt;IMPOKCONVABS)) &amp;&amp; ACTUALHARDFAILURE(failreturnenergy)==0){</span></div>
<div class="line"><a name="l04033"></a><span class="lineno"> 4033</span>&#160;</div>
<div class="line"><a name="l04034"></a><span class="lineno"> 4034</span>&#160;        <span class="comment">//        if((errorabsenergy[WHICHERROR]&lt;errorabsenergybest[WHICHERROR] &amp;&amp; (RADINVBAD(radinvmodenergy)==0 || RADINVBAD(radinvmodenergybest) &amp;&amp; RADINVBAD(radinvmodenergy)) || RADINVBAD(radinvmodenergybest) &amp;&amp; RADINVBAD(radinvmodenergy)==0 &amp;&amp; (errorabsenergy[WHICHERROR]&lt;errorabsenergybest[WHICHERROR]||errorabsenergy[WHICHERROR]&lt;IMPOKCONVABS) || RADINVBAD(radinvmodenergybest)==0 &amp;&amp; RADINVBAD(radinvmodenergy) &amp;&amp; (errorabsenergybest[WHICHERROR]&gt;IMPOKCONVABS &amp;&amp; errorabsenergy[WHICHERROR]&lt;IMPOKCONVABS)) &amp;&amp; ACTUALHARDFAILURE(failreturnenergy)==0){</span></div>
<div class="line"><a name="l04035"></a><span class="lineno"> 4035</span>&#160;</div>
<div class="line"><a name="l04036"></a><span class="lineno"> 4036</span>&#160;        <span class="keywordflow">if</span>(</div>
<div class="line"><a name="l04037"></a><span class="lineno"> 4037</span>&#160;           (</div>
<div class="line"><a name="l04038"></a><span class="lineno"> 4038</span>&#160;            <span class="comment">// best and no radinv problem</span></div>
<div class="line"><a name="l04039"></a><span class="lineno"> 4039</span>&#160;            errorabsenergy[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>]&lt;errorabsenergybest[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>] &amp;&amp; <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0685d01c4383c1608a7ea72cb7ce3791">RADINVBAD</a>(radinvmodenergy)==0</div>
<div class="line"><a name="l04040"></a><span class="lineno"> 4040</span>&#160;            <span class="comment">// best because prior best also had radinv problem and still smaller error</span></div>
<div class="line"><a name="l04041"></a><span class="lineno"> 4041</span>&#160;            || errorabsenergy[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>]&lt;errorabsenergybest[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>] &amp;&amp; (<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0685d01c4383c1608a7ea72cb7ce3791">RADINVBAD</a>(radinvmodenergy) &amp;&amp; <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0685d01c4383c1608a7ea72cb7ce3791">RADINVBAD</a>(radinvmodenergybest))</div>
<div class="line"><a name="l04042"></a><span class="lineno"> 4042</span>&#160;            <span class="comment">// best because even though has radinv problem (while best doesn&#39;t) much smaller error</span></div>
<div class="line"><a name="l04043"></a><span class="lineno"> 4043</span>&#160;            || errorabsenergy[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>]&lt;errorabsenergybest[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>] &amp;&amp; errorabsenergy[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>]&lt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a0beb933bdd5a874f9fcada46b302fbff">IMPOKCONVABS</a> &amp;&amp; errorabsenergybest[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>]&gt;100.0*<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a0beb933bdd5a874f9fcada46b302fbff">IMPOKCONVABS</a> &amp;&amp; (<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0685d01c4383c1608a7ea72cb7ce3791">RADINVBAD</a>(radinvmodenergy) &amp;&amp; <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0685d01c4383c1608a7ea72cb7ce3791">RADINVBAD</a>(radinvmodenergybest)==0)</div>
<div class="line"><a name="l04044"></a><span class="lineno"> 4044</span>&#160;            )</div>
<div class="line"><a name="l04045"></a><span class="lineno"> 4045</span>&#160;           &amp;&amp; <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a98e2c94d4fc861c61bc8dde7b4eec734">ACTUALHARDFAILURE</a>(failreturnenergy)==0){</div>
<div class="line"><a name="l04046"></a><span class="lineno"> 4046</span>&#160;</div>
<div class="line"><a name="l04047"></a><span class="lineno"> 4047</span>&#160;          <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a6ce9f5de6e575be785e5f053882a0909">ACCEPTASNOFAILURE</a>(failreturnenergy)) usedrameshenergy=1; <span class="comment">// means will use this actually, not just best yet no good enough</span></div>
<div class="line"><a name="l04048"></a><span class="lineno"> 4048</span>&#160;          <span class="comment">// store result in case better than latter results</span></div>
<div class="line"><a name="l04049"></a><span class="lineno"> 4049</span>&#160;          lpflagenergybest=*lpflag;</div>
<div class="line"><a name="l04050"></a><span class="lineno"> 4050</span>&#160;          lpflagradenergybest=*lpflagrad;</div>
<div class="line"><a name="l04051"></a><span class="lineno"> 4051</span>&#160;          radinvmodenergybest=radinvmodenergy;</div>
<div class="line"><a name="l04052"></a><span class="lineno"> 4052</span>&#160;          radErfnegenergybest=radErfnegenergy;</div>
<div class="line"><a name="l04053"></a><span class="lineno"> 4053</span>&#160;          failreturnenergybest=failreturnenergy;</div>
<div class="line"><a name="l04054"></a><span class="lineno"> 4054</span>&#160;          eomtypeenergybest=eomtypeenergy;</div>
<div class="line"><a name="l04055"></a><span class="lineno"> 4055</span>&#160;          errorabsenergybest[0]=errorabsenergy[0];</div>
<div class="line"><a name="l04056"></a><span class="lineno"> 4056</span>&#160;          errorabsenergybest[1]=errorabsenergy[1];</div>
<div class="line"><a name="l04057"></a><span class="lineno"> 4057</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l04058"></a><span class="lineno"> 4058</span>&#160;            pbenergybest[pl]=pbenergy[pl];</div>
<div class="line"><a name="l04059"></a><span class="lineno"> 4059</span>&#160;            uubenergybest[pl]=uubenergy[pl];</div>
<div class="line"><a name="l04060"></a><span class="lineno"> 4060</span>&#160;            <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a2da8b12fca78064531b9b64e5699e4fc" title="loop over ALL sources (including geometry)">SCLOOP</a>(sc) dUcompenergybest[sc][pl]=dUcompenergy[sc][pl];</div>
<div class="line"><a name="l04061"></a><span class="lineno"> 4061</span>&#160;          }</div>
<div class="line"><a name="l04062"></a><span class="lineno"> 4062</span>&#160;          qenergybest=qenergy;</div>
<div class="line"><a name="l04063"></a><span class="lineno"> 4063</span>&#160;</div>
<div class="line"><a name="l04064"></a><span class="lineno"> 4064</span>&#160;          <span class="comment">// save which method ended up using</span></div>
<div class="line"><a name="l04065"></a><span class="lineno"> 4065</span>&#160;          methodindex[<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a19f0668a5075a4ca1061348f26a4fc13">BASEITERMETHODINDEX</a>] = <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9cf5ca7f5e5aa1e0bdef53abe3f27c1c">QTYPMHD</a>;</div>
<div class="line"><a name="l04066"></a><span class="lineno"> 4066</span>&#160;          methodindex[<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a698402bc5dc720863bbf11c90786520d">ITERMODEINDEX</a>] = <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a480c56e263c4874ccb40f3bbc1b32032">ITERMODESTAGES</a>;</div>
<div class="line"><a name="l04067"></a><span class="lineno"> 4067</span>&#160;          methodindex[<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a8f7ffa366fb45fd76a8a991ac9f4c43b">IMPMAXITERINDEX</a>] = <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a58cca3253f4dfcefde5fe864699e297a">IMPMAXITERLONG</a>;</div>
<div class="line"><a name="l04068"></a><span class="lineno"> 4068</span>&#160;          methodindex[NUMDAMPINDEX] = <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a91061094ecbe11ec91b0999d1f243f20">NUMDAMPATTEMPTSQUICK</a>;</div>
<div class="line"><a name="l04069"></a><span class="lineno"> 4069</span>&#160;          methodindex[<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a0f8cccff59db9d8325aa44b8cb389a44">MODPRIMINDEX</a>] = 0;</div>
<div class="line"><a name="l04070"></a><span class="lineno"> 4070</span>&#160;          methodindex[<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a86a2418b187397a6fdf2cfd790a0ddeb">CHECKRADINVINDEX</a>] = 1;</div>
<div class="line"><a name="l04071"></a><span class="lineno"> 4071</span>&#160;          methodindex[<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a4681062d53a43e7fcb647275649f05ef">EOMTYPEINDEX</a>] = <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a03d89f51ab60206791830c886d62bfd0">EOMGRMHD</a>;</div>
<div class="line"><a name="l04072"></a><span class="lineno"> 4072</span>&#160;</div>
<div class="line"><a name="l04073"></a><span class="lineno"> 4073</span>&#160;        }</div>
<div class="line"><a name="l04074"></a><span class="lineno"> 4074</span>&#160;</div>
<div class="line"><a name="l04075"></a><span class="lineno"> 4075</span>&#160;        <span class="comment">// still cost more iters</span></div>
<div class="line"><a name="l04076"></a><span class="lineno"> 4076</span>&#160;        itersenergy+=itersenergyold;</div>
<div class="line"><a name="l04077"></a><span class="lineno"> 4077</span>&#160;</div>
<div class="line"><a name="l04078"></a><span class="lineno"> 4078</span>&#160;        <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a7207286a043c1f65037676ebf80412e5">ACTUALHARDORSOFTFAILURE</a>(failreturnenergy)==0){<span class="comment">// || failreturnenergy==FAILRETURNMODESWITCH){</span></div>
<div class="line"><a name="l04079"></a><span class="lineno"> 4079</span>&#160;          <span class="keywordflow">if</span>(debugfail&gt;=2) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;(energy: failreturnenergy=%d): Recovered using ramesh (%d %d): ijknstepsteppart=%d %d %d %ld %d : error: %21.15g-&gt;%21.15g iters: %d-&gt;%d\n&quot;</span>,failreturnenergy,gotrameshsolution,usedrameshenergy,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a1a1088d87617078680f1fd0f0d707384">nstep</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a70170b90229f9fc05eebf8508a685c70">steppart</a>,errorabsenergyold[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>],errorabsenergy[WHICHERROR],itersenergyold,itersenergy);</div>
<div class="line"><a name="l04080"></a><span class="lineno"> 4080</span>&#160;        }</div>
<div class="line"><a name="l04081"></a><span class="lineno"> 4081</span>&#160;        <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l04082"></a><span class="lineno"> 4082</span>&#160;          <span class="keywordflow">if</span>(debugfail&gt;=2) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;Failed to  (energy: failreturnenergy=%d): Recovered using ramesh (%d %d): ijknstepsteppart=%d %d %d %ld %d : error: %21.15g-&gt;%21.15g iters: %d-&gt;%d\n&quot;</span>,failreturnenergy,gotrameshsolution,usedrameshenergy,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a1a1088d87617078680f1fd0f0d707384">nstep</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a70170b90229f9fc05eebf8508a685c70">steppart</a>,errorabsenergyold[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>],errorabsenergy[WHICHERROR],itersenergyold,itersenergy);</div>
<div class="line"><a name="l04083"></a><span class="lineno"> 4083</span>&#160;        }</div>
<div class="line"><a name="l04084"></a><span class="lineno"> 4084</span>&#160;      }<span class="comment">// end if using ramesh</span></div>
<div class="line"><a name="l04085"></a><span class="lineno"> 4085</span>&#160;</div>
<div class="line"><a name="l04086"></a><span class="lineno"> 4086</span>&#160;      </div>
<div class="line"><a name="l04087"></a><span class="lineno"> 4087</span>&#160;</div>
<div class="line"><a name="l04088"></a><span class="lineno"> 4088</span>&#160;</div>
<div class="line"><a name="l04089"></a><span class="lineno"> 4089</span>&#160;</div>
<div class="line"><a name="l04090"></a><span class="lineno"> 4090</span>&#160;</div>
<div class="line"><a name="l04092"></a><span class="lineno"> 4092</span>&#160;      <span class="comment">//</span></div>
<div class="line"><a name="l04093"></a><span class="lineno"> 4093</span>&#160;      <span class="comment">// use best result from trying harder over all energy attempts</span></div>
<div class="line"><a name="l04094"></a><span class="lineno"> 4094</span>&#160;      <span class="comment">//</span></div>
<div class="line"><a name="l04096"></a><span class="lineno"> 4096</span>&#160;<span class="comment"></span>      *lpflag=lpflagenergybest;</div>
<div class="line"><a name="l04097"></a><span class="lineno"> 4097</span>&#160;      *lpflagrad=lpflagradenergybest;</div>
<div class="line"><a name="l04098"></a><span class="lineno"> 4098</span>&#160;      radinvmodenergy=radinvmodenergybest;</div>
<div class="line"><a name="l04099"></a><span class="lineno"> 4099</span>&#160;      radErfnegenergy=radErfnegenergybest;</div>
<div class="line"><a name="l04100"></a><span class="lineno"> 4100</span>&#160;      failreturnenergy=failreturnenergybest;</div>
<div class="line"><a name="l04101"></a><span class="lineno"> 4101</span>&#160;      eomtypeenergy=eomtypeenergybest;</div>
<div class="line"><a name="l04102"></a><span class="lineno"> 4102</span>&#160;      errorabsenergy[0]=errorabsenergybest[0];</div>
<div class="line"><a name="l04103"></a><span class="lineno"> 4103</span>&#160;      errorabsenergy[1]=errorabsenergybest[1];</div>
<div class="line"><a name="l04104"></a><span class="lineno"> 4104</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l04105"></a><span class="lineno"> 4105</span>&#160;        pbenergy[pl]=pbenergybest[pl];</div>
<div class="line"><a name="l04106"></a><span class="lineno"> 4106</span>&#160;        uubenergy[pl]=uubenergybest[pl];</div>
<div class="line"><a name="l04107"></a><span class="lineno"> 4107</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a2da8b12fca78064531b9b64e5699e4fc" title="loop over ALL sources (including geometry)">SCLOOP</a>(sc) dUcompenergy[sc][pl]=dUcompenergybest[sc][pl];</div>
<div class="line"><a name="l04108"></a><span class="lineno"> 4108</span>&#160;      }</div>
<div class="line"><a name="l04109"></a><span class="lineno"> 4109</span>&#160;      qenergy=qenergybest;</div>
<div class="line"><a name="l04110"></a><span class="lineno"> 4110</span>&#160;      goexplicitenergy=goexplicitenergybest;</div>
<div class="line"><a name="l04111"></a><span class="lineno"> 4111</span>&#160;</div>
<div class="line"><a name="l04112"></a><span class="lineno"> 4112</span>&#160;      <span class="comment">// store these in case energy ultimately used</span></div>
<div class="line"><a name="l04113"></a><span class="lineno"> 4113</span>&#160;      lpflagenergy=*lpflag;</div>
<div class="line"><a name="l04114"></a><span class="lineno"> 4114</span>&#160;      lpflagradenergy=*lpflagrad;</div>
<div class="line"><a name="l04115"></a><span class="lineno"> 4115</span>&#160;</div>
<div class="line"><a name="l04116"></a><span class="lineno"> 4116</span>&#160;      </div>
<div class="line"><a name="l04117"></a><span class="lineno"> 4117</span>&#160;</div>
<div class="line"><a name="l04118"></a><span class="lineno"> 4118</span>&#160;</div>
<div class="line"><a name="l04119"></a><span class="lineno"> 4119</span>&#160;</div>
<div class="line"><a name="l04120"></a><span class="lineno"> 4120</span>&#160;     </div>
<div class="line"><a name="l04121"></a><span class="lineno"> 4121</span>&#160;    }<span class="comment">// end if doing GRMHD inversion</span></div>
<div class="line"><a name="l04122"></a><span class="lineno"> 4122</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l04123"></a><span class="lineno"> 4123</span>&#160;      <span class="comment">// if didn&#39;t do energy inversion, treat as failure of said inversion</span></div>
<div class="line"><a name="l04124"></a><span class="lineno"> 4124</span>&#160;      failreturnenergy=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab0abd953f677a44020dc50259c410486">FAILRETURNGENERAL</a>;</div>
<div class="line"><a name="l04125"></a><span class="lineno"> 4125</span>&#160;    }</div>
<div class="line"><a name="l04126"></a><span class="lineno"> 4126</span>&#160;</div>
<div class="line"><a name="l04127"></a><span class="lineno"> 4127</span>&#160;</div>
<div class="line"><a name="l04128"></a><span class="lineno"> 4128</span>&#160;</div>
<div class="line"><a name="l04129"></a><span class="lineno"> 4129</span>&#160;</div>
<div class="line"><a name="l04130"></a><span class="lineno"> 4130</span>&#160;</div>
<div class="line"><a name="l04131"></a><span class="lineno"> 4131</span>&#160;</div>
<div class="line"><a name="l04132"></a><span class="lineno"> 4132</span>&#160;</div>
<div class="line"><a name="l04133"></a><span class="lineno"> 4133</span>&#160;    <span class="keywordflow">if</span>(</div>
<div class="line"><a name="l04134"></a><span class="lineno"> 4134</span>&#160;       reducetoquick!=1 &amp;&amp; (</div>
<div class="line"><a name="l04135"></a><span class="lineno"> 4135</span>&#160;       eomtypecond[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a40b55e98bfcccde1a3f19d983ca7488c">EOMENTROPYGRMHD</a>]==1</div>
<div class="line"><a name="l04136"></a><span class="lineno"> 4136</span>&#160;       || (pbenergy[UU]&lt;=0.0 &amp;&amp; <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a6ce9f5de6e575be785e5f053882a0909">ACCEPTASNOFAILURE</a>(failreturnenergy)==1 || <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a98e2c94d4fc861c61bc8dde7b4eec734">ACTUALHARDFAILURE</a>(failreturnenergy)==1)</div>
<div class="line"><a name="l04137"></a><span class="lineno"> 4137</span>&#160;                            )</div>
<div class="line"><a name="l04138"></a><span class="lineno"> 4138</span>&#160;       ){</div>
<div class="line"><a name="l04140"></a><span class="lineno"> 4140</span>&#160;      <span class="comment">//</span></div>
<div class="line"><a name="l04141"></a><span class="lineno"> 4141</span>&#160;      <span class="comment">// GET ENTROPY (currently, only if failure for energy solver)</span></div>
<div class="line"><a name="l04142"></a><span class="lineno"> 4142</span>&#160;      <span class="comment">//</span></div>
<div class="line"><a name="l04144"></a><span class="lineno"> 4144</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04145"></a><span class="lineno"> 4145</span>&#160;</div>
<div class="line"><a name="l04146"></a><span class="lineno"> 4146</span>&#160;      <span class="comment">// quickly try QTYPMHD then QTYURAD</span></div>
<div class="line"><a name="l04147"></a><span class="lineno"> 4147</span>&#160;      <span class="keywordtype">int</span> tryphase1;</div>
<div class="line"><a name="l04148"></a><span class="lineno"> 4148</span>&#160;</div>
<div class="line"><a name="l04149"></a><span class="lineno"> 4149</span>&#160;      <span class="keywordtype">int</span> baseitermethodlist[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a490d03249c544ac789d91c742057394e">NUMPHASESENT</a>]={<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9cf5ca7f5e5aa1e0bdef53abe3f27c1c">QTYPMHD</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ae83cfa7d219127e1aab2b1ccbe844bc6">QTYENTROPYUMHD</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad919bedc37c48678c11e7e45cd1394cf">QTYURAD</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#add9bc1d07725fe2851182eccaa8eb385">QTYPRAD</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9cf5ca7f5e5aa1e0bdef53abe3f27c1c">QTYPMHD</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ae83cfa7d219127e1aab2b1ccbe844bc6">QTYENTROPYUMHD</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad919bedc37c48678c11e7e45cd1394cf">QTYURAD</a>,QTYPRAD}; <span class="keywordtype">int</span> whichfirstpmhd=0,whichfirstentropyumhd=1,whichfirsturad=2,whichfirstprad=3;</div>
<div class="line"><a name="l04150"></a><span class="lineno"> 4150</span>&#160;      <span class="keywordtype">int</span> itermodelist[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a490d03249c544ac789d91c742057394e">NUMPHASESENT</a>]={<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab9c7390f62ef08325e12b7110621d33a">ITERMODENORMAL</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab9c7390f62ef08325e12b7110621d33a">ITERMODENORMAL</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab9c7390f62ef08325e12b7110621d33a">ITERMODENORMAL</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab9c7390f62ef08325e12b7110621d33a">ITERMODENORMAL</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a480c56e263c4874ccb40f3bbc1b32032">ITERMODESTAGES</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a480c56e263c4874ccb40f3bbc1b32032">ITERMODESTAGES</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a480c56e263c4874ccb40f3bbc1b32032">ITERMODESTAGES</a>,ITERMODESTAGES};</div>
<div class="line"><a name="l04151"></a><span class="lineno"> 4151</span>&#160;<span class="preprocessor">#if(DOPERF&amp;&amp;0) // superquick too little</span></div>
<div class="line"><a name="l04152"></a><span class="lineno"> 4152</span>&#160;<span class="preprocessor"></span>      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> trueimptryconvlist[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a490d03249c544ac789d91c742057394e">NUMPHASESENT</a>]={<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ac5e04595551dd07bf6f57b21d5911e81">IMPTRYCONVSUPERQUICK</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ac5e04595551dd07bf6f57b21d5911e81">IMPTRYCONVSUPERQUICK</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ac5e04595551dd07bf6f57b21d5911e81">IMPTRYCONVSUPERQUICK</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ac5e04595551dd07bf6f57b21d5911e81">IMPTRYCONVSUPERQUICK</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ac5e04595551dd07bf6f57b21d5911e81">IMPTRYCONVSUPERQUICK</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ac5e04595551dd07bf6f57b21d5911e81">IMPTRYCONVSUPERQUICK</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ac5e04595551dd07bf6f57b21d5911e81">IMPTRYCONVSUPERQUICK</a>,IMPTRYCONVSUPERQUICK};</div>
<div class="line"><a name="l04153"></a><span class="lineno"> 4153</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> trueimpokconvlist[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a490d03249c544ac789d91c742057394e">NUMPHASESENT</a>]={<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ac5e04595551dd07bf6f57b21d5911e81">IMPTRYCONVSUPERQUICK</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ac5e04595551dd07bf6f57b21d5911e81">IMPTRYCONVSUPERQUICK</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ac5e04595551dd07bf6f57b21d5911e81">IMPTRYCONVSUPERQUICK</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ac5e04595551dd07bf6f57b21d5911e81">IMPTRYCONVSUPERQUICK</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ac5e04595551dd07bf6f57b21d5911e81">IMPTRYCONVSUPERQUICK</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ac5e04595551dd07bf6f57b21d5911e81">IMPTRYCONVSUPERQUICK</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ac5e04595551dd07bf6f57b21d5911e81">IMPTRYCONVSUPERQUICK</a>,IMPTRYCONVSUPERQUICK};</div>
<div class="line"><a name="l04154"></a><span class="lineno"> 4154</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> trueimpallowconvconstlist[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a490d03249c544ac789d91c742057394e">NUMPHASESENT</a>]={<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab1ad1aee2202922457a377be53918cdc" title="what tolerance to use for saying can switch to entropy when u_g is suggested to be bad for energy...">IMPALLOWCONVCONST</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab1ad1aee2202922457a377be53918cdc" title="what tolerance to use for saying can switch to entropy when u_g is suggested to be bad for energy...">IMPALLOWCONVCONST</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab1ad1aee2202922457a377be53918cdc" title="what tolerance to use for saying can switch to entropy when u_g is suggested to be bad for energy...">IMPALLOWCONVCONST</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab1ad1aee2202922457a377be53918cdc" title="what tolerance to use for saying can switch to entropy when u_g is suggested to be bad for energy...">IMPALLOWCONVCONST</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab1ad1aee2202922457a377be53918cdc" title="what tolerance to use for saying can switch to entropy when u_g is suggested to be bad for energy...">IMPALLOWCONVCONST</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab1ad1aee2202922457a377be53918cdc" title="what tolerance to use for saying can switch to entropy when u_g is suggested to be bad for energy...">IMPALLOWCONVCONST</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab1ad1aee2202922457a377be53918cdc" title="what tolerance to use for saying can switch to entropy when u_g is suggested to be bad for energy...">IMPALLOWCONVCONST</a>,IMPALLOWCONVCONST};</div>
<div class="line"><a name="l04155"></a><span class="lineno"> 4155</span>&#160;      <span class="keywordtype">int</span> trueimpmaxiterlist[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a490d03249c544ac789d91c742057394e">NUMPHASESENT</a>]={<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a2d8c9708802cf755a4a134bbc40f7fea">IMPMAXITERSUPERQUICK</a>+1,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a2d8c9708802cf755a4a134bbc40f7fea">IMPMAXITERSUPERQUICK</a>+1,IMPMAXITERSUPERQUICK+1,IMPMAXITERSUPERQUICK+1,IMPMAXITERSUPERQUICK+1,IMPMAXITERSUPERQUICK+1,IMPMAXITERSUPERQUICK+1,IMPMAXITERSUPERQUICK+1};</div>
<div class="line"><a name="l04156"></a><span class="lineno"> 4156</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l04157"></a><span class="lineno"> 4157</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#if(DOPERF)</span></div>
<div class="line"><a name="l04158"></a><span class="lineno"> 4158</span>&#160;<span class="preprocessor"></span>      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> trueimptryconvlist[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a490d03249c544ac789d91c742057394e">NUMPHASESENT</a>]={<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a1ed8230cb4aee8a0c35a93613b5abcdd">IMPTRYCONVQUICK</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a1ed8230cb4aee8a0c35a93613b5abcdd">IMPTRYCONVQUICK</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a1ed8230cb4aee8a0c35a93613b5abcdd">IMPTRYCONVQUICK</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a1ed8230cb4aee8a0c35a93613b5abcdd">IMPTRYCONVQUICK</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a1ed8230cb4aee8a0c35a93613b5abcdd">IMPTRYCONVQUICK</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a1ed8230cb4aee8a0c35a93613b5abcdd">IMPTRYCONVQUICK</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a1ed8230cb4aee8a0c35a93613b5abcdd">IMPTRYCONVQUICK</a>,IMPTRYCONVQUICK};</div>
<div class="line"><a name="l04159"></a><span class="lineno"> 4159</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> trueimpokconvlist[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a490d03249c544ac789d91c742057394e">NUMPHASESENT</a>]={<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a1ed8230cb4aee8a0c35a93613b5abcdd">IMPTRYCONVQUICK</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a1ed8230cb4aee8a0c35a93613b5abcdd">IMPTRYCONVQUICK</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a1ed8230cb4aee8a0c35a93613b5abcdd">IMPTRYCONVQUICK</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a1ed8230cb4aee8a0c35a93613b5abcdd">IMPTRYCONVQUICK</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a1ed8230cb4aee8a0c35a93613b5abcdd">IMPTRYCONVQUICK</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a1ed8230cb4aee8a0c35a93613b5abcdd">IMPTRYCONVQUICK</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a1ed8230cb4aee8a0c35a93613b5abcdd">IMPTRYCONVQUICK</a>,IMPTRYCONVQUICK};</div>
<div class="line"><a name="l04160"></a><span class="lineno"> 4160</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> trueimpallowconvconstlist[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a490d03249c544ac789d91c742057394e">NUMPHASESENT</a>]={<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab1ad1aee2202922457a377be53918cdc" title="what tolerance to use for saying can switch to entropy when u_g is suggested to be bad for energy...">IMPALLOWCONVCONST</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab1ad1aee2202922457a377be53918cdc" title="what tolerance to use for saying can switch to entropy when u_g is suggested to be bad for energy...">IMPALLOWCONVCONST</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab1ad1aee2202922457a377be53918cdc" title="what tolerance to use for saying can switch to entropy when u_g is suggested to be bad for energy...">IMPALLOWCONVCONST</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab1ad1aee2202922457a377be53918cdc" title="what tolerance to use for saying can switch to entropy when u_g is suggested to be bad for energy...">IMPALLOWCONVCONST</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab1ad1aee2202922457a377be53918cdc" title="what tolerance to use for saying can switch to entropy when u_g is suggested to be bad for energy...">IMPALLOWCONVCONST</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab1ad1aee2202922457a377be53918cdc" title="what tolerance to use for saying can switch to entropy when u_g is suggested to be bad for energy...">IMPALLOWCONVCONST</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab1ad1aee2202922457a377be53918cdc" title="what tolerance to use for saying can switch to entropy when u_g is suggested to be bad for energy...">IMPALLOWCONVCONST</a>,IMPALLOWCONVCONST};</div>
<div class="line"><a name="l04161"></a><span class="lineno"> 4161</span>&#160;      <span class="keywordtype">int</span> trueimpmaxiterlist[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a490d03249c544ac789d91c742057394e">NUMPHASESENT</a>]={<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a03eeb7614c6d7be8ab6fb4e6d2036ee3">IMPMAXITERQUICK</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a03eeb7614c6d7be8ab6fb4e6d2036ee3">IMPMAXITERQUICK</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a03eeb7614c6d7be8ab6fb4e6d2036ee3">IMPMAXITERQUICK</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a03eeb7614c6d7be8ab6fb4e6d2036ee3">IMPMAXITERQUICK</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a03eeb7614c6d7be8ab6fb4e6d2036ee3">IMPMAXITERQUICK</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a03eeb7614c6d7be8ab6fb4e6d2036ee3">IMPMAXITERQUICK</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a03eeb7614c6d7be8ab6fb4e6d2036ee3">IMPMAXITERQUICK</a>,IMPMAXITERQUICK};</div>
<div class="line"><a name="l04162"></a><span class="lineno"> 4162</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l04163"></a><span class="lineno"> 4163</span>&#160;<span class="preprocessor"></span>      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> trueimptryconvlist[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a490d03249c544ac789d91c742057394e">NUMPHASESENT</a>]={<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afc9b116343212081b674a39ac69ce6ed" title="Funny, even 1E-5 does ok with torus, no worse at Erf~ERADLIMIT instances. Also, does ~3 iterations...">IMPTRYCONV</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afc9b116343212081b674a39ac69ce6ed" title="Funny, even 1E-5 does ok with torus, no worse at Erf~ERADLIMIT instances. Also, does ~3 iterations...">IMPTRYCONV</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afc9b116343212081b674a39ac69ce6ed" title="Funny, even 1E-5 does ok with torus, no worse at Erf~ERADLIMIT instances. Also, does ~3 iterations...">IMPTRYCONV</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afc9b116343212081b674a39ac69ce6ed" title="Funny, even 1E-5 does ok with torus, no worse at Erf~ERADLIMIT instances. Also, does ~3 iterations...">IMPTRYCONV</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afc9b116343212081b674a39ac69ce6ed" title="Funny, even 1E-5 does ok with torus, no worse at Erf~ERADLIMIT instances. Also, does ~3 iterations...">IMPTRYCONV</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afc9b116343212081b674a39ac69ce6ed" title="Funny, even 1E-5 does ok with torus, no worse at Erf~ERADLIMIT instances. Also, does ~3 iterations...">IMPTRYCONV</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afc9b116343212081b674a39ac69ce6ed" title="Funny, even 1E-5 does ok with torus, no worse at Erf~ERADLIMIT instances. Also, does ~3 iterations...">IMPTRYCONV</a>,IMPTRYCONV};</div>
<div class="line"><a name="l04164"></a><span class="lineno"> 4164</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> trueimpokconvlist[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a490d03249c544ac789d91c742057394e">NUMPHASESENT</a>]={<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afc9b116343212081b674a39ac69ce6ed" title="Funny, even 1E-5 does ok with torus, no worse at Erf~ERADLIMIT instances. Also, does ~3 iterations...">IMPTRYCONV</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afc9b116343212081b674a39ac69ce6ed" title="Funny, even 1E-5 does ok with torus, no worse at Erf~ERADLIMIT instances. Also, does ~3 iterations...">IMPTRYCONV</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afc9b116343212081b674a39ac69ce6ed" title="Funny, even 1E-5 does ok with torus, no worse at Erf~ERADLIMIT instances. Also, does ~3 iterations...">IMPTRYCONV</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afc9b116343212081b674a39ac69ce6ed" title="Funny, even 1E-5 does ok with torus, no worse at Erf~ERADLIMIT instances. Also, does ~3 iterations...">IMPTRYCONV</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afc9b116343212081b674a39ac69ce6ed" title="Funny, even 1E-5 does ok with torus, no worse at Erf~ERADLIMIT instances. Also, does ~3 iterations...">IMPTRYCONV</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afc9b116343212081b674a39ac69ce6ed" title="Funny, even 1E-5 does ok with torus, no worse at Erf~ERADLIMIT instances. Also, does ~3 iterations...">IMPTRYCONV</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afc9b116343212081b674a39ac69ce6ed" title="Funny, even 1E-5 does ok with torus, no worse at Erf~ERADLIMIT instances. Also, does ~3 iterations...">IMPTRYCONV</a>,IMPTRYCONV};</div>
<div class="line"><a name="l04165"></a><span class="lineno"> 4165</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> trueimpallowconvconstlist[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a490d03249c544ac789d91c742057394e">NUMPHASESENT</a>]={<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab1ad1aee2202922457a377be53918cdc" title="what tolerance to use for saying can switch to entropy when u_g is suggested to be bad for energy...">IMPALLOWCONVCONST</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab1ad1aee2202922457a377be53918cdc" title="what tolerance to use for saying can switch to entropy when u_g is suggested to be bad for energy...">IMPALLOWCONVCONST</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab1ad1aee2202922457a377be53918cdc" title="what tolerance to use for saying can switch to entropy when u_g is suggested to be bad for energy...">IMPALLOWCONVCONST</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab1ad1aee2202922457a377be53918cdc" title="what tolerance to use for saying can switch to entropy when u_g is suggested to be bad for energy...">IMPALLOWCONVCONST</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab1ad1aee2202922457a377be53918cdc" title="what tolerance to use for saying can switch to entropy when u_g is suggested to be bad for energy...">IMPALLOWCONVCONST</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab1ad1aee2202922457a377be53918cdc" title="what tolerance to use for saying can switch to entropy when u_g is suggested to be bad for energy...">IMPALLOWCONVCONST</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab1ad1aee2202922457a377be53918cdc" title="what tolerance to use for saying can switch to entropy when u_g is suggested to be bad for energy...">IMPALLOWCONVCONST</a>,IMPALLOWCONVCONST};</div>
<div class="line"><a name="l04166"></a><span class="lineno"> 4166</span>&#160;      <span class="keywordtype">int</span> trueimpmaxiterlist[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a490d03249c544ac789d91c742057394e">NUMPHASESENT</a>]={<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad666390bb51588e23136cdeccc543418">IMPMAXITERMEDIUM</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad666390bb51588e23136cdeccc543418">IMPMAXITERMEDIUM</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad666390bb51588e23136cdeccc543418">IMPMAXITERMEDIUM</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad666390bb51588e23136cdeccc543418">IMPMAXITERMEDIUM</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad666390bb51588e23136cdeccc543418">IMPMAXITERMEDIUM</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad666390bb51588e23136cdeccc543418">IMPMAXITERMEDIUM</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad666390bb51588e23136cdeccc543418">IMPMAXITERMEDIUM</a>,IMPMAXITERMEDIUM};</div>
<div class="line"><a name="l04167"></a><span class="lineno"> 4167</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l04168"></a><span class="lineno"> 4168</span>&#160;<span class="preprocessor"></span>      <span class="keywordtype">int</span> truenumdampattemptslist[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a490d03249c544ac789d91c742057394e">NUMPHASESENT</a>]={<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a91061094ecbe11ec91b0999d1f243f20">NUMDAMPATTEMPTSQUICK</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a91061094ecbe11ec91b0999d1f243f20">NUMDAMPATTEMPTSQUICK</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a91061094ecbe11ec91b0999d1f243f20">NUMDAMPATTEMPTSQUICK</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a91061094ecbe11ec91b0999d1f243f20">NUMDAMPATTEMPTSQUICK</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a91061094ecbe11ec91b0999d1f243f20">NUMDAMPATTEMPTSQUICK</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a91061094ecbe11ec91b0999d1f243f20">NUMDAMPATTEMPTSQUICK</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a91061094ecbe11ec91b0999d1f243f20">NUMDAMPATTEMPTSQUICK</a>,NUMDAMPATTEMPTSQUICK};</div>
<div class="line"><a name="l04169"></a><span class="lineno"> 4169</span>&#160;      <span class="keywordtype">int</span> modprimlist[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a490d03249c544ac789d91c742057394e">NUMPHASESENT</a>]={0,0,0,0,1,0,0,0};</div>
<div class="line"><a name="l04170"></a><span class="lineno"> 4170</span>&#160;      <span class="keywordtype">int</span> checkradinvlist[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a490d03249c544ac789d91c742057394e">NUMPHASESENT</a>]={0,1,1,1,0,1,1,1};</div>
<div class="line"><a name="l04171"></a><span class="lineno"> 4171</span>&#160;      <span class="keywordtype">int</span> eomtypelist[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a490d03249c544ac789d91c742057394e">NUMPHASESENT</a>]={<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a40b55e98bfcccde1a3f19d983ca7488c">EOMENTROPYGRMHD</a>,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a40b55e98bfcccde1a3f19d983ca7488c">EOMENTROPYGRMHD</a>,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a40b55e98bfcccde1a3f19d983ca7488c">EOMENTROPYGRMHD</a>,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a40b55e98bfcccde1a3f19d983ca7488c">EOMENTROPYGRMHD</a>,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a40b55e98bfcccde1a3f19d983ca7488c">EOMENTROPYGRMHD</a>,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a40b55e98bfcccde1a3f19d983ca7488c">EOMENTROPYGRMHD</a>,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a40b55e98bfcccde1a3f19d983ca7488c">EOMENTROPYGRMHD</a>,EOMENTROPYGRMHD};</div>
<div class="line"><a name="l04172"></a><span class="lineno"> 4172</span>&#160;</div>
<div class="line"><a name="l04173"></a><span class="lineno"> 4173</span>&#160;      <span class="comment">// results in list</span></div>
<div class="line"><a name="l04174"></a><span class="lineno"> 4174</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> errorabslist[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8076bfd08bb8012f9711601a7364d93c">NUMPHASES</a>][<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa63447acbbbc62cbedae23eac61c716e" title="determine which error will use when deciding if converged or not.">NUMERRORTYPES</a>];</div>
<div class="line"><a name="l04175"></a><span class="lineno"> 4175</span>&#160;      set_array(errorabslist,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8076bfd08bb8012f9711601a7364d93c">NUMPHASES</a>*<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa63447acbbbc62cbedae23eac61c716e" title="determine which error will use when deciding if converged or not.">NUMERRORTYPES</a>,MPI_FTYPE,1.0);</div>
<div class="line"><a name="l04176"></a><span class="lineno"> 4176</span>&#160;      <span class="keywordtype">int</span> radinvmodlist[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8076bfd08bb8012f9711601a7364d93c">NUMPHASES</a>];</div>
<div class="line"><a name="l04177"></a><span class="lineno"> 4177</span>&#160;      set_array(radinvmodlist,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8076bfd08bb8012f9711601a7364d93c">NUMPHASES</a>,MPI_INT,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ad987489760e6592057a80faf09588c88" title="unfixable inversion problems">UTOPRIMRADFAILBAD1</a>);</div>
<div class="line"><a name="l04178"></a><span class="lineno"> 4178</span>&#160;</div>
<div class="line"><a name="l04179"></a><span class="lineno"> 4179</span>&#160;      <span class="keywordflow">if</span>(gasprimaryevolves==0){ <span class="comment">// if gas primary evolves, then keep original order because PMHD is fastest method.</span></div>
<div class="line"><a name="l04180"></a><span class="lineno"> 4180</span>&#160;        <span class="keywordflow">if</span>(radprimaryevolves){</div>
<div class="line"><a name="l04181"></a><span class="lineno"> 4181</span>&#160;          <span class="keywordflow">if</span>(</div>
<div class="line"><a name="l04182"></a><span class="lineno"> 4182</span>&#160;             (<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a0e05f8ddd1f85dddb1432aa1941bbbd7" title="whether to use history of methods to determine current method  KORALTODO: Needs work.">USEPRIORITERMETHOD</a> &amp;&amp; (prioritermethodlist[<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a19f0668a5075a4ca1061348f26a4fc13">BASEITERMETHODINDEX</a>] == <a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a5b3bcf4eaf08299f68268d75a01a0f9b">PRIORITERMETHODNOTSET</a> ||  prioritermethodlist[<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a19f0668a5075a4ca1061348f26a4fc13">BASEITERMETHODINDEX</a>] == <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad919bedc37c48678c11e7e45cd1394cf">QTYURAD</a>))</div>
<div class="line"><a name="l04183"></a><span class="lineno"> 4183</span>&#160;             || <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a0e05f8ddd1f85dddb1432aa1941bbbd7" title="whether to use history of methods to determine current method  KORALTODO: Needs work.">USEPRIORITERMETHOD</a>==0</div>
<div class="line"><a name="l04184"></a><span class="lineno"> 4184</span>&#160;             ){</div>
<div class="line"><a name="l04185"></a><span class="lineno"> 4185</span>&#160;            tryphase1=-1;</div>
<div class="line"><a name="l04186"></a><span class="lineno"> 4186</span>&#160;            tryphase1++; baseitermethodlist[tryphase1]=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad919bedc37c48678c11e7e45cd1394cf">QTYURAD</a>;        modprimlist[tryphase1]=0; whichfirsturad=tryphase1;</div>
<div class="line"><a name="l04187"></a><span class="lineno"> 4187</span>&#160;            tryphase1++; baseitermethodlist[tryphase1]=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#add9bc1d07725fe2851182eccaa8eb385">QTYPRAD</a>;        modprimlist[tryphase1]=0; whichfirstprad=tryphase1;</div>
<div class="line"><a name="l04188"></a><span class="lineno"> 4188</span>&#160;            tryphase1++; baseitermethodlist[tryphase1]=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9cf5ca7f5e5aa1e0bdef53abe3f27c1c">QTYPMHD</a>;        modprimlist[tryphase1]=0; whichfirstpmhd=tryphase1;</div>
<div class="line"><a name="l04189"></a><span class="lineno"> 4189</span>&#160;            tryphase1++; baseitermethodlist[tryphase1]=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ae83cfa7d219127e1aab2b1ccbe844bc6">QTYENTROPYUMHD</a>; modprimlist[tryphase1]=0; whichfirstentropyumhd=tryphase1;</div>
<div class="line"><a name="l04190"></a><span class="lineno"> 4190</span>&#160;            tryphase1++; baseitermethodlist[tryphase1]=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad919bedc37c48678c11e7e45cd1394cf">QTYURAD</a>;        modprimlist[tryphase1]=0;</div>
<div class="line"><a name="l04191"></a><span class="lineno"> 4191</span>&#160;            tryphase1++; baseitermethodlist[tryphase1]=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#add9bc1d07725fe2851182eccaa8eb385">QTYPRAD</a>;        modprimlist[tryphase1]=0;</div>
<div class="line"><a name="l04192"></a><span class="lineno"> 4192</span>&#160;            tryphase1++; baseitermethodlist[tryphase1]=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9cf5ca7f5e5aa1e0bdef53abe3f27c1c">QTYPMHD</a>;        modprimlist[tryphase1]=1;</div>
<div class="line"><a name="l04193"></a><span class="lineno"> 4193</span>&#160;            tryphase1++; baseitermethodlist[tryphase1]=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ae83cfa7d219127e1aab2b1ccbe844bc6">QTYENTROPYUMHD</a>; modprimlist[tryphase1]=0;</div>
<div class="line"><a name="l04194"></a><span class="lineno"> 4194</span>&#160;          }</div>
<div class="line"><a name="l04195"></a><span class="lineno"> 4195</span>&#160;          <span class="keywordflow">if</span>(</div>
<div class="line"><a name="l04196"></a><span class="lineno"> 4196</span>&#160;             (<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a0e05f8ddd1f85dddb1432aa1941bbbd7" title="whether to use history of methods to determine current method  KORALTODO: Needs work.">USEPRIORITERMETHOD</a> &amp;&amp; prioritermethodlist[<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a19f0668a5075a4ca1061348f26a4fc13">BASEITERMETHODINDEX</a>] == <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#add9bc1d07725fe2851182eccaa8eb385">QTYPRAD</a>)</div>
<div class="line"><a name="l04197"></a><span class="lineno"> 4197</span>&#160;             ){</div>
<div class="line"><a name="l04198"></a><span class="lineno"> 4198</span>&#160;            tryphase1=-1;</div>
<div class="line"><a name="l04199"></a><span class="lineno"> 4199</span>&#160;            tryphase1++; baseitermethodlist[tryphase1]=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#add9bc1d07725fe2851182eccaa8eb385">QTYPRAD</a>;        modprimlist[tryphase1]=0; whichfirstprad=tryphase1;</div>
<div class="line"><a name="l04200"></a><span class="lineno"> 4200</span>&#160;            tryphase1++; baseitermethodlist[tryphase1]=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad919bedc37c48678c11e7e45cd1394cf">QTYURAD</a>;        modprimlist[tryphase1]=0; whichfirsturad=tryphase1;</div>
<div class="line"><a name="l04201"></a><span class="lineno"> 4201</span>&#160;            tryphase1++; baseitermethodlist[tryphase1]=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9cf5ca7f5e5aa1e0bdef53abe3f27c1c">QTYPMHD</a>;        modprimlist[tryphase1]=0; whichfirstpmhd=tryphase1;</div>
<div class="line"><a name="l04202"></a><span class="lineno"> 4202</span>&#160;            tryphase1++; baseitermethodlist[tryphase1]=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ae83cfa7d219127e1aab2b1ccbe844bc6">QTYENTROPYUMHD</a>; modprimlist[tryphase1]=0; whichfirstentropyumhd=tryphase1;</div>
<div class="line"><a name="l04203"></a><span class="lineno"> 4203</span>&#160;            tryphase1++; baseitermethodlist[tryphase1]=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#add9bc1d07725fe2851182eccaa8eb385">QTYPRAD</a>;        modprimlist[tryphase1]=0;</div>
<div class="line"><a name="l04204"></a><span class="lineno"> 4204</span>&#160;            tryphase1++; baseitermethodlist[tryphase1]=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad919bedc37c48678c11e7e45cd1394cf">QTYURAD</a>;        modprimlist[tryphase1]=0;</div>
<div class="line"><a name="l04205"></a><span class="lineno"> 4205</span>&#160;            tryphase1++; baseitermethodlist[tryphase1]=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9cf5ca7f5e5aa1e0bdef53abe3f27c1c">QTYPMHD</a>;        modprimlist[tryphase1]=1;</div>
<div class="line"><a name="l04206"></a><span class="lineno"> 4206</span>&#160;            tryphase1++; baseitermethodlist[tryphase1]=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ae83cfa7d219127e1aab2b1ccbe844bc6">QTYENTROPYUMHD</a>; modprimlist[tryphase1]=0;</div>
<div class="line"><a name="l04207"></a><span class="lineno"> 4207</span>&#160;          }</div>
<div class="line"><a name="l04208"></a><span class="lineno"> 4208</span>&#160;        }</div>
<div class="line"><a name="l04209"></a><span class="lineno"> 4209</span>&#160;      }</div>
<div class="line"><a name="l04210"></a><span class="lineno"> 4210</span>&#160;</div>
<div class="line"><a name="l04211"></a><span class="lineno"> 4211</span>&#160;</div>
<div class="line"><a name="l04212"></a><span class="lineno"> 4212</span>&#160;      <span class="keywordtype">int</span> firsttryphase1used=-1;</div>
<div class="line"><a name="l04213"></a><span class="lineno"> 4213</span>&#160;      <span class="keywordflow">for</span>(tryphase1=0;tryphase1&lt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a490d03249c544ac789d91c742057394e">NUMPHASESENT</a>;tryphase1++){</div>
<div class="line"><a name="l04214"></a><span class="lineno"> 4214</span>&#160;</div>
<div class="line"><a name="l04215"></a><span class="lineno"> 4215</span>&#160;        <span class="comment">// pick best simple method avoids all solvers except PMHD</span></div>
<div class="line"><a name="l04216"></a><span class="lineno"> 4216</span>&#160;        <span class="keywordflow">if</span>(modemethodlocal==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a861070760a7e713342da86a4c8bfa660">MODEPICKBESTSIMPLE</a> &amp;&amp; baseitermethodlist[tryphase1]!=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9cf5ca7f5e5aa1e0bdef53abe3f27c1c">QTYPMHD</a>) <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l04217"></a><span class="lineno"> 4217</span>&#160;</div>
<div class="line"><a name="l04218"></a><span class="lineno"> 4218</span>&#160;<span class="preprocessor">#if(DOPERF)</span></div>
<div class="line"><a name="l04219"></a><span class="lineno"> 4219</span>&#160;<span class="preprocessor"></span>        <span class="comment">// pick best simple 2 method avoids all itermodestages methods</span></div>
<div class="line"><a name="l04220"></a><span class="lineno"> 4220</span>&#160;        <span class="keywordflow">if</span>(modemethodlocal==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a861070760a7e713342da86a4c8bfa660">MODEPICKBESTSIMPLE</a> &amp;&amp; itermodelist[tryphase1]==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a480c56e263c4874ccb40f3bbc1b32032">ITERMODESTAGES</a>) <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l04221"></a><span class="lineno"> 4221</span>&#160;        <span class="keywordflow">if</span>(funnelcond){ <span class="comment">// then don&#39;t expect to treat density accurate anyways, just need ok accuracy and stability</span></div>
<div class="line"><a name="l04222"></a><span class="lineno"> 4222</span>&#160;          trueimptryconvlist[tryphase1]=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(trueimptryconvlist[tryphase1],<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a2970b7302296037943041f82a6cb59fc">IMPTRYCONVMARGINAL</a>);</div>
<div class="line"><a name="l04223"></a><span class="lineno"> 4223</span>&#160;        }</div>
<div class="line"><a name="l04224"></a><span class="lineno"> 4224</span>&#160;        <span class="keywordflow">if</span>(V[1]&lt;<a class="code" href="../../d8/d5b/defs_8general_8h.html#a20e81ef2343c6d8db701c6613cbcd279">Rhor</a> &amp;&amp; isbhspc){</div>
<div class="line"><a name="l04225"></a><span class="lineno"> 4225</span>&#160;          <span class="comment">//          trueimptryconvlist[tryphase1]=MAX(trueimptryconvlist[tryphase1],IMPTRYCONV_RHORHIGHERTOL);</span></div>
<div class="line"><a name="l04226"></a><span class="lineno"> 4226</span>&#160;          trueimpallowconvconstlist[tryphase1]=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(trueimpallowconvconstlist[tryphase1],<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a69f5311b52c9fce4441c9ded33d86184">IMPALLOWCONV_RHORHIGHERTOL</a>);</div>
<div class="line"><a name="l04227"></a><span class="lineno"> 4227</span>&#160;        }</div>
<div class="line"><a name="l04228"></a><span class="lineno"> 4228</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(V[1]&gt;<a class="code" href="../../da/d3e/definit_8h.html#a96144cf19084532e7fa17366b1b4b5b9">OUTERDEATHRADIUS</a> &amp;&amp; <a class="code" href="../../da/d3e/definit_8h.html#aa2b0c5dd91e7e776f8944c26ff7ecf0b">OUTERDEATH</a>==1){</div>
<div class="line"><a name="l04229"></a><span class="lineno"> 4229</span>&#160;          trueimptryconvlist[tryphase1]=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(trueimptryconvlist[tryphase1],<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#adfc141d6141c97938025b106e5c2484f">IMPTRYCONV_ROUTERHIGHERTOL</a>);</div>
<div class="line"><a name="l04230"></a><span class="lineno"> 4230</span>&#160;        } </div>
<div class="line"><a name="l04231"></a><span class="lineno"> 4231</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l04232"></a><span class="lineno"> 4232</span>&#160;<span class="preprocessor"></span>        <span class="comment">// pick best simple 2 method avoids all itermodestages methods</span></div>
<div class="line"><a name="l04233"></a><span class="lineno"> 4233</span>&#160;        <span class="keywordflow">if</span>(modemethodlocal==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a4a773e56e52c24230ab87c41877f241e">MODEPICKBESTSIMPLE2</a> &amp;&amp; itermodelist[tryphase1]==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a480c56e263c4874ccb40f3bbc1b32032">ITERMODESTAGES</a>) <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l04234"></a><span class="lineno"> 4234</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l04235"></a><span class="lineno"> 4235</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l04236"></a><span class="lineno"> 4236</span>&#160;        <span class="comment">// avoid method in case very non-dominant since then would give errorneous (critically bad even) results.  If methods that can use fail, have to revert to entropy or fixups.</span></div>
<div class="line"><a name="l04237"></a><span class="lineno"> 4237</span>&#160;        <span class="keywordflow">if</span>(radextremeprimaryevolves &amp;&amp; (baseitermethodlist[tryphase1]==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9cf5ca7f5e5aa1e0bdef53abe3f27c1c">QTYPMHD</a> || baseitermethodlist[tryphase1]==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ae83cfa7d219127e1aab2b1ccbe844bc6">QTYENTROPYUMHD</a>) ) <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l04238"></a><span class="lineno"> 4238</span>&#160;        <span class="keywordflow">if</span>(gasextremeprimaryevolves &amp;&amp; (baseitermethodlist[tryphase1]==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad919bedc37c48678c11e7e45cd1394cf">QTYURAD</a> || baseitermethodlist[tryphase1]==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#add9bc1d07725fe2851182eccaa8eb385">QTYPRAD</a>)) <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l04239"></a><span class="lineno"> 4239</span>&#160;</div>
<div class="line"><a name="l04240"></a><span class="lineno"> 4240</span>&#160;        <span class="keywordflow">if</span>(radextremeprimaryevolves==0 &amp;&amp; (baseitermethodlist[tryphase1]==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad919bedc37c48678c11e7e45cd1394cf">QTYURAD</a> || baseitermethodlist[tryphase1]==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#add9bc1d07725fe2851182eccaa8eb385">QTYPRAD</a>) ){</div>
<div class="line"><a name="l04241"></a><span class="lineno"> 4241</span>&#160;          <span class="comment">// if not in extreme radiative regime, then don&#39;t do damping for raditive schemes that are slow.</span></div>
<div class="line"><a name="l04242"></a><span class="lineno"> 4242</span>&#160;          truenumdampattemptslist[tryphase1]=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a91061094ecbe11ec91b0999d1f243f20">NUMDAMPATTEMPTSQUICK</a>;</div>
<div class="line"><a name="l04243"></a><span class="lineno"> 4243</span>&#160;          <span class="comment">// and don&#39;t try to get too good of error.</span></div>
<div class="line"><a name="l04244"></a><span class="lineno"> 4244</span>&#160;          trueimptryconvlist[tryphase1]=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a1ed8230cb4aee8a0c35a93613b5abcdd">IMPTRYCONVQUICK</a>;</div>
<div class="line"><a name="l04245"></a><span class="lineno"> 4245</span>&#160;          <span class="comment">// and avoid stages</span></div>
<div class="line"><a name="l04246"></a><span class="lineno"> 4246</span>&#160;          itermodelist[tryphase1]=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab9c7390f62ef08325e12b7110621d33a">ITERMODENORMAL</a>;</div>
<div class="line"><a name="l04247"></a><span class="lineno"> 4247</span>&#160;        }</div>
<div class="line"><a name="l04248"></a><span class="lineno"> 4248</span>&#160;        <span class="keywordflow">if</span>(gasextremeprimaryevolves==0 &amp;&amp; (baseitermethodlist[tryphase1]==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9cf5ca7f5e5aa1e0bdef53abe3f27c1c">QTYPMHD</a>)){</div>
<div class="line"><a name="l04249"></a><span class="lineno"> 4249</span>&#160;          <span class="comment">// then still try to get good error since fast method, so no changes.</span></div>
<div class="line"><a name="l04250"></a><span class="lineno"> 4250</span>&#160;        }</div>
<div class="line"><a name="l04251"></a><span class="lineno"> 4251</span>&#160;</div>
<div class="line"><a name="l04252"></a><span class="lineno"> 4252</span>&#160;</div>
<div class="line"><a name="l04253"></a><span class="lineno"> 4253</span>&#160;        <span class="keywordflow">if</span>(modemethodlocal==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a861070760a7e713342da86a4c8bfa660">MODEPICKBESTSIMPLE</a>){</div>
<div class="line"><a name="l04254"></a><span class="lineno"> 4254</span>&#160;          <span class="comment">// do nothing, don&#39;t skip stages.</span></div>
<div class="line"><a name="l04255"></a><span class="lineno"> 4255</span>&#160;        }</div>
<div class="line"><a name="l04256"></a><span class="lineno"> 4256</span>&#160;        <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l04257"></a><span class="lineno"> 4257</span>&#160;          <span class="comment">// If already tried QTYPMHD and that got error(0)&lt;tol but error(1)&gt;tol, then skip QTYPMHD with stages since should switch to QTYURAD or QTYPRAD because STAGES won&#39;t improve on error(1) if error(0)&lt;tol.</span></div>
<div class="line"><a name="l04258"></a><span class="lineno"> 4258</span>&#160;          <span class="keywordflow">if</span>(baseitermethodlist[tryphase1]==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9cf5ca7f5e5aa1e0bdef53abe3f27c1c">QTYPMHD</a> &amp;&amp; errorabslist[whichfirstpmhd][0]&lt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afc9b116343212081b674a39ac69ce6ed" title="Funny, even 1E-5 does ok with torus, no worse at Erf~ERADLIMIT instances. Also, does ~3 iterations...">IMPTRYCONV</a> &amp;&amp; errorabslist[whichfirstpmhd][1]&gt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afc9b116343212081b674a39ac69ce6ed" title="Funny, even 1E-5 does ok with torus, no worse at Erf~ERADLIMIT instances. Also, does ~3 iterations...">IMPTRYCONV</a> &amp;&amp; <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>==1){</div>
<div class="line"><a name="l04259"></a><span class="lineno"> 4259</span>&#160;            <span class="comment">// then should skip this case and rely upon radiative solvers</span></div>
<div class="line"><a name="l04260"></a><span class="lineno"> 4260</span>&#160;            <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l04261"></a><span class="lineno"> 4261</span>&#160;          }</div>
<div class="line"><a name="l04262"></a><span class="lineno"> 4262</span>&#160;</div>
<div class="line"><a name="l04263"></a><span class="lineno"> 4263</span>&#160;          <span class="keywordflow">if</span>(baseitermethodlist[tryphase1]==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ae83cfa7d219127e1aab2b1ccbe844bc6">QTYENTROPYUMHD</a> &amp;&amp; errorabslist[whichfirstentropyumhd][0]&lt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afc9b116343212081b674a39ac69ce6ed" title="Funny, even 1E-5 does ok with torus, no worse at Erf~ERADLIMIT instances. Also, does ~3 iterations...">IMPTRYCONV</a> &amp;&amp; errorabslist[whichfirstentropyumhd][1]&gt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afc9b116343212081b674a39ac69ce6ed" title="Funny, even 1E-5 does ok with torus, no worse at Erf~ERADLIMIT instances. Also, does ~3 iterations...">IMPTRYCONV</a> &amp;&amp; <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>==1){</div>
<div class="line"><a name="l04264"></a><span class="lineno"> 4264</span>&#160;            <span class="comment">// then should skip this case and rely upon others</span></div>
<div class="line"><a name="l04265"></a><span class="lineno"> 4265</span>&#160;            <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l04266"></a><span class="lineno"> 4266</span>&#160;          }</div>
<div class="line"><a name="l04267"></a><span class="lineno"> 4267</span>&#160;</div>
<div class="line"><a name="l04268"></a><span class="lineno"> 4268</span>&#160;          <span class="keywordflow">if</span>(baseitermethodlist[tryphase1]==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad919bedc37c48678c11e7e45cd1394cf">QTYURAD</a> &amp;&amp; errorabslist[whichfirsturad][0]&lt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afc9b116343212081b674a39ac69ce6ed" title="Funny, even 1E-5 does ok with torus, no worse at Erf~ERADLIMIT instances. Also, does ~3 iterations...">IMPTRYCONV</a> &amp;&amp; errorabslist[whichfirsturad][1]&gt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afc9b116343212081b674a39ac69ce6ed" title="Funny, even 1E-5 does ok with torus, no worse at Erf~ERADLIMIT instances. Also, does ~3 iterations...">IMPTRYCONV</a> &amp;&amp; <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>==1){</div>
<div class="line"><a name="l04269"></a><span class="lineno"> 4269</span>&#160;            <span class="comment">// then should skip this case and rely upon others</span></div>
<div class="line"><a name="l04270"></a><span class="lineno"> 4270</span>&#160;            <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l04271"></a><span class="lineno"> 4271</span>&#160;          }</div>
<div class="line"><a name="l04272"></a><span class="lineno"> 4272</span>&#160;</div>
<div class="line"><a name="l04273"></a><span class="lineno"> 4273</span>&#160;          <span class="keywordflow">if</span>(baseitermethodlist[tryphase1]==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#add9bc1d07725fe2851182eccaa8eb385">QTYPRAD</a> &amp;&amp; errorabslist[whichfirstprad][0]&lt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afc9b116343212081b674a39ac69ce6ed" title="Funny, even 1E-5 does ok with torus, no worse at Erf~ERADLIMIT instances. Also, does ~3 iterations...">IMPTRYCONV</a> &amp;&amp; errorabslist[whichfirstprad][1]&gt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afc9b116343212081b674a39ac69ce6ed" title="Funny, even 1E-5 does ok with torus, no worse at Erf~ERADLIMIT instances. Also, does ~3 iterations...">IMPTRYCONV</a> &amp;&amp; <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>==1){</div>
<div class="line"><a name="l04274"></a><span class="lineno"> 4274</span>&#160;            <span class="comment">// then should skip this case and rely upon others</span></div>
<div class="line"><a name="l04275"></a><span class="lineno"> 4275</span>&#160;            <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l04276"></a><span class="lineno"> 4276</span>&#160;          }</div>
<div class="line"><a name="l04277"></a><span class="lineno"> 4277</span>&#160;        }</div>
<div class="line"><a name="l04278"></a><span class="lineno"> 4278</span>&#160;</div>
<div class="line"><a name="l04279"></a><span class="lineno"> 4279</span>&#160;</div>
<div class="line"><a name="l04280"></a><span class="lineno"> 4280</span>&#160;        <span class="comment">// __WORKINGONIT__</span></div>
<div class="line"><a name="l04281"></a><span class="lineno"> 4281</span>&#160;        <span class="comment">//if(baseitermethodlist[tryphase1]==QTYENTROPYUMHD || baseitermethodlist[tryphase1]==QTYURAD || baseitermethodlist[tryphase1]==QTYPRAD) continue; // skip this method for now.</span></div>
<div class="line"><a name="l04282"></a><span class="lineno"> 4282</span>&#160;        <span class="keywordflow">if</span>(baseitermethodlist[tryphase1]==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ae83cfa7d219127e1aab2b1ccbe844bc6">QTYENTROPYUMHD</a>) <span class="keywordflow">continue</span>; <span class="comment">// skip this method for now.</span></div>
<div class="line"><a name="l04283"></a><span class="lineno"> 4283</span>&#160;</div>
<div class="line"><a name="l04284"></a><span class="lineno"> 4284</span>&#160;        <span class="keywordflow">if</span>(reducetoquick){</div>
<div class="line"><a name="l04285"></a><span class="lineno"> 4285</span>&#160;          <span class="keywordflow">if</span>(reducetoquick==1){</div>
<div class="line"><a name="l04286"></a><span class="lineno"> 4286</span>&#160;            trueimptryconvlist[tryphase1]=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ac5e04595551dd07bf6f57b21d5911e81">IMPTRYCONVSUPERQUICK</a>;</div>
<div class="line"><a name="l04287"></a><span class="lineno"> 4287</span>&#160;            trueimpmaxiterlist[tryphase1]=1;</div>
<div class="line"><a name="l04288"></a><span class="lineno"> 4288</span>&#160;          }</div>
<div class="line"><a name="l04289"></a><span class="lineno"> 4289</span>&#160;          <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l04290"></a><span class="lineno"> 4290</span>&#160;            trueimptryconvlist[tryphase1]=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a1ed8230cb4aee8a0c35a93613b5abcdd">IMPTRYCONVQUICK</a>;</div>
<div class="line"><a name="l04291"></a><span class="lineno"> 4291</span>&#160;            trueimpmaxiterlist[tryphase1]=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a03eeb7614c6d7be8ab6fb4e6d2036ee3">IMPMAXITERQUICK</a>;</div>
<div class="line"><a name="l04292"></a><span class="lineno"> 4292</span>&#160;          }</div>
<div class="line"><a name="l04293"></a><span class="lineno"> 4293</span>&#160;          <span class="keywordflow">if</span>(firsttryphase1used!=-1) <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l04294"></a><span class="lineno"> 4294</span>&#160;        }</div>
<div class="line"><a name="l04295"></a><span class="lineno"> 4295</span>&#160;</div>
<div class="line"><a name="l04296"></a><span class="lineno"> 4296</span>&#160;</div>
<div class="line"><a name="l04297"></a><span class="lineno"> 4297</span>&#160;        <span class="comment">// consider radinvmod only if error bad for original approach.  Avoids excessive attempts when should hit radiative ceiling and error is small.</span></div>
<div class="line"><a name="l04298"></a><span class="lineno"> 4298</span>&#160;</div>
<div class="line"><a name="l04299"></a><span class="lineno"> 4299</span>&#160;        <span class="keywordtype">int</span> needtotry;</div>
<div class="line"><a name="l04300"></a><span class="lineno"> 4300</span>&#160;        needtotry=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0685d01c4383c1608a7ea72cb7ce3791">RADINVBAD</a>(radinvmodentropybest) &amp;&amp; checkradinvlist[tryphase1] || <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a7207286a043c1f65037676ebf80412e5">ACTUALHARDORSOFTFAILURE</a>(failreturnentropybest) &amp;&amp; failreturnentropybest!=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a42e7e780e89073f5d14dfafda3bae62e">FAILRETURNMODESWITCH</a>;</div>
<div class="line"><a name="l04301"></a><span class="lineno"> 4301</span>&#160;</div>
<div class="line"><a name="l04302"></a><span class="lineno"> 4302</span>&#160;        <span class="keywordflow">if</span>(needtotry){</div>
<div class="line"><a name="l04303"></a><span class="lineno"> 4303</span>&#160;          <span class="keywordflow">if</span>(firsttryphase1used==-1) firsttryphase1used=tryphase1;</div>
<div class="line"><a name="l04304"></a><span class="lineno"> 4304</span>&#160;          tryphaselistentropy[tryphase1]++;</div>
<div class="line"><a name="l04305"></a><span class="lineno"> 4305</span>&#160;</div>
<div class="line"><a name="l04306"></a><span class="lineno"> 4306</span>&#160;</div>
<div class="line"><a name="l04307"></a><span class="lineno"> 4307</span>&#160;          itersentropyold=itersentropy;</div>
<div class="line"><a name="l04308"></a><span class="lineno"> 4308</span>&#160;          errorabsentropyold[0]=errorabsentropy[0];</div>
<div class="line"><a name="l04309"></a><span class="lineno"> 4309</span>&#160;          errorabsentropyold[1]=errorabsentropy[1];</div>
<div class="line"><a name="l04310"></a><span class="lineno"> 4310</span>&#160;          radinvmodentropyold=radinvmodentropy;</div>
<div class="line"><a name="l04311"></a><span class="lineno"> 4311</span>&#160;          <span class="comment">//</span></div>
<div class="line"><a name="l04312"></a><span class="lineno"> 4312</span>&#160;          whichcapentropy=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a4b6c6060c025e15f1d92aae3dcb9365b" title="which cap type to place in rad inversion">CAPTYPEBASIC</a>;</div>
<div class="line"><a name="l04313"></a><span class="lineno"> 4313</span>&#160;          baseitermethodentropy=baseitermethodlist[tryphase1];</div>
<div class="line"><a name="l04314"></a><span class="lineno"> 4314</span>&#160;          itermodeentropy=itermodelist[tryphase1];</div>
<div class="line"><a name="l04315"></a><span class="lineno"> 4315</span>&#160;          trueimptryconventropy=trueimptryconvlist[tryphase1];</div>
<div class="line"><a name="l04316"></a><span class="lineno"> 4316</span>&#160;          trueimpokconventropy=(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(trueimptryconvlist[tryphase1],trueimpokconvlist[tryphase1]));</div>
<div class="line"><a name="l04317"></a><span class="lineno"> 4317</span>&#160;          trueimpallowconventropy=(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(trueimptryconvlist[tryphase1],trueimpallowconvconstlist[tryphase1]));</div>
<div class="line"><a name="l04318"></a><span class="lineno"> 4318</span>&#160;          trueimpmaxiterentropy=trueimpmaxiterlist[tryphase1];</div>
<div class="line"><a name="l04319"></a><span class="lineno"> 4319</span>&#160;          truenumdampattemptsentropy=truenumdampattemptslist[tryphase1];</div>
<div class="line"><a name="l04320"></a><span class="lineno"> 4320</span>&#160;          <span class="keywordtype">int</span> modprim=0;</div>
<div class="line"><a name="l04321"></a><span class="lineno"> 4321</span>&#160;          <span class="keywordflow">if</span>(havebackup==0) modprim=modprimlist[tryphase1];</div>
<div class="line"><a name="l04322"></a><span class="lineno"> 4322</span>&#160;          <span class="comment">//</span></div>
<div class="line"><a name="l04323"></a><span class="lineno"> 4323</span>&#160;          <span class="comment">// start fresh</span></div>
<div class="line"><a name="l04324"></a><span class="lineno"> 4324</span>&#160;          *lpflag=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#abdf9e55b7b15ec0bcd386055f1787f47">UTOPRIMNOFAIL</a>;</div>
<div class="line"><a name="l04325"></a><span class="lineno"> 4325</span>&#160;          *lpflagrad=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6435e9609d622c9dbaf78c12658ecf8e">UTOPRIMRADNOFAIL</a>;</div>
<div class="line"><a name="l04326"></a><span class="lineno"> 4326</span>&#160;          radinvmodentropy=0;</div>
<div class="line"><a name="l04327"></a><span class="lineno"> 4327</span>&#160;          radErfnegentropy=0;</div>
<div class="line"><a name="l04328"></a><span class="lineno"> 4328</span>&#160;          failreturnentropy=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab0abd953f677a44020dc50259c410486">FAILRETURNGENERAL</a>;<span class="comment">// default to fail</span></div>
<div class="line"><a name="l04329"></a><span class="lineno"> 4329</span>&#160;          eomtypeentropy=eomtypelist[tryphase1];</div>
<div class="line"><a name="l04330"></a><span class="lineno"> 4330</span>&#160;          errorabsentropy[0]=errorabsentropy[1]=1.0;</div>
<div class="line"><a name="l04331"></a><span class="lineno"> 4331</span>&#160;          <span class="comment">//</span></div>
<div class="line"><a name="l04332"></a><span class="lineno"> 4332</span>&#160;          <span class="comment">// setup guess</span></div>
<div class="line"><a name="l04333"></a><span class="lineno"> 4333</span>&#160;          <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a98e2c94d4fc861c61bc8dde7b4eec734">ACTUALHARDFAILURE</a>(failreturnenergy)==1 || errorabsenergy[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>]&gt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#abbf8da2bda1bab4cdb847a0faa6db3c1" title="error below which will use entropy as guess for energy if entropy didn&#39;t hard fail.">ERRORTOUSEENTROPYFORENERGYGUESS</a> || pbenergy[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]&lt;=0.0){</div>
<div class="line"><a name="l04334"></a><span class="lineno"> 4334</span>&#160;            <span class="keywordflow">if</span>(errorabsentropybest[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>]&gt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a4a0ce3856fb32518938a274adb6c3946" title="error below which to feed best guess into next attempt">TRYHARDERFEEDGUESSTOL</a>){</div>
<div class="line"><a name="l04335"></a><span class="lineno"> 4335</span>&#160;              <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l04336"></a><span class="lineno"> 4336</span>&#160;                pbentropy[pl]=pbbackup[pl];</div>
<div class="line"><a name="l04337"></a><span class="lineno"> 4337</span>&#160;                uubentropy[pl]=uubbackup[pl];</div>
<div class="line"><a name="l04338"></a><span class="lineno"> 4338</span>&#160;                <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a2da8b12fca78064531b9b64e5699e4fc" title="loop over ALL sources (including geometry)">SCLOOP</a>(sc) dUcompentropy[sc][pl]=dUcompbackup[sc][pl];</div>
<div class="line"><a name="l04339"></a><span class="lineno"> 4339</span>&#160;              }</div>
<div class="line"><a name="l04340"></a><span class="lineno"> 4340</span>&#160;              qentropy=qbackup;</div>
<div class="line"><a name="l04341"></a><span class="lineno"> 4341</span>&#160;              errorabsentropy[0]=errorabsentropy[1]=1.0;</div>
<div class="line"><a name="l04342"></a><span class="lineno"> 4342</span>&#160;              radinvmodentropy=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ad987489760e6592057a80faf09588c88" title="unfixable inversion problems">UTOPRIMRADFAILBAD1</a>;</div>
<div class="line"><a name="l04343"></a><span class="lineno"> 4343</span>&#160;            }</div>
<div class="line"><a name="l04344"></a><span class="lineno"> 4344</span>&#160;            <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l04345"></a><span class="lineno"> 4345</span>&#160;              <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l04346"></a><span class="lineno"> 4346</span>&#160;                pbentropy[pl]=pbentropybest[pl];</div>
<div class="line"><a name="l04347"></a><span class="lineno"> 4347</span>&#160;                uubentropy[pl]=uubentropybest[pl];</div>
<div class="line"><a name="l04348"></a><span class="lineno"> 4348</span>&#160;                <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a2da8b12fca78064531b9b64e5699e4fc" title="loop over ALL sources (including geometry)">SCLOOP</a>(sc) dUcompentropy[sc][pl]=dUcompbackup[sc][pl];</div>
<div class="line"><a name="l04349"></a><span class="lineno"> 4349</span>&#160;              }</div>
<div class="line"><a name="l04350"></a><span class="lineno"> 4350</span>&#160;              qentropy=qentropybest;</div>
<div class="line"><a name="l04351"></a><span class="lineno"> 4351</span>&#160;              errorabsentropy[0]=errorabsentropybest[0];</div>
<div class="line"><a name="l04352"></a><span class="lineno"> 4352</span>&#160;              errorabsentropy[1]=errorabsentropybest[1];</div>
<div class="line"><a name="l04353"></a><span class="lineno"> 4353</span>&#160;              radinvmodentropy=radinvmodentropybest;</div>
<div class="line"><a name="l04354"></a><span class="lineno"> 4354</span>&#160;            }</div>
<div class="line"><a name="l04355"></a><span class="lineno"> 4355</span>&#160;          }</div>
<div class="line"><a name="l04356"></a><span class="lineno"> 4356</span>&#160;          <span class="keywordflow">else</span>{ <span class="comment">// start with energy</span></div>
<div class="line"><a name="l04357"></a><span class="lineno"> 4357</span>&#160;            <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l04358"></a><span class="lineno"> 4358</span>&#160;              pbentropy[pl]=pbenergy[pl];</div>
<div class="line"><a name="l04359"></a><span class="lineno"> 4359</span>&#160;              <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a2da8b12fca78064531b9b64e5699e4fc" title="loop over ALL sources (including geometry)">SCLOOP</a>(sc) dUcompentropy[sc][pl]=dUcompbackup[sc][pl];</div>
<div class="line"><a name="l04360"></a><span class="lineno"> 4360</span>&#160;            }</div>
<div class="line"><a name="l04361"></a><span class="lineno"> 4361</span>&#160;            qentropy=qenergy;</div>
<div class="line"><a name="l04362"></a><span class="lineno"> 4362</span>&#160;            errorabsentropy[0]=errorabsenergy[0]; <span class="comment">// just for setting guess, not accepted error for entropy</span></div>
<div class="line"><a name="l04363"></a><span class="lineno"> 4363</span>&#160;            errorabsentropy[1]=errorabsenergy[1]; <span class="comment">// just for setting guess, not accepted error for entropy</span></div>
<div class="line"><a name="l04364"></a><span class="lineno"> 4364</span>&#160;            radinvmodentropy=radinvmodenergy;</div>
<div class="line"><a name="l04365"></a><span class="lineno"> 4365</span>&#160;          }</div>
<div class="line"><a name="l04366"></a><span class="lineno"> 4366</span>&#160;          <span class="comment">//</span></div>
<div class="line"><a name="l04367"></a><span class="lineno"> 4367</span>&#160;          <span class="comment">//</span></div>
<div class="line"><a name="l04368"></a><span class="lineno"> 4368</span>&#160;          <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fracenergyentropy=0;</div>
<div class="line"><a name="l04369"></a><span class="lineno"> 4369</span>&#160;          failreturnentropy=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a17aede36203a236390363af78d3a86f0" title="compute changes to U (both T and R) using implicit method KORALTODO: If doing implicit, should also add geometry source term that can sometimes be stiff.">koral_source_rad_implicit_mode</a>(modemethodlocal,0,modprim,havebackup, didentropyalready, &amp;eomtypeentropy, whichcapentropy, itermodeentropy, &amp;baseitermethodentropy, trueimptryconventropy, trueimpokconventropy, trueimpallowconventropy, trueimpmaxiterentropy,  truenumdampattemptsentropy, fracenergyentropy, dissmeasure, &amp;radinvmodentropy, pbentropy, uubentropy, piin, Uiin, Ufin, CUf, CUimp, ptrgeom, &amp;qentropy, dUother ,dUcompentropy, errorabsentropy, errorabsentropybest, &amp;itersentropy, &amp;f1itersentropy, &amp;nummhdinvsentropy, &amp;nummhdstepsentropy);</div>
<div class="line"><a name="l04370"></a><span class="lineno"> 4370</span>&#160;          nummhdsteps+=nummhdstepsentropy;</div>
<div class="line"><a name="l04371"></a><span class="lineno"> 4371</span>&#160;</div>
<div class="line"><a name="l04372"></a><span class="lineno"> 4372</span>&#160;</div>
<div class="line"><a name="l04373"></a><span class="lineno"> 4373</span>&#160;          <span class="comment">// store error, no matter if using solution or not or even if explicit</span></div>
<div class="line"><a name="l04374"></a><span class="lineno"> 4374</span>&#160;          errorabslist[tryphase1][0]=errorabsentropy[0];</div>
<div class="line"><a name="l04375"></a><span class="lineno"> 4375</span>&#160;          errorabslist[tryphase1][1]=errorabsentropy[1];</div>
<div class="line"><a name="l04376"></a><span class="lineno"> 4376</span>&#160;</div>
<div class="line"><a name="l04377"></a><span class="lineno"> 4377</span>&#160;          <span class="keywordflow">if</span>(failreturnentropy==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a04634949fd2370214f3d313c9cffa182">FAILRETURNGOTRIVIALEXPLICIT</a>){</div>
<div class="line"><a name="l04378"></a><span class="lineno"> 4378</span>&#160;            lpflagentropybest=*lpflag;</div>
<div class="line"><a name="l04379"></a><span class="lineno"> 4379</span>&#160;            lpflagradentropybest=*lpflagrad;</div>
<div class="line"><a name="l04380"></a><span class="lineno"> 4380</span>&#160;            radinvmodentropybest=radinvmodentropy;</div>
<div class="line"><a name="l04381"></a><span class="lineno"> 4381</span>&#160;            radErfnegentropybest=radErfnegentropy;</div>
<div class="line"><a name="l04382"></a><span class="lineno"> 4382</span>&#160;            failreturnentropybest=failreturnentropy;</div>
<div class="line"><a name="l04383"></a><span class="lineno"> 4383</span>&#160;            eomtypeentropybest=eomtypelist[tryphase1];</div>
<div class="line"><a name="l04384"></a><span class="lineno"> 4384</span>&#160;            goexplicitentropybest=1;</div>
<div class="line"><a name="l04385"></a><span class="lineno"> 4385</span>&#160;</div>
<div class="line"><a name="l04386"></a><span class="lineno"> 4386</span>&#160;            <span class="comment">// save which method ended up using</span></div>
<div class="line"><a name="l04387"></a><span class="lineno"> 4387</span>&#160;            <span class="keywordtype">int</span> prioriter; <span class="keywordflow">for</span>(prioriter=0;prioriter&lt;<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#acb843c30a487185fc9ae1e5460a19284" title="array indices for prioritermethod">NUMPRIORITERMETHODINDEX</a>;prioriter++){</div>
<div class="line"><a name="l04388"></a><span class="lineno"> 4388</span>&#160;              methodindex[prioriter] = <a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a5b3bcf4eaf08299f68268d75a01a0f9b">PRIORITERMETHODNOTSET</a>; <span class="comment">// back to unknown</span></div>
<div class="line"><a name="l04389"></a><span class="lineno"> 4389</span>&#160;            }</div>
<div class="line"><a name="l04390"></a><span class="lineno"> 4390</span>&#160;          }</div>
<div class="line"><a name="l04391"></a><span class="lineno"> 4391</span>&#160;          <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l04392"></a><span class="lineno"> 4392</span>&#160;            <span class="comment">// see if want to keep</span></div>
<div class="line"><a name="l04393"></a><span class="lineno"> 4393</span>&#160;            <span class="comment">//            if((errorabsentropy[WHICHERROR]&lt;errorabsentropybest[WHICHERROR] &amp;&amp; (RADINVBAD(radinvmodentropy)==0 || RADINVBAD(radinvmodentropybest) &amp;&amp; RADINVBAD(radinvmodentropy)) || RADINVBAD(radinvmodentropybest) &amp;&amp; RADINVBAD(radinvmodentropy)==0 &amp;&amp; (errorabsentropy[WHICHERROR]&lt;errorabsentropybest[WHICHERROR]||errorabsentropy[WHICHERROR]&lt;IMPOKCONVABS) || RADINVBAD(radinvmodentropybest)==0 &amp;&amp; RADINVBAD(radinvmodentropy) &amp;&amp; (errorabsentropybest[WHICHERROR]&gt;IMPOKCONVABS &amp;&amp; errorabsentropy[WHICHERROR]&lt;IMPOKCONVABS)) &amp;&amp; ACTUALHARDFAILURE(failreturnentropy)==0){</span></div>
<div class="line"><a name="l04394"></a><span class="lineno"> 4394</span>&#160;            <span class="keywordflow">if</span>(</div>
<div class="line"><a name="l04395"></a><span class="lineno"> 4395</span>&#160;               (</div>
<div class="line"><a name="l04396"></a><span class="lineno"> 4396</span>&#160;                <span class="comment">// best and no radinv problem</span></div>
<div class="line"><a name="l04397"></a><span class="lineno"> 4397</span>&#160;                errorabsentropy[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>]&lt;errorabsentropybest[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>] &amp;&amp; <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0685d01c4383c1608a7ea72cb7ce3791">RADINVBAD</a>(radinvmodentropy)==0</div>
<div class="line"><a name="l04398"></a><span class="lineno"> 4398</span>&#160;                <span class="comment">// best because prior best also had radinv problem and still smaller error</span></div>
<div class="line"><a name="l04399"></a><span class="lineno"> 4399</span>&#160;                || errorabsentropy[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>]&lt;errorabsentropybest[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>] &amp;&amp; (<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0685d01c4383c1608a7ea72cb7ce3791">RADINVBAD</a>(radinvmodentropy) &amp;&amp; <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0685d01c4383c1608a7ea72cb7ce3791">RADINVBAD</a>(radinvmodentropybest))</div>
<div class="line"><a name="l04400"></a><span class="lineno"> 4400</span>&#160;                <span class="comment">// best because even though has radinv problem (while best doesn&#39;t) much smaller error</span></div>
<div class="line"><a name="l04401"></a><span class="lineno"> 4401</span>&#160;                || errorabsentropy[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>]&lt;errorabsentropybest[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>] &amp;&amp; errorabsentropy[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>]&lt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a0beb933bdd5a874f9fcada46b302fbff">IMPOKCONVABS</a> &amp;&amp; errorabsentropybest[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>]&gt;100.0*<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a0beb933bdd5a874f9fcada46b302fbff">IMPOKCONVABS</a> &amp;&amp; (<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0685d01c4383c1608a7ea72cb7ce3791">RADINVBAD</a>(radinvmodentropy) &amp;&amp; <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0685d01c4383c1608a7ea72cb7ce3791">RADINVBAD</a>(radinvmodentropybest)==0)</div>
<div class="line"><a name="l04402"></a><span class="lineno"> 4402</span>&#160;                )</div>
<div class="line"><a name="l04403"></a><span class="lineno"> 4403</span>&#160;               &amp;&amp; <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a98e2c94d4fc861c61bc8dde7b4eec734">ACTUALHARDFAILURE</a>(failreturnentropy)==0){</div>
<div class="line"><a name="l04404"></a><span class="lineno"> 4404</span>&#160;</div>
<div class="line"><a name="l04405"></a><span class="lineno"> 4405</span>&#160;              <span class="comment">// store result in case better than latter results</span></div>
<div class="line"><a name="l04406"></a><span class="lineno"> 4406</span>&#160;              lpflagentropybest=*lpflag;</div>
<div class="line"><a name="l04407"></a><span class="lineno"> 4407</span>&#160;              lpflagradentropybest=*lpflagrad;</div>
<div class="line"><a name="l04408"></a><span class="lineno"> 4408</span>&#160;              radinvmodentropybest=radinvmodentropy;</div>
<div class="line"><a name="l04409"></a><span class="lineno"> 4409</span>&#160;              radErfnegentropybest=radErfnegentropy;</div>
<div class="line"><a name="l04410"></a><span class="lineno"> 4410</span>&#160;              failreturnentropybest=failreturnentropy;</div>
<div class="line"><a name="l04411"></a><span class="lineno"> 4411</span>&#160;              eomtypeentropybest=eomtypeentropy;</div>
<div class="line"><a name="l04412"></a><span class="lineno"> 4412</span>&#160;              goexplicitentropybest=0;</div>
<div class="line"><a name="l04413"></a><span class="lineno"> 4413</span>&#160;              errorabsentropybest[0]=errorabsentropy[0];</div>
<div class="line"><a name="l04414"></a><span class="lineno"> 4414</span>&#160;              errorabsentropybest[1]=errorabsentropy[1];</div>
<div class="line"><a name="l04415"></a><span class="lineno"> 4415</span>&#160;              <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l04416"></a><span class="lineno"> 4416</span>&#160;                pbentropybest[pl]=pbentropy[pl];</div>
<div class="line"><a name="l04417"></a><span class="lineno"> 4417</span>&#160;                uubentropybest[pl]=uubentropy[pl];</div>
<div class="line"><a name="l04418"></a><span class="lineno"> 4418</span>&#160;                <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a2da8b12fca78064531b9b64e5699e4fc" title="loop over ALL sources (including geometry)">SCLOOP</a>(sc) dUcompentropybest[sc][pl]=dUcompentropy[sc][pl];</div>
<div class="line"><a name="l04419"></a><span class="lineno"> 4419</span>&#160;              }</div>
<div class="line"><a name="l04420"></a><span class="lineno"> 4420</span>&#160;              qentropybest=qentropy;</div>
<div class="line"><a name="l04421"></a><span class="lineno"> 4421</span>&#160;</div>
<div class="line"><a name="l04422"></a><span class="lineno"> 4422</span>&#160;              <span class="comment">// save which method ended up using</span></div>
<div class="line"><a name="l04423"></a><span class="lineno"> 4423</span>&#160;              methodindex[<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a19f0668a5075a4ca1061348f26a4fc13">BASEITERMETHODINDEX</a>] = baseitermethodlist[tryphase1];</div>
<div class="line"><a name="l04424"></a><span class="lineno"> 4424</span>&#160;              methodindex[<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a698402bc5dc720863bbf11c90786520d">ITERMODEINDEX</a>] = itermodelist[tryphase1];</div>
<div class="line"><a name="l04425"></a><span class="lineno"> 4425</span>&#160;              methodindex[<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#ae8652406acc776eaa231ffc6eb9fbcb5">IMPTRYCONVINDEX</a>] = (trueimptryconvlist[tryphase1]==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afc9b116343212081b674a39ac69ce6ed" title="Funny, even 1E-5 does ok with torus, no worse at Erf~ERADLIMIT instances. Also, does ~3 iterations...">IMPTRYCONV</a>);</div>
<div class="line"><a name="l04426"></a><span class="lineno"> 4426</span>&#160;              methodindex[<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a8f7ffa366fb45fd76a8a991ac9f4c43b">IMPMAXITERINDEX</a>] = trueimpmaxiterlist[tryphase1];</div>
<div class="line"><a name="l04427"></a><span class="lineno"> 4427</span>&#160;              methodindex[NUMDAMPINDEX] = truenumdampattemptslist[tryphase1];</div>
<div class="line"><a name="l04428"></a><span class="lineno"> 4428</span>&#160;              methodindex[<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a0f8cccff59db9d8325aa44b8cb389a44">MODPRIMINDEX</a>] = modprimlist[tryphase1];</div>
<div class="line"><a name="l04429"></a><span class="lineno"> 4429</span>&#160;              methodindex[<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a86a2418b187397a6fdf2cfd790a0ddeb">CHECKRADINVINDEX</a>] = checkradinvlist[tryphase1];</div>
<div class="line"><a name="l04430"></a><span class="lineno"> 4430</span>&#160;              methodindex[<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a4681062d53a43e7fcb647275649f05ef">EOMTYPEINDEX</a>] = eomtypelist[tryphase1];</div>
<div class="line"><a name="l04431"></a><span class="lineno"> 4431</span>&#160;</div>
<div class="line"><a name="l04432"></a><span class="lineno"> 4432</span>&#160;            }</div>
<div class="line"><a name="l04433"></a><span class="lineno"> 4433</span>&#160;          }</div>
<div class="line"><a name="l04434"></a><span class="lineno"> 4434</span>&#160;</div>
<div class="line"><a name="l04435"></a><span class="lineno"> 4435</span>&#160;          <span class="comment">// regardless, still cost more iters</span></div>
<div class="line"><a name="l04436"></a><span class="lineno"> 4436</span>&#160;          itersentropy+=itersentropyold;</div>
<div class="line"><a name="l04437"></a><span class="lineno"> 4437</span>&#160;</div>
<div class="line"><a name="l04438"></a><span class="lineno"> 4438</span>&#160;          <span class="keywordtype">int</span> noproblem=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a7207286a043c1f65037676ebf80412e5">ACTUALHARDORSOFTFAILURE</a>(failreturnentropy)==0;</div>
<div class="line"><a name="l04439"></a><span class="lineno"> 4439</span>&#160;</div>
<div class="line"><a name="l04440"></a><span class="lineno"> 4440</span>&#160;          <span class="keywordflow">if</span>(tryphase1!=firsttryphase1used &amp;&amp; noproblem){</div>
<div class="line"><a name="l04441"></a><span class="lineno"> 4441</span>&#160;            <span class="keywordflow">if</span>(debugfail&gt;=2) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;Recovered using tryphase1=%d (entropy: %d radinvmod=%d -&gt; %d): ijknstepsteppart=%d %d %d %ld %d : error: %21.15g-&gt;%21.15g (best=%21.15g) iters: %d-&gt;%d\n&quot;</span>,tryphase1,failreturnentropy,radinvmodentropyold,radinvmodentropy,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a1a1088d87617078680f1fd0f0d707384">nstep</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a70170b90229f9fc05eebf8508a685c70">steppart</a>,errorabsentropyold[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>],errorabsentropy[WHICHERROR],errorabsentropybest[WHICHERROR],itersentropyold,itersentropy);</div>
<div class="line"><a name="l04442"></a><span class="lineno"> 4442</span>&#160;          }</div>
<div class="line"><a name="l04443"></a><span class="lineno"> 4443</span>&#160;          <span class="keywordflow">if</span>(noproblem==0){</div>
<div class="line"><a name="l04444"></a><span class="lineno"> 4444</span>&#160;            <span class="keywordflow">if</span>(debugfail&gt;=2) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;Failed to: &lt;Recovered&gt; using tryphase1=%d (entropy: %d radinvmod=%d -&gt; %d): ijknstepsteppart=%d %d %d %ld %d : error: %21.15g-&gt;%21.15g (best=%21.15g) iters: %d-&gt;%d\n&quot;</span>,tryphase1,failreturnentropy,radinvmodentropyold,radinvmodentropy,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a1a1088d87617078680f1fd0f0d707384">nstep</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a70170b90229f9fc05eebf8508a685c70">steppart</a>,errorabsentropyold[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>],errorabsentropy[WHICHERROR],errorabsentropybest[WHICHERROR],itersentropyold,itersentropy);</div>
<div class="line"><a name="l04445"></a><span class="lineno"> 4445</span>&#160;          }</div>
<div class="line"><a name="l04446"></a><span class="lineno"> 4446</span>&#160;</div>
<div class="line"><a name="l04447"></a><span class="lineno"> 4447</span>&#160;        }<span class="comment">// done trying harder</span></div>
<div class="line"><a name="l04448"></a><span class="lineno"> 4448</span>&#160;      }<span class="comment">// end over tryphase1 loop</span></div>
<div class="line"><a name="l04449"></a><span class="lineno"> 4449</span>&#160;</div>
<div class="line"><a name="l04450"></a><span class="lineno"> 4450</span>&#160;</div>
<div class="line"><a name="l04451"></a><span class="lineno"> 4451</span>&#160;</div>
<div class="line"><a name="l04452"></a><span class="lineno"> 4452</span>&#160;</div>
<div class="line"><a name="l04453"></a><span class="lineno"> 4453</span>&#160;</div>
<div class="line"><a name="l04454"></a><span class="lineno"> 4454</span>&#160;      <span class="keywordflow">if</span>(</div>
<div class="line"><a name="l04455"></a><span class="lineno"> 4455</span>&#160;         !(modemethodlocal==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a4a773e56e52c24230ab87c41877f241e">MODEPICKBESTSIMPLE2</a>) <span class="comment">// Ramesh method is like stages, so avoid if simple2 method</span></div>
<div class="line"><a name="l04456"></a><span class="lineno"> 4456</span>&#160;         &amp;&amp; <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a7207286a043c1f65037676ebf80412e5">ACTUALHARDORSOFTFAILURE</a>(failreturnentropy) &amp;&amp; <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a4e881a6dce34b0b9f03a77b9d9c11c9c" title="whether to use ramesh solver as backup">USERAMESH</a> &amp;&amp; radextremeprimaryevolves==0</div>
<div class="line"><a name="l04457"></a><span class="lineno"> 4457</span>&#160;         &amp;&amp; !(errorabslist[whichfirstpmhd][0]&lt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afc9b116343212081b674a39ac69ce6ed" title="Funny, even 1E-5 does ok with torus, no worse at Erf~ERADLIMIT instances. Also, does ~3 iterations...">IMPTRYCONV</a> &amp;&amp; errorabslist[whichfirstpmhd][1]&gt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afc9b116343212081b674a39ac69ce6ed" title="Funny, even 1E-5 does ok with torus, no worse at Erf~ERADLIMIT instances. Also, does ~3 iterations...">IMPTRYCONV</a>)</div>
<div class="line"><a name="l04458"></a><span class="lineno"> 4458</span>&#160;         ){ <span class="comment">// try ramesh</span></div>
<div class="line"><a name="l04459"></a><span class="lineno"> 4459</span>&#160;        errorabsentropyold[0]=errorabsentropy[0];</div>
<div class="line"><a name="l04460"></a><span class="lineno"> 4460</span>&#160;        errorabsentropyold[1]=errorabsentropy[1];</div>
<div class="line"><a name="l04461"></a><span class="lineno"> 4461</span>&#160;        radinvmodentropyold=radinvmodentropy;</div>
<div class="line"><a name="l04462"></a><span class="lineno"> 4462</span>&#160;        itersentropyold=itersentropy;</div>
<div class="line"><a name="l04463"></a><span class="lineno"> 4463</span>&#160;        goexplicitentropy=0; <span class="comment">// doesn&#39;t check, so force implicit</span></div>
<div class="line"><a name="l04464"></a><span class="lineno"> 4464</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l04465"></a><span class="lineno"> 4465</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l04466"></a><span class="lineno"> 4466</span>&#160;        <span class="keywordflow">if</span>(gotrameshsolution){<span class="comment">// then just recall solution</span></div>
<div class="line"><a name="l04467"></a><span class="lineno"> 4467</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l04468"></a><span class="lineno"> 4468</span>&#160;            pbenergy[pl]=ppeng[pl];</div>
<div class="line"><a name="l04469"></a><span class="lineno"> 4469</span>&#160;            uubenergy[pl]=uueng[pl];</div>
<div class="line"><a name="l04470"></a><span class="lineno"> 4470</span>&#160;            <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a2da8b12fca78064531b9b64e5699e4fc" title="loop over ALL sources (including geometry)">SCLOOP</a>(sc) dUcompenergy[sc][pl]=dUcompeng[sc][pl];</div>
<div class="line"><a name="l04471"></a><span class="lineno"> 4471</span>&#160;          }</div>
<div class="line"><a name="l04472"></a><span class="lineno"> 4472</span>&#160;          qenergy=qeng;</div>
<div class="line"><a name="l04473"></a><span class="lineno"> 4473</span>&#160;          <span class="comment">//</span></div>
<div class="line"><a name="l04474"></a><span class="lineno"> 4474</span>&#160;          *lpflag=*lpflagrad=(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a>)failtypeeng; <span class="comment">// need better translation</span></div>
<div class="line"><a name="l04475"></a><span class="lineno"> 4475</span>&#160;          radinvmodenergy=radinvmodeng;</div>
<div class="line"><a name="l04476"></a><span class="lineno"> 4476</span>&#160;          radErfnegenergy=0; <span class="comment">// not allowed, considered BADNEG type</span></div>
<div class="line"><a name="l04477"></a><span class="lineno"> 4477</span>&#160;          itersenergy=iterseng;</div>
<div class="line"><a name="l04478"></a><span class="lineno"> 4478</span>&#160;          errorabsenergy[0]=errorabseng[0];</div>
<div class="line"><a name="l04479"></a><span class="lineno"> 4479</span>&#160;          errorabsenergy[1]=errorabseng[1];</div>
<div class="line"><a name="l04480"></a><span class="lineno"> 4480</span>&#160;          <span class="keywordflow">if</span>(failtypeeng || errorabsenergy[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>]&gt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8469a53eb25c0eb3b81286c364d0e7f3">IMPALLOWCONVCONSTABS</a>){ failreturnenergy=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab0abd953f677a44020dc50259c410486">FAILRETURNGENERAL</a>; eomtypeenergy=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a03d89f51ab60206791830c886d62bfd0">EOMGRMHD</a>; }</div>
<div class="line"><a name="l04481"></a><span class="lineno"> 4481</span>&#160;          <span class="keywordflow">else</span> <span class="keywordflow">if</span>(errorabsenergy[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>]&lt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a37aa5c4b7b1b481299d87bf929d13b15" title="error for comparing to sum over all absolute errors">IMPTRYCONVABS</a>){ failreturnenergy=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a3d6e4da5640133efaad94738c97e5171">FAILRETURNNOFAIL</a>; eomtypeenergy=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a04d93d33dd8dba356800fa12cb80064e">EOMDIDGRMHD</a>;}</div>
<div class="line"><a name="l04482"></a><span class="lineno"> 4482</span>&#160;          <span class="keywordflow">else</span>{ failreturnenergy=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a45adfa493bc8ab6857a43a11d9d649d1">FAILRETURNNOTTOLERROR</a>; eomtypeenergy=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a04d93d33dd8dba356800fa12cb80064e">EOMDIDGRMHD</a>;}</div>
<div class="line"><a name="l04483"></a><span class="lineno"> 4483</span>&#160;        }</div>
<div class="line"><a name="l04484"></a><span class="lineno"> 4484</span>&#160;        <span class="keywordflow">else</span>{ <span class="comment">// else get new ramesh solution</span></div>
<div class="line"><a name="l04485"></a><span class="lineno"> 4485</span>&#160;          <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> errorabsforramesh[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa63447acbbbc62cbedae23eac61c716e" title="determine which error will use when deciding if converged or not.">NUMERRORTYPES</a>];</div>
<div class="line"><a name="l04486"></a><span class="lineno"> 4486</span>&#160;          set_array(errorabsforramesh,NUMERRORTYPES,MPI_FTYPE,1.0);</div>
<div class="line"><a name="l04487"></a><span class="lineno"> 4487</span>&#160;          <span class="comment">// start fresh with ramesh</span></div>
<div class="line"><a name="l04488"></a><span class="lineno"> 4488</span>&#160;          <span class="keywordflow">if</span>(errorabsentropy[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>]&gt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a4a0ce3856fb32518938a274adb6c3946" title="error below which to feed best guess into next attempt">TRYHARDERFEEDGUESSTOL</a>){</div>
<div class="line"><a name="l04489"></a><span class="lineno"> 4489</span>&#160;            <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l04490"></a><span class="lineno"> 4490</span>&#160;              pbentropy[pl]=pbbackup[pl];</div>
<div class="line"><a name="l04491"></a><span class="lineno"> 4491</span>&#160;              uubentropy[pl]=uubbackup[pl];</div>
<div class="line"><a name="l04492"></a><span class="lineno"> 4492</span>&#160;              <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a2da8b12fca78064531b9b64e5699e4fc" title="loop over ALL sources (including geometry)">SCLOOP</a>(sc) dUcompent[sc][pl]=dUcompentropy[sc][pl]=dUcompbackup[sc][pl];</div>
<div class="line"><a name="l04493"></a><span class="lineno"> 4493</span>&#160;            }</div>
<div class="line"><a name="l04494"></a><span class="lineno"> 4494</span>&#160;            qentropy=qbackup;</div>
<div class="line"><a name="l04495"></a><span class="lineno"> 4495</span>&#160;            errorabsent[0]=errorabsent[1]=1.0;</div>
<div class="line"><a name="l04496"></a><span class="lineno"> 4496</span>&#160;            errorabsforramesh[0]=errorabsforramesh[1]=1.0;</div>
<div class="line"><a name="l04497"></a><span class="lineno"> 4497</span>&#160;            radinvmodent=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ad987489760e6592057a80faf09588c88" title="unfixable inversion problems">UTOPRIMRADFAILBAD1</a>;</div>
<div class="line"><a name="l04498"></a><span class="lineno"> 4498</span>&#160;          }</div>
<div class="line"><a name="l04499"></a><span class="lineno"> 4499</span>&#160;          <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l04500"></a><span class="lineno"> 4500</span>&#160;            <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l04501"></a><span class="lineno"> 4501</span>&#160;              pbentropy[pl]=pbentropybest[pl];</div>
<div class="line"><a name="l04502"></a><span class="lineno"> 4502</span>&#160;              <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a2da8b12fca78064531b9b64e5699e4fc" title="loop over ALL sources (including geometry)">SCLOOP</a>(sc) dUcompent[sc][pl]=dUcompentropy[sc][pl]=dUcompbackup[sc][pl]; <span class="comment">// always backup</span></div>
<div class="line"><a name="l04503"></a><span class="lineno"> 4503</span>&#160;            }</div>
<div class="line"><a name="l04504"></a><span class="lineno"> 4504</span>&#160;            qentropy=qentropybest;</div>
<div class="line"><a name="l04505"></a><span class="lineno"> 4505</span>&#160;            errorabsforramesh[0]=errorabsentropybest[0];</div>
<div class="line"><a name="l04506"></a><span class="lineno"> 4506</span>&#160;            errorabsforramesh[1]=errorabsentropybest[1];</div>
<div class="line"><a name="l04507"></a><span class="lineno"> 4507</span>&#160;            errorabsent[0]=errorabsentropybest[0];</div>
<div class="line"><a name="l04508"></a><span class="lineno"> 4508</span>&#160;            errorabsent[1]=errorabsentropybest[1];</div>
<div class="line"><a name="l04509"></a><span class="lineno"> 4509</span>&#160;            radinvmodent=radinvmodentropybest;</div>
<div class="line"><a name="l04510"></a><span class="lineno"> 4510</span>&#160;          }</div>
<div class="line"><a name="l04511"></a><span class="lineno"> 4511</span>&#160;          <span class="comment">//</span></div>
<div class="line"><a name="l04512"></a><span class="lineno"> 4512</span>&#160;          <span class="comment">// BEGIN GET RAMESH SOLUTION</span></div>
<div class="line"><a name="l04513"></a><span class="lineno"> 4513</span>&#160;          failreturnentropy=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab0abd953f677a44020dc50259c410486">FAILRETURNGENERAL</a>;<span class="comment">// default to fail</span></div>
<div class="line"><a name="l04514"></a><span class="lineno"> 4514</span>&#160;          eomtypeentropy=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a40b55e98bfcccde1a3f19d983ca7488c">EOMENTROPYGRMHD</a>;</div>
<div class="line"><a name="l04515"></a><span class="lineno"> 4515</span>&#160;          <span class="keywordtype">int</span> whichcall=eomtypeentropy; <span class="comment">// real entropy call</span></div>
<div class="line"><a name="l04516"></a><span class="lineno"> 4516</span>&#160;          get_rameshsolution_wrapper(whichcall, eomtypeentropy, errorabsforramesh, ptrgeom, pbentropy, piin, Uiin, Ufin, dUother, CUf, CUimp, q, ppeng, ppent, uueng, uuent, dUcompeng, dUcompent, &amp;qeng, &amp;qent, &amp;failtypeeng, errorabseng, &amp;iterseng, &amp;radinvmodeng, &amp;failtypeent, errorabsent, &amp;itersent, &amp;radinvmodent);</div>
<div class="line"><a name="l04517"></a><span class="lineno"> 4517</span>&#160;          gotrameshsolution=1; <span class="comment">// indicates did at least attempt ramesh solution call</span></div>
<div class="line"><a name="l04518"></a><span class="lineno"> 4518</span>&#160;          <span class="comment">// translate</span></div>
<div class="line"><a name="l04519"></a><span class="lineno"> 4519</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l04520"></a><span class="lineno"> 4520</span>&#160;            pbentropy[pl]=ppent[pl];</div>
<div class="line"><a name="l04521"></a><span class="lineno"> 4521</span>&#160;            uubentropy[pl]=uuent[pl];</div>
<div class="line"><a name="l04522"></a><span class="lineno"> 4522</span>&#160;            <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a2da8b12fca78064531b9b64e5699e4fc" title="loop over ALL sources (including geometry)">SCLOOP</a>(sc) dUcompentropy[sc][pl]=dUcompent[sc][pl];</div>
<div class="line"><a name="l04523"></a><span class="lineno"> 4523</span>&#160;          }</div>
<div class="line"><a name="l04524"></a><span class="lineno"> 4524</span>&#160;          qentropy=qent;</div>
<div class="line"><a name="l04525"></a><span class="lineno"> 4525</span>&#160;          <span class="comment">//</span></div>
<div class="line"><a name="l04526"></a><span class="lineno"> 4526</span>&#160;          *lpflag=*lpflagrad=(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a>)failtypeent; <span class="comment">// need better translation</span></div>
<div class="line"><a name="l04527"></a><span class="lineno"> 4527</span>&#160;          radinvmodentropy=radinvmodent;</div>
<div class="line"><a name="l04528"></a><span class="lineno"> 4528</span>&#160;          radErfnegentropy=0; <span class="comment">// not allowed, considered BADNEG type</span></div>
<div class="line"><a name="l04529"></a><span class="lineno"> 4529</span>&#160;          itersentropy=itersent;</div>
<div class="line"><a name="l04530"></a><span class="lineno"> 4530</span>&#160;          errorabsentropy[0]=errorabsent[0];</div>
<div class="line"><a name="l04531"></a><span class="lineno"> 4531</span>&#160;          errorabsentropy[1]=errorabsent[1];</div>
<div class="line"><a name="l04532"></a><span class="lineno"> 4532</span>&#160;          <span class="keywordflow">if</span>(failtypeent || errorabsentropy[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>]&gt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8469a53eb25c0eb3b81286c364d0e7f3">IMPALLOWCONVCONSTABS</a>){ failreturnentropy=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab0abd953f677a44020dc50259c410486">FAILRETURNGENERAL</a>; eomtypeentropy=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a40b55e98bfcccde1a3f19d983ca7488c">EOMENTROPYGRMHD</a>; }</div>
<div class="line"><a name="l04533"></a><span class="lineno"> 4533</span>&#160;          <span class="keywordflow">else</span> <span class="keywordflow">if</span>(errorabsentropy[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>]&lt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a37aa5c4b7b1b481299d87bf929d13b15" title="error for comparing to sum over all absolute errors">IMPTRYCONVABS</a>){ failreturnentropy=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a3d6e4da5640133efaad94738c97e5171">FAILRETURNNOFAIL</a>; eomtypeentropy=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a74427604dbc716cea325f65f5c927662">EOMDIDENTROPYGRMHD</a>;}</div>
<div class="line"><a name="l04534"></a><span class="lineno"> 4534</span>&#160;          <span class="keywordflow">else</span>{ failreturnentropy=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a45adfa493bc8ab6857a43a11d9d649d1">FAILRETURNNOTTOLERROR</a>; eomtypeentropy=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a74427604dbc716cea325f65f5c927662">EOMDIDENTROPYGRMHD</a>;}</div>
<div class="line"><a name="l04535"></a><span class="lineno"> 4535</span>&#160;          <span class="comment">// END GET RAMESH SOLUTION</span></div>
<div class="line"><a name="l04536"></a><span class="lineno"> 4536</span>&#160;          <span class="comment">//</span></div>
<div class="line"><a name="l04537"></a><span class="lineno"> 4537</span>&#160;        }<span class="comment">// end else if need to get ramesh solution</span></div>
<div class="line"><a name="l04538"></a><span class="lineno"> 4538</span>&#160;        <span class="comment">// see if want to keep</span></div>
<div class="line"><a name="l04539"></a><span class="lineno"> 4539</span>&#160;        <span class="comment">//        if((errorabsentropy[WHICHERROR]&lt;errorabsentropybest[WHICHERROR] &amp;&amp; (RADINVBAD(radinvmodentropy)==0 || RADINVBAD(radinvmodentropybest) &amp;&amp; RADINVBAD(radinvmodentropy)) || RADINVBAD(radinvmodentropybest) &amp;&amp; RADINVBAD(radinvmodentropy)==0 &amp;&amp; (errorabsentropy[WHICHERROR]&lt;errorabsentropybest[WHICHERROR]||errorabsentropy[WHICHERROR]&lt;IMPOKCONVABS) || RADINVBAD(radinvmodentropybest)==0 &amp;&amp; RADINVBAD(radinvmodentropy) &amp;&amp; (errorabsentropybest[WHICHERROR]&gt;IMPOKCONVABS &amp;&amp; errorabsentropy[WHICHERROR]&lt;IMPOKCONVABS)) &amp;&amp; ACTUALHARDFAILURE(failreturnentropy)==0){</span></div>
<div class="line"><a name="l04540"></a><span class="lineno"> 4540</span>&#160;        <span class="keywordflow">if</span>(</div>
<div class="line"><a name="l04541"></a><span class="lineno"> 4541</span>&#160;           (</div>
<div class="line"><a name="l04542"></a><span class="lineno"> 4542</span>&#160;            <span class="comment">// best and no radinv problem</span></div>
<div class="line"><a name="l04543"></a><span class="lineno"> 4543</span>&#160;            errorabsentropy[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>]&lt;errorabsentropybest[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>] &amp;&amp; <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0685d01c4383c1608a7ea72cb7ce3791">RADINVBAD</a>(radinvmodentropy)==0</div>
<div class="line"><a name="l04544"></a><span class="lineno"> 4544</span>&#160;            <span class="comment">// best because prior best also had radinv problem and still smaller error</span></div>
<div class="line"><a name="l04545"></a><span class="lineno"> 4545</span>&#160;            || errorabsentropy[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>]&lt;errorabsentropybest[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>] &amp;&amp; (<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0685d01c4383c1608a7ea72cb7ce3791">RADINVBAD</a>(radinvmodentropy) &amp;&amp; <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0685d01c4383c1608a7ea72cb7ce3791">RADINVBAD</a>(radinvmodentropybest))</div>
<div class="line"><a name="l04546"></a><span class="lineno"> 4546</span>&#160;            <span class="comment">// best because even though has radinv problem (while best doesn&#39;t) much smaller error</span></div>
<div class="line"><a name="l04547"></a><span class="lineno"> 4547</span>&#160;            || errorabsentropy[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>]&lt;errorabsentropybest[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>] &amp;&amp; errorabsentropy[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>]&lt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a0beb933bdd5a874f9fcada46b302fbff">IMPOKCONVABS</a> &amp;&amp; errorabsentropybest[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>]&gt;100.0*<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a0beb933bdd5a874f9fcada46b302fbff">IMPOKCONVABS</a> &amp;&amp; (<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0685d01c4383c1608a7ea72cb7ce3791">RADINVBAD</a>(radinvmodentropy) &amp;&amp; <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0685d01c4383c1608a7ea72cb7ce3791">RADINVBAD</a>(radinvmodentropybest)==0)</div>
<div class="line"><a name="l04548"></a><span class="lineno"> 4548</span>&#160;            )</div>
<div class="line"><a name="l04549"></a><span class="lineno"> 4549</span>&#160;           &amp;&amp; <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a98e2c94d4fc861c61bc8dde7b4eec734">ACTUALHARDFAILURE</a>(failreturnentropy)==0){</div>
<div class="line"><a name="l04550"></a><span class="lineno"> 4550</span>&#160;</div>
<div class="line"><a name="l04551"></a><span class="lineno"> 4551</span>&#160;          <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a6ce9f5de6e575be785e5f053882a0909">ACCEPTASNOFAILURE</a>(failreturnentropy)) usedrameshentropy=1; <span class="comment">// means will use this actually, not just best yet no good enough</span></div>
<div class="line"><a name="l04552"></a><span class="lineno"> 4552</span>&#160;          <span class="comment">// store result in case better than latter results</span></div>
<div class="line"><a name="l04553"></a><span class="lineno"> 4553</span>&#160;          lpflagentropybest=*lpflag;</div>
<div class="line"><a name="l04554"></a><span class="lineno"> 4554</span>&#160;          lpflagradentropybest=*lpflagrad;</div>
<div class="line"><a name="l04555"></a><span class="lineno"> 4555</span>&#160;          radinvmodentropybest=radinvmodentropy;</div>
<div class="line"><a name="l04556"></a><span class="lineno"> 4556</span>&#160;          radErfnegentropybest=radErfnegentropy;</div>
<div class="line"><a name="l04557"></a><span class="lineno"> 4557</span>&#160;          failreturnentropybest=failreturnentropy;</div>
<div class="line"><a name="l04558"></a><span class="lineno"> 4558</span>&#160;          eomtypeentropybest=eomtypeentropy;</div>
<div class="line"><a name="l04559"></a><span class="lineno"> 4559</span>&#160;          errorabsentropybest[0]=errorabsentropy[0];</div>
<div class="line"><a name="l04560"></a><span class="lineno"> 4560</span>&#160;          errorabsentropybest[1]=errorabsentropy[1];</div>
<div class="line"><a name="l04561"></a><span class="lineno"> 4561</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l04562"></a><span class="lineno"> 4562</span>&#160;            pbentropybest[pl]=pbentropy[pl];</div>
<div class="line"><a name="l04563"></a><span class="lineno"> 4563</span>&#160;            uubentropybest[pl]=uubentropy[pl];</div>
<div class="line"><a name="l04564"></a><span class="lineno"> 4564</span>&#160;            <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a2da8b12fca78064531b9b64e5699e4fc" title="loop over ALL sources (including geometry)">SCLOOP</a>(sc) dUcompentropybest[sc][pl]=dUcompentropy[sc][pl];</div>
<div class="line"><a name="l04565"></a><span class="lineno"> 4565</span>&#160;          }</div>
<div class="line"><a name="l04566"></a><span class="lineno"> 4566</span>&#160;          qentropybest=qentropy;</div>
<div class="line"><a name="l04567"></a><span class="lineno"> 4567</span>&#160;</div>
<div class="line"><a name="l04568"></a><span class="lineno"> 4568</span>&#160;          <span class="comment">// save which method ended up using</span></div>
<div class="line"><a name="l04569"></a><span class="lineno"> 4569</span>&#160;          methodindex[<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a19f0668a5075a4ca1061348f26a4fc13">BASEITERMETHODINDEX</a>] = <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9cf5ca7f5e5aa1e0bdef53abe3f27c1c">QTYPMHD</a>;</div>
<div class="line"><a name="l04570"></a><span class="lineno"> 4570</span>&#160;          methodindex[<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a698402bc5dc720863bbf11c90786520d">ITERMODEINDEX</a>] = <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a480c56e263c4874ccb40f3bbc1b32032">ITERMODESTAGES</a>;</div>
<div class="line"><a name="l04571"></a><span class="lineno"> 4571</span>&#160;          methodindex[<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a8f7ffa366fb45fd76a8a991ac9f4c43b">IMPMAXITERINDEX</a>] = <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a58cca3253f4dfcefde5fe864699e297a">IMPMAXITERLONG</a>;</div>
<div class="line"><a name="l04572"></a><span class="lineno"> 4572</span>&#160;          methodindex[NUMDAMPINDEX] = <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a91061094ecbe11ec91b0999d1f243f20">NUMDAMPATTEMPTSQUICK</a>;</div>
<div class="line"><a name="l04573"></a><span class="lineno"> 4573</span>&#160;          methodindex[<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a0f8cccff59db9d8325aa44b8cb389a44">MODPRIMINDEX</a>] = 0;</div>
<div class="line"><a name="l04574"></a><span class="lineno"> 4574</span>&#160;          methodindex[<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a86a2418b187397a6fdf2cfd790a0ddeb">CHECKRADINVINDEX</a>] = 1;</div>
<div class="line"><a name="l04575"></a><span class="lineno"> 4575</span>&#160;          methodindex[<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a4681062d53a43e7fcb647275649f05ef">EOMTYPEINDEX</a>] = <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a40b55e98bfcccde1a3f19d983ca7488c">EOMENTROPYGRMHD</a>;</div>
<div class="line"><a name="l04576"></a><span class="lineno"> 4576</span>&#160;</div>
<div class="line"><a name="l04577"></a><span class="lineno"> 4577</span>&#160;        }</div>
<div class="line"><a name="l04578"></a><span class="lineno"> 4578</span>&#160;        <span class="comment">// still cost more iters</span></div>
<div class="line"><a name="l04579"></a><span class="lineno"> 4579</span>&#160;        itersentropy+=itersentropyold;</div>
<div class="line"><a name="l04580"></a><span class="lineno"> 4580</span>&#160;        <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a7207286a043c1f65037676ebf80412e5">ACTUALHARDORSOFTFAILURE</a>(failreturnentropy)==0){</div>
<div class="line"><a name="l04581"></a><span class="lineno"> 4581</span>&#160;          <span class="keywordflow">if</span>(debugfail&gt;=2) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;Recovered using ramesh(%d) (entropy: radinvmod=%d -&gt; %d): ijknstepsteppart=%d %d %d %ld %d : error: %21.15g-&gt;%21.15g iters: %d-&gt;%d\n&quot;</span>,failtypeent,radinvmodentropyold,radinvmodentropy,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a1a1088d87617078680f1fd0f0d707384">nstep</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a70170b90229f9fc05eebf8508a685c70">steppart</a>,errorabsentropyold[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>],errorabsentropy[WHICHERROR],itersentropyold,itersentropy);</div>
<div class="line"><a name="l04582"></a><span class="lineno"> 4582</span>&#160;        }</div>
<div class="line"><a name="l04583"></a><span class="lineno"> 4583</span>&#160;        <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l04584"></a><span class="lineno"> 4584</span>&#160;          <span class="keywordflow">if</span>(debugfail&gt;=2) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;Failed to: Recovered using ramesh(%d) (entropy: radinvmod=%d -&gt; %d): ijknstepsteppart=%d %d %d %ld %d : error: %21.15g-&gt;%21.15g iters: %d-&gt;%d\n&quot;</span>,failtypeent,radinvmodentropyold,radinvmodentropy,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a1a1088d87617078680f1fd0f0d707384">nstep</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a70170b90229f9fc05eebf8508a685c70">steppart</a>,errorabsentropyold[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>],errorabsentropy[WHICHERROR],itersentropyold,itersentropy);</div>
<div class="line"><a name="l04585"></a><span class="lineno"> 4585</span>&#160;        }</div>
<div class="line"><a name="l04586"></a><span class="lineno"> 4586</span>&#160;      }</div>
<div class="line"><a name="l04587"></a><span class="lineno"> 4587</span>&#160;</div>
<div class="line"><a name="l04588"></a><span class="lineno"> 4588</span>&#160;</div>
<div class="line"><a name="l04589"></a><span class="lineno"> 4589</span>&#160;</div>
<div class="line"><a name="l04590"></a><span class="lineno"> 4590</span>&#160;</div>
<div class="line"><a name="l04591"></a><span class="lineno"> 4591</span>&#160;</div>
<div class="line"><a name="l04593"></a><span class="lineno"> 4593</span>&#160;      <span class="comment">//</span></div>
<div class="line"><a name="l04594"></a><span class="lineno"> 4594</span>&#160;      <span class="comment">// use best result</span></div>
<div class="line"><a name="l04595"></a><span class="lineno"> 4595</span>&#160;      <span class="comment">//</span></div>
<div class="line"><a name="l04597"></a><span class="lineno"> 4597</span>&#160;<span class="comment"></span>      *lpflag=lpflagentropybest;</div>
<div class="line"><a name="l04598"></a><span class="lineno"> 4598</span>&#160;      *lpflagrad=lpflagradentropybest;</div>
<div class="line"><a name="l04599"></a><span class="lineno"> 4599</span>&#160;      radinvmodentropy=radinvmodentropybest;</div>
<div class="line"><a name="l04600"></a><span class="lineno"> 4600</span>&#160;      radErfnegentropy=radErfnegentropybest;</div>
<div class="line"><a name="l04601"></a><span class="lineno"> 4601</span>&#160;      failreturnentropy=failreturnentropybest;</div>
<div class="line"><a name="l04602"></a><span class="lineno"> 4602</span>&#160;      eomtypeentropy=eomtypeentropybest;</div>
<div class="line"><a name="l04603"></a><span class="lineno"> 4603</span>&#160;      errorabsentropy[0]=errorabsentropybest[0];</div>
<div class="line"><a name="l04604"></a><span class="lineno"> 4604</span>&#160;      errorabsentropy[1]=errorabsentropybest[1];</div>
<div class="line"><a name="l04605"></a><span class="lineno"> 4605</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l04606"></a><span class="lineno"> 4606</span>&#160;        pbentropy[pl]=pbentropybest[pl];</div>
<div class="line"><a name="l04607"></a><span class="lineno"> 4607</span>&#160;        uubentropy[pl]=uubentropybest[pl];</div>
<div class="line"><a name="l04608"></a><span class="lineno"> 4608</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a2da8b12fca78064531b9b64e5699e4fc" title="loop over ALL sources (including geometry)">SCLOOP</a>(sc) dUcompentropy[sc][pl]=dUcompentropybest[sc][pl];</div>
<div class="line"><a name="l04609"></a><span class="lineno"> 4609</span>&#160;      }</div>
<div class="line"><a name="l04610"></a><span class="lineno"> 4610</span>&#160;      qentropy=qentropybest;</div>
<div class="line"><a name="l04611"></a><span class="lineno"> 4611</span>&#160;      goexplicitentropy=goexplicitentropybest;</div>
<div class="line"><a name="l04612"></a><span class="lineno"> 4612</span>&#160;</div>
<div class="line"><a name="l04613"></a><span class="lineno"> 4613</span>&#160;</div>
<div class="line"><a name="l04614"></a><span class="lineno"> 4614</span>&#160;      <span class="comment">// store these in case entropy ultimately used (if goexplicit, then these are set by last call to _mode() function)</span></div>
<div class="line"><a name="l04615"></a><span class="lineno"> 4615</span>&#160;      lpflagentropy=*lpflag;</div>
<div class="line"><a name="l04616"></a><span class="lineno"> 4616</span>&#160;      lpflagradentropy=*lpflagrad;</div>
<div class="line"><a name="l04617"></a><span class="lineno"> 4617</span>&#160;</div>
<div class="line"><a name="l04618"></a><span class="lineno"> 4618</span>&#160;</div>
<div class="line"><a name="l04619"></a><span class="lineno"> 4619</span>&#160;      <span class="comment">// eomtypeentropy can become EOMDONOTHING if this call was successful</span></div>
<div class="line"><a name="l04620"></a><span class="lineno"> 4620</span>&#160;    }</div>
<div class="line"><a name="l04621"></a><span class="lineno"> 4621</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l04622"></a><span class="lineno"> 4622</span>&#160;      failreturnentropy=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab0abd953f677a44020dc50259c410486">FAILRETURNGENERAL</a>;<span class="comment">// fail if wasn&#39;t done</span></div>
<div class="line"><a name="l04623"></a><span class="lineno"> 4623</span>&#160;    }</div>
<div class="line"><a name="l04624"></a><span class="lineno"> 4624</span>&#160;</div>
<div class="line"><a name="l04625"></a><span class="lineno"> 4625</span>&#160;</div>
<div class="line"><a name="l04626"></a><span class="lineno"> 4626</span>&#160;</div>
<div class="line"><a name="l04627"></a><span class="lineno"> 4627</span>&#160;  </div>
<div class="line"><a name="l04628"></a><span class="lineno"> 4628</span>&#160;</div>
<div class="line"><a name="l04629"></a><span class="lineno"> 4629</span>&#160;</div>
<div class="line"><a name="l04630"></a><span class="lineno"> 4630</span>&#160;</div>
<div class="line"><a name="l04631"></a><span class="lineno"> 4631</span>&#160;</div>
<div class="line"><a name="l04632"></a><span class="lineno"> 4632</span>&#160;</div>
<div class="line"><a name="l04633"></a><span class="lineno"> 4633</span>&#160;</div>
<div class="line"><a name="l04634"></a><span class="lineno"> 4634</span>&#160;</div>
<div class="line"><a name="l04636"></a><span class="lineno"> 4636</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l04637"></a><span class="lineno"> 4637</span>&#160;    <span class="comment">// See if want to try getting &quot;cold&quot; solution where only momentum exchange is considered</span></div>
<div class="line"><a name="l04638"></a><span class="lineno"> 4638</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l04640"></a><span class="lineno"> 4640</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04641"></a><span class="lineno"> 4641</span>&#160;</div>
<div class="line"><a name="l04643"></a><span class="lineno"> 4643</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l04644"></a><span class="lineno"> 4644</span>&#160;    <span class="comment">// COLD VARIABLES</span></div>
<div class="line"><a name="l04645"></a><span class="lineno"> 4645</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l04647"></a><span class="lineno"> 4647</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04648"></a><span class="lineno"> 4648</span>&#160;    <span class="comment">// holds iterations</span></div>
<div class="line"><a name="l04649"></a><span class="lineno"> 4649</span>&#160;    <span class="keywordtype">int</span> iterscold=0;</div>
<div class="line"><a name="l04650"></a><span class="lineno"> 4650</span>&#160;    <span class="keywordtype">int</span> f1iterscold=0;</div>
<div class="line"><a name="l04651"></a><span class="lineno"> 4651</span>&#160;    <span class="keywordtype">int</span> nummhdinvscold=0;</div>
<div class="line"><a name="l04652"></a><span class="lineno"> 4652</span>&#160;    <span class="keywordtype">int</span> nummhdstepscold=0;</div>
<div class="line"><a name="l04653"></a><span class="lineno"> 4653</span>&#160;</div>
<div class="line"><a name="l04654"></a><span class="lineno"> 4654</span>&#160;    <span class="comment">// implicit cold solution held in these variables</span></div>
<div class="line"><a name="l04655"></a><span class="lineno"> 4655</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> pbcold[NPR]; <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) pbcold[pl]=pbbackup[pl];</div>
<div class="line"><a name="l04656"></a><span class="lineno"> 4656</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> uubcold[NPR];  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) uubcold[pl]=uubbackup[pl]; <span class="comment">// holds returned uu from implicit solver</span></div>
<div class="line"><a name="l04657"></a><span class="lineno"> 4657</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dUcompcold[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ac34589654a83c911addd1fda0898e738">NUMSOURCES</a>][NPR]; <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a2da8b12fca78064531b9b64e5699e4fc" title="loop over ALL sources (including geometry)">SCLOOP</a>(sc) dUcompcold[sc][pl]=dUcompbackup[sc][pl];</div>
<div class="line"><a name="l04658"></a><span class="lineno"> 4658</span>&#160;    <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> qcold=qbackup;</div>
<div class="line"><a name="l04659"></a><span class="lineno"> 4659</span>&#160;    <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> lpflagcold=1;</div>
<div class="line"><a name="l04660"></a><span class="lineno"> 4660</span>&#160;    <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> lpflagradcold=1;</div>
<div class="line"><a name="l04661"></a><span class="lineno"> 4661</span>&#160;    <span class="keywordtype">int</span> radinvmodcold=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ad987489760e6592057a80faf09588c88" title="unfixable inversion problems">UTOPRIMRADFAILBAD1</a>;</div>
<div class="line"><a name="l04662"></a><span class="lineno"> 4662</span>&#160;    <span class="keywordtype">int</span> radErfnegcold=1;</div>
<div class="line"><a name="l04663"></a><span class="lineno"> 4663</span>&#160;    <span class="keywordtype">int</span> failreturncold=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab0abd953f677a44020dc50259c410486">FAILRETURNGENERAL</a>; <span class="comment">// default to fail in case cold not to be done at all</span></div>
<div class="line"><a name="l04664"></a><span class="lineno"> 4664</span>&#160;    <span class="keywordtype">int</span> eomtypecold=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a757ad8b9c2c7611dad8aab853a87f61b">EOMCOLDGRMHD</a>;</div>
<div class="line"><a name="l04665"></a><span class="lineno"> 4665</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> errorabscold[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa63447acbbbc62cbedae23eac61c716e" title="determine which error will use when deciding if converged or not.">NUMERRORTYPES</a>];</div>
<div class="line"><a name="l04666"></a><span class="lineno"> 4666</span>&#160;    set_array(errorabscold,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa63447acbbbc62cbedae23eac61c716e" title="determine which error will use when deciding if converged or not.">NUMERRORTYPES</a>,MPI_FTYPE,1.0);</div>
<div class="line"><a name="l04667"></a><span class="lineno"> 4667</span>&#160;    <span class="keywordtype">int</span> goexplicitcold=0;</div>
<div class="line"><a name="l04668"></a><span class="lineno"> 4668</span>&#160;</div>
<div class="line"><a name="l04669"></a><span class="lineno"> 4669</span>&#160;</div>
<div class="line"><a name="l04670"></a><span class="lineno"> 4670</span>&#160;    <span class="comment">// try cold if energy and entropy both failed or the successfully converged versions gave u_g&lt;=0.0</span></div>
<div class="line"><a name="l04671"></a><span class="lineno"> 4671</span>&#160;    <span class="keywordflow">if</span>( reducetoquick!=1 &amp;&amp; (</div>
<div class="line"><a name="l04672"></a><span class="lineno"> 4672</span>&#160;       (pbenergy[UU]&lt;=0.0 &amp;&amp; <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a6ce9f5de6e575be785e5f053882a0909">ACCEPTASNOFAILURE</a>(failreturnenergy)==1 || <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a6ce9f5de6e575be785e5f053882a0909">ACCEPTASNOFAILURE</a>(failreturnenergy)==0)</div>
<div class="line"><a name="l04673"></a><span class="lineno"> 4673</span>&#160;       &amp;&amp;</div>
<div class="line"><a name="l04674"></a><span class="lineno"> 4674</span>&#160;       (pbentropy[UU]&lt;=0.0 &amp;&amp; <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a6ce9f5de6e575be785e5f053882a0909">ACCEPTASNOFAILURE</a>(failreturnentropy)==1 || <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a6ce9f5de6e575be785e5f053882a0909">ACCEPTASNOFAILURE</a>(failreturnentropy)==0)</div>
<div class="line"><a name="l04675"></a><span class="lineno"> 4675</span>&#160;                             )</div>
<div class="line"><a name="l04676"></a><span class="lineno"> 4676</span>&#160;        ){</div>
<div class="line"><a name="l04677"></a><span class="lineno"> 4677</span>&#160;</div>
<div class="line"><a name="l04679"></a><span class="lineno"> 4679</span>&#160;      <span class="comment">//</span></div>
<div class="line"><a name="l04680"></a><span class="lineno"> 4680</span>&#160;      <span class="comment">// measure whether flow really cold enough to even use cold inversion</span></div>
<div class="line"><a name="l04681"></a><span class="lineno"> 4681</span>&#160;      <span class="comment">//</span></div>
<div class="line"><a name="l04683"></a><span class="lineno"> 4683</span>&#160;<span class="comment"></span>      <span class="keywordtype">int</span> includerad=1;</div>
<div class="line"><a name="l04684"></a><span class="lineno"> 4684</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> COLDFACTOR=0.1; <span class="comment">// really ensure cold to use cold solution</span></div>
<div class="line"><a name="l04685"></a><span class="lineno"> 4685</span>&#160;      <span class="keywordtype">int</span> iscoldflow=<a class="code" href="../../d1/d3e/utoprimgen_8c.html#a7d31362f91cd4ec3b92e15dd6bcb3908" title="includerad=1: account for fact that not only assume MHD flow is cold itself, but energy-force balance...">isflowcold</a>(COLDFACTOR, includerad,pb,ptrgeom,q,uu0);</div>
<div class="line"><a name="l04686"></a><span class="lineno"> 4686</span>&#160;      <span class="comment">//      iscoldflow=1; // test</span></div>
<div class="line"><a name="l04687"></a><span class="lineno"> 4687</span>&#160;</div>
<div class="line"><a name="l04688"></a><span class="lineno"> 4688</span>&#160;      <span class="comment">//      dualfprintf(fail_file,&quot;iscoldflow: %d : ug=%21.15g Erf=%21.15g rhovsq=%21.15g : Esqgas=%21.15g usqgas=%21.15g Esqrad=%21.15g usqrad=%21.15g\n&quot;,iscoldflow,pb[UU],pb[URAD0],pb[RHO]*fabs(usq),fabs(ucongas[TT]*ucovgas[TT]),fabs(ugas),fabs(uconrad[TT]*ucovrad[TT]),fabs(urad)); // DEBUG</span></div>
<div class="line"><a name="l04689"></a><span class="lineno"> 4689</span>&#160;</div>
<div class="line"><a name="l04690"></a><span class="lineno"> 4690</span>&#160;</div>
<div class="line"><a name="l04691"></a><span class="lineno"> 4691</span>&#160;      <span class="comment">// if flow is cold, do inversion</span></div>
<div class="line"><a name="l04692"></a><span class="lineno"> 4692</span>&#160;      <span class="keywordflow">if</span>(iscoldflow==1){</div>
<div class="line"><a name="l04693"></a><span class="lineno"> 4693</span>&#160;</div>
<div class="line"><a name="l04694"></a><span class="lineno"> 4694</span>&#160;        <span class="comment">// count attempt to use cold</span></div>
<div class="line"><a name="l04695"></a><span class="lineno"> 4695</span>&#160;        tryphaselistcold[0]++;</div>
<div class="line"><a name="l04696"></a><span class="lineno"> 4696</span>&#160;</div>
<div class="line"><a name="l04697"></a><span class="lineno"> 4697</span>&#160;        failreturncold=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab0abd953f677a44020dc50259c410486">FAILRETURNGENERAL</a>; <span class="comment">// if doing cold, default is fail.</span></div>
<div class="line"><a name="l04698"></a><span class="lineno"> 4698</span>&#160;        <span class="keywordtype">int</span> whichcapcold=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a4b6c6060c025e15f1d92aae3dcb9365b" title="which cap type to place in rad inversion">CAPTYPEBASIC</a>;</div>
<div class="line"><a name="l04699"></a><span class="lineno"> 4699</span>&#160;        <span class="keywordtype">int</span> itermodecold=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a18693ca111670c1ff38ab2206f70c81e">ITERMODECOLD</a>;</div>
<div class="line"><a name="l04700"></a><span class="lineno"> 4700</span>&#160;        <span class="keywordtype">int</span> baseitermethodcold=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9cf5ca7f5e5aa1e0bdef53abe3f27c1c">QTYPMHD</a>;</div>
<div class="line"><a name="l04701"></a><span class="lineno"> 4701</span>&#160;<span class="preprocessor">#if(DOPERF&amp;&amp;0) // superquick too little</span></div>
<div class="line"><a name="l04702"></a><span class="lineno"> 4702</span>&#160;<span class="preprocessor"></span>        <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> trueimptryconvcold=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ac5e04595551dd07bf6f57b21d5911e81">IMPTRYCONVSUPERQUICK</a>;</div>
<div class="line"><a name="l04703"></a><span class="lineno"> 4703</span>&#160;        <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> trueimpokconvcold=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab1ad1aee2202922457a377be53918cdc" title="what tolerance to use for saying can switch to entropy when u_g is suggested to be bad for energy...">IMPALLOWCONVCONST</a>;</div>
<div class="line"><a name="l04704"></a><span class="lineno"> 4704</span>&#160;        <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> trueimpallowconvcold=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab1ad1aee2202922457a377be53918cdc" title="what tolerance to use for saying can switch to entropy when u_g is suggested to be bad for energy...">IMPALLOWCONVCONST</a>;</div>
<div class="line"><a name="l04705"></a><span class="lineno"> 4705</span>&#160;        <span class="keywordtype">int</span> trueimpmaxitercold=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a2d8c9708802cf755a4a134bbc40f7fea">IMPMAXITERSUPERQUICK</a>+1;</div>
<div class="line"><a name="l04706"></a><span class="lineno"> 4706</span>&#160;        <span class="keywordtype">int</span> truenumdampattemptscold=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a91061094ecbe11ec91b0999d1f243f20">NUMDAMPATTEMPTSQUICK</a>;</div>
<div class="line"><a name="l04707"></a><span class="lineno"> 4707</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l04708"></a><span class="lineno"> 4708</span>&#160;<span class="preprocessor"></span>        <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> trueimptryconvcold=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a1ed8230cb4aee8a0c35a93613b5abcdd">IMPTRYCONVQUICK</a>;</div>
<div class="line"><a name="l04709"></a><span class="lineno"> 4709</span>&#160;        <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> trueimpokconvcold=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab1ad1aee2202922457a377be53918cdc" title="what tolerance to use for saying can switch to entropy when u_g is suggested to be bad for energy...">IMPALLOWCONVCONST</a>;</div>
<div class="line"><a name="l04710"></a><span class="lineno"> 4710</span>&#160;        <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> trueimpallowconvcold=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab1ad1aee2202922457a377be53918cdc" title="what tolerance to use for saying can switch to entropy when u_g is suggested to be bad for energy...">IMPALLOWCONVCONST</a>;</div>
<div class="line"><a name="l04711"></a><span class="lineno"> 4711</span>&#160;        <span class="keywordtype">int</span> trueimpmaxitercold=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a03eeb7614c6d7be8ab6fb4e6d2036ee3">IMPMAXITERQUICK</a>;</div>
<div class="line"><a name="l04712"></a><span class="lineno"> 4712</span>&#160;        <span class="keywordtype">int</span> truenumdampattemptscold=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a91061094ecbe11ec91b0999d1f243f20">NUMDAMPATTEMPTSQUICK</a>;</div>
<div class="line"><a name="l04713"></a><span class="lineno"> 4713</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l04714"></a><span class="lineno"> 4714</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l04715"></a><span class="lineno"> 4715</span>&#160;        <span class="keywordflow">if</span>(funnelcond){ <span class="comment">// then don&#39;t expect to treat density accurate anyways, just need ok accuracy and stability</span></div>
<div class="line"><a name="l04716"></a><span class="lineno"> 4716</span>&#160;          trueimptryconvcold=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(trueimptryconvcold,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a2970b7302296037943041f82a6cb59fc">IMPTRYCONVMARGINAL</a>);</div>
<div class="line"><a name="l04717"></a><span class="lineno"> 4717</span>&#160;          <span class="keywordflow">if</span>(V[1]&lt;<a class="code" href="../../d8/d5b/defs_8general_8h.html#a20e81ef2343c6d8db701c6613cbcd279">Rhor</a> &amp;&amp; isbhspc){</div>
<div class="line"><a name="l04718"></a><span class="lineno"> 4718</span>&#160;            <span class="comment">//          trueimptryconvlist[tryphase1]=MAX(trueimptryconvlist[tryphase1],IMPTRYCONV_RHORHIGHERTOL);</span></div>
<div class="line"><a name="l04719"></a><span class="lineno"> 4719</span>&#160;            trueimpallowconvcold=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(trueimpallowconvcold,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a69f5311b52c9fce4441c9ded33d86184">IMPALLOWCONV_RHORHIGHERTOL</a>);</div>
<div class="line"><a name="l04720"></a><span class="lineno"> 4720</span>&#160;          }</div>
<div class="line"><a name="l04721"></a><span class="lineno"> 4721</span>&#160;          <span class="keywordflow">else</span> <span class="keywordflow">if</span>(V[1]&gt;<a class="code" href="../../da/d3e/definit_8h.html#a96144cf19084532e7fa17366b1b4b5b9">OUTERDEATHRADIUS</a> &amp;&amp; <a class="code" href="../../da/d3e/definit_8h.html#aa2b0c5dd91e7e776f8944c26ff7ecf0b">OUTERDEATH</a>==1){</div>
<div class="line"><a name="l04722"></a><span class="lineno"> 4722</span>&#160;            trueimptryconvcold=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(trueimptryconvcold,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#adfc141d6141c97938025b106e5c2484f">IMPTRYCONV_ROUTERHIGHERTOL</a>);</div>
<div class="line"><a name="l04723"></a><span class="lineno"> 4723</span>&#160;          } </div>
<div class="line"><a name="l04724"></a><span class="lineno"> 4724</span>&#160;</div>
<div class="line"><a name="l04725"></a><span class="lineno"> 4725</span>&#160;        }</div>
<div class="line"><a name="l04726"></a><span class="lineno"> 4726</span>&#160;      </div>
<div class="line"><a name="l04727"></a><span class="lineno"> 4727</span>&#160;        <span class="keywordflow">if</span>(reducetoquick){</div>
<div class="line"><a name="l04728"></a><span class="lineno"> 4728</span>&#160;          <span class="keywordflow">if</span>(reducetoquick==1){</div>
<div class="line"><a name="l04729"></a><span class="lineno"> 4729</span>&#160;            trueimptryconvcold=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ac5e04595551dd07bf6f57b21d5911e81">IMPTRYCONVSUPERQUICK</a>;</div>
<div class="line"><a name="l04730"></a><span class="lineno"> 4730</span>&#160;            trueimpmaxitercold=1;</div>
<div class="line"><a name="l04731"></a><span class="lineno"> 4731</span>&#160;          }</div>
<div class="line"><a name="l04732"></a><span class="lineno"> 4732</span>&#160;          <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l04733"></a><span class="lineno"> 4733</span>&#160;            trueimptryconvcold=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a1ed8230cb4aee8a0c35a93613b5abcdd">IMPTRYCONVQUICK</a>;</div>
<div class="line"><a name="l04734"></a><span class="lineno"> 4734</span>&#160;            trueimpmaxitercold=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a03eeb7614c6d7be8ab6fb4e6d2036ee3">IMPMAXITERQUICK</a>;</div>
<div class="line"><a name="l04735"></a><span class="lineno"> 4735</span>&#160;          }</div>
<div class="line"><a name="l04736"></a><span class="lineno"> 4736</span>&#160;        }</div>
<div class="line"><a name="l04737"></a><span class="lineno"> 4737</span>&#160;</div>
<div class="line"><a name="l04738"></a><span class="lineno"> 4738</span>&#160;        <span class="comment">// start fresh or use entropy as starting point</span></div>
<div class="line"><a name="l04739"></a><span class="lineno"> 4739</span>&#160;        *lpflag=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#abdf9e55b7b15ec0bcd386055f1787f47">UTOPRIMNOFAIL</a>;</div>
<div class="line"><a name="l04740"></a><span class="lineno"> 4740</span>&#160;        *lpflagrad=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6435e9609d622c9dbaf78c12658ecf8e">UTOPRIMRADNOFAIL</a>;</div>
<div class="line"><a name="l04741"></a><span class="lineno"> 4741</span>&#160;        radinvmodcold=0;</div>
<div class="line"><a name="l04742"></a><span class="lineno"> 4742</span>&#160;        radErfnegcold=0;</div>
<div class="line"><a name="l04743"></a><span class="lineno"> 4743</span>&#160;        failreturncold=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab0abd953f677a44020dc50259c410486">FAILRETURNGENERAL</a>; <span class="comment">// default to fail in case cold not to be done at all</span></div>
<div class="line"><a name="l04744"></a><span class="lineno"> 4744</span>&#160;        eomtypecold=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a757ad8b9c2c7611dad8aab853a87f61b">EOMCOLDGRMHD</a>;</div>
<div class="line"><a name="l04745"></a><span class="lineno"> 4745</span>&#160;        goexplicitcold=0;</div>
<div class="line"><a name="l04746"></a><span class="lineno"> 4746</span>&#160;        errorabscold[0]=errorabscold[1]=1.0;</div>
<div class="line"><a name="l04747"></a><span class="lineno"> 4747</span>&#160;        <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fracenergycold=0.0;</div>
<div class="line"><a name="l04748"></a><span class="lineno"> 4748</span>&#160;        <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> errorabscoldbest[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa63447acbbbc62cbedae23eac61c716e" title="determine which error will use when deciding if converged or not.">NUMERRORTYPES</a>];</div>
<div class="line"><a name="l04749"></a><span class="lineno"> 4749</span>&#160;        set_array(errorabscoldbest,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa63447acbbbc62cbedae23eac61c716e" title="determine which error will use when deciding if converged or not.">NUMERRORTYPES</a>,MPI_FTYPE,1.0);</div>
<div class="line"><a name="l04750"></a><span class="lineno"> 4750</span>&#160;</div>
<div class="line"><a name="l04751"></a><span class="lineno"> 4751</span>&#160;        havebackup=0; <span class="comment">// no backup since entropy and energy failed</span></div>
<div class="line"><a name="l04752"></a><span class="lineno"> 4752</span>&#160;        didentropyalready=0;</div>
<div class="line"><a name="l04753"></a><span class="lineno"> 4753</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l04754"></a><span class="lineno"> 4754</span>&#160;          pbcold[pl]=pbbackup[pl];</div>
<div class="line"><a name="l04755"></a><span class="lineno"> 4755</span>&#160;          uubcold[pl]=uubbackup[pl];</div>
<div class="line"><a name="l04756"></a><span class="lineno"> 4756</span>&#160;          <span class="keywordflow">if</span>(0){</div>
<div class="line"><a name="l04757"></a><span class="lineno"> 4757</span>&#160;            <span class="comment">// but force cold setup</span></div>
<div class="line"><a name="l04758"></a><span class="lineno"> 4758</span>&#160;            pbcold[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a13f615d7832e3abc6abd54325112daf3">UUMINLIMIT</a>;</div>
<div class="line"><a name="l04759"></a><span class="lineno"> 4759</span>&#160;            pbcold[URAD0]=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a5bd9da451f108352614cbc457524c5b0">ERADLIMIT</a>;</div>
<div class="line"><a name="l04760"></a><span class="lineno"> 4760</span>&#160;          }</div>
<div class="line"><a name="l04761"></a><span class="lineno"> 4761</span>&#160;          <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l04762"></a><span class="lineno"> 4762</span>&#160;            <span class="comment">// try just using static u_g and solving momentum equation as if not changing.</span></div>
<div class="line"><a name="l04763"></a><span class="lineno"> 4763</span>&#160;          }</div>
<div class="line"><a name="l04764"></a><span class="lineno"> 4764</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a2da8b12fca78064531b9b64e5699e4fc" title="loop over ALL sources (including geometry)">SCLOOP</a>(sc) dUcompcold[sc][pl]=dUcompbackup[sc][pl];</div>
<div class="line"><a name="l04765"></a><span class="lineno"> 4765</span>&#160;        }</div>
<div class="line"><a name="l04766"></a><span class="lineno"> 4766</span>&#160;        qcold=qbackup;</div>
<div class="line"><a name="l04767"></a><span class="lineno"> 4767</span>&#160;        errorabscold[0]=errorabscold[1]=1.0;</div>
<div class="line"><a name="l04768"></a><span class="lineno"> 4768</span>&#160;</div>
<div class="line"><a name="l04769"></a><span class="lineno"> 4769</span>&#160;</div>
<div class="line"><a name="l04770"></a><span class="lineno"> 4770</span>&#160;        failreturncold=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a17aede36203a236390363af78d3a86f0" title="compute changes to U (both T and R) using implicit method KORALTODO: If doing implicit, should also add geometry source term that can sometimes be stiff.">koral_source_rad_implicit_mode</a>(modemethodlocal,0,0,havebackup, didentropyalready, &amp;eomtypecold, whichcapcold, itermodecold, &amp;baseitermethodcold, trueimptryconvcold, trueimpokconvcold, trueimpallowconvcold, trueimpmaxitercold, truenumdampattemptscold, fracenergycold, dissmeasure, &amp;radinvmodcold, pbcold, uubcold, piin, Uiin, Ufin, CUf, CUimp, ptrgeom, &amp;qcold, dUother ,dUcompcold, errorabscold, errorabscoldbest, &amp;iterscold, &amp;f1iterscold, &amp;nummhdinvscold, &amp;nummhdstepscold);</div>
<div class="line"><a name="l04771"></a><span class="lineno"> 4771</span>&#160;        nummhdsteps+=nummhdstepscold;</div>
<div class="line"><a name="l04772"></a><span class="lineno"> 4772</span>&#160;</div>
<div class="line"><a name="l04773"></a><span class="lineno"> 4773</span>&#160;        <span class="keywordflow">if</span>(failreturncold==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a04634949fd2370214f3d313c9cffa182">FAILRETURNGOTRIVIALEXPLICIT</a>) goexplicitcold=1;</div>
<div class="line"><a name="l04774"></a><span class="lineno"> 4774</span>&#160;        <span class="comment">// store these in case cold ultimately used</span></div>
<div class="line"><a name="l04775"></a><span class="lineno"> 4775</span>&#160;        lpflagcold=*lpflag;</div>
<div class="line"><a name="l04776"></a><span class="lineno"> 4776</span>&#160;        lpflagradcold=*lpflagrad;</div>
<div class="line"><a name="l04777"></a><span class="lineno"> 4777</span>&#160;</div>
<div class="line"><a name="l04778"></a><span class="lineno"> 4778</span>&#160;        <span class="comment">// save which method ended up using</span></div>
<div class="line"><a name="l04779"></a><span class="lineno"> 4779</span>&#160;        methodindex[<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a19f0668a5075a4ca1061348f26a4fc13">BASEITERMETHODINDEX</a>] = <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9cf5ca7f5e5aa1e0bdef53abe3f27c1c">QTYPMHD</a>;</div>
<div class="line"><a name="l04780"></a><span class="lineno"> 4780</span>&#160;        methodindex[<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a698402bc5dc720863bbf11c90786520d">ITERMODEINDEX</a>] = <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a18693ca111670c1ff38ab2206f70c81e">ITERMODECOLD</a>;</div>
<div class="line"><a name="l04781"></a><span class="lineno"> 4781</span>&#160;        methodindex[<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a8f7ffa366fb45fd76a8a991ac9f4c43b">IMPMAXITERINDEX</a>] = <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a03eeb7614c6d7be8ab6fb4e6d2036ee3">IMPMAXITERQUICK</a>;</div>
<div class="line"><a name="l04782"></a><span class="lineno"> 4782</span>&#160;        methodindex[NUMDAMPINDEX] = <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a05f68af4806f09b5fcb143348da66be1">NUMDAMPATTEMPTS</a>;</div>
<div class="line"><a name="l04783"></a><span class="lineno"> 4783</span>&#160;        methodindex[<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a0f8cccff59db9d8325aa44b8cb389a44">MODPRIMINDEX</a>] = 0;</div>
<div class="line"><a name="l04784"></a><span class="lineno"> 4784</span>&#160;        methodindex[<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a86a2418b187397a6fdf2cfd790a0ddeb">CHECKRADINVINDEX</a>] = 1;</div>
<div class="line"><a name="l04785"></a><span class="lineno"> 4785</span>&#160;        methodindex[<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a4681062d53a43e7fcb647275649f05ef">EOMTYPEINDEX</a>] = <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a757ad8b9c2c7611dad8aab853a87f61b">EOMCOLDGRMHD</a>;</div>
<div class="line"><a name="l04786"></a><span class="lineno"> 4786</span>&#160;</div>
<div class="line"><a name="l04787"></a><span class="lineno"> 4787</span>&#160;</div>
<div class="line"><a name="l04788"></a><span class="lineno"> 4788</span>&#160;      }<span class="comment">// end if cold flow</span></div>
<div class="line"><a name="l04789"></a><span class="lineno"> 4789</span>&#160;    }<span class="comment">// end if not failure</span></div>
<div class="line"><a name="l04790"></a><span class="lineno"> 4790</span>&#160;</div>
<div class="line"><a name="l04791"></a><span class="lineno"> 4791</span>&#160;</div>
<div class="line"><a name="l04792"></a><span class="lineno"> 4792</span>&#160;</div>
<div class="line"><a name="l04793"></a><span class="lineno"> 4793</span>&#160;</div>
<div class="line"><a name="l04794"></a><span class="lineno"> 4794</span>&#160;</div>
<div class="line"><a name="l04795"></a><span class="lineno"> 4795</span>&#160;</div>
<div class="line"><a name="l04796"></a><span class="lineno"> 4796</span>&#160;</div>
<div class="line"><a name="l04797"></a><span class="lineno"> 4797</span>&#160;</div>
<div class="line"><a name="l04798"></a><span class="lineno"> 4798</span>&#160;</div>
<div class="line"><a name="l04799"></a><span class="lineno"> 4799</span>&#160;</div>
<div class="line"><a name="l04800"></a><span class="lineno"> 4800</span>&#160;</div>
<div class="line"><a name="l04801"></a><span class="lineno"> 4801</span>&#160;</div>
<div class="line"><a name="l04803"></a><span class="lineno"> 4803</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l04804"></a><span class="lineno"> 4804</span>&#160;    <span class="comment">// see if should use the entropy solution</span></div>
<div class="line"><a name="l04805"></a><span class="lineno"> 4805</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l04806"></a><span class="lineno"> 4806</span>&#160;    <span class="comment">// Conditions to use entropy include:</span></div>
<div class="line"><a name="l04807"></a><span class="lineno"> 4807</span>&#160;    <span class="comment">// 1) dissmeasure says should avoid energy</span></div>
<div class="line"><a name="l04808"></a><span class="lineno"> 4808</span>&#160;    <span class="comment">// 2) energy failed</span></div>
<div class="line"><a name="l04809"></a><span class="lineno"> 4809</span>&#160;    <span class="comment">// 3) energy predicts smaller u_g than entropy</span></div>
<div class="line"><a name="l04810"></a><span class="lineno"> 4810</span>&#160;    <span class="comment">// 4) error in energy is large</span></div>
<div class="line"><a name="l04811"></a><span class="lineno"> 4811</span>&#160;    <span class="comment">// 5) etc.</span></div>
<div class="line"><a name="l04812"></a><span class="lineno"> 4812</span>&#160;    <span class="comment">// but keep changing conditions as learn more..</span></div>
<div class="line"><a name="l04813"></a><span class="lineno"> 4813</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l04815"></a><span class="lineno"> 4815</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04816"></a><span class="lineno"> 4816</span>&#160;    <span class="keywordtype">int</span> doentropy=whetherdoentropy(ptrgeom, fracenergy, <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a6ce9f5de6e575be785e5f053882a0909">ACCEPTASNOFAILURE</a>(failreturnentropy),<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a6ce9f5de6e575be785e5f053882a0909">ACCEPTASNOFAILURE</a>(failreturnenergy), radinvmodentropy, radinvmodenergy, <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a37aa5c4b7b1b481299d87bf929d13b15" title="error for comparing to sum over all absolute errors">IMPTRYCONVABS</a>, <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a0beb933bdd5a874f9fcada46b302fbff">IMPOKCONVABS</a>, <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a7c65c2d72d332ecc46dec0a183962ba2" title="tolerance above which say energy solution is probably bad even if not very large error. These have tended (or nearly 100%) to be cases where actual solution has u_g&lt;0 but harm gets error u_g&gt;0 and error not too large.">IMPBADENERGY</a>, errorabsentropy[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>], errorabsenergy[WHICHERROR], pbentropy, pbenergy);</div>
<div class="line"><a name="l04817"></a><span class="lineno"> 4817</span>&#160;    <span class="keywordflow">if</span>(goexplicitentropy==1) doentropy=0; <span class="comment">// override</span></div>
<div class="line"><a name="l04818"></a><span class="lineno"> 4818</span>&#160;</div>
<div class="line"><a name="l04819"></a><span class="lineno"> 4819</span>&#160;</div>
<div class="line"><a name="l04820"></a><span class="lineno"> 4820</span>&#160;</div>
<div class="line"><a name="l04821"></a><span class="lineno"> 4821</span>&#160;</div>
<div class="line"><a name="l04822"></a><span class="lineno"> 4822</span>&#160;    <span class="comment">// check if doing implicit</span></div>
<div class="line"><a name="l04823"></a><span class="lineno"> 4823</span>&#160;    <span class="comment">// 1) check if used entropy</span></div>
<div class="line"><a name="l04824"></a><span class="lineno"> 4824</span>&#160;    <span class="comment">// 2) check if used energy</span></div>
<div class="line"><a name="l04825"></a><span class="lineno"> 4825</span>&#160;    <span class="comment">// 3) check if used cold</span></div>
<div class="line"><a name="l04826"></a><span class="lineno"> 4826</span>&#160;    <span class="comment">// 4) else if none, then no implicit solution</span></div>
<div class="line"><a name="l04827"></a><span class="lineno"> 4827</span>&#160;</div>
<div class="line"><a name="l04828"></a><span class="lineno"> 4828</span>&#160;    <span class="comment">// 4a) If goexplicit{energy,entropy}=1, then explicit will be done as indicated by failfinalreturn=-1</span></div>
<div class="line"><a name="l04829"></a><span class="lineno"> 4829</span>&#160;    <span class="comment">// 4b) Else, real failure, so will just avoid G and do outer MHD/RAD inversion that assumes G=0.</span></div>
<div class="line"><a name="l04830"></a><span class="lineno"> 4830</span>&#160;</div>
<div class="line"><a name="l04831"></a><span class="lineno"> 4831</span>&#160;    <span class="keywordflow">if</span>(goexplicitentropy==0 &amp;&amp; goexplicitenergy==0){</div>
<div class="line"><a name="l04832"></a><span class="lineno"> 4832</span>&#160;      usedimplicit=1;</div>
<div class="line"><a name="l04833"></a><span class="lineno"> 4833</span>&#160;</div>
<div class="line"><a name="l04835"></a><span class="lineno"> 4835</span>&#160;      <span class="comment">//</span></div>
<div class="line"><a name="l04836"></a><span class="lineno"> 4836</span>&#160;      <span class="comment">// cases where must use entropy</span></div>
<div class="line"><a name="l04837"></a><span class="lineno"> 4837</span>&#160;      <span class="comment">//</span></div>
<div class="line"><a name="l04839"></a><span class="lineno"> 4839</span>&#160;<span class="comment"></span>      <span class="keywordflow">if</span>(doentropy){</div>
<div class="line"><a name="l04840"></a><span class="lineno"> 4840</span>&#160;        <span class="comment">//      dualfprintf(fail_file,&quot;USING ENTROPY\n&quot;);</span></div>
<div class="line"><a name="l04841"></a><span class="lineno"> 4841</span>&#160;        <span class="comment">// tell an externals to switch to entropy</span></div>
<div class="line"><a name="l04842"></a><span class="lineno"> 4842</span>&#160;        <span class="comment">// store these in case energy ultimately used</span></div>
<div class="line"><a name="l04843"></a><span class="lineno"> 4843</span>&#160;        *lpflag=lpflagentropy;</div>
<div class="line"><a name="l04844"></a><span class="lineno"> 4844</span>&#160;        *lpflagrad=lpflagradentropy;</div>
<div class="line"><a name="l04845"></a><span class="lineno"> 4845</span>&#160;        *eomtype=eomtypeentropy; <span class="comment">// can be EOMDONOTHING if successful and small enough error</span></div>
<div class="line"><a name="l04846"></a><span class="lineno"> 4846</span>&#160;        <span class="comment">// set result as entropy result</span></div>
<div class="line"><a name="l04847"></a><span class="lineno"> 4847</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l04848"></a><span class="lineno"> 4848</span>&#160;          pb[pl]=pbentropy[pl];</div>
<div class="line"><a name="l04849"></a><span class="lineno"> 4849</span>&#160;          uub[pl]=uubentropy[pl];</div>
<div class="line"><a name="l04850"></a><span class="lineno"> 4850</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a2da8b12fca78064531b9b64e5699e4fc" title="loop over ALL sources (including geometry)">SCLOOP</a>(sc) dUcomp[sc][pl]=dUcompentropy[sc][pl];</div>
<div class="line"><a name="l04851"></a><span class="lineno"> 4851</span>&#160;          *q=qentropy;</div>
<div class="line"><a name="l04852"></a><span class="lineno"> 4852</span>&#160;        }</div>
<div class="line"><a name="l04853"></a><span class="lineno"> 4853</span>&#160;        usedentropy=1;</div>
<div class="line"><a name="l04854"></a><span class="lineno"> 4854</span>&#160;        noprims=0;</div>
<div class="line"><a name="l04855"></a><span class="lineno"> 4855</span>&#160;        errorabs[0]=errorabsentropy[0];</div>
<div class="line"><a name="l04856"></a><span class="lineno"> 4856</span>&#160;        errorabs[1]=errorabsentropy[1];</div>
<div class="line"><a name="l04857"></a><span class="lineno"> 4857</span>&#160;        iters=itersentropy+itersenergy; <span class="comment">// count both since did both</span></div>
<div class="line"><a name="l04858"></a><span class="lineno"> 4858</span>&#160;        f1iters=f1itersentropy+f1itersenergy; <span class="comment">// count both since did both</span></div>
<div class="line"><a name="l04859"></a><span class="lineno"> 4859</span>&#160;        failreturn=failreturnentropy;</div>
<div class="line"><a name="l04860"></a><span class="lineno"> 4860</span>&#160;        failfinalreturn=0;</div>
<div class="line"><a name="l04861"></a><span class="lineno"> 4861</span>&#160;</div>
<div class="line"><a name="l04862"></a><span class="lineno"> 4862</span>&#160;        <span class="comment">// save</span></div>
<div class="line"><a name="l04863"></a><span class="lineno"> 4863</span>&#160;        methodindex[<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a4681062d53a43e7fcb647275649f05ef">EOMTYPEINDEX</a>] = <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a40b55e98bfcccde1a3f19d983ca7488c">EOMENTROPYGRMHD</a>;</div>
<div class="line"><a name="l04864"></a><span class="lineno"> 4864</span>&#160;</div>
<div class="line"><a name="l04865"></a><span class="lineno"> 4865</span>&#160;      }</div>
<div class="line"><a name="l04866"></a><span class="lineno"> 4866</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a6ce9f5de6e575be785e5f053882a0909">ACCEPTASNOFAILURE</a>(failreturnenergy)==1){ <span class="comment">// automatically also done when fracenergy==1.0 (now, or when also fracenergy&gt;0.0)</span></div>
<div class="line"><a name="l04867"></a><span class="lineno"> 4867</span>&#160;        <span class="comment">//      dualfprintf(fail_file,&quot;USING ENERGY: errorabsenergy=%g errorabsentropy=%g\n&quot;,errorabsenergy[WHICHERROR],errorabsentropy[WHICHERROR]);</span></div>
<div class="line"><a name="l04868"></a><span class="lineno"> 4868</span>&#160;        *lpflag=lpflagenergy;</div>
<div class="line"><a name="l04869"></a><span class="lineno"> 4869</span>&#160;        *lpflagrad=lpflagradenergy;</div>
<div class="line"><a name="l04870"></a><span class="lineno"> 4870</span>&#160;        *eomtype=eomtypeenergy; <span class="comment">// can be EOMDONOTHING if successful</span></div>
<div class="line"><a name="l04871"></a><span class="lineno"> 4871</span>&#160;        <span class="comment">// set result as energy result</span></div>
<div class="line"><a name="l04872"></a><span class="lineno"> 4872</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l04873"></a><span class="lineno"> 4873</span>&#160;          pb[pl]=pbenergy[pl];</div>
<div class="line"><a name="l04874"></a><span class="lineno"> 4874</span>&#160;          uub[pl]=uubenergy[pl];</div>
<div class="line"><a name="l04875"></a><span class="lineno"> 4875</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a2da8b12fca78064531b9b64e5699e4fc" title="loop over ALL sources (including geometry)">SCLOOP</a>(sc) dUcomp[sc][pl]=dUcompenergy[sc][pl];</div>
<div class="line"><a name="l04876"></a><span class="lineno"> 4876</span>&#160;          *q=qenergy;</div>
<div class="line"><a name="l04877"></a><span class="lineno"> 4877</span>&#160;        }</div>
<div class="line"><a name="l04878"></a><span class="lineno"> 4878</span>&#160;        usedenergy=1;</div>
<div class="line"><a name="l04879"></a><span class="lineno"> 4879</span>&#160;        noprims=0;</div>
<div class="line"><a name="l04880"></a><span class="lineno"> 4880</span>&#160;        errorabs[0]=errorabsenergy[0];</div>
<div class="line"><a name="l04881"></a><span class="lineno"> 4881</span>&#160;        errorabs[1]=errorabsenergy[1];</div>
<div class="line"><a name="l04882"></a><span class="lineno"> 4882</span>&#160;        iters=itersentropy+itersenergy; <span class="comment">// count both since did both</span></div>
<div class="line"><a name="l04883"></a><span class="lineno"> 4883</span>&#160;        f1iters=f1itersentropy+f1itersenergy; <span class="comment">// count both since did both</span></div>
<div class="line"><a name="l04884"></a><span class="lineno"> 4884</span>&#160;        failreturn=failreturnenergy;</div>
<div class="line"><a name="l04885"></a><span class="lineno"> 4885</span>&#160;        failfinalreturn=0;</div>
<div class="line"><a name="l04886"></a><span class="lineno"> 4886</span>&#160;</div>
<div class="line"><a name="l04887"></a><span class="lineno"> 4887</span>&#160;        <span class="comment">// save</span></div>
<div class="line"><a name="l04888"></a><span class="lineno"> 4888</span>&#160;        methodindex[<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a4681062d53a43e7fcb647275649f05ef">EOMTYPEINDEX</a>] = <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a03d89f51ab60206791830c886d62bfd0">EOMGRMHD</a>;</div>
<div class="line"><a name="l04889"></a><span class="lineno"> 4889</span>&#160;</div>
<div class="line"><a name="l04890"></a><span class="lineno"> 4890</span>&#160;      }</div>
<div class="line"><a name="l04891"></a><span class="lineno"> 4891</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a6ce9f5de6e575be785e5f053882a0909">ACCEPTASNOFAILURE</a>(failreturncold)==1){</div>
<div class="line"><a name="l04892"></a><span class="lineno"> 4892</span>&#160;        <span class="comment">//      dualfprintf(fail_file,&quot;USING COLD: errorabscold=%g errorabsentropy=%g\n&quot;,errorabscold[WHICHERROR],errorabsentropy[WHICHERROR]);</span></div>
<div class="line"><a name="l04893"></a><span class="lineno"> 4893</span>&#160;        *lpflag=lpflagcold;</div>
<div class="line"><a name="l04894"></a><span class="lineno"> 4894</span>&#160;        *lpflagrad=lpflagradcold;</div>
<div class="line"><a name="l04895"></a><span class="lineno"> 4895</span>&#160;        *eomtype=eomtypecold; <span class="comment">// can be EOMDONOTHING if successful</span></div>
<div class="line"><a name="l04896"></a><span class="lineno"> 4896</span>&#160;        <span class="comment">// set result as cold result</span></div>
<div class="line"><a name="l04897"></a><span class="lineno"> 4897</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l04898"></a><span class="lineno"> 4898</span>&#160;          pb[pl]=pbcold[pl];</div>
<div class="line"><a name="l04899"></a><span class="lineno"> 4899</span>&#160;          uub[pl]=uubcold[pl];</div>
<div class="line"><a name="l04900"></a><span class="lineno"> 4900</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a2da8b12fca78064531b9b64e5699e4fc" title="loop over ALL sources (including geometry)">SCLOOP</a>(sc) dUcomp[sc][pl]=dUcompcold[sc][pl];</div>
<div class="line"><a name="l04901"></a><span class="lineno"> 4901</span>&#160;          *q=qcold;</div>
<div class="line"><a name="l04902"></a><span class="lineno"> 4902</span>&#160;        }</div>
<div class="line"><a name="l04903"></a><span class="lineno"> 4903</span>&#160;        usedcold=1;</div>
<div class="line"><a name="l04904"></a><span class="lineno"> 4904</span>&#160;        noprims=0;</div>
<div class="line"><a name="l04905"></a><span class="lineno"> 4905</span>&#160;        errorabs[0]=errorabscold[0];</div>
<div class="line"><a name="l04906"></a><span class="lineno"> 4906</span>&#160;        errorabs[1]=errorabscold[1];</div>
<div class="line"><a name="l04907"></a><span class="lineno"> 4907</span>&#160;        iters=itersentropy+itersenergy+iterscold; <span class="comment">// count all since did all</span></div>
<div class="line"><a name="l04908"></a><span class="lineno"> 4908</span>&#160;        f1iters=f1itersentropy+f1itersenergy+f1iterscold; <span class="comment">// &quot;&quot;</span></div>
<div class="line"><a name="l04909"></a><span class="lineno"> 4909</span>&#160;        failreturn=failreturncold;</div>
<div class="line"><a name="l04910"></a><span class="lineno"> 4910</span>&#160;        failfinalreturn=0;</div>
<div class="line"><a name="l04911"></a><span class="lineno"> 4911</span>&#160;</div>
<div class="line"><a name="l04912"></a><span class="lineno"> 4912</span>&#160;        <span class="comment">// need to fail on u_g and Erf so averages</span></div>
<div class="line"><a name="l04913"></a><span class="lineno"> 4913</span>&#160;        *lpflag=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afc8db2dfa526f28224a0903680453240">UTOPRIMFAILU2AVG1FROMCOLD</a>;</div>
<div class="line"><a name="l04914"></a><span class="lineno"> 4914</span>&#160;        *lpflagrad=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afc8db2dfa526f28224a0903680453240">UTOPRIMFAILU2AVG1FROMCOLD</a>;</div>
<div class="line"><a name="l04915"></a><span class="lineno"> 4915</span>&#160;        <span class="comment">// only keep u_g and Erf static as backup</span></div>
<div class="line"><a name="l04916"></a><span class="lineno"> 4916</span>&#160;        pbcold[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]=pbbackup[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>];</div>
<div class="line"><a name="l04917"></a><span class="lineno"> 4917</span>&#160;        pbcold[URAD0]=pbbackup[URAD0]; </div>
<div class="line"><a name="l04918"></a><span class="lineno"> 4918</span>&#160;</div>
<div class="line"><a name="l04919"></a><span class="lineno"> 4919</span>&#160;        <span class="comment">// save</span></div>
<div class="line"><a name="l04920"></a><span class="lineno"> 4920</span>&#160;        methodindex[<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a4681062d53a43e7fcb647275649f05ef">EOMTYPEINDEX</a>] = <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a757ad8b9c2c7611dad8aab853a87f61b">EOMCOLDGRMHD</a>;</div>
<div class="line"><a name="l04921"></a><span class="lineno"> 4921</span>&#160;</div>
<div class="line"><a name="l04922"></a><span class="lineno"> 4922</span>&#160;      }</div>
<div class="line"><a name="l04923"></a><span class="lineno"> 4923</span>&#160;      <span class="keywordflow">else</span>{ <span class="comment">// force even if was default</span></div>
<div class="line"><a name="l04924"></a><span class="lineno"> 4924</span>&#160;        usedimplicit=0;</div>
<div class="line"><a name="l04925"></a><span class="lineno"> 4925</span>&#160;</div>
<div class="line"><a name="l04926"></a><span class="lineno"> 4926</span>&#160;        <span class="comment">// save</span></div>
<div class="line"><a name="l04927"></a><span class="lineno"> 4927</span>&#160;        methodindex[<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a4681062d53a43e7fcb647275649f05ef">EOMTYPEINDEX</a>] = <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aa28b06d889a02621b45edc716bfb2d01">EOMDEFAULT</a>;</div>
<div class="line"><a name="l04928"></a><span class="lineno"> 4928</span>&#160;</div>
<div class="line"><a name="l04929"></a><span class="lineno"> 4929</span>&#160;      }</div>
<div class="line"><a name="l04930"></a><span class="lineno"> 4930</span>&#160;    }</div>
<div class="line"><a name="l04931"></a><span class="lineno"> 4931</span>&#160;</div>
<div class="line"><a name="l04932"></a><span class="lineno"> 4932</span>&#160;</div>
<div class="line"><a name="l04933"></a><span class="lineno"> 4933</span>&#160;</div>
<div class="line"><a name="l04934"></a><span class="lineno"> 4934</span>&#160;    <span class="keywordflow">if</span>(usedimplicit==0){<span class="comment">// No source either because goexplicitenergy==1 &amp;&amp; goexplicitentropy==1 or failed</span></div>
<div class="line"><a name="l04935"></a><span class="lineno"> 4935</span>&#160;      <span class="keywordflow">if</span>(goexplicitenergy==1 || goexplicitentropy==1){</div>
<div class="line"><a name="l04936"></a><span class="lineno"> 4936</span>&#160;        *lpflag=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#abdf9e55b7b15ec0bcd386055f1787f47">UTOPRIMNOFAIL</a>;</div>
<div class="line"><a name="l04937"></a><span class="lineno"> 4937</span>&#160;        *lpflagrad=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6435e9609d622c9dbaf78c12658ecf8e">UTOPRIMRADNOFAIL</a>;</div>
<div class="line"><a name="l04938"></a><span class="lineno"> 4938</span>&#160;        noprims=1;</div>
<div class="line"><a name="l04939"></a><span class="lineno"> 4939</span>&#160;        failfinalreturn=1;</div>
<div class="line"><a name="l04940"></a><span class="lineno"> 4940</span>&#160;        *eomtype=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aa28b06d889a02621b45edc716bfb2d01">EOMDEFAULT</a>;</div>
<div class="line"><a name="l04941"></a><span class="lineno"> 4941</span>&#160;        methodindex[<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a4681062d53a43e7fcb647275649f05ef">EOMTYPEINDEX</a>] = *eomtype;</div>
<div class="line"><a name="l04942"></a><span class="lineno"> 4942</span>&#160;</div>
<div class="line"><a name="l04943"></a><span class="lineno"> 4943</span>&#160;        <span class="keywordflow">if</span>(goexplicitenergy==1 || goexplicitentropy==1){ usedexplicitgood=1; failfinalreturn=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a04634949fd2370214f3d313c9cffa182">FAILRETURNGOTRIVIALEXPLICIT</a>;}</div>
<div class="line"><a name="l04944"></a><span class="lineno"> 4944</span>&#160;        <span class="keywordflow">else</span>{ usedexplicitkindabad=1; failfinalreturn=1;} <span class="comment">// __WORKINGONIT__: might want to treat as actual failure if QTYPMHD mode since lpflag never set.</span></div>
<div class="line"><a name="l04945"></a><span class="lineno"> 4945</span>&#160;</div>
<div class="line"><a name="l04946"></a><span class="lineno"> 4946</span>&#160;        <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a7df8286c59d491ba1117884d33499a7a">prod0dualfprintf</a>(debugfail&gt;=3,<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;Went explicit: eenergy=%g eentropy=%g ienergy=%d ientropy=%d\n&quot;</span>,errorabsenergy[WHICHERROR],errorabsentropy[WHICHERROR],itersenergy,itersentropy);</div>
<div class="line"><a name="l04947"></a><span class="lineno"> 4947</span>&#160;      }</div>
<div class="line"><a name="l04948"></a><span class="lineno"> 4948</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span>(*lpflagrad&gt;<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6435e9609d622c9dbaf78c12658ecf8e">UTOPRIMRADNOFAIL</a> &amp;&amp; *lpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#abdf9e55b7b15ec0bcd386055f1787f47">UTOPRIMNOFAIL</a>){ <span class="comment">// then assume just radinvmod (i.e. any radiation failure is always fixable), so revert to explicit if couldn&#39;t find solution.</span></div>
<div class="line"><a name="l04949"></a><span class="lineno"> 4949</span>&#160;        *lpflag=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#abdf9e55b7b15ec0bcd386055f1787f47">UTOPRIMNOFAIL</a>;</div>
<div class="line"><a name="l04950"></a><span class="lineno"> 4950</span>&#160;        <span class="comment">//        *lpflagrad=UTOPRIMRADNOFAIL;</span></div>
<div class="line"><a name="l04951"></a><span class="lineno"> 4951</span>&#160;        noprims=1; <span class="comment">// so will apply fixup_utoprim()</span></div>
<div class="line"><a name="l04952"></a><span class="lineno"> 4952</span>&#160;        failfinalreturn=1;</div>
<div class="line"><a name="l04953"></a><span class="lineno"> 4953</span>&#160;        *eomtype=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aa28b06d889a02621b45edc716bfb2d01">EOMDEFAULT</a>;</div>
<div class="line"><a name="l04954"></a><span class="lineno"> 4954</span>&#160;        methodindex[<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a4681062d53a43e7fcb647275649f05ef">EOMTYPEINDEX</a>] = *eomtype;</div>
<div class="line"><a name="l04955"></a><span class="lineno"> 4955</span>&#160;</div>
<div class="line"><a name="l04956"></a><span class="lineno"> 4956</span>&#160;        <span class="keywordflow">if</span>(goexplicitenergy==1 || goexplicitentropy==1){ usedexplicitgood=1; failfinalreturn=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a04634949fd2370214f3d313c9cffa182">FAILRETURNGOTRIVIALEXPLICIT</a>;}</div>
<div class="line"><a name="l04957"></a><span class="lineno"> 4957</span>&#160;        <span class="keywordflow">else</span>{ usedexplicitkindabad=1; failfinalreturn=1;} <span class="comment">// __WORKINGONIT__: might want to treat as actual failure if QTYPMHD mode since lpflag never set.</span></div>
<div class="line"><a name="l04958"></a><span class="lineno"> 4958</span>&#160;</div>
<div class="line"><a name="l04959"></a><span class="lineno"> 4959</span>&#160;        <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a7df8286c59d491ba1117884d33499a7a">prod0dualfprintf</a>(debugfail&gt;=3,<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;Went explicit: eenergy=%g eentropy=%g ienergy=%d ientropy=%d\n&quot;</span>,errorabsenergy[WHICHERROR],errorabsentropy[WHICHERROR],itersenergy,itersentropy);</div>
<div class="line"><a name="l04960"></a><span class="lineno"> 4960</span>&#160;      }</div>
<div class="line"><a name="l04961"></a><span class="lineno"> 4961</span>&#160;      <span class="keywordflow">else</span>{ <span class="comment">// actual full failure</span></div>
<div class="line"><a name="l04962"></a><span class="lineno"> 4962</span>&#160;        <span class="comment">// if no source, then will do normal inversion (no change to *eomtype) as if G=0.</span></div>
<div class="line"><a name="l04963"></a><span class="lineno"> 4963</span>&#160;        methodindex[<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a4681062d53a43e7fcb647275649f05ef">EOMTYPEINDEX</a>] = *eomtype;</div>
<div class="line"><a name="l04964"></a><span class="lineno"> 4964</span>&#160;        *lpflag=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2de5944abdafe2f29ef970d24869a883">UTOPRIMFAILCONV</a>;</div>
<div class="line"><a name="l04965"></a><span class="lineno"> 4965</span>&#160;        *lpflagrad=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aba9c5f566b4227c5e5d8faef0f62e4e6" title="locally fixed inversion problems (as possible sometimes with radiation): see phys.tools.rad.c:u2p_rad()">UTOPRIMRADFAILCASE1A</a>;</div>
<div class="line"><a name="l04966"></a><span class="lineno"> 4966</span>&#160;        <span class="keywordflow">if</span>(errorabsenergy[WHICHERROR]&lt;errorabsentropy[WHICHERROR]){</div>
<div class="line"><a name="l04967"></a><span class="lineno"> 4967</span>&#160;          <span class="comment">// indicates error that could have had if chose to raise IMPALLOWCONV</span></div>
<div class="line"><a name="l04968"></a><span class="lineno"> 4968</span>&#160;          errorabs[0]=errorabsenergy[0];</div>
<div class="line"><a name="l04969"></a><span class="lineno"> 4969</span>&#160;          errorabs[1]=errorabsenergy[1];</div>
<div class="line"><a name="l04970"></a><span class="lineno"> 4970</span>&#160;        }</div>
<div class="line"><a name="l04971"></a><span class="lineno"> 4971</span>&#160;        <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l04972"></a><span class="lineno"> 4972</span>&#160;          errorabs[0]=errorabsentropy[0];</div>
<div class="line"><a name="l04973"></a><span class="lineno"> 4973</span>&#160;          errorabs[1]=errorabsentropy[1];</div>
<div class="line"><a name="l04974"></a><span class="lineno"> 4974</span>&#160;        }</div>
<div class="line"><a name="l04975"></a><span class="lineno"> 4975</span>&#160;        failfinalreturn=1;</div>
<div class="line"><a name="l04976"></a><span class="lineno"> 4976</span>&#160;        <span class="keywordflow">if</span>(reducetoquick!=1) usedexplicitbad=1;</div>
<div class="line"><a name="l04977"></a><span class="lineno"> 4977</span>&#160;</div>
<div class="line"><a name="l04978"></a><span class="lineno"> 4978</span>&#160;        <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a7df8286c59d491ba1117884d33499a7a">prod0dualfprintf</a>(debugfail&gt;=2,<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;No source: eenergy=%g eentropy=%g ienergy=%d ientropy=%d\n&quot;</span>,errorabsenergy[WHICHERROR],errorabsentropy[WHICHERROR],itersenergy,itersentropy);</div>
<div class="line"><a name="l04979"></a><span class="lineno"> 4979</span>&#160;      }</div>
<div class="line"><a name="l04980"></a><span class="lineno"> 4980</span>&#160;</div>
<div class="line"><a name="l04981"></a><span class="lineno"> 4981</span>&#160;      <span class="comment">// set prims and dU, but shouldn&#39;t be used</span></div>
<div class="line"><a name="l04982"></a><span class="lineno"> 4982</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l04983"></a><span class="lineno"> 4983</span>&#160;        pb[pl]=pbbackup[pl];</div>
<div class="line"><a name="l04984"></a><span class="lineno"> 4984</span>&#160;        uub[pl]=uubbackup[pl];</div>
<div class="line"><a name="l04985"></a><span class="lineno"> 4985</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a2da8b12fca78064531b9b64e5699e4fc" title="loop over ALL sources (including geometry)">SCLOOP</a>(sc) dUcomp[sc][pl]=dUcompbackup[sc][pl];</div>
<div class="line"><a name="l04986"></a><span class="lineno"> 4986</span>&#160;        *q=qbackup;</div>
<div class="line"><a name="l04987"></a><span class="lineno"> 4987</span>&#160;      }</div>
<div class="line"><a name="l04988"></a><span class="lineno"> 4988</span>&#160;      noprims=1;</div>
<div class="line"><a name="l04989"></a><span class="lineno"> 4989</span>&#160;      iters=itersentropy+itersenergy; <span class="comment">// count both since did both</span></div>
<div class="line"><a name="l04990"></a><span class="lineno"> 4990</span>&#160;      f1iters=f1itersentropy+f1itersenergy; <span class="comment">// count both since did both</span></div>
<div class="line"><a name="l04991"></a><span class="lineno"> 4991</span>&#160;      <span class="comment">//      failreturn=0;</span></div>
<div class="line"><a name="l04992"></a><span class="lineno"> 4992</span>&#160;      <span class="comment">// KORALTODO: But might want to fail more aggressively and report total failure.  Need to have estimate of whether G was important.</span></div>
<div class="line"><a name="l04993"></a><span class="lineno"> 4993</span>&#160;      failreturn=failreturnenergy;</div>
<div class="line"><a name="l04994"></a><span class="lineno"> 4994</span>&#160;    } <span class="comment">// end if using implicit solution</span></div>
<div class="line"><a name="l04995"></a><span class="lineno"> 4995</span>&#160;</div>
<div class="line"><a name="l04996"></a><span class="lineno"> 4996</span>&#160;</div>
<div class="line"><a name="l04997"></a><span class="lineno"> 4997</span>&#160;    <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a7df8286c59d491ba1117884d33499a7a">prod0dualfprintf</a>(*eomtype&gt;=0 &amp;&amp; failreturnenergy&gt;=0 &amp;&amp; failreturnentropy&gt;=0 &amp;&amp; failreturncold&gt;=0,<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;WTF: %d %d %d : %d : %d : %d\n&quot;</span>,failreturnentropy,failreturnenergy,failreturncold,failfinalreturn,noprims,*eomtype);</div>
<div class="line"><a name="l04998"></a><span class="lineno"> 4998</span>&#160;</div>
<div class="line"><a name="l04999"></a><span class="lineno"> 4999</span>&#160;  }<span class="comment">// end MODEPICKBEST || MODEPICKBESTSIMPLE || MODEPICKBESTSIMPLE2</span></div>
<div class="line"><a name="l05000"></a><span class="lineno"> 5000</span>&#160;</div>
<div class="line"><a name="l05001"></a><span class="lineno"> 5001</span>&#160;</div>
<div class="line"><a name="l05002"></a><span class="lineno"> 5002</span>&#160;</div>
<div class="line"><a name="l05003"></a><span class="lineno"> 5003</span>&#160;  <span class="comment">// DEBUG:</span></div>
<div class="line"><a name="l05004"></a><span class="lineno"> 5004</span>&#160;  <span class="comment">//  int prioriter; for(prioriter=0;prioriter&lt;NUMPRIORITERMETHODINDEX;prioriter++){</span></div>
<div class="line"><a name="l05005"></a><span class="lineno"> 5005</span>&#160;  <span class="comment">//    dualfprintf(fail_file,&quot;INDEX: prioriter=%d : %d\n&quot;,prioriter,methodindex[prioriter]);</span></div>
<div class="line"><a name="l05006"></a><span class="lineno"> 5006</span>&#160;  <span class="comment">//  }</span></div>
<div class="line"><a name="l05007"></a><span class="lineno"> 5007</span>&#160;</div>
<div class="line"><a name="l05008"></a><span class="lineno"> 5008</span>&#160;</div>
<div class="line"><a name="l05009"></a><span class="lineno"> 5009</span>&#160;</div>
<div class="line"><a name="l05010"></a><span class="lineno"> 5010</span>&#160;</div>
<div class="line"><a name="l05011"></a><span class="lineno"> 5011</span>&#160;</div>
<div class="line"><a name="l05012"></a><span class="lineno"> 5012</span>&#160;</div>
<div class="line"><a name="l05013"></a><span class="lineno"> 5013</span>&#160;  <span class="comment">// whether set some primitives (implies also failfinalreturn=0)</span></div>
<div class="line"><a name="l05014"></a><span class="lineno"> 5014</span>&#160;  <span class="keywordflow">if</span>(noprims==0){</div>
<div class="line"><a name="l05015"></a><span class="lineno"> 5015</span>&#160;    <span class="keywordflow">if</span>((pb[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>]&lt;=0.)&amp;&amp;(pb[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]&gt;=0.)) *lpflag= <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ad5bd994b947d2a46102582b38e4b1529">UTOPRIMFAILRHONEG</a>;</div>
<div class="line"><a name="l05016"></a><span class="lineno"> 5016</span>&#160;    <span class="keywordflow">if</span>((pb[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>]&gt;0.)&amp;&amp;(pb[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]&lt;0.))   *lpflag= <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a17c167aa50c0750a25baba351db69740">UTOPRIMFAILUNEG</a>;</div>
<div class="line"><a name="l05017"></a><span class="lineno"> 5017</span>&#160;    <span class="keywordflow">if</span>((pb[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>]&lt;=0.)&amp;&amp;(pb[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]&lt;0.))  *lpflag= <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a24290f84c3e2b725f7cbbdff81da4760">UTOPRIMFAILRHOUNEG</a>;</div>
<div class="line"><a name="l05018"></a><span class="lineno"> 5018</span>&#160;    <span class="keywordflow">if</span>(pb[PRAD0]&lt;=0.) *lpflagrad = <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a38b0585ec02d900ad0413645acb00918">UTOPRIMRADFAILERFNEG</a>;</div>
<div class="line"><a name="l05019"></a><span class="lineno"> 5019</span>&#160;  }</div>
<div class="line"><a name="l05020"></a><span class="lineno"> 5020</span>&#160;</div>
<div class="line"><a name="l05021"></a><span class="lineno"> 5021</span>&#160;</div>
<div class="line"><a name="l05022"></a><span class="lineno"> 5022</span>&#160;  <span class="comment">// force field to evolve as directly.</span></div>
<div class="line"><a name="l05023"></a><span class="lineno"> 5023</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a9afde1f1647e18e733406a1566b8b550">PLOOPBONLY</a>(pl){</div>
<div class="line"><a name="l05024"></a><span class="lineno"> 5024</span>&#160;    pf[pl]=pb[pl]=uu0[pl];</div>
<div class="line"><a name="l05025"></a><span class="lineno"> 5025</span>&#160;    dUcomp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab130f34dd5996718289efe08bc68b518">RADSOURCE</a>][pl]=0.0; <span class="comment">// always has to be.</span></div>
<div class="line"><a name="l05026"></a><span class="lineno"> 5026</span>&#160;  }</div>
<div class="line"><a name="l05027"></a><span class="lineno"> 5027</span>&#160;  </div>
<div class="line"><a name="l05028"></a><span class="lineno"> 5028</span>&#160;</div>
<div class="line"><a name="l05029"></a><span class="lineno"> 5029</span>&#160;</div>
<div class="line"><a name="l05030"></a><span class="lineno"> 5030</span>&#160;  <span class="comment">// DEBUG:</span></div>
<div class="line"><a name="l05031"></a><span class="lineno"> 5031</span>&#160;  <span class="comment">//  failfinalreturn=1;</span></div>
<div class="line"><a name="l05032"></a><span class="lineno"> 5032</span>&#160;  <span class="comment">//  *eomtype=EOMGRMHD;</span></div>
<div class="line"><a name="l05033"></a><span class="lineno"> 5033</span>&#160;</div>
<div class="line"><a name="l05034"></a><span class="lineno"> 5034</span>&#160;</div>
<div class="line"><a name="l05035"></a><span class="lineno"> 5035</span>&#160;</div>
<div class="line"><a name="l05036"></a><span class="lineno"> 5036</span>&#160;<span class="preprocessor">#if(PRODUCTION==0)</span></div>
<div class="line"><a name="l05037"></a><span class="lineno"> 5037</span>&#160;<span class="preprocessor"></span>  <span class="comment">// check if uncaught nan/inf</span></div>
<div class="line"><a name="l05038"></a><span class="lineno"> 5038</span>&#160;  <span class="keywordtype">int</span> caughtnan=0;</div>
<div class="line"><a name="l05039"></a><span class="lineno"> 5039</span>&#160;  <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9aa23a9a2b28d2c91e90a06c0025e91f">PLOOPDYNAMICAL</a>(pliter,pl){</div>
<div class="line"><a name="l05040"></a><span class="lineno"> 5040</span>&#160;    <span class="keywordflow">if</span>(!<a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(pb[pl])) caughtnan++;</div>
<div class="line"><a name="l05041"></a><span class="lineno"> 5041</span>&#160;    <span class="keywordflow">if</span>(!<a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(pf[pl])) caughtnan++;</div>
<div class="line"><a name="l05042"></a><span class="lineno"> 5042</span>&#160;    <span class="keywordflow">if</span>(!<a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(uub[pl])) caughtnan++;</div>
<div class="line"><a name="l05043"></a><span class="lineno"> 5043</span>&#160;    <span class="keywordflow">if</span>(!<a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(dUcomp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab130f34dd5996718289efe08bc68b518">RADSOURCE</a>][pl])) caughtnan++;</div>
<div class="line"><a name="l05044"></a><span class="lineno"> 5044</span>&#160;  }</div>
<div class="line"><a name="l05045"></a><span class="lineno"> 5045</span>&#160;  <span class="keywordflow">if</span>(caughtnan){</div>
<div class="line"><a name="l05046"></a><span class="lineno"> 5046</span>&#160;    <span class="comment">// Doesn&#39;t seem to happen, even on Kraken</span></div>
<div class="line"><a name="l05047"></a><span class="lineno"> 5047</span>&#160;    <span class="keywordflow">if</span>(debugfail&gt;=2){</div>
<div class="line"><a name="l05048"></a><span class="lineno"> 5048</span>&#160;      dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;implicit solver generated nan result and it wasn&#39;t caught\n&quot;</span>);</div>
<div class="line"><a name="l05049"></a><span class="lineno"> 5049</span>&#160;      <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9aa23a9a2b28d2c91e90a06c0025e91f">PLOOPDYNAMICAL</a>(pliter,pl) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;1implicit solver: pl=%d pb=%21.15g pf=%21.15g dU=%21.15g\n&quot;</span>,pl,pb[pl],pf[pl],dUcomp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab130f34dd5996718289efe08bc68b518">RADSOURCE</a>][pl]);</div>
<div class="line"><a name="l05050"></a><span class="lineno"> 5050</span>&#160;      <span class="keywordtype">int</span> jj;</div>
<div class="line"><a name="l05051"></a><span class="lineno"> 5051</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;2implicit solver: jj=%d ucon=%21.15g ucov=%21.15g uradcon=%21.15g uradcov=%21.15g\n&quot;</span>,jj,q-&gt;<a class="code" href="../../d1/d83/structof__state.html#aab723d3c7c2c48b7246cc7d7d5379eed">ucon</a>[jj],q-&gt;<a class="code" href="../../d1/d83/structof__state.html#a09881c3d05809ef27f8115d02a835e11">ucov</a>[jj],q-&gt;<a class="code" href="../../d1/d83/structof__state.html#a3bf8e15ee6ae95831230791baf2fc570">uradcon</a>[jj],q-&gt;<a class="code" href="../../d1/d83/structof__state.html#a87c04c4f890495e87a6682643a0c7955">uradcov</a>[jj]);</div>
<div class="line"><a name="l05052"></a><span class="lineno"> 5052</span>&#160;    }</div>
<div class="line"><a name="l05053"></a><span class="lineno"> 5053</span>&#160;</div>
<div class="line"><a name="l05054"></a><span class="lineno"> 5054</span>&#160;    <span class="comment">// choose as bad solution</span></div>
<div class="line"><a name="l05055"></a><span class="lineno"> 5055</span>&#160;</div>
<div class="line"><a name="l05056"></a><span class="lineno"> 5056</span>&#160;    <span class="comment">// if no source, then will do normal inversion (no change to *eomtype) as if G=0.</span></div>
<div class="line"><a name="l05057"></a><span class="lineno"> 5057</span>&#160;    methodindex[<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a4681062d53a43e7fcb647275649f05ef">EOMTYPEINDEX</a>] = *eomtype;</div>
<div class="line"><a name="l05058"></a><span class="lineno"> 5058</span>&#160;    *lpflag=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2de5944abdafe2f29ef970d24869a883">UTOPRIMFAILCONV</a>;</div>
<div class="line"><a name="l05059"></a><span class="lineno"> 5059</span>&#160;    *lpflagrad=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aba9c5f566b4227c5e5d8faef0f62e4e6" title="locally fixed inversion problems (as possible sometimes with radiation): see phys.tools.rad.c:u2p_rad()">UTOPRIMRADFAILCASE1A</a>;</div>
<div class="line"><a name="l05060"></a><span class="lineno"> 5060</span>&#160;    <span class="keywordflow">if</span>(debugfail&gt;=2) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;No sourceNAN\n&quot;</span>);</div>
<div class="line"><a name="l05061"></a><span class="lineno"> 5061</span>&#160;    failfinalreturn=1;</div>
<div class="line"><a name="l05062"></a><span class="lineno"> 5062</span>&#160;    <span class="keywordflow">if</span>(reducetoquick!=1) usedexplicitbad=1; <span class="comment">// don&#39;t include as real bad failure if forced pass-through without real solution</span></div>
<div class="line"><a name="l05063"></a><span class="lineno"> 5063</span>&#160;  </div>
<div class="line"><a name="l05064"></a><span class="lineno"> 5064</span>&#160;    <span class="comment">// set prims and dU, but shouldn&#39;t be used</span></div>
<div class="line"><a name="l05065"></a><span class="lineno"> 5065</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l05066"></a><span class="lineno"> 5066</span>&#160;      pb[pl]=pbbackup[pl];</div>
<div class="line"><a name="l05067"></a><span class="lineno"> 5067</span>&#160;      uub[pl]=uubbackup[pl];</div>
<div class="line"><a name="l05068"></a><span class="lineno"> 5068</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a2da8b12fca78064531b9b64e5699e4fc" title="loop over ALL sources (including geometry)">SCLOOP</a>(sc) dUcomp[sc][pl]=dUcompbackup[sc][pl];</div>
<div class="line"><a name="l05069"></a><span class="lineno"> 5069</span>&#160;      *q=qbackup;</div>
<div class="line"><a name="l05070"></a><span class="lineno"> 5070</span>&#160;    }</div>
<div class="line"><a name="l05071"></a><span class="lineno"> 5071</span>&#160;    noprims=1;</div>
<div class="line"><a name="l05072"></a><span class="lineno"> 5072</span>&#160;    <span class="comment">//      failreturn=0;</span></div>
<div class="line"><a name="l05073"></a><span class="lineno"> 5073</span>&#160;  }</div>
<div class="line"><a name="l05074"></a><span class="lineno"> 5074</span>&#160;<span class="preprocessor">#endif  </span></div>
<div class="line"><a name="l05075"></a><span class="lineno"> 5075</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l05076"></a><span class="lineno"> 5076</span>&#160;</div>
<div class="line"><a name="l05077"></a><span class="lineno"> 5077</span>&#160;</div>
<div class="line"><a name="l05078"></a><span class="lineno"> 5078</span>&#160;</div>
<div class="line"><a name="l05079"></a><span class="lineno"> 5079</span>&#160;</div>
<div class="line"><a name="l05080"></a><span class="lineno"> 5080</span>&#160;</div>
<div class="line"><a name="l05081"></a><span class="lineno"> 5081</span>&#160;  {<span class="comment">// save prior iter method</span></div>
<div class="line"><a name="l05082"></a><span class="lineno"> 5082</span>&#160;    <span class="keywordtype">int</span> oo;</div>
<div class="line"><a name="l05083"></a><span class="lineno"> 5083</span>&#160;    <span class="keywordflow">for</span>(oo=0;oo&lt;<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#acb843c30a487185fc9ae1e5460a19284" title="array indices for prioritermethod">NUMPRIORITERMETHODINDEX</a>;oo++){</div>
<div class="line"><a name="l05084"></a><span class="lineno"> 5084</span>&#160;      GLOBALMACP0A1(prioritermethod,i,j,k,oo)=methodindex[oo];</div>
<div class="line"><a name="l05085"></a><span class="lineno"> 5085</span>&#160;    }</div>
<div class="line"><a name="l05086"></a><span class="lineno"> 5086</span>&#160;  }</div>
<div class="line"><a name="l05087"></a><span class="lineno"> 5087</span>&#160;</div>
<div class="line"><a name="l05088"></a><span class="lineno"> 5088</span>&#160;</div>
<div class="line"><a name="l05089"></a><span class="lineno"> 5089</span>&#160;</div>
<div class="line"><a name="l05090"></a><span class="lineno"> 5090</span>&#160;</div>
<div class="line"><a name="l05091"></a><span class="lineno"> 5091</span>&#160;</div>
<div class="line"><a name="l05092"></a><span class="lineno"> 5092</span>&#160;</div>
<div class="line"><a name="l05093"></a><span class="lineno"> 5093</span>&#160;</div>
<div class="line"><a name="l05095"></a><span class="lineno"> 5095</span>&#160;    <span class="comment">// DEBUG INFO STUFF</span></div>
<div class="line"><a name="l05096"></a><span class="lineno"> 5096</span>&#160;</div>
<div class="line"><a name="l05097"></a><span class="lineno"> 5097</span>&#160;</div>
<div class="line"><a name="l05098"></a><span class="lineno"> 5098</span>&#160;</div>
<div class="line"><a name="l05099"></a><span class="lineno"> 5099</span>&#160;<span class="preprocessor">#if(PRODUCTION==0)</span></div>
<div class="line"><a name="l05100"></a><span class="lineno"> 5100</span>&#160;<span class="preprocessor"></span>  <span class="keywordflow">if</span>(errorabs[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>]&gt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8469a53eb25c0eb3b81286c364d0e7f3">IMPALLOWCONVCONSTABS</a> &amp;&amp; (usedenergy||usedentropy||usedcold)){</div>
<div class="line"><a name="l05101"></a><span class="lineno"> 5101</span>&#160;    dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;WTF2: %g : %d %d %d : %d %d\n&quot;</span>,errorabs[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>],usedenergy,usedentropy,usedcold,usedrameshenergy,usedrameshentropy);</div>
<div class="line"><a name="l05102"></a><span class="lineno"> 5102</span>&#160;    myexit(666);</div>
<div class="line"><a name="l05103"></a><span class="lineno"> 5103</span>&#160;  }</div>
<div class="line"><a name="l05104"></a><span class="lineno"> 5104</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l05105"></a><span class="lineno"> 5105</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l05106"></a><span class="lineno"> 5106</span>&#160;</div>
<div class="line"><a name="l05107"></a><span class="lineno"> 5107</span>&#160;  <span class="keywordtype">int</span> finalstep=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a70170b90229f9fc05eebf8508a685c70">steppart</a>==<a class="code" href="../../d8/d5b/defs_8general_8h.html#ae202d8b69a0ef3f07651368c3de9ca25">TIMEORDER</a>-1; <span class="comment">// all sub-steps aren&#39;t a concern as just setting flux but not implicit part of final ucum</span></div>
<div class="line"><a name="l05108"></a><span class="lineno"> 5108</span>&#160;</div>
<div class="line"><a name="l05109"></a><span class="lineno"> 5109</span>&#160;  <span class="comment">//  if(*lpflagrad&lt;0){</span></div>
<div class="line"><a name="l05110"></a><span class="lineno"> 5110</span>&#160;  <span class="comment">//    dualfprintf(fail_file,&quot;GOTHERE\n&quot;);</span></div>
<div class="line"><a name="l05111"></a><span class="lineno"> 5111</span>&#160;  <span class="comment">//  }</span></div>
<div class="line"><a name="l05112"></a><span class="lineno"> 5112</span>&#160;</div>
<div class="line"><a name="l05113"></a><span class="lineno"> 5113</span>&#160;  <span class="comment">//  if(*lpflag&lt;=UTOPRIMNOFAIL &amp;&amp; *lpflagrad&lt;=UTOPRIMRADNOFAIL &amp;&amp; (! (*lpflag&lt;UTOPRIMNOFAIL &amp;&amp; *lpflagrad&lt;UTOPRIMRADNOFAIL)) &amp;&amp; finalstep==1 &amp;&amp; failfinalreturn==0 &amp;&amp; *eomtype==EOMDIDGRMHD &amp;&amp; EOMTYPE==EOMGRMHD){</span></div>
<div class="line"><a name="l05114"></a><span class="lineno"> 5114</span>&#160;  <span class="comment">//*lpflag&lt;=UTOPRIMNOFAIL &amp;&amp; *lpflagrad&lt;=UTOPRIMRADNOFAIL &amp;&amp; (! (*lpflag&lt;UTOPRIMNOFAIL &amp;&amp; *lpflagrad&lt;UTOPRIMRADNOFAIL))&amp;&amp;</span></div>
<div class="line"><a name="l05115"></a><span class="lineno"> 5115</span>&#160;</div>
<div class="line"><a name="l05116"></a><span class="lineno"> 5116</span>&#160;</div>
<div class="line"><a name="l05117"></a><span class="lineno"> 5117</span>&#160;</div>
<div class="line"><a name="l05118"></a><span class="lineno"> 5118</span>&#160;  <span class="keywordflow">if</span>(finalstep==1&amp;&amp; failfinalreturn==0){</div>
<div class="line"><a name="l05119"></a><span class="lineno"> 5119</span>&#160;    <span class="comment">// see how accurately got energy-momentum</span></div>
<div class="line"><a name="l05120"></a><span class="lineno"> 5120</span>&#160;    <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> qb;</div>
<div class="line"><a name="l05121"></a><span class="lineno"> 5121</span>&#160;    <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a11e17cd8b0594d1ad52e3594aa9f477e" title="find ucon, ucov, bcon, bcov from primitive variables when calling get_state, users of this function e...">get_state</a>(pb,ptrgeom,&amp;qb);</div>
<div class="line"><a name="l05122"></a><span class="lineno"> 5122</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ub[NPR],ubabs[NPR];</div>
<div class="line"><a name="l05123"></a><span class="lineno"> 5123</span>&#160;    <span class="keywordtype">int</span> uutype=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0339344098add3b8dbaaf3f753ed4b4f">UDIAG</a>;</div>
<div class="line"><a name="l05124"></a><span class="lineno"> 5124</span>&#160;    <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a9a54096e4c40a15a2c1bf74266153616" title="calculate &quot;conserved&quot; quantities">primtoU</a>(uutype,pb,&amp;qb,ptrgeom,ub,ubabs);</div>
<div class="line"><a name="l05125"></a><span class="lineno"> 5125</span>&#160;    <span class="comment">//    if((startpos[1]+ptrgeom-&gt;i==17) &amp;&amp; (startpos[2]+ptrgeom-&gt;j)==0){</span></div>
<div class="line"><a name="l05126"></a><span class="lineno"> 5126</span>&#160;    <span class="comment">//      dualfprintf(fail_file,&quot;URHOINIMPLICIT=%21.15g\n&quot;,ub[RHO]*dx[1]*dx[2]*dx[3]);</span></div>
<div class="line"><a name="l05127"></a><span class="lineno"> 5127</span>&#160;    <span class="comment">//    }</span></div>
<div class="line"><a name="l05128"></a><span class="lineno"> 5128</span>&#160;</div>
<div class="line"><a name="l05129"></a><span class="lineno"> 5129</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> utot[NPR];</div>
<div class="line"><a name="l05130"></a><span class="lineno"> 5130</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) utot[pl] = uub[pl]; <span class="comment">// UNOTHING</span></div>
<div class="line"><a name="l05131"></a><span class="lineno"> 5131</span>&#160;</div>
<div class="line"><a name="l05132"></a><span class="lineno"> 5132</span>&#160;    <span class="comment">//    dualfprintf(fail_file,&quot;ub=%g utot=%g dU=%g\n&quot;,ub[UU],utot[UU],ub[UU]-utot[UU]);</span></div>
<div class="line"><a name="l05133"></a><span class="lineno"> 5133</span>&#160;</div>
<div class="line"><a name="l05134"></a><span class="lineno"> 5134</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ubdiag[NPR],utotdiag[NPR];</div>
<div class="line"><a name="l05135"></a><span class="lineno"> 5135</span>&#160;    UtoU(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0339344098add3b8dbaaf3f753ed4b4f">UDIAG</a>,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0339344098add3b8dbaaf3f753ed4b4f">UDIAG</a>,ptrgeom,ub,ubdiag);  <span class="comment">// convert from UNOTHING -&gt; UDIAG</span></div>
<div class="line"><a name="l05136"></a><span class="lineno"> 5136</span>&#160;    UtoU(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab2be21bd5eff40ca89c20eeecbeab5e0">UNOTHING</a>,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0339344098add3b8dbaaf3f753ed4b4f">UDIAG</a>,ptrgeom,utot,utotdiag);  <span class="comment">// convert from UNOTHING -&gt; UDIAG</span></div>
<div class="line"><a name="l05137"></a><span class="lineno"> 5137</span>&#160;</div>
<div class="line"><a name="l05138"></a><span class="lineno"> 5138</span>&#160;</div>
<div class="line"><a name="l05139"></a><span class="lineno"> 5139</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) <span class="keywordflow">if</span>(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a56c640597356b6f642dd6ee1afb87e74">BPL</a>(pl)) utotdiag[pl] = ubdiag[pl]; <span class="comment">// cell center as if no change as required, but should be true already as setup these.</span></div>
<div class="line"><a name="l05140"></a><span class="lineno"> 5140</span>&#160;</div>
<div class="line"><a name="l05141"></a><span class="lineno"> 5141</span>&#160;    <span class="comment">// Get deltaUavg[] and also modify ucons if required and should</span></div>
<div class="line"><a name="l05142"></a><span class="lineno"> 5142</span>&#160;    <span class="keywordtype">int</span> whocalled;</div>
<div class="line"><a name="l05143"></a><span class="lineno"> 5143</span>&#160;    <span class="keywordflow">if</span>(usedenergy) whocalled=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ade70ac9345aa7986f3361cb70abfe07c">COUNTIMPLICITENERGY</a>;</div>
<div class="line"><a name="l05144"></a><span class="lineno"> 5144</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(usedentropy) whocalled=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3f3b9c00c396340aca793cbdbebbf0e7">COUNTIMPLICITENTROPY</a>;</div>
<div class="line"><a name="l05145"></a><span class="lineno"> 5145</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(usedcold) whocalled=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae1b5fe25f0ef7944669acade1b7d923b">COUNTIMPLICITCOLDMHD</a>;</div>
<div class="line"><a name="l05146"></a><span class="lineno"> 5146</span>&#160;    <span class="comment">//else if(usedexplicitgood) whocalled=COUNTEXPLICITNORMAL;</span></div>
<div class="line"><a name="l05147"></a><span class="lineno"> 5147</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(usedexplicitkindabad || usedexplicitbad) whocalled=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2f4f7319228d53b3c944b91bd6507b8b">COUNTEXPLICITBAD</a>;</div>
<div class="line"><a name="l05148"></a><span class="lineno"> 5148</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(usedenergy==0 &amp;&amp; usedentropy==0 &amp;&amp; usedboth==0 &amp;&amp; usedcold==0 &amp;&amp; usedimplicit==1) whocalled=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a09723ba9b05dd86356218d16488871fb">COUNTIMPLICITBAD</a>;</div>
<div class="line"><a name="l05149"></a><span class="lineno"> 5149</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l05150"></a><span class="lineno"> 5150</span>&#160;      <span class="comment">//      dualfprintf(fail_file,&quot;GOD: %d %d\n&quot;,usedimplicit,usedexplicitgood);</span></div>
<div class="line"><a name="l05151"></a><span class="lineno"> 5151</span>&#160;      whocalled=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a4648060d8a43abd580dc12a575da466d">COUNTIMPLICITITERS</a>;</div>
<div class="line"><a name="l05152"></a><span class="lineno"> 5152</span>&#160;    }</div>
<div class="line"><a name="l05153"></a><span class="lineno"> 5153</span>&#160;</div>
<div class="line"><a name="l05154"></a><span class="lineno"> 5154</span>&#160;    <span class="keywordtype">int</span> docorrectuconslocal=0;</div>
<div class="line"><a name="l05155"></a><span class="lineno"> 5155</span>&#160;    <span class="keyword">extern</span> <span class="keywordtype">int</span> diag_fixup_dUandaccount(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ui, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Uf, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *ucons, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <span class="keywordtype">int</span> finalstep, <span class="keywordtype">int</span> whocalled, <span class="keywordtype">int</span> docorrectuconslocal);</div>
<div class="line"><a name="l05156"></a><span class="lineno"> 5156</span>&#160;    diag_fixup_dUandaccount(utotdiag, ubdiag, NULL, ptrgeom, finalstep, whocalled, docorrectuconslocal);</div>
<div class="line"><a name="l05157"></a><span class="lineno"> 5157</span>&#160;</div>
<div class="line"><a name="l05158"></a><span class="lineno"> 5158</span>&#160;</div>
<div class="line"><a name="l05159"></a><span class="lineno"> 5159</span>&#160;    <span class="comment">//    FTYPE rat = fabs(utotdiag[RHO]-ubdiag[RHO])/(fabs(utotdiag[RHO])+fabs(ubdiag[RHO]));</span></div>
<div class="line"><a name="l05160"></a><span class="lineno"> 5160</span>&#160;    <span class="comment">//    if(rat&gt;1E-13){</span></div>
<div class="line"><a name="l05161"></a><span class="lineno"> 5161</span>&#160;    <span class="comment">//      dualfprintf(fail_file,&quot;Why not: %d %d %d :  %21.15g %21.15g: diff=%21.15g : prho=%21.15g uu0RHO=%21.15g: error=%21.15g %21.15g\n&quot;,usedenergy,usedentropy,usedcold,utotdiag[RHO],ubdiag[RHO],utotdiag[RHO]-ubdiag[RHO],pb[RHO],uu0[RHO]*ptrgeom-&gt;gdet,errorabs[0],errorabs[1]);</span></div>
<div class="line"><a name="l05162"></a><span class="lineno"> 5162</span>&#160;    <span class="comment">//    }</span></div>
<div class="line"><a name="l05163"></a><span class="lineno"> 5163</span>&#160;</div>
<div class="line"><a name="l05164"></a><span class="lineno"> 5164</span>&#160;  }</div>
<div class="line"><a name="l05165"></a><span class="lineno"> 5165</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l05166"></a><span class="lineno"> 5166</span>&#160;    <span class="comment">// no solution, reverst to explicit and then average bad values, accounting will occur there.</span></div>
<div class="line"><a name="l05167"></a><span class="lineno"> 5167</span>&#160;  }</div>
<div class="line"><a name="l05168"></a><span class="lineno"> 5168</span>&#160;</div>
<div class="line"><a name="l05169"></a><span class="lineno"> 5169</span>&#160;</div>
<div class="line"><a name="l05170"></a><span class="lineno"> 5170</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#aefc47346bd5140a39b6d744385796e56" title="0: don&#39;t output debug dump file or ener file(ener is based on dump counts) 1: do">DODEBUG</a>){</div>
<div class="line"><a name="l05171"></a><span class="lineno"> 5171</span>&#160;    <span class="comment">// counters for implicit method and how it fails.</span></div>
<div class="line"><a name="l05172"></a><span class="lineno"> 5172</span>&#160;    <span class="comment">// Separate from normal utoprim inversion failure since once outside lose what actually did exactly</span></div>
<div class="line"><a name="l05173"></a><span class="lineno"> 5173</span>&#160;    <span class="comment">// That is, once outside this function, only know if failed, not which scheme used, because locally treat as not failing if (e.g.) entropy or coldMHD can be used and they did not fail.  This way, only no solution gives failure that then needs to be processed by fixup_utoprim().</span></div>
<div class="line"><a name="l05174"></a><span class="lineno"> 5174</span>&#160;</div>
<div class="line"><a name="l05175"></a><span class="lineno"> 5175</span>&#160;    <span class="comment">// just count, assume if want more details about how U is changed as a result, would use ONESTEPDUACCOUNTING=1</span></div>
<div class="line"><a name="l05176"></a><span class="lineno"> 5176</span>&#160;    <span class="keyword">extern</span> <span class="keywordtype">int</span> <a class="code" href="../../de/d95/fixup_8c.html#a43fb15d762b67f635ac6c63a158bf558" title="record who called the diag_fixup routine">count_whocalled</a>(<span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k, <span class="keywordtype">int</span> finalstep, <span class="keywordtype">int</span> whocalled, CTYPE toadd);</div>
<div class="line"><a name="l05177"></a><span class="lineno"> 5177</span>&#160;    <span class="keywordtype">int</span> fakefinalstep=1; <span class="comment">// always count, since final step actually doesn&#39;t do implicit stepping sometimes and need to know how intermediate steps did.</span></div>
<div class="line"><a name="l05178"></a><span class="lineno"> 5178</span>&#160;</div>
<div class="line"><a name="l05179"></a><span class="lineno"> 5179</span>&#160;    <a class="code" href="../../de/d95/fixup_8c.html#a43fb15d762b67f635ac6c63a158bf558" title="record who called the diag_fixup routine">count_whocalled</a>(ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k, fakefinalstep, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a4648060d8a43abd580dc12a575da466d">COUNTIMPLICITITERS</a>,(CTYPE)iters);</div>
<div class="line"><a name="l05180"></a><span class="lineno"> 5180</span>&#160;    <a class="code" href="../../de/d95/fixup_8c.html#a43fb15d762b67f635ac6c63a158bf558" title="record who called the diag_fixup routine">count_whocalled</a>(ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k, fakefinalstep, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ac1685fb73117f7ba0090cad2346a80a2">COUNTIMPLICITMHDSTEPS</a>,(CTYPE)nummhdsteps);</div>
<div class="line"><a name="l05181"></a><span class="lineno"> 5181</span>&#160;    <a class="code" href="../../de/d95/fixup_8c.html#a43fb15d762b67f635ac6c63a158bf558" title="record who called the diag_fixup routine">count_whocalled</a>(ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k, fakefinalstep, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a49acb288b48bbd107e99ea8f668c5249">COUNTIMPLICITERRORS0</a>,(CTYPE)errorabs[0]);</div>
<div class="line"><a name="l05182"></a><span class="lineno"> 5182</span>&#160;    <a class="code" href="../../de/d95/fixup_8c.html#a43fb15d762b67f635ac6c63a158bf558" title="record who called the diag_fixup routine">count_whocalled</a>(ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k, fakefinalstep, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aaf848fc9e63e17c924c7c3344984bfa9">COUNTIMPLICITERRORS1</a>,(CTYPE)errorabs[1]);</div>
<div class="line"><a name="l05183"></a><span class="lineno"> 5183</span>&#160;</div>
<div class="line"><a name="l05184"></a><span class="lineno"> 5184</span>&#160;    <span class="keywordflow">if</span>(usedimplicit) <a class="code" href="../../de/d95/fixup_8c.html#a43fb15d762b67f635ac6c63a158bf558" title="record who called the diag_fixup routine">count_whocalled</a>(ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k, fakefinalstep, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab6ef11dd00fcc6688c6ee3542d87a12e">COUNTIMPLICITNORMAL</a>,1);</div>
<div class="line"><a name="l05185"></a><span class="lineno"> 5185</span>&#160;    <span class="keywordflow">if</span>(usedexplicitgood) <a class="code" href="../../de/d95/fixup_8c.html#a43fb15d762b67f635ac6c63a158bf558" title="record who called the diag_fixup routine">count_whocalled</a>(ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k, fakefinalstep, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94e78a5a3dd0d93a76ee98795d9641ed">COUNTEXPLICITNORMAL</a>,1);</div>
<div class="line"><a name="l05186"></a><span class="lineno"> 5186</span>&#160;    <span class="keywordflow">if</span>(usedexplicitkindabad || usedexplicitbad) <a class="code" href="../../de/d95/fixup_8c.html#a43fb15d762b67f635ac6c63a158bf558" title="record who called the diag_fixup routine">count_whocalled</a>(ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k, fakefinalstep, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2f4f7319228d53b3c944b91bd6507b8b">COUNTEXPLICITBAD</a>,1);</div>
<div class="line"><a name="l05187"></a><span class="lineno"> 5187</span>&#160;    <span class="keywordflow">if</span>(usedenergy==0 &amp;&amp; usedentropy==0 &amp;&amp; usedboth==0 &amp;&amp; usedcold==0 &amp;&amp; usedimplicit==1) <a class="code" href="../../de/d95/fixup_8c.html#a43fb15d762b67f635ac6c63a158bf558" title="record who called the diag_fixup routine">count_whocalled</a>(ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k, fakefinalstep, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a09723ba9b05dd86356218d16488871fb">COUNTIMPLICITBAD</a>,1);</div>
<div class="line"><a name="l05188"></a><span class="lineno"> 5188</span>&#160;    <span class="keywordflow">if</span>(usedenergy||usedboth) <a class="code" href="../../de/d95/fixup_8c.html#a43fb15d762b67f635ac6c63a158bf558" title="record who called the diag_fixup routine">count_whocalled</a>(ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k, fakefinalstep, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ade70ac9345aa7986f3361cb70abfe07c">COUNTIMPLICITENERGY</a>,1);</div>
<div class="line"><a name="l05189"></a><span class="lineno"> 5189</span>&#160;    <span class="keywordflow">if</span>(usedentropy||usedboth) <a class="code" href="../../de/d95/fixup_8c.html#a43fb15d762b67f635ac6c63a158bf558" title="record who called the diag_fixup routine">count_whocalled</a>(ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k, fakefinalstep, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3f3b9c00c396340aca793cbdbebbf0e7">COUNTIMPLICITENTROPY</a>,1);</div>
<div class="line"><a name="l05190"></a><span class="lineno"> 5190</span>&#160;    <span class="keywordflow">if</span>(usedcold) <a class="code" href="../../de/d95/fixup_8c.html#a43fb15d762b67f635ac6c63a158bf558" title="record who called the diag_fixup routine">count_whocalled</a>(ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k, fakefinalstep, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae1b5fe25f0ef7944669acade1b7d923b">COUNTIMPLICITCOLDMHD</a>,1);</div>
<div class="line"><a name="l05191"></a><span class="lineno"> 5191</span>&#160;</div>
<div class="line"><a name="l05192"></a><span class="lineno"> 5192</span>&#160;    </div>
<div class="line"><a name="l05193"></a><span class="lineno"> 5193</span>&#160;</div>
<div class="line"><a name="l05194"></a><span class="lineno"> 5194</span>&#160;    <span class="keywordflow">if</span>(methodindex[<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a19f0668a5075a4ca1061348f26a4fc13">BASEITERMETHODINDEX</a>] == <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9cf5ca7f5e5aa1e0bdef53abe3f27c1c">QTYPMHD</a>) <a class="code" href="../../de/d95/fixup_8c.html#a43fb15d762b67f635ac6c63a158bf558" title="record who called the diag_fixup routine">count_whocalled</a>(ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k, fakefinalstep, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#af68cf32ad16ab3c5fa0748ea1b40b96a">COUNTIMPLICITPMHD</a>,1);</div>
<div class="line"><a name="l05195"></a><span class="lineno"> 5195</span>&#160;    <span class="keywordflow">if</span>(methodindex[<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a19f0668a5075a4ca1061348f26a4fc13">BASEITERMETHODINDEX</a>] == <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aea080032b13db4a71781aee78fef9902" title="whether iterate or have as error function: MHD T^t_ or RAD R^t_, etc.">QTYUMHD</a>) <a class="code" href="../../de/d95/fixup_8c.html#a43fb15d762b67f635ac6c63a158bf558" title="record who called the diag_fixup routine">count_whocalled</a>(ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k, fakefinalstep, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6a7723c9d3e9793fd4b9b0e89ac99f6e">COUNTIMPLICITUMHD</a>,1);</div>
<div class="line"><a name="l05196"></a><span class="lineno"> 5196</span>&#160;    <span class="keywordflow">if</span>(methodindex[<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a19f0668a5075a4ca1061348f26a4fc13">BASEITERMETHODINDEX</a>] == <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#add9bc1d07725fe2851182eccaa8eb385">QTYPRAD</a>) <a class="code" href="../../de/d95/fixup_8c.html#a43fb15d762b67f635ac6c63a158bf558" title="record who called the diag_fixup routine">count_whocalled</a>(ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k, fakefinalstep, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3c48d1c153ce3a37c09f42cbf7429fe1">COUNTIMPLICITPRAD</a>,1);</div>
<div class="line"><a name="l05197"></a><span class="lineno"> 5197</span>&#160;    <span class="keywordflow">if</span>(methodindex[<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a19f0668a5075a4ca1061348f26a4fc13">BASEITERMETHODINDEX</a>] == <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad919bedc37c48678c11e7e45cd1394cf">QTYURAD</a>) <a class="code" href="../../de/d95/fixup_8c.html#a43fb15d762b67f635ac6c63a158bf558" title="record who called the diag_fixup routine">count_whocalled</a>(ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k, fakefinalstep, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a78eaafb488ba043db08308288cfd92fe">COUNTIMPLICITURAD</a>,1);</div>
<div class="line"><a name="l05198"></a><span class="lineno"> 5198</span>&#160;    <span class="keywordflow">if</span>(methodindex[<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a19f0668a5075a4ca1061348f26a4fc13">BASEITERMETHODINDEX</a>] == <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ae83cfa7d219127e1aab2b1ccbe844bc6">QTYENTROPYUMHD</a>) <a class="code" href="../../de/d95/fixup_8c.html#a43fb15d762b67f635ac6c63a158bf558" title="record who called the diag_fixup routine">count_whocalled</a>(ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k, fakefinalstep, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae3b825355a7e332ff634e853264bf41e">COUNTIMPLICITENTROPYUMHD</a>,1);</div>
<div class="line"><a name="l05199"></a><span class="lineno"> 5199</span>&#160;    <span class="keywordflow">if</span>(methodindex[<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a19f0668a5075a4ca1061348f26a4fc13">BASEITERMETHODINDEX</a>] == <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a7a5a1fd5a93591755aa3e1af2019dc57">QTYENTROPYPMHD</a>) <a class="code" href="../../de/d95/fixup_8c.html#a43fb15d762b67f635ac6c63a158bf558" title="record who called the diag_fixup routine">count_whocalled</a>(ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k, fakefinalstep, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a5b3c6a6766bf042d739b9eff9653bba9">COUNTIMPLICITENTROPYPMHD</a>,1);</div>
<div class="line"><a name="l05200"></a><span class="lineno"> 5200</span>&#160;    <span class="keywordflow">if</span>(methodindex[<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a698402bc5dc720863bbf11c90786520d">ITERMODEINDEX</a>] == <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab9c7390f62ef08325e12b7110621d33a">ITERMODENORMAL</a>) <a class="code" href="../../de/d95/fixup_8c.html#a43fb15d762b67f635ac6c63a158bf558" title="record who called the diag_fixup routine">count_whocalled</a>(ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k, fakefinalstep, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a125d7b3d15b289faca7e1cbf4e643f05">COUNTIMPLICITMODENORMAL</a>,1);</div>
<div class="line"><a name="l05201"></a><span class="lineno"> 5201</span>&#160;    <span class="keywordflow">if</span>(methodindex[<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a698402bc5dc720863bbf11c90786520d">ITERMODEINDEX</a>] == <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a480c56e263c4874ccb40f3bbc1b32032">ITERMODESTAGES</a>) <a class="code" href="../../de/d95/fixup_8c.html#a43fb15d762b67f635ac6c63a158bf558" title="record who called the diag_fixup routine">count_whocalled</a>(ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k, fakefinalstep, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2c80106a282afd86e0145e271d370bbb">COUNTIMPLICITMODESTAGES</a>,1);</div>
<div class="line"><a name="l05202"></a><span class="lineno"> 5202</span>&#160;    <span class="keywordflow">if</span>(methodindex[<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a698402bc5dc720863bbf11c90786520d">ITERMODEINDEX</a>] == <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a18693ca111670c1ff38ab2206f70c81e">ITERMODECOLD</a>) <a class="code" href="../../de/d95/fixup_8c.html#a43fb15d762b67f635ac6c63a158bf558" title="record who called the diag_fixup routine">count_whocalled</a>(ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k, fakefinalstep, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a361b98f4af80cfdde0bc6938332d3155">COUNTIMPLICITMODECOLD</a>,1);</div>
<div class="line"><a name="l05203"></a><span class="lineno"> 5203</span>&#160;</div>
<div class="line"><a name="l05204"></a><span class="lineno"> 5204</span>&#160;</div>
<div class="line"><a name="l05205"></a><span class="lineno"> 5205</span>&#160;<span class="comment">// maybe fill du instead of these counts?</span></div>
<div class="line"><a name="l05206"></a><span class="lineno"> 5206</span>&#160;<span class="comment">//    count_whocalled(ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k, fakefinalstep, COUNTIMPLICITERRORS,errorabs[WHICHERROR]);</span></div>
<div class="line"><a name="l05207"></a><span class="lineno"> 5207</span>&#160;<span class="comment">//  numhisterr[MAX(MIN((int)(-log10l(SMALL+errorabs[WHICHERROR])),NUMNUMHIST-1),0)]++;</span></div>
<div class="line"><a name="l05208"></a><span class="lineno"> 5208</span>&#160;</div>
<div class="line"><a name="l05209"></a><span class="lineno"> 5209</span>&#160;<span class="comment">// unused: COUNTIMPLICITFAILED</span></div>
<div class="line"><a name="l05210"></a><span class="lineno"> 5210</span>&#160;</div>
<div class="line"><a name="l05211"></a><span class="lineno"> 5211</span>&#160;  }</div>
<div class="line"><a name="l05212"></a><span class="lineno"> 5212</span>&#160;</div>
<div class="line"><a name="l05213"></a><span class="lineno"> 5213</span>&#160;</div>
<div class="line"><a name="l05214"></a><span class="lineno"> 5214</span>&#160;</div>
<div class="line"><a name="l05215"></a><span class="lineno"> 5215</span>&#160;</div>
<div class="line"><a name="l05216"></a><span class="lineno"> 5216</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#a6fc838c14c5e9fc17d6d8bb3d868ec2f">PRODUCTION</a>==0 &amp;&amp; debugfail&gt;=2 || <a class="code" href="../../da/d3e/definit_8h.html#a6fc838c14c5e9fc17d6d8bb3d868ec2f">PRODUCTION</a>&lt;=1){</div>
<div class="line"><a name="l05217"></a><span class="lineno"> 5217</span>&#160;    <span class="comment">// counters and more detailed statistics on how the implicit solver performed</span></div>
<div class="line"><a name="l05218"></a><span class="lineno"> 5218</span>&#160;    <span class="comment">// Inlcudes histogram of iterations and errors</span></div>
<div class="line"><a name="l05219"></a><span class="lineno"> 5219</span>&#160;    <span class="comment">// this debug MPI stuff is very expensive</span></div>
<div class="line"><a name="l05220"></a><span class="lineno"> 5220</span>&#160;</div>
<div class="line"><a name="l05221"></a><span class="lineno"> 5221</span>&#160;</div>
<div class="line"><a name="l05223"></a><span class="lineno"> 5223</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l05224"></a><span class="lineno"> 5224</span>&#160;    <span class="comment">// static counter for diagnosing issues</span></div>
<div class="line"><a name="l05225"></a><span class="lineno"> 5225</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l05227"></a><span class="lineno"> 5227</span>&#160;<span class="comment"></span><span class="preprocessor">#define NUMNUMHIST (20)</span></div>
<div class="line"><a name="l05228"></a><span class="lineno"> 5228</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l05229"></a><span class="lineno"> 5229</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> numenergy=0;</div>
<div class="line"><a name="l05230"></a><span class="lineno"> 5230</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> numentropy=0;</div>
<div class="line"><a name="l05231"></a><span class="lineno"> 5231</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> numboth=0;</div>
<div class="line"><a name="l05232"></a><span class="lineno"> 5232</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> numcold=0;</div>
<div class="line"><a name="l05233"></a><span class="lineno"> 5233</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> numbad=0;</div>
<div class="line"><a name="l05234"></a><span class="lineno"> 5234</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> numramesh=0;</div>
<div class="line"><a name="l05235"></a><span class="lineno"> 5235</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> numrameshenergy=0;</div>
<div class="line"><a name="l05236"></a><span class="lineno"> 5236</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> numrameshentropy=0;</div>
<div class="line"><a name="l05237"></a><span class="lineno"> 5237</span>&#160;</div>
<div class="line"><a name="l05238"></a><span class="lineno"> 5238</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> numqtypmhd=0;</div>
<div class="line"><a name="l05239"></a><span class="lineno"> 5239</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> numqtyumhd=0;</div>
<div class="line"><a name="l05240"></a><span class="lineno"> 5240</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> numqtyprad=0;</div>
<div class="line"><a name="l05241"></a><span class="lineno"> 5241</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> numqtyurad=0;</div>
<div class="line"><a name="l05242"></a><span class="lineno"> 5242</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> numqtyentropyumhd=0;</div>
<div class="line"><a name="l05243"></a><span class="lineno"> 5243</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> numqtyentropypmhd=0;</div>
<div class="line"><a name="l05244"></a><span class="lineno"> 5244</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> numitermodenormal=0;</div>
<div class="line"><a name="l05245"></a><span class="lineno"> 5245</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> numitermodestages=0;</div>
<div class="line"><a name="l05246"></a><span class="lineno"> 5246</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> numitermodecold=0;</div>
<div class="line"><a name="l05247"></a><span class="lineno"> 5247</span>&#160;</div>
<div class="line"><a name="l05248"></a><span class="lineno"> 5248</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> numimplicits=0;</div>
<div class="line"><a name="l05249"></a><span class="lineno"> 5249</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> numexplicitsgood=0;</div>
<div class="line"><a name="l05250"></a><span class="lineno"> 5250</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> numexplicitskindabad=0;</div>
<div class="line"><a name="l05251"></a><span class="lineno"> 5251</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> numexplicitsbad=0;</div>
<div class="line"><a name="l05252"></a><span class="lineno"> 5252</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> numoff1iter=0,numofiter=0;</div>
<div class="line"><a name="l05253"></a><span class="lineno"> 5253</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> numhisterr0[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a382d31e35ac680932f0e2b78b42cf75f">NUMNUMHIST</a>]={0}; <span class="comment">// histogram of error for implicit solver to be reported infrequently</span></div>
<div class="line"><a name="l05254"></a><span class="lineno"> 5254</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> numhisterr1[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a382d31e35ac680932f0e2b78b42cf75f">NUMNUMHIST</a>]={0}; <span class="comment">// histogram of error for implicit solver to be reported infrequently</span></div>
<div class="line"><a name="l05255"></a><span class="lineno"> 5255</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> numhistiter[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a58cca3253f4dfcefde5fe864699e297a">IMPMAXITERLONG</a>+1]={0}; <span class="comment">// histogram of error for implicit solver to be reported infrequently</span></div>
<div class="line"><a name="l05256"></a><span class="lineno"> 5256</span>&#160;    <span class="comment">//    static long long int numindex[NUMPRIORITERMETHODINDEX]={0};</span></div>
<div class="line"><a name="l05257"></a><span class="lineno"> 5257</span>&#160;</div>
<div class="line"><a name="l05258"></a><span class="lineno"> 5258</span>&#160;    <span class="comment">// static counter for diagnosing issues</span></div>
<div class="line"><a name="l05259"></a><span class="lineno"> 5259</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> totalnumenergy=0;</div>
<div class="line"><a name="l05260"></a><span class="lineno"> 5260</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> totalnumentropy=0;</div>
<div class="line"><a name="l05261"></a><span class="lineno"> 5261</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> totalnumcold=0;</div>
<div class="line"><a name="l05262"></a><span class="lineno"> 5262</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> totalnumboth=0;</div>
<div class="line"><a name="l05263"></a><span class="lineno"> 5263</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> totalnumbad=0;</div>
<div class="line"><a name="l05264"></a><span class="lineno"> 5264</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> totalnumramesh=0;</div>
<div class="line"><a name="l05265"></a><span class="lineno"> 5265</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> totalnumrameshenergy=0;</div>
<div class="line"><a name="l05266"></a><span class="lineno"> 5266</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> totalnumrameshentropy=0;</div>
<div class="line"><a name="l05267"></a><span class="lineno"> 5267</span>&#160;</div>
<div class="line"><a name="l05268"></a><span class="lineno"> 5268</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> totalnumqtypmhd=0;</div>
<div class="line"><a name="l05269"></a><span class="lineno"> 5269</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> totalnumqtyumhd=0;</div>
<div class="line"><a name="l05270"></a><span class="lineno"> 5270</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> totalnumqtyprad=0;</div>
<div class="line"><a name="l05271"></a><span class="lineno"> 5271</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> totalnumqtyurad=0;</div>
<div class="line"><a name="l05272"></a><span class="lineno"> 5272</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> totalnumqtyentropyumhd=0;</div>
<div class="line"><a name="l05273"></a><span class="lineno"> 5273</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> totalnumqtyentropypmhd=0;</div>
<div class="line"><a name="l05274"></a><span class="lineno"> 5274</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> totalnumitermodenormal=0;</div>
<div class="line"><a name="l05275"></a><span class="lineno"> 5275</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> totalnumitermodestages=0;</div>
<div class="line"><a name="l05276"></a><span class="lineno"> 5276</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> totalnumitermodecold=0;</div>
<div class="line"><a name="l05277"></a><span class="lineno"> 5277</span>&#160;</div>
<div class="line"><a name="l05278"></a><span class="lineno"> 5278</span>&#160;</div>
<div class="line"><a name="l05279"></a><span class="lineno"> 5279</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> totalnumimplicits=0;</div>
<div class="line"><a name="l05280"></a><span class="lineno"> 5280</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> totalnumexplicitsgood=0;</div>
<div class="line"><a name="l05281"></a><span class="lineno"> 5281</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> totalnumexplicitskindabad=0;</div>
<div class="line"><a name="l05282"></a><span class="lineno"> 5282</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> totalnumexplicitsbad=0;</div>
<div class="line"><a name="l05283"></a><span class="lineno"> 5283</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> totalnumoff1iter=0,totalnumofiter=0;</div>
<div class="line"><a name="l05284"></a><span class="lineno"> 5284</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> totalnumhisterr0[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a382d31e35ac680932f0e2b78b42cf75f">NUMNUMHIST</a>]={0}; <span class="comment">// histogram of error for implicit solver to be reported infrequently</span></div>
<div class="line"><a name="l05285"></a><span class="lineno"> 5285</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> totalnumhisterr1[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a382d31e35ac680932f0e2b78b42cf75f">NUMNUMHIST</a>]={0}; <span class="comment">// histogram of error for implicit solver to be reported infrequently</span></div>
<div class="line"><a name="l05286"></a><span class="lineno"> 5286</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> totalnumhistiter[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a58cca3253f4dfcefde5fe864699e297a">IMPMAXITERLONG</a>+1]={0}; <span class="comment">// histogram of error for implicit solver to be reported infrequently</span></div>
<div class="line"><a name="l05287"></a><span class="lineno"> 5287</span>&#160;    <span class="comment">//    static long long int methodindex[NUMPRIORITERMETHODINDEX]={0};</span></div>
<div class="line"><a name="l05288"></a><span class="lineno"> 5288</span>&#160;</div>
<div class="line"><a name="l05289"></a><span class="lineno"> 5289</span>&#160;</div>
<div class="line"><a name="l05290"></a><span class="lineno"> 5290</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> totaltryphaselistenergy[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8076bfd08bb8012f9711601a7364d93c">NUMPHASES</a>];</div>
<div class="line"><a name="l05291"></a><span class="lineno"> 5291</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> totaltryphaselistentropy[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a490d03249c544ac789d91c742057394e">NUMPHASESENT</a>];</div>
<div class="line"><a name="l05292"></a><span class="lineno"> 5292</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> totaltryphaselistcold[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a12af67299c9e98e2eeef308ad46e3e0e">NUMPHASESCOLD</a>];</div>
<div class="line"><a name="l05293"></a><span class="lineno"> 5293</span>&#160;</div>
<div class="line"><a name="l05294"></a><span class="lineno"> 5294</span>&#160;</div>
<div class="line"><a name="l05296"></a><span class="lineno"> 5296</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l05297"></a><span class="lineno"> 5297</span>&#160;    <span class="comment">// Do some diagnostics and reporting.  Done if ACCEPTASNOFAILURE(failreturn)==0 or not.</span></div>
<div class="line"><a name="l05298"></a><span class="lineno"> 5298</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l05299"></a><span class="lineno"> 5299</span>&#160;    <span class="comment">// KORALNOTE: If set IMPALLOWCONV to be smaller, energy solution can be then invalidated (while previously would have been used because it has no u_g issue) and go to entropy can succeed, and then appears that fewer low-energy events.</span></div>
<div class="line"><a name="l05300"></a><span class="lineno"> 5300</span>&#160;    <span class="comment">// But then no FAILINFO will be reported to check why energy got high error!</span></div>
<div class="line"><a name="l05301"></a><span class="lineno"> 5301</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l05303"></a><span class="lineno"> 5303</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05304"></a><span class="lineno"> 5304</span>&#160;    <span class="comment">// simple counters</span></div>
<div class="line"><a name="l05305"></a><span class="lineno"> 5305</span>&#160;    numimplicits+=usedimplicit;</div>
<div class="line"><a name="l05306"></a><span class="lineno"> 5306</span>&#160;    numexplicitsgood+=usedexplicitgood;</div>
<div class="line"><a name="l05307"></a><span class="lineno"> 5307</span>&#160;    numexplicitskindabad+=usedexplicitkindabad;</div>
<div class="line"><a name="l05308"></a><span class="lineno"> 5308</span>&#160;    numexplicitsbad+=usedexplicitbad;</div>
<div class="line"><a name="l05309"></a><span class="lineno"> 5309</span>&#160;    numofiter+=iters;</div>
<div class="line"><a name="l05310"></a><span class="lineno"> 5310</span>&#160;    numoff1iter+=f1iters;</div>
<div class="line"><a name="l05311"></a><span class="lineno"> 5311</span>&#160;    numenergy+=usedenergy;</div>
<div class="line"><a name="l05312"></a><span class="lineno"> 5312</span>&#160;    numentropy+=usedentropy;</div>
<div class="line"><a name="l05313"></a><span class="lineno"> 5313</span>&#160;    numboth+=usedboth;</div>
<div class="line"><a name="l05314"></a><span class="lineno"> 5314</span>&#160;    numcold+=usedcold;</div>
<div class="line"><a name="l05315"></a><span class="lineno"> 5315</span>&#160;    numbad+=(usedenergy==0 &amp;&amp; usedentropy==0 &amp;&amp; usedboth==0 &amp;&amp; usedcold==0 &amp;&amp; usedimplicit==1);</div>
<div class="line"><a name="l05316"></a><span class="lineno"> 5316</span>&#160;    numramesh+=gotrameshsolution;</div>
<div class="line"><a name="l05317"></a><span class="lineno"> 5317</span>&#160;    numrameshenergy+=usedrameshenergy;</div>
<div class="line"><a name="l05318"></a><span class="lineno"> 5318</span>&#160;    numrameshentropy+=usedrameshentropy;</div>
<div class="line"><a name="l05319"></a><span class="lineno"> 5319</span>&#160;</div>
<div class="line"><a name="l05320"></a><span class="lineno"> 5320</span>&#160;    numqtypmhd += (methodindex[<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a19f0668a5075a4ca1061348f26a4fc13">BASEITERMETHODINDEX</a>] == <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9cf5ca7f5e5aa1e0bdef53abe3f27c1c">QTYPMHD</a>);</div>
<div class="line"><a name="l05321"></a><span class="lineno"> 5321</span>&#160;    numqtyumhd += (methodindex[<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a19f0668a5075a4ca1061348f26a4fc13">BASEITERMETHODINDEX</a>] == <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aea080032b13db4a71781aee78fef9902" title="whether iterate or have as error function: MHD T^t_ or RAD R^t_, etc.">QTYUMHD</a>);</div>
<div class="line"><a name="l05322"></a><span class="lineno"> 5322</span>&#160;    numqtyprad += (methodindex[<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a19f0668a5075a4ca1061348f26a4fc13">BASEITERMETHODINDEX</a>] == <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#add9bc1d07725fe2851182eccaa8eb385">QTYPRAD</a>);</div>
<div class="line"><a name="l05323"></a><span class="lineno"> 5323</span>&#160;    numqtyurad += (methodindex[<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a19f0668a5075a4ca1061348f26a4fc13">BASEITERMETHODINDEX</a>] == <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad919bedc37c48678c11e7e45cd1394cf">QTYURAD</a>);</div>
<div class="line"><a name="l05324"></a><span class="lineno"> 5324</span>&#160;    numqtyentropyumhd += (methodindex[<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a19f0668a5075a4ca1061348f26a4fc13">BASEITERMETHODINDEX</a>] == <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ae83cfa7d219127e1aab2b1ccbe844bc6">QTYENTROPYUMHD</a>);</div>
<div class="line"><a name="l05325"></a><span class="lineno"> 5325</span>&#160;    numqtyentropypmhd += (methodindex[<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a19f0668a5075a4ca1061348f26a4fc13">BASEITERMETHODINDEX</a>] == <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a7a5a1fd5a93591755aa3e1af2019dc57">QTYENTROPYPMHD</a>);</div>
<div class="line"><a name="l05326"></a><span class="lineno"> 5326</span>&#160;    numitermodenormal += (methodindex[<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a698402bc5dc720863bbf11c90786520d">ITERMODEINDEX</a>] == <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab9c7390f62ef08325e12b7110621d33a">ITERMODENORMAL</a>);</div>
<div class="line"><a name="l05327"></a><span class="lineno"> 5327</span>&#160;    numitermodestages += (methodindex[<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a698402bc5dc720863bbf11c90786520d">ITERMODEINDEX</a>] == <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a480c56e263c4874ccb40f3bbc1b32032">ITERMODESTAGES</a>);</div>
<div class="line"><a name="l05328"></a><span class="lineno"> 5328</span>&#160;    numitermodecold += (methodindex[<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a698402bc5dc720863bbf11c90786520d">ITERMODEINDEX</a>] == <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a18693ca111670c1ff38ab2206f70c81e">ITERMODECOLD</a>);</div>
<div class="line"><a name="l05329"></a><span class="lineno"> 5329</span>&#160;</div>
<div class="line"><a name="l05330"></a><span class="lineno"> 5330</span>&#160;</div>
<div class="line"><a name="l05331"></a><span class="lineno"> 5331</span>&#160;</div>
<div class="line"><a name="l05332"></a><span class="lineno"> 5332</span>&#160;</div>
<div class="line"><a name="l05333"></a><span class="lineno"> 5333</span>&#160;    <span class="comment">// i=j=k=0 just to show infrequently</span></div>
<div class="line"><a name="l05334"></a><span class="lineno"> 5334</span>&#160;    <span class="keywordflow">if</span>(debugfail&gt;=2 &amp;&amp; (ptrgeom-&gt;i==0 &amp;&amp; ptrgeom-&gt;j==0  &amp;&amp; ptrgeom-&gt;k==0)){</div>
<div class="line"><a name="l05335"></a><span class="lineno"> 5335</span>&#160;      dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;nstep=%ld numimplicits=%lld numexplicitsgood=%lld numexplicitskindabad=%lld numexplicitsbad=%lld : numenergy=%lld numentropy=%lld numboth=%lld numcold=%lld : numbad=%lld : numramesh=%lld numrameshenergy=%lld numrameshentropy=%lld : averagef1iter=%g averageiter=%g  : numqtypmhd=%lld numqtyumhd=%lld numqtyprad=%lld numqtyurad=%lld numqtyentropyumhd=%lld numqtyentropypmhd=%lld numitermodenormal=%lld numitermodestages=%lld numitermodecold=%lld\n&quot;</span>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a1a1088d87617078680f1fd0f0d707384">nstep</a>,numimplicits,numexplicitsgood,numexplicitskindabad,numexplicitsbad,numenergy,numentropy,numboth,numcold,numbad,numramesh,numrameshenergy,numrameshentropy,(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a>)numoff1iter/(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a09c78d2f8feb311dd9fc969a0bf84979">SMALL</a>+(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a>)numimplicits),(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a>)numofiter/(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a09c78d2f8feb311dd9fc969a0bf84979">SMALL</a>+(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a>)numimplicits),numqtypmhd,numqtyumhd,numqtyprad,numqtyurad,numqtyentropyumhd,numqtyentropypmhd,numitermodenormal,numitermodestages,numitermodecold);</div>
<div class="line"><a name="l05336"></a><span class="lineno"> 5336</span>&#160;      <span class="comment">// counters for which method was *attempted* even if not used</span></div>
<div class="line"><a name="l05337"></a><span class="lineno"> 5337</span>&#160;      <span class="keywordtype">int</span> oo;</div>
<div class="line"><a name="l05338"></a><span class="lineno"> 5338</span>&#160;      dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;tryenergy: &quot;</span>);</div>
<div class="line"><a name="l05339"></a><span class="lineno"> 5339</span>&#160;      <span class="keywordflow">for</span>(oo=0;oo&lt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8076bfd08bb8012f9711601a7364d93c">NUMPHASES</a>;oo++) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;%lld &quot;</span>,tryphaselistenergy[oo]);</div>
<div class="line"><a name="l05340"></a><span class="lineno"> 5340</span>&#160;      dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line"><a name="l05341"></a><span class="lineno"> 5341</span>&#160;      dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;tryentropy: &quot;</span>);</div>
<div class="line"><a name="l05342"></a><span class="lineno"> 5342</span>&#160;      <span class="keywordflow">for</span>(oo=0;oo&lt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a490d03249c544ac789d91c742057394e">NUMPHASESENT</a>;oo++) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;%lld &quot;</span>,tryphaselistentropy[oo]);</div>
<div class="line"><a name="l05343"></a><span class="lineno"> 5343</span>&#160;      dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line"><a name="l05344"></a><span class="lineno"> 5344</span>&#160;      dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;trycold: &quot;</span>);</div>
<div class="line"><a name="l05345"></a><span class="lineno"> 5345</span>&#160;      <span class="keywordflow">for</span>(oo=0;oo&lt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a12af67299c9e98e2eeef308ad46e3e0e">NUMPHASESCOLD</a>;oo++) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;%lld &quot;</span>,tryphaselistcold[oo]);</div>
<div class="line"><a name="l05346"></a><span class="lineno"> 5346</span>&#160;      dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line"><a name="l05347"></a><span class="lineno"> 5347</span>&#160;    }</div>
<div class="line"><a name="l05348"></a><span class="lineno"> 5348</span>&#160;    </div>
<div class="line"><a name="l05349"></a><span class="lineno"> 5349</span>&#160;    numhisterr0[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>((<span class="keywordtype">int</span>)(-log10l(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a09c78d2f8feb311dd9fc969a0bf84979">SMALL</a>+errorabs[0])),<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a382d31e35ac680932f0e2b78b42cf75f">NUMNUMHIST</a>-1),0)]++;</div>
<div class="line"><a name="l05350"></a><span class="lineno"> 5350</span>&#160;    numhisterr1[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>((<span class="keywordtype">int</span>)(-log10l(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a09c78d2f8feb311dd9fc969a0bf84979">SMALL</a>+errorabs[1])),<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a382d31e35ac680932f0e2b78b42cf75f">NUMNUMHIST</a>-1),0)]++;</div>
<div class="line"><a name="l05351"></a><span class="lineno"> 5351</span>&#160;    numhistiter[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(iters,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a58cca3253f4dfcefde5fe864699e297a">IMPMAXITERLONG</a>),0)]++;</div>
<div class="line"><a name="l05352"></a><span class="lineno"> 5352</span>&#160;<span class="preprocessor">#define HISTREPORTSTEP (DTr) //something infrequent but not too much so</span></div>
<div class="line"><a name="l05353"></a><span class="lineno"> 5353</span>&#160;<span class="preprocessor"></span>    <span class="keywordflow">if</span>(debugfail&gt;=2 &amp;&amp; <a class="code" href="../../d8/d5b/defs_8general_8h.html#a1a1088d87617078680f1fd0f0d707384">nstep</a>%<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a95c5484e82aa3e2043aac14b968ca3cb">HISTREPORTSTEP</a>==0 &amp;&amp; ptrgeom-&gt;i==0 &amp;&amp; ptrgeom-&gt;j==0 &amp;&amp; ptrgeom-&gt;k==0){</div>
<div class="line"><a name="l05354"></a><span class="lineno"> 5354</span>&#160;      <span class="keywordtype">int</span> histi;</div>
<div class="line"><a name="l05355"></a><span class="lineno"> 5355</span>&#160;      <span class="keywordflow">for</span>(histi=0;histi&lt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a382d31e35ac680932f0e2b78b42cf75f">NUMNUMHIST</a>;histi++){</div>
<div class="line"><a name="l05356"></a><span class="lineno"> 5356</span>&#160;        dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;numhisterr%d=%lld %lld\n&quot;</span>,histi,numhisterr0[histi],numhisterr1[histi]);</div>
<div class="line"><a name="l05357"></a><span class="lineno"> 5357</span>&#160;      }</div>
<div class="line"><a name="l05358"></a><span class="lineno"> 5358</span>&#160;      <span class="keywordflow">for</span>(histi=0;histi&lt;=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a58cca3253f4dfcefde5fe864699e297a">IMPMAXITERLONG</a>;histi++){</div>
<div class="line"><a name="l05359"></a><span class="lineno"> 5359</span>&#160;        dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;numhistiter%d=%lld\n&quot;</span>,histi,numhistiter[histi]);</div>
<div class="line"><a name="l05360"></a><span class="lineno"> 5360</span>&#160;      }</div>
<div class="line"><a name="l05361"></a><span class="lineno"> 5361</span>&#160;    }</div>
<div class="line"><a name="l05362"></a><span class="lineno"> 5362</span>&#160;</div>
<div class="line"><a name="l05363"></a><span class="lineno"> 5363</span>&#160;    <span class="comment">// only need to get totals over cores when need to show result</span></div>
<div class="line"><a name="l05364"></a><span class="lineno"> 5364</span>&#160;    <span class="comment">// i=j=k=0 just to show infrequently</span></div>
<div class="line"><a name="l05365"></a><span class="lineno"> 5365</span>&#160;<span class="preprocessor">#define GETCOLLECTIVETOTALS ( (debugfail&gt;=2 || PRODUCTION&lt;=1 &amp;&amp; nstep%HISTREPORTSTEP==0 &amp;&amp; steppart==0 ) &amp;&amp; (ptrgeom-&gt;i==0 &amp;&amp; ptrgeom-&gt;j==0  &amp;&amp; ptrgeom-&gt;k==0) )</span></div>
<div class="line"><a name="l05366"></a><span class="lineno"> 5366</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l05367"></a><span class="lineno"> 5367</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a0694dc97a4e18663c011cbbe658a9b30">GETCOLLECTIVETOTALS</a>){</div>
<div class="line"><a name="l05368"></a><span class="lineno"> 5368</span>&#160;      <span class="comment">// over all cores</span></div>
<div class="line"><a name="l05369"></a><span class="lineno"> 5369</span>&#160;      <span class="keywordflow">if</span>(USEMPI){</div>
<div class="line"><a name="l05370"></a><span class="lineno"> 5370</span>&#160;<span class="preprocessor">#if(USEMPI)</span></div>
<div class="line"><a name="l05371"></a><span class="lineno"> 5371</span>&#160;<span class="preprocessor"></span>        MPI_Reduce(&amp;numimplicits, &amp;totalnumimplicits, 1, MPI_LONG_LONG_INT, MPI_SUM, MPIid[0], MPI_COMM_GRMHD);</div>
<div class="line"><a name="l05372"></a><span class="lineno"> 5372</span>&#160;        MPI_Reduce(&amp;numexplicitsgood, &amp;totalnumexplicitsgood, 1, MPI_LONG_LONG_INT, MPI_SUM, MPIid[0], MPI_COMM_GRMHD);</div>
<div class="line"><a name="l05373"></a><span class="lineno"> 5373</span>&#160;        MPI_Reduce(&amp;numexplicitskindabad, &amp;totalnumexplicitskindabad, 1, MPI_LONG_LONG_INT, MPI_SUM, MPIid[0], MPI_COMM_GRMHD);</div>
<div class="line"><a name="l05374"></a><span class="lineno"> 5374</span>&#160;        MPI_Reduce(&amp;numexplicitsbad, &amp;totalnumexplicitsbad, 1, MPI_LONG_LONG_INT, MPI_SUM, MPIid[0], MPI_COMM_GRMHD);</div>
<div class="line"><a name="l05375"></a><span class="lineno"> 5375</span>&#160;        MPI_Reduce(&amp;numoff1iter, &amp;totalnumoff1iter, 1, MPI_LONG_LONG_INT, MPI_SUM, MPIid[0], MPI_COMM_GRMHD);</div>
<div class="line"><a name="l05376"></a><span class="lineno"> 5376</span>&#160;        MPI_Reduce(&amp;numofiter, &amp;totalnumofiter, 1, MPI_LONG_LONG_INT, MPI_SUM, MPIid[0], MPI_COMM_GRMHD);</div>
<div class="line"><a name="l05377"></a><span class="lineno"> 5377</span>&#160;        MPI_Reduce(&amp;numenergy, &amp;totalnumenergy, 1, MPI_LONG_LONG_INT, MPI_SUM, MPIid[0], MPI_COMM_GRMHD);</div>
<div class="line"><a name="l05378"></a><span class="lineno"> 5378</span>&#160;        MPI_Reduce(&amp;numentropy, &amp;totalnumentropy, 1, MPI_LONG_LONG_INT, MPI_SUM, MPIid[0], MPI_COMM_GRMHD);</div>
<div class="line"><a name="l05379"></a><span class="lineno"> 5379</span>&#160;        MPI_Reduce(&amp;numboth, &amp;totalnumboth, 1, MPI_LONG_LONG_INT, MPI_SUM, MPIid[0], MPI_COMM_GRMHD);</div>
<div class="line"><a name="l05380"></a><span class="lineno"> 5380</span>&#160;        MPI_Reduce(&amp;numcold, &amp;totalnumcold, 1, MPI_LONG_LONG_INT, MPI_SUM, MPIid[0], MPI_COMM_GRMHD);</div>
<div class="line"><a name="l05381"></a><span class="lineno"> 5381</span>&#160;        MPI_Reduce(&amp;numbad, &amp;totalnumbad, 1, MPI_LONG_LONG_INT, MPI_SUM, MPIid[0], MPI_COMM_GRMHD);</div>
<div class="line"><a name="l05382"></a><span class="lineno"> 5382</span>&#160;        MPI_Reduce(&amp;numramesh, &amp;totalnumramesh, 1, MPI_LONG_LONG_INT, MPI_SUM, MPIid[0], MPI_COMM_GRMHD);</div>
<div class="line"><a name="l05383"></a><span class="lineno"> 5383</span>&#160;        MPI_Reduce(&amp;numrameshenergy, &amp;totalnumrameshenergy, 1, MPI_LONG_LONG_INT, MPI_SUM, MPIid[0], MPI_COMM_GRMHD);</div>
<div class="line"><a name="l05384"></a><span class="lineno"> 5384</span>&#160;        MPI_Reduce(&amp;numrameshentropy, &amp;totalnumrameshentropy, 1, MPI_LONG_LONG_INT, MPI_SUM, MPIid[0], MPI_COMM_GRMHD);</div>
<div class="line"><a name="l05385"></a><span class="lineno"> 5385</span>&#160;</div>
<div class="line"><a name="l05386"></a><span class="lineno"> 5386</span>&#160;        MPI_Reduce(&amp;numqtypmhd, &amp;totalnumqtypmhd, 1, MPI_LONG_LONG_INT, MPI_SUM, MPIid[0], MPI_COMM_GRMHD);</div>
<div class="line"><a name="l05387"></a><span class="lineno"> 5387</span>&#160;        MPI_Reduce(&amp;numqtyumhd, &amp;totalnumqtyumhd, 1, MPI_LONG_LONG_INT, MPI_SUM, MPIid[0], MPI_COMM_GRMHD);</div>
<div class="line"><a name="l05388"></a><span class="lineno"> 5388</span>&#160;        MPI_Reduce(&amp;numqtyprad, &amp;totalnumqtyprad, 1, MPI_LONG_LONG_INT, MPI_SUM, MPIid[0], MPI_COMM_GRMHD);</div>
<div class="line"><a name="l05389"></a><span class="lineno"> 5389</span>&#160;        MPI_Reduce(&amp;numqtyurad, &amp;totalnumqtyurad, 1, MPI_LONG_LONG_INT, MPI_SUM, MPIid[0], MPI_COMM_GRMHD);</div>
<div class="line"><a name="l05390"></a><span class="lineno"> 5390</span>&#160;        MPI_Reduce(&amp;numqtyentropyumhd, &amp;totalnumqtyentropyumhd, 1, MPI_LONG_LONG_INT, MPI_SUM, MPIid[0], MPI_COMM_GRMHD);</div>
<div class="line"><a name="l05391"></a><span class="lineno"> 5391</span>&#160;        MPI_Reduce(&amp;numqtyentropypmhd, &amp;totalnumqtyentropypmhd, 1, MPI_LONG_LONG_INT, MPI_SUM, MPIid[0], MPI_COMM_GRMHD);</div>
<div class="line"><a name="l05392"></a><span class="lineno"> 5392</span>&#160;        MPI_Reduce(&amp;numitermodenormal, &amp;totalnumitermodenormal, 1, MPI_LONG_LONG_INT, MPI_SUM, MPIid[0], MPI_COMM_GRMHD);</div>
<div class="line"><a name="l05393"></a><span class="lineno"> 5393</span>&#160;        MPI_Reduce(&amp;numitermodestages, &amp;totalnumitermodestages, 1, MPI_LONG_LONG_INT, MPI_SUM, MPIid[0], MPI_COMM_GRMHD);</div>
<div class="line"><a name="l05394"></a><span class="lineno"> 5394</span>&#160;</div>
<div class="line"><a name="l05395"></a><span class="lineno"> 5395</span>&#160;        MPI_Reduce(numhisterr0, totalnumhisterr0, <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a382d31e35ac680932f0e2b78b42cf75f">NUMNUMHIST</a>, MPI_LONG_LONG_INT, MPI_SUM, MPIid[0], MPI_COMM_GRMHD);</div>
<div class="line"><a name="l05396"></a><span class="lineno"> 5396</span>&#160;        MPI_Reduce(numhisterr1, totalnumhisterr1, <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a382d31e35ac680932f0e2b78b42cf75f">NUMNUMHIST</a>, MPI_LONG_LONG_INT, MPI_SUM, MPIid[0], MPI_COMM_GRMHD);</div>
<div class="line"><a name="l05397"></a><span class="lineno"> 5397</span>&#160;        MPI_Reduce(numhistiter, totalnumhistiter, <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a58cca3253f4dfcefde5fe864699e297a">IMPMAXITERLONG</a>+1, MPI_LONG_LONG_INT, MPI_SUM, MPIid[0], MPI_COMM_GRMHD);</div>
<div class="line"><a name="l05398"></a><span class="lineno"> 5398</span>&#160;</div>
<div class="line"><a name="l05399"></a><span class="lineno"> 5399</span>&#160;        <span class="comment">// attempt counters</span></div>
<div class="line"><a name="l05400"></a><span class="lineno"> 5400</span>&#160;        MPI_Reduce(tryphaselistenergy, totaltryphaselistenergy, <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8076bfd08bb8012f9711601a7364d93c">NUMPHASES</a>, MPI_LONG_LONG_INT, MPI_SUM, MPIid[0], MPI_COMM_GRMHD);</div>
<div class="line"><a name="l05401"></a><span class="lineno"> 5401</span>&#160;        MPI_Reduce(tryphaselistentropy, totaltryphaselistentropy, <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a490d03249c544ac789d91c742057394e">NUMPHASESENT</a>, MPI_LONG_LONG_INT, MPI_SUM, MPIid[0], MPI_COMM_GRMHD);</div>
<div class="line"><a name="l05402"></a><span class="lineno"> 5402</span>&#160;        MPI_Reduce(tryphaselistcold, totaltryphaselistcold, <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a12af67299c9e98e2eeef308ad46e3e0e">NUMPHASESCOLD</a>, MPI_LONG_LONG_INT, MPI_SUM, MPIid[0], MPI_COMM_GRMHD);</div>
<div class="line"><a name="l05403"></a><span class="lineno"> 5403</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l05404"></a><span class="lineno"> 5404</span>&#160;<span class="preprocessor"></span>      }</div>
<div class="line"><a name="l05405"></a><span class="lineno"> 5405</span>&#160;      <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l05406"></a><span class="lineno"> 5406</span>&#160;        totalnumimplicits=numimplicits;</div>
<div class="line"><a name="l05407"></a><span class="lineno"> 5407</span>&#160;        totalnumexplicitsgood=numexplicitsgood;</div>
<div class="line"><a name="l05408"></a><span class="lineno"> 5408</span>&#160;        totalnumexplicitskindabad=numexplicitskindabad;</div>
<div class="line"><a name="l05409"></a><span class="lineno"> 5409</span>&#160;        totalnumexplicitsbad=numexplicitsbad;</div>
<div class="line"><a name="l05410"></a><span class="lineno"> 5410</span>&#160;        totalnumoff1iter=numoff1iter;</div>
<div class="line"><a name="l05411"></a><span class="lineno"> 5411</span>&#160;        totalnumofiter=numofiter;</div>
<div class="line"><a name="l05412"></a><span class="lineno"> 5412</span>&#160;        totalnumenergy=numenergy;</div>
<div class="line"><a name="l05413"></a><span class="lineno"> 5413</span>&#160;        totalnumentropy=numentropy;</div>
<div class="line"><a name="l05414"></a><span class="lineno"> 5414</span>&#160;        totalnumboth=numboth;</div>
<div class="line"><a name="l05415"></a><span class="lineno"> 5415</span>&#160;        totalnumcold=numcold;</div>
<div class="line"><a name="l05416"></a><span class="lineno"> 5416</span>&#160;        totalnumbad=numbad;</div>
<div class="line"><a name="l05417"></a><span class="lineno"> 5417</span>&#160;        totalnumramesh=numramesh;</div>
<div class="line"><a name="l05418"></a><span class="lineno"> 5418</span>&#160;        totalnumrameshenergy=numrameshenergy;</div>
<div class="line"><a name="l05419"></a><span class="lineno"> 5419</span>&#160;        totalnumrameshentropy=numrameshentropy;</div>
<div class="line"><a name="l05420"></a><span class="lineno"> 5420</span>&#160;</div>
<div class="line"><a name="l05421"></a><span class="lineno"> 5421</span>&#160;        totalnumqtypmhd=numqtypmhd;</div>
<div class="line"><a name="l05422"></a><span class="lineno"> 5422</span>&#160;        totalnumqtyumhd=numqtyumhd;</div>
<div class="line"><a name="l05423"></a><span class="lineno"> 5423</span>&#160;        totalnumqtyprad=numqtyprad;</div>
<div class="line"><a name="l05424"></a><span class="lineno"> 5424</span>&#160;        totalnumqtyurad=numqtyurad;</div>
<div class="line"><a name="l05425"></a><span class="lineno"> 5425</span>&#160;        totalnumqtyentropyumhd=numqtyentropyumhd;</div>
<div class="line"><a name="l05426"></a><span class="lineno"> 5426</span>&#160;        totalnumqtyentropypmhd=numqtyentropypmhd;</div>
<div class="line"><a name="l05427"></a><span class="lineno"> 5427</span>&#160;        totalnumitermodenormal=numitermodenormal;</div>
<div class="line"><a name="l05428"></a><span class="lineno"> 5428</span>&#160;        totalnumitermodestages=numitermodestages;</div>
<div class="line"><a name="l05429"></a><span class="lineno"> 5429</span>&#160;</div>
<div class="line"><a name="l05430"></a><span class="lineno"> 5430</span>&#160;        <span class="keywordtype">int</span> histi;</div>
<div class="line"><a name="l05431"></a><span class="lineno"> 5431</span>&#160;        <span class="keywordflow">for</span>(histi=0;histi&lt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a382d31e35ac680932f0e2b78b42cf75f">NUMNUMHIST</a>;histi++){</div>
<div class="line"><a name="l05432"></a><span class="lineno"> 5432</span>&#160;          totalnumhisterr0[histi]=numhisterr0[histi];</div>
<div class="line"><a name="l05433"></a><span class="lineno"> 5433</span>&#160;          totalnumhisterr1[histi]=numhisterr1[histi];</div>
<div class="line"><a name="l05434"></a><span class="lineno"> 5434</span>&#160;        }</div>
<div class="line"><a name="l05435"></a><span class="lineno"> 5435</span>&#160;        <span class="keywordflow">for</span>(histi=0;histi&lt;=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a58cca3253f4dfcefde5fe864699e297a">IMPMAXITERLONG</a>;histi++){</div>
<div class="line"><a name="l05436"></a><span class="lineno"> 5436</span>&#160;          totalnumhistiter[histi]=numhistiter[histi];</div>
<div class="line"><a name="l05437"></a><span class="lineno"> 5437</span>&#160;        }</div>
<div class="line"><a name="l05438"></a><span class="lineno"> 5438</span>&#160;</div>
<div class="line"><a name="l05439"></a><span class="lineno"> 5439</span>&#160;        <span class="keywordtype">int</span> oo;</div>
<div class="line"><a name="l05440"></a><span class="lineno"> 5440</span>&#160;        <span class="keywordflow">for</span>(oo=0;oo&lt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8076bfd08bb8012f9711601a7364d93c">NUMPHASES</a>;oo++){</div>
<div class="line"><a name="l05441"></a><span class="lineno"> 5441</span>&#160;          totaltryphaselistenergy[oo]=tryphaselistenergy[oo];</div>
<div class="line"><a name="l05442"></a><span class="lineno"> 5442</span>&#160;        }</div>
<div class="line"><a name="l05443"></a><span class="lineno"> 5443</span>&#160;        <span class="keywordflow">for</span>(oo=0;oo&lt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a490d03249c544ac789d91c742057394e">NUMPHASESENT</a>;oo++){</div>
<div class="line"><a name="l05444"></a><span class="lineno"> 5444</span>&#160;          totaltryphaselistentropy[oo]=tryphaselistentropy[oo];</div>
<div class="line"><a name="l05445"></a><span class="lineno"> 5445</span>&#160;        }</div>
<div class="line"><a name="l05446"></a><span class="lineno"> 5446</span>&#160;        <span class="keywordflow">for</span>(oo=0;oo&lt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a12af67299c9e98e2eeef308ad46e3e0e">NUMPHASESCOLD</a>;oo++){</div>
<div class="line"><a name="l05447"></a><span class="lineno"> 5447</span>&#160;          totaltryphaselistcold[oo]=tryphaselistcold[oo];</div>
<div class="line"><a name="l05448"></a><span class="lineno"> 5448</span>&#160;        }</div>
<div class="line"><a name="l05449"></a><span class="lineno"> 5449</span>&#160;      }</div>
<div class="line"><a name="l05450"></a><span class="lineno"> 5450</span>&#160;</div>
<div class="line"><a name="l05451"></a><span class="lineno"> 5451</span>&#160;      <span class="keywordflow">if</span>(myid==MPIid[0]){<span class="comment">// only show result on one core that got the final result     </span></div>
<div class="line"><a name="l05452"></a><span class="lineno"> 5452</span>&#160;        dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;nstep=%ld totalnumimplicits=%lld totalnumexplicitsgood=%lld totalnumexplicitskindabad=%lld totalnumexplicitsbad=%lld : totalnumenergy=%lld totalnumentropy=%lld totalnumboth=%lld totalnumcold=%lld : totalnumbad=%lld : totalnumramesh=%lld totalnumrameshenergy=%lld totalnumrameshentropy=%lld : totalaveragef1iter=%g totalaverageiter=%g  : totalnumqtypmhd=%lld totalnumqtyumhd=%lld totalnumqtyprad=%lld totalnumqtyurad=%lld totalnumqtyentropyumhd=%lld totalnumqtyentropypmhd=%lld totalnumitermodenormal=%lld totalnumitermodestages=%lld totalnumitermodecold=%lld\n&quot;</span>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a1a1088d87617078680f1fd0f0d707384">nstep</a>,totalnumimplicits,totalnumexplicitsgood,totalnumexplicitskindabad,totalnumexplicitsbad,totalnumenergy,totalnumentropy,totalnumboth,totalnumcold,totalnumbad,totalnumramesh,totalnumrameshenergy,totalnumrameshentropy,(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a>)totalnumoff1iter/(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a09c78d2f8feb311dd9fc969a0bf84979">SMALL</a>+(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a>)totalnumimplicits),(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a>)totalnumofiter/(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a09c78d2f8feb311dd9fc969a0bf84979">SMALL</a>+(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a>)totalnumimplicits),totalnumqtypmhd,totalnumqtyumhd,totalnumqtyprad,totalnumqtyurad,totalnumqtyentropyumhd,totalnumqtyentropypmhd,totalnumitermodenormal,totalnumitermodestages,totalnumitermodecold);</div>
<div class="line"><a name="l05453"></a><span class="lineno"> 5453</span>&#160;        <span class="comment">// counters for which method was *attempted* even if not used</span></div>
<div class="line"><a name="l05454"></a><span class="lineno"> 5454</span>&#160;        <span class="keywordtype">int</span> oo;</div>
<div class="line"><a name="l05455"></a><span class="lineno"> 5455</span>&#160;        dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;totaltryenergy: &quot;</span>);</div>
<div class="line"><a name="l05456"></a><span class="lineno"> 5456</span>&#160;        <span class="keywordflow">for</span>(oo=0;oo&lt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8076bfd08bb8012f9711601a7364d93c">NUMPHASES</a>;oo++) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;%lld &quot;</span>,totaltryphaselistenergy[oo]);</div>
<div class="line"><a name="l05457"></a><span class="lineno"> 5457</span>&#160;        dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line"><a name="l05458"></a><span class="lineno"> 5458</span>&#160;        dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;totaltryentropy: &quot;</span>);</div>
<div class="line"><a name="l05459"></a><span class="lineno"> 5459</span>&#160;        <span class="keywordflow">for</span>(oo=0;oo&lt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a490d03249c544ac789d91c742057394e">NUMPHASESENT</a>;oo++) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;%lld &quot;</span>,totaltryphaselistentropy[oo]);</div>
<div class="line"><a name="l05460"></a><span class="lineno"> 5460</span>&#160;        dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line"><a name="l05461"></a><span class="lineno"> 5461</span>&#160;        dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;totaltrycold: &quot;</span>);</div>
<div class="line"><a name="l05462"></a><span class="lineno"> 5462</span>&#160;        <span class="keywordflow">for</span>(oo=0;oo&lt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a12af67299c9e98e2eeef308ad46e3e0e">NUMPHASESCOLD</a>;oo++) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;%lld &quot;</span>,totaltryphaselistcold[oo]);</div>
<div class="line"><a name="l05463"></a><span class="lineno"> 5463</span>&#160;        dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line"><a name="l05464"></a><span class="lineno"> 5464</span>&#160;      </div>
<div class="line"><a name="l05465"></a><span class="lineno"> 5465</span>&#160;        <span class="keywordflow">if</span>(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a1a1088d87617078680f1fd0f0d707384">nstep</a>%<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a95c5484e82aa3e2043aac14b968ca3cb">HISTREPORTSTEP</a>==0){</div>
<div class="line"><a name="l05466"></a><span class="lineno"> 5466</span>&#160;          <span class="keywordtype">int</span> histi;</div>
<div class="line"><a name="l05467"></a><span class="lineno"> 5467</span>&#160;          <span class="keywordflow">for</span>(histi=0;histi&lt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a382d31e35ac680932f0e2b78b42cf75f">NUMNUMHIST</a>;histi++){</div>
<div class="line"><a name="l05468"></a><span class="lineno"> 5468</span>&#160;            trifprintf(<span class="stringliteral">&quot;totalnumhisterr%d=%lld %lld\n&quot;</span>,histi,totalnumhisterr0[histi],totalnumhisterr1[histi]);</div>
<div class="line"><a name="l05469"></a><span class="lineno"> 5469</span>&#160;          }</div>
<div class="line"><a name="l05470"></a><span class="lineno"> 5470</span>&#160;          <span class="keywordflow">for</span>(histi=0;histi&lt;=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a58cca3253f4dfcefde5fe864699e297a">IMPMAXITERLONG</a>;histi++){</div>
<div class="line"><a name="l05471"></a><span class="lineno"> 5471</span>&#160;            trifprintf(<span class="stringliteral">&quot;totalnumhistiter%d=%lld\n&quot;</span>,histi,totalnumhistiter[histi]);</div>
<div class="line"><a name="l05472"></a><span class="lineno"> 5472</span>&#160;          }</div>
<div class="line"><a name="l05473"></a><span class="lineno"> 5473</span>&#160;        }</div>
<div class="line"><a name="l05474"></a><span class="lineno"> 5474</span>&#160;      }<span class="comment">// end if myid==0</span></div>
<div class="line"><a name="l05475"></a><span class="lineno"> 5475</span>&#160;    }<span class="comment">// end if getting totals</span></div>
<div class="line"><a name="l05476"></a><span class="lineno"> 5476</span>&#160;  }<span class="comment">// end if ok production level to get these diags</span></div>
<div class="line"><a name="l05477"></a><span class="lineno"> 5477</span>&#160;</div>
<div class="line"><a name="l05478"></a><span class="lineno"> 5478</span>&#160;</div>
<div class="line"><a name="l05479"></a><span class="lineno"> 5479</span>&#160;</div>
<div class="line"><a name="l05480"></a><span class="lineno"> 5480</span>&#160;  <span class="keywordflow">return</span>(failfinalreturn);</div>
<div class="line"><a name="l05481"></a><span class="lineno"> 5481</span>&#160;}</div>
<div class="line"><a name="l05482"></a><span class="lineno"> 5482</span>&#160;</div>
<div class="line"><a name="l05483"></a><span class="lineno"> 5483</span>&#160;</div>
<div class="line"><a name="l05484"></a><span class="lineno"> 5484</span>&#160;</div>
<div class="line"><a name="l05485"></a><span class="lineno"> 5485</span>&#160;</div>
<div class="line"><a name="l05486"></a><span class="lineno"> 5486</span>&#160;</div>
<div class="line"><a name="l05487"></a><span class="lineno"> 5487</span>&#160;</div>
<div class="line"><a name="l05488"></a><span class="lineno"> 5488</span>&#160;</div>
<div class="line"><a name="l05491"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a17aede36203a236390363af78d3a86f0"> 5491</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a17aede36203a236390363af78d3a86f0" title="compute changes to U (both T and R) using implicit method KORALTODO: If doing implicit, should also add geometry source term that can sometimes be stiff.">koral_source_rad_implicit_mode</a>(<span class="keywordtype">int</span> modemethodlocal, <span class="keywordtype">int</span> allowbaseitermethodswitch, <span class="keywordtype">int</span> modprim, <span class="keywordtype">int</span> havebackup, <span class="keywordtype">int</span> didentropyalready, <span class="keywordtype">int</span> *eomtype, <span class="keywordtype">int</span> whichcap, <span class="keywordtype">int</span> itermode, <span class="keywordtype">int</span> *baseitermethod, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> trueimptryconv, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> trueimpokconv, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> trueimpallowconv, <span class="keywordtype">int</span> trueimpmaxiter, <span class="keywordtype">int</span> truenumdampattempts, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fracenergy, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dissmeasure, <span class="keywordtype">int</span> *radinvmod, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pb, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *uub, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *piin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Uiin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ufin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUf, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUimp, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *q, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *dUother ,<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*dUcomp)[NPR], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *errorabsreturn, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *errorabsbestexternal, <span class="keywordtype">int</span> *itersreturn, <span class="keywordtype">int</span> *f1itersreturn, <span class="keywordtype">int</span> *nummhdinvsreturn, <span class="keywordtype">int</span> *nummhdstepsreturn)</div>
<div class="line"><a name="l05492"></a><span class="lineno"> 5492</span>&#160;{</div>
<div class="line"><a name="l05493"></a><span class="lineno"> 5493</span>&#160;  <span class="keywordtype">int</span> nstrokeorig=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a5f1c4a4bf07f7a6010404484cb9e6b50">nstroke</a>;</div>
<div class="line"><a name="l05494"></a><span class="lineno"> 5494</span>&#160;  *nummhdinvsreturn=0;</div>
<div class="line"><a name="l05495"></a><span class="lineno"> 5495</span>&#160;  *nummhdstepsreturn=0; <span class="comment">// global number of strokes for this core at this point, add negative so can add position later and get difference additional steps for this _mode() call</span></div>
<div class="line"><a name="l05496"></a><span class="lineno"> 5496</span>&#160;</div>
<div class="line"><a name="l05497"></a><span class="lineno"> 5497</span>&#160;  <span class="comment">// some geometry stuff to store pre-step instead of for each step.</span></div>
<div class="line"><a name="l05498"></a><span class="lineno"> 5498</span>&#160;  <span class="keywordtype">int</span> pliter,pl;</div>
<div class="line"><a name="l05499"></a><span class="lineno"> 5499</span>&#160;  <span class="keywordtype">int</span> jjdim;</div>
<div class="line"><a name="l05500"></a><span class="lineno"> 5500</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dimfactU[NPR];</div>
<div class="line"><a name="l05501"></a><span class="lineno"> 5501</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) dimfactU[pl]=1.0; <span class="comment">// default</span></div>
<div class="line"><a name="l05502"></a><span class="lineno"> 5502</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jjdim) dimfactU[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>+jjdim]=dimfactU[URAD0+jjdim]=sqrt(fabs(ptrgeom-&gt;gcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(jjdim,jjdim)]));</div>
<div class="line"><a name="l05503"></a><span class="lineno"> 5503</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jjdim) dimfactU[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>+jjdim-1] = 1.0/dimfactU[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>+jjdim-1];</div>
<div class="line"><a name="l05504"></a><span class="lineno"> 5504</span>&#160;</div>
<div class="line"><a name="l05505"></a><span class="lineno"> 5505</span>&#160;</div>
<div class="line"><a name="l05506"></a><span class="lineno"> 5506</span>&#160;  <span class="keywordtype">int</span> i1,i2,i3,iv,ii,jj,kk,sc;</div>
<div class="line"><a name="l05507"></a><span class="lineno"> 5507</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> realdt;</div>
<div class="line"><a name="l05508"></a><span class="lineno"> 5508</span>&#160;  <span class="keywordtype">int</span> gotbest,bestfailreturnf;</div>
<div class="line"><a name="l05509"></a><span class="lineno"> 5509</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> iJ[NPR][NPR];</div>
<div class="line"><a name="l05510"></a><span class="lineno"> 5510</span>&#160;</div>
<div class="line"><a name="l05511"></a><span class="lineno"> 5511</span>&#160;  <span class="comment">// store pb as might have didentropyalready=1 and then can use pborig[UU] as entropy&#39;s solution for u_g, and that can be used to create condition to avoid over-iterating with energy solver.</span></div>
<div class="line"><a name="l05512"></a><span class="lineno"> 5512</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> pborig[NPR];</div>
<div class="line"><a name="l05513"></a><span class="lineno"> 5513</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) pborig[pl]=pb[pl];</div>
<div class="line"><a name="l05514"></a><span class="lineno"> 5514</span>&#160;  <span class="keywordtype">int</span> radinvmodorig=*radinvmod;</div>
<div class="line"><a name="l05515"></a><span class="lineno"> 5515</span>&#160;</div>
<div class="line"><a name="l05516"></a><span class="lineno"> 5516</span>&#160;  <span class="comment">//  FTYPE trueimptryconv=IMPTRYCONV;</span></div>
<div class="line"><a name="l05517"></a><span class="lineno"> 5517</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> trueimptryconvabs=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a37aa5c4b7b1b481299d87bf929d13b15" title="error for comparing to sum over all absolute errors">IMPTRYCONVABS</a>;</div>
<div class="line"><a name="l05518"></a><span class="lineno"> 5518</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> trueimptryconvalt=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a3251670ff8087f873c6cac91ca50b16d">IMPTRYCONVALT</a>;</div>
<div class="line"><a name="l05519"></a><span class="lineno"> 5519</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> trueimpokconvabs=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a0beb933bdd5a874f9fcada46b302fbff">IMPOKCONVABS</a>;</div>
<div class="line"><a name="l05520"></a><span class="lineno"> 5520</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> trueimpallowconvabs=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a87254fbd4e77d25faf8405ae2dfbd70c">IMPALLOWCONVABS</a>;</div>
<div class="line"><a name="l05521"></a><span class="lineno"> 5521</span>&#160;</div>
<div class="line"><a name="l05522"></a><span class="lineno"> 5522</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> trueimptryconv_orig=trueimptryconv;</div>
<div class="line"><a name="l05523"></a><span class="lineno"> 5523</span>&#160;</div>
<div class="line"><a name="l05524"></a><span class="lineno"> 5524</span>&#160;<span class="preprocessor">#if(DEBUGMAXITER)</span></div>
<div class="line"><a name="l05525"></a><span class="lineno"> 5525</span>&#160;<span class="preprocessor"></span>  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> pppreholdlist[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a58cca3253f4dfcefde5fe864699e297a">IMPMAXITERLONG</a>+2][NPR]={{0}}; <span class="comment">// for debug</span></div>
<div class="line"><a name="l05526"></a><span class="lineno"> 5526</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ppposholdlist[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a58cca3253f4dfcefde5fe864699e297a">IMPMAXITERLONG</a>+2][NPR]={{0}}; <span class="comment">// for debug</span></div>
<div class="line"><a name="l05527"></a><span class="lineno"> 5527</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> f1reportlist[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a58cca3253f4dfcefde5fe864699e297a">IMPMAXITERLONG</a>+2][NPR]={{0}}; <span class="comment">// for debug</span></div>
<div class="line"><a name="l05528"></a><span class="lineno"> 5528</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> f1list[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a58cca3253f4dfcefde5fe864699e297a">IMPMAXITERLONG</a>+2][NPR]={{0}}; <span class="comment">// for debug</span></div>
<div class="line"><a name="l05529"></a><span class="lineno"> 5529</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> errorabsf1list[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a58cca3253f4dfcefde5fe864699e297a">IMPMAXITERLONG</a>+2]={0}; <span class="comment">// for debug</span></div>
<div class="line"><a name="l05530"></a><span class="lineno"> 5530</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> errorallabsf1list[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a58cca3253f4dfcefde5fe864699e297a">IMPMAXITERLONG</a>+2]={0}; <span class="comment">// for debug</span></div>
<div class="line"><a name="l05531"></a><span class="lineno"> 5531</span>&#160;  <span class="keywordtype">int</span> realiterlist[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a58cca3253f4dfcefde5fe864699e297a">IMPMAXITERLONG</a>+2]; <span class="comment">// for debug</span></div>
<div class="line"><a name="l05532"></a><span class="lineno"> 5532</span>&#160;  set_array(realiterlist,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a58cca3253f4dfcefde5fe864699e297a">IMPMAXITERLONG</a>+2,MPI_INT,-1);</div>
<div class="line"><a name="l05533"></a><span class="lineno"> 5533</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> jaclist[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a58cca3253f4dfcefde5fe864699e297a">IMPMAXITERLONG</a>+2][<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8a1b3014b620253123af842109580dfe">JACNPR</a>][<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>]; <span class="comment">// for debug</span></div>
<div class="line"><a name="l05534"></a><span class="lineno"> 5534</span>&#160;  set_array(jaclist,(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a58cca3253f4dfcefde5fe864699e297a">IMPMAXITERLONG</a>+2)*NDIM*NDIM,MPI_FTYPE,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>);</div>
<div class="line"><a name="l05535"></a><span class="lineno"> 5535</span>&#160;  <span class="keywordtype">int</span> implicititerlist[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a58cca3253f4dfcefde5fe864699e297a">IMPMAXITERLONG</a>+2]={0}; <span class="comment">// for debug</span></div>
<div class="line"><a name="l05536"></a><span class="lineno"> 5536</span>&#160;  <span class="keywordtype">int</span> implicitferrlist[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a58cca3253f4dfcefde5fe864699e297a">IMPMAXITERLONG</a>+2]={0}; <span class="comment">// for debug</span></div>
<div class="line"><a name="l05537"></a><span class="lineno"> 5537</span>&#160;<span class="preprocessor">#define NUMFRACDAMP 10</span></div>
<div class="line"><a name="l05538"></a><span class="lineno"> 5538</span>&#160;<span class="preprocessor"></span>  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fracdamplist[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad75bdfcd506be657fa710e58af467b4d">NUMFRACDAMP</a>]={0};</div>
<div class="line"><a name="l05539"></a><span class="lineno"> 5539</span>&#160;</div>
<div class="line"><a name="l05540"></a><span class="lineno"> 5540</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l05541"></a><span class="lineno"> 5541</span>&#160;<span class="preprocessor"></span>  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> errorabsf1list[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a58cca3253f4dfcefde5fe864699e297a">IMPMAXITERLONG</a>+2]={0}; <span class="comment">// for tracking error</span></div>
<div class="line"><a name="l05542"></a><span class="lineno"> 5542</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> errorallabsf1list[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a58cca3253f4dfcefde5fe864699e297a">IMPMAXITERLONG</a>+2]={0}; <span class="comment">// for tracking error</span></div>
<div class="line"><a name="l05543"></a><span class="lineno"> 5543</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l05544"></a><span class="lineno"> 5544</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l05545"></a><span class="lineno"> 5545</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> uu0[NPR],uup[NPR],uupp[NPR],uuppp[NPR],uu[NPR],uuporig[NPR],uu0orig[NPR],bestuu[NPR];</div>
<div class="line"><a name="l05546"></a><span class="lineno"> 5546</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> pp0[NPR],ppp[NPR],pppp[NPR],ppppp[NPR],pp[NPR],ppporig[NPR],pp0orig[NPR],bestpp[NPR];</div>
<div class="line"><a name="l05547"></a><span class="lineno"> 5547</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> f1[NPR],f1norm[NPR],f1report[NPR],f3report[NPR],lowestf1[NPR],lowestf1norm[NPR],lowestf1report[NPR],lowestf3report[NPR];</div>
<div class="line"><a name="l05548"></a><span class="lineno"> 5548</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> f1p[NPR];</div>
<div class="line"><a name="l05549"></a><span class="lineno"> 5549</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> pppriorsteptype[NPR],uupriorsteptype[NPR];</div>
<div class="line"><a name="l05550"></a><span class="lineno"> 5550</span>&#160;</div>
<div class="line"><a name="l05551"></a><span class="lineno"> 5551</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> radsource[NPR], deltas[NPR]; </div>
<div class="line"><a name="l05552"></a><span class="lineno"> 5552</span>&#160;  <span class="keyword">extern</span> <span class="keywordtype">int</span> mathematica_report_check(<span class="keywordtype">int</span> radinvmod, <span class="keywordtype">int</span> failtype, <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> failnum, <span class="keywordtype">int</span> gotfirstnofail, <span class="keywordtype">int</span> eomtypelocal, <span class="keywordtype">int</span> itermode, <span class="keywordtype">int</span> baseitermethod, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *errorabs, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *errorabsbestexternal, <span class="keywordtype">int</span> iters, <span class="keywordtype">int</span> iterstotal, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> realdt,<span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *ppfirst, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pp, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pb, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *piin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *prtestUiin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *prtestUU0, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *uu0, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *uu, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Uiin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ufin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUf, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUimp, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *q, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *dUother);</div>
<div class="line"><a name="l05553"></a><span class="lineno"> 5553</span>&#160;  <span class="keywordtype">int</span> mathfailtype;</div>
<div class="line"><a name="l05554"></a><span class="lineno"> 5554</span>&#160;</div>
<div class="line"><a name="l05555"></a><span class="lineno"> 5555</span>&#160;</div>
<div class="line"><a name="l05556"></a><span class="lineno"> 5556</span>&#160;  <span class="keywordtype">int</span> eomtypelocal=*eomtype; <span class="comment">// default choice</span></div>
<div class="line"><a name="l05557"></a><span class="lineno"> 5557</span>&#160;  <span class="keywordtype">int</span> allowlocalfailurefixandnoreport=0; <span class="comment">// must be 0 so implicit method knows when really failure</span></div>
<div class="line"><a name="l05558"></a><span class="lineno"> 5558</span>&#160;  <span class="keywordtype">int</span> failreturn=0;</div>
<div class="line"><a name="l05559"></a><span class="lineno"> 5559</span>&#160;</div>
<div class="line"><a name="l05560"></a><span class="lineno"> 5560</span>&#160;</div>
<div class="line"><a name="l05561"></a><span class="lineno"> 5561</span>&#160;</div>
<div class="line"><a name="l05562"></a><span class="lineno"> 5562</span>&#160;  <span class="comment">// DEBUG VARS</span></div>
<div class="line"><a name="l05563"></a><span class="lineno"> 5563</span>&#160;  <span class="keywordtype">int</span> showmessages=0; <span class="comment">// by default 0, don&#39;t show any messages for inversion stuff during implicit solver, unless debugging.  Assume any moment of inversion failure is corrected for now unless failure of final inversion done outside implicit solver.</span></div>
<div class="line"><a name="l05564"></a><span class="lineno"> 5564</span>&#160;  <span class="keywordtype">int</span> showmessagesheavy=0;  <span class="comment">// very detailed for common debugging</span></div>
<div class="line"><a name="l05565"></a><span class="lineno"> 5565</span>&#160;  <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> failnum=0;</div>
<div class="line"><a name="l05566"></a><span class="lineno"> 5566</span>&#160;  </div>
<div class="line"><a name="l05567"></a><span class="lineno"> 5567</span>&#160;  <span class="keywordtype">int</span> doingitsomecpu=0;</div>
<div class="line"><a name="l05568"></a><span class="lineno"> 5568</span>&#160;  <span class="keywordtype">int</span> doingit=0;</div>
<div class="line"><a name="l05569"></a><span class="lineno"> 5569</span>&#160;<span class="preprocessor">#if(0)</span></div>
<div class="line"><a name="l05570"></a><span class="lineno"> 5570</span>&#160;<span class="preprocessor"></span>  <span class="keywordflow">if</span>(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a1a1088d87617078680f1fd0f0d707384">nstep</a>==15 &amp;&amp; <a class="code" href="../../d8/d5b/defs_8general_8h.html#a70170b90229f9fc05eebf8508a685c70">steppart</a>==0 &amp;&amp; ptrgeom-&gt;i==6 &amp;&amp; ptrgeom-&gt;j==8 &amp;&amp; ptrgeom-&gt;k==0){</div>
<div class="line"><a name="l05571"></a><span class="lineno"> 5571</span>&#160;    doingitsomecpu=1;</div>
<div class="line"><a name="l05572"></a><span class="lineno"> 5572</span>&#160;    <span class="keywordflow">if</span>(myid==0){ <span class="comment">// so similar situation and grid at least</span></div>
<div class="line"><a name="l05573"></a><span class="lineno"> 5573</span>&#160;      dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;DOINGIT\n&quot;</span>);</div>
<div class="line"><a name="l05574"></a><span class="lineno"> 5574</span>&#160;      doingit=1;</div>
<div class="line"><a name="l05575"></a><span class="lineno"> 5575</span>&#160;</div>
<div class="line"><a name="l05577"></a><span class="lineno"> 5577</span>&#160;      <span class="comment">// insert FAILRETURN data here.</span></div>
<div class="line"><a name="l05579"></a><span class="lineno"> 5579</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05580"></a><span class="lineno"> 5580</span>&#160;      showmessages=showmessagesheavy=1;</div>
<div class="line"><a name="l05581"></a><span class="lineno"> 5581</span>&#160;    }<span class="comment">// end on doing it core</span></div>
<div class="line"><a name="l05582"></a><span class="lineno"> 5582</span>&#160;  }</div>
<div class="line"><a name="l05583"></a><span class="lineno"> 5583</span>&#160;</div>
<div class="line"><a name="l05584"></a><span class="lineno"> 5584</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l05585"></a><span class="lineno"> 5585</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l05586"></a><span class="lineno"> 5586</span>&#160;</div>
<div class="line"><a name="l05587"></a><span class="lineno"> 5587</span>&#160;</div>
<div class="line"><a name="l05588"></a><span class="lineno"> 5588</span>&#160;</div>
<div class="line"><a name="l05589"></a><span class="lineno"> 5589</span>&#160;</div>
<div class="line"><a name="l05591"></a><span class="lineno"> 5591</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l05592"></a><span class="lineno"> 5592</span>&#160;  <span class="comment">// initialize errors</span></div>
<div class="line"><a name="l05593"></a><span class="lineno"> 5593</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l05595"></a><span class="lineno"> 5595</span>&#160;<span class="comment"></span>  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l05596"></a><span class="lineno"> 5596</span>&#160;    f1[pl]=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>;</div>
<div class="line"><a name="l05597"></a><span class="lineno"> 5597</span>&#160;    f1p[pl]=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>;</div>
<div class="line"><a name="l05598"></a><span class="lineno"> 5598</span>&#160;  }</div>
<div class="line"><a name="l05599"></a><span class="lineno"> 5599</span>&#160;</div>
<div class="line"><a name="l05600"></a><span class="lineno"> 5600</span>&#160;</div>
<div class="line"><a name="l05602"></a><span class="lineno"> 5602</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l05603"></a><span class="lineno"> 5603</span>&#160;  <span class="comment">// setup reversion to best solution for uu in case iterations lead to worse error and reach maximum iterations.</span></div>
<div class="line"><a name="l05604"></a><span class="lineno"> 5604</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l05606"></a><span class="lineno"> 5606</span>&#160;<span class="comment"></span>  gotbest=0;</div>
<div class="line"><a name="l05607"></a><span class="lineno"> 5607</span>&#160;  bestfailreturnf=0;</div>
<div class="line"><a name="l05608"></a><span class="lineno"> 5608</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l05609"></a><span class="lineno"> 5609</span>&#160;    lowestf1[pl]=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>;</div>
<div class="line"><a name="l05610"></a><span class="lineno"> 5610</span>&#160;    lowestf1norm[pl]=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>;</div>
<div class="line"><a name="l05611"></a><span class="lineno"> 5611</span>&#160;    lowestf1report[pl]=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>;</div>
<div class="line"><a name="l05612"></a><span class="lineno"> 5612</span>&#160;    lowestf3report[pl]=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>;</div>
<div class="line"><a name="l05613"></a><span class="lineno"> 5613</span>&#160;  }</div>
<div class="line"><a name="l05614"></a><span class="lineno"> 5614</span>&#160;  <span class="comment">// setup locally-used ppfirst that can pass back as pb if good solution</span></div>
<div class="line"><a name="l05615"></a><span class="lineno"> 5615</span>&#160;  <span class="keywordtype">int</span> gotfirstnofail=0;</div>
<div class="line"><a name="l05616"></a><span class="lineno"> 5616</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ppfirst[NPR];</div>
<div class="line"><a name="l05617"></a><span class="lineno"> 5617</span>&#160;</div>
<div class="line"><a name="l05618"></a><span class="lineno"> 5618</span>&#160;</div>
<div class="line"><a name="l05619"></a><span class="lineno"> 5619</span>&#160;</div>
<div class="line"><a name="l05621"></a><span class="lineno"> 5621</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l05622"></a><span class="lineno"> 5622</span>&#160;  <span class="comment">// setup implicit iteration procedure and loops</span></div>
<div class="line"><a name="l05623"></a><span class="lineno"> 5623</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l05625"></a><span class="lineno"> 5625</span>&#160;<span class="comment"></span>  <span class="keywordtype">int</span> isexplicit=0;</div>
<div class="line"><a name="l05626"></a><span class="lineno"> 5626</span>&#160;  realdt = <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5dcc789108ddf06ec44fb22770f18e90" title="compute dt for this sub-step">compute_dt</a>(isexplicit,CUf, CUimp,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a56db625f31229c5e8b208ff27d464931">dt</a>);</div>
<div class="line"><a name="l05627"></a><span class="lineno"> 5627</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fracdtuu0=1.0,fracdtG=1.0,fracuup=1.0; <span class="comment">// initially try full realstep step</span></div>
<div class="line"><a name="l05628"></a><span class="lineno"> 5628</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fracdtuu0p=fracdtuu0;</div>
<div class="line"><a name="l05629"></a><span class="lineno"> 5629</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fracdtuu0pp=fracdtuu0p;</div>
<div class="line"><a name="l05630"></a><span class="lineno"> 5630</span>&#160;</div>
<div class="line"><a name="l05631"></a><span class="lineno"> 5631</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fracdtGp=fracdtG;</div>
<div class="line"><a name="l05632"></a><span class="lineno"> 5632</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fracdtGpp=fracdtGp;</div>
<div class="line"><a name="l05633"></a><span class="lineno"> 5633</span>&#160;</div>
<div class="line"><a name="l05634"></a><span class="lineno"> 5634</span>&#160;  <span class="keywordtype">int</span> fakeitermethod=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a58cca3253f4dfcefde5fe864699e297a">IMPMAXITERLONG</a>;<span class="comment">// used by normal stepping, so just make maximum</span></div>
<div class="line"><a name="l05635"></a><span class="lineno"> 5635</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../d6/dbe/structof__method.html">of_method</a> mtd;</div>
<div class="line"><a name="l05636"></a><span class="lineno"> 5636</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../d2/d46/structof__ref_u.html">of_refU</a> ru;</div>
<div class="line"><a name="l05637"></a><span class="lineno"> 5637</span>&#160;  define_method(fakeitermethod, &amp;eomtypelocal, itermode, *baseitermethod, fracenergy, dissmeasure, &amp;mtd);</div>
<div class="line"><a name="l05638"></a><span class="lineno"> 5638</span>&#160;  <span class="comment">// no need to define numdims,jacs,refs, or signs yet.</span></div>
<div class="line"><a name="l05639"></a><span class="lineno"> 5639</span>&#160;</div>
<div class="line"><a name="l05640"></a><span class="lineno"> 5640</span>&#160;</div>
<div class="line"><a name="l05641"></a><span class="lineno"> 5641</span>&#160;</div>
<div class="line"><a name="l05643"></a><span class="lineno"> 5643</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l05644"></a><span class="lineno"> 5644</span>&#160;  <span class="comment">// set uu0 = &quot;initial+flux&quot; contribution to uu</span></div>
<div class="line"><a name="l05645"></a><span class="lineno"> 5645</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l05647"></a><span class="lineno"> 5647</span>&#160;<span class="comment"></span>  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dUnongeomall[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0a72db4856620ff1b9551c885f1b32b5">MAXTIMEORDER</a>]={0.0};</div>
<div class="line"><a name="l05648"></a><span class="lineno"> 5648</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) uu[pl]=uu0[pl]=UFSET(CUf,fracdtuu0*<a class="code" href="../../d8/d5b/defs_8general_8h.html#a56db625f31229c5e8b208ff27d464931">dt</a>,Uiin[pl],Ufin[pl],dUother[pl],0.0,dUnongeomall);</div>
<div class="line"><a name="l05649"></a><span class="lineno"> 5649</span>&#160;</div>
<div class="line"><a name="l05650"></a><span class="lineno"> 5650</span>&#160;</div>
<div class="line"><a name="l05651"></a><span class="lineno"> 5651</span>&#160;</div>
<div class="line"><a name="l05652"></a><span class="lineno"> 5652</span>&#160;</div>
<div class="line"><a name="l05654"></a><span class="lineno"> 5654</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l05655"></a><span class="lineno"> 5655</span>&#160;  <span class="comment">// get default failure state from Uiin</span></div>
<div class="line"><a name="l05656"></a><span class="lineno"> 5656</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l05658"></a><span class="lineno"> 5658</span>&#160;<span class="comment"></span>  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> prtestUiin[NPR];</div>
<div class="line"><a name="l05659"></a><span class="lineno"> 5659</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) prtestUiin[pl]=piin[pl]; <span class="comment">// initial guess (should be easy with piin=ppin(Uiin))</span></div>
<div class="line"><a name="l05660"></a><span class="lineno"> 5660</span>&#160;</div>
<div class="line"><a name="l05661"></a><span class="lineno"> 5661</span>&#160;  <span class="comment">//#define GETDEFAULTFAILURESTATE 1 // 1 was normal before.</span></div>
<div class="line"><a name="l05662"></a><span class="lineno"> 5662</span>&#160;<span class="preprocessor">#define GETDEFAULTFAILURESTATE (IMPPMHDTYPE(mtd.implicititer)==0) // with new rad inversion scheme, seems to push through without issue to just let hit gamma ceiling temporarily -- even with RADPULSEPLANAR</span></div>
<div class="line"><a name="l05663"></a><span class="lineno"> 5663</span>&#160;<span class="preprocessor"></span>  <span class="comment">// Otherwise, takes *many* iterations, not just f1iters, to get solution.  Even though that was old code state that was working, not required now.</span></div>
<div class="line"><a name="l05664"></a><span class="lineno"> 5664</span>&#160;</div>
<div class="line"><a name="l05665"></a><span class="lineno"> 5665</span>&#160;</div>
<div class="line"><a name="l05666"></a><span class="lineno"> 5666</span>&#160;  <span class="comment">// default is to allow no failure unless iterating MHD primitives in which case a radiation failure is ok.</span></div>
<div class="line"><a name="l05667"></a><span class="lineno"> 5667</span>&#160;  <span class="keywordtype">int</span> failreturnallowable;</div>
<div class="line"><a name="l05668"></a><span class="lineno"> 5668</span>&#160;</div>
<div class="line"><a name="l05669"></a><span class="lineno"> 5669</span>&#160;  <span class="comment">// no need to worry about RAD failure if not iterating rad quantities</span></div>
<div class="line"><a name="l05670"></a><span class="lineno"> 5670</span>&#160;  <span class="comment">// As stated above, with new rad inversion, seems ok to temporarily hit ceiling.</span></div>
<div class="line"><a name="l05671"></a><span class="lineno"> 5671</span>&#160;  <span class="comment">// With tests like RADTUBE, can&#39;t allow radiative inversion cieling else dies.  While with tests like RADPULSE, fastest to converge to good solution with allowing hitting the ceiling.  So mixed issue.</span></div>
<div class="line"><a name="l05672"></a><span class="lineno"> 5672</span>&#160;  <span class="comment">// With RADTUBE and QTYPMHD, must also avoid rad failure if possible to avoid lack of solution, hence &amp;&amp;0 below.</span></div>
<div class="line"><a name="l05673"></a><span class="lineno"> 5673</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ae0630b7afa58e9ef8f8caf69e619787d" title="whether to avoid back-tracing f1 calculation if rad inv hits cap, just push through if ==1...">TREATRADINVCAPASNONFAILUREFORPMHDMETHOD</a> &amp;&amp; <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a33425cd25de3bba0ed1613fd419efefd" title="MHD or RAD baseitermethod types.">IMPMHDTYPEBASE</a>(*baseitermethod)==1){</div>
<div class="line"><a name="l05674"></a><span class="lineno"> 5674</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a4d6b9e1b70703c6aa1d0f9dd9a7acb6b" title="MHD or RAD type.">IMPMHDTYPE</a>(mtd.<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>)) failreturnallowable=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a3dc38d50c77a49ac41a760b684ad7aab">UTOPRIMGENWRAPPERRETURNFAILRAD</a>;</div>
<div class="line"><a name="l05675"></a><span class="lineno"> 5675</span>&#160;    <span class="keywordflow">else</span> failreturnallowable=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#abdf9e55b7b15ec0bcd386055f1787f47">UTOPRIMNOFAIL</a>;</div>
<div class="line"><a name="l05676"></a><span class="lineno"> 5676</span>&#160;  }</div>
<div class="line"><a name="l05677"></a><span class="lineno"> 5677</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l05678"></a><span class="lineno"> 5678</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a4d6b9e1b70703c6aa1d0f9dd9a7acb6b" title="MHD or RAD type.">IMPMHDTYPE</a>(mtd.<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>)&amp;&amp;0) failreturnallowable=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a3dc38d50c77a49ac41a760b684ad7aab">UTOPRIMGENWRAPPERRETURNFAILRAD</a>;</div>
<div class="line"><a name="l05679"></a><span class="lineno"> 5679</span>&#160;    <span class="keywordflow">else</span> failreturnallowable=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#abdf9e55b7b15ec0bcd386055f1787f47">UTOPRIMNOFAIL</a>;</div>
<div class="line"><a name="l05680"></a><span class="lineno"> 5680</span>&#160;  }</div>
<div class="line"><a name="l05681"></a><span class="lineno"> 5681</span>&#160;</div>
<div class="line"><a name="l05682"></a><span class="lineno"> 5682</span>&#160;  <span class="keywordtype">int</span> failreturnallowableuse=failreturnallowable;</div>
<div class="line"><a name="l05683"></a><span class="lineno"> 5683</span>&#160;  <span class="keywordtype">int</span> failreturnallowablefirst=-1;</div>
<div class="line"><a name="l05684"></a><span class="lineno"> 5684</span>&#160;</div>
<div class="line"><a name="l05685"></a><span class="lineno"> 5685</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab8fea83a2a563e021ff9518477125b29">GETDEFAULTFAILURESTATE</a> &amp;&amp; <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa8c4409b81bebfe2ff9dc6f2f1c2472a" title="PMHD types.">IMPPMHDTYPE</a>(mtd.<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>)==0){    <span class="comment">// No need for failure state if doing MHD iteration using primitives</span></div>
<div class="line"><a name="l05686"></a><span class="lineno"> 5686</span>&#160;    <span class="comment">// KORALTODO: Instead of doing this, just keep inversion error from previously as stored in pflag.  So don&#39;t reset pflag elsewhere in fixup_utoprim() for elsewhere</span></div>
<div class="line"><a name="l05687"></a><span class="lineno"> 5687</span>&#160;    <span class="comment">// Need to get default failure state.  Can allow such an error if having trouble with convergence (e.g. backing up too much)</span></div>
<div class="line"><a name="l05688"></a><span class="lineno"> 5688</span>&#160;</div>
<div class="line"><a name="l05690"></a><span class="lineno"> 5690</span>&#160;    <span class="comment">// be quick about checking this</span></div>
<div class="line"><a name="l05691"></a><span class="lineno"> 5691</span>&#160;    <span class="keyword">struct </span><a class="code" href="../../db/d3a/structof__newtonstats.html">of_newtonstats</a> newtonstats; setnewtonstatsdefault(&amp;newtonstats);</div>
<div class="line"><a name="l05692"></a><span class="lineno"> 5692</span>&#160;    newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a073783ba864c07681c8999a67162202b">nstroke</a>=newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a83280998e47831044a7e35299495a9bb">lntries</a>=0;</div>
<div class="line"><a name="l05693"></a><span class="lineno"> 5693</span>&#160;    <span class="comment">// set inputs for errors, maxiters, etc.</span></div>
<div class="line"><a name="l05694"></a><span class="lineno"> 5694</span>&#160;<span class="preprocessor">#define IMPOKCONVCONSTFORDEFAULT (1E-6)</span></div>
<div class="line"><a name="l05695"></a><span class="lineno"> 5695</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define IMPALLOWCONVCONSTFORDEFAULT (1E-4)</span></div>
<div class="line"><a name="l05696"></a><span class="lineno"> 5696</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define IMPMAXITERFORDEFAULT (10)</span></div>
<div class="line"><a name="l05697"></a><span class="lineno"> 5697</span>&#160;<span class="preprocessor"></span>    newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#abaf99ec9e8c395755285cd9a44858314">tryconv</a>=1<a class="code" href="../../d8/d60/init_8c.html#a07484107e6d9fdf38b53edf631d6511d">E</a>-2*<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(trueimptryconv,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#af37d83577a8a8c0594d3f50a863871bf">IMPOKCONVCONSTFORDEFAULT</a>);</div>
<div class="line"><a name="l05698"></a><span class="lineno"> 5698</span>&#160;    newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a00940ef45bf3eb6e72c49ea66dd7c8b2">tryconvultrarel</a>=1<a class="code" href="../../d8/d60/init_8c.html#a07484107e6d9fdf38b53edf631d6511d">E</a>-2*<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(trueimptryconv,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#af37d83577a8a8c0594d3f50a863871bf">IMPOKCONVCONSTFORDEFAULT</a>);</div>
<div class="line"><a name="l05699"></a><span class="lineno"> 5699</span>&#160;    newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a28c2335afb8757d40128392034402c17">extra_newt_iter</a>=1;</div>
<div class="line"><a name="l05700"></a><span class="lineno"> 5700</span>&#160;    newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a08186e529162af19adc29e62eaaf31d9">extra_newt_iter_ultrarel</a>=2;</div>
<div class="line"><a name="l05701"></a><span class="lineno"> 5701</span>&#160;    newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a98ac5de850a4bd5b495a8c9e1975499b">mintryconv</a>=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9246a73614335644963eb4e47ec0de8c">MINTRYCONVFORMHDINVERSION</a>;<span class="comment">//IMPALLOWCONVCONSTFORDEFAULT;</span></div>
<div class="line"><a name="l05702"></a><span class="lineno"> 5702</span>&#160;    newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a767c6b7671c51ec6db1a3d7199775588">maxiter</a>=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(trueimpmaxiter,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aed3b748acc91229a6a8e8f3cac14988a">IMPMAXITERFORDEFAULT</a>);</div>
<div class="line"><a name="l05703"></a><span class="lineno"> 5703</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l05704"></a><span class="lineno"> 5704</span>&#160;    <span class="keywordtype">int</span> finalstep = 0;</div>
<div class="line"><a name="l05705"></a><span class="lineno"> 5705</span>&#160;    <span class="keywordtype">int</span> doradonly=0;</div>
<div class="line"><a name="l05706"></a><span class="lineno"> 5706</span>&#160;    eomtypelocal=*eomtype; <span class="comment">// stick with default choice so far</span></div>
<div class="line"><a name="l05707"></a><span class="lineno"> 5707</span>&#160;    <span class="keywordtype">int</span> checkoninversiongas;</div>
<div class="line"><a name="l05708"></a><span class="lineno"> 5708</span>&#160;    <span class="keywordtype">int</span> checkoninversionrad;</div>
<div class="line"><a name="l05709"></a><span class="lineno"> 5709</span>&#160;    <span class="comment">// don&#39;t check since slows down code and could be good enough solution if original error says ok.</span></div>
<div class="line"><a name="l05710"></a><span class="lineno"> 5710</span>&#160;    checkoninversiongas=checkoninversionrad=0;</div>
<div class="line"><a name="l05711"></a><span class="lineno"> 5711</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l05712"></a><span class="lineno"> 5712</span>&#160;    failreturnallowable=Utoprimgen_failwrapper(doradonly,radinvmod,showmessages,checkoninversiongas,checkoninversionrad,allowlocalfailurefixandnoreport, finalstep, &amp;eomtypelocal, whichcap, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7d1dc231c422450f87fdb3e71b4a7aff" title="defines how Utoprimgen is used">EVOLVEUTOPRIM</a>, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab2be21bd5eff40ca89c20eeecbeab5e0">UNOTHING</a>, Uiin, q, ptrgeom, dissmeasure, prtestUiin, &amp;newtonstats);</div>
<div class="line"><a name="l05713"></a><span class="lineno"> 5713</span>&#160;    *nummhdinvsreturn++;</div>
<div class="line"><a name="l05714"></a><span class="lineno"> 5714</span>&#160;    <span class="keywordflow">if</span>(failreturnallowable!=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aca02306e49f39d9dfc81492b850fb466" title="mnemonics for return modes so schemes know how failed and what to do.">UTOPRIMGENWRAPPERRETURNNOFAIL</a>){</div>
<div class="line"><a name="l05715"></a><span class="lineno"> 5715</span>&#160;      <span class="keywordflow">if</span>(showmessages &amp;&amp; debugfail&gt;=2) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;Utoprimgen_wrapper() says that Uiin is already a problem with %d\n&quot;</span>,failreturnallowable);</div>
<div class="line"><a name="l05716"></a><span class="lineno"> 5716</span>&#160;    }</div>
<div class="line"><a name="l05717"></a><span class="lineno"> 5717</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l05718"></a><span class="lineno"> 5718</span>&#160;      <span class="keywordflow">if</span>(showmessagesheavy &amp;&amp; debugfail&gt;=2) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;Utoprimgen_wrapper() says that Uiin is NOT a problem with %d\n&quot;</span>,failreturnallowable);</div>
<div class="line"><a name="l05719"></a><span class="lineno"> 5719</span>&#160;    }</div>
<div class="line"><a name="l05720"></a><span class="lineno"> 5720</span>&#160;</div>
<div class="line"><a name="l05721"></a><span class="lineno"> 5721</span>&#160;    <span class="keywordflow">if</span>(failreturnallowable==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aca02306e49f39d9dfc81492b850fb466" title="mnemonics for return modes so schemes know how failed and what to do.">UTOPRIMGENWRAPPERRETURNNOFAIL</a>) gotfirstnofail=1;</div>
<div class="line"><a name="l05722"></a><span class="lineno"> 5722</span>&#160;    <span class="keywordflow">else</span> gotfirstnofail=0;</div>
<div class="line"><a name="l05723"></a><span class="lineno"> 5723</span>&#160;    failreturnallowablefirst=failreturnallowable;</div>
<div class="line"><a name="l05724"></a><span class="lineno"> 5724</span>&#160;</div>
<div class="line"><a name="l05725"></a><span class="lineno"> 5725</span>&#160;    <span class="comment">//    if(myid==5 &amp;&amp; nstep==1 &amp;&amp; steppart==0 &amp;&amp; ptrgeom-&gt;i==19 &amp;&amp; ptrgeom-&gt;j==15){</span></div>
<div class="line"><a name="l05726"></a><span class="lineno"> 5726</span>&#160;    <span class="comment">//      PLOOP(pliter,pl) dualfprintf(fail_file,&quot;pl=%d prtestUiin=%21.15g Uiin=%21.15g\n&quot;,pl,prtestUiin[pl],Uiin[pl]);</span></div>
<div class="line"><a name="l05727"></a><span class="lineno"> 5727</span>&#160;    <span class="comment">//    }</span></div>
<div class="line"><a name="l05728"></a><span class="lineno"> 5728</span>&#160;</div>
<div class="line"><a name="l05729"></a><span class="lineno"> 5729</span>&#160;  }</div>
<div class="line"><a name="l05730"></a><span class="lineno"> 5730</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l05731"></a><span class="lineno"> 5731</span>&#160;    failreturnallowablefirst=failreturnallowable;</div>
<div class="line"><a name="l05732"></a><span class="lineno"> 5732</span>&#160;    gotfirstnofail=1;<span class="comment">//default is no failure</span></div>
<div class="line"><a name="l05733"></a><span class="lineno"> 5733</span>&#160;  }</div>
<div class="line"><a name="l05734"></a><span class="lineno"> 5734</span>&#160;</div>
<div class="line"><a name="l05735"></a><span class="lineno"> 5735</span>&#160;</div>
<div class="line"><a name="l05736"></a><span class="lineno"> 5736</span>&#160;</div>
<div class="line"><a name="l05737"></a><span class="lineno"> 5737</span>&#160;</div>
<div class="line"><a name="l05738"></a><span class="lineno"> 5738</span>&#160;</div>
<div class="line"><a name="l05740"></a><span class="lineno"> 5740</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l05741"></a><span class="lineno"> 5741</span>&#160;  <span class="comment">// Get p(uu0) for radiative guess for pb that is used in optically thin regime when USEDUINRADUPDATE==1</span></div>
<div class="line"><a name="l05742"></a><span class="lineno"> 5742</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l05743"></a><span class="lineno"> 5743</span>&#160;  <span class="comment">// get better version of pb that agrees with uu0.  This is only good for optically thin region, so best used with USEDUINRADUPDATE==1 for general optical depths.</span></div>
<div class="line"><a name="l05744"></a><span class="lineno"> 5744</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l05745"></a><span class="lineno"> 5745</span>&#160;  <span class="comment">// Getting prad(uu0_{rad parts}) is only relevant for PRAD method.  All other methods overwrite the radiative pb and pp.</span></div>
<div class="line"><a name="l05746"></a><span class="lineno"> 5746</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l05748"></a><span class="lineno"> 5748</span>&#160;<span class="comment"></span>  <span class="keywordflow">if</span>((<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a20ceb73955d66a10e7cebd4a1ae006b8" title="whether to get pb(uu0) instead of using pb that was used to compute F(pb).">GETRADINVFROMUU0FORPB</a>==1 &amp;&amp; <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa8c4409b81bebfe2ff9dc6f2f1c2472a" title="PMHD types.">IMPPMHDTYPE</a>(mtd.<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>)==0) || <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a20ceb73955d66a10e7cebd4a1ae006b8" title="whether to get pb(uu0) instead of using pb that was used to compute F(pb).">GETRADINVFROMUU0FORPB</a>==2 &amp;&amp; <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a7d3841c1f6026ab21196a7ee22a31957">IMPRADTYPEBASE</a>(*baseitermethod) || <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a20ceb73955d66a10e7cebd4a1ae006b8" title="whether to get pb(uu0) instead of using pb that was used to compute F(pb).">GETRADINVFROMUU0FORPB</a>==3 &amp;&amp; (<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a7d3841c1f6026ab21196a7ee22a31957">IMPRADTYPEBASE</a>(*baseitermethod) || <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a33425cd25de3bba0ed1613fd419efefd" title="MHD or RAD baseitermethod types.">IMPMHDTYPEBASE</a>(*baseitermethod) &amp;&amp; itermode==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a480c56e263c4874ccb40f3bbc1b32032">ITERMODESTAGES</a>)){</div>
<div class="line"><a name="l05749"></a><span class="lineno"> 5749</span>&#160;</div>
<div class="line"><a name="l05750"></a><span class="lineno"> 5750</span>&#160;      <span class="keyword">struct </span><a class="code" href="../../db/d3a/structof__newtonstats.html">of_newtonstats</a> newtonstats; setnewtonstatsdefault(&amp;newtonstats);</div>
<div class="line"><a name="l05751"></a><span class="lineno"> 5751</span>&#160;    <span class="keywordflow">if</span>(0){</div>
<div class="line"><a name="l05752"></a><span class="lineno"> 5752</span>&#160;      <span class="comment">// initialize counters</span></div>
<div class="line"><a name="l05753"></a><span class="lineno"> 5753</span>&#160;      newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a073783ba864c07681c8999a67162202b">nstroke</a>=newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a83280998e47831044a7e35299495a9bb">lntries</a>=0;</div>
<div class="line"><a name="l05754"></a><span class="lineno"> 5754</span>&#160;      <span class="comment">// set inputs for errors, maxiters, etc.</span></div>
<div class="line"><a name="l05755"></a><span class="lineno"> 5755</span>&#160;      newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#abaf99ec9e8c395755285cd9a44858314">tryconv</a>=trueimptryconv;</div>
<div class="line"><a name="l05756"></a><span class="lineno"> 5756</span>&#160;      newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a00940ef45bf3eb6e72c49ea66dd7c8b2">tryconvultrarel</a>=trueimptryconv*1<a class="code" href="../../d8/d60/init_8c.html#a07484107e6d9fdf38b53edf631d6511d">E</a>-1; <span class="comment">// just bit smaller, not as extreme as default</span></div>
<div class="line"><a name="l05757"></a><span class="lineno"> 5757</span>&#160;      newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a98ac5de850a4bd5b495a8c9e1975499b">mintryconv</a>=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9246a73614335644963eb4e47ec0de8c">MINTRYCONVFORMHDINVERSION</a>; <span class="comment">//IMPALLOWCONV;</span></div>
<div class="line"><a name="l05758"></a><span class="lineno"> 5758</span>&#160;      newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a767c6b7671c51ec6db1a3d7199775588">maxiter</a>=trueimpmaxiter;</div>
<div class="line"><a name="l05759"></a><span class="lineno"> 5759</span>&#160;      newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a28c2335afb8757d40128392034402c17">extra_newt_iter</a>=0;</div>
<div class="line"><a name="l05760"></a><span class="lineno"> 5760</span>&#160;      newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a08186e529162af19adc29e62eaaf31d9">extra_newt_iter_ultrarel</a>=1;</div>
<div class="line"><a name="l05761"></a><span class="lineno"> 5761</span>&#160;    }</div>
<div class="line"><a name="l05762"></a><span class="lineno"> 5762</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l05764"></a><span class="lineno"> 5764</span>&#160;      <span class="comment">// be quick about checking this</span></div>
<div class="line"><a name="l05765"></a><span class="lineno"> 5765</span>&#160;      newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a073783ba864c07681c8999a67162202b">nstroke</a>=newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a83280998e47831044a7e35299495a9bb">lntries</a>=0;</div>
<div class="line"><a name="l05766"></a><span class="lineno"> 5766</span>&#160;      <span class="comment">// set inputs for errors, maxiters, etc.</span></div>
<div class="line"><a name="l05767"></a><span class="lineno"> 5767</span>&#160;      newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#abaf99ec9e8c395755285cd9a44858314">tryconv</a>=1<a class="code" href="../../d8/d60/init_8c.html#a07484107e6d9fdf38b53edf631d6511d">E</a>-2*<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(trueimptryconv,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#af37d83577a8a8c0594d3f50a863871bf">IMPOKCONVCONSTFORDEFAULT</a>);</div>
<div class="line"><a name="l05768"></a><span class="lineno"> 5768</span>&#160;      newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a00940ef45bf3eb6e72c49ea66dd7c8b2">tryconvultrarel</a>=1<a class="code" href="../../d8/d60/init_8c.html#a07484107e6d9fdf38b53edf631d6511d">E</a>-2*<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(trueimptryconv,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#af37d83577a8a8c0594d3f50a863871bf">IMPOKCONVCONSTFORDEFAULT</a>);</div>
<div class="line"><a name="l05769"></a><span class="lineno"> 5769</span>&#160;      newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a28c2335afb8757d40128392034402c17">extra_newt_iter</a>=1;</div>
<div class="line"><a name="l05770"></a><span class="lineno"> 5770</span>&#160;      newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a08186e529162af19adc29e62eaaf31d9">extra_newt_iter_ultrarel</a>=2;</div>
<div class="line"><a name="l05771"></a><span class="lineno"> 5771</span>&#160;      newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a98ac5de850a4bd5b495a8c9e1975499b">mintryconv</a>=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9246a73614335644963eb4e47ec0de8c">MINTRYCONVFORMHDINVERSION</a>; <span class="comment">//IMPALLOWCONVCONSTFORDEFAULT;</span></div>
<div class="line"><a name="l05772"></a><span class="lineno"> 5772</span>&#160;      newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a767c6b7671c51ec6db1a3d7199775588">maxiter</a>=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(trueimpmaxiter,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aed3b748acc91229a6a8e8f3cac14988a">IMPMAXITERFORDEFAULT</a>);</div>
<div class="line"><a name="l05773"></a><span class="lineno"> 5773</span>&#160;      <span class="comment">//</span></div>
<div class="line"><a name="l05774"></a><span class="lineno"> 5774</span>&#160;    }</div>
<div class="line"><a name="l05775"></a><span class="lineno"> 5775</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l05776"></a><span class="lineno"> 5776</span>&#160;    <span class="keywordtype">int</span> finalstep = 0;</div>
<div class="line"><a name="l05777"></a><span class="lineno"> 5777</span>&#160;    <span class="keywordtype">int</span> doradonly=0;</div>
<div class="line"><a name="l05778"></a><span class="lineno"> 5778</span>&#160;    <span class="keywordflow">if</span>(*baseitermethod==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#add9bc1d07725fe2851182eccaa8eb385">QTYPRAD</a>){</div>
<div class="line"><a name="l05779"></a><span class="lineno"> 5779</span>&#160;      doradonly=1;</div>
<div class="line"><a name="l05780"></a><span class="lineno"> 5780</span>&#160;    }</div>
<div class="line"><a name="l05781"></a><span class="lineno"> 5781</span>&#160;    <span class="keywordflow">else</span> doradonly=0;</div>
<div class="line"><a name="l05782"></a><span class="lineno"> 5782</span>&#160;    eomtypelocal=*eomtype; <span class="comment">// stick with default choice so far</span></div>
<div class="line"><a name="l05783"></a><span class="lineno"> 5783</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> prtest[NPR];</div>
<div class="line"><a name="l05784"></a><span class="lineno"> 5784</span>&#160;    <span class="keywordtype">int</span> whichcapnew=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#af4a8ea9a61541490ee05c096ae984f20">CAPTYPEFIX2</a>; <span class="comment">// so Erf doesn&#39;t drop out for guess.</span></div>
<div class="line"><a name="l05785"></a><span class="lineno"> 5785</span>&#160;    <span class="keywordtype">int</span> checkoninversiongas;</div>
<div class="line"><a name="l05786"></a><span class="lineno"> 5786</span>&#160;    <span class="keywordtype">int</span> checkoninversionrad;</div>
<div class="line"><a name="l05787"></a><span class="lineno"> 5787</span>&#160;    <span class="comment">// don&#39;t check since slows down code and could be good enough solution if original error says ok.</span></div>
<div class="line"><a name="l05788"></a><span class="lineno"> 5788</span>&#160;    checkoninversiongas=checkoninversionrad=0;</div>
<div class="line"><a name="l05789"></a><span class="lineno"> 5789</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l05790"></a><span class="lineno"> 5790</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) prtest[pl]=pb[pl];</div>
<div class="line"><a name="l05791"></a><span class="lineno"> 5791</span>&#160;    failreturnallowable=Utoprimgen_failwrapper(doradonly,radinvmod,showmessages,checkoninversiongas,checkoninversionrad,allowlocalfailurefixandnoreport, finalstep, &amp;eomtypelocal, whichcapnew, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7d1dc231c422450f87fdb3e71b4a7aff" title="defines how Utoprimgen is used">EVOLVEUTOPRIM</a>, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab2be21bd5eff40ca89c20eeecbeab5e0">UNOTHING</a>, uu0, q, ptrgeom, dissmeasure, prtest, &amp;newtonstats);</div>
<div class="line"><a name="l05792"></a><span class="lineno"> 5792</span>&#160;    <span class="keywordflow">if</span>(doradonly==0) *nummhdinvsreturn++;</div>
<div class="line"><a name="l05793"></a><span class="lineno"> 5793</span>&#160;    <span class="keywordflow">if</span>(*baseitermethod==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#add9bc1d07725fe2851182eccaa8eb385">QTYPRAD</a> &amp;&amp; (1||failreturnallowable==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aca02306e49f39d9dfc81492b850fb466" title="mnemonics for return modes so schemes know how failed and what to do.">UTOPRIMGENWRAPPERRETURNNOFAIL</a>)){ <span class="comment">// 1|| so assigns if failed or not, because with CAPTYEPFIX2 won&#39;t give dropped-out answer.</span></div>
<div class="line"><a name="l05794"></a><span class="lineno"> 5794</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) <span class="keywordflow">if</span>(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a43791f6c1915cf7bfe3a02a4502510e4">RADFULLPL</a>(pl)) pb[pl]=prtest[pl];</div>
<div class="line"><a name="l05795"></a><span class="lineno"> 5795</span>&#160;    }</div>
<div class="line"><a name="l05796"></a><span class="lineno"> 5796</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(*baseitermethod==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9cf5ca7f5e5aa1e0bdef53abe3f27c1c">QTYPMHD</a> &amp;&amp; (failreturnallowable==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aca02306e49f39d9dfc81492b850fb466" title="mnemonics for return modes so schemes know how failed and what to do.">UTOPRIMGENWRAPPERRETURNNOFAIL</a>)){</div>
<div class="line"><a name="l05797"></a><span class="lineno"> 5797</span>&#160;      <span class="comment">// if not iterating radiation primitives, then these rad primitives will be overwritten by first f_implicit() call, so avoid...</span></div>
<div class="line"><a name="l05798"></a><span class="lineno"> 5798</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) <span class="keywordflow">if</span>(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a43791f6c1915cf7bfe3a02a4502510e4">RADFULLPL</a>(pl)) pb[pl]=prtest[pl];</div>
<div class="line"><a name="l05799"></a><span class="lineno"> 5799</span>&#160;    }</div>
<div class="line"><a name="l05800"></a><span class="lineno"> 5800</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l05801"></a><span class="lineno"> 5801</span>&#160;      <span class="comment">// then just leave pb as pb.</span></div>
<div class="line"><a name="l05802"></a><span class="lineno"> 5802</span>&#160;    }</div>
<div class="line"><a name="l05803"></a><span class="lineno"> 5803</span>&#160;  }</div>
<div class="line"><a name="l05804"></a><span class="lineno"> 5804</span>&#160;</div>
<div class="line"><a name="l05805"></a><span class="lineno"> 5805</span>&#160;</div>
<div class="line"><a name="l05806"></a><span class="lineno"> 5806</span>&#160;</div>
<div class="line"><a name="l05807"></a><span class="lineno"> 5807</span>&#160;</div>
<div class="line"><a name="l05808"></a><span class="lineno"> 5808</span>&#160;</div>
<div class="line"><a name="l05810"></a><span class="lineno"> 5810</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l05811"></a><span class="lineno"> 5811</span>&#160;  <span class="comment">// see if uu0-&gt;p possible and desired.  Or just assign pp,pb,uu in terms of piin,Uiin,uu0 (based possibly upon optical depth).</span></div>
<div class="line"><a name="l05812"></a><span class="lineno"> 5812</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l05814"></a><span class="lineno"> 5814</span>&#160;<span class="comment"></span>  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> prtestUU0[NPR];</div>
<div class="line"><a name="l05815"></a><span class="lineno"> 5815</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) prtestUU0[pl]=pb[pl]; <span class="comment">// initial guess</span></div>
<div class="line"><a name="l05816"></a><span class="lineno"> 5816</span>&#160;</div>
<div class="line"><a name="l05817"></a><span class="lineno"> 5817</span>&#160;  <span class="comment">// KORALTODO: Need to check if UFSET with no dUother fails.  How it fails, must allow since can do nothing better.  This avoids excessive attempts to get good solution without that failure!  Should speed-up things.  But what about error recovery?  If goes from CASE to no case!</span></div>
<div class="line"><a name="l05818"></a><span class="lineno"> 5818</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a886aa42856b0650b3cc366405c07151b" title="whether to use dUriemann and dUgeom or other dU&#39;s sitting in dUother for radiation update -1 : use Ui...">USEDUINRADUPDATE</a>==3){</div>
<div class="line"><a name="l05819"></a><span class="lineno"> 5819</span>&#160;    <span class="comment">// uu0 will hold original vector of conserved</span></div>
<div class="line"><a name="l05820"></a><span class="lineno"> 5820</span>&#160;    <span class="comment">// here original means U[before fluxes, geometry, etc.] + dU[due to fluxes, geometry, etc. already applied and included in dUother]</span></div>
<div class="line"><a name="l05821"></a><span class="lineno"> 5821</span>&#160;    <span class="comment">// This is required for stiff source term so immediately have balance between fluxes+geometry+radiation.  Otherwise, radiation diffuses.</span></div>
<div class="line"><a name="l05822"></a><span class="lineno"> 5822</span>&#160;    <span class="comment">// I&#39;m guessing that even though one uses RK2 or RK3, the first step generates large radiative velocities without any balanced source term since U isn&#39;t updated yet. One would hope RK2 would recover on the final substep, but it doesn&#39;t! In RK2, upon the final substep, that velocity is present for the radiation source term. But it&#39;s also present for the fluxes! That is, if there were no flux update on the final substep, then the source would have balanced the previous flux, but yet another flux is done, so there can be no balance. This leads to a run-away velocity that would be similar to the \tau\sim 1 case.</span></div>
<div class="line"><a name="l05823"></a><span class="lineno"> 5823</span>&#160;    <span class="comment">// NOTE: If this gives radiation or mhd failure, then less likely that will be actual solution since not even original uu0 has inversion.</span></div>
<div class="line"><a name="l05824"></a><span class="lineno"> 5824</span>&#160;    <span class="comment">// Note that &quot;q&quot; isn&#39;t used in this function or used in function call, so don&#39;t have to update it here.</span></div>
<div class="line"><a name="l05825"></a><span class="lineno"> 5825</span>&#160;</div>
<div class="line"><a name="l05826"></a><span class="lineno"> 5826</span>&#160;    <span class="comment">// Need to get default failure state.  Can allow such an error if having trouble with convergence (e.g. backing up too much)</span></div>
<div class="line"><a name="l05827"></a><span class="lineno"> 5827</span>&#160;    <span class="keyword">struct </span><a class="code" href="../../db/d3a/structof__newtonstats.html">of_newtonstats</a> newtonstats; setnewtonstatsdefault(&amp;newtonstats);</div>
<div class="line"><a name="l05828"></a><span class="lineno"> 5828</span>&#160;    <span class="keywordflow">if</span>(0){</div>
<div class="line"><a name="l05829"></a><span class="lineno"> 5829</span>&#160;      <span class="comment">// initialize counters</span></div>
<div class="line"><a name="l05830"></a><span class="lineno"> 5830</span>&#160;      newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a073783ba864c07681c8999a67162202b">nstroke</a>=newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a83280998e47831044a7e35299495a9bb">lntries</a>=0;</div>
<div class="line"><a name="l05831"></a><span class="lineno"> 5831</span>&#160;    }</div>
<div class="line"><a name="l05832"></a><span class="lineno"> 5832</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l05834"></a><span class="lineno"> 5834</span>&#160;      <span class="comment">// be quick about checking this</span></div>
<div class="line"><a name="l05835"></a><span class="lineno"> 5835</span>&#160;      newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a073783ba864c07681c8999a67162202b">nstroke</a>=newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a83280998e47831044a7e35299495a9bb">lntries</a>=0;</div>
<div class="line"><a name="l05836"></a><span class="lineno"> 5836</span>&#160;      <span class="comment">// set inputs for errors, maxiters, etc.</span></div>
<div class="line"><a name="l05837"></a><span class="lineno"> 5837</span>&#160;      newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#abaf99ec9e8c395755285cd9a44858314">tryconv</a>=1<a class="code" href="../../d8/d60/init_8c.html#a07484107e6d9fdf38b53edf631d6511d">E</a>-2*<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(trueimptryconv,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#af37d83577a8a8c0594d3f50a863871bf">IMPOKCONVCONSTFORDEFAULT</a>);</div>
<div class="line"><a name="l05838"></a><span class="lineno"> 5838</span>&#160;      newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a00940ef45bf3eb6e72c49ea66dd7c8b2">tryconvultrarel</a>=1<a class="code" href="../../d8/d60/init_8c.html#a07484107e6d9fdf38b53edf631d6511d">E</a>-2*<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(trueimptryconv,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#af37d83577a8a8c0594d3f50a863871bf">IMPOKCONVCONSTFORDEFAULT</a>);</div>
<div class="line"><a name="l05839"></a><span class="lineno"> 5839</span>&#160;      newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a28c2335afb8757d40128392034402c17">extra_newt_iter</a>=1;</div>
<div class="line"><a name="l05840"></a><span class="lineno"> 5840</span>&#160;      newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a08186e529162af19adc29e62eaaf31d9">extra_newt_iter_ultrarel</a>=2;</div>
<div class="line"><a name="l05841"></a><span class="lineno"> 5841</span>&#160;      newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a98ac5de850a4bd5b495a8c9e1975499b">mintryconv</a>=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9246a73614335644963eb4e47ec0de8c">MINTRYCONVFORMHDINVERSION</a>; <span class="comment">//IMPALLOWCONVCONSTFORDEFAULT;</span></div>
<div class="line"><a name="l05842"></a><span class="lineno"> 5842</span>&#160;      newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a767c6b7671c51ec6db1a3d7199775588">maxiter</a>=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(trueimpmaxiter,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aed3b748acc91229a6a8e8f3cac14988a">IMPMAXITERFORDEFAULT</a>);</div>
<div class="line"><a name="l05843"></a><span class="lineno"> 5843</span>&#160;    }</div>
<div class="line"><a name="l05844"></a><span class="lineno"> 5844</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l05845"></a><span class="lineno"> 5845</span>&#160;    <span class="keywordtype">int</span> failreturninversion;</div>
<div class="line"><a name="l05846"></a><span class="lineno"> 5846</span>&#160;    <span class="keywordtype">int</span> finalstep = 0;</div>
<div class="line"><a name="l05847"></a><span class="lineno"> 5847</span>&#160;    <span class="keywordtype">int</span> doradonly=0;</div>
<div class="line"><a name="l05848"></a><span class="lineno"> 5848</span>&#160;    <span class="keywordtype">int</span> checkoninversiongas;</div>
<div class="line"><a name="l05849"></a><span class="lineno"> 5849</span>&#160;    <span class="keywordtype">int</span> checkoninversionrad;</div>
<div class="line"><a name="l05850"></a><span class="lineno"> 5850</span>&#160;    <span class="comment">// don&#39;t check since slows down code and could be good enough solution if original error says ok.</span></div>
<div class="line"><a name="l05851"></a><span class="lineno"> 5851</span>&#160;    checkoninversiongas=checkoninversionrad=0;</div>
<div class="line"><a name="l05852"></a><span class="lineno"> 5852</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l05853"></a><span class="lineno"> 5853</span>&#160;    eomtypelocal=*eomtype; <span class="comment">// stick with default choice so far</span></div>
<div class="line"><a name="l05854"></a><span class="lineno"> 5854</span>&#160;    failreturninversion=Utoprimgen_failwrapper(doradonly,radinvmod,showmessages,checkoninversiongas,checkoninversionrad,allowlocalfailurefixandnoreport, finalstep, &amp;eomtypelocal, whichcap, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7d1dc231c422450f87fdb3e71b4a7aff" title="defines how Utoprimgen is used">EVOLVEUTOPRIM</a>, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab2be21bd5eff40ca89c20eeecbeab5e0">UNOTHING</a>, uu0, q, ptrgeom, dissmeasure, prtestUU0, &amp;newtonstats);</div>
<div class="line"><a name="l05855"></a><span class="lineno"> 5855</span>&#160;    *nummhdinvsreturn++;</div>
<div class="line"><a name="l05856"></a><span class="lineno"> 5856</span>&#160;</div>
<div class="line"><a name="l05857"></a><span class="lineno"> 5857</span>&#160;</div>
<div class="line"><a name="l05858"></a><span class="lineno"> 5858</span>&#160;    <span class="comment">// get pp0(uu0) so uu,uu0 properly associated with pp,pp0</span></div>
<div class="line"><a name="l05859"></a><span class="lineno"> 5859</span>&#160;    <span class="comment">// set first pp that is p(uu0), assuming that can do inversion</span></div>
<div class="line"><a name="l05860"></a><span class="lineno"> 5860</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) ppfirst[pl]=pp[pl]=pp0[pl]=prtestUU0[pl];</div>
<div class="line"><a name="l05861"></a><span class="lineno"> 5861</span>&#160;</div>
<div class="line"><a name="l05862"></a><span class="lineno"> 5862</span>&#160;  }</div>
<div class="line"><a name="l05863"></a><span class="lineno"> 5863</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a886aa42856b0650b3cc366405c07151b" title="whether to use dUriemann and dUgeom or other dU&#39;s sitting in dUother for radiation update -1 : use Ui...">USEDUINRADUPDATE</a>==2){</div>
<div class="line"><a name="l05864"></a><span class="lineno"> 5864</span>&#160;    <span class="comment">// normal behavior, where uu0 has no known primitive inversion yet.</span></div>
<div class="line"><a name="l05865"></a><span class="lineno"> 5865</span>&#160;    <span class="comment">// if entropy got solution and then energy is being done here, then pb is good entropy guess.</span></div>
<div class="line"><a name="l05866"></a><span class="lineno"> 5866</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l05867"></a><span class="lineno"> 5867</span>&#160;      uu[pl] = uu0[pl];</div>
<div class="line"><a name="l05868"></a><span class="lineno"> 5868</span>&#160;      ppfirst[pl] = pp[pl] = pp0[pl] = pb[pl];</div>
<div class="line"><a name="l05869"></a><span class="lineno"> 5869</span>&#160;    }</div>
<div class="line"><a name="l05870"></a><span class="lineno"> 5870</span>&#160;  }</div>
<div class="line"><a name="l05871"></a><span class="lineno"> 5871</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a886aa42856b0650b3cc366405c07151b" title="whether to use dUriemann and dUgeom or other dU&#39;s sitting in dUother for radiation update -1 : use Ui...">USEDUINRADUPDATE</a>==1){</div>
<div class="line"><a name="l05872"></a><span class="lineno"> 5872</span>&#160;</div>
<div class="line"><a name="l05873"></a><span class="lineno"> 5873</span>&#160;</div>
<div class="line"><a name="l05874"></a><span class="lineno"> 5874</span>&#160;    <span class="comment">// use tau as guess for which guess is best</span></div>
<div class="line"><a name="l05875"></a><span class="lineno"> 5875</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> tautot[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>]={0.0},tautotmax=0.0;</div>
<div class="line"><a name="l05876"></a><span class="lineno"> 5876</span>&#160;    <a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#a5943065ab3d5b4e9f4f691db499b588f" title="calculates total opacity over dx[]">calc_tautot</a>(pb, ptrgeom, q, tautot, &amp;tautotmax);</div>
<div class="line"><a name="l05877"></a><span class="lineno"> 5877</span>&#160;</div>
<div class="line"><a name="l05878"></a><span class="lineno"> 5878</span>&#160;    <span class="comment">// allow tolerance to be higher if optically thin enough</span></div>
<div class="line"><a name="l05879"></a><span class="lineno"> 5879</span>&#160;    <span class="keywordflow">if</span>(tautotmax&lt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ccd98422074e3018295182279a0df12">TAUTOTMAXHIGHERTOL</a>){</div>
<div class="line"><a name="l05880"></a><span class="lineno"> 5880</span>&#160;      trueimptryconv=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a4dab6e92e4bf6573af2e54f9f924fcc7">IMPTRYCONV_TAUTOTMAXHIGHERTOL</a>;</div>
<div class="line"><a name="l05881"></a><span class="lineno"> 5881</span>&#160;      <span class="comment">//  FTYPE trueimptryconv=IMPTRYCONV;</span></div>
<div class="line"><a name="l05882"></a><span class="lineno"> 5882</span>&#160;      trueimptryconvabs=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a37aa5c4b7b1b481299d87bf929d13b15" title="error for comparing to sum over all absolute errors">IMPTRYCONVABS</a>;</div>
<div class="line"><a name="l05883"></a><span class="lineno"> 5883</span>&#160;      trueimptryconvalt=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a3251670ff8087f873c6cac91ca50b16d">IMPTRYCONVALT</a>;</div>
<div class="line"><a name="l05884"></a><span class="lineno"> 5884</span>&#160;    }</div>
<div class="line"><a name="l05885"></a><span class="lineno"> 5885</span>&#160;    <span class="keywordflow">else</span>{ <span class="comment">// back to orig</span></div>
<div class="line"><a name="l05886"></a><span class="lineno"> 5886</span>&#160;      trueimptryconv=trueimptryconv_orig;</div>
<div class="line"><a name="l05887"></a><span class="lineno"> 5887</span>&#160;      <span class="comment">//  FTYPE trueimptryconv=IMPTRYCONV;</span></div>
<div class="line"><a name="l05888"></a><span class="lineno"> 5888</span>&#160;      trueimptryconvabs=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a37aa5c4b7b1b481299d87bf929d13b15" title="error for comparing to sum over all absolute errors">IMPTRYCONVABS</a>;</div>
<div class="line"><a name="l05889"></a><span class="lineno"> 5889</span>&#160;      trueimptryconvalt=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a3251670ff8087f873c6cac91ca50b16d">IMPTRYCONVALT</a>;</div>
<div class="line"><a name="l05890"></a><span class="lineno"> 5890</span>&#160;    }</div>
<div class="line"><a name="l05891"></a><span class="lineno"> 5891</span>&#160;</div>
<div class="line"><a name="l05892"></a><span class="lineno"> 5892</span>&#160;    <span class="comment">// iterated, so keep as initial (i.e. previous full solution, not just initial+flux)</span></div>
<div class="line"><a name="l05893"></a><span class="lineno"> 5893</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l05894"></a><span class="lineno"> 5894</span>&#160;      <span class="keywordflow">if</span>(tautotmax&gt;=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa4b9d982b48049810dccd1aab2565433">TAUSWITCHPBVSPIIN</a>){</div>
<div class="line"><a name="l05895"></a><span class="lineno"> 5895</span>&#160;        uu[pl] = Uiin[pl]; <span class="comment">// assume somewhat static and Uiin is best guess</span></div>
<div class="line"><a name="l05896"></a><span class="lineno"> 5896</span>&#160;        ppfirst[pl] = pp[pl] = pp0[pl] = piin[pl];</div>
<div class="line"><a name="l05897"></a><span class="lineno"> 5897</span>&#160;      }</div>
<div class="line"><a name="l05898"></a><span class="lineno"> 5898</span>&#160;      <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l05899"></a><span class="lineno"> 5899</span>&#160;        uu[pl] = uu0[pl]; <span class="comment">// assume dynamic and should use full uu0 to avoid pushing any errors into other fluid component.</span></div>
<div class="line"><a name="l05900"></a><span class="lineno"> 5900</span>&#160;        ppfirst[pl] = pp[pl] = pp0[pl] = pb[pl];</div>
<div class="line"><a name="l05901"></a><span class="lineno"> 5901</span>&#160;      }</div>
<div class="line"><a name="l05902"></a><span class="lineno"> 5902</span>&#160;    }</div>
<div class="line"><a name="l05903"></a><span class="lineno"> 5903</span>&#160;    <span class="comment">// non-iterated, so keep as initial+flux (since all there is)</span></div>
<div class="line"><a name="l05904"></a><span class="lineno"> 5904</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l05905"></a><span class="lineno"> 5905</span>&#160;      <span class="keywordflow">if</span>(!(pl&gt;=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a> &amp;&amp; pl&lt;=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8de9104f1fffa59f057b214d74c5cfea">U3</a> || <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a385beb27e1712b12184404ccdceb9fbe">RADPL</a>(pl) || pl==ENTROPY)){</div>
<div class="line"><a name="l05906"></a><span class="lineno"> 5906</span>&#160;        uu[pl] = uu0[pl];</div>
<div class="line"><a name="l05907"></a><span class="lineno"> 5907</span>&#160;        ppfirst[pl] = pp[pl] = pp0[pl] = pb[pl];</div>
<div class="line"><a name="l05908"></a><span class="lineno"> 5908</span>&#160;      }</div>
<div class="line"><a name="l05909"></a><span class="lineno"> 5909</span>&#160;    }</div>
<div class="line"><a name="l05910"></a><span class="lineno"> 5910</span>&#160;</div>
<div class="line"><a name="l05911"></a><span class="lineno"> 5911</span>&#160;  }</div>
<div class="line"><a name="l05912"></a><span class="lineno"> 5912</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a886aa42856b0650b3cc366405c07151b" title="whether to use dUriemann and dUgeom or other dU&#39;s sitting in dUother for radiation update -1 : use Ui...">USEDUINRADUPDATE</a>==0){</div>
<div class="line"><a name="l05913"></a><span class="lineno"> 5913</span>&#160;    <span class="comment">// bad choice for non-iterated quantities, like uu[RHO] should be uu0[RHO]</span></div>
<div class="line"><a name="l05914"></a><span class="lineno"> 5914</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l05915"></a><span class="lineno"> 5915</span>&#160;      uu[pl] = Uiin[pl];</div>
<div class="line"><a name="l05916"></a><span class="lineno"> 5916</span>&#160;      ppfirst[pl] = pp[pl] = pp0[pl] = piin[pl];</div>
<div class="line"><a name="l05917"></a><span class="lineno"> 5917</span>&#160;    }</div>
<div class="line"><a name="l05918"></a><span class="lineno"> 5918</span>&#160;  }</div>
<div class="line"><a name="l05919"></a><span class="lineno"> 5919</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l05920"></a><span class="lineno"> 5920</span>&#160;    <span class="comment">// then (not recommended) just using Uiin as uu0 .  KORALNOTE: uu0 reset later, but intermediates would use this uu0.</span></div>
<div class="line"><a name="l05921"></a><span class="lineno"> 5921</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l05922"></a><span class="lineno"> 5922</span>&#160;      uu[pl] = uu0[pl] = Uiin[pl];</div>
<div class="line"><a name="l05923"></a><span class="lineno"> 5923</span>&#160;      ppfirst[pl] = pp[pl] = pp0[pl] = piin[pl];</div>
<div class="line"><a name="l05924"></a><span class="lineno"> 5924</span>&#160;    }</div>
<div class="line"><a name="l05925"></a><span class="lineno"> 5925</span>&#160;  }  </div>
<div class="line"><a name="l05926"></a><span class="lineno"> 5926</span>&#160;</div>
<div class="line"><a name="l05927"></a><span class="lineno"> 5927</span>&#160;</div>
<div class="line"><a name="l05928"></a><span class="lineno"> 5928</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ae6b95cb2bf8c9e2e610922c6e72025c2" title="whether to use inputted uub, and pb as guess if errorabsreturn inputted is small enough makes sense i...">USEINPUTASGUESSIFERRORSMALL</a>){</div>
<div class="line"><a name="l05929"></a><span class="lineno"> 5929</span>&#160;    <span class="comment">// if error small enough and no fixups used with the radative inversion, override guess to use previous solution as the new guess</span></div>
<div class="line"><a name="l05930"></a><span class="lineno"> 5930</span>&#160;    <span class="keywordflow">if</span>(errorabsreturn[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>]&lt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a4a0ce3856fb32518938a274adb6c3946" title="error below which to feed best guess into next attempt">TRYHARDERFEEDGUESSTOL</a> &amp;&amp; <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0685d01c4383c1608a7ea72cb7ce3791">RADINVBAD</a>(radinvmodorig)==0){</div>
<div class="line"><a name="l05931"></a><span class="lineno"> 5931</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l05932"></a><span class="lineno"> 5932</span>&#160;        pp[pl] = pp0[pl] = ppfirst[pl] = pb[pl]; <span class="comment">// not just F(pb) anymore, holds better guess</span></div>
<div class="line"><a name="l05933"></a><span class="lineno"> 5933</span>&#160;        uu[pl] = uub[pl]; <span class="comment">// not just Uiin or uu0 anymore, holds better guess</span></div>
<div class="line"><a name="l05934"></a><span class="lineno"> 5934</span>&#160;      }</div>
<div class="line"><a name="l05935"></a><span class="lineno"> 5935</span>&#160;    }</div>
<div class="line"><a name="l05936"></a><span class="lineno"> 5936</span>&#160;  }</div>
<div class="line"><a name="l05937"></a><span class="lineno"> 5937</span>&#160;</div>
<div class="line"><a name="l05938"></a><span class="lineno"> 5938</span>&#160;</div>
<div class="line"><a name="l05940"></a><span class="lineno"> 5940</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l05941"></a><span class="lineno"> 5941</span>&#160;  <span class="comment">// Fix u_g so entropy not smaller than guess</span></div>
<div class="line"><a name="l05942"></a><span class="lineno"> 5942</span>&#160;  <span class="comment">// Only do this if u_g is just guess and is being solved for.</span></div>
<div class="line"><a name="l05943"></a><span class="lineno"> 5943</span>&#160;  <span class="comment">// When eomtype==EOMCOLDGRMHD, then u_g is static so shouldn&#39;t modify as if was guess.</span></div>
<div class="line"><a name="l05944"></a><span class="lineno"> 5944</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l05946"></a><span class="lineno"> 5946</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05947"></a><span class="lineno"> 5947</span>&#160;  <span class="keywordflow">if</span>(*eomtype!=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a757ad8b9c2c7611dad8aab853a87f61b">EOMCOLDGRMHD</a> &amp;&amp; <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a4d6b9e1b70703c6aa1d0f9dd9a7acb6b" title="MHD or RAD type.">IMPMHDTYPE</a>(mtd.<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>)==1 &amp;&amp; modprim==1){</div>
<div class="line"><a name="l05948"></a><span class="lineno"> 5948</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6708634050275c94899ab9f611f293b" title="whether to ensure specific entropy no smaller than guess">ENTROPYFIXGUESS</a>){</div>
<div class="line"><a name="l05949"></a><span class="lineno"> 5949</span>&#160;      entropyfixguess(q, ptrgeom, uu0, pp);</div>
<div class="line"><a name="l05950"></a><span class="lineno"> 5950</span>&#160;      <span class="comment">// piin is sometimes even a bit higher, and want to start high, and helps to avoid lack of convergence issue.</span></div>
<div class="line"><a name="l05951"></a><span class="lineno"> 5951</span>&#160;      pp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(pp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>],piin[UU]);</div>
<div class="line"><a name="l05952"></a><span class="lineno"> 5952</span>&#160;    }</div>
<div class="line"><a name="l05953"></a><span class="lineno"> 5953</span>&#160;    </div>
<div class="line"><a name="l05954"></a><span class="lineno"> 5954</span>&#160;    <span class="keywordflow">if</span>(modprim==1){</div>
<div class="line"><a name="l05955"></a><span class="lineno"> 5955</span>&#160;      pp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]=10.0*<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(pp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>],piin[UU]); <span class="comment">// raise u_g a bit.</span></div>
<div class="line"><a name="l05956"></a><span class="lineno"> 5956</span>&#160;    }</div>
<div class="line"><a name="l05957"></a><span class="lineno"> 5957</span>&#160;  }</div>
<div class="line"><a name="l05958"></a><span class="lineno"> 5958</span>&#160;  </div>
<div class="line"><a name="l05959"></a><span class="lineno"> 5959</span>&#160;</div>
<div class="line"><a name="l05960"></a><span class="lineno"> 5960</span>&#160;</div>
<div class="line"><a name="l05961"></a><span class="lineno"> 5961</span>&#160;</div>
<div class="line"><a name="l05962"></a><span class="lineno"> 5962</span>&#160;</div>
<div class="line"><a name="l05963"></a><span class="lineno"> 5963</span>&#160;</div>
<div class="line"><a name="l05965"></a><span class="lineno"> 5965</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l05966"></a><span class="lineno"> 5966</span>&#160;  <span class="comment">// SETUP Damping loop</span></div>
<div class="line"><a name="l05967"></a><span class="lineno"> 5967</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l05969"></a><span class="lineno"> 5969</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05970"></a><span class="lineno"> 5970</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ppdampbackup[NPR],uudampbackup[NPR],uu0dampbackup[NPR];</div>
<div class="line"><a name="l05971"></a><span class="lineno"> 5971</span>&#160;  <span class="comment">// backup those things that below can change, yet we want to start fresh each damp attempt (except best and backup stuff values and errors)</span></div>
<div class="line"><a name="l05972"></a><span class="lineno"> 5972</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l05973"></a><span class="lineno"> 5973</span>&#160;    ppdampbackup[pl]=pp[pl];</div>
<div class="line"><a name="l05974"></a><span class="lineno"> 5974</span>&#160;    uudampbackup[pl]=uu[pl];</div>
<div class="line"><a name="l05975"></a><span class="lineno"> 5975</span>&#160;    uu0dampbackup[pl]=uu0[pl];</div>
<div class="line"><a name="l05976"></a><span class="lineno"> 5976</span>&#160;  }</div>
<div class="line"><a name="l05977"></a><span class="lineno"> 5977</span>&#160;  <span class="comment">// backups and bests</span></div>
<div class="line"><a name="l05978"></a><span class="lineno"> 5978</span>&#160;  <span class="keywordtype">int</span> gotbackup=0;</div>
<div class="line"><a name="l05979"></a><span class="lineno"> 5979</span>&#160;  <span class="keywordtype">int</span> totaliters=0;</div>
<div class="line"><a name="l05980"></a><span class="lineno"> 5980</span>&#160;  <span class="keywordtype">int</span> iter=0;</div>
<div class="line"><a name="l05981"></a><span class="lineno"> 5981</span>&#160;  <span class="keywordtype">int</span> debugiter=0;</div>
<div class="line"><a name="l05982"></a><span class="lineno"> 5982</span>&#160;  <span class="keywordtype">int</span> debugiteratteempts[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a05f68af4806f09b5fcb143348da66be1">NUMDAMPATTEMPTS</a>];</div>
<div class="line"><a name="l05983"></a><span class="lineno"> 5983</span>&#160;  <span class="keywordtype">int</span> momiters=0,energyiters=0,fulliters=0;</div>
<div class="line"><a name="l05984"></a><span class="lineno"> 5984</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> errorabsf1[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa63447acbbbc62cbedae23eac61c716e" title="determine which error will use when deciding if converged or not.">NUMERRORTYPES</a>];</div>
<div class="line"><a name="l05985"></a><span class="lineno"> 5985</span>&#160;  set_array(errorabsf1,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa63447acbbbc62cbedae23eac61c716e" title="determine which error will use when deciding if converged or not.">NUMERRORTYPES</a>,MPI_FTYPE,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>);</div>
<div class="line"><a name="l05986"></a><span class="lineno"> 5986</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> suberrorabsf1=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>;</div>
<div class="line"><a name="l05987"></a><span class="lineno"> 5987</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> errorabsf3=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>;</div>
<div class="line"><a name="l05988"></a><span class="lineno"> 5988</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> suberrorabsf3=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>;</div>
<div class="line"><a name="l05989"></a><span class="lineno"> 5989</span>&#160;  <span class="comment">// things that can happen that then no matter what other conditions, avoid damping or other attempts.</span></div>
<div class="line"><a name="l05990"></a><span class="lineno"> 5990</span>&#160;  <span class="keywordtype">int</span> lowitererror=0;</div>
<div class="line"><a name="l05991"></a><span class="lineno"> 5991</span>&#160;  <span class="keywordtype">int</span> earlylowerror=0;</div>
<div class="line"><a name="l05992"></a><span class="lineno"> 5992</span>&#160;</div>
<div class="line"><a name="l05993"></a><span class="lineno"> 5993</span>&#160;  <span class="comment">// best is over all damps as well</span></div>
<div class="line"><a name="l05994"></a><span class="lineno"> 5994</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> errorabsbest[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa63447acbbbc62cbedae23eac61c716e" title="determine which error will use when deciding if converged or not.">NUMERRORTYPES</a>];</div>
<div class="line"><a name="l05995"></a><span class="lineno"> 5995</span>&#160;  set_array(errorabsbest,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa63447acbbbc62cbedae23eac61c716e" title="determine which error will use when deciding if converged or not.">NUMERRORTYPES</a>,MPI_FTYPE,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>);</div>
<div class="line"><a name="l05996"></a><span class="lineno"> 5996</span>&#160;  <span class="keywordtype">int</span> failreturnbest=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab0abd953f677a44020dc50259c410486">FAILRETURNGENERAL</a>;</div>
<div class="line"><a name="l05997"></a><span class="lineno"> 5997</span>&#160;  <span class="keywordtype">int</span> radinvmodbest=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ad987489760e6592057a80faf09588c88" title="unfixable inversion problems">UTOPRIMRADFAILBAD1</a>;</div>
<div class="line"><a name="l05998"></a><span class="lineno"> 5998</span>&#160;</div>
<div class="line"><a name="l05999"></a><span class="lineno"> 5999</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> tautotmaxreturn;</div>
<div class="line"><a name="l06000"></a><span class="lineno"> 6000</span>&#160;</div>
<div class="line"><a name="l06001"></a><span class="lineno"> 6001</span>&#160;</div>
<div class="line"><a name="l06002"></a><span class="lineno"> 6002</span>&#160;  <span class="keywordtype">int</span> f1iterstart=0;</div>
<div class="line"><a name="l06003"></a><span class="lineno"> 6003</span>&#160;  <span class="keywordtype">int</span> explicitattempt;</div>
<div class="line"><a name="l06004"></a><span class="lineno"> 6004</span>&#160;  <span class="keywordflow">for</span>(explicitattempt=0;explicitattempt&lt;=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad09ae1fd1b9957bada8d4ba83bcfcf75">DONONEXPLICITIFFAILS</a>;explicitattempt++){</div>
<div class="line"><a name="l06005"></a><span class="lineno"> 6005</span>&#160;</div>
<div class="line"><a name="l06006"></a><span class="lineno"> 6006</span>&#160;    gotbackup=0;</div>
<div class="line"><a name="l06007"></a><span class="lineno"> 6007</span>&#160;    iter=0;</div>
<div class="line"><a name="l06008"></a><span class="lineno"> 6008</span>&#160;    debugiter=0;</div>
<div class="line"><a name="l06009"></a><span class="lineno"> 6009</span>&#160;    set_array(errorabsf1,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa63447acbbbc62cbedae23eac61c716e" title="determine which error will use when deciding if converged or not.">NUMERRORTYPES</a>,MPI_FTYPE,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>);</div>
<div class="line"><a name="l06010"></a><span class="lineno"> 6010</span>&#160;    suberrorabsf1=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>;</div>
<div class="line"><a name="l06011"></a><span class="lineno"> 6011</span>&#160;    errorabsf3=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>;</div>
<div class="line"><a name="l06012"></a><span class="lineno"> 6012</span>&#160;    suberrorabsf3=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>;</div>
<div class="line"><a name="l06013"></a><span class="lineno"> 6013</span>&#160;</div>
<div class="line"><a name="l06014"></a><span class="lineno"> 6014</span>&#160;    <span class="keywordflow">if</span>(explicitattempt&gt;0 &amp;&amp; (lowitererror || earlylowerror || errorabsf1[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>]&lt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a62f93a82af6febdabb986b5cc9062449" title="tolerance above which to continue to try damping">IMPTRYDAMPCONV</a> &amp;&amp; <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a6ce9f5de6e575be785e5f053882a0909">ACCEPTASNOFAILURE</a>(failreturn) || failreturn==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a42e7e780e89073f5d14dfafda3bae62e">FAILRETURNMODESWITCH</a>) ){ <span class="comment">// try damping if any bad failure or not desired tolerance when damping</span></div>
<div class="line"><a name="l06015"></a><span class="lineno"> 6015</span>&#160;      <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l06016"></a><span class="lineno"> 6016</span>&#160;    }</div>
<div class="line"><a name="l06017"></a><span class="lineno"> 6017</span>&#160;    <span class="keywordflow">if</span>(explicitattempt==1){</div>
<div class="line"><a name="l06018"></a><span class="lineno"> 6018</span>&#160;      f1iterstart=1;</div>
<div class="line"><a name="l06019"></a><span class="lineno"> 6019</span>&#160;    }</div>
<div class="line"><a name="l06020"></a><span class="lineno"> 6020</span>&#160;    <span class="keywordflow">else</span> f1iterstart=0;</div>
<div class="line"><a name="l06021"></a><span class="lineno"> 6021</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l06022"></a><span class="lineno"> 6022</span>&#160;      pp[pl]=ppdampbackup[pl];</div>
<div class="line"><a name="l06023"></a><span class="lineno"> 6023</span>&#160;      uu[pl]=uudampbackup[pl];</div>
<div class="line"><a name="l06024"></a><span class="lineno"> 6024</span>&#160;      uu0[pl]=uu0dampbackup[pl];</div>
<div class="line"><a name="l06025"></a><span class="lineno"> 6025</span>&#160;    }</div>
<div class="line"><a name="l06026"></a><span class="lineno"> 6026</span>&#160;</div>
<div class="line"><a name="l06027"></a><span class="lineno"> 6027</span>&#160;</div>
<div class="line"><a name="l06028"></a><span class="lineno"> 6028</span>&#160;</div>
<div class="line"><a name="l06029"></a><span class="lineno"> 6029</span>&#160;</div>
<div class="line"><a name="l06031"></a><span class="lineno"> 6031</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l06032"></a><span class="lineno"> 6032</span>&#160;    <span class="comment">// THE DAMP LOOP ITSELF</span></div>
<div class="line"><a name="l06033"></a><span class="lineno"> 6033</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l06035"></a><span class="lineno"> 6035</span>&#160;<span class="comment"></span>    <span class="keywordtype">int</span> dampattempt;</div>
<div class="line"><a name="l06036"></a><span class="lineno"> 6036</span>&#160;    <span class="keywordflow">for</span>(dampattempt=0;dampattempt&lt;truenumdampattempts;dampattempt++){</div>
<div class="line"><a name="l06037"></a><span class="lineno"> 6037</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> DAMPFACTOR0;</div>
<div class="line"><a name="l06038"></a><span class="lineno"> 6038</span>&#160;      <span class="comment">// dampattempt&gt;0 refers to any attempt beyond the very first.  Uses iter from end of region inside this loop.</span></div>
<div class="line"><a name="l06039"></a><span class="lineno"> 6039</span>&#160;      <span class="keywordflow">if</span>(dampattempt&gt;0 &amp;&amp; (lowitererror || earlylowerror || errorabsf1[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>]&lt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a62f93a82af6febdabb986b5cc9062449" title="tolerance above which to continue to try damping">IMPTRYDAMPCONV</a> &amp;&amp; <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a6ce9f5de6e575be785e5f053882a0909">ACCEPTASNOFAILURE</a>(failreturn) || failreturn==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a42e7e780e89073f5d14dfafda3bae62e">FAILRETURNMODESWITCH</a>) ){ <span class="comment">// try damping if any bad failure or not desired tolerance when damping</span></div>
<div class="line"><a name="l06040"></a><span class="lineno"> 6040</span>&#160;        <span class="keywordflow">if</span>(dampattempt&gt;=2 &amp;&amp; failreturn!=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a42e7e780e89073f5d14dfafda3bae62e">FAILRETURNMODESWITCH</a>){ <span class="comment">// dampattempt&gt;=2 refers to attempts with at least 1 damp attempt</span></div>
<div class="line"><a name="l06041"></a><span class="lineno"> 6041</span>&#160;          <span class="keywordflow">if</span>(debugfail&gt;=2) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;Damping worked to reach desired tolerance: errorabsf1=%g errorallabsf1=%g (IMPTRYDAMPCONV=%g), so should have lower error: dampattempt=%d iter=%d ijk=%d %d %d\n&quot;</span>,errorabsf1[0],errorabsf1[1],<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a62f93a82af6febdabb986b5cc9062449" title="tolerance above which to continue to try damping">IMPTRYDAMPCONV</a>,dampattempt,iter,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k);</div>
<div class="line"><a name="l06042"></a><span class="lineno"> 6042</span>&#160;        }</div>
<div class="line"><a name="l06043"></a><span class="lineno"> 6043</span>&#160;        <span class="keywordflow">break</span>; <span class="comment">// if didn&#39;t hit problem, so no need to damp since got tolerance requested or returned because will just switch to another scheme.</span></div>
<div class="line"><a name="l06044"></a><span class="lineno"> 6044</span>&#160;      }</div>
<div class="line"><a name="l06045"></a><span class="lineno"> 6045</span>&#160;      <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l06046"></a><span class="lineno"> 6046</span>&#160;        <span class="comment">// control factor by which step Newton&#39;s method.</span></div>
<div class="line"><a name="l06047"></a><span class="lineno"> 6047</span>&#160;        <span class="keywordflow">if</span>(dampattempt==0) DAMPFACTOR0=1.0;</div>
<div class="line"><a name="l06048"></a><span class="lineno"> 6048</span>&#160;        <span class="keywordflow">else</span> DAMPFACTOR0=1.0/pow(2.0,(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a>)(dampattempt));</div>
<div class="line"><a name="l06049"></a><span class="lineno"> 6049</span>&#160;</div>
<div class="line"><a name="l06050"></a><span class="lineno"> 6050</span>&#160;        <span class="keywordflow">if</span>(dampattempt&gt;0) <span class="keywordflow">if</span>(debugfail&gt;=2) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;Trying dampattempt=%d DAMPFACTOR0=%g failreturn=%d errorabsf1=%g errorallabsf1=%g iter=%d ijk=%d %d %d\n&quot;</span>,dampattempt,DAMPFACTOR0,failreturn,errorabsf1[0],errorabsf1[1],iter,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k);</div>
<div class="line"><a name="l06051"></a><span class="lineno"> 6051</span>&#160;</div>
<div class="line"><a name="l06052"></a><span class="lineno"> 6052</span>&#160;        <span class="comment">// start fresh</span></div>
<div class="line"><a name="l06053"></a><span class="lineno"> 6053</span>&#160;        iter=debugiter=0;</div>
<div class="line"><a name="l06054"></a><span class="lineno"> 6054</span>&#160;        failreturn=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a3d6e4da5640133efaad94738c97e5171">FAILRETURNNOFAIL</a>; <span class="comment">// default is no failure</span></div>
<div class="line"><a name="l06055"></a><span class="lineno"> 6055</span>&#160;        mathfailtype=-1; <span class="comment">// indicates not set</span></div>
<div class="line"><a name="l06056"></a><span class="lineno"> 6056</span>&#160;        {</div>
<div class="line"><a name="l06057"></a><span class="lineno"> 6057</span>&#160;          <span class="comment">//        PLOOP(pliter,pl) uu0[pl]=uu0dampbackup[pl];</span></div>
<div class="line"><a name="l06058"></a><span class="lineno"> 6058</span>&#160;        }</div>
<div class="line"><a name="l06059"></a><span class="lineno"> 6059</span>&#160;        <span class="keywordflow">if</span>(errorabsf1[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>]&lt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a4a0ce3856fb32518938a274adb6c3946" title="error below which to feed best guess into next attempt">TRYHARDERFEEDGUESSTOL</a>){</div>
<div class="line"><a name="l06060"></a><span class="lineno"> 6060</span>&#160;          <span class="comment">// then keep pp and uu as better starting point</span></div>
<div class="line"><a name="l06061"></a><span class="lineno"> 6061</span>&#160;        }</div>
<div class="line"><a name="l06062"></a><span class="lineno"> 6062</span>&#160;        <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l06063"></a><span class="lineno"> 6063</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l06064"></a><span class="lineno"> 6064</span>&#160;            pp[pl]=ppdampbackup[pl];</div>
<div class="line"><a name="l06065"></a><span class="lineno"> 6065</span>&#160;            uu[pl]=uudampbackup[pl];</div>
<div class="line"><a name="l06066"></a><span class="lineno"> 6066</span>&#160;            uu0[pl]=uu0dampbackup[pl];</div>
<div class="line"><a name="l06067"></a><span class="lineno"> 6067</span>&#160;          }</div>
<div class="line"><a name="l06068"></a><span class="lineno"> 6068</span>&#160;        }</div>
<div class="line"><a name="l06069"></a><span class="lineno"> 6069</span>&#160;</div>
<div class="line"><a name="l06070"></a><span class="lineno"> 6070</span>&#160;      }</div>
<div class="line"><a name="l06071"></a><span class="lineno"> 6071</span>&#160;</div>
<div class="line"><a name="l06072"></a><span class="lineno"> 6072</span>&#160;</div>
<div class="line"><a name="l06073"></a><span class="lineno"> 6073</span>&#160;</div>
<div class="line"><a name="l06074"></a><span class="lineno"> 6074</span>&#160;</div>
<div class="line"><a name="l06075"></a><span class="lineno"> 6075</span>&#160;</div>
<div class="line"><a name="l06077"></a><span class="lineno"> 6077</span>&#160;      <span class="comment">//</span></div>
<div class="line"><a name="l06078"></a><span class="lineno"> 6078</span>&#160;      <span class="comment">// SETUP IMPLICIT ITERATIONS</span></div>
<div class="line"><a name="l06079"></a><span class="lineno"> 6079</span>&#160;      <span class="comment">//</span></div>
<div class="line"><a name="l06081"></a><span class="lineno"> 6081</span>&#160;<span class="comment"></span>      <span class="keywordtype">int</span> f1iter;</div>
<div class="line"><a name="l06082"></a><span class="lineno"> 6082</span>&#160;      <span class="keywordtype">int</span> checkconv,changeotherdt=1;</div>
<div class="line"><a name="l06083"></a><span class="lineno"> 6083</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> impepsjac=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a900fca7c5effa733d936e1954b7192ee" title="IMPLICIT SOLVER TOLERANCES or DERIVATIVE SIZES for used implicit solver (needs to be chosen more gene...">IMPEPSLARGE</a>; <span class="comment">// default</span></div>
<div class="line"><a name="l06084"></a><span class="lineno"> 6084</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> errorabspf1[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab4cf497679ffe5ebf0a9020558d74067">NUMPRIORERRORS</a>];</div>
<div class="line"><a name="l06085"></a><span class="lineno"> 6085</span>&#160;      set_array(errorabspf1,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab4cf497679ffe5ebf0a9020558d74067">NUMPRIORERRORS</a>,MPI_FTYPE,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>);</div>
<div class="line"><a name="l06086"></a><span class="lineno"> 6086</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> errorabspf3=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>;</div>
<div class="line"><a name="l06087"></a><span class="lineno"> 6087</span>&#160;</div>
<div class="line"><a name="l06088"></a><span class="lineno"> 6088</span>&#160;      <span class="comment">// initialize previous &#39;good inversion&#39; based uu&#39;s</span></div>
<div class="line"><a name="l06089"></a><span class="lineno"> 6089</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l06090"></a><span class="lineno"> 6090</span>&#160;        uupriorsteptype[pl]=uuppp[pl]=uupp[pl]=uuporig[pl]=uup[pl]=uu0orig[pl]=uu[pl];</div>
<div class="line"><a name="l06091"></a><span class="lineno"> 6091</span>&#160;        pppriorsteptype[pl]=ppppp[pl]=pppp[pl]=ppporig[pl]=ppp[pl]=pp0orig[pl]=pp[pl];</div>
<div class="line"><a name="l06092"></a><span class="lineno"> 6092</span>&#160;      }</div>
<div class="line"><a name="l06093"></a><span class="lineno"> 6093</span>&#160;</div>
<div class="line"><a name="l06094"></a><span class="lineno"> 6094</span>&#160;</div>
<div class="line"><a name="l06095"></a><span class="lineno"> 6095</span>&#160;      <span class="comment">// setup debug so can see starting guess</span></div>
<div class="line"><a name="l06096"></a><span class="lineno"> 6096</span>&#160;<span class="preprocessor">#if(DEBUGMAXITER)</span></div>
<div class="line"><a name="l06097"></a><span class="lineno"> 6097</span>&#160;<span class="preprocessor"></span>      <span class="keywordtype">int</span> iterlist=0;</div>
<div class="line"><a name="l06098"></a><span class="lineno"> 6098</span>&#160;      <span class="keywordflow">if</span>(dampattempt==0){</div>
<div class="line"><a name="l06099"></a><span class="lineno"> 6099</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) pppreholdlist[iterlist][pl]=pp[pl];</div>
<div class="line"><a name="l06100"></a><span class="lineno"> 6100</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) ppposholdlist[iterlist][pl]=pp[pl];</div>
<div class="line"><a name="l06101"></a><span class="lineno"> 6101</span>&#160;        <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8968c59c029dc64a1057992a70ef8dbd" title="0: show primitive 1: show u^ and urad^">DEBUGMAXITERVELOCITY</a>==1){</div>
<div class="line"><a name="l06102"></a><span class="lineno"> 6102</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj){</div>
<div class="line"><a name="l06103"></a><span class="lineno"> 6103</span>&#160;            pppreholdlist[iterlist][<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>+jj-1]=q-&gt;<a class="code" href="../../d1/d83/structof__state.html#aab723d3c7c2c48b7246cc7d7d5379eed">ucon</a>[jj];</div>
<div class="line"><a name="l06104"></a><span class="lineno"> 6104</span>&#160;            pppreholdlist[iterlist][URAD1+jj-1]=q-&gt;<a class="code" href="../../d1/d83/structof__state.html#a3bf8e15ee6ae95831230791baf2fc570">uradcon</a>[jj];</div>
<div class="line"><a name="l06105"></a><span class="lineno"> 6105</span>&#160;            ppposholdlist[iterlist][<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>+jj-1]=q-&gt;<a class="code" href="../../d1/d83/structof__state.html#aab723d3c7c2c48b7246cc7d7d5379eed">ucon</a>[jj];</div>
<div class="line"><a name="l06106"></a><span class="lineno"> 6106</span>&#160;            ppposholdlist[iterlist][URAD1+jj-1]=q-&gt;<a class="code" href="../../d1/d83/structof__state.html#a3bf8e15ee6ae95831230791baf2fc570">uradcon</a>[jj];</div>
<div class="line"><a name="l06107"></a><span class="lineno"> 6107</span>&#160;          }</div>
<div class="line"><a name="l06108"></a><span class="lineno"> 6108</span>&#160;        }</div>
<div class="line"><a name="l06109"></a><span class="lineno"> 6109</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) f1reportlist[iterlist][pl]=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>;</div>
<div class="line"><a name="l06110"></a><span class="lineno"> 6110</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) f1list[iterlist][pl]=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>;</div>
<div class="line"><a name="l06111"></a><span class="lineno"> 6111</span>&#160;        realiterlist[iterlist]=-1;</div>
<div class="line"><a name="l06112"></a><span class="lineno"> 6112</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a59b7ef1517ff22fd4dfce4cf6d380c55" title="loop over all Dimensions; second rank loop">DLOOP</a>(jj,kk) jaclist[iterlist][jj][kk]=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>;</div>
<div class="line"><a name="l06113"></a><span class="lineno"> 6113</span>&#160;        implicititerlist[iterlist]=-1;</div>
<div class="line"><a name="l06114"></a><span class="lineno"> 6114</span>&#160;        implicitferrlist[iterlist]=-1;</div>
<div class="line"><a name="l06115"></a><span class="lineno"> 6115</span>&#160;        fracdamplist[0]=fracdtuu0;</div>
<div class="line"><a name="l06116"></a><span class="lineno"> 6116</span>&#160;        fracdamplist[1]=fracdtG;</div>
<div class="line"><a name="l06117"></a><span class="lineno"> 6117</span>&#160;        fracdamplist[2]=0;</div>
<div class="line"><a name="l06118"></a><span class="lineno"> 6118</span>&#160;      }</div>
<div class="line"><a name="l06119"></a><span class="lineno"> 6119</span>&#160;      errorabsf1list[iterlist]=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>;</div>
<div class="line"><a name="l06120"></a><span class="lineno"> 6120</span>&#160;      errorallabsf1list[iterlist]=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>;</div>
<div class="line"><a name="l06121"></a><span class="lineno"> 6121</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l06122"></a><span class="lineno"> 6122</span>&#160;<span class="preprocessor"></span>      {</div>
<div class="line"><a name="l06123"></a><span class="lineno"> 6123</span>&#160;        <span class="keywordtype">int</span> iterlist=0;</div>
<div class="line"><a name="l06124"></a><span class="lineno"> 6124</span>&#160;        errorabsf1list[iterlist]=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>;</div>
<div class="line"><a name="l06125"></a><span class="lineno"> 6125</span>&#160;        errorallabsf1list[iterlist]=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>;</div>
<div class="line"><a name="l06126"></a><span class="lineno"> 6126</span>&#160;      }</div>
<div class="line"><a name="l06127"></a><span class="lineno"> 6127</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l06128"></a><span class="lineno"> 6128</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l06129"></a><span class="lineno"> 6129</span>&#160;      <span class="comment">// DEBUG:</span></div>
<div class="line"><a name="l06130"></a><span class="lineno"> 6130</span>&#160;      errorabsreturn[0]=errorabsreturn[1]=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>;</div>
<div class="line"><a name="l06131"></a><span class="lineno"> 6131</span>&#160;</div>
<div class="line"><a name="l06132"></a><span class="lineno"> 6132</span>&#160;      <span class="comment">// whether holding as positive and outher counts</span></div>
<div class="line"><a name="l06133"></a><span class="lineno"> 6133</span>&#160;      <span class="comment">// or things that happen that mean need to break out of this attempt, but not break out of damping loop.</span></div>
<div class="line"><a name="l06134"></a><span class="lineno"> 6134</span>&#160;      <span class="keywordtype">int</span> holdingaspositive=0,iterhold=0;</div>
<div class="line"><a name="l06135"></a><span class="lineno"> 6135</span>&#160;      <span class="keywordtype">int</span> countholdpositive=0;</div>
<div class="line"><a name="l06136"></a><span class="lineno"> 6136</span>&#160;      <span class="keywordtype">int</span> countugnegative=0;</div>
<div class="line"><a name="l06137"></a><span class="lineno"> 6137</span>&#160;      <span class="keywordtype">int</span> countbadenergy=0;</div>
<div class="line"><a name="l06138"></a><span class="lineno"> 6138</span>&#160;      <span class="keywordtype">int</span> counterrorrose=0;</div>
<div class="line"><a name="l06139"></a><span class="lineno"> 6139</span>&#160;      <span class="keywordtype">int</span> priorerrorscount=0;</div>
<div class="line"><a name="l06140"></a><span class="lineno"> 6140</span>&#160;      <span class="keywordtype">int</span> canbreak=0;</div>
<div class="line"><a name="l06141"></a><span class="lineno"> 6141</span>&#160;      <span class="keywordtype">int</span> notfinite=0;</div>
<div class="line"><a name="l06142"></a><span class="lineno"> 6142</span>&#160;      <span class="keywordtype">int</span> convreturnf3limit=0;</div>
<div class="line"><a name="l06143"></a><span class="lineno"> 6143</span>&#160;      <span class="keywordtype">int</span> notholding=1;</div>
<div class="line"><a name="l06144"></a><span class="lineno"> 6144</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> DAMPFACTOR;</div>
<div class="line"><a name="l06145"></a><span class="lineno"> 6145</span>&#160;      <span class="keywordtype">int</span> numjumpchecks=0;</div>
<div class="line"><a name="l06146"></a><span class="lineno"> 6146</span>&#160;</div>
<div class="line"><a name="l06148"></a><span class="lineno"> 6148</span>&#160;      <span class="comment">//</span></div>
<div class="line"><a name="l06149"></a><span class="lineno"> 6149</span>&#160;      <span class="comment">// IMPLICIT LOOP ITSELF</span></div>
<div class="line"><a name="l06150"></a><span class="lineno"> 6150</span>&#160;      <span class="comment">//</span></div>
<div class="line"><a name="l06152"></a><span class="lineno"> 6152</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l06153"></a><span class="lineno"> 6153</span>&#160;      <span class="keywordflow">do</span>{</div>
<div class="line"><a name="l06154"></a><span class="lineno"> 6154</span>&#160;        debugiter++; <span class="comment">// never skips, goes every step</span></div>
<div class="line"><a name="l06155"></a><span class="lineno"> 6155</span>&#160;        <span class="comment">//      dualfprintf(fail_file,&quot;iter=%d debugiter=%d\n&quot;,iter,debugiter);</span></div>
<div class="line"><a name="l06156"></a><span class="lineno"> 6156</span>&#160;        debugiteratteempts[dampattempt]=debugiter;</div>
<div class="line"><a name="l06157"></a><span class="lineno"> 6157</span>&#160;        iter++; <span class="comment">// below might skip some iter, used to control which equations used</span></div>
<div class="line"><a name="l06158"></a><span class="lineno"> 6158</span>&#160;</div>
<div class="line"><a name="l06159"></a><span class="lineno"> 6159</span>&#160;</div>
<div class="line"><a name="l06160"></a><span class="lineno"> 6160</span>&#160;</div>
<div class="line"><a name="l06161"></a><span class="lineno"> 6161</span>&#160;        <span class="comment">// setup method and signs</span></div>
<div class="line"><a name="l06162"></a><span class="lineno"> 6162</span>&#160;        define_method(iter, &amp;eomtypelocal, itermode, *baseitermethod, fracenergy, dissmeasure, &amp;mtd);</div>
<div class="line"><a name="l06163"></a><span class="lineno"> 6163</span>&#160;        get_refUs(&amp;mtd, &amp;ru);</div>
<div class="line"><a name="l06164"></a><span class="lineno"> 6164</span>&#160;</div>
<div class="line"><a name="l06165"></a><span class="lineno"> 6165</span>&#160;</div>
<div class="line"><a name="l06166"></a><span class="lineno"> 6166</span>&#160;        <span class="keywordflow">if</span>(iter&gt;=mtd.<a class="code" href="../../d6/dbe/structof__method.html#ab82f125cc45b1d2881155d70795fbf8a">BEGINMOMSTEPS</a> &amp;&amp; iter&lt;=mtd.<a class="code" href="../../d6/dbe/structof__method.html#a854fcca7e3e1d7ab0a6955321ce698de">ENDMOMSTEPS</a>){</div>
<div class="line"><a name="l06167"></a><span class="lineno"> 6167</span>&#160;          momiters++;</div>
<div class="line"><a name="l06168"></a><span class="lineno"> 6168</span>&#160;        }</div>
<div class="line"><a name="l06169"></a><span class="lineno"> 6169</span>&#160;        <span class="keywordflow">if</span>(iter&gt;=mtd.<a class="code" href="../../d6/dbe/structof__method.html#a6412a5671687f2d9f5be2fd0fafb81f1">BEGINENERGYSTEPS</a> &amp;&amp; iter&lt;=mtd.<a class="code" href="../../d6/dbe/structof__method.html#a9829068ffbaa124dda46be28c48bfccc">ENDENERGYSTEPS</a>){</div>
<div class="line"><a name="l06170"></a><span class="lineno"> 6170</span>&#160;          energyiters++;</div>
<div class="line"><a name="l06171"></a><span class="lineno"> 6171</span>&#160;        }</div>
<div class="line"><a name="l06172"></a><span class="lineno"> 6172</span>&#160;        <span class="keywordflow">if</span>(iter&gt;=mtd.<a class="code" href="../../d6/dbe/structof__method.html#a73849808a0b3a900c373b244089eab1f">BEGINFULLSTEPS</a> &amp;&amp; iter&lt;=mtd.<a class="code" href="../../d6/dbe/structof__method.html#acda8029c6baa1a6f01a7f60bbe748ebb">ENDFULLSTEPS</a>){</div>
<div class="line"><a name="l06173"></a><span class="lineno"> 6173</span>&#160;          fulliters++;</div>
<div class="line"><a name="l06174"></a><span class="lineno"> 6174</span>&#160;        }</div>
<div class="line"><a name="l06175"></a><span class="lineno"> 6175</span>&#160;</div>
<div class="line"><a name="l06176"></a><span class="lineno"> 6176</span>&#160;</div>
<div class="line"><a name="l06177"></a><span class="lineno"> 6177</span>&#160;</div>
<div class="line"><a name="l06178"></a><span class="lineno"> 6178</span>&#160;</div>
<div class="line"><a name="l06180"></a><span class="lineno"> 6180</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l06181"></a><span class="lineno"> 6181</span>&#160;        <span class="comment">// things to reset each iteration start for any steps</span></div>
<div class="line"><a name="l06182"></a><span class="lineno"> 6182</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l06184"></a><span class="lineno"> 6184</span>&#160;<span class="comment"></span>        canbreak=0; <span class="comment">// reset each start of iteration</span></div>
<div class="line"><a name="l06185"></a><span class="lineno"> 6185</span>&#160;        convreturnf3limit=0;</div>
<div class="line"><a name="l06186"></a><span class="lineno"> 6186</span>&#160;        notholding=1; <span class="comment">// default is no hold</span></div>
<div class="line"><a name="l06187"></a><span class="lineno"> 6187</span>&#160;        earlylowerror=0; <span class="comment">// reset each iteration</span></div>
<div class="line"><a name="l06188"></a><span class="lineno"> 6188</span>&#160;        lowitererror=0;</div>
<div class="line"><a name="l06189"></a><span class="lineno"> 6189</span>&#160;    </div>
<div class="line"><a name="l06190"></a><span class="lineno"> 6190</span>&#160;        <span class="keywordflow">if</span>(iter&gt;10){ <span class="comment">// KORALTODO: improve upon this later.  Only matters if not doing PMHD method</span></div>
<div class="line"><a name="l06191"></a><span class="lineno"> 6191</span>&#160;          <span class="comment">// assume trying hard and failing to work, then allow CASE radiation errors</span></div>
<div class="line"><a name="l06192"></a><span class="lineno"> 6192</span>&#160;          failreturnallowable=failreturnallowableuse=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a3dc38d50c77a49ac41a760b684ad7aab">UTOPRIMGENWRAPPERRETURNFAILRAD</a>;</div>
<div class="line"><a name="l06193"></a><span class="lineno"> 6193</span>&#160;        }</div>
<div class="line"><a name="l06194"></a><span class="lineno"> 6194</span>&#160;</div>
<div class="line"><a name="l06195"></a><span class="lineno"> 6195</span>&#160;        <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a00a5777dcc22797386a32f88a19cd973" title="whether to change damp factor during this instance.">CHANGEDAMPFACTOR</a>==1){</div>
<div class="line"><a name="l06196"></a><span class="lineno"> 6196</span>&#160;          <span class="keywordflow">if</span>(trueimpmaxiter==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a03eeb7614c6d7be8ab6fb4e6d2036ee3">IMPMAXITERQUICK</a> &amp;&amp; iter&gt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a03eeb7614c6d7be8ab6fb4e6d2036ee3">IMPMAXITERQUICK</a>/2){</div>
<div class="line"><a name="l06197"></a><span class="lineno"> 6197</span>&#160;            DAMPFACTOR=0.5*DAMPFACTOR0;</div>
<div class="line"><a name="l06198"></a><span class="lineno"> 6198</span>&#160;          }</div>
<div class="line"><a name="l06199"></a><span class="lineno"> 6199</span>&#160;          <span class="keywordflow">else</span> <span class="keywordflow">if</span>(trueimpmaxiter==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a58cca3253f4dfcefde5fe864699e297a">IMPMAXITERLONG</a> &amp;&amp; iter&gt;<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a58cca3253f4dfcefde5fe864699e297a">IMPMAXITERLONG</a>/2,20)){</div>
<div class="line"><a name="l06200"></a><span class="lineno"> 6200</span>&#160;            DAMPFACTOR=0.5*DAMPFACTOR0;</div>
<div class="line"><a name="l06201"></a><span class="lineno"> 6201</span>&#160;          }</div>
<div class="line"><a name="l06202"></a><span class="lineno"> 6202</span>&#160;          <span class="keywordflow">else</span> DAMPFACTOR=DAMPFACTOR0;</div>
<div class="line"><a name="l06203"></a><span class="lineno"> 6203</span>&#160;        }</div>
<div class="line"><a name="l06204"></a><span class="lineno"> 6204</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a00a5777dcc22797386a32f88a19cd973" title="whether to change damp factor during this instance.">CHANGEDAMPFACTOR</a>==2){</div>
<div class="line"><a name="l06205"></a><span class="lineno"> 6205</span>&#160;          <span class="keywordflow">if</span>(itermode==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a480c56e263c4874ccb40f3bbc1b32032">ITERMODESTAGES</a> &amp;&amp; iter==mtd.<a class="code" href="../../d6/dbe/structof__method.html#ab82f125cc45b1d2881155d70795fbf8a">BEGINMOMSTEPS</a>) DAMPFACTOR=0.5*DAMPFACTOR0; <span class="keywordflow">else</span> DAMPFACTOR=DAMPFACTOR0;</div>
<div class="line"><a name="l06206"></a><span class="lineno"> 6206</span>&#160;          <span class="keywordflow">if</span>(itermode==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a480c56e263c4874ccb40f3bbc1b32032">ITERMODESTAGES</a> &amp;&amp; iter==mtd.<a class="code" href="../../d6/dbe/structof__method.html#a6412a5671687f2d9f5be2fd0fafb81f1">BEGINENERGYSTEPS</a>) DAMPFACTOR=0.5*DAMPFACTOR0; <span class="keywordflow">else</span> DAMPFACTOR=DAMPFACTOR0;</div>
<div class="line"><a name="l06207"></a><span class="lineno"> 6207</span>&#160;          <span class="keywordflow">if</span>(itermode==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a480c56e263c4874ccb40f3bbc1b32032">ITERMODESTAGES</a> &amp;&amp; iter==mtd.<a class="code" href="../../d6/dbe/structof__method.html#a73849808a0b3a900c373b244089eab1f">BEGINFULLSTEPS</a>) DAMPFACTOR=0.25*DAMPFACTOR0; <span class="keywordflow">else</span> DAMPFACTOR=DAMPFACTOR0; <span class="comment">// 0.25 to be very careful since can change energy too much when suddenly turning back on momentum</span></div>
<div class="line"><a name="l06208"></a><span class="lineno"> 6208</span>&#160;        }</div>
<div class="line"><a name="l06209"></a><span class="lineno"> 6209</span>&#160;        <span class="keywordflow">else</span> DAMPFACTOR=DAMPFACTOR0;</div>
<div class="line"><a name="l06210"></a><span class="lineno"> 6210</span>&#160;      </div>
<div class="line"><a name="l06211"></a><span class="lineno"> 6211</span>&#160;</div>
<div class="line"><a name="l06212"></a><span class="lineno"> 6212</span>&#160;</div>
<div class="line"><a name="l06214"></a><span class="lineno"> 6214</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l06215"></a><span class="lineno"> 6215</span>&#160;        <span class="comment">// vector of conserved, primitives, and fractions of steps used at the previous few iterations</span></div>
<div class="line"><a name="l06216"></a><span class="lineno"> 6216</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l06218"></a><span class="lineno"> 6218</span>&#160;<span class="comment"></span>        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l06219"></a><span class="lineno"> 6219</span>&#160;          uuppp[pl]=uupp[pl]; <span class="comment">// uuppp...</span></div>
<div class="line"><a name="l06220"></a><span class="lineno"> 6220</span>&#160;          uupp[pl]=uup[pl]; <span class="comment">// uupp will have solution for inversion: P(uupp)</span></div>
<div class="line"><a name="l06221"></a><span class="lineno"> 6221</span>&#160;          uup[pl]=uu[pl]; <span class="comment">// uup will not necessarily have P(uup) because uu used Newton step.</span></div>
<div class="line"><a name="l06222"></a><span class="lineno"> 6222</span>&#160;          uuporig[pl]=uu[pl];</div>
<div class="line"><a name="l06223"></a><span class="lineno"> 6223</span>&#160;        </div>
<div class="line"><a name="l06224"></a><span class="lineno"> 6224</span>&#160;          ppppp[pl]=pppp[pl]; <span class="comment">// ppppp will have knowledge of 2 prior errorabsf1&#39;s</span></div>
<div class="line"><a name="l06225"></a><span class="lineno"> 6225</span>&#160;          pppp[pl]=ppp[pl]; <span class="comment">// pppp will have solution for inversion</span></div>
<div class="line"><a name="l06226"></a><span class="lineno"> 6226</span>&#160;          ppp[pl]=pp[pl]; <span class="comment">// ppp will not necessarily have solution because pp used Newton step.</span></div>
<div class="line"><a name="l06227"></a><span class="lineno"> 6227</span>&#160;          ppporig[pl]=pp[pl];</div>
<div class="line"><a name="l06228"></a><span class="lineno"> 6228</span>&#160;        }</div>
<div class="line"><a name="l06229"></a><span class="lineno"> 6229</span>&#160;</div>
<div class="line"><a name="l06230"></a><span class="lineno"> 6230</span>&#160;        fracdtuu0pp=fracdtuu0p; <span class="comment">// fracdtuu0 used when computing previous f1 and f2&#39;s</span></div>
<div class="line"><a name="l06231"></a><span class="lineno"> 6231</span>&#160;        fracdtuu0p=fracdtuu0; <span class="comment">// fracdtuu0 used when computing previous f1 and f2&#39;s</span></div>
<div class="line"><a name="l06232"></a><span class="lineno"> 6232</span>&#160;</div>
<div class="line"><a name="l06233"></a><span class="lineno"> 6233</span>&#160;        fracdtGpp=fracdtGp; <span class="comment">// fracdtG used when computing previous f1 and f2&#39;s</span></div>
<div class="line"><a name="l06234"></a><span class="lineno"> 6234</span>&#160;        fracdtGp=fracdtG; <span class="comment">// fracdtG used when computing previous f1 and f2&#39;s</span></div>
<div class="line"><a name="l06235"></a><span class="lineno"> 6235</span>&#160;</div>
<div class="line"><a name="l06236"></a><span class="lineno"> 6236</span>&#160;        errorabspf3=errorabsf3;</div>
<div class="line"><a name="l06237"></a><span class="lineno"> 6237</span>&#160;</div>
<div class="line"><a name="l06238"></a><span class="lineno"> 6238</span>&#160;</div>
<div class="line"><a name="l06240"></a><span class="lineno"> 6240</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l06241"></a><span class="lineno"> 6241</span>&#160;        <span class="comment">// reset at start of new use of equations</span></div>
<div class="line"><a name="l06242"></a><span class="lineno"> 6242</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l06244"></a><span class="lineno"> 6244</span>&#160;<span class="comment"></span>        <span class="keywordtype">int</span> itererror;</div>
<div class="line"><a name="l06245"></a><span class="lineno"> 6245</span>&#160;        <span class="keywordflow">if</span>(iter==mtd.<a class="code" href="../../d6/dbe/structof__method.html#ab82f125cc45b1d2881155d70795fbf8a">BEGINMOMSTEPS</a> || iter==mtd.<a class="code" href="../../d6/dbe/structof__method.html#a6412a5671687f2d9f5be2fd0fafb81f1">BEGINENERGYSTEPS</a> || iter==mtd.<a class="code" href="../../d6/dbe/structof__method.html#a73849808a0b3a900c373b244089eab1f">BEGINFULLSTEPS</a>){</div>
<div class="line"><a name="l06246"></a><span class="lineno"> 6246</span>&#160;          iterhold=0;</div>
<div class="line"><a name="l06247"></a><span class="lineno"> 6247</span>&#160;          countbadenergy=0;</div>
<div class="line"><a name="l06248"></a><span class="lineno"> 6248</span>&#160;          counterrorrose=0;</div>
<div class="line"><a name="l06249"></a><span class="lineno"> 6249</span>&#160;          priorerrorscount=0;</div>
<div class="line"><a name="l06250"></a><span class="lineno"> 6250</span>&#160;          holdingaspositive=0;</div>
<div class="line"><a name="l06251"></a><span class="lineno"> 6251</span>&#160;          countholdpositive=0;</div>
<div class="line"><a name="l06252"></a><span class="lineno"> 6252</span>&#160;          countugnegative=0;</div>
<div class="line"><a name="l06253"></a><span class="lineno"> 6253</span>&#160;          <span class="keywordflow">for</span>(itererror=0;itererror&lt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab4cf497679ffe5ebf0a9020558d74067">NUMPRIORERRORS</a>;itererror++) errorabspf1[itererror]=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>;</div>
<div class="line"><a name="l06254"></a><span class="lineno"> 6254</span>&#160;          <span class="comment">// store uu,pp before modified using new step</span></div>
<div class="line"><a name="l06255"></a><span class="lineno"> 6255</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l06256"></a><span class="lineno"> 6256</span>&#160;            uupriorsteptype[pl]=uu[pl];</div>
<div class="line"><a name="l06257"></a><span class="lineno"> 6257</span>&#160;            pppriorsteptype[pl]=pp[pl];</div>
<div class="line"><a name="l06258"></a><span class="lineno"> 6258</span>&#160;          }</div>
<div class="line"><a name="l06259"></a><span class="lineno"> 6259</span>&#160;        }</div>
<div class="line"><a name="l06260"></a><span class="lineno"> 6260</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(iter&gt;1){</div>
<div class="line"><a name="l06261"></a><span class="lineno"> 6261</span>&#160;          <span class="keywordflow">for</span>(itererror=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(priorerrorscount,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab4cf497679ffe5ebf0a9020558d74067">NUMPRIORERRORS</a>)-1;itererror&gt;=1;itererror--) errorabspf1[itererror]=errorabspf1[itererror-1]; <span class="comment">// shift to higher</span></div>
<div class="line"><a name="l06262"></a><span class="lineno"> 6262</span>&#160;          errorabspf1[0]=suberrorabsf1; <span class="comment">// only for equations that are currently iterating.</span></div>
<div class="line"><a name="l06263"></a><span class="lineno"> 6263</span>&#160;        }</div>
<div class="line"><a name="l06264"></a><span class="lineno"> 6264</span>&#160;        <span class="comment">// store previous f1 values</span></div>
<div class="line"><a name="l06265"></a><span class="lineno"> 6265</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) f1p[pl]=f1[pl];</div>
<div class="line"><a name="l06266"></a><span class="lineno"> 6266</span>&#160;</div>
<div class="line"><a name="l06267"></a><span class="lineno"> 6267</span>&#160;</div>
<div class="line"><a name="l06268"></a><span class="lineno"> 6268</span>&#160;</div>
<div class="line"><a name="l06269"></a><span class="lineno"> 6269</span>&#160;</div>
<div class="line"><a name="l06270"></a><span class="lineno"> 6270</span>&#160;        <span class="comment">// KORALTODO: Once use certain uu0 value and succeed in getting f1, not enough.  But if take a step and *then* good f1, then know that original U was good choice and can restart from that point instead of backing up uu0 again.</span></div>
<div class="line"><a name="l06271"></a><span class="lineno"> 6271</span>&#160;        <span class="comment">// KORALTODO: Look at whether bounding error by sign as in bisection (only true in 1D!!), and if approaching 0 slowly enough and still hit CASE, then must be real CASE not a stepping issue.</span></div>
<div class="line"><a name="l06272"></a><span class="lineno"> 6272</span>&#160;        <span class="comment">// KORALTODO: Getting f1 is just about f1(U) as far as radiation is concerned.  So as far as CASE issues, getting f1(U) means we are good with that U and we can certainly stick with the used uu0.</span></div>
<div class="line"><a name="l06273"></a><span class="lineno"> 6273</span>&#160;</div>
<div class="line"><a name="l06274"></a><span class="lineno"> 6274</span>&#160;</div>
<div class="line"><a name="l06275"></a><span class="lineno"> 6275</span>&#160;</div>
<div class="line"><a name="l06276"></a><span class="lineno"> 6276</span>&#160;</div>
<div class="line"><a name="l06278"></a><span class="lineno"> 6278</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l06279"></a><span class="lineno"> 6279</span>&#160;        <span class="comment">// get error function (f1) and inversion (uu-&gt;pp) using uu</span></div>
<div class="line"><a name="l06280"></a><span class="lineno"> 6280</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l06282"></a><span class="lineno"> 6282</span>&#160;<span class="comment"></span>        <span class="keywordtype">int</span> failreturnferr;</div>
<div class="line"><a name="l06283"></a><span class="lineno"> 6283</span>&#160;        <span class="keywordtype">int</span> convreturnf1;</div>
<div class="line"><a name="l06284"></a><span class="lineno"> 6284</span>&#160;        <span class="keywordflow">for</span>(f1iter=f1iterstart;f1iter&lt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ac8f7be0e2a8b0e45b7bf155cf0146c24">MAXF1TRIES</a>;f1iter++){</div>
<div class="line"><a name="l06285"></a><span class="lineno"> 6285</span>&#160;        </div>
<div class="line"><a name="l06286"></a><span class="lineno"> 6286</span>&#160;          <span class="comment">//        dualfprintf(fail_file,&quot;iter=%d debugiter=%d f1iter=%d\n&quot;,iter,debugiter,f1iter);</span></div>
<div class="line"><a name="l06287"></a><span class="lineno"> 6287</span>&#160;</div>
<div class="line"><a name="l06288"></a><span class="lineno"> 6288</span>&#160;</div>
<div class="line"><a name="l06289"></a><span class="lineno"> 6289</span>&#160;          <span class="keywordtype">int</span> whichcall=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a439b24ca8b87220703a1f950242344b7" title="f_implicit() call types">FIMPLICITCALLTYPEF1</a>;</div>
<div class="line"><a name="l06290"></a><span class="lineno"> 6290</span>&#160;          eomtypelocal=*eomtype; <span class="comment">// re-chose default each time.  If this reduces to a new eomtype, then Jacobian will stick with that for consistency!</span></div>
<div class="line"><a name="l06291"></a><span class="lineno"> 6291</span>&#160;          <span class="keywordtype">int</span> goexplicit;</div>
<div class="line"><a name="l06292"></a><span class="lineno"> 6292</span>&#160;          <span class="keywordtype">int</span> dimtypef=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a6c45d4170066340923e6ec67e05436f4">DIMTYPEFCONS</a>;</div>
<div class="line"><a name="l06293"></a><span class="lineno"> 6293</span>&#160;</div>
<div class="line"><a name="l06294"></a><span class="lineno"> 6294</span>&#160;          <span class="comment">// get original baseitermethod</span></div>
<div class="line"><a name="l06295"></a><span class="lineno"> 6295</span>&#160;          <span class="keywordtype">int</span> baseitermethodorig=*baseitermethod;</div>
<div class="line"><a name="l06296"></a><span class="lineno"> 6296</span>&#160;          <span class="comment">// use ppppp and uuppp as backup since one previous step is often off alot even if not already hitting point at which one should change baseitermethod</span></div>
<div class="line"><a name="l06297"></a><span class="lineno"> 6297</span>&#160;          failreturnferr=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#af46d2b1cf89a70a7e2ef503146c649a9" title="uu0 - original cons.">f_implicit</a>(allowbaseitermethodswitch, iter, f1iter, failreturnallowableuse, whichcall, impepsjac, showmessages, showmessagesheavy, allowlocalfailurefixandnoreport, &amp;eomtypelocal, whichcap, itermode, baseitermethod, fracenergy, dissmeasure, radinvmod, trueimptryconv, trueimptryconvabs, trueimpallowconvabs, trueimpmaxiter, realdt, dimtypef, dimfactU, ppppp, pp, piin, uuppp, Uiin, uu0, uu, fracdtG*realdt, ptrgeom, q, f1, f1norm, f1report, &amp;goexplicit, &amp;errorabsf1[0], &amp;errorabsf1[1], <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>, &amp;convreturnf1, nummhdinvsreturn, &amp;tautotmaxreturn, &amp;mtd, &amp;ru); <span class="comment">// modifies uu and pp, f1poret, goexplicit, errorabsf1[0,1], convreturnf1</span></div>
<div class="line"><a name="l06298"></a><span class="lineno"> 6298</span>&#160;</div>
<div class="line"><a name="l06299"></a><span class="lineno"> 6299</span>&#160;</div>
<div class="line"><a name="l06300"></a><span class="lineno"> 6300</span>&#160;          <span class="comment">// see if 4-force negligible</span></div>
<div class="line"><a name="l06301"></a><span class="lineno"> 6301</span>&#160;          <span class="keywordflow">if</span>(goexplicit){</div>
<div class="line"><a name="l06302"></a><span class="lineno"> 6302</span>&#160;            <span class="comment">// immediate return.</span></div>
<div class="line"><a name="l06303"></a><span class="lineno"> 6303</span>&#160;            <span class="keywordflow">return</span>(-1);</div>
<div class="line"><a name="l06304"></a><span class="lineno"> 6304</span>&#160;          }</div>
<div class="line"><a name="l06305"></a><span class="lineno"> 6305</span>&#160;</div>
<div class="line"><a name="l06306"></a><span class="lineno"> 6306</span>&#160;</div>
<div class="line"><a name="l06307"></a><span class="lineno"> 6307</span>&#160;          <span class="comment">// allow tolerance to be higher if optically thin enough, track for each iteration in case changes!</span></div>
<div class="line"><a name="l06308"></a><span class="lineno"> 6308</span>&#160;          <span class="keywordflow">if</span>(tautotmaxreturn&lt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ccd98422074e3018295182279a0df12">TAUTOTMAXHIGHERTOL</a>){</div>
<div class="line"><a name="l06309"></a><span class="lineno"> 6309</span>&#160;            trueimptryconv=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a4dab6e92e4bf6573af2e54f9f924fcc7">IMPTRYCONV_TAUTOTMAXHIGHERTOL</a>;</div>
<div class="line"><a name="l06310"></a><span class="lineno"> 6310</span>&#160;            <span class="comment">//  FTYPE trueimptryconv=IMPTRYCONV;</span></div>
<div class="line"><a name="l06311"></a><span class="lineno"> 6311</span>&#160;            trueimptryconvabs=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a37aa5c4b7b1b481299d87bf929d13b15" title="error for comparing to sum over all absolute errors">IMPTRYCONVABS</a>;</div>
<div class="line"><a name="l06312"></a><span class="lineno"> 6312</span>&#160;            trueimptryconvalt=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a3251670ff8087f873c6cac91ca50b16d">IMPTRYCONVALT</a>;</div>
<div class="line"><a name="l06313"></a><span class="lineno"> 6313</span>&#160;          }</div>
<div class="line"><a name="l06314"></a><span class="lineno"> 6314</span>&#160;          <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l06315"></a><span class="lineno"> 6315</span>&#160;            trueimptryconv=trueimptryconv_orig;</div>
<div class="line"><a name="l06316"></a><span class="lineno"> 6316</span>&#160;            <span class="comment">//  FTYPE trueimptryconv=IMPTRYCONV;</span></div>
<div class="line"><a name="l06317"></a><span class="lineno"> 6317</span>&#160;            trueimptryconvabs=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a37aa5c4b7b1b481299d87bf929d13b15" title="error for comparing to sum over all absolute errors">IMPTRYCONVABS</a>;</div>
<div class="line"><a name="l06318"></a><span class="lineno"> 6318</span>&#160;            trueimptryconvalt=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a3251670ff8087f873c6cac91ca50b16d">IMPTRYCONVALT</a>;</div>
<div class="line"><a name="l06319"></a><span class="lineno"> 6319</span>&#160;          }</div>
<div class="line"><a name="l06320"></a><span class="lineno"> 6320</span>&#160;</div>
<div class="line"><a name="l06321"></a><span class="lineno"> 6321</span>&#160;</div>
<div class="line"><a name="l06322"></a><span class="lineno"> 6322</span>&#160;          <span class="comment">// if baseitermethod changed, then need to deal with fracdtuu0 that may have different properties.  So while we don&#39;t necessarily go back too far on pp,uu, we need to pretend starting over with how we deal with uu0.</span></div>
<div class="line"><a name="l06323"></a><span class="lineno"> 6323</span>&#160;          <span class="keywordflow">if</span>(*baseitermethod!=baseitermethodorig) iter=1;</div>
<div class="line"><a name="l06324"></a><span class="lineno"> 6324</span>&#160;</div>
<div class="line"><a name="l06325"></a><span class="lineno"> 6325</span>&#160;</div>
<div class="line"><a name="l06326"></a><span class="lineno"> 6326</span>&#160;<span class="preprocessor">#if(MODEMETHOD==MODEENERGY ||MODEMETHOD==MODEENTROPY ||MODEMETHOD==MODESWITCH)</span></div>
<div class="line"><a name="l06327"></a><span class="lineno"> 6327</span>&#160;<span class="preprocessor"></span>          <span class="comment">// setup method and signs in case changed baseitermethod</span></div>
<div class="line"><a name="l06328"></a><span class="lineno"> 6328</span>&#160;          define_method(iter, &amp;eomtypelocal, itermode, *baseitermethod, fracenergy, dissmeasure, &amp;mtd);</div>
<div class="line"><a name="l06329"></a><span class="lineno"> 6329</span>&#160;          get_refUs(&amp;mtd, &amp;ru);</div>
<div class="line"><a name="l06330"></a><span class="lineno"> 6330</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l06331"></a><span class="lineno"> 6331</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l06332"></a><span class="lineno"> 6332</span>&#160;</div>
<div class="line"><a name="l06333"></a><span class="lineno"> 6333</span>&#160;</div>
<div class="line"><a name="l06334"></a><span class="lineno"> 6334</span>&#160;          <span class="comment">// f1 error calculation updated non-iterated pp or uu, so store.  Ok to re-store iterated uu and pp as well</span></div>
<div class="line"><a name="l06335"></a><span class="lineno"> 6335</span>&#160;          <span class="comment">// KORALTODO: This might mess up when f1 backs-up uu and pp</span></div>
<div class="line"><a name="l06336"></a><span class="lineno"> 6336</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l06337"></a><span class="lineno"> 6337</span>&#160;            uup[pl]=uu[pl];</div>
<div class="line"><a name="l06338"></a><span class="lineno"> 6338</span>&#160;            ppp[pl]=pp[pl];</div>
<div class="line"><a name="l06339"></a><span class="lineno"> 6339</span>&#160;          }</div>
<div class="line"><a name="l06340"></a><span class="lineno"> 6340</span>&#160;</div>
<div class="line"><a name="l06341"></a><span class="lineno"> 6341</span>&#160;</div>
<div class="line"><a name="l06342"></a><span class="lineno"> 6342</span>&#160;<span class="preprocessor">#if(0)</span></div>
<div class="line"><a name="l06343"></a><span class="lineno"> 6343</span>&#160;<span class="preprocessor"></span>          <span class="keywordflow">if</span>(pp[PRAD0]&lt;10.0*<a class="code" href="../../d8/d5b/defs_8general_8h.html#a5bd9da451f108352614cbc457524c5b0">ERADLIMIT</a>){</div>
<div class="line"><a name="l06344"></a><span class="lineno"> 6344</span>&#160;            <span class="comment">// try smaller tolerance</span></div>
<div class="line"><a name="l06345"></a><span class="lineno"> 6345</span>&#160;            trueimptryconv=10.0*<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a8913cb5d64cfec23ae1a3052930ec468">NUMEPSILON</a>;</div>
<div class="line"><a name="l06346"></a><span class="lineno"> 6346</span>&#160;            trueimptryconvabs=((<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a>)(NDIM+2)*trueimptryconv);</div>
<div class="line"><a name="l06347"></a><span class="lineno"> 6347</span>&#160;            trueimptryconvalt=(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(1<a class="code" href="../../d8/d60/init_8c.html#a07484107e6d9fdf38b53edf631d6511d">E</a>-8,trueimptryconvabs));</div>
<div class="line"><a name="l06348"></a><span class="lineno"> 6348</span>&#160;          }</div>
<div class="line"><a name="l06349"></a><span class="lineno"> 6349</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l06350"></a><span class="lineno"> 6350</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l06351"></a><span class="lineno"> 6351</span>&#160;</div>
<div class="line"><a name="l06352"></a><span class="lineno"> 6352</span>&#160;          <span class="keywordflow">if</span>(failreturnferr){</div>
<div class="line"><a name="l06353"></a><span class="lineno"> 6353</span>&#160;</div>
<div class="line"><a name="l06354"></a><span class="lineno"> 6354</span>&#160;            <span class="comment">//          if(debugfail&gt;=2) dualfprintf(fail_file,&quot;Failed f1: %d\n&quot;,failreturnferr);</span></div>
<div class="line"><a name="l06355"></a><span class="lineno"> 6355</span>&#160;</div>
<div class="line"><a name="l06356"></a><span class="lineno"> 6356</span>&#160;<span class="preprocessor">#define BACKUPRELEASEFAIL0 (1E-4)</span></div>
<div class="line"><a name="l06357"></a><span class="lineno"> 6357</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define BACKUPRELEASEFAIL1 (1E-6)</span></div>
<div class="line"><a name="l06358"></a><span class="lineno"> 6358</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define BACKUPRELEASEFAIL2 (1E-7)</span></div>
<div class="line"><a name="l06359"></a><span class="lineno"> 6359</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define MAXF1ITERRADTRY (10) // number of iterations after which to release and allow radiation to &quot;fail&quot;</span></div>
<div class="line"><a name="l06360"></a><span class="lineno"> 6360</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l06361"></a><span class="lineno"> 6361</span>&#160;            <span class="comment">// if backing up alot, then allow same failure as original Uiin in hopes that can recover that way (otherwise would have hoped would recover via flux update to Uiin)</span></div>
<div class="line"><a name="l06362"></a><span class="lineno"> 6362</span>&#160;            <span class="keywordflow">if</span>(fracdtuu0&lt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a2427d41f1c778b463107025713ecf497">BACKUPRELEASEFAIL0</a>){</div>
<div class="line"><a name="l06363"></a><span class="lineno"> 6363</span>&#160;              failreturnallowableuse=failreturnallowable;</div>
<div class="line"><a name="l06364"></a><span class="lineno"> 6364</span>&#160;            }</div>
<div class="line"><a name="l06365"></a><span class="lineno"> 6365</span>&#160;            <span class="keywordflow">if</span>(fracdtuu0&lt;BACKUPRELEASEFAIL1 || f1iter&gt;=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8e48eb04a2773bb03b456e4d82671431">MAXF1ITERRADTRY</a>){</div>
<div class="line"><a name="l06366"></a><span class="lineno"> 6366</span>&#160;              failreturnallowableuse=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a3dc38d50c77a49ac41a760b684ad7aab">UTOPRIMGENWRAPPERRETURNFAILRAD</a>;</div>
<div class="line"><a name="l06367"></a><span class="lineno"> 6367</span>&#160;            }</div>
<div class="line"><a name="l06368"></a><span class="lineno"> 6368</span>&#160;</div>
<div class="line"><a name="l06369"></a><span class="lineno"> 6369</span>&#160;</div>
<div class="line"><a name="l06370"></a><span class="lineno"> 6370</span>&#160;            <span class="keywordflow">if</span>(iter==1){</div>
<div class="line"><a name="l06371"></a><span class="lineno"> 6371</span>&#160;              <span class="comment">// if initial uu failed, then should take smaller jump from Uiin-&gt;uu until settled between fluid and radiation.</span></div>
<div class="line"><a name="l06372"></a><span class="lineno"> 6372</span>&#160;              <span class="comment">// If here, know original Uiin is good, so take baby steps in case uu needs heavy raditive changes.</span></div>
<div class="line"><a name="l06373"></a><span class="lineno"> 6373</span>&#160;              <span class="comment">// if f1 fails, try going back to Uiin a bit</span></div>
<div class="line"><a name="l06374"></a><span class="lineno"> 6374</span>&#160;              fracdtuu0*=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afccf4aec740d2b23fa42d2dbc356eb31">RADDAMPDELTA</a>; <span class="comment">// DAMP Uiin-&gt;uu0 step that may be too large and generated too large G</span></div>
<div class="line"><a name="l06375"></a><span class="lineno"> 6375</span>&#160;              fracdtuu0=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(1.0,fracdtuu0);</div>
<div class="line"><a name="l06376"></a><span class="lineno"> 6376</span>&#160;</div>
<div class="line"><a name="l06377"></a><span class="lineno"> 6377</span>&#160;              <span class="comment">//          if(fracdtuu0&lt;BACKUPRELEASEFAIL2) fracdtuu0=0.0; // just stop trying to start with some uu0 and revert to Uiin</span></div>
<div class="line"><a name="l06378"></a><span class="lineno"> 6378</span>&#160;</div>
<div class="line"><a name="l06379"></a><span class="lineno"> 6379</span>&#160;              <span class="comment">// modifies uup (ppp) and uu (pp) as if starting over, and then another call to f_implicit(f1) will change uu by generally smaller amount.</span></div>
<div class="line"><a name="l06380"></a><span class="lineno"> 6380</span>&#160;              <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l06381"></a><span class="lineno"> 6381</span>&#160;                uup[pl]=uu[pl]=uu0[pl];</div>
<div class="line"><a name="l06382"></a><span class="lineno"> 6382</span>&#160;                ppp[pl]=pp[pl]=pp0[pl];</div>
<div class="line"><a name="l06383"></a><span class="lineno"> 6383</span>&#160;              }</div>
<div class="line"><a name="l06384"></a><span class="lineno"> 6384</span>&#160;            }</div>
<div class="line"><a name="l06385"></a><span class="lineno"> 6385</span>&#160;            <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l06386"></a><span class="lineno"> 6386</span>&#160;              <span class="comment">// if here, then assume prior uup was good in sense that no failures like P(uup) is good inversion.  And uu=uup before f_implicit(f1) is called.</span></div>
<div class="line"><a name="l06387"></a><span class="lineno"> 6387</span>&#160;              <span class="comment">// No, not necessarily true, because uu updated with some-sized Newton step without checking if inversion is good for that uu.</span></div>
<div class="line"><a name="l06388"></a><span class="lineno"> 6388</span>&#160;              <span class="comment">// So need to damp between original uup and uupp .  This essentially damps Newton step now that have knowledge the Newton step was too large as based upon P(U) failure.</span></div>
<div class="line"><a name="l06389"></a><span class="lineno"> 6389</span>&#160;</div>
<div class="line"><a name="l06390"></a><span class="lineno"> 6390</span>&#160;              <span class="comment">// Avoid G-damping because not needed so far.  If added, competes in non-trivial way with fracuup damping that&#39;s required separately for large forces in some problems beyond iter=1 (e.g. NTUBE=31).</span></div>
<div class="line"><a name="l06391"></a><span class="lineno"> 6391</span>&#160;              <span class="comment">//          fracdtG*=RADDAMPDELTA; // DAMP give only fraction of 4-force to let uu to catch-up</span></div>
<div class="line"><a name="l06392"></a><span class="lineno"> 6392</span>&#160;              <span class="comment">//           fracdtG=0.5; // DAMP give only fraction of 4-force to let uu to catch-up</span></div>
<div class="line"><a name="l06393"></a><span class="lineno"> 6393</span>&#160;</div>
<div class="line"><a name="l06394"></a><span class="lineno"> 6394</span>&#160;              fracuup*=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afccf4aec740d2b23fa42d2dbc356eb31">RADDAMPDELTA</a>; <span class="comment">// DAMP in case Newton step is too large after iter&gt;1 and stuck with certain uu from Newton step that gets stored in uup above.</span></div>
<div class="line"><a name="l06395"></a><span class="lineno"> 6395</span>&#160;</div>
<div class="line"><a name="l06396"></a><span class="lineno"> 6396</span>&#160;              <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) uu[pl]=(1.0-fracuup)*uupp[pl] + fracuup*uuporig[pl];</div>
<div class="line"><a name="l06397"></a><span class="lineno"> 6397</span>&#160;              <span class="comment">//          PLOOP(pliter,pl) uu[pl]=(1.0-fracuup)*uupp[pl] + fracuup*uup[pl];</span></div>
<div class="line"><a name="l06398"></a><span class="lineno"> 6398</span>&#160;              <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) uup[pl]=uu[pl]; <span class="comment">// store new version of prior Newton step</span></div>
<div class="line"><a name="l06399"></a><span class="lineno"> 6399</span>&#160;</div>
<div class="line"><a name="l06400"></a><span class="lineno"> 6400</span>&#160;              <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) pp[pl]=(1.0-fracuup)*pppp[pl] + fracuup*ppporig[pl];</div>
<div class="line"><a name="l06401"></a><span class="lineno"> 6401</span>&#160;              <span class="comment">//          PLOOP(pliter,pl) pp[pl]=(1.0-fracuup)*pppp[pl] + fracuup*ppp[pl];</span></div>
<div class="line"><a name="l06402"></a><span class="lineno"> 6402</span>&#160;              <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) ppp[pl]=pp[pl]; <span class="comment">// store new version of prior Newton step</span></div>
<div class="line"><a name="l06403"></a><span class="lineno"> 6403</span>&#160;          </div>
<div class="line"><a name="l06404"></a><span class="lineno"> 6404</span>&#160;              <span class="comment">// get interpolated fracdtuu0 so using fracdtuu0 that was used with the corresponding uu</span></div>
<div class="line"><a name="l06405"></a><span class="lineno"> 6405</span>&#160;              fracdtuu0=(1.0-fracuup)*fracdtuu0pp + fracuup*fracdtuu0p;</div>
<div class="line"><a name="l06406"></a><span class="lineno"> 6406</span>&#160;              <span class="comment">// same for fracdtG</span></div>
<div class="line"><a name="l06407"></a><span class="lineno"> 6407</span>&#160;              fracdtG=(1.0-fracuup)*fracdtGpp + fracuup*fracdtGp;</div>
<div class="line"><a name="l06408"></a><span class="lineno"> 6408</span>&#160;</div>
<div class="line"><a name="l06409"></a><span class="lineno"> 6409</span>&#160;            }</div>
<div class="line"><a name="l06410"></a><span class="lineno"> 6410</span>&#160;</div>
<div class="line"><a name="l06411"></a><span class="lineno"> 6411</span>&#160;</div>
<div class="line"><a name="l06412"></a><span class="lineno"> 6412</span>&#160;            <span class="comment">// get uu0 (which may be changing)</span></div>
<div class="line"><a name="l06413"></a><span class="lineno"> 6413</span>&#160;            <span class="comment">//          FTYPE dUnongeomall[MAXTIMEORDER]={0.0};</span></div>
<div class="line"><a name="l06414"></a><span class="lineno"> 6414</span>&#160;            <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) uu0[pl]=UFSET(CUf,fracdtuu0*dt,Uiin[pl],Ufin[pl],dUother[pl],0.0,dUnongeomall);</div>
<div class="line"><a name="l06415"></a><span class="lineno"> 6415</span>&#160;            {</div>
<div class="line"><a name="l06416"></a><span class="lineno"> 6416</span>&#160;              <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> uuiterback[NPR];</div>
<div class="line"><a name="l06417"></a><span class="lineno"> 6417</span>&#160;              <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) uuiterback[pl] = uu[pl]; <span class="comment">// hold actual iterated quantities</span></div>
<div class="line"><a name="l06418"></a><span class="lineno"> 6418</span>&#160;              <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) uu[pl] = uu0[pl]; <span class="comment">// &quot;iterate&quot; non-iterated quantities</span></div>
<div class="line"><a name="l06419"></a><span class="lineno"> 6419</span>&#160;              <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a33e29fbc91c598484cbeb76769ce1fd2">JACLOOP</a>(ii,ru.<a class="code" href="../../d2/d46/structof__ref_u.html#a9f3d856dcdd8fa240dfbdcedfad888ef">startjac</a>,ru.<a class="code" href="../../d2/d46/structof__ref_u.html#af67164c1a42e2aefe0603597dd2ea25e">endjac</a>) uu[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[ii]] = uuiterback[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[ii]]; <span class="comment">// overwrite with actual previous step for iterated quantities</span></div>
<div class="line"><a name="l06420"></a><span class="lineno"> 6420</span>&#160;            }</div>
<div class="line"><a name="l06421"></a><span class="lineno"> 6421</span>&#160;            <span class="comment">// KORALNOTE: pp0 not used, setting uu0 above fixes error function where only uu0 is needed.</span></div>
<div class="line"><a name="l06422"></a><span class="lineno"> 6422</span>&#160;</div>
<div class="line"><a name="l06423"></a><span class="lineno"> 6423</span>&#160;</div>
<div class="line"><a name="l06424"></a><span class="lineno"> 6424</span>&#160;</div>
<div class="line"><a name="l06425"></a><span class="lineno"> 6425</span>&#160;            <span class="comment">// keep below so can count inversion failures against retry successes in the failure file.</span></div>
<div class="line"><a name="l06426"></a><span class="lineno"> 6426</span>&#160;            <span class="keywordflow">if</span>(showmessages &amp;&amp; debugfail&gt;=2) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;f_implicit for f1 failed: iter=%d  Backing-up both uu0 and G.: f1iter=%d fracdtuu0=%g fracdtG=%g fracuup=%g\n&quot;</span>,iter,f1iter,fracdtuu0,fracdtG,fracuup);</div>
<div class="line"><a name="l06427"></a><span class="lineno"> 6427</span>&#160;            <span class="keywordflow">if</span>(showmessagesheavy) <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;pl=%d Ui=%26.20g uu0=%26.20g uu0orig=%26.20g uu=%26.20g uup=%26.20g dUother=%26.20g\n&quot;</span>,pl,Uiin[pl],uu0[pl],uu0orig[pl],uu[pl],uup[pl],dUother[pl]);</div>
<div class="line"><a name="l06428"></a><span class="lineno"> 6428</span>&#160;          }<span class="comment">// end if failed inversion in f_implicit()</span></div>
<div class="line"><a name="l06429"></a><span class="lineno"> 6429</span>&#160;          <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l06430"></a><span class="lineno"> 6430</span>&#160;            <span class="comment">// then success, so was able to do inversion P(U) with change in radiation on fluid: P(uu[fluid] = uu0[fluid] - (uu[rad]-uu0[rad]))</span></div>
<div class="line"><a name="l06431"></a><span class="lineno"> 6431</span>&#160;            <span class="comment">// This doesn&#39;t necessarily mean could do P(uu0) except for iter=1.</span></div>
<div class="line"><a name="l06432"></a><span class="lineno"> 6432</span>&#160;            <span class="comment">// Corresponds to success for a certain P(uu0,uu) pair.</span></div>
<div class="line"><a name="l06433"></a><span class="lineno"> 6433</span>&#160;            <span class="keywordflow">if</span>(showmessagesheavy) <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;SUCCESS: pl=%d Ui=%26.20g uu0=%26.20g uu0orig=%26.20g uu=%26.20g uup=%26.20g dUother=%26.20g: pp(pnew)=%g : fracdtuu0=%g fracdtG=%g fracuup=%g\n&quot;</span>,pl,Uiin[pl],uu0[pl],uu0orig[pl],uu[pl],uup[pl],dUother[pl],pp[pl],fracdtuu0,fracdtG,fracuup);</div>
<div class="line"><a name="l06434"></a><span class="lineno"> 6434</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l06435"></a><span class="lineno"> 6435</span>&#160;          }</div>
<div class="line"><a name="l06436"></a><span class="lineno"> 6436</span>&#160;</div>
<div class="line"><a name="l06437"></a><span class="lineno"> 6437</span>&#160;          <span class="comment">// if during f1iter-ations u_g or rho is negative, switch to entropy</span></div>
<div class="line"><a name="l06438"></a><span class="lineno"> 6438</span>&#160;<span class="preprocessor">#define F1ITERSWITCHONNEG 20</span></div>
<div class="line"><a name="l06439"></a><span class="lineno"> 6439</span>&#160;<span class="preprocessor"></span>          <span class="keywordflow">if</span>(havebackup){</div>
<div class="line"><a name="l06440"></a><span class="lineno"> 6440</span>&#160;            <span class="keywordflow">if</span>(f1iter&gt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a6760034090ce1656e6c41246b013a81a">F1ITERSWITCHONNEG</a> &amp;&amp; (pp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>]&lt;0 || pp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]&lt;0)){</div>
<div class="line"><a name="l06441"></a><span class="lineno"> 6441</span>&#160;              failreturn=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a42e7e780e89073f5d14dfafda3bae62e">FAILRETURNMODESWITCH</a>; mathfailtype=70;</div>
<div class="line"><a name="l06442"></a><span class="lineno"> 6442</span>&#160;              <span class="keywordflow">if</span>(debugfail&gt;=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a969edf608c4953dd7b4b34e99dbc686c">DEBUGLEVELIMPSOLVERMORE</a>) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;Switched modes during f1iter=%d : rho=%21.15g ug=%21.15g\n&quot;</span>,f1iter,pp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>],pp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]);</div>
<div class="line"><a name="l06443"></a><span class="lineno"> 6443</span>&#160;              <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l06444"></a><span class="lineno"> 6444</span>&#160;            }</div>
<div class="line"><a name="l06445"></a><span class="lineno"> 6445</span>&#160;          }</div>
<div class="line"><a name="l06446"></a><span class="lineno"> 6446</span>&#160;</div>
<div class="line"><a name="l06447"></a><span class="lineno"> 6447</span>&#160;</div>
<div class="line"><a name="l06448"></a><span class="lineno"> 6448</span>&#160;          *nummhdstepsreturn = (int)(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a5f1c4a4bf07f7a6010404484cb9e6b50">nstroke</a>-nstrokeorig); <span class="comment">// get number of mhd inversion steps</span></div>
<div class="line"><a name="l06449"></a><span class="lineno"> 6449</span>&#160;          <span class="keywordflow">if</span>(*nummhdstepsreturn&gt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a55a6521d140538925946aeb79da33b5b">MAXMHDSTEPS</a>){</div>
<div class="line"><a name="l06450"></a><span class="lineno"> 6450</span>&#160;            failreturn=0;</div>
<div class="line"><a name="l06451"></a><span class="lineno"> 6451</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l06452"></a><span class="lineno"> 6452</span>&#160;          }</div>
<div class="line"><a name="l06453"></a><span class="lineno"> 6453</span>&#160;      </div>
<div class="line"><a name="l06454"></a><span class="lineno"> 6454</span>&#160;</div>
<div class="line"><a name="l06455"></a><span class="lineno"> 6455</span>&#160;        }<span class="comment">// end loop over f1iter</span></div>
<div class="line"><a name="l06456"></a><span class="lineno"> 6456</span>&#160;        *f1itersreturn += f1iter;</div>
<div class="line"><a name="l06457"></a><span class="lineno"> 6457</span>&#160;</div>
<div class="line"><a name="l06458"></a><span class="lineno"> 6458</span>&#160;</div>
<div class="line"><a name="l06460"></a><span class="lineno"> 6460</span>&#160;        <span class="comment">// break again out of total loop if broke in f1iter loop</span></div>
<div class="line"><a name="l06461"></a><span class="lineno"> 6461</span>&#160;        <span class="keywordflow">if</span>(failreturn){</div>
<div class="line"><a name="l06462"></a><span class="lineno"> 6462</span>&#160;          <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a7df8286c59d491ba1117884d33499a7a">prod0dualfprintf</a>(debugfail&gt;=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a969edf608c4953dd7b4b34e99dbc686c">DEBUGLEVELIMPSOLVERMORE</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;Breaking out of loop as think f1iter wanted us to.\n&quot;</span>);</div>
<div class="line"><a name="l06463"></a><span class="lineno"> 6463</span>&#160;          <span class="keywordflow">break</span>; <span class="comment">// ok to break here and avoid saying this was best solution since unlikely will be best as f1 can&#39;t even be obtained.  And so step shouldn&#39;t be taken as well.</span></div>
<div class="line"><a name="l06464"></a><span class="lineno"> 6464</span>&#160;        }</div>
<div class="line"><a name="l06465"></a><span class="lineno"> 6465</span>&#160;        <span class="keywordflow">else</span>{<span class="comment">// else if good f1</span></div>
<div class="line"><a name="l06466"></a><span class="lineno"> 6466</span>&#160;</div>
<div class="line"><a name="l06468"></a><span class="lineno"> 6468</span>&#160;          <span class="comment">//</span></div>
<div class="line"><a name="l06469"></a><span class="lineno"> 6469</span>&#160;          <span class="comment">// Check if reached max f1 iterations</span></div>
<div class="line"><a name="l06470"></a><span class="lineno"> 6470</span>&#160;          <span class="comment">//</span></div>
<div class="line"><a name="l06472"></a><span class="lineno"> 6472</span>&#160;<span class="comment"></span>          *nummhdstepsreturn = (int)(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a5f1c4a4bf07f7a6010404484cb9e6b50">nstroke</a>-nstrokeorig); <span class="comment">// get number of mhd inversion steps</span></div>
<div class="line"><a name="l06473"></a><span class="lineno"> 6473</span>&#160;          <span class="keywordflow">if</span>(f1iter==MAXF1TRIES || *nummhdstepsreturn&gt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a55a6521d140538925946aeb79da33b5b">MAXMHDSTEPS</a>){</div>
<div class="line"><a name="l06474"></a><span class="lineno"> 6474</span>&#160;</div>
<div class="line"><a name="l06475"></a><span class="lineno"> 6475</span>&#160;            <span class="keywordflow">if</span>(f1iter==MAXF1TRIES) <span class="keywordflow">if</span>(debugfail&gt;=2) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;Reached MAXF1TRIES=%d (nummhdstepsreturn=%d: %d %d trueimpmaxiter=%d): fracdtuu0=%g nstep=%ld steppart=%d ijk=%d %d %d : iter=%d eomtype=%d baseitermethod=%d failreturn=%d\n&quot;</span>,MAXF1TRIES,*nummhdstepsreturn,nstrokeorig,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a5f1c4a4bf07f7a6010404484cb9e6b50">nstroke</a>,trueimpmaxiter,fracdtuu0,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a1a1088d87617078680f1fd0f0d707384">nstep</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a70170b90229f9fc05eebf8508a685c70">steppart</a>,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,iter,eomtypelocal,*baseitermethod,failreturn);</div>
<div class="line"><a name="l06476"></a><span class="lineno"> 6476</span>&#160;            <span class="keywordflow">if</span>(*nummhdstepsreturn&gt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a55a6521d140538925946aeb79da33b5b">MAXMHDSTEPS</a>) <span class="keywordflow">if</span>(debugfail&gt;=2) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;Reached MAXMHDSTEPS=%d: fracdtuu0=%g nstep=%ld steppart=%d ijk=%d %d %d : iter=%d eomtype=%d baseitermethod=%d failreturn=%d\n&quot;</span>,*nummhdstepsreturn,fracdtuu0,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a1a1088d87617078680f1fd0f0d707384">nstep</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a70170b90229f9fc05eebf8508a685c70">steppart</a>,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,iter,eomtypelocal,*baseitermethod,failreturn);</div>
<div class="line"><a name="l06477"></a><span class="lineno"> 6477</span>&#160;            <span class="keywordflow">if</span>(havebackup){</div>
<div class="line"><a name="l06478"></a><span class="lineno"> 6478</span>&#160;              failreturn=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a42e7e780e89073f5d14dfafda3bae62e">FAILRETURNMODESWITCH</a>; mathfailtype=20;</div>
<div class="line"><a name="l06479"></a><span class="lineno"> 6479</span>&#160;              <span class="keywordflow">if</span>(debugfail&gt;=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a969edf608c4953dd7b4b34e99dbc686c">DEBUGLEVELIMPSOLVERMORE</a>) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;SWITCHING MODE: Detected MAXF1TRIES\n&quot;</span>);</div>
<div class="line"><a name="l06480"></a><span class="lineno"> 6480</span>&#160;              <span class="keywordflow">break</span>; <span class="comment">// ok to break, no better solution to store as best</span></div>
<div class="line"><a name="l06481"></a><span class="lineno"> 6481</span>&#160;            }</div>
<div class="line"><a name="l06482"></a><span class="lineno"> 6482</span>&#160;            <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l06483"></a><span class="lineno"> 6483</span>&#160;              failreturn=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab0abd953f677a44020dc50259c410486">FAILRETURNGENERAL</a>; mathfailtype=2;</div>
<div class="line"><a name="l06484"></a><span class="lineno"> 6484</span>&#160;              <span class="keywordflow">if</span>(doingit==1) myexit(10000000); <span class="comment">// DEBUG</span></div>
<div class="line"><a name="l06485"></a><span class="lineno"> 6485</span>&#160;              <span class="comment">// Note that if inversion reduces to entropy or cold, don&#39;t fail, so passes until reached this point.  But convergence can be hard if flipping around which EOMs for the inversion are actually used.</span></div>
<div class="line"><a name="l06486"></a><span class="lineno"> 6486</span>&#160;              <span class="keywordflow">break</span>; <span class="comment">// ok to break, no better solution to store as best</span></div>
<div class="line"><a name="l06487"></a><span class="lineno"> 6487</span>&#160;            }</div>
<div class="line"><a name="l06488"></a><span class="lineno"> 6488</span>&#160;          }</div>
<div class="line"><a name="l06489"></a><span class="lineno"> 6489</span>&#160;          <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l06490"></a><span class="lineno"> 6490</span>&#160;            <span class="comment">// restore fracuup back to 1 since this is only meant to adjust how much go back to previous uu to be able to get f1 computed.</span></div>
<div class="line"><a name="l06491"></a><span class="lineno"> 6491</span>&#160;            <span class="comment">// fracuup doesn&#39;t stay &lt;1.0 because each attempt to get f1 is independent.</span></div>
<div class="line"><a name="l06492"></a><span class="lineno"> 6492</span>&#160;            <span class="comment">// KORALNOTE: Perhaps reasonable and safer to keep fracuup as not reverted back to 1, since apparently unable to take full steps.  This effectively damps stepping.</span></div>
<div class="line"><a name="l06493"></a><span class="lineno"> 6493</span>&#160;            fracuup=1.0;</div>
<div class="line"><a name="l06494"></a><span class="lineno"> 6494</span>&#160;          }</div>
<div class="line"><a name="l06495"></a><span class="lineno"> 6495</span>&#160;  </div>
<div class="line"><a name="l06496"></a><span class="lineno"> 6496</span>&#160;          <span class="comment">// diagnose</span></div>
<div class="line"><a name="l06497"></a><span class="lineno"> 6497</span>&#160;          <span class="keywordflow">if</span>(showmessagesheavy) <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;i=%d ii=%d pl=%d f1=%g\n&quot;</span>,ptrgeom-&gt;i,ii,pl,f1[pl]);</div>
<div class="line"><a name="l06498"></a><span class="lineno"> 6498</span>&#160;        }<span class="comment">// else if f1 calculation didn&#39;t fail.</span></div>
<div class="line"><a name="l06499"></a><span class="lineno"> 6499</span>&#160;</div>
<div class="line"><a name="l06500"></a><span class="lineno"> 6500</span>&#160;</div>
<div class="line"><a name="l06501"></a><span class="lineno"> 6501</span>&#160;    </div>
<div class="line"><a name="l06502"></a><span class="lineno"> 6502</span>&#160;    </div>
<div class="line"><a name="l06504"></a><span class="lineno"> 6504</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l06505"></a><span class="lineno"> 6505</span>&#160;        <span class="comment">// get type of EOMTYPE</span></div>
<div class="line"><a name="l06506"></a><span class="lineno"> 6506</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l06508"></a><span class="lineno"> 6508</span>&#160;<span class="comment"></span>        <span class="keywordtype">int</span> eomcond=(eomtypelocal==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a03d89f51ab60206791830c886d62bfd0">EOMGRMHD</a> || eomtypelocal==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aa28b06d889a02621b45edc716bfb2d01">EOMDEFAULT</a> &amp;&amp; <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aa28b06d889a02621b45edc716bfb2d01">EOMDEFAULT</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a03d89f51ab60206791830c886d62bfd0">EOMGRMHD</a>);</div>
<div class="line"><a name="l06509"></a><span class="lineno"> 6509</span>&#160;</div>
<div class="line"><a name="l06510"></a><span class="lineno"> 6510</span>&#160;</div>
<div class="line"><a name="l06512"></a><span class="lineno"> 6512</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l06513"></a><span class="lineno"> 6513</span>&#160;        <span class="comment">// see if should check convergence or check how solution is behaving.</span></div>
<div class="line"><a name="l06514"></a><span class="lineno"> 6514</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l06516"></a><span class="lineno"> 6516</span>&#160;<span class="comment"></span>        checkconv=1;</div>
<div class="line"><a name="l06518"></a><span class="lineno"> 6518</span>&#160;        <span class="comment">//    if(fracuup!=1.0){</span></div>
<div class="line"><a name="l06519"></a><span class="lineno"> 6519</span>&#160;        <span class="comment">//      if(fabs(fracuup-1.0)&gt;10.0*NUMEPSILON){</span></div>
<div class="line"><a name="l06520"></a><span class="lineno"> 6520</span>&#160;        <span class="keywordflow">if</span>(fracuup&lt;1.0){</div>
<div class="line"><a name="l06521"></a><span class="lineno"> 6521</span>&#160;          <span class="comment">// try increasing amount of uu or pp used</span></div>
<div class="line"><a name="l06522"></a><span class="lineno"> 6522</span>&#160;          checkconv=0;</div>
<div class="line"><a name="l06523"></a><span class="lineno"> 6523</span>&#160;        }</div>
<div class="line"><a name="l06525"></a><span class="lineno"> 6525</span>&#160;        <span class="comment">//    if(fracdtuu0!=1.0){</span></div>
<div class="line"><a name="l06526"></a><span class="lineno"> 6526</span>&#160;        <span class="comment">//      if(fabs(fracdtuu0-1.0)&gt;10.0*NUMEPSILON &amp;&amp; changeotherdt){</span></div>
<div class="line"><a name="l06527"></a><span class="lineno"> 6527</span>&#160;        <span class="keywordflow">if</span>(fracdtuu0&lt;1.0){</div>
<div class="line"><a name="l06528"></a><span class="lineno"> 6528</span>&#160;          checkconv=0;</div>
<div class="line"><a name="l06529"></a><span class="lineno"> 6529</span>&#160;        }</div>
<div class="line"><a name="l06531"></a><span class="lineno"> 6531</span>&#160;        <span class="comment">//    if(fracdtG!=1.0){</span></div>
<div class="line"><a name="l06532"></a><span class="lineno"> 6532</span>&#160;        <span class="comment">//      if(fabs(fracdtG-1.0)&gt;10.0*NUMEPSILON &amp;&amp; changeotherdt){</span></div>
<div class="line"><a name="l06533"></a><span class="lineno"> 6533</span>&#160;        <span class="keywordflow">if</span>(fracdtG&lt;1.0 &amp;&amp; changeotherdt){</div>
<div class="line"><a name="l06534"></a><span class="lineno"> 6534</span>&#160;          checkconv=0;</div>
<div class="line"><a name="l06535"></a><span class="lineno"> 6535</span>&#160;        }      </div>
<div class="line"><a name="l06537"></a><span class="lineno"> 6537</span>&#160;        <span class="keywordflow">if</span>(iter&lt;mtd.<a class="code" href="../../d6/dbe/structof__method.html#a95212a0a740e95e0e2cc94cc9f4d0f7d">BEGINNORMALSTEPS</a>) checkconv=0; <span class="comment">// don&#39;t check actual convergence till doing full steps</span></div>
<div class="line"><a name="l06539"></a><span class="lineno"> 6539</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l06540"></a><span class="lineno"> 6540</span>&#160;</div>
<div class="line"><a name="l06541"></a><span class="lineno"> 6541</span>&#160;</div>
<div class="line"><a name="l06543"></a><span class="lineno"> 6543</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l06544"></a><span class="lineno"> 6544</span>&#160;        <span class="comment">// get error using f1 and f1norm</span></div>
<div class="line"><a name="l06545"></a><span class="lineno"> 6545</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l06547"></a><span class="lineno"> 6547</span>&#160;<span class="comment"></span>        <span class="comment">//      int convreturnf1=f_error_check(showmessages, showmessagesheavy, iter, trueimptryconv, trueimptryconvabs, realdt, DIMTYPEFCONS,eomtypelocal , *radinvmod, itermode,*baseitermethod,fracenergy,dissmeasure,dimfactU,pp,piin,f1,f1norm,f1report,Uiin,uu0,uu,ptrgeom,&amp;errorabsf1[0],&amp;errorabsf1[1],WHICHERROR,&amp;mtd,&amp;ru);</span></div>
<div class="line"><a name="l06548"></a><span class="lineno"> 6548</span>&#160;        <span class="comment">// but don&#39;t break, since need to iterate a bit first and check |dU/U| and need to see if checkconv==1</span></div>
<div class="line"><a name="l06549"></a><span class="lineno"> 6549</span>&#160;        <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> numsub=0;</div>
<div class="line"><a name="l06550"></a><span class="lineno"> 6550</span>&#160;        suberrorabsf1=0.0;  <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a72fc248e1a3a074c499fa4dfe283db6d">JACLOOPSUBERROR</a>(jj,ru.<a class="code" href="../../d2/d46/structof__ref_u.html#a9f3d856dcdd8fa240dfbdcedfad888ef">startjac</a>,ru.<a class="code" href="../../d2/d46/structof__ref_u.html#af67164c1a42e2aefe0603597dd2ea25e">endjac</a>){</div>
<div class="line"><a name="l06551"></a><span class="lineno"> 6551</span>&#160;          suberrorabsf1     += fabs(f1report[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[jj]]); <span class="comment">// e.g. may only be energy error or only momentum error.</span></div>
<div class="line"><a name="l06552"></a><span class="lineno"> 6552</span>&#160;          numsub += 1.0;</div>
<div class="line"><a name="l06553"></a><span class="lineno"> 6553</span>&#160;        }</div>
<div class="line"><a name="l06554"></a><span class="lineno"> 6554</span>&#160;</div>
<div class="line"><a name="l06555"></a><span class="lineno"> 6555</span>&#160;</div>
<div class="line"><a name="l06556"></a><span class="lineno"> 6556</span>&#160;</div>
<div class="line"><a name="l06557"></a><span class="lineno"> 6557</span>&#160;        <span class="comment">// DEBUG STUFF</span></div>
<div class="line"><a name="l06558"></a><span class="lineno"> 6558</span>&#160;<span class="preprocessor">#if(DEBUGMAXITER)</span></div>
<div class="line"><a name="l06559"></a><span class="lineno"> 6559</span>&#160;<span class="preprocessor"></span>        <span class="keywordflow">if</span>(dampattempt==0){</div>
<div class="line"><a name="l06560"></a><span class="lineno"> 6560</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) pppreholdlist[debugiter][pl]=pp[pl]; <span class="comment">// just default dummy value in case break</span></div>
<div class="line"><a name="l06561"></a><span class="lineno"> 6561</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) ppposholdlist[debugiter][pl]=pp[pl]; <span class="comment">// just default dummy value in case break</span></div>
<div class="line"><a name="l06562"></a><span class="lineno"> 6562</span>&#160;          <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8968c59c029dc64a1057992a70ef8dbd" title="0: show primitive 1: show u^ and urad^">DEBUGMAXITERVELOCITY</a>==1){</div>
<div class="line"><a name="l06563"></a><span class="lineno"> 6563</span>&#160;            <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj){</div>
<div class="line"><a name="l06564"></a><span class="lineno"> 6564</span>&#160;              pppreholdlist[debugiter][<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>+jj-1]=q-&gt;<a class="code" href="../../d1/d83/structof__state.html#aab723d3c7c2c48b7246cc7d7d5379eed">ucon</a>[jj];</div>
<div class="line"><a name="l06565"></a><span class="lineno"> 6565</span>&#160;              pppreholdlist[debugiter][URAD1+jj-1]=q-&gt;<a class="code" href="../../d1/d83/structof__state.html#a3bf8e15ee6ae95831230791baf2fc570">uradcon</a>[jj];</div>
<div class="line"><a name="l06566"></a><span class="lineno"> 6566</span>&#160;              ppposholdlist[debugiter][<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>+jj-1]=q-&gt;<a class="code" href="../../d1/d83/structof__state.html#aab723d3c7c2c48b7246cc7d7d5379eed">ucon</a>[jj];</div>
<div class="line"><a name="l06567"></a><span class="lineno"> 6567</span>&#160;              ppposholdlist[debugiter][URAD1+jj-1]=q-&gt;<a class="code" href="../../d1/d83/structof__state.html#a3bf8e15ee6ae95831230791baf2fc570">uradcon</a>[jj];</div>
<div class="line"><a name="l06568"></a><span class="lineno"> 6568</span>&#160;            }</div>
<div class="line"><a name="l06569"></a><span class="lineno"> 6569</span>&#160;          }</div>
<div class="line"><a name="l06570"></a><span class="lineno"> 6570</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) f1reportlist[debugiter][pl]=f1report[pl];</div>
<div class="line"><a name="l06571"></a><span class="lineno"> 6571</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) f1list[debugiter][pl]=f1[pl];</div>
<div class="line"><a name="l06572"></a><span class="lineno"> 6572</span>&#160;          realiterlist[debugiter]=iter;</div>
<div class="line"><a name="l06573"></a><span class="lineno"> 6573</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a59b7ef1517ff22fd4dfce4cf6d380c55" title="loop over all Dimensions; second rank loop">DLOOP</a>(jj,kk) jaclist[debugiter][jj][kk]=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>; <span class="comment">// just default dummy value in case break</span></div>
<div class="line"><a name="l06574"></a><span class="lineno"> 6574</span>&#160;          implicititerlist[debugiter]=mtd.<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>;</div>
<div class="line"><a name="l06575"></a><span class="lineno"> 6575</span>&#160;          implicitferrlist[debugiter]=mtd.<a class="code" href="../../d6/dbe/structof__method.html#a2c5c387f7161b69aad77ee5a13d30c68">implicitferr</a>;</div>
<div class="line"><a name="l06576"></a><span class="lineno"> 6576</span>&#160;          fracdamplist[0]=fracdtuu0;</div>
<div class="line"><a name="l06577"></a><span class="lineno"> 6577</span>&#160;          fracdamplist[1]=fracdtG;</div>
<div class="line"><a name="l06578"></a><span class="lineno"> 6578</span>&#160;          fracdamplist[2]=DAMPFACTOR;</div>
<div class="line"><a name="l06579"></a><span class="lineno"> 6579</span>&#160;        }</div>
<div class="line"><a name="l06580"></a><span class="lineno"> 6580</span>&#160;        errorabsf1list[debugiter]=errorabsf1[0];</div>
<div class="line"><a name="l06581"></a><span class="lineno"> 6581</span>&#160;        errorallabsf1list[debugiter]=errorabsf1[1];</div>
<div class="line"><a name="l06582"></a><span class="lineno"> 6582</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l06583"></a><span class="lineno"> 6583</span>&#160;<span class="preprocessor"></span>        errorabsf1list[debugiter]=errorabsf1[0];</div>
<div class="line"><a name="l06584"></a><span class="lineno"> 6584</span>&#160;        errorallabsf1list[debugiter]=errorabsf1[1];</div>
<div class="line"><a name="l06585"></a><span class="lineno"> 6585</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l06586"></a><span class="lineno"> 6586</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l06587"></a><span class="lineno"> 6587</span>&#160;</div>
<div class="line"><a name="l06588"></a><span class="lineno"> 6588</span>&#160;</div>
<div class="line"><a name="l06590"></a><span class="lineno"> 6590</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l06591"></a><span class="lineno"> 6591</span>&#160;        <span class="comment">// If error dropped below tolerance for this sub-matrix iteration mode, then continue to next level.</span></div>
<div class="line"><a name="l06592"></a><span class="lineno"> 6592</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l06594"></a><span class="lineno"> 6594</span>&#160;<span class="comment"></span>        <span class="comment">// check if energy only iteration has error that has dropped below tolerance, then can move on to </span></div>
<div class="line"><a name="l06595"></a><span class="lineno"> 6595</span>&#160;        <span class="keywordflow">if</span>(itermode==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a480c56e263c4874ccb40f3bbc1b32032">ITERMODESTAGES</a> &amp;&amp; iter&gt;=mtd.<a class="code" href="../../d6/dbe/structof__method.html#ab82f125cc45b1d2881155d70795fbf8a">BEGINMOMSTEPS</a> &amp;&amp; iter&lt;=mtd.<a class="code" href="../../d6/dbe/structof__method.html#a854fcca7e3e1d7ab0a6955321ce698de">ENDMOMSTEPS</a>){</div>
<div class="line"><a name="l06596"></a><span class="lineno"> 6596</span>&#160;          <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> errorabs3=0.0; <span class="keywordtype">int</span> testi;</div>
<div class="line"><a name="l06597"></a><span class="lineno"> 6597</span>&#160;          <span class="keywordflow">for</span>(testi=1;testi&lt;=3;testi++) errorabs3 += fabs(f1report[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[testi]]);</div>
<div class="line"><a name="l06598"></a><span class="lineno"> 6598</span>&#160;          <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> errorneed=((<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a>)(3+2)*trueimptryconv);</div>
<div class="line"><a name="l06599"></a><span class="lineno"> 6599</span>&#160;          <span class="keywordflow">if</span>(errorabs3&lt;errorneed){</div>
<div class="line"><a name="l06600"></a><span class="lineno"> 6600</span>&#160;            <span class="keywordflow">if</span>(iter&lt;=mtd.<a class="code" href="../../d6/dbe/structof__method.html#a854fcca7e3e1d7ab0a6955321ce698de">ENDMOMSTEPS</a>){ iter=mtd.<a class="code" href="../../d6/dbe/structof__method.html#a6412a5671687f2d9f5be2fd0fafb81f1">BEGINENERGYSTEPS</a>-1; <span class="keywordflow">continue</span>;} <span class="comment">// force as if already doing energy steps.  If already next iteration is to be this energy step, then no skipping needed.</span></div>
<div class="line"><a name="l06601"></a><span class="lineno"> 6601</span>&#160;            <span class="comment">// continue assumes not triggered when iter&gt;trueimpmaxiter</span></div>
<div class="line"><a name="l06602"></a><span class="lineno"> 6602</span>&#160;          }</div>
<div class="line"><a name="l06603"></a><span class="lineno"> 6603</span>&#160;        }</div>
<div class="line"><a name="l06604"></a><span class="lineno"> 6604</span>&#160;        <span class="comment">// check if energy only iteration has error that has dropped below tolerance, then can move on to </span></div>
<div class="line"><a name="l06605"></a><span class="lineno"> 6605</span>&#160;        <span class="keywordflow">if</span>(itermode==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a480c56e263c4874ccb40f3bbc1b32032">ITERMODESTAGES</a> &amp;&amp; iter&gt;=mtd.<a class="code" href="../../d6/dbe/structof__method.html#a6412a5671687f2d9f5be2fd0fafb81f1">BEGINENERGYSTEPS</a> &amp;&amp; iter&lt;=mtd.<a class="code" href="../../d6/dbe/structof__method.html#a9829068ffbaa124dda46be28c48bfccc">ENDENERGYSTEPS</a>){</div>
<div class="line"><a name="l06606"></a><span class="lineno"> 6606</span>&#160;          <span class="comment">//        if(f1report[ru.irefU[0]]==BIG){ dualfprintf(fail_file,&quot;FUDGE\n&quot;); }</span></div>
<div class="line"><a name="l06607"></a><span class="lineno"> 6607</span>&#160;          <span class="comment">// SUPERGODMARK: valgrind says belw is undefined, but don&#39;t see it.</span></div>
<div class="line"><a name="l06608"></a><span class="lineno"> 6608</span>&#160;          <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> errorabs1=0.0; <span class="keywordtype">int</span> testi;</div>
<div class="line"><a name="l06609"></a><span class="lineno"> 6609</span>&#160;          <span class="keywordflow">for</span>(testi=1;testi&lt;=1;testi++) errorabs1 += fabs(f1report[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[testi]]);</div>
<div class="line"><a name="l06610"></a><span class="lineno"> 6610</span>&#160;          <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> errorneed=((<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a>)(1+2)*trueimptryconv);</div>
<div class="line"><a name="l06611"></a><span class="lineno"> 6611</span>&#160;          <span class="keywordflow">if</span>(errorabs1&lt;errorneed){</div>
<div class="line"><a name="l06612"></a><span class="lineno"> 6612</span>&#160;            <span class="keywordflow">if</span>(iter&lt;=mtd.<a class="code" href="../../d6/dbe/structof__method.html#a9829068ffbaa124dda46be28c48bfccc">ENDENERGYSTEPS</a>){ iter=mtd.<a class="code" href="../../d6/dbe/structof__method.html#a73849808a0b3a900c373b244089eab1f">BEGINFULLSTEPS</a>-1; <span class="keywordflow">continue</span>;} <span class="comment">// force as if already doing normal steps.  If already next iteration is to be normal step, no need to skip.</span></div>
<div class="line"><a name="l06613"></a><span class="lineno"> 6613</span>&#160;            <span class="comment">// continue assumes not triggered when iter&gt;trueimpmaxiter</span></div>
<div class="line"><a name="l06614"></a><span class="lineno"> 6614</span>&#160;          }</div>
<div class="line"><a name="l06615"></a><span class="lineno"> 6615</span>&#160;        }</div>
<div class="line"><a name="l06616"></a><span class="lineno"> 6616</span>&#160;</div>
<div class="line"><a name="l06617"></a><span class="lineno"> 6617</span>&#160;</div>
<div class="line"><a name="l06618"></a><span class="lineno"> 6618</span>&#160;</div>
<div class="line"><a name="l06619"></a><span class="lineno"> 6619</span>&#160;</div>
<div class="line"><a name="l06620"></a><span class="lineno"> 6620</span>&#160;</div>
<div class="line"><a name="l06621"></a><span class="lineno"> 6621</span>&#160;</div>
<div class="line"><a name="l06622"></a><span class="lineno"> 6622</span>&#160;</div>
<div class="line"><a name="l06624"></a><span class="lineno"> 6624</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l06625"></a><span class="lineno"> 6625</span>&#160;        <span class="comment">//  PRE NEWTON ADJUSTMENTS</span></div>
<div class="line"><a name="l06626"></a><span class="lineno"> 6626</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l06628"></a><span class="lineno"> 6628</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l06629"></a><span class="lineno"> 6629</span>&#160;<span class="preprocessor">#define ERRORJUMPCHECK 0 // no longer needed with error trend check, and expensive if u_g or Erf try to be &lt;0 since hits continue.</span></div>
<div class="line"><a name="l06630"></a><span class="lineno"> 6630</span>&#160;<span class="preprocessor"></span>        <span class="comment">// whether to check if error jumps up, between last and current step, in irefU[0] -- u_g for QTYPMHD method.  If so, backs-up step a bit for all quantities iterated and try to get error again</span></div>
<div class="line"><a name="l06631"></a><span class="lineno"> 6631</span>&#160;<span class="preprocessor">#define BUFFERITER 0 // how many iterations to wait until start to check how error is doing.  When switching iteration methods, error will often rise initially in f1[0], but that&#39;s ok.  But can temper jump by bridging used pp,uu, so ok to keep as 0 perhaps.</span></div>
<div class="line"><a name="l06632"></a><span class="lineno"> 6632</span>&#160;<span class="preprocessor"></span>        <span class="comment">// check if doing energy stepping and error jumped up too much</span></div>
<div class="line"><a name="l06633"></a><span class="lineno"> 6633</span>&#160;<span class="preprocessor">#define NUMJUMPCHECKSMAX 5 // must limit, else if really drops-out and can&#39;t help, need to just accept.</span></div>
<div class="line"><a name="l06634"></a><span class="lineno"> 6634</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#if(ERRORJUMPCHECK)</span></div>
<div class="line"><a name="l06635"></a><span class="lineno"> 6635</span>&#160;<span class="preprocessor"></span>        <span class="keywordflow">if</span>(numjumpchecks&lt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a1ec26131e3649a5d995f22815710c79b">NUMJUMPCHECKSMAX</a>){</div>
<div class="line"><a name="l06636"></a><span class="lineno"> 6636</span>&#160;          <span class="keywordflow">if</span>(iter&gt;=mtd.<a class="code" href="../../d6/dbe/structof__method.html#a6412a5671687f2d9f5be2fd0fafb81f1">BEGINENERGYSTEPS</a>+<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa12a0ed38eedece33080c0191982e4fa">BUFFERITER</a> &amp;&amp; iter&lt;=mtd.ENDENERGYSTEPS || iter&gt;=mtd.<a class="code" href="../../d6/dbe/structof__method.html#a73849808a0b3a900c373b244089eab1f">BEGINFULLSTEPS</a>+<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa12a0ed38eedece33080c0191982e4fa">BUFFERITER</a> &amp;&amp; iter&lt;=mtd.<a class="code" href="../../d6/dbe/structof__method.html#acda8029c6baa1a6f01a7f60bbe748ebb">ENDFULLSTEPS</a>){<span class="comment">// now all steps beyond energy</span></div>
<div class="line"><a name="l06637"></a><span class="lineno"> 6637</span>&#160;            <span class="keywordflow">if</span>(</div>
<div class="line"><a name="l06638"></a><span class="lineno"> 6638</span>&#160;               (fabs(f1[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[0]]/f1p[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[0]])&gt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a623cc9e076e87e4c1a95ea6168668e17" title="factor by which error jumps as indication that u_g stepped to was very bad choice.">FACTORBADJUMPERROR</a> &amp;&amp; fabs(f1report[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[0]])&gt;trueimptryconv)</div>
<div class="line"><a name="l06639"></a><span class="lineno"> 6639</span>&#160;               || (pp[URAD0]&lt;10.0*<a class="code" href="../../d8/d5b/defs_8general_8h.html#a5bd9da451f108352614cbc457524c5b0">ERADLIMIT</a>) <span class="comment">// expensive</span></div>
<div class="line"><a name="l06640"></a><span class="lineno"> 6640</span>&#160;               || (pp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]&lt;10.0*<a class="code" href="../../d8/d5b/defs_8general_8h.html#a13f615d7832e3abc6abd54325112daf3">UUMINLIMIT</a>) <span class="comment">// expensive</span></div>
<div class="line"><a name="l06641"></a><span class="lineno"> 6641</span>&#160;               ){</div>
<div class="line"><a name="l06642"></a><span class="lineno"> 6642</span>&#160;              <span class="comment">// then pseudo-bisect (between zero and previous ok error case)</span></div>
<div class="line"><a name="l06643"></a><span class="lineno"> 6643</span>&#160;              <span class="keywordflow">if</span>(debugfail&gt;=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a63410994d900c1c05481efc828361b3b">DEBUGLEVELIMPSOLVER</a>) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;pseudo-bisect: iter=%d f1=%g f1p=%g pp=%g ppp=%g  pppp=%g  ppppp=%g\n&quot;</span>,iter,f1[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[0]],f1p[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[0]],pp[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[0]],ppp[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[0]],pppp[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[0]],ppppp[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[0]]);</div>
<div class="line"><a name="l06644"></a><span class="lineno"> 6644</span>&#160;              <span class="keywordflow">if</span>(0){</div>
<div class="line"><a name="l06645"></a><span class="lineno"> 6645</span>&#160;                <span class="comment">// doens&#39;t make sense in general</span></div>
<div class="line"><a name="l06646"></a><span class="lineno"> 6646</span>&#160;                <span class="comment">//          pp[ru.irefU[0]] = ppp[ru.irefU[0]] = pppp[ru.irefU[0]] = 0.5*(fabs(ppppp[ru.irefU[0]]));</span></div>
<div class="line"><a name="l06647"></a><span class="lineno"> 6647</span>&#160;                pp[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[0]] = ppp[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[0]] = 0.5*fabs(pppp[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[0]]);</div>
<div class="line"><a name="l06648"></a><span class="lineno"> 6648</span>&#160;                uu[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[0]] = uup[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[0]] = 0.5*fabs(uupp[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[0]]);</div>
<div class="line"><a name="l06649"></a><span class="lineno"> 6649</span>&#160;              }</div>
<div class="line"><a name="l06650"></a><span class="lineno"> 6650</span>&#160;              <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l06651"></a><span class="lineno"> 6651</span>&#160;                <span class="comment">// half-way between current (pp and ppp are same current primitve) and last primitive</span></div>
<div class="line"><a name="l06652"></a><span class="lineno"> 6652</span>&#160;                <span class="comment">// uu and pp won&#39;t be consistent, but when get to f_implicit(), as continue forces, this will be done.</span></div>
<div class="line"><a name="l06653"></a><span class="lineno"> 6653</span>&#160;                <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) pp[pl] = 0.75*pppp[pl] + 0.25*ppp[pl];</div>
<div class="line"><a name="l06654"></a><span class="lineno"> 6654</span>&#160;                <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) uu[pl] = 0.75*uupp[pl] + 0.25*uup[pl];</div>
<div class="line"><a name="l06655"></a><span class="lineno"> 6655</span>&#160;              }</div>
<div class="line"><a name="l06656"></a><span class="lineno"> 6656</span>&#160;              <span class="comment">// update debug with modifications</span></div>
<div class="line"><a name="l06657"></a><span class="lineno"> 6657</span>&#160;<span class="preprocessor">#if(DEBUGMAXITER)</span></div>
<div class="line"><a name="l06658"></a><span class="lineno"> 6658</span>&#160;<span class="preprocessor"></span>              <span class="keywordflow">if</span>(dampattempt==0){</div>
<div class="line"><a name="l06659"></a><span class="lineno"> 6659</span>&#160;                <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) pppreholdlist[debugiter][pl]=pp[pl];</div>
<div class="line"><a name="l06660"></a><span class="lineno"> 6660</span>&#160;                <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) ppposholdlist[debugiter][pl]=pp[pl];</div>
<div class="line"><a name="l06661"></a><span class="lineno"> 6661</span>&#160;                <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8968c59c029dc64a1057992a70ef8dbd" title="0: show primitive 1: show u^ and urad^">DEBUGMAXITERVELOCITY</a>==1){</div>
<div class="line"><a name="l06662"></a><span class="lineno"> 6662</span>&#160;                  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj){</div>
<div class="line"><a name="l06663"></a><span class="lineno"> 6663</span>&#160;                    pppreholdlist[debugiter][<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>+jj-1]=q-&gt;<a class="code" href="../../d1/d83/structof__state.html#aab723d3c7c2c48b7246cc7d7d5379eed">ucon</a>[jj];</div>
<div class="line"><a name="l06664"></a><span class="lineno"> 6664</span>&#160;                    pppreholdlist[debugiter][URAD1+jj-1]=q-&gt;<a class="code" href="../../d1/d83/structof__state.html#a3bf8e15ee6ae95831230791baf2fc570">uradcon</a>[jj];</div>
<div class="line"><a name="l06665"></a><span class="lineno"> 6665</span>&#160;                    ppposholdlist[debugiter][<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>+jj-1]=q-&gt;<a class="code" href="../../d1/d83/structof__state.html#aab723d3c7c2c48b7246cc7d7d5379eed">ucon</a>[jj];</div>
<div class="line"><a name="l06666"></a><span class="lineno"> 6666</span>&#160;                    ppposholdlist[debugiter][URAD1+jj-1]=q-&gt;<a class="code" href="../../d1/d83/structof__state.html#a3bf8e15ee6ae95831230791baf2fc570">uradcon</a>[jj];</div>
<div class="line"><a name="l06667"></a><span class="lineno"> 6667</span>&#160;                  }</div>
<div class="line"><a name="l06668"></a><span class="lineno"> 6668</span>&#160;                }</div>
<div class="line"><a name="l06669"></a><span class="lineno"> 6669</span>&#160;                <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a59b7ef1517ff22fd4dfce4cf6d380c55" title="loop over all Dimensions; second rank loop">DLOOP</a>(jj,kk) jaclist[debugiter][jj][kk]=iJ[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]][ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[kk]];</div>
<div class="line"><a name="l06670"></a><span class="lineno"> 6670</span>&#160;                implicititerlist[debugiter]=mtd.<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>;</div>
<div class="line"><a name="l06671"></a><span class="lineno"> 6671</span>&#160;                implicitferrlist[debugiter]=mtd.<a class="code" href="../../d6/dbe/structof__method.html#a2c5c387f7161b69aad77ee5a13d30c68">implicitferr</a>;</div>
<div class="line"><a name="l06672"></a><span class="lineno"> 6672</span>&#160;                fracdamplist[0]=fracdtuu0;</div>
<div class="line"><a name="l06673"></a><span class="lineno"> 6673</span>&#160;                fracdamplist[1]=fracdtG;</div>
<div class="line"><a name="l06674"></a><span class="lineno"> 6674</span>&#160;                fracdamplist[2]=DAMPFACTOR;</div>
<div class="line"><a name="l06675"></a><span class="lineno"> 6675</span>&#160;              }</div>
<div class="line"><a name="l06676"></a><span class="lineno"> 6676</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l06677"></a><span class="lineno"> 6677</span>&#160;<span class="preprocessor"></span>          </div>
<div class="line"><a name="l06678"></a><span class="lineno"> 6678</span>&#160;</div>
<div class="line"><a name="l06679"></a><span class="lineno"> 6679</span>&#160;              <span class="comment">// need to get new error function so can take step based upon this as reference!</span></div>
<div class="line"><a name="l06680"></a><span class="lineno"> 6680</span>&#160;              <span class="keywordflow">if</span>(iter&gt;trueimpmaxiter){</div>
<div class="line"><a name="l06681"></a><span class="lineno"> 6681</span>&#160;                <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a7df8286c59d491ba1117884d33499a7a">prod0dualfprintf</a>(debugfail&gt;=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a969edf608c4953dd7b4b34e99dbc686c">DEBUGLEVELIMPSOLVERMORE</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;iter=%d&gt;%d\n&quot;</span>,iter,trueimpmaxiter);</div>
<div class="line"><a name="l06682"></a><span class="lineno"> 6682</span>&#160;              }</div>
<div class="line"><a name="l06683"></a><span class="lineno"> 6683</span>&#160;              <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l06684"></a><span class="lineno"> 6684</span>&#160;                <span class="comment">// continue assumes not triggered when iter&gt;trueimpmaxiter</span></div>
<div class="line"><a name="l06685"></a><span class="lineno"> 6685</span>&#160;                numjumpchecks++;</div>
<div class="line"><a name="l06686"></a><span class="lineno"> 6686</span>&#160;                <span class="keywordflow">if</span>(numjumpchecks&lt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a1ec26131e3649a5d995f22815710c79b">NUMJUMPCHECKSMAX</a>) <span class="keywordflow">continue</span>; <span class="comment">// head to start of loop to iter++ and get new error function.</span></div>
<div class="line"><a name="l06687"></a><span class="lineno"> 6687</span>&#160;              }</div>
<div class="line"><a name="l06688"></a><span class="lineno"> 6688</span>&#160;            }</div>
<div class="line"><a name="l06689"></a><span class="lineno"> 6689</span>&#160;          }</div>
<div class="line"><a name="l06690"></a><span class="lineno"> 6690</span>&#160;        }</div>
<div class="line"><a name="l06691"></a><span class="lineno"> 6691</span>&#160;<span class="preprocessor">#endif // end if ERRORJUMPCHECK</span></div>
<div class="line"><a name="l06692"></a><span class="lineno"> 6692</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l06693"></a><span class="lineno"> 6693</span>&#160;</div>
<div class="line"><a name="l06694"></a><span class="lineno"> 6694</span>&#160;</div>
<div class="line"><a name="l06695"></a><span class="lineno"> 6695</span>&#160;</div>
<div class="line"><a name="l06696"></a><span class="lineno"> 6696</span>&#160;</div>
<div class="line"><a name="l06697"></a><span class="lineno"> 6697</span>&#160;</div>
<div class="line"><a name="l06698"></a><span class="lineno"> 6698</span>&#160;        <span class="comment">// only check convergence or check the properties of the solution if checkconv==1</span></div>
<div class="line"><a name="l06699"></a><span class="lineno"> 6699</span>&#160;        <span class="keywordflow">if</span>(checkconv){</div>
<div class="line"><a name="l06701"></a><span class="lineno"> 6701</span>&#160;          <span class="comment">//</span></div>
<div class="line"><a name="l06702"></a><span class="lineno"> 6702</span>&#160;          <span class="comment">// see if pre-convergence (happens if force is small or no force at all.  Can&#39;t necessarily continue since Jacobian can require arbitrarily large dU on fluid and fail to invert even if no fluid-radiation interaction!</span></div>
<div class="line"><a name="l06703"></a><span class="lineno"> 6703</span>&#160;          <span class="comment">//test pre-convergence using initial |dU/U|</span></div>
<div class="line"><a name="l06704"></a><span class="lineno"> 6704</span>&#160;          <span class="comment">// KORALTODO: This isn&#39;t a completely general error check since force might be large for fluid that needs itself to have more accuracy, but if using ~NUMEPSILON, won&#39;t resolve 4-force of radiation on fluid to better than that.</span></div>
<div class="line"><a name="l06705"></a><span class="lineno"> 6705</span>&#160;          <span class="comment">//</span></div>
<div class="line"><a name="l06707"></a><span class="lineno"> 6707</span>&#160;<span class="comment"></span>          <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> LOCALPREIMPCONV=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(10.0*<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a8913cb5d64cfec23ae1a3052930ec468">NUMEPSILON</a>,trueimptryconv); <span class="comment">// more strict than later tolerance</span></div>
<div class="line"><a name="l06708"></a><span class="lineno"> 6708</span>&#160;          <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> LOCALPREIMPCONVABS=(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a>)(NDIM+2)*LOCALPREIMPCONV; <span class="comment">// more strict than later tolerance</span></div>
<div class="line"><a name="l06709"></a><span class="lineno"> 6709</span>&#160;          <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad447e623f48316a0e519d46c213ce17f" title="stop if WHICHERROR is low error">STOPIFVERYLOWERROR</a> &amp;&amp; errorabsf1[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>]&lt;=LOCALPREIMPCONVABS){</div>
<div class="line"><a name="l06710"></a><span class="lineno"> 6710</span>&#160;            earlylowerror=1;</div>
<div class="line"><a name="l06711"></a><span class="lineno"> 6711</span>&#160;          }</div>
<div class="line"><a name="l06712"></a><span class="lineno"> 6712</span>&#160;          <span class="comment">// see if error on iterated quantities has already gone near/below machine precision.  If so, can&#39;t do any better with total error, so stop.</span></div>
<div class="line"><a name="l06713"></a><span class="lineno"> 6713</span>&#160;          <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab65ae0cf68e3a38ad5326ae212bdd134" title="stop if iter error is low error">STOPIFITERLOWERROR</a> &amp;&amp; <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>==1 &amp;&amp; errorabsf1[0]&lt;=LOCALPREIMPCONVABS){</div>
<div class="line"><a name="l06714"></a><span class="lineno"> 6714</span>&#160;            lowitererror=1; <span class="comment">// __WORKINGONIT__: makes use urad alot and why?</span></div>
<div class="line"><a name="l06715"></a><span class="lineno"> 6715</span>&#160;          }</div>
<div class="line"><a name="l06716"></a><span class="lineno"> 6716</span>&#160;</div>
<div class="line"><a name="l06717"></a><span class="lineno"> 6717</span>&#160;</div>
<div class="line"><a name="l06718"></a><span class="lineno"> 6718</span>&#160;</div>
<div class="line"><a name="l06720"></a><span class="lineno"> 6720</span>&#160;          <span class="comment">//</span></div>
<div class="line"><a name="l06721"></a><span class="lineno"> 6721</span>&#160;          <span class="comment">// try to get best solution (should be based upon immediate f_error_check(uu,pp,errorabsf1)</span></div>
<div class="line"><a name="l06722"></a><span class="lineno"> 6722</span>&#160;          <span class="comment">//</span></div>
<div class="line"><a name="l06723"></a><span class="lineno"> 6723</span>&#160;          <span class="comment">// store error and solution in case eventually lead to max iterations and actually get worse error</span></div>
<div class="line"><a name="l06724"></a><span class="lineno"> 6724</span>&#160;          <span class="comment">// f1 based</span></div>
<div class="line"><a name="l06725"></a><span class="lineno"> 6725</span>&#160;          <span class="comment">//</span></div>
<div class="line"><a name="l06727"></a><span class="lineno"> 6727</span>&#160;<span class="comment"></span>          errorabsbest[0]=0.0; <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a60eea34b552378df229a78747fda6857">JACLOOPFULLERROR</a>(itermode,jj,ru.<a class="code" href="../../d2/d46/structof__ref_u.html#a9f3d856dcdd8fa240dfbdcedfad888ef">startjac</a>,ru.<a class="code" href="../../d2/d46/structof__ref_u.html#af67164c1a42e2aefe0603597dd2ea25e">endjac</a>) errorabsbest[0] += fabs(lowestf1report[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[jj]]);</div>
<div class="line"><a name="l06728"></a><span class="lineno"> 6728</span>&#160;          errorabsbest[1]=0.0; <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aef340eabe2a41c05add2b3d8527b0fd0">JACLOOPSUPERFULL</a>(pliter,pl,*eomtype,*baseitermethod,*radinvmod) errorabsbest[1] += fabs(lowestf1report[pl]);</div>
<div class="line"><a name="l06729"></a><span class="lineno"> 6729</span>&#160;          <span class="keywordflow">if</span>(errorabsbest[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>]&gt;errorabsf1[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>] &amp;&amp; <a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(errorabsf1[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>]) &amp;&amp; (itermode==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a18693ca111670c1ff38ab2206f70c81e">ITERMODECOLD</a> || pp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>]&gt;0.0 &amp;&amp; pp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]&gt;0.0 &amp;&amp; pp[PRAD0]&gt;0.0)){</div>
<div class="line"><a name="l06730"></a><span class="lineno"> 6730</span>&#160;            <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) bestuu[pl]=uu[pl];</div>
<div class="line"><a name="l06731"></a><span class="lineno"> 6731</span>&#160;            <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) bestpp[pl]=pp[pl];</div>
<div class="line"><a name="l06732"></a><span class="lineno"> 6732</span>&#160;            <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) lowestf1[pl]=f1[pl];</div>
<div class="line"><a name="l06733"></a><span class="lineno"> 6733</span>&#160;            <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) lowestf1norm[pl]=f1norm[pl];</div>
<div class="line"><a name="l06734"></a><span class="lineno"> 6734</span>&#160;            <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) lowestf1report[pl]=f1report[pl];</div>
<div class="line"><a name="l06735"></a><span class="lineno"> 6735</span>&#160;            errorabsbest[0]=errorabsf1[0];</div>
<div class="line"><a name="l06736"></a><span class="lineno"> 6736</span>&#160;            errorabsbest[1]=errorabsf1[1];</div>
<div class="line"><a name="l06737"></a><span class="lineno"> 6737</span>&#160;            radinvmodbest=*radinvmod;</div>
<div class="line"><a name="l06738"></a><span class="lineno"> 6738</span>&#160;            gotbest=1;</div>
<div class="line"><a name="l06739"></a><span class="lineno"> 6739</span>&#160;          }</div>
<div class="line"><a name="l06740"></a><span class="lineno"> 6740</span>&#160;</div>
<div class="line"><a name="l06741"></a><span class="lineno"> 6741</span>&#160;</div>
<div class="line"><a name="l06742"></a><span class="lineno"> 6742</span>&#160;          <span class="keywordflow">if</span>(earlylowerror){</div>
<div class="line"><a name="l06743"></a><span class="lineno"> 6743</span>&#160;            <span class="keywordflow">if</span>(debugfail&gt;=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a969edf608c4953dd7b4b34e99dbc686c">DEBUGLEVELIMPSOLVERMORE</a>) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;Early low error=%g %g : iter=%d\n&quot;</span>,errorabsf1[0],errorabsf1[1],iter);</div>
<div class="line"><a name="l06744"></a><span class="lineno"> 6744</span>&#160;            <span class="comment">//  not failure.</span></div>
<div class="line"><a name="l06745"></a><span class="lineno"> 6745</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l06746"></a><span class="lineno"> 6746</span>&#160;          }</div>
<div class="line"><a name="l06747"></a><span class="lineno"> 6747</span>&#160;          <span class="keywordflow">if</span>(lowitererror){</div>
<div class="line"><a name="l06748"></a><span class="lineno"> 6748</span>&#160;            <span class="keywordflow">if</span>(debugfail&gt;=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a969edf608c4953dd7b4b34e99dbc686c">DEBUGLEVELIMPSOLVERMORE</a>) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;Low iter error=%g %g : iter=%d\n&quot;</span>,errorabsf1[0],errorabsf1[1],iter);</div>
<div class="line"><a name="l06749"></a><span class="lineno"> 6749</span>&#160;            <span class="comment">//  not failure.</span></div>
<div class="line"><a name="l06750"></a><span class="lineno"> 6750</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l06751"></a><span class="lineno"> 6751</span>&#160;          }</div>
<div class="line"><a name="l06752"></a><span class="lineno"> 6752</span>&#160;</div>
<div class="line"><a name="l06753"></a><span class="lineno"> 6753</span>&#160;</div>
<div class="line"><a name="l06754"></a><span class="lineno"> 6754</span>&#160;          <span class="keywordflow">if</span>(convreturnf1){</div>
<div class="line"><a name="l06755"></a><span class="lineno"> 6755</span>&#160;            <span class="keywordflow">break</span>; <span class="comment">// then converged already and no need to take a step (saves time)</span></div>
<div class="line"><a name="l06756"></a><span class="lineno"> 6756</span>&#160;          }</div>
<div class="line"><a name="l06757"></a><span class="lineno"> 6757</span>&#160;</div>
<div class="line"><a name="l06758"></a><span class="lineno"> 6758</span>&#160;</div>
<div class="line"><a name="l06759"></a><span class="lineno"> 6759</span>&#160;</div>
<div class="line"><a name="l06760"></a><span class="lineno"> 6760</span>&#160;</div>
<div class="line"><a name="l06761"></a><span class="lineno"> 6761</span>&#160;</div>
<div class="line"><a name="l06762"></a><span class="lineno"> 6762</span>&#160;</div>
<div class="line"><a name="l06763"></a><span class="lineno"> 6763</span>&#160;</div>
<div class="line"><a name="l06765"></a><span class="lineno"> 6765</span>&#160;          <span class="comment">//</span></div>
<div class="line"><a name="l06766"></a><span class="lineno"> 6766</span>&#160;          <span class="comment">// See if error is dropping as expected</span></div>
<div class="line"><a name="l06767"></a><span class="lineno"> 6767</span>&#160;          <span class="comment">// Trying to avoid excessive unhelpful iterations</span></div>
<div class="line"><a name="l06768"></a><span class="lineno"> 6768</span>&#160;          <span class="comment">//</span></div>
<div class="line"><a name="l06770"></a><span class="lineno"> 6770</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l06771"></a><span class="lineno"> 6771</span>&#160;<span class="preprocessor">#define CHECKDECREASE0 5</span></div>
<div class="line"><a name="l06772"></a><span class="lineno"> 6772</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define CHECKDECREASEAVGNUM 3 // should be less than CHECKDECREASE0</span></div>
<div class="line"><a name="l06773"></a><span class="lineno"> 6773</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define CHECKDECFACTOR (0.5) // i.e. should drop by this factor compared to older average</span></div>
<div class="line"><a name="l06774"></a><span class="lineno"> 6774</span>&#160;<span class="preprocessor"></span>          <span class="keywordflow">if</span>(debugiter&gt;=mtd.<a class="code" href="../../d6/dbe/structof__method.html#a95212a0a740e95e0e2cc94cc9f4d0f7d">BEGINNORMALSTEPS</a>+<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab875a9257a90523e50d86f22faf1173d">CHECKDECREASE0</a>){</div>
<div class="line"><a name="l06775"></a><span class="lineno"> 6775</span>&#160;            <span class="keywordtype">int</span> ci;</div>
<div class="line"><a name="l06776"></a><span class="lineno"> 6776</span>&#160;            <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> avgerror[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa63447acbbbc62cbedae23eac61c716e" title="determine which error will use when deciding if converged or not.">NUMERRORTYPES</a>];</div>
<div class="line"><a name="l06777"></a><span class="lineno"> 6777</span>&#160;            avgerror[0]=avgerror[1]=0.0;</div>
<div class="line"><a name="l06778"></a><span class="lineno"> 6778</span>&#160;            <span class="keywordflow">for</span>(ci=0;ci&lt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a44c64c3ad77999ceaaf6c1156fb2c1bd">CHECKDECREASEAVGNUM</a>;ci++) avgerror[0] += errorabsf1list[debugiter-<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab875a9257a90523e50d86f22faf1173d">CHECKDECREASE0</a>+ci];</div>
<div class="line"><a name="l06779"></a><span class="lineno"> 6779</span>&#160;            <span class="keywordflow">for</span>(ci=0;ci&lt;CHECKDECREASEAVGNUM;ci++) avgerror[1] += errorallabsf1list[debugiter-<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab875a9257a90523e50d86f22faf1173d">CHECKDECREASE0</a>+ci];</div>
<div class="line"><a name="l06780"></a><span class="lineno"> 6780</span>&#160;            avgerror[0]/=(CHECKDECREASEAVGNUM);</div>
<div class="line"><a name="l06781"></a><span class="lineno"> 6781</span>&#160;            avgerror[1]/=(CHECKDECREASEAVGNUM);</div>
<div class="line"><a name="l06782"></a><span class="lineno"> 6782</span>&#160;            <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> currenterror[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa63447acbbbc62cbedae23eac61c716e" title="determine which error will use when deciding if converged or not.">NUMERRORTYPES</a>];</div>
<div class="line"><a name="l06783"></a><span class="lineno"> 6783</span>&#160;            currenterror[0]=errorabsf1list[debugiter];</div>
<div class="line"><a name="l06784"></a><span class="lineno"> 6784</span>&#160;            currenterror[1]=errorallabsf1list[debugiter];</div>
<div class="line"><a name="l06785"></a><span class="lineno"> 6785</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l06786"></a><span class="lineno"> 6786</span>&#160;            <span class="comment">// check both errors to ensure they are decreasing</span></div>
<div class="line"><a name="l06787"></a><span class="lineno"> 6787</span>&#160;            <span class="keywordtype">int</span> cond1=(currenterror[0]&gt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#abee5b17ad07d8944ce6f8d94a74e8716">CHECKDECFACTOR</a>*avgerror[0] || currenterror[1]&gt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#abee5b17ad07d8944ce6f8d94a74e8716">CHECKDECFACTOR</a>*avgerror[1])&amp;&amp;(WHICHERROR==1);</div>
<div class="line"><a name="l06788"></a><span class="lineno"> 6788</span>&#160;            <span class="keywordtype">int</span> cond2=(currenterror[0]&gt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#abee5b17ad07d8944ce6f8d94a74e8716">CHECKDECFACTOR</a>*avgerror[0])&amp;&amp;(WHICHERROR==0);</div>
<div class="line"><a name="l06789"></a><span class="lineno"> 6789</span>&#160;            <span class="keywordflow">if</span>(cond1 || cond2){</div>
<div class="line"><a name="l06790"></a><span class="lineno"> 6790</span>&#160;</div>
<div class="line"><a name="l06791"></a><span class="lineno"> 6791</span>&#160;              <span class="keywordflow">if</span>(havebackup){</div>
<div class="line"><a name="l06792"></a><span class="lineno"> 6792</span>&#160;                failreturn=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a42e7e780e89073f5d14dfafda3bae62e">FAILRETURNMODESWITCH</a>; mathfailtype=80;</div>
<div class="line"><a name="l06793"></a><span class="lineno"> 6793</span>&#160;                <span class="keywordflow">if</span>(debugfail&gt;=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a63410994d900c1c05481efc828361b3b">DEBUGLEVELIMPSOLVER</a>) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;SWITCHING MODE: Detected did not decrease error\n&quot;</span>);</div>
<div class="line"><a name="l06794"></a><span class="lineno"> 6794</span>&#160;                <span class="comment">// if want to ensure should have gotten solution, should still report</span></div>
<div class="line"><a name="l06795"></a><span class="lineno"> 6795</span>&#160;              }</div>
<div class="line"><a name="l06796"></a><span class="lineno"> 6796</span>&#160;              <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l06797"></a><span class="lineno"> 6797</span>&#160;                <span class="comment">// then aborting due to error alone even without backup</span></div>
<div class="line"><a name="l06798"></a><span class="lineno"> 6798</span>&#160;                canbreak=4; <span class="comment">// use same canbreak as below</span></div>
<div class="line"><a name="l06799"></a><span class="lineno"> 6799</span>&#160;                mathfailtype=81;</div>
<div class="line"><a name="l06800"></a><span class="lineno"> 6800</span>&#160;                <span class="keywordflow">if</span>(debugfail&gt;=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a63410994d900c1c05481efc828361b3b">DEBUGLEVELIMPSOLVER</a>) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;Aborting even without backup because error not decreasing\n&quot;</span>);</div>
<div class="line"><a name="l06801"></a><span class="lineno"> 6801</span>&#160;                <span class="comment">// no failure or switch.</span></div>
<div class="line"><a name="l06802"></a><span class="lineno"> 6802</span>&#160;              }</div>
<div class="line"><a name="l06803"></a><span class="lineno"> 6803</span>&#160;              <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l06804"></a><span class="lineno"> 6804</span>&#160;</div>
<div class="line"><a name="l06805"></a><span class="lineno"> 6805</span>&#160;            }<span class="comment">// end if current error too large compared to older average error</span></div>
<div class="line"><a name="l06806"></a><span class="lineno"> 6806</span>&#160;          }<span class="comment">// end if large enough iterations so can check how error is trending, to avoid many iterations when error is not dropping enough to matter.</span></div>
<div class="line"><a name="l06807"></a><span class="lineno"> 6807</span>&#160;</div>
<div class="line"><a name="l06808"></a><span class="lineno"> 6808</span>&#160;</div>
<div class="line"><a name="l06809"></a><span class="lineno"> 6809</span>&#160;</div>
<div class="line"><a name="l06810"></a><span class="lineno"> 6810</span>&#160;</div>
<div class="line"><a name="l06811"></a><span class="lineno"> 6811</span>&#160;</div>
<div class="line"><a name="l06813"></a><span class="lineno"> 6813</span>&#160;          <span class="comment">//</span></div>
<div class="line"><a name="l06814"></a><span class="lineno"> 6814</span>&#160;          <span class="comment">// check if error repeatedly rises</span></div>
<div class="line"><a name="l06815"></a><span class="lineno"> 6815</span>&#160;          <span class="comment">// do this even if damping, since damping should only help get continuous reduction in error.</span></div>
<div class="line"><a name="l06816"></a><span class="lineno"> 6816</span>&#160;          <span class="comment">//</span></div>
<div class="line"><a name="l06818"></a><span class="lineno"> 6818</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l06819"></a><span class="lineno"> 6819</span>&#160;          <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a0c7f2a194649bb51a1957ee424aff64f">NUMNOERRORREDUCE</a> &amp;&amp; iter&gt;=mtd.<a class="code" href="../../d6/dbe/structof__method.html#a95212a0a740e95e0e2cc94cc9f4d0f7d">BEGINNORMALSTEPS</a>){</div>
<div class="line"><a name="l06820"></a><span class="lineno"> 6820</span>&#160;            <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> errorneed=((<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a>)(numsub+2)*trueimptryconv);</div>
<div class="line"><a name="l06821"></a><span class="lineno"> 6821</span>&#160;            <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> errorneedalt=(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(1<a class="code" href="../../d8/d60/init_8c.html#a07484107e6d9fdf38b53edf631d6511d">E</a>-8,errorneed));</div>
<div class="line"><a name="l06822"></a><span class="lineno"> 6822</span>&#160;            <span class="keywordflow">if</span>(iter&gt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8b8fab71a8c26738e5758912ea6c06e2" title="number of iterations by which to check (1st) whether after some number of times (2nd) error rose inst...">NUMNOERRORREDUCE0</a> &amp;&amp; suberrorabsf1&gt;errorneed){ <span class="comment">// no need to do this if actually error is below desired tolerance,  hence second argument</span></div>
<div class="line"><a name="l06823"></a><span class="lineno"> 6823</span>&#160;              <span class="keywordflow">if</span>(suberrorabsf1&gt;=errorabspf1[0]) counterrorrose++;</div>
<div class="line"><a name="l06824"></a><span class="lineno"> 6824</span>&#160;              <span class="keywordtype">int</span> allowedtoabort=(havebackup || havebackup==0 &amp;&amp; <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a02e53f4aca74277f18558720aba22d26" title="whether to abort even the backup if error is not reducing.">ABORTBACKUPIFNOERRORREDUCE</a>==1 &amp;&amp; suberrorabsf1&lt;errorneedalt);</div>
<div class="line"><a name="l06825"></a><span class="lineno"> 6825</span>&#160;              <span class="comment">//+int allowedtoabort=(havebackup || havebackup==0 &amp;&amp; ABORTBACKUPIFNOERRORREDUCE==1 &amp;&amp; suberrorabsf1&lt;errorneedalt || modemethodlocal==MODEPICKBEST || modemethodlocal==MODEPICKBESTSIMPLE  || modemethodlocal==MODEPICKBESTSIMPLE2);</span></div>
<div class="line"><a name="l06826"></a><span class="lineno"> 6826</span>&#160;              <span class="keywordflow">if</span>(counterrorrose&gt;=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a0c7f2a194649bb51a1957ee424aff64f">NUMNOERRORREDUCE</a> &amp;&amp; allowedtoabort){ <span class="comment">// would be risky to do abort if don&#39;t have backup, even if enter into limit cycle.</span></div>
<div class="line"><a name="l06827"></a><span class="lineno"> 6827</span>&#160;</div>
<div class="line"><a name="l06828"></a><span class="lineno"> 6828</span>&#160;                <span class="keywordflow">if</span>(itermode==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a480c56e263c4874ccb40f3bbc1b32032">ITERMODESTAGES</a> &amp;&amp; iter&gt;=mtd.<a class="code" href="../../d6/dbe/structof__method.html#ab82f125cc45b1d2881155d70795fbf8a">BEGINMOMSTEPS</a> &amp;&amp; iter&lt;=mtd.<a class="code" href="../../d6/dbe/structof__method.html#a854fcca7e3e1d7ab0a6955321ce698de">ENDMOMSTEPS</a>){</div>
<div class="line"><a name="l06829"></a><span class="lineno"> 6829</span>&#160;                  <span class="keywordflow">if</span>(iter&lt;=mtd.<a class="code" href="../../d6/dbe/structof__method.html#a854fcca7e3e1d7ab0a6955321ce698de">ENDMOMSTEPS</a>){ iter=mtd.<a class="code" href="../../d6/dbe/structof__method.html#a6412a5671687f2d9f5be2fd0fafb81f1">BEGINENERGYSTEPS</a>-1; <span class="keywordflow">continue</span>;} <span class="comment">// force as if already doing energy steps.  If already next iteration is to be this energy step, then no skipping needed.</span></div>
<div class="line"><a name="l06830"></a><span class="lineno"> 6830</span>&#160;                }<span class="comment">// end if doing momentum steps and error not decreasing fast enough, then skip to energy steps</span></div>
<div class="line"><a name="l06831"></a><span class="lineno"> 6831</span>&#160;                <span class="keywordflow">else</span> <span class="keywordflow">if</span>(itermode==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a480c56e263c4874ccb40f3bbc1b32032">ITERMODESTAGES</a> &amp;&amp; iter&gt;=mtd.<a class="code" href="../../d6/dbe/structof__method.html#a6412a5671687f2d9f5be2fd0fafb81f1">BEGINENERGYSTEPS</a> &amp;&amp; iter&lt;=mtd.<a class="code" href="../../d6/dbe/structof__method.html#a9829068ffbaa124dda46be28c48bfccc">ENDENERGYSTEPS</a>){</div>
<div class="line"><a name="l06832"></a><span class="lineno"> 6832</span>&#160;                  <span class="keywordflow">if</span>(iter&lt;=mtd.<a class="code" href="../../d6/dbe/structof__method.html#a9829068ffbaa124dda46be28c48bfccc">ENDENERGYSTEPS</a>){ iter=mtd.<a class="code" href="../../d6/dbe/structof__method.html#a73849808a0b3a900c373b244089eab1f">BEGINFULLSTEPS</a>-1; <span class="keywordflow">continue</span>;} <span class="comment">// force as if already doing normal steps.  If already next iteration is to be normal step, no need to skip.</span></div>
<div class="line"><a name="l06833"></a><span class="lineno"> 6833</span>&#160;                }<span class="comment">// end if doing energy steps and error not decreasing fast enough, then skip to normal steps</span></div>
<div class="line"><a name="l06834"></a><span class="lineno"> 6834</span>&#160;                <span class="keywordflow">else</span>{<span class="comment">// else if normal step</span></div>
<div class="line"><a name="l06835"></a><span class="lineno"> 6835</span>&#160;</div>
<div class="line"><a name="l06836"></a><span class="lineno"> 6836</span>&#160;                  <span class="keywordflow">if</span>(havebackup){</div>
<div class="line"><a name="l06837"></a><span class="lineno"> 6837</span>&#160;                    failreturn=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a42e7e780e89073f5d14dfafda3bae62e">FAILRETURNMODESWITCH</a>; mathfailtype=80;</div>
<div class="line"><a name="l06838"></a><span class="lineno"> 6838</span>&#160;                    <span class="keywordflow">if</span>(debugfail&gt;=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a63410994d900c1c05481efc828361b3b">DEBUGLEVELIMPSOLVER</a>) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;SWITCHING MODE: Detected did not decrease error %d times at iter=%d : suberrorabsf1=%g errorabspf1=%g\n&quot;</span>,counterrorrose,iter,suberrorabsf1,errorabspf1[0]);</div>
<div class="line"><a name="l06839"></a><span class="lineno"> 6839</span>&#160;                    <span class="comment">// if want to ensure should have gotten solution, should still report</span></div>
<div class="line"><a name="l06840"></a><span class="lineno"> 6840</span>&#160;                  }</div>
<div class="line"><a name="l06841"></a><span class="lineno"> 6841</span>&#160;                  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l06842"></a><span class="lineno"> 6842</span>&#160;                    <span class="comment">// then aborting due to error alone even without backup</span></div>
<div class="line"><a name="l06843"></a><span class="lineno"> 6843</span>&#160;                    canbreak=2;</div>
<div class="line"><a name="l06844"></a><span class="lineno"> 6844</span>&#160;                    mathfailtype=81;</div>
<div class="line"><a name="l06845"></a><span class="lineno"> 6845</span>&#160;                    <span class="keywordflow">if</span>(debugfail&gt;=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a63410994d900c1c05481efc828361b3b">DEBUGLEVELIMPSOLVER</a>) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;Aborting even without backup because error oscillated (iter=%d) and suberrorabsf1=%g errorabsf1[0,1]=%g %g\n&quot;</span>,iter,suberrorabsf1,errorabsf1[0],errorabsf1[1]);</div>
<div class="line"><a name="l06846"></a><span class="lineno"> 6846</span>&#160;                    <span class="comment">// no failure or switch.</span></div>
<div class="line"><a name="l06847"></a><span class="lineno"> 6847</span>&#160;                  }</div>
<div class="line"><a name="l06848"></a><span class="lineno"> 6848</span>&#160;                  <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l06849"></a><span class="lineno"> 6849</span>&#160;                }</div>
<div class="line"><a name="l06850"></a><span class="lineno"> 6850</span>&#160;              }<span class="comment">// end if normal step</span></div>
<div class="line"><a name="l06851"></a><span class="lineno"> 6851</span>&#160;            }</div>
<div class="line"><a name="l06852"></a><span class="lineno"> 6852</span>&#160;          }      </div>
<div class="line"><a name="l06853"></a><span class="lineno"> 6853</span>&#160;</div>
<div class="line"><a name="l06854"></a><span class="lineno"> 6854</span>&#160;</div>
<div class="line"><a name="l06855"></a><span class="lineno"> 6855</span>&#160;</div>
<div class="line"><a name="l06857"></a><span class="lineno"> 6857</span>&#160;          <span class="comment">//</span></div>
<div class="line"><a name="l06858"></a><span class="lineno"> 6858</span>&#160;          <span class="comment">// check if error isn&#39;t decreasing enough for be interesting</span></div>
<div class="line"><a name="l06859"></a><span class="lineno"> 6859</span>&#160;          <span class="comment">// but don&#39;t check on error if holding on u_g&gt;0 since error can be bad until settle to near root.</span></div>
<div class="line"><a name="l06860"></a><span class="lineno"> 6860</span>&#160;          <span class="comment">// and don&#39;t do this check if damping, since if damping really want to try harder.</span></div>
<div class="line"><a name="l06861"></a><span class="lineno"> 6861</span>&#160;          <span class="comment">//</span></div>
<div class="line"><a name="l06863"></a><span class="lineno"> 6863</span>&#160;<span class="comment"></span>          <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab4cf497679ffe5ebf0a9020558d74067">NUMPRIORERRORS</a>&gt;0 &amp;&amp; holdingaspositive==0 &amp;&amp; dampattempt==0){</div>
<div class="line"><a name="l06864"></a><span class="lineno"> 6864</span>&#160;            <span class="keywordflow">if</span>(priorerrorscount&gt;=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a652ffab4e70169ef7493d1ba4663e954" title="number of prior iterations to see if error has dropped enough to seem relevant">NUMPRIORERRORSITER0</a>){</div>
<div class="line"><a name="l06865"></a><span class="lineno"> 6865</span>&#160;              <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> erroraverage=0.0; <span class="keywordtype">int</span> numerroraverage=0;</div>
<div class="line"><a name="l06866"></a><span class="lineno"> 6866</span>&#160;              <span class="keywordflow">for</span>(itererror=1;itererror&lt;<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(priorerrorscount,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab4cf497679ffe5ebf0a9020558d74067">NUMPRIORERRORS</a>);itererror++){ erroraverage += errorabspf1[itererror]; numerroraverage++;} erroraverage/=((<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a>)numerroraverage);</div>
<div class="line"><a name="l06867"></a><span class="lineno"> 6867</span>&#160;              <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> changerequired;</div>
<div class="line"><a name="l06868"></a><span class="lineno"> 6868</span>&#160;              <span class="keywordflow">if</span>(dampattempt==0) changerequired=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ac2f05e43b43040f8803b83374ecaba58">PRIORERRORCHANGEREQUIRED</a>;</div>
<div class="line"><a name="l06869"></a><span class="lineno"> 6869</span>&#160;              <span class="keywordflow">else</span> <span class="keywordflow">if</span>(dampattempt==1) changerequired=0.7;</div>
<div class="line"><a name="l06870"></a><span class="lineno"> 6870</span>&#160;              <span class="keywordflow">else</span> <span class="keywordflow">if</span>(dampattempt==2) changerequired=0.8;</div>
<div class="line"><a name="l06871"></a><span class="lineno"> 6871</span>&#160;              <span class="keywordflow">else</span> <span class="keywordflow">if</span>(dampattempt==3) changerequired=0.9;</div>
<div class="line"><a name="l06872"></a><span class="lineno"> 6872</span>&#160;              <span class="keywordflow">else</span> changerequired=0.95;</div>
<div class="line"><a name="l06873"></a><span class="lineno"> 6873</span>&#160;              <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> errorneed=((<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a>)(numsub+2)*trueimptryconv);</div>
<div class="line"><a name="l06874"></a><span class="lineno"> 6874</span>&#160;              <span class="keywordflow">if</span>(suberrorabsf1/erroraverage&gt;changerequired &amp;&amp; suberrorabsf1&gt;errorneed){</div>
<div class="line"><a name="l06875"></a><span class="lineno"> 6875</span>&#160;</div>
<div class="line"><a name="l06876"></a><span class="lineno"> 6876</span>&#160;                <span class="keywordflow">if</span>(itermode==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a480c56e263c4874ccb40f3bbc1b32032">ITERMODESTAGES</a> &amp;&amp; iter&gt;=mtd.<a class="code" href="../../d6/dbe/structof__method.html#ab82f125cc45b1d2881155d70795fbf8a">BEGINMOMSTEPS</a> &amp;&amp; iter&lt;=mtd.<a class="code" href="../../d6/dbe/structof__method.html#a854fcca7e3e1d7ab0a6955321ce698de">ENDMOMSTEPS</a>){</div>
<div class="line"><a name="l06877"></a><span class="lineno"> 6877</span>&#160;                  <span class="keywordflow">if</span>(iter&lt;=mtd.<a class="code" href="../../d6/dbe/structof__method.html#a854fcca7e3e1d7ab0a6955321ce698de">ENDMOMSTEPS</a>){ iter=mtd.<a class="code" href="../../d6/dbe/structof__method.html#a6412a5671687f2d9f5be2fd0fafb81f1">BEGINENERGYSTEPS</a>-1; <span class="keywordflow">continue</span>;} <span class="comment">// force as if already doing energy steps.  If already next iteration is to be this energy step, then no skipping needed.</span></div>
<div class="line"><a name="l06878"></a><span class="lineno"> 6878</span>&#160;                }<span class="comment">// end if doing momentum steps and error not decreasing fast enough, then skip to energy steps</span></div>
<div class="line"><a name="l06879"></a><span class="lineno"> 6879</span>&#160;                <span class="keywordflow">else</span> <span class="keywordflow">if</span>(itermode==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a480c56e263c4874ccb40f3bbc1b32032">ITERMODESTAGES</a> &amp;&amp; iter&gt;=mtd.<a class="code" href="../../d6/dbe/structof__method.html#a6412a5671687f2d9f5be2fd0fafb81f1">BEGINENERGYSTEPS</a> &amp;&amp; iter&lt;=mtd.<a class="code" href="../../d6/dbe/structof__method.html#a9829068ffbaa124dda46be28c48bfccc">ENDENERGYSTEPS</a>){</div>
<div class="line"><a name="l06880"></a><span class="lineno"> 6880</span>&#160;                  <span class="keywordflow">if</span>(iter&lt;=mtd.<a class="code" href="../../d6/dbe/structof__method.html#a9829068ffbaa124dda46be28c48bfccc">ENDENERGYSTEPS</a>){ iter=mtd.<a class="code" href="../../d6/dbe/structof__method.html#a73849808a0b3a900c373b244089eab1f">BEGINFULLSTEPS</a>-1; <span class="keywordflow">continue</span>;} <span class="comment">// force as if already doing normal steps.  If already next iteration is to be normal step, no need to skip.</span></div>
<div class="line"><a name="l06881"></a><span class="lineno"> 6881</span>&#160;                }<span class="comment">// end if doing energy steps and error not decreasing fast enough, then skip to normal steps</span></div>
<div class="line"><a name="l06882"></a><span class="lineno"> 6882</span>&#160;                <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l06883"></a><span class="lineno"> 6883</span>&#160;                  canbreak=3;</div>
<div class="line"><a name="l06884"></a><span class="lineno"> 6884</span>&#160;                  <span class="keywordflow">if</span>(debugfail&gt;=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a63410994d900c1c05481efc828361b3b">DEBUGLEVELIMPSOLVER</a>){</div>
<div class="line"><a name="l06885"></a><span class="lineno"> 6885</span>&#160;                    dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;Error is not decreasing sufficiently fast: iter=%d priorerrorscount=%d suberrorabsf1=%g\n&quot;</span>,iter,priorerrorscount,suberrorabsf1);</div>
<div class="line"><a name="l06886"></a><span class="lineno"> 6886</span>&#160;                    <span class="keywordflow">for</span>(itererror=1;itererror&lt;<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(priorerrorscount,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab4cf497679ffe5ebf0a9020558d74067">NUMPRIORERRORS</a>);itererror++) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;errorabspf1[%d]=%g\n&quot;</span>,itererror,errorabspf1[itererror]);</div>
<div class="line"><a name="l06887"></a><span class="lineno"> 6887</span>&#160;                  }</div>
<div class="line"><a name="l06888"></a><span class="lineno"> 6888</span>&#160;                  <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l06889"></a><span class="lineno"> 6889</span>&#160;                }<span class="comment">// end if doing normal steps and error not decreasing fast enough</span></div>
<div class="line"><a name="l06890"></a><span class="lineno"> 6890</span>&#160;              }<span class="comment">// end if error not decreasing enough and also higher than desired tolerance in error</span></div>
<div class="line"><a name="l06891"></a><span class="lineno"> 6891</span>&#160;            }<span class="comment">// end if enough prior errors to make average measurement of past error</span></div>
<div class="line"><a name="l06892"></a><span class="lineno"> 6892</span>&#160;            priorerrorscount++;</div>
<div class="line"><a name="l06893"></a><span class="lineno"> 6893</span>&#160;          }</div>
<div class="line"><a name="l06894"></a><span class="lineno"> 6894</span>&#160;</div>
<div class="line"><a name="l06895"></a><span class="lineno"> 6895</span>&#160;</div>
<div class="line"><a name="l06896"></a><span class="lineno"> 6896</span>&#160;</div>
<div class="line"><a name="l06897"></a><span class="lineno"> 6897</span>&#160;</div>
<div class="line"><a name="l06898"></a><span class="lineno"> 6898</span>&#160;</div>
<div class="line"><a name="l06899"></a><span class="lineno"> 6899</span>&#160;        }<span class="comment">// end if checkconv==1</span></div>
<div class="line"><a name="l06900"></a><span class="lineno"> 6900</span>&#160;</div>
<div class="line"><a name="l06901"></a><span class="lineno"> 6901</span>&#160;</div>
<div class="line"><a name="l06902"></a><span class="lineno"> 6902</span>&#160;</div>
<div class="line"><a name="l06903"></a><span class="lineno"> 6903</span>&#160;</div>
<div class="line"><a name="l06905"></a><span class="lineno"> 6905</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l06906"></a><span class="lineno"> 6906</span>&#160;        <span class="comment">// See if solution has nan&#39;ed or inf&#39;ed out.</span></div>
<div class="line"><a name="l06907"></a><span class="lineno"> 6907</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l06909"></a><span class="lineno"> 6909</span>&#160;<span class="comment"></span>        <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a54453e145c6408911f60070de366b11a">IMPUTYPE</a>(mtd.<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>)){</div>
<div class="line"><a name="l06910"></a><span class="lineno"> 6910</span>&#160;          notfinite = !<a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(uu[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[0]])|| !<a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(uu[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[1]])|| !<a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(uu[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[2]])|| !<a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(uu[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[3]]) || !<a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(uup[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[0]])|| !<a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(uup[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[1]])|| !<a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(uup[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[2]])|| !<a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(uup[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[3]]);</div>
<div class="line"><a name="l06911"></a><span class="lineno"> 6911</span>&#160;        }</div>
<div class="line"><a name="l06912"></a><span class="lineno"> 6912</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a003b3a1fbd946c173da7ba3c6312e8e1" title="P or U types.">IMPPTYPE</a>(mtd.<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>)){</div>
<div class="line"><a name="l06913"></a><span class="lineno"> 6913</span>&#160;          notfinite = !<a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(pp[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[0]])|| !<a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(pp[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[1]])|| !<a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(pp[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[2]])|| !<a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(pp[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[3]]) || !<a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(ppp[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[0]])|| !<a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(ppp[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[1]])|| !<a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(ppp[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[2]])|| !<a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(ppp[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[3]]);</div>
<div class="line"><a name="l06914"></a><span class="lineno"> 6914</span>&#160;        }</div>
<div class="line"><a name="l06915"></a><span class="lineno"> 6915</span>&#160;</div>
<div class="line"><a name="l06916"></a><span class="lineno"> 6916</span>&#160;</div>
<div class="line"><a name="l06917"></a><span class="lineno"> 6917</span>&#160;</div>
<div class="line"><a name="l06919"></a><span class="lineno"> 6919</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l06920"></a><span class="lineno"> 6920</span>&#160;        <span class="comment">// continue with computing Jacobian and Newton step if origin point for error function didn&#39;t nan&#39;out or inf&#39;out.</span></div>
<div class="line"><a name="l06921"></a><span class="lineno"> 6921</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l06923"></a><span class="lineno"> 6923</span>&#160;<span class="comment"></span>        <span class="keywordflow">if</span>(!notfinite){</div>
<div class="line"><a name="l06924"></a><span class="lineno"> 6924</span>&#160;    </div>
<div class="line"><a name="l06925"></a><span class="lineno"> 6925</span>&#160;</div>
<div class="line"><a name="l06926"></a><span class="lineno"> 6926</span>&#160;          <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a0d533cb54a9df8780a89f93455915512">SKIPJACCOMPUTE</a>==0 || <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a0d533cb54a9df8780a89f93455915512">SKIPJACCOMPUTE</a>==1 &amp;&amp; (iter&lt;=SKIPJACITER || iter&gt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a6b05d7d9b573d45e23e96b6dc931ae0f">SKIPJACITER</a> &amp;&amp; iter%<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5db3e0d01f4eefea2276d87eee1caad1">SKIPJACFACTOR</a>==0)){ <span class="comment">// only get new Jacobian before 5th iteration and then only if every 3rd iteration since assume Jacobian itself doesn&#39;t change so rapidly.</span></div>
<div class="line"><a name="l06927"></a><span class="lineno"> 6927</span>&#160;</div>
<div class="line"><a name="l06929"></a><span class="lineno"> 6929</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l06930"></a><span class="lineno"> 6930</span>&#160;            <span class="comment">// get Jacobian and inversion Jacobian </span></div>
<div class="line"><a name="l06931"></a><span class="lineno"> 6931</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l06933"></a><span class="lineno"> 6933</span>&#160;<span class="comment"></span>            <span class="comment">//      eomtypelocal=*eomtype; // re-chose default each time.  No, stick with what f1 reduced to for consistency.</span></div>
<div class="line"><a name="l06934"></a><span class="lineno"> 6934</span>&#160;            <span class="comment">//        dualfprintf(fail_file,&quot;iJ call: iter=%d\n&quot;,iter);</span></div>
<div class="line"><a name="l06935"></a><span class="lineno"> 6935</span>&#160;</div>
<div class="line"><a name="l06936"></a><span class="lineno"> 6936</span>&#160;            <span class="comment">// assume as error gets small, function becomes linear and can use smaller delta for Jacobian</span></div>
<div class="line"><a name="l06937"></a><span class="lineno"> 6937</span>&#160;            <span class="keywordflow">if</span>(errorabsf1[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>]&lt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a619a303605d8ee1dbb98c199c988f275">ERRORFORIMPEPSSMALL</a>) impepsjac=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aecad06ce06434289996654bfa987edbb">IMPEPSSMALL</a>;</div>
<div class="line"><a name="l06938"></a><span class="lineno"> 6938</span>&#160;            <span class="keywordflow">else</span> impepsjac=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a900fca7c5effa733d936e1954b7192ee" title="IMPLICIT SOLVER TOLERANCES or DERIVATIVE SIZES for used implicit solver (needs to be chosen more gene...">IMPEPSLARGE</a>;</div>
<div class="line"><a name="l06939"></a><span class="lineno"> 6939</span>&#160;            <span class="keywordtype">int</span> dimtypef=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a6c45d4170066340923e6ec67e05436f4">DIMTYPEFCONS</a>;</div>
<div class="line"><a name="l06940"></a><span class="lineno"> 6940</span>&#160;            <span class="keywordtype">int</span> failreturniJ=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afa73a2caa3209e565a64f92447058507" title="calculating approximate Jacobian: dUresid(dUrad,G(Urad))/dUrad = dy(x)/dx then compute inverse Jacobi...">get_implicit_iJ</a>(allowbaseitermethodswitch, failreturnallowableuse, showmessages, showmessagesheavy, allowlocalfailurefixandnoreport, &amp;eomtypelocal, whichcap, itermode, baseitermethod, fracenergy, dissmeasure, impepsjac, trueimptryconv, trueimptryconvabs, trueimpallowconvabs, trueimpmaxiter, iter, errorabsf1[0], errorabsf1[1], <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>, dimtypef, dimfactU, Uiin, uu, uup, uu0, piin, pp, ppp, fracdtG, realdt, ptrgeom, q, f1, f1norm, iJ, nummhdinvsreturn,&amp;mtd,&amp;ru);</div>
<div class="line"><a name="l06941"></a><span class="lineno"> 6941</span>&#160;</div>
<div class="line"><a name="l06942"></a><span class="lineno"> 6942</span>&#160;            <span class="keywordflow">if</span>(failreturniJ!=0){</div>
<div class="line"><a name="l06943"></a><span class="lineno"> 6943</span>&#160;              <span class="keywordflow">if</span>(havebackup){</div>
<div class="line"><a name="l06944"></a><span class="lineno"> 6944</span>&#160;                failreturn=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a42e7e780e89073f5d14dfafda3bae62e">FAILRETURNMODESWITCH</a>; mathfailtype=30;</div>
<div class="line"><a name="l06945"></a><span class="lineno"> 6945</span>&#160;                <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a7df8286c59d491ba1117884d33499a7a">prod0dualfprintf</a>(debugfail&gt;=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a63410994d900c1c05481efc828361b3b">DEBUGLEVELIMPSOLVER</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;SWITCHING MODE: Detected bad Jacobian\n&quot;</span>);</div>
<div class="line"><a name="l06946"></a><span class="lineno"> 6946</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l06947"></a><span class="lineno"> 6947</span>&#160;              }</div>
<div class="line"><a name="l06948"></a><span class="lineno"> 6948</span>&#160;              <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l06949"></a><span class="lineno"> 6949</span>&#160;                failreturn=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8e6ffbfa15bc415667f8326125aece2f">FAILRETURNJACISSUE</a>; mathfailtype=12;</div>
<div class="line"><a name="l06950"></a><span class="lineno"> 6950</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l06951"></a><span class="lineno"> 6951</span>&#160;              }</div>
<div class="line"><a name="l06952"></a><span class="lineno"> 6952</span>&#160;            }</div>
<div class="line"><a name="l06953"></a><span class="lineno"> 6953</span>&#160;</div>
<div class="line"><a name="l06954"></a><span class="lineno"> 6954</span>&#160;</div>
<div class="line"><a name="l06955"></a><span class="lineno"> 6955</span>&#160;</div>
<div class="line"><a name="l06956"></a><span class="lineno"> 6956</span>&#160;<span class="preprocessor">#if(PRODUCTION==0)</span></div>
<div class="line"><a name="l06957"></a><span class="lineno"> 6957</span>&#160;<span class="preprocessor"></span>            <span class="keywordflow">if</span>(showmessagesheavy){</div>
<div class="line"><a name="l06958"></a><span class="lineno"> 6958</span>&#160;              <span class="keywordtype">int</span> iii,jjj;</div>
<div class="line"><a name="l06959"></a><span class="lineno"> 6959</span>&#160;              <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a06f52b18202ad535ff7c470055f5cb02">JACLOOP2D</a>(iii,jjj,ru.<a class="code" href="../../d2/d46/structof__ref_u.html#a9f3d856dcdd8fa240dfbdcedfad888ef">startjac</a>,ru.<a class="code" href="../../d2/d46/structof__ref_u.html#af67164c1a42e2aefe0603597dd2ea25e">endjac</a>)  dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;iJ[i %d][e %d]=%g\n&quot;</span>,iii,jjj,iJ[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[iii]][ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[jjj]]);</div>
<div class="line"><a name="l06960"></a><span class="lineno"> 6960</span>&#160;            }</div>
<div class="line"><a name="l06961"></a><span class="lineno"> 6961</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l06962"></a><span class="lineno"> 6962</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l06963"></a><span class="lineno"> 6963</span>&#160;</div>
<div class="line"><a name="l06964"></a><span class="lineno"> 6964</span>&#160;          }</div>
<div class="line"><a name="l06965"></a><span class="lineno"> 6965</span>&#160;</div>
<div class="line"><a name="l06966"></a><span class="lineno"> 6966</span>&#160;</div>
<div class="line"><a name="l06967"></a><span class="lineno"> 6967</span>&#160;</div>
<div class="line"><a name="l06969"></a><span class="lineno"> 6969</span>&#160;          <span class="comment">//</span></div>
<div class="line"><a name="l06970"></a><span class="lineno"> 6970</span>&#160;          <span class="comment">// Newton step (uup or ppp)</span></div>
<div class="line"><a name="l06971"></a><span class="lineno"> 6971</span>&#160;          <span class="comment">//</span></div>
<div class="line"><a name="l06972"></a><span class="lineno"> 6972</span>&#160;          <span class="comment">// DAMPFACTOR unused so far because don&#39;t know a priori whether to damp.  fracuup does post-inversion effective damping of this Newton step.</span></div>
<div class="line"><a name="l06973"></a><span class="lineno"> 6973</span>&#160;          <span class="comment">// Newton step: x = x0 - (df/dx)^{-1}|_{x=x0} f(x0)</span></div>
<div class="line"><a name="l06974"></a><span class="lineno"> 6974</span>&#160;          <span class="comment">//</span></div>
<div class="line"><a name="l06975"></a><span class="lineno"> 6975</span>&#160;          <span class="comment">// Only updates 4D part of NPR data</span></div>
<div class="line"><a name="l06976"></a><span class="lineno"> 6976</span>&#160;          <span class="comment">//</span></div>
<div class="line"><a name="l06978"></a><span class="lineno"> 6978</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l06979"></a><span class="lineno"> 6979</span>&#160;</div>
<div class="line"><a name="l06981"></a><span class="lineno"> 6981</span>&#160;          <span class="comment">//</span></div>
<div class="line"><a name="l06982"></a><span class="lineno"> 6982</span>&#160;          <span class="comment">// ITERATING U</span></div>
<div class="line"><a name="l06983"></a><span class="lineno"> 6983</span>&#160;          <span class="comment">//</span></div>
<div class="line"><a name="l06985"></a><span class="lineno"> 6985</span>&#160;<span class="comment"></span>          <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a54453e145c6408911f60070de366b11a">IMPUTYPE</a>(mtd.<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>)){</div>
<div class="line"><a name="l06986"></a><span class="lineno"> 6986</span>&#160;            <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) uu[pl] = uup[pl];</div>
<div class="line"><a name="l06987"></a><span class="lineno"> 6987</span>&#160;            <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a06f52b18202ad535ff7c470055f5cb02">JACLOOP2D</a>(ii,jj,ru.<a class="code" href="../../d2/d46/structof__ref_u.html#a9f3d856dcdd8fa240dfbdcedfad888ef">startjac</a>,ru.<a class="code" href="../../d2/d46/structof__ref_u.html#af67164c1a42e2aefe0603597dd2ea25e">endjac</a>) uu[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[ii]] -= DAMPFACTOR*iJ[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[ii]][ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[jj]]*f1[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[jj]];</div>
<div class="line"><a name="l06988"></a><span class="lineno"> 6988</span>&#160;</div>
<div class="line"><a name="l06989"></a><span class="lineno"> 6989</span>&#160;            <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ae63207aeebd9e61dd18e446352b8197c" title="whether to check pp-ppp 1: directly check post pp-ppp relative error and see if changes by LOCALPREIM...">POSTNEWTONCONVCHECK</a>==2){</div>
<div class="line"><a name="l06990"></a><span class="lineno"> 6990</span>&#160;              <span class="comment">// check if any actual changes in primitives.  If none, then have to stop.</span></div>
<div class="line"><a name="l06991"></a><span class="lineno"> 6991</span>&#160;              <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> diffuu=0.0,sumuu=0.0;</div>
<div class="line"><a name="l06992"></a><span class="lineno"> 6992</span>&#160;              <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l06993"></a><span class="lineno"> 6993</span>&#160;                diffuu += fabs(uu[pl]-uup[pl]);</div>
<div class="line"><a name="l06994"></a><span class="lineno"> 6994</span>&#160;                sumuu += fabs(uu[pl])+fabs(uup[pl]);</div>
<div class="line"><a name="l06995"></a><span class="lineno"> 6995</span>&#160;              }</div>
<div class="line"><a name="l06996"></a><span class="lineno"> 6996</span>&#160;              <span class="keywordflow">if</span>(diffuu&lt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a18a6baa85e6cc019fe0cb531923ffcbf" title="below which sum of all primitives is taken as no interesting change.">DIFFXLIMIT</a>*sumuu){</div>
<div class="line"><a name="l06997"></a><span class="lineno"> 6997</span>&#160;                convreturnf3limit=1;</div>
<div class="line"><a name="l06998"></a><span class="lineno"> 6998</span>&#160;              }</div>
<div class="line"><a name="l06999"></a><span class="lineno"> 6999</span>&#160;            }</div>
<div class="line"><a name="l07000"></a><span class="lineno"> 7000</span>&#160;</div>
<div class="line"><a name="l07001"></a><span class="lineno"> 7001</span>&#160;</div>
<div class="line"><a name="l07002"></a><span class="lineno"> 7002</span>&#160;<span class="preprocessor">#if(PRODUCTION==0)</span></div>
<div class="line"><a name="l07003"></a><span class="lineno"> 7003</span>&#160;<span class="preprocessor"></span>            <span class="keywordflow">if</span>(showmessagesheavy) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;POSTDX: uu: %g %g %g %g : uup=%g %g %g %g\n&quot;</span>,uu[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[0]],uu[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[1]],uu[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[2]],uu[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[3]],uup[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[0]],uup[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[1]],uup[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[2]],uup[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[3]]);</div>
<div class="line"><a name="l07004"></a><span class="lineno"> 7004</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l07005"></a><span class="lineno"> 7005</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l07006"></a><span class="lineno"> 7006</span>&#160;</div>
<div class="line"><a name="l07007"></a><span class="lineno"> 7007</span>&#160;          }<span class="comment">// end iterating U</span></div>
<div class="line"><a name="l07008"></a><span class="lineno"> 7008</span>&#160;</div>
<div class="line"><a name="l07009"></a><span class="lineno"> 7009</span>&#160;</div>
<div class="line"><a name="l07011"></a><span class="lineno"> 7011</span>&#160;          <span class="comment">//</span></div>
<div class="line"><a name="l07012"></a><span class="lineno"> 7012</span>&#160;          <span class="comment">// ITERATING P</span></div>
<div class="line"><a name="l07013"></a><span class="lineno"> 7013</span>&#160;          <span class="comment">//</span></div>
<div class="line"><a name="l07015"></a><span class="lineno"> 7015</span>&#160;<span class="comment"></span>          <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a003b3a1fbd946c173da7ba3c6312e8e1" title="P or U types.">IMPPTYPE</a>(mtd.<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>)){</div>
<div class="line"><a name="l07016"></a><span class="lineno"> 7016</span>&#160;</div>
<div class="line"><a name="l07017"></a><span class="lineno"> 7017</span>&#160;            <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8f61cd4c0fa78552cb734a45cd5aec72">NEWJONHOLDPOS</a>==0){</div>
<div class="line"><a name="l07018"></a><span class="lineno"> 7018</span>&#160;              <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) pp[pl]=ppp[pl];</div>
<div class="line"><a name="l07019"></a><span class="lineno"> 7019</span>&#160;              <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a06f52b18202ad535ff7c470055f5cb02">JACLOOP2D</a>(ii,jj,ru.<a class="code" href="../../d2/d46/structof__ref_u.html#a9f3d856dcdd8fa240dfbdcedfad888ef">startjac</a>,ru.<a class="code" href="../../d2/d46/structof__ref_u.html#af67164c1a42e2aefe0603597dd2ea25e">endjac</a>){</div>
<div class="line"><a name="l07020"></a><span class="lineno"> 7020</span>&#160;                pp[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[ii]] -= DAMPFACTOR*iJ[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[ii]][ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[jj]]*f1[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[jj]];</div>
<div class="line"><a name="l07021"></a><span class="lineno"> 7021</span>&#160;                <span class="keywordflow">if</span>(debugfail&gt;=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a969edf608c4953dd7b4b34e99dbc686c">DEBUGLEVELIMPSOLVERMORE</a>) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;added to ppp=%21.15g ii=%d jj=%d irefU=%d an amount of negative %21.15g\n&quot;</span>,ppp[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[ii]],ii,jj,ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[ii],DAMPFACTOR*iJ[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[ii]][ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[jj]]*f1[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[jj]]);</div>
<div class="line"><a name="l07022"></a><span class="lineno"> 7022</span>&#160;              }</div>
<div class="line"><a name="l07023"></a><span class="lineno"> 7023</span>&#160;            }</div>
<div class="line"><a name="l07024"></a><span class="lineno"> 7024</span>&#160;            <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l07025"></a><span class="lineno"> 7025</span>&#160;              <span class="comment">// if u_g (or Erf)&lt;0, then shift entire jacobian to make smaller changes</span></div>
<div class="line"><a name="l07026"></a><span class="lineno"> 7026</span>&#160;</div>
<div class="line"><a name="l07027"></a><span class="lineno"> 7027</span>&#160;              <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dpp[NPR]={0.0};</div>
<div class="line"><a name="l07028"></a><span class="lineno"> 7028</span>&#160;              <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) pp[pl]=ppp[pl];</div>
<div class="line"><a name="l07029"></a><span class="lineno"> 7029</span>&#160;              <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a06f52b18202ad535ff7c470055f5cb02">JACLOOP2D</a>(ii,jj,ru.<a class="code" href="../../d2/d46/structof__ref_u.html#a9f3d856dcdd8fa240dfbdcedfad888ef">startjac</a>,ru.<a class="code" href="../../d2/d46/structof__ref_u.html#af67164c1a42e2aefe0603597dd2ea25e">endjac</a>){</div>
<div class="line"><a name="l07030"></a><span class="lineno"> 7030</span>&#160;                dpp[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[ii]] += -DAMPFACTOR*iJ[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[ii]][ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[jj]]*f1[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[jj]];</div>
<div class="line"><a name="l07031"></a><span class="lineno"> 7031</span>&#160;                <span class="keywordflow">if</span>(debugfail&gt;=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a969edf608c4953dd7b4b34e99dbc686c">DEBUGLEVELIMPSOLVERMORE</a>) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;added to ppp=%21.15g ii=%d jj=%d irefU=%d an amount of negative %21.15g\n&quot;</span>,ppp[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[ii]],ii,jj,ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[ii],DAMPFACTOR*iJ[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[ii]][ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[jj]]*f1[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[jj]]);</div>
<div class="line"><a name="l07032"></a><span class="lineno"> 7032</span>&#160;              }</div>
<div class="line"><a name="l07033"></a><span class="lineno"> 7033</span>&#160;              <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a33e29fbc91c598484cbeb76769ce1fd2">JACLOOP</a>(ii,ru.<a class="code" href="../../d2/d46/structof__ref_u.html#a9f3d856dcdd8fa240dfbdcedfad888ef">startjac</a>,ru.<a class="code" href="../../d2/d46/structof__ref_u.html#af67164c1a42e2aefe0603597dd2ea25e">endjac</a>){</div>
<div class="line"><a name="l07034"></a><span class="lineno"> 7034</span>&#160;                pp[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[ii]] += dpp[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[ii]];</div>
<div class="line"><a name="l07035"></a><span class="lineno"> 7035</span>&#160;              }</div>
<div class="line"><a name="l07036"></a><span class="lineno"> 7036</span>&#160;</div>
<div class="line"><a name="l07037"></a><span class="lineno"> 7037</span>&#160;              <span class="keywordflow">if</span>(ru.<a class="code" href="../../d2/d46/structof__ref_u.html#a9f3d856dcdd8fa240dfbdcedfad888ef">startjac</a>==0){</div>
<div class="line"><a name="l07038"></a><span class="lineno"> 7038</span>&#160;                ii=0;</div>
<div class="line"><a name="l07039"></a><span class="lineno"> 7039</span>&#160;                <span class="keywordflow">if</span>(pp[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[ii]]&lt;=0.0){</div>
<div class="line"><a name="l07040"></a><span class="lineno"> 7040</span>&#160;<span class="preprocessor">#if(0)</span></div>
<div class="line"><a name="l07041"></a><span class="lineno"> 7041</span>&#160;<span class="preprocessor"></span>                  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ppbad[NPR];</div>
<div class="line"><a name="l07042"></a><span class="lineno"> 7042</span>&#160;                  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) ppbad[pl]=pp[pl];</div>
<div class="line"><a name="l07043"></a><span class="lineno"> 7043</span>&#160;                  <span class="comment">// rescale iJ so u_g -&gt; u_g0/2 instead (or for Erf)</span></div>
<div class="line"><a name="l07044"></a><span class="lineno"> 7044</span>&#160;                  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) pp[pl]=ppp[pl];</div>
<div class="line"><a name="l07045"></a><span class="lineno"> 7045</span>&#160;                  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> REDAMP=fabs(+0.5*ppp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]/dpp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>])*DAMPFACTOR; <span class="comment">// KORALTOD: inverted damp.  Sometimes works, sometimes bad.</span></div>
<div class="line"><a name="l07046"></a><span class="lineno"> 7046</span>&#160;                  <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a06f52b18202ad535ff7c470055f5cb02">JACLOOP2D</a>(ii,jj,ru.<a class="code" href="../../d2/d46/structof__ref_u.html#a9f3d856dcdd8fa240dfbdcedfad888ef">startjac</a>,ru.<a class="code" href="../../d2/d46/structof__ref_u.html#af67164c1a42e2aefe0603597dd2ea25e">endjac</a>){</div>
<div class="line"><a name="l07047"></a><span class="lineno"> 7047</span>&#160;                    pp[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[ii]] += REDAMP*iJ[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[ii]][ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[jj]]*f1[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[jj]];</div>
<div class="line"><a name="l07048"></a><span class="lineno"> 7048</span>&#160;                  }</div>
<div class="line"><a name="l07049"></a><span class="lineno"> 7049</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l07050"></a><span class="lineno"> 7050</span>&#160;<span class="preprocessor"></span>                  pp[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[ii]]=ppp[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[ii]]; <span class="comment">// super hold, works just as well as inverted damp.</span></div>
<div class="line"><a name="l07051"></a><span class="lineno"> 7051</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l07052"></a><span class="lineno"> 7052</span>&#160;<span class="preprocessor"></span>                }</div>
<div class="line"><a name="l07053"></a><span class="lineno"> 7053</span>&#160;              }</div>
<div class="line"><a name="l07054"></a><span class="lineno"> 7054</span>&#160;</div>
<div class="line"><a name="l07055"></a><span class="lineno"> 7055</span>&#160;            }</div>
<div class="line"><a name="l07056"></a><span class="lineno"> 7056</span>&#160;</div>
<div class="line"><a name="l07057"></a><span class="lineno"> 7057</span>&#160;</div>
<div class="line"><a name="l07058"></a><span class="lineno"> 7058</span>&#160;</div>
<div class="line"><a name="l07059"></a><span class="lineno"> 7059</span>&#160;          </div>
<div class="line"><a name="l07060"></a><span class="lineno"> 7060</span>&#160;            <span class="comment">// DEBUG: store steps in case hit max iter and want to debug</span></div>
<div class="line"><a name="l07061"></a><span class="lineno"> 7061</span>&#160;<span class="preprocessor">#if(DEBUGMAXITER)</span></div>
<div class="line"><a name="l07062"></a><span class="lineno"> 7062</span>&#160;<span class="preprocessor"></span>            <span class="keywordflow">if</span>(dampattempt==0){</div>
<div class="line"><a name="l07063"></a><span class="lineno"> 7063</span>&#160;              <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) pppreholdlist[debugiter][pl]=pp[pl];</div>
<div class="line"><a name="l07064"></a><span class="lineno"> 7064</span>&#160;              <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8968c59c029dc64a1057992a70ef8dbd" title="0: show primitive 1: show u^ and urad^">DEBUGMAXITERVELOCITY</a>==1){</div>
<div class="line"><a name="l07065"></a><span class="lineno"> 7065</span>&#160;                <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj){</div>
<div class="line"><a name="l07066"></a><span class="lineno"> 7066</span>&#160;                  pppreholdlist[debugiter][<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>+jj-1]=q-&gt;<a class="code" href="../../d1/d83/structof__state.html#aab723d3c7c2c48b7246cc7d7d5379eed">ucon</a>[jj];</div>
<div class="line"><a name="l07067"></a><span class="lineno"> 7067</span>&#160;                  pppreholdlist[debugiter][URAD1+jj-1]=q-&gt;<a class="code" href="../../d1/d83/structof__state.html#a3bf8e15ee6ae95831230791baf2fc570">uradcon</a>[jj];</div>
<div class="line"><a name="l07068"></a><span class="lineno"> 7068</span>&#160;                }</div>
<div class="line"><a name="l07069"></a><span class="lineno"> 7069</span>&#160;              }</div>
<div class="line"><a name="l07070"></a><span class="lineno"> 7070</span>&#160;              <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a59b7ef1517ff22fd4dfce4cf6d380c55" title="loop over all Dimensions; second rank loop">DLOOP</a>(jj,kk) jaclist[debugiter][jj][kk]=iJ[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]][ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[kk]];</div>
<div class="line"><a name="l07071"></a><span class="lineno"> 7071</span>&#160;              implicititerlist[debugiter]=mtd.<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>;</div>
<div class="line"><a name="l07072"></a><span class="lineno"> 7072</span>&#160;              implicitferrlist[debugiter]=mtd.<a class="code" href="../../d6/dbe/structof__method.html#a2c5c387f7161b69aad77ee5a13d30c68">implicitferr</a>;</div>
<div class="line"><a name="l07073"></a><span class="lineno"> 7073</span>&#160;              fracdamplist[0]=fracdtuu0;</div>
<div class="line"><a name="l07074"></a><span class="lineno"> 7074</span>&#160;              fracdamplist[1]=fracdtG;</div>
<div class="line"><a name="l07075"></a><span class="lineno"> 7075</span>&#160;              fracdamplist[2]=DAMPFACTOR;</div>
<div class="line"><a name="l07076"></a><span class="lineno"> 7076</span>&#160;            }</div>
<div class="line"><a name="l07077"></a><span class="lineno"> 7077</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l07078"></a><span class="lineno"> 7078</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l07079"></a><span class="lineno"> 7079</span>&#160;</div>
<div class="line"><a name="l07080"></a><span class="lineno"> 7080</span>&#160;</div>
<div class="line"><a name="l07081"></a><span class="lineno"> 7081</span>&#160;</div>
<div class="line"><a name="l07083"></a><span class="lineno"> 7083</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l07084"></a><span class="lineno"> 7084</span>&#160;            <span class="comment">//  POST NEWTON ADJUSTMENTS</span></div>
<div class="line"><a name="l07085"></a><span class="lineno"> 7085</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l07087"></a><span class="lineno"> 7087</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l07088"></a><span class="lineno"> 7088</span>&#160;</div>
<div class="line"><a name="l07089"></a><span class="lineno"> 7089</span>&#160;</div>
<div class="line"><a name="l07090"></a><span class="lineno"> 7090</span>&#160;            <span class="comment">// HOLD TT-iterated quantity or momentum-iterated quantity in initial steps</span></div>
<div class="line"><a name="l07091"></a><span class="lineno"> 7091</span>&#160;            <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ada1f75a5f358478d047ee8a8db4436a7" title="how many holds on u_g to apply while stepping velocity.">RAMESHFIXEARLYSTEPS</a>){</div>
<div class="line"><a name="l07092"></a><span class="lineno"> 7092</span>&#160;              <span class="comment">// RAMESH  HOLD</span></div>
<div class="line"><a name="l07093"></a><span class="lineno"> 7093</span>&#160;              <span class="keywordflow">if</span>(iter&lt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ada1f75a5f358478d047ee8a8db4436a7" title="how many holds on u_g to apply while stepping velocity.">RAMESHFIXEARLYSTEPS</a>) pp[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[0]]=ppp[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[0]]; <span class="comment">// don&#39;t trust first Newton step in u_g, Erf, or S</span></div>
<div class="line"><a name="l07094"></a><span class="lineno"> 7094</span>&#160;              <span class="keywordflow">else</span> <span class="keywordflow">if</span>(iter==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ada1f75a5f358478d047ee8a8db4436a7" title="how many holds on u_g to apply while stepping velocity.">RAMESHFIXEARLYSTEPS</a>) <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) pp[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]]=ppp[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]]; <span class="comment">// don&#39;t trust second Newton step in velocity-momentum.</span></div>
<div class="line"><a name="l07095"></a><span class="lineno"> 7095</span>&#160;</div>
<div class="line"><a name="l07096"></a><span class="lineno"> 7096</span>&#160;              <span class="keywordflow">if</span>(pp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>]&lt;=0.0||pp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]&lt;=0.0){</div>
<div class="line"><a name="l07097"></a><span class="lineno"> 7097</span>&#160;                <span class="keywordflow">if</span>(debugfail&gt;=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a969edf608c4953dd7b4b34e99dbc686c">DEBUGLEVELIMPSOLVERMORE</a>) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;Detected negative rho=%21.15g ug=%21.15g\n&quot;</span>,iter,pp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>],pp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]);</div>
<div class="line"><a name="l07098"></a><span class="lineno"> 7098</span>&#160;              }</div>
<div class="line"><a name="l07099"></a><span class="lineno"> 7099</span>&#160;            }<span class="comment">// end Ramesh hold</span></div>
<div class="line"><a name="l07100"></a><span class="lineno"> 7100</span>&#160;</div>
<div class="line"><a name="l07101"></a><span class="lineno"> 7101</span>&#160;</div>
<div class="line"><a name="l07102"></a><span class="lineno"> 7102</span>&#160;</div>
<div class="line"><a name="l07103"></a><span class="lineno"> 7103</span>&#160;</div>
<div class="line"><a name="l07104"></a><span class="lineno"> 7104</span>&#160;</div>
<div class="line"><a name="l07105"></a><span class="lineno"> 7105</span>&#160;</div>
<div class="line"><a name="l07107"></a><span class="lineno"> 7107</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l07108"></a><span class="lineno"> 7108</span>&#160;            <span class="comment">// check if u_g,Erf&lt;0.  Do even if RAMESHFIXEARLYSTEPS going or even if checkconv==0</span></div>
<div class="line"><a name="l07109"></a><span class="lineno"> 7109</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l07111"></a><span class="lineno"> 7111</span>&#160;<span class="comment"></span>            <span class="comment">//          FTYPE umin=10.0*calc_PEQ_ufromTrho(TEMPMIN,fabs(pp[RHO]));</span></div>
<div class="line"><a name="l07112"></a><span class="lineno"> 7112</span>&#160;            <span class="keywordflow">if</span>(pp[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[0]]&lt;=0.0 &amp;&amp; (<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a003b3a1fbd946c173da7ba3c6312e8e1" title="P or U types.">IMPPTYPE</a>(mtd.<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>)&amp;&amp; *baseitermethod!=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a7a5a1fd5a93591755aa3e1af2019dc57">QTYENTROPYPMHD</a>)){ <span class="comment">// don&#39;t consider mtd.implicititer==QTYENTROPYPMHD since S can be positive or negative.  Would only be unphysical or absolute-limited if the related u_g&lt;0 or rho&lt;0.</span></div>
<div class="line"><a name="l07113"></a><span class="lineno"> 7113</span>&#160;              <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a311385191ec842a32ec2e645c2491e38" title="whether to apply Jon&#39;s hold on u_g or rho from going negative">JONHOLDPOS</a>){</div>
<div class="line"><a name="l07114"></a><span class="lineno"> 7114</span>&#160;</div>
<div class="line"><a name="l07115"></a><span class="lineno"> 7115</span>&#160;<span class="preprocessor">#if(1)</span></div>
<div class="line"><a name="l07116"></a><span class="lineno"> 7116</span>&#160;<span class="preprocessor"></span>                holdingaspositive=0; <span class="comment">// default</span></div>
<div class="line"><a name="l07117"></a><span class="lineno"> 7117</span>&#160;                <span class="keywordflow">if</span>(countholdpositive&lt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aceea98f8281dc4737224ea2233815318" title="number of times allowed to hold u_g as positive">NUMHOLDTIMES</a>){</div>
<div class="line"><a name="l07118"></a><span class="lineno"> 7118</span>&#160;                  <span class="keywordflow">if</span>(debugfail&gt;=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a63410994d900c1c05481efc828361b3b">DEBUGLEVELIMPSOLVER</a>) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;HOLDING: Detected unphysical iter=%d countholdpositive=%d : pp[ru.irefU[0]]=%g : ijknstepsteppart=%d %d %d %ld %d\n&quot;</span>,iter,countholdpositive,pp[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[0]],ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a1a1088d87617078680f1fd0f0d707384">nstep</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a70170b90229f9fc05eebf8508a685c70">steppart</a>);</div>
<div class="line"><a name="l07119"></a><span class="lineno"> 7119</span>&#160;                  <span class="comment">//pp[ru.irefU[0]]=MAX(100.0*NUMEPSILON*fabs(pp[RHO]),fabs(ppp[ru.irefU[0]])); // hold as positive -- ppp might be too large so hold might be too aggressive to be useful.</span></div>
<div class="line"><a name="l07120"></a><span class="lineno"> 7120</span>&#160;                  <span class="comment">//                if(gotbest) umin=MAX(umin,0.5*fabs(pp[UU])); // override with last best version of u_g, because using very minimum leads to jump in behavior. // causes problems, leads to many high error events.</span></div>
<div class="line"><a name="l07121"></a><span class="lineno"> 7121</span>&#160;                  <span class="comment">//pp[ru.irefU[0]]=umin; // hold as positive.</span></div>
<div class="line"><a name="l07122"></a><span class="lineno"> 7122</span>&#160;                  pp[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[0]]=0.5*fabs(ppp[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[0]]); <span class="comment">// just drop by half of positive value of *previous* value, not of negative value.</span></div>
<div class="line"><a name="l07123"></a><span class="lineno"> 7123</span>&#160;                  countholdpositive++;</div>
<div class="line"><a name="l07124"></a><span class="lineno"> 7124</span>&#160;                  holdingaspositive=1;</div>
<div class="line"><a name="l07125"></a><span class="lineno"> 7125</span>&#160;                }</div>
<div class="line"><a name="l07126"></a><span class="lineno"> 7126</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l07127"></a><span class="lineno"> 7127</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define NUMITERHOLD (eomcond ? 2 : 4)</span></div>
<div class="line"><a name="l07128"></a><span class="lineno"> 7128</span>&#160;<span class="preprocessor"></span>                <span class="keywordflow">if</span>(holdingaspositive==0 || holdingaspositive==1 &amp;&amp; iter&lt;iterhold+NUMITERHOLD){</div>
<div class="line"><a name="l07129"></a><span class="lineno"> 7129</span>&#160;                  <span class="keywordflow">if</span>(debugfail&gt;=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a63410994d900c1c05481efc828361b3b">DEBUGLEVELIMPSOLVER</a>) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;HOLDING: Detected unphysical iter=%d iterhold+NUMITERHOLD=%d holdingaspositive=%d : pp[ru.irefU[0]]=%g : ijknstepsteppart=%d %d %d %ld %d\n&quot;</span>,iter,iterhold+NUMITERHOLD,holdingaspositive,pp[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[0]],ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a1a1088d87617078680f1fd0f0d707384">nstep</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a70170b90229f9fc05eebf8508a685c70">steppart</a>);</div>
<div class="line"><a name="l07130"></a><span class="lineno"> 7130</span>&#160;                  <span class="keywordflow">if</span>(holdingaspositive==0) iterhold=iter;</div>
<div class="line"><a name="l07131"></a><span class="lineno"> 7131</span>&#160;                  <span class="comment">//              else holdingaspositive=1;</span></div>
<div class="line"><a name="l07132"></a><span class="lineno"> 7132</span>&#160;                  holdingaspositive=1;</div>
<div class="line"><a name="l07133"></a><span class="lineno"> 7133</span>&#160;                  <span class="comment">//                pp[ru.irefU[0]]=100.0*NUMEPSILON*fabs(pp[RHO]); // hold as positive just one iteration</span></div>
<div class="line"><a name="l07134"></a><span class="lineno"> 7134</span>&#160;                  <span class="comment">//                if(gotbest) umin=MAX(umin,0.5*fabs(pp[UU])); // override with last best version of u_g, because using very minimum leads to jump in behavior. // causes problems, leads to many high error events.</span></div>
<div class="line"><a name="l07135"></a><span class="lineno"> 7135</span>&#160;                  <span class="comment">//pp[ru.irefU[0]]=umin; // hold as positive</span></div>
<div class="line"><a name="l07136"></a><span class="lineno"> 7136</span>&#160;                  pp[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[0]]=0.5*fabs(ppp[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[0]]); <span class="comment">// just drop by half of positive value of *previous* value, not of negative value.</span></div>
<div class="line"><a name="l07137"></a><span class="lineno"> 7137</span>&#160;                }</div>
<div class="line"><a name="l07138"></a><span class="lineno"> 7138</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l07139"></a><span class="lineno"> 7139</span>&#160;<span class="preprocessor"></span>                <span class="keywordflow">else</span>{<span class="comment">// then exceeding hold attempts</span></div>
<div class="line"><a name="l07140"></a><span class="lineno"> 7140</span>&#160;</div>
<div class="line"><a name="l07141"></a><span class="lineno"> 7141</span>&#160;                  <span class="comment">// if pre-normal step, skip to next type of step because non-normal step seems to want wrong/bad u_g anyways.</span></div>
<div class="line"><a name="l07142"></a><span class="lineno"> 7142</span>&#160;                  <span class="keywordflow">if</span>(itermode==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a480c56e263c4874ccb40f3bbc1b32032">ITERMODESTAGES</a> &amp;&amp; iter&gt;=mtd.<a class="code" href="../../d6/dbe/structof__method.html#ab82f125cc45b1d2881155d70795fbf8a">BEGINMOMSTEPS</a> &amp;&amp; iter&lt;=mtd.<a class="code" href="../../d6/dbe/structof__method.html#a854fcca7e3e1d7ab0a6955321ce698de">ENDMOMSTEPS</a>){</div>
<div class="line"><a name="l07143"></a><span class="lineno"> 7143</span>&#160;                    <span class="comment">// revert to previous stepping&#39;s u_g, since using modified u_g (after u_g&lt;0) should be bad.</span></div>
<div class="line"><a name="l07144"></a><span class="lineno"> 7144</span>&#160;                    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l07145"></a><span class="lineno"> 7145</span>&#160;                      pp[pl] = pppriorsteptype[pl];</div>
<div class="line"><a name="l07146"></a><span class="lineno"> 7146</span>&#160;                      uu[pl] = uupriorsteptype[pl];</div>
<div class="line"><a name="l07147"></a><span class="lineno"> 7147</span>&#160;                    }                    </div>
<div class="line"><a name="l07148"></a><span class="lineno"> 7148</span>&#160;                    iter=mtd.<a class="code" href="../../d6/dbe/structof__method.html#a6412a5671687f2d9f5be2fd0fafb81f1">BEGINENERGYSTEPS</a>-1;</div>
<div class="line"><a name="l07149"></a><span class="lineno"> 7149</span>&#160;                    <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l07150"></a><span class="lineno"> 7150</span>&#160;                  }</div>
<div class="line"><a name="l07151"></a><span class="lineno"> 7151</span>&#160;                  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(itermode==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a480c56e263c4874ccb40f3bbc1b32032">ITERMODESTAGES</a> &amp;&amp; iter&gt;=mtd.<a class="code" href="../../d6/dbe/structof__method.html#a6412a5671687f2d9f5be2fd0fafb81f1">BEGINENERGYSTEPS</a> &amp;&amp; iter&lt;=mtd.<a class="code" href="../../d6/dbe/structof__method.html#a9829068ffbaa124dda46be28c48bfccc">ENDENERGYSTEPS</a>){</div>
<div class="line"><a name="l07152"></a><span class="lineno"> 7152</span>&#160;                    <span class="comment">// revert previous stepping&#39;s u_g, since using modified u_g (after u_g&lt;0) should be bad.</span></div>
<div class="line"><a name="l07153"></a><span class="lineno"> 7153</span>&#160;                    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l07154"></a><span class="lineno"> 7154</span>&#160;                      pp[pl] = pppriorsteptype[pl];</div>
<div class="line"><a name="l07155"></a><span class="lineno"> 7155</span>&#160;                      uu[pl] = uupriorsteptype[pl];</div>
<div class="line"><a name="l07156"></a><span class="lineno"> 7156</span>&#160;                    }                    </div>
<div class="line"><a name="l07157"></a><span class="lineno"> 7157</span>&#160;                    iter=mtd.<a class="code" href="../../d6/dbe/structof__method.html#a73849808a0b3a900c373b244089eab1f">BEGINFULLSTEPS</a>-1;</div>
<div class="line"><a name="l07158"></a><span class="lineno"> 7158</span>&#160;                    <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l07159"></a><span class="lineno"> 7159</span>&#160;                  }</div>
<div class="line"><a name="l07160"></a><span class="lineno"> 7160</span>&#160;                  <span class="keywordflow">else</span>{<span class="comment">// else doing normal steps</span></div>
<div class="line"><a name="l07161"></a><span class="lineno"> 7161</span>&#160;                    pp[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[0]]=0.5*fabs(ppp[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[0]]); <span class="comment">// just drop by half of positive value of *previous* value, not of negative value.</span></div>
<div class="line"><a name="l07162"></a><span class="lineno"> 7162</span>&#160;                    <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a11a23c165eeac58d97d409da3de53e0a" title="need to do final check since get f1 and then do step.">DOFINALCHECK</a>){</div>
<div class="line"><a name="l07163"></a><span class="lineno"> 7163</span>&#160;                      <span class="keywordflow">if</span>(debugfail&gt;=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a63410994d900c1c05481efc828361b3b">DEBUGLEVELIMPSOLVER</a>) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;Unable to hold off u_g&lt;0, setting canbreak=1 and letting finalchecks confirm error is good or bad.  iter=%d\n&quot;</span>,iter);</div>
<div class="line"><a name="l07164"></a><span class="lineno"> 7164</span>&#160;                      canbreak=1; <span class="comment">// just break since might be good (or at least allowable) error still.  Let final error check handle this.</span></div>
<div class="line"><a name="l07165"></a><span class="lineno"> 7165</span>&#160;                      <span class="comment">// not fail.</span></div>
<div class="line"><a name="l07166"></a><span class="lineno"> 7166</span>&#160;                      mathfailtype=89;</div>
<div class="line"><a name="l07167"></a><span class="lineno"> 7167</span>&#160;                      <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l07168"></a><span class="lineno"> 7168</span>&#160;                    }</div>
<div class="line"><a name="l07169"></a><span class="lineno"> 7169</span>&#160;                    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(havebackup){</div>
<div class="line"><a name="l07170"></a><span class="lineno"> 7170</span>&#160;                      failreturn=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a42e7e780e89073f5d14dfafda3bae62e">FAILRETURNMODESWITCH</a>; mathfailtype=90;</div>
<div class="line"><a name="l07171"></a><span class="lineno"> 7171</span>&#160;                      <span class="keywordflow">if</span>(debugfail&gt;=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a969edf608c4953dd7b4b34e99dbc686c">DEBUGLEVELIMPSOLVERMORE</a>) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;SWITCHING MODE: Detected bad u_g\n&quot;</span>);</div>
<div class="line"><a name="l07172"></a><span class="lineno"> 7172</span>&#160;                      <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l07173"></a><span class="lineno"> 7173</span>&#160;                    }</div>
<div class="line"><a name="l07174"></a><span class="lineno"> 7174</span>&#160;                    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l07175"></a><span class="lineno"> 7175</span>&#160;                      <span class="comment">// then full failure</span></div>
<div class="line"><a name="l07176"></a><span class="lineno"> 7176</span>&#160;                      failreturn=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab0abd953f677a44020dc50259c410486">FAILRETURNGENERAL</a>; mathfailtype=10;</div>
<div class="line"><a name="l07177"></a><span class="lineno"> 7177</span>&#160;                      <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l07178"></a><span class="lineno"> 7178</span>&#160;                    }</div>
<div class="line"><a name="l07179"></a><span class="lineno"> 7179</span>&#160;                  }<span class="comment">// end else normal step</span></div>
<div class="line"><a name="l07180"></a><span class="lineno"> 7180</span>&#160;                } <span class="comment">// if beyond hold counts allowed</span></div>
<div class="line"><a name="l07181"></a><span class="lineno"> 7181</span>&#160;              } <span class="comment">// end if JONHOLDPOS</span></div>
<div class="line"><a name="l07182"></a><span class="lineno"> 7182</span>&#160;              <span class="keywordflow">else</span>{<span class="comment">//  not using JONHOLDPOS</span></div>
<div class="line"><a name="l07183"></a><span class="lineno"> 7183</span>&#160;                <span class="comment">// if pre-normal step, skip to next type of step because non-normal step may have wrong u_g anyways.</span></div>
<div class="line"><a name="l07184"></a><span class="lineno"> 7184</span>&#160;                <span class="keywordflow">if</span>(itermode==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a480c56e263c4874ccb40f3bbc1b32032">ITERMODESTAGES</a> &amp;&amp; iter&gt;=mtd.<a class="code" href="../../d6/dbe/structof__method.html#ab82f125cc45b1d2881155d70795fbf8a">BEGINMOMSTEPS</a> &amp;&amp; iter&lt;=mtd.<a class="code" href="../../d6/dbe/structof__method.html#a854fcca7e3e1d7ab0a6955321ce698de">ENDMOMSTEPS</a>){ iter=mtd.<a class="code" href="../../d6/dbe/structof__method.html#a6412a5671687f2d9f5be2fd0fafb81f1">BEGINENERGYSTEPS</a>-1;    <span class="keywordflow">continue</span>;    }</div>
<div class="line"><a name="l07185"></a><span class="lineno"> 7185</span>&#160;                <span class="keywordflow">else</span> <span class="keywordflow">if</span>(itermode==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a480c56e263c4874ccb40f3bbc1b32032">ITERMODESTAGES</a> &amp;&amp; iter&gt;=mtd.<a class="code" href="../../d6/dbe/structof__method.html#a6412a5671687f2d9f5be2fd0fafb81f1">BEGINENERGYSTEPS</a> &amp;&amp; iter&lt;=mtd.<a class="code" href="../../d6/dbe/structof__method.html#a9829068ffbaa124dda46be28c48bfccc">ENDENERGYSTEPS</a>){ iter=mtd.<a class="code" href="../../d6/dbe/structof__method.html#a73849808a0b3a900c373b244089eab1f">BEGINFULLSTEPS</a>-1;   <span class="keywordflow">continue</span>; }</div>
<div class="line"><a name="l07186"></a><span class="lineno"> 7186</span>&#160;                <span class="keywordflow">else</span>{<span class="comment">// else doing normal steps</span></div>
<div class="line"><a name="l07187"></a><span class="lineno"> 7187</span>&#160;                  <span class="keywordflow">if</span>(havebackup){</div>
<div class="line"><a name="l07188"></a><span class="lineno"> 7188</span>&#160;                    failreturn=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a42e7e780e89073f5d14dfafda3bae62e">FAILRETURNMODESWITCH</a>; mathfailtype=90;</div>
<div class="line"><a name="l07189"></a><span class="lineno"> 7189</span>&#160;                    <span class="keywordflow">if</span>(debugfail&gt;=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a969edf608c4953dd7b4b34e99dbc686c">DEBUGLEVELIMPSOLVERMORE</a>) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;SWITCHING MODE: Detected unphysical pp[ru.irefU[0]]: iter=%d\n&quot;</span>,iter);</div>
<div class="line"><a name="l07190"></a><span class="lineno"> 7190</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l07191"></a><span class="lineno"> 7191</span>&#160;                  }</div>
<div class="line"><a name="l07192"></a><span class="lineno"> 7192</span>&#160;                }</div>
<div class="line"><a name="l07193"></a><span class="lineno"> 7193</span>&#160;              }<span class="comment">// else if not using JONHOLDPOS</span></div>
<div class="line"><a name="l07194"></a><span class="lineno"> 7194</span>&#160;            }<span class="comment">// end if u_g&lt;0 and iterating primitives</span></div>
<div class="line"><a name="l07195"></a><span class="lineno"> 7195</span>&#160;            <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l07196"></a><span class="lineno"> 7196</span>&#160;              <span class="comment">// if u_g&gt;0, not holding.</span></div>
<div class="line"><a name="l07197"></a><span class="lineno"> 7197</span>&#160;              holdingaspositive=0;</div>
<div class="line"><a name="l07198"></a><span class="lineno"> 7198</span>&#160;            }</div>
<div class="line"><a name="l07199"></a><span class="lineno"> 7199</span>&#160;</div>
<div class="line"><a name="l07200"></a><span class="lineno"> 7200</span>&#160;</div>
<div class="line"><a name="l07201"></a><span class="lineno"> 7201</span>&#160;</div>
<div class="line"><a name="l07202"></a><span class="lineno"> 7202</span>&#160;</div>
<div class="line"><a name="l07203"></a><span class="lineno"> 7203</span>&#160;            <span class="comment">// DEBUG: store steps in case hit max iter and want to debug</span></div>
<div class="line"><a name="l07204"></a><span class="lineno"> 7204</span>&#160;<span class="preprocessor">#if(DEBUGMAXITER)</span></div>
<div class="line"><a name="l07205"></a><span class="lineno"> 7205</span>&#160;<span class="preprocessor"></span>            <span class="keywordflow">if</span>(dampattempt==0){</div>
<div class="line"><a name="l07206"></a><span class="lineno"> 7206</span>&#160;              <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) ppposholdlist[debugiter][pl]=pp[pl];</div>
<div class="line"><a name="l07207"></a><span class="lineno"> 7207</span>&#160;              <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8968c59c029dc64a1057992a70ef8dbd" title="0: show primitive 1: show u^ and urad^">DEBUGMAXITERVELOCITY</a>==1){</div>
<div class="line"><a name="l07208"></a><span class="lineno"> 7208</span>&#160;                <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj){</div>
<div class="line"><a name="l07209"></a><span class="lineno"> 7209</span>&#160;                  ppposholdlist[debugiter][<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>+jj-1]=q-&gt;<a class="code" href="../../d1/d83/structof__state.html#aab723d3c7c2c48b7246cc7d7d5379eed">ucon</a>[jj];</div>
<div class="line"><a name="l07210"></a><span class="lineno"> 7210</span>&#160;                  ppposholdlist[debugiter][URAD1+jj-1]=q-&gt;<a class="code" href="../../d1/d83/structof__state.html#a3bf8e15ee6ae95831230791baf2fc570">uradcon</a>[jj];</div>
<div class="line"><a name="l07211"></a><span class="lineno"> 7211</span>&#160;                }</div>
<div class="line"><a name="l07212"></a><span class="lineno"> 7212</span>&#160;              }</div>
<div class="line"><a name="l07213"></a><span class="lineno"> 7213</span>&#160;            }</div>
<div class="line"><a name="l07214"></a><span class="lineno"> 7214</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l07215"></a><span class="lineno"> 7215</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l07216"></a><span class="lineno"> 7216</span>&#160;</div>
<div class="line"><a name="l07217"></a><span class="lineno"> 7217</span>&#160;</div>
<div class="line"><a name="l07218"></a><span class="lineno"> 7218</span>&#160;            <span class="comment">// determine if holding so post-newton checks know.</span></div>
<div class="line"><a name="l07219"></a><span class="lineno"> 7219</span>&#160;            notholding=(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ada1f75a5f358478d047ee8a8db4436a7" title="how many holds on u_g to apply while stepping velocity.">RAMESHFIXEARLYSTEPS</a> &amp;&amp; iter&gt;=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ada1f75a5f358478d047ee8a8db4436a7" title="how many holds on u_g to apply while stepping velocity.">RAMESHFIXEARLYSTEPS</a> || <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ada1f75a5f358478d047ee8a8db4436a7" title="how many holds on u_g to apply while stepping velocity.">RAMESHFIXEARLYSTEPS</a>==0) &amp;&amp; (<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a311385191ec842a32ec2e645c2491e38" title="whether to apply Jon&#39;s hold on u_g or rho from going negative">JONHOLDPOS</a> &amp;&amp; holdingaspositive==0 || <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a311385191ec842a32ec2e645c2491e38" title="whether to apply Jon&#39;s hold on u_g or rho from going negative">JONHOLDPOS</a>==0);</div>
<div class="line"><a name="l07220"></a><span class="lineno"> 7220</span>&#160;</div>
<div class="line"><a name="l07221"></a><span class="lineno"> 7221</span>&#160;</div>
<div class="line"><a name="l07222"></a><span class="lineno"> 7222</span>&#160;</div>
<div class="line"><a name="l07224"></a><span class="lineno"> 7224</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l07225"></a><span class="lineno"> 7225</span>&#160;            <span class="comment">//  POST NEWTON CHECKS</span></div>
<div class="line"><a name="l07226"></a><span class="lineno"> 7226</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l07228"></a><span class="lineno"> 7228</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l07229"></a><span class="lineno"> 7229</span>&#160;</div>
<div class="line"><a name="l07230"></a><span class="lineno"> 7230</span>&#160;            <span class="comment">// only do post-newton checks if checking convergence allowed</span></div>
<div class="line"><a name="l07231"></a><span class="lineno"> 7231</span>&#160;            <span class="keywordflow">if</span>(checkconv==1){</div>
<div class="line"><a name="l07232"></a><span class="lineno"> 7232</span>&#160;</div>
<div class="line"><a name="l07233"></a><span class="lineno"> 7233</span>&#160;              <span class="comment">// check if energy u_g too often bad compared to entropy u_g</span></div>
<div class="line"><a name="l07234"></a><span class="lineno"> 7234</span>&#160;              <span class="comment">// assume this is only done after </span></div>
<div class="line"><a name="l07235"></a><span class="lineno"> 7235</span>&#160;              <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a69c8700ef814c6827710501cb880689b" title="stop iterating energy if pbenergy[UU]&lt;0.5*pbentropy[UU] consistently starting aafter below number of ...">RAMESHSTOPENERGYIFTOOOFTENBELOWENTROPY</a>){</div>
<div class="line"><a name="l07236"></a><span class="lineno"> 7236</span>&#160;                <span class="keywordflow">if</span>((mtd.<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9cf5ca7f5e5aa1e0bdef53abe3f27c1c">QTYPMHD</a> || mtd.<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8b10ec187cbee196f071e162563cd945">QTYPMHDENERGYONLY</a>)  &amp;&amp; didentropyalready){</div>
<div class="line"><a name="l07237"></a><span class="lineno"> 7237</span>&#160;                  <span class="keywordflow">if</span>(notholding==1 || mtd.<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9cf5ca7f5e5aa1e0bdef53abe3f27c1c">QTYPMHD</a>){ <span class="comment">// if holding on energy equation, don&#39;t  use this u_g check.  But, if normal steps, then ignore holding and assume holding means u_g bad if on normal steps.</span></div>
<div class="line"><a name="l07238"></a><span class="lineno"> 7238</span>&#160;                    <span class="keywordflow">if</span>(badenergy(ptrgeom,pp,pborig)) countbadenergy++;</div>
<div class="line"><a name="l07239"></a><span class="lineno"> 7239</span>&#160;                    <span class="keywordflow">if</span>(countbadenergy&gt;=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a69c8700ef814c6827710501cb880689b" title="stop iterating energy if pbenergy[UU]&lt;0.5*pbentropy[UU] consistently starting aafter below number of ...">RAMESHSTOPENERGYIFTOOOFTENBELOWENTROPY</a>){</div>
<div class="line"><a name="l07240"></a><span class="lineno"> 7240</span>&#160;</div>
<div class="line"><a name="l07241"></a><span class="lineno"> 7241</span>&#160;                      <span class="comment">// if pre-normal step, skip to next type of step because non-normal step may have wrong u_g anyways.</span></div>
<div class="line"><a name="l07242"></a><span class="lineno"> 7242</span>&#160;                      <span class="keywordflow">if</span>(itermode==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a480c56e263c4874ccb40f3bbc1b32032">ITERMODESTAGES</a> &amp;&amp; iter&gt;=mtd.<a class="code" href="../../d6/dbe/structof__method.html#ab82f125cc45b1d2881155d70795fbf8a">BEGINMOMSTEPS</a> &amp;&amp; iter&lt;=mtd.<a class="code" href="../../d6/dbe/structof__method.html#a854fcca7e3e1d7ab0a6955321ce698de">ENDMOMSTEPS</a>){ iter=mtd.<a class="code" href="../../d6/dbe/structof__method.html#a6412a5671687f2d9f5be2fd0fafb81f1">BEGINENERGYSTEPS</a>-1;    <span class="keywordflow">continue</span>;    }</div>
<div class="line"><a name="l07243"></a><span class="lineno"> 7243</span>&#160;                      <span class="keywordflow">else</span> <span class="keywordflow">if</span>(itermode==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a480c56e263c4874ccb40f3bbc1b32032">ITERMODESTAGES</a> &amp;&amp; iter&gt;=mtd.<a class="code" href="../../d6/dbe/structof__method.html#a6412a5671687f2d9f5be2fd0fafb81f1">BEGINENERGYSTEPS</a> &amp;&amp; iter&lt;=mtd.<a class="code" href="../../d6/dbe/structof__method.html#a9829068ffbaa124dda46be28c48bfccc">ENDENERGYSTEPS</a>){ iter=mtd.<a class="code" href="../../d6/dbe/structof__method.html#a73849808a0b3a900c373b244089eab1f">BEGINFULLSTEPS</a>-1;   <span class="keywordflow">continue</span>; }</div>
<div class="line"><a name="l07244"></a><span class="lineno"> 7244</span>&#160;                      <span class="keywordflow">else</span>{<span class="comment">// else doing normal steps</span></div>
<div class="line"><a name="l07245"></a><span class="lineno"> 7245</span>&#160;                        <span class="comment">// &quot;switch&quot; to entropy by just stopping trying to get energy solution</span></div>
<div class="line"><a name="l07246"></a><span class="lineno"> 7246</span>&#160;                        failreturn=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a42e7e780e89073f5d14dfafda3bae62e">FAILRETURNMODESWITCH</a>; mathfailtype=100;</div>
<div class="line"><a name="l07247"></a><span class="lineno"> 7247</span>&#160;                        <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a7df8286c59d491ba1117884d33499a7a">prod0dualfprintf</a>(debugfail&gt;=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a63410994d900c1c05481efc828361b3b">DEBUGLEVELIMPSOLVER</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;SWITCHING MODE: Detected entropy u_g preferred consistently: iter=%d: %g %g\n&quot;</span>,iter,pp[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[0]],pborig[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[0]]);</div>
<div class="line"><a name="l07248"></a><span class="lineno"> 7248</span>&#160;                        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l07249"></a><span class="lineno"> 7249</span>&#160;                      }</div>
<div class="line"><a name="l07250"></a><span class="lineno"> 7250</span>&#160;                    }<span class="comment">// end if normal step</span></div>
<div class="line"><a name="l07251"></a><span class="lineno"> 7251</span>&#160;                  }<span class="comment">//end if at point where iterations can be considered</span></div>
<div class="line"><a name="l07252"></a><span class="lineno"> 7252</span>&#160;                }<span class="comment">// whether have information necessary to check</span></div>
<div class="line"><a name="l07253"></a><span class="lineno"> 7253</span>&#160;              }<span class="comment">// whether to check u_g energy vs. entropy</span></div>
<div class="line"><a name="l07254"></a><span class="lineno"> 7254</span>&#160;</div>
<div class="line"><a name="l07255"></a><span class="lineno"> 7255</span>&#160;</div>
<div class="line"><a name="l07256"></a><span class="lineno"> 7256</span>&#160;</div>
<div class="line"><a name="l07257"></a><span class="lineno"> 7257</span>&#160;              <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ae63207aeebd9e61dd18e446352b8197c" title="whether to check pp-ppp 1: directly check post pp-ppp relative error and see if changes by LOCALPREIM...">POSTNEWTONCONVCHECK</a>==2 &amp;&amp; notholding==1){</div>
<div class="line"><a name="l07258"></a><span class="lineno"> 7258</span>&#160;                <span class="comment">// check if any actual changes in primitives.  If none, then have to stop.</span></div>
<div class="line"><a name="l07259"></a><span class="lineno"> 7259</span>&#160;                <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> diffpp=0.0,sumpp=0.0;</div>
<div class="line"><a name="l07260"></a><span class="lineno"> 7260</span>&#160;                <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l07261"></a><span class="lineno"> 7261</span>&#160;                  diffpp += fabs(pp[pl]-ppp[pl]);</div>
<div class="line"><a name="l07262"></a><span class="lineno"> 7262</span>&#160;                  sumpp += fabs(pp[pl])+fabs(ppp[pl]);</div>
<div class="line"><a name="l07263"></a><span class="lineno"> 7263</span>&#160;                }</div>
<div class="line"><a name="l07264"></a><span class="lineno"> 7264</span>&#160;                <span class="keywordflow">if</span>(diffpp&lt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a18a6baa85e6cc019fe0cb531923ffcbf" title="below which sum of all primitives is taken as no interesting change.">DIFFXLIMIT</a>*sumpp){</div>
<div class="line"><a name="l07265"></a><span class="lineno"> 7265</span>&#160;                  convreturnf3limit=1;</div>
<div class="line"><a name="l07266"></a><span class="lineno"> 7266</span>&#160;                }</div>
<div class="line"><a name="l07267"></a><span class="lineno"> 7267</span>&#160;              }</div>
<div class="line"><a name="l07268"></a><span class="lineno"> 7268</span>&#160;            }<span class="comment">// end if checkconv==1</span></div>
<div class="line"><a name="l07269"></a><span class="lineno"> 7269</span>&#160;</div>
<div class="line"><a name="l07270"></a><span class="lineno"> 7270</span>&#160;</div>
<div class="line"><a name="l07271"></a><span class="lineno"> 7271</span>&#160;</div>
<div class="line"><a name="l07272"></a><span class="lineno"> 7272</span>&#160;</div>
<div class="line"><a name="l07273"></a><span class="lineno"> 7273</span>&#160;            <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a7df8286c59d491ba1117884d33499a7a">prod0dualfprintf</a>(showmessagesheavy,<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;POSTDX: pp: %g %g %g %g : ppp=%g %g %g %g\n&quot;</span>,pp[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[0]],pp[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[1]],pp[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[2]],pp[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[3]],ppp[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[0]],ppp[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[1]],ppp[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[2]],ppp[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[3]]);</div>
<div class="line"><a name="l07274"></a><span class="lineno"> 7274</span>&#160;</div>
<div class="line"><a name="l07275"></a><span class="lineno"> 7275</span>&#160;</div>
<div class="line"><a name="l07276"></a><span class="lineno"> 7276</span>&#160;</div>
<div class="line"><a name="l07277"></a><span class="lineno"> 7277</span>&#160;          }<span class="comment">// end if iterating primitves</span></div>
<div class="line"><a name="l07278"></a><span class="lineno"> 7278</span>&#160;</div>
<div class="line"><a name="l07279"></a><span class="lineno"> 7279</span>&#160;</div>
<div class="line"><a name="l07280"></a><span class="lineno"> 7280</span>&#160;   </div>
<div class="line"><a name="l07281"></a><span class="lineno"> 7281</span>&#160;</div>
<div class="line"><a name="l07282"></a><span class="lineno"> 7282</span>&#160;      </div>
<div class="line"><a name="l07283"></a><span class="lineno"> 7283</span>&#160;</div>
<div class="line"><a name="l07285"></a><span class="lineno"> 7285</span>&#160;          <span class="comment">//</span></div>
<div class="line"><a name="l07286"></a><span class="lineno"> 7286</span>&#160;          <span class="comment">//  POST NEWTON ADJUSTMENTS part 2</span></div>
<div class="line"><a name="l07287"></a><span class="lineno"> 7287</span>&#160;          <span class="comment">//</span></div>
<div class="line"><a name="l07289"></a><span class="lineno"> 7289</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l07290"></a><span class="lineno"> 7290</span>&#160;</div>
<div class="line"><a name="l07291"></a><span class="lineno"> 7291</span>&#160;</div>
<div class="line"><a name="l07292"></a><span class="lineno"> 7292</span>&#160;          <span class="comment">// only do post-newton checks if checking convergence allowed</span></div>
<div class="line"><a name="l07293"></a><span class="lineno"> 7293</span>&#160;          <span class="keywordflow">if</span>(checkconv==1){</div>
<div class="line"><a name="l07294"></a><span class="lineno"> 7294</span>&#160;</div>
<div class="line"><a name="l07295"></a><span class="lineno"> 7295</span>&#160;</div>
<div class="line"><a name="l07296"></a><span class="lineno"> 7296</span>&#160;</div>
<div class="line"><a name="l07298"></a><span class="lineno"> 7298</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l07299"></a><span class="lineno"> 7299</span>&#160;            <span class="comment">// check if u_g&lt;0 too often and know have entropy backup</span></div>
<div class="line"><a name="l07300"></a><span class="lineno"> 7300</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l07302"></a><span class="lineno"> 7302</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l07303"></a><span class="lineno"> 7303</span>&#160;            <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a7d3841c1f6026ab21196a7ee22a31957">IMPRADTYPEBASE</a>(*baseitermethod)){<span class="comment">//__WORKINGONIT__, might be too aggressive for PMHD method.</span></div>
<div class="line"><a name="l07304"></a><span class="lineno"> 7304</span>&#160;              <span class="comment">// abort if too often hit negative u_g or Erf and know have entropy backup method.</span></div>
<div class="line"><a name="l07305"></a><span class="lineno"> 7305</span>&#160;<span class="preprocessor">#define NUMUGNEGENERGY (3)</span></div>
<div class="line"><a name="l07306"></a><span class="lineno"> 7306</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l07307"></a><span class="lineno"> 7307</span>&#160;              <span class="keywordflow">if</span>(pp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]&lt;=10.0*<a class="code" href="../../d8/d5b/defs_8general_8h.html#a13f615d7832e3abc6abd54325112daf3">UUMINLIMIT</a> &amp;&amp; *baseitermethod!=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a7a5a1fd5a93591755aa3e1af2019dc57">QTYENTROPYPMHD</a> &amp;&amp; iter&gt;=mtd.<a class="code" href="../../d6/dbe/structof__method.html#a95212a0a740e95e0e2cc94cc9f4d0f7d">BEGINNORMALSTEPS</a>){</div>
<div class="line"><a name="l07308"></a><span class="lineno"> 7308</span>&#160;                countugnegative++;</div>
<div class="line"><a name="l07309"></a><span class="lineno"> 7309</span>&#160;              }</div>
<div class="line"><a name="l07310"></a><span class="lineno"> 7310</span>&#160;              <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l07311"></a><span class="lineno"> 7311</span>&#160;                <span class="comment">//            dualfprintf(fail_file,&quot;NOTNEG: countugnegative=%d\n&quot;,countugnegative);</span></div>
<div class="line"><a name="l07312"></a><span class="lineno"> 7312</span>&#160;              }</div>
<div class="line"><a name="l07313"></a><span class="lineno"> 7313</span>&#160;</div>
<div class="line"><a name="l07314"></a><span class="lineno"> 7314</span>&#160;              <span class="keywordflow">if</span>(countugnegative&gt;=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a1142b7e9244e41cca238e34d7b82c351">NUMUGNEGENERGY</a> &amp;&amp; eomcond &amp;&amp; (modemethodlocal==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aef33cf4e6c2534137907bc2eaefdb224">MODEPICKBEST</a> || modemethodlocal==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a861070760a7e713342da86a4c8bfa660">MODEPICKBESTSIMPLE</a>  || modemethodlocal==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a4a773e56e52c24230ab87c41877f241e">MODEPICKBESTSIMPLE2</a>) &amp;&amp; iter&gt;=mtd.<a class="code" href="../../d6/dbe/structof__method.html#a95212a0a740e95e0e2cc94cc9f4d0f7d">BEGINNORMALSTEPS</a>){</div>
<div class="line"><a name="l07315"></a><span class="lineno"> 7315</span>&#160;                <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a11a23c165eeac58d97d409da3de53e0a" title="need to do final check since get f1 and then do step.">DOFINALCHECK</a>){</div>
<div class="line"><a name="l07316"></a><span class="lineno"> 7316</span>&#160;                  <span class="keywordflow">if</span>(debugfail&gt;=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a63410994d900c1c05481efc828361b3b">DEBUGLEVELIMPSOLVER</a>) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;2Unable to hold off u_g&lt;0, setting canbreak=1 and letting finalchecks confirm error is good or bad.  iter=%d\n&quot;</span>,iter);</div>
<div class="line"><a name="l07317"></a><span class="lineno"> 7317</span>&#160;                  canbreak=5; <span class="comment">// just break since might be good (or at least allowable) error still.  Let final error check handle this.</span></div>
<div class="line"><a name="l07318"></a><span class="lineno"> 7318</span>&#160;                  <span class="comment">// not fail.</span></div>
<div class="line"><a name="l07319"></a><span class="lineno"> 7319</span>&#160;                  mathfailtype=89;</div>
<div class="line"><a name="l07320"></a><span class="lineno"> 7320</span>&#160;                  <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l07321"></a><span class="lineno"> 7321</span>&#160;                }</div>
<div class="line"><a name="l07322"></a><span class="lineno"> 7322</span>&#160;                <span class="keywordflow">else</span> <span class="keywordflow">if</span>(havebackup){</div>
<div class="line"><a name="l07323"></a><span class="lineno"> 7323</span>&#160;                  failreturn=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a42e7e780e89073f5d14dfafda3bae62e">FAILRETURNMODESWITCH</a>; mathfailtype=90;</div>
<div class="line"><a name="l07324"></a><span class="lineno"> 7324</span>&#160;                  <span class="keywordflow">if</span>(debugfail&gt;=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a969edf608c4953dd7b4b34e99dbc686c">DEBUGLEVELIMPSOLVERMORE</a>) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;2SWITCHING MODE: Detected bad u_g\n&quot;</span>);</div>
<div class="line"><a name="l07325"></a><span class="lineno"> 7325</span>&#160;                  <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l07326"></a><span class="lineno"> 7326</span>&#160;                }</div>
<div class="line"><a name="l07327"></a><span class="lineno"> 7327</span>&#160;                <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l07328"></a><span class="lineno"> 7328</span>&#160;                  <span class="comment">// then full failure</span></div>
<div class="line"><a name="l07329"></a><span class="lineno"> 7329</span>&#160;                  failreturn=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab0abd953f677a44020dc50259c410486">FAILRETURNGENERAL</a>; mathfailtype=10;</div>
<div class="line"><a name="l07330"></a><span class="lineno"> 7330</span>&#160;                  <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l07331"></a><span class="lineno"> 7331</span>&#160;                }</div>
<div class="line"><a name="l07332"></a><span class="lineno"> 7332</span>&#160;              }</div>
<div class="line"><a name="l07333"></a><span class="lineno"> 7333</span>&#160;            }</div>
<div class="line"><a name="l07334"></a><span class="lineno"> 7334</span>&#160;</div>
<div class="line"><a name="l07335"></a><span class="lineno"> 7335</span>&#160;</div>
<div class="line"><a name="l07336"></a><span class="lineno"> 7336</span>&#160;</div>
<div class="line"><a name="l07337"></a><span class="lineno"> 7337</span>&#160;</div>
<div class="line"><a name="l07338"></a><span class="lineno"> 7338</span>&#160;</div>
<div class="line"><a name="l07339"></a><span class="lineno"> 7339</span>&#160;</div>
<div class="line"><a name="l07340"></a><span class="lineno"> 7340</span>&#160;            <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> f3[NPR]={0},f3norm[NPR]={0};</div>
<div class="line"><a name="l07341"></a><span class="lineno"> 7341</span>&#160;            <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ae63207aeebd9e61dd18e446352b8197c" title="whether to check pp-ppp 1: directly check post pp-ppp relative error and see if changes by LOCALPREIM...">POSTNEWTONCONVCHECK</a>==1 &amp;&amp; notholding==1){</div>
<div class="line"><a name="l07342"></a><span class="lineno"> 7342</span>&#160;              <span class="keywordtype">int</span> dimtypef3;</div>
<div class="line"><a name="l07344"></a><span class="lineno"> 7344</span>&#160;              <span class="comment">//</span></div>
<div class="line"><a name="l07345"></a><span class="lineno"> 7345</span>&#160;              <span class="comment">// test convergence after Newton step</span></div>
<div class="line"><a name="l07346"></a><span class="lineno"> 7346</span>&#160;              <span class="comment">// test convergence using |dU/U|</span></div>
<div class="line"><a name="l07347"></a><span class="lineno"> 7347</span>&#160;              <span class="comment">// KORALTODO: This isn&#39;t a completely general error check since force might be large for fluid.  So using (e.g.) 1E-6 might still imply a ~1 or larger error for the fluid.  Only down to ~NUMEPSILON will radiation 4-force be unresolved as fluid source term.</span></div>
<div class="line"><a name="l07348"></a><span class="lineno"> 7348</span>&#160;              <span class="comment">// NOTE: Have to be careful with decreasing DAMPFACTOR or fracdtuu0 because can become small enough that apparently fake convergence with below condition, so only check for convergence if all DAMPs are 1.0.</span></div>
<div class="line"><a name="l07350"></a><span class="lineno"> 7350</span>&#160;<span class="comment"></span>              <span class="comment">// 0 = conserved R^t_\nu type, 1 = primitive R^{ti} type</span></div>
<div class="line"><a name="l07351"></a><span class="lineno"> 7351</span>&#160;              <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a54453e145c6408911f60070de366b11a">IMPUTYPE</a>(mtd.<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>)){ <span class="comment">// still considering iterate error</span></div>
<div class="line"><a name="l07352"></a><span class="lineno"> 7352</span>&#160;                dimtypef3=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a6c45d4170066340923e6ec67e05436f4">DIMTYPEFCONS</a>;</div>
<div class="line"><a name="l07353"></a><span class="lineno"> 7353</span>&#160;                <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad362268c94979b8c041e986c54f7f59e">JACLOOPALT</a>(ii,ru.<a class="code" href="../../d2/d46/structof__ref_u.html#a9f3d856dcdd8fa240dfbdcedfad888ef">startjac</a>,ru.<a class="code" href="../../d2/d46/structof__ref_u.html#af67164c1a42e2aefe0603597dd2ea25e">endjac</a>){</div>
<div class="line"><a name="l07354"></a><span class="lineno"> 7354</span>&#160;                  f3[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[ii]]=(uu[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[ii]]-uup[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[ii]]);</div>
<div class="line"><a name="l07355"></a><span class="lineno"> 7355</span>&#160;                  f3norm[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[ii]]=fabs(uu[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[ii]])+fabs(uup[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[ii]]);</div>
<div class="line"><a name="l07356"></a><span class="lineno"> 7356</span>&#160;                }</div>
<div class="line"><a name="l07357"></a><span class="lineno"> 7357</span>&#160;              }</div>
<div class="line"><a name="l07358"></a><span class="lineno"> 7358</span>&#160;              <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a003b3a1fbd946c173da7ba3c6312e8e1" title="P or U types.">IMPPTYPE</a>(mtd.<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>)){ <span class="comment">// still considering iterate error</span></div>
<div class="line"><a name="l07359"></a><span class="lineno"> 7359</span>&#160;                dimtypef3=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab02ce49b9873ae6d9b33d05f1a675f0b">DIMTYPEFPRIM</a>;</div>
<div class="line"><a name="l07360"></a><span class="lineno"> 7360</span>&#160;                <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad362268c94979b8c041e986c54f7f59e">JACLOOPALT</a>(ii,ru.<a class="code" href="../../d2/d46/structof__ref_u.html#a9f3d856dcdd8fa240dfbdcedfad888ef">startjac</a>,ru.<a class="code" href="../../d2/d46/structof__ref_u.html#af67164c1a42e2aefe0603597dd2ea25e">endjac</a>){</div>
<div class="line"><a name="l07361"></a><span class="lineno"> 7361</span>&#160;                  f3[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[ii]]=(pp[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[ii]]-ppp[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[ii]]);</div>
<div class="line"><a name="l07362"></a><span class="lineno"> 7362</span>&#160;                  f3norm[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[ii]]=fabs(pp[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[ii]])+fabs(ppp[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[ii]]);</div>
<div class="line"><a name="l07363"></a><span class="lineno"> 7363</span>&#160;                }</div>
<div class="line"><a name="l07364"></a><span class="lineno"> 7364</span>&#160;              }</div>
<div class="line"><a name="l07365"></a><span class="lineno"> 7365</span>&#160;  </div>
<div class="line"><a name="l07366"></a><span class="lineno"> 7366</span>&#160;              <span class="comment">// store error and solution in case eventually lead to max iterations and actually get worse error</span></div>
<div class="line"><a name="l07367"></a><span class="lineno"> 7367</span>&#160;              <span class="comment">// f_error_check(uu0,uu) is ok to use since it just normalizes error</span></div>
<div class="line"><a name="l07368"></a><span class="lineno"> 7368</span>&#160;              <span class="keywordtype">int</span> convreturnf3;</div>
<div class="line"><a name="l07369"></a><span class="lineno"> 7369</span>&#160;              <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> errorallabsf3; <span class="comment">// not used</span></div>
<div class="line"><a name="l07370"></a><span class="lineno"> 7370</span>&#160;              convreturnf3=f_error_check(showmessages, showmessagesheavy, iter, trueimptryconv, trueimptryconvabs, realdt, dimtypef3,eomtypelocal ,*radinvmod, itermode,*baseitermethod,fracenergy,dissmeasure,dimfactU,pp,piin,f3,f3norm,f3report,Uiin,uu0,uu,ptrgeom,&amp;errorabsf3,&amp;errorallabsf3,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>,&amp;mtd,&amp;ru);</div>
<div class="line"><a name="l07371"></a><span class="lineno"> 7371</span>&#160;              <span class="comment">// while using f1 for true error, can&#39;t do better if f3 error is below near machine precision.</span></div>
<div class="line"><a name="l07372"></a><span class="lineno"> 7372</span>&#160;              convreturnf3limit=(errorabsf3&lt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a2e77bdd514904b3194b3ceefe200cec3">LOCALPREIMPCONVXABS</a>);</div>
<div class="line"><a name="l07373"></a><span class="lineno"> 7373</span>&#160;            }</div>
<div class="line"><a name="l07374"></a><span class="lineno"> 7374</span>&#160;</div>
<div class="line"><a name="l07375"></a><span class="lineno"> 7375</span>&#160;            <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ae63207aeebd9e61dd18e446352b8197c" title="whether to check pp-ppp 1: directly check post pp-ppp relative error and see if changes by LOCALPREIM...">POSTNEWTONCONVCHECK</a>==0 || notholding==0){</div>
<div class="line"><a name="l07376"></a><span class="lineno"> 7376</span>&#160;              convreturnf3limit=0;</div>
<div class="line"><a name="l07377"></a><span class="lineno"> 7377</span>&#160;            }</div>
<div class="line"><a name="l07378"></a><span class="lineno"> 7378</span>&#160;</div>
<div class="line"><a name="l07379"></a><span class="lineno"> 7379</span>&#160;</div>
<div class="line"><a name="l07380"></a><span class="lineno"> 7380</span>&#160;</div>
<div class="line"><a name="l07382"></a><span class="lineno"> 7382</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l07383"></a><span class="lineno"> 7383</span>&#160;            <span class="comment">// check convergence</span></div>
<div class="line"><a name="l07384"></a><span class="lineno"> 7384</span>&#160;            <span class="comment">// then can check convergence: using f1 and f3limit</span></div>
<div class="line"><a name="l07385"></a><span class="lineno"> 7385</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l07387"></a><span class="lineno"> 7387</span>&#160;<span class="comment"></span>            <span class="keywordflow">if</span>(convreturnf1 || convreturnf3limit || canbreak){</div>
<div class="line"><a name="l07388"></a><span class="lineno"> 7388</span>&#160;<span class="preprocessor">#if(PRODUCTION==0)</span></div>
<div class="line"><a name="l07389"></a><span class="lineno"> 7389</span>&#160;<span class="preprocessor"></span>              <span class="keywordflow">if</span>(debugfail&gt;=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a969edf608c4953dd7b4b34e99dbc686c">DEBUGLEVELIMPSOLVERMORE</a>){</div>
<div class="line"><a name="l07390"></a><span class="lineno"> 7390</span>&#160;                <span class="keywordflow">if</span>(convreturnf3limit &amp;&amp; debugfail&gt;=3){</div>
<div class="line"><a name="l07391"></a><span class="lineno"> 7391</span>&#160;                  dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;f3limit good\n&quot;</span>);</div>
<div class="line"><a name="l07392"></a><span class="lineno"> 7392</span>&#160;                  <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ae63207aeebd9e61dd18e446352b8197c" title="whether to check pp-ppp 1: directly check post pp-ppp relative error and see if changes by LOCALPREIM...">POSTNEWTONCONVCHECK</a>==1) <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad362268c94979b8c041e986c54f7f59e">JACLOOPALT</a>(ii,ru.<a class="code" href="../../d2/d46/structof__ref_u.html#a9f3d856dcdd8fa240dfbdcedfad888ef">startjac</a>,ru.<a class="code" href="../../d2/d46/structof__ref_u.html#af67164c1a42e2aefe0603597dd2ea25e">endjac</a>) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;ii=%d erefU[ii]=%d f3=%21.15g f3norm=%21.15g f3report=%21.15g\n&quot;</span>,ii,ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[ii],f3[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[ii]],f3norm[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[ii]],f3report[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[ii]]);          </div>
<div class="line"><a name="l07393"></a><span class="lineno"> 7393</span>&#160;                }</div>
<div class="line"><a name="l07394"></a><span class="lineno"> 7394</span>&#160;                <span class="keywordflow">if</span>(convreturnf1) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;f1 good: ijknstepsteppart=%d %d %d %ld %d\n&quot;</span>,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a1a1088d87617078680f1fd0f0d707384">nstep</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a70170b90229f9fc05eebf8508a685c70">steppart</a>);</div>
<div class="line"><a name="l07395"></a><span class="lineno"> 7395</span>&#160;                <span class="keywordflow">if</span>(convreturnf3limit) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;f3 good: ijknstepsteppart=%d %d %d %ld %d\n&quot;</span>,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a1a1088d87617078680f1fd0f0d707384">nstep</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a70170b90229f9fc05eebf8508a685c70">steppart</a>);</div>
<div class="line"><a name="l07396"></a><span class="lineno"> 7396</span>&#160;                <span class="keywordflow">if</span>(canbreak) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;canbreak=%d good: ijknstepsteppart=%d %d %d %ld %d\n&quot;</span>,canbreak,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a1a1088d87617078680f1fd0f0d707384">nstep</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a70170b90229f9fc05eebf8508a685c70">steppart</a>);</div>
<div class="line"><a name="l07397"></a><span class="lineno"> 7397</span>&#160;              }</div>
<div class="line"><a name="l07398"></a><span class="lineno"> 7398</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l07399"></a><span class="lineno"> 7399</span>&#160;<span class="preprocessor"></span>              <span class="comment">// so done.</span></div>
<div class="line"><a name="l07400"></a><span class="lineno"> 7400</span>&#160;              <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l07401"></a><span class="lineno"> 7401</span>&#160;            }</div>
<div class="line"><a name="l07402"></a><span class="lineno"> 7402</span>&#160;            <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l07403"></a><span class="lineno"> 7403</span>&#160;              <span class="comment">// then not done</span></div>
<div class="line"><a name="l07404"></a><span class="lineno"> 7404</span>&#160;            }</div>
<div class="line"><a name="l07405"></a><span class="lineno"> 7405</span>&#160;</div>
<div class="line"><a name="l07406"></a><span class="lineno"> 7406</span>&#160;          } <span class="comment">// end if checkconv==1</span></div>
<div class="line"><a name="l07407"></a><span class="lineno"> 7407</span>&#160;</div>
<div class="line"><a name="l07408"></a><span class="lineno"> 7408</span>&#160;<span class="preprocessor">#if(DOPERF)</span></div>
<div class="line"><a name="l07409"></a><span class="lineno"> 7409</span>&#160;<span class="preprocessor"></span>          <span class="comment">// only try low error if not too many iterations, otherwise drop trying quite as hard.</span></div>
<div class="line"><a name="l07410"></a><span class="lineno"> 7410</span>&#160;          <span class="keywordflow">if</span>(iter&gt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a0cea9304b0ed59b809486aae51f7bae4">ITERATIONMARGINAL2</a> &amp;&amp; (errorabsf1[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>]&lt;<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(trueimpallowconvabs,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a14a313e984d9d1e9a7cc3a4cf0ada803">IMPTRYCONVMARGINAL2</a>) ) ){</div>
<div class="line"><a name="l07411"></a><span class="lineno"> 7411</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l07412"></a><span class="lineno"> 7412</span>&#160;          }</div>
<div class="line"><a name="l07413"></a><span class="lineno"> 7413</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l07414"></a><span class="lineno"> 7414</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l07415"></a><span class="lineno"> 7415</span>&#160;        }<span class="comment">// end if finite</span></div>
<div class="line"><a name="l07416"></a><span class="lineno"> 7416</span>&#160;</div>
<div class="line"><a name="l07417"></a><span class="lineno"> 7417</span>&#160;</div>
<div class="line"><a name="l07418"></a><span class="lineno"> 7418</span>&#160;</div>
<div class="line"><a name="l07419"></a><span class="lineno"> 7419</span>&#160;</div>
<div class="line"><a name="l07420"></a><span class="lineno"> 7420</span>&#160;</div>
<div class="line"><a name="l07421"></a><span class="lineno"> 7421</span>&#160;</div>
<div class="line"><a name="l07423"></a><span class="lineno"> 7423</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l07424"></a><span class="lineno"> 7424</span>&#160;        <span class="comment">// revert any back-ups if ok to do so</span></div>
<div class="line"><a name="l07425"></a><span class="lineno"> 7425</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l07426"></a><span class="lineno"> 7426</span>&#160;        <span class="comment">// NOTEMARK: Can only modify uu0 or frac&#39;s after they are used consistently to get f1, iJ, take step, and check convergence with error function</span></div>
<div class="line"><a name="l07427"></a><span class="lineno"> 7427</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l07429"></a><span class="lineno"> 7429</span>&#160;<span class="comment"></span>        changeotherdt=1;</div>
<div class="line"><a name="l07431"></a><span class="lineno"> 7431</span>&#160;        <span class="comment">//    if(fracuup!=1.0){</span></div>
<div class="line"><a name="l07432"></a><span class="lineno"> 7432</span>&#160;        <span class="comment">//      if(fabs(fracuup-1.0)&gt;10.0*NUMEPSILON){</span></div>
<div class="line"><a name="l07433"></a><span class="lineno"> 7433</span>&#160;        <span class="keywordflow">if</span>(fracuup&lt;1.0){</div>
<div class="line"><a name="l07434"></a><span class="lineno"> 7434</span>&#160;          <span class="comment">// try increasing amount of uu or pp used</span></div>
<div class="line"><a name="l07435"></a><span class="lineno"> 7435</span>&#160;          fracuup*=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab991e76a81e787d737c9f1b755798ce9">RADDAMPUNDELTA</a>;</div>
<div class="line"><a name="l07436"></a><span class="lineno"> 7436</span>&#160;          fracuup=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(1.0,fracuup);</div>
<div class="line"><a name="l07437"></a><span class="lineno"> 7437</span>&#160;          changeotherdt=0; <span class="comment">// ensure fracuup back to 1.0 first before reverting others.</span></div>
<div class="line"><a name="l07438"></a><span class="lineno"> 7438</span>&#160;        }</div>
<div class="line"><a name="l07440"></a><span class="lineno"> 7440</span>&#160;        <span class="comment">//    if(fracdtuu0!=1.0){</span></div>
<div class="line"><a name="l07441"></a><span class="lineno"> 7441</span>&#160;        <span class="comment">//      if(fabs(fracdtuu0-1.0)&gt;10.0*NUMEPSILON &amp;&amp; changeotherdt){</span></div>
<div class="line"><a name="l07442"></a><span class="lineno"> 7442</span>&#160;        <span class="keywordflow">if</span>(fracdtuu0&lt;1.0 &amp;&amp; changeotherdt){</div>
<div class="line"><a name="l07443"></a><span class="lineno"> 7443</span>&#160;          <span class="comment">// try increasing uu0 away from Uiin to account for full dUother</span></div>
<div class="line"><a name="l07444"></a><span class="lineno"> 7444</span>&#160;          fracdtuu0*=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab991e76a81e787d737c9f1b755798ce9">RADDAMPUNDELTA</a>;</div>
<div class="line"><a name="l07445"></a><span class="lineno"> 7445</span>&#160;          fracdtuu0=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(1.0,fracdtuu0);</div>
<div class="line"><a name="l07446"></a><span class="lineno"> 7446</span>&#160;          <span class="comment">//        FTYPE dUnongeomall[MAXTIMEORDER]={0.0};</span></div>
<div class="line"><a name="l07447"></a><span class="lineno"> 7447</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) uu0[pl]=UFSET(CUf,fracdtuu0*dt,Uiin[pl],Ufin[pl],dUother[pl],0.0,dUnongeomall); <span class="comment">// modifies uu0</span></div>
<div class="line"><a name="l07448"></a><span class="lineno"> 7448</span>&#160;          {</div>
<div class="line"><a name="l07449"></a><span class="lineno"> 7449</span>&#160;            <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> uuiterback[NPR];</div>
<div class="line"><a name="l07450"></a><span class="lineno"> 7450</span>&#160;            <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) uuiterback[pl] = uu[pl]; <span class="comment">// hold actual iterated quantities</span></div>
<div class="line"><a name="l07451"></a><span class="lineno"> 7451</span>&#160;            <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) uu[pl] = uu0[pl]; <span class="comment">// &quot;iterate&quot; non-iterated quantities</span></div>
<div class="line"><a name="l07452"></a><span class="lineno"> 7452</span>&#160;            <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a33e29fbc91c598484cbeb76769ce1fd2">JACLOOP</a>(ii,ru.<a class="code" href="../../d2/d46/structof__ref_u.html#a9f3d856dcdd8fa240dfbdcedfad888ef">startjac</a>,ru.<a class="code" href="../../d2/d46/structof__ref_u.html#af67164c1a42e2aefe0603597dd2ea25e">endjac</a>) uu[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[ii]] = uuiterback[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[ii]]; <span class="comment">// overwrite with actual previous step for iterated quantities</span></div>
<div class="line"><a name="l07453"></a><span class="lineno"> 7453</span>&#160;          }</div>
<div class="line"><a name="l07454"></a><span class="lineno"> 7454</span>&#160;          <span class="comment">// KORALNOTE: No need to get pp0, since never used.  uu0 only used in error function.</span></div>
<div class="line"><a name="l07455"></a><span class="lineno"> 7455</span>&#160;        }</div>
<div class="line"><a name="l07457"></a><span class="lineno"> 7457</span>&#160;        <span class="comment">//    if(fracdtG!=1.0){</span></div>
<div class="line"><a name="l07458"></a><span class="lineno"> 7458</span>&#160;        <span class="comment">//      if(fabs(fracdtG-1.0)&gt;10.0*NUMEPSILON &amp;&amp; changeotherdt){</span></div>
<div class="line"><a name="l07459"></a><span class="lineno"> 7459</span>&#160;        <span class="keywordflow">if</span>(fracdtG&lt;1.0 &amp;&amp; changeotherdt){</div>
<div class="line"><a name="l07460"></a><span class="lineno"> 7460</span>&#160;          <span class="comment">// try increasing amount of G applied</span></div>
<div class="line"><a name="l07461"></a><span class="lineno"> 7461</span>&#160;          fracdtG*=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab991e76a81e787d737c9f1b755798ce9">RADDAMPUNDELTA</a>;</div>
<div class="line"><a name="l07462"></a><span class="lineno"> 7462</span>&#160;          fracdtG=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(1.0,fracdtG);</div>
<div class="line"><a name="l07463"></a><span class="lineno"> 7463</span>&#160;        }      </div>
<div class="line"><a name="l07464"></a><span class="lineno"> 7464</span>&#160;</div>
<div class="line"><a name="l07465"></a><span class="lineno"> 7465</span>&#160;</div>
<div class="line"><a name="l07467"></a><span class="lineno"> 7467</span>&#160;        <span class="comment">// see if took too many Newton steps or not finite results</span></div>
<div class="line"><a name="l07469"></a><span class="lineno"> 7469</span>&#160;<span class="comment"></span>        *nummhdstepsreturn = (int)(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a5f1c4a4bf07f7a6010404484cb9e6b50">nstroke</a>-nstrokeorig); <span class="comment">// get number of mhd inversion steps</span></div>
<div class="line"><a name="l07470"></a><span class="lineno"> 7470</span>&#160;        <span class="keywordflow">if</span>(iter&gt;trueimpmaxiter || *nummhdstepsreturn&gt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a55a6521d140538925946aeb79da33b5b">MAXMHDSTEPS</a> || notfinite ){</div>
<div class="line"><a name="l07471"></a><span class="lineno"> 7471</span>&#160;          <span class="keywordflow">if</span>(debugfail&gt;=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a969edf608c4953dd7b4b34e99dbc686c">DEBUGLEVELIMPSOLVERMORE</a>) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;iter=%d&gt;%d mhdsteps=%d&gt;%d or notfinite=%d\n&quot;</span>,iter,trueimpmaxiter,*nummhdstepsreturn,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a55a6521d140538925946aeb79da33b5b">MAXMHDSTEPS</a>,notfinite);</div>
<div class="line"><a name="l07472"></a><span class="lineno"> 7472</span>&#160;          <span class="comment">//      failreturn=FAILRETURNGENERAL; // no don&#39;t fail, might be allowable error.</span></div>
<div class="line"><a name="l07473"></a><span class="lineno"> 7473</span>&#160;          <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l07474"></a><span class="lineno"> 7474</span>&#160;        }</div>
<div class="line"><a name="l07475"></a><span class="lineno"> 7475</span>&#160;</div>
<div class="line"><a name="l07476"></a><span class="lineno"> 7476</span>&#160;      }<span class="comment">// end do</span></div>
<div class="line"><a name="l07477"></a><span class="lineno"> 7477</span>&#160;      <span class="keywordflow">while</span>(1);</div>
<div class="line"><a name="l07478"></a><span class="lineno"> 7478</span>&#160;</div>
<div class="line"><a name="l07479"></a><span class="lineno"> 7479</span>&#160;</div>
<div class="line"><a name="l07480"></a><span class="lineno"> 7480</span>&#160;</div>
<div class="line"><a name="l07481"></a><span class="lineno"> 7481</span>&#160;</div>
<div class="line"><a name="l07482"></a><span class="lineno"> 7482</span>&#160;</div>
<div class="line"><a name="l07483"></a><span class="lineno"> 7483</span>&#160;</div>
<div class="line"><a name="l07484"></a><span class="lineno"> 7484</span>&#160;</div>
<div class="line"><a name="l07485"></a><span class="lineno"> 7485</span>&#160;</div>
<div class="line"><a name="l07487"></a><span class="lineno"> 7487</span>&#160;      <span class="comment">//</span></div>
<div class="line"><a name="l07488"></a><span class="lineno"> 7488</span>&#160;      <span class="comment">// once done iterating, regardless of result or failure, need to ensure non-iterated quantities are normal</span></div>
<div class="line"><a name="l07489"></a><span class="lineno"> 7489</span>&#160;      <span class="comment">//</span></div>
<div class="line"><a name="l07491"></a><span class="lineno"> 7491</span>&#160;<span class="comment"></span>      fracdtuu0=1.0;</div>
<div class="line"><a name="l07492"></a><span class="lineno"> 7492</span>&#160;      <span class="comment">//</span></div>
<div class="line"><a name="l07493"></a><span class="lineno"> 7493</span>&#160;      <span class="comment">//    FTYPE dUnongeomall[MAXTIMEORDER]={0.0};</span></div>
<div class="line"><a name="l07494"></a><span class="lineno"> 7494</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) uu0[pl]=UFSET(CUf,fracdtuu0*dt,Uiin[pl],Ufin[pl],dUother[pl],0.0,dUnongeomall); <span class="comment">// modifies uu0</span></div>
<div class="line"><a name="l07495"></a><span class="lineno"> 7495</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l07496"></a><span class="lineno"> 7496</span>&#160;        <span class="keywordflow">if</span>(!(pl&gt;=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a> &amp;&amp; pl&lt;=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8de9104f1fffa59f057b214d74c5cfea">U3</a> || <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a385beb27e1712b12184404ccdceb9fbe">RADPL</a>(pl) || pl==ENTROPY)){</div>
<div class="line"><a name="l07497"></a><span class="lineno"> 7497</span>&#160;          uu[pl] = uu0[pl];</div>
<div class="line"><a name="l07498"></a><span class="lineno"> 7498</span>&#160;        }</div>
<div class="line"><a name="l07499"></a><span class="lineno"> 7499</span>&#160;      }</div>
<div class="line"><a name="l07500"></a><span class="lineno"> 7500</span>&#160;      <span class="comment">// regardless, invert non-iterated quantities</span></div>
<div class="line"><a name="l07501"></a><span class="lineno"> 7501</span>&#160;      <span class="comment">// 1) trivially invert field</span></div>
<div class="line"><a name="l07502"></a><span class="lineno"> 7502</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a9afde1f1647e18e733406a1566b8b550">PLOOPBONLY</a>(pl) bestpp[pl]=bestuu[pl]=pp[pl] = uu0[pl];</div>
<div class="line"><a name="l07503"></a><span class="lineno"> 7503</span>&#160;      <span class="comment">// 2) trivially invert to get rho assuming q up-to-date</span></div>
<div class="line"><a name="l07504"></a><span class="lineno"> 7504</span>&#160;      <span class="comment">//    pp[RHO]= uu0[RHO]/q-&gt;ucon[TT]; // q might not be up-to-date</span></div>
<div class="line"><a name="l07505"></a><span class="lineno"> 7505</span>&#160;      <span class="comment">// 3) Invert other scalars (only uses uu[RHO], not pp[RHO])</span></div>
<div class="line"><a name="l07506"></a><span class="lineno"> 7506</span>&#160;      <span class="keyword">extern</span> <span class="keywordtype">int</span> <a class="code" href="../../d1/d3e/utoprimgen_8c.html#abfc42de6975dd4ff02f2748404e10911" title="perform U-&gt;p inversion on advected scalars">invert_scalars1</a>(<span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ugeomfree, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr);</div>
<div class="line"><a name="l07507"></a><span class="lineno"> 7507</span>&#160;      <a class="code" href="../../d1/d3e/utoprimgen_8c.html#abfc42de6975dd4ff02f2748404e10911" title="perform U-&gt;p inversion on advected scalars">invert_scalars1</a>(ptrgeom, uu,pp);</div>
<div class="line"><a name="l07508"></a><span class="lineno"> 7508</span>&#160;      <span class="keyword">extern</span> <span class="keywordtype">int</span> <a class="code" href="../../d1/d3e/utoprimgen_8c.html#a1118806d01e553c38ae5cf5f036f9f2e" title="perform U-&gt;p inversion on advected scalars">invert_scalars2</a>(<span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ugeomfree, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *q, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr);</div>
<div class="line"><a name="l07509"></a><span class="lineno"> 7509</span>&#160;      <a class="code" href="../../d1/d3e/utoprimgen_8c.html#a1118806d01e553c38ae5cf5f036f9f2e" title="perform U-&gt;p inversion on advected scalars">invert_scalars2</a>(ptrgeom, uu, q, pp);</div>
<div class="line"><a name="l07510"></a><span class="lineno"> 7510</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l07511"></a><span class="lineno"> 7511</span>&#160;        <span class="keywordflow">if</span>(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ad50f2824bc8460c8e155508477b7f31e">SCALARPL</a>(pl)){</div>
<div class="line"><a name="l07512"></a><span class="lineno"> 7512</span>&#160;          bestpp[pl]=pp[pl];</div>
<div class="line"><a name="l07513"></a><span class="lineno"> 7513</span>&#160;          bestuu[pl]=uu[pl];</div>
<div class="line"><a name="l07514"></a><span class="lineno"> 7514</span>&#160;        }</div>
<div class="line"><a name="l07515"></a><span class="lineno"> 7515</span>&#160;      }</div>
<div class="line"><a name="l07516"></a><span class="lineno"> 7516</span>&#160;      <span class="comment">//</span></div>
<div class="line"><a name="l07517"></a><span class="lineno"> 7517</span>&#160;      <span class="comment">// end trivial inversion</span></div>
<div class="line"><a name="l07518"></a><span class="lineno"> 7518</span>&#160;      <span class="comment">//</span></div>
<div class="line"><a name="l07520"></a><span class="lineno"> 7520</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l07521"></a><span class="lineno"> 7521</span>&#160;  </div>
<div class="line"><a name="l07522"></a><span class="lineno"> 7522</span>&#160;</div>
<div class="line"><a name="l07523"></a><span class="lineno"> 7523</span>&#160;</div>
<div class="line"><a name="l07525"></a><span class="lineno"> 7525</span>&#160;      <span class="comment">//</span></div>
<div class="line"><a name="l07526"></a><span class="lineno"> 7526</span>&#160;      <span class="comment">// if no failure, then see if really still failed or not with some final checks.</span></div>
<div class="line"><a name="l07527"></a><span class="lineno"> 7527</span>&#160;      <span class="comment">//</span></div>
<div class="line"><a name="l07529"></a><span class="lineno"> 7529</span>&#160;<span class="comment"></span>      <span class="keywordtype">int</span> failreturnf=0;</div>
<div class="line"><a name="l07530"></a><span class="lineno"> 7530</span>&#160;      <span class="comment">//    if(failreturn==0 &amp;&amp; (earlylowerror==0 &amp;&amp; lowitererror==0) ){</span></div>
<div class="line"><a name="l07531"></a><span class="lineno"> 7531</span>&#160;      <span class="keywordflow">if</span>(failreturn==0 &amp;&amp; earlylowerror==0){ <span class="comment">// still check if lowitererror==1 because might have best total error at another iter.</span></div>
<div class="line"><a name="l07532"></a><span class="lineno"> 7532</span>&#160;</div>
<div class="line"><a name="l07533"></a><span class="lineno"> 7533</span>&#160;</div>
<div class="line"><a name="l07534"></a><span class="lineno"> 7534</span>&#160;        <span class="comment">// if didn&#39;t fail, shouldn&#39;t need to set fracdtuu0=1, but do so just in caes.</span></div>
<div class="line"><a name="l07535"></a><span class="lineno"> 7535</span>&#160;        fracdtuu0=1.0;</div>
<div class="line"><a name="l07536"></a><span class="lineno"> 7536</span>&#160;</div>
<div class="line"><a name="l07537"></a><span class="lineno"> 7537</span>&#160;</div>
<div class="line"><a name="l07538"></a><span class="lineno"> 7538</span>&#160;        <span class="keywordtype">int</span> fakeiter;</div>
<div class="line"><a name="l07539"></a><span class="lineno"> 7539</span>&#160;        <span class="keywordflow">for</span>(fakeiter=0;fakeiter&lt;=0;fakeiter++){</div>
<div class="line"><a name="l07540"></a><span class="lineno"> 7540</span>&#160;</div>
<div class="line"><a name="l07541"></a><span class="lineno"> 7541</span>&#160;          <span class="keywordtype">int</span> convreturn=1,convreturnok=1,convreturnallow=1; <span class="comment">// default is solution is acceptable.</span></div>
<div class="line"><a name="l07542"></a><span class="lineno"> 7542</span>&#160;</div>
<div class="line"><a name="l07543"></a><span class="lineno"> 7543</span>&#160;</div>
<div class="line"><a name="l07544"></a><span class="lineno"> 7544</span>&#160;          <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a11a23c165eeac58d97d409da3de53e0a" title="need to do final check since get f1 and then do step.">DOFINALCHECK</a>){</div>
<div class="line"><a name="l07546"></a><span class="lineno"> 7546</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l07547"></a><span class="lineno"> 7547</span>&#160;            <span class="comment">// check and get error for last iteration or any mods from above that are post-iteration</span></div>
<div class="line"><a name="l07548"></a><span class="lineno"> 7548</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l07549"></a><span class="lineno"> 7549</span>&#160;            <span class="comment">// uses final uu0 with fracdtuu0=1 to ensure really updated non-iterated quantities correctly</span></div>
<div class="line"><a name="l07550"></a><span class="lineno"> 7550</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l07551"></a><span class="lineno"> 7551</span>&#160;            <span class="comment">// The call to f_implicit() also ensures uu is consistent with new pp</span></div>
<div class="line"><a name="l07552"></a><span class="lineno"> 7552</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l07554"></a><span class="lineno"> 7554</span>&#160;<span class="comment"></span>            <span class="keywordtype">int</span> whichcall=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aed44d99ba064f5db1486676c305f80e2">FIMPLICITCALLTYPEFINALCHECK</a>;</div>
<div class="line"><a name="l07555"></a><span class="lineno"> 7555</span>&#160;            <span class="comment">//  eomtypelocal=*eomtype; // re-chose default each time. No, stick with what f1 (last call to f1) chose</span></div>
<div class="line"><a name="l07556"></a><span class="lineno"> 7556</span>&#160;            <span class="keywordtype">int</span> goexplicitfake; <span class="comment">// not used here</span></div>
<div class="line"><a name="l07557"></a><span class="lineno"> 7557</span>&#160;            <span class="keywordtype">int</span> dimtypef=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a6c45d4170066340923e6ec67e05436f4">DIMTYPEFCONS</a>; <span class="comment">// 0 = conserved R^t_\nu type, 1 = primitive (u,v^i) type, i.e. v^i has no energy density term</span></div>
<div class="line"><a name="l07558"></a><span class="lineno"> 7558</span>&#160;            <span class="keywordtype">int</span> fakef1iter=-1;</div>
<div class="line"><a name="l07559"></a><span class="lineno"> 7559</span>&#160;            failreturnf=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#af46d2b1cf89a70a7e2ef503146c649a9" title="uu0 - original cons.">f_implicit</a>(allowbaseitermethodswitch, iter,fakef1iter,failreturnallowableuse, whichcall,impepsjac,showmessages, showmessagesheavy, allowlocalfailurefixandnoreport, &amp;eomtypelocal, whichcap, itermode, baseitermethod, fracenergy, dissmeasure, radinvmod, trueimptryconv, trueimptryconvabs, trueimpallowconvabs, trueimpmaxiter, realdt, dimtypef, dimfactU, pp, pp, piin, uu, Uiin, uu0, uu, fracdtG*realdt, ptrgeom, q, f1, f1norm, f1report, &amp;goexplicitfake, &amp;errorabsf1[0], &amp;errorabsf1[1], <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>, &amp;convreturn, nummhdinvsreturn, &amp;tautotmaxreturn, &amp;mtd, &amp;ru); <span class="comment">// modifies uu and pp and q and f1report and goexplicitfake and errorabsf1</span></div>
<div class="line"><a name="l07560"></a><span class="lineno"> 7560</span>&#160;            <span class="comment">// radinvmod contains whether radiative inversion modified process.</span></div>
<div class="line"><a name="l07561"></a><span class="lineno"> 7561</span>&#160;</div>
<div class="line"><a name="l07562"></a><span class="lineno"> 7562</span>&#160;            <span class="comment">//          convreturn=f_error_check(showmessages, showmessagesheavy, iter, trueimptryconv,trueimptryconvabs,realdt,dimtypef,eomtypelocal,*radinvmod, itermode,*baseitermethod,fracenergy,dissmeasure,dimfactU,pp,piin,f1,f1norm,f1report,Uiin,uu0,uu,ptrgeom,&amp;errorabsf1,WHICHERROR,&amp;mtd,&amp;ru);</span></div>
<div class="line"><a name="l07563"></a><span class="lineno"> 7563</span>&#160;            convreturnallow=(errorabsf1[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>]&lt;trueimpallowconvabs);</div>
<div class="line"><a name="l07564"></a><span class="lineno"> 7564</span>&#160;            convreturnok=(errorabsf1[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>]&lt;trueimpokconvabs);</div>
<div class="line"><a name="l07565"></a><span class="lineno"> 7565</span>&#160;            <span class="keywordflow">if</span>(debugfail&gt;=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a969edf608c4953dd7b4b34e99dbc686c">DEBUGLEVELIMPSOLVERMORE</a>) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;DOFINALCHECK: convreturn=%d convreturnok=%d convreturnallow=%d (IMPOKCONV=%g IMPALLOWCONV=%g) f1report: %g %g %g %g : %g %g\n&quot;</span>,convreturn,convreturnok,convreturnallow,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#af7b72bf07e905af920a80341cad3ec60">IMPOKCONV</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aed356d684bdfb542015fcc82d0b8e46f">IMPALLOWCONV</a>,f1report[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[0]],f1report[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[1]],f1report[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[2]],f1report[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[3]],errorabsf1[0],errorabsf1[1]);</div>
<div class="line"><a name="l07566"></a><span class="lineno"> 7566</span>&#160;          }<span class="comment">// end if doing final check</span></div>
<div class="line"><a name="l07567"></a><span class="lineno"> 7567</span>&#160;          <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l07568"></a><span class="lineno"> 7568</span>&#160;            <span class="comment">// kinda risky to rely upon last step but not checking its error</span></div>
<div class="line"><a name="l07569"></a><span class="lineno"> 7569</span>&#160;</div>
<div class="line"><a name="l07570"></a><span class="lineno"> 7570</span>&#160;            <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a003b3a1fbd946c173da7ba3c6312e8e1" title="P or U types.">IMPPTYPE</a>(mtd.<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>)){</div>
<div class="line"><a name="l07571"></a><span class="lineno"> 7571</span>&#160;              <span class="comment">// since iterated pp or uu but didn&#39;t call f_implicit(), uu or pp (respectively) is no longer consistent.</span></div>
<div class="line"><a name="l07572"></a><span class="lineno"> 7572</span>&#160;              <span class="comment">// So get uu(pp)</span></div>
<div class="line"><a name="l07573"></a><span class="lineno"> 7573</span>&#160;              <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> qcons;</div>
<div class="line"><a name="l07574"></a><span class="lineno"> 7574</span>&#160;              <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a11e17cd8b0594d1ad52e3594aa9f477e" title="find ucon, ucov, bcon, bcov from primitive variables when calling get_state, users of this function e...">get_state</a>(pp, ptrgeom, &amp;qcons);</div>
<div class="line"><a name="l07575"></a><span class="lineno"> 7575</span>&#160;              <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a9a54096e4c40a15a2c1bf74266153616" title="calculate &quot;conserved&quot; quantities">primtoU</a>(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab2be21bd5eff40ca89c20eeecbeab5e0">UNOTHING</a>,pp,&amp;qcons,ptrgeom, uu, NULL);</div>
<div class="line"><a name="l07576"></a><span class="lineno"> 7576</span>&#160;            }</div>
<div class="line"><a name="l07577"></a><span class="lineno"> 7577</span>&#160;</div>
<div class="line"><a name="l07578"></a><span class="lineno"> 7578</span>&#160;            <span class="comment">// now get error</span></div>
<div class="line"><a name="l07579"></a><span class="lineno"> 7579</span>&#160;            <span class="keywordtype">int</span> dimtypef=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a6c45d4170066340923e6ec67e05436f4">DIMTYPEFCONS</a>; <span class="comment">// 0 = conserved R^t_\nu type, 1 = primitive (u,v^i) type, i.e. v^i has no energy density term</span></div>
<div class="line"><a name="l07580"></a><span class="lineno"> 7580</span>&#160;            convreturn=f_error_check(showmessages, showmessagesheavy, iter, trueimptryconv, trueimptryconvabs,realdt,dimtypef,eomtypelocal,*radinvmod,itermode,*baseitermethod,fracenergy,dissmeasure,dimfactU,pp,piin,f1,f1norm,f1report,Uiin,uu0,uu,ptrgeom,&amp;errorabsf1[0],&amp;errorabsf1[1],<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>,&amp;mtd,&amp;ru);</div>
<div class="line"><a name="l07581"></a><span class="lineno"> 7581</span>&#160;            convreturnallow=(errorabsf1[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>]&lt;trueimpallowconvabs);</div>
<div class="line"><a name="l07582"></a><span class="lineno"> 7582</span>&#160;            convreturnok=(errorabsf1[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>]&lt;trueimpokconvabs);</div>
<div class="line"><a name="l07583"></a><span class="lineno"> 7583</span>&#160;          }</div>
<div class="line"><a name="l07584"></a><span class="lineno"> 7584</span>&#160;</div>
<div class="line"><a name="l07585"></a><span class="lineno"> 7585</span>&#160;</div>
<div class="line"><a name="l07586"></a><span class="lineno"> 7586</span>&#160;</div>
<div class="line"><a name="l07587"></a><span class="lineno"> 7587</span>&#160;          <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a7b7fdf03aa53ba612d2d2344e4f6882a" title="whether to get lowest error solution instead of final one.">GETBEST</a>){</div>
<div class="line"><a name="l07588"></a><span class="lineno"> 7588</span>&#160;      </div>
<div class="line"><a name="l07589"></a><span class="lineno"> 7589</span>&#160;            <span class="keywordflow">if</span>(gotbest){</div>
<div class="line"><a name="l07590"></a><span class="lineno"> 7590</span>&#160;              <span class="comment">// f1-based</span></div>
<div class="line"><a name="l07591"></a><span class="lineno"> 7591</span>&#160;              <span class="comment">// using old uu,uup, but probably ok since just helps normalize error</span></div>
<div class="line"><a name="l07592"></a><span class="lineno"> 7592</span>&#160;              errorabsf1[0]=0.0;   <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a60eea34b552378df229a78747fda6857">JACLOOPFULLERROR</a>(itermode,jj,ru.<a class="code" href="../../d2/d46/structof__ref_u.html#a9f3d856dcdd8fa240dfbdcedfad888ef">startjac</a>,ru.<a class="code" href="../../d2/d46/structof__ref_u.html#af67164c1a42e2aefe0603597dd2ea25e">endjac</a>) errorabsf1[0]   += fabs(f1report[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[jj]]);</div>
<div class="line"><a name="l07593"></a><span class="lineno"> 7593</span>&#160;              errorabsf1[1]=0.0;   <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aef340eabe2a41c05add2b3d8527b0fd0">JACLOOPSUPERFULL</a>(pliter,pl,eomtypelocal,*baseitermethod,*radinvmod)  errorabsf1[1]   += fabs(f1report[pl]);</div>
<div class="line"><a name="l07594"></a><span class="lineno"> 7594</span>&#160;              errorabsbest[0]=0.0; <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a60eea34b552378df229a78747fda6857">JACLOOPFULLERROR</a>(itermode,jj,ru.<a class="code" href="../../d2/d46/structof__ref_u.html#a9f3d856dcdd8fa240dfbdcedfad888ef">startjac</a>,ru.<a class="code" href="../../d2/d46/structof__ref_u.html#af67164c1a42e2aefe0603597dd2ea25e">endjac</a>) errorabsbest[0] += fabs(lowestf1report[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[jj]]);</div>
<div class="line"><a name="l07595"></a><span class="lineno"> 7595</span>&#160;              errorabsbest[1]=0.0; <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aef340eabe2a41c05add2b3d8527b0fd0">JACLOOPSUPERFULL</a>(pliter,pl,eomtypelocal,*baseitermethod,*radinvmod)  errorabsbest[1] += fabs(lowestf1report[pl]);</div>
<div class="line"><a name="l07596"></a><span class="lineno"> 7596</span>&#160;</div>
<div class="line"><a name="l07597"></a><span class="lineno"> 7597</span>&#160;              <span class="comment">// see if should revert to prior best</span></div>
<div class="line"><a name="l07598"></a><span class="lineno"> 7598</span>&#160;              <span class="keywordflow">if</span>(errorabsbest[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>]&lt;errorabsf1[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>] || !<a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(errorabsf1[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>]) ){</div>
<div class="line"><a name="l07599"></a><span class="lineno"> 7599</span>&#160;                <span class="keywordflow">if</span>(showmessages &amp;&amp; debugfail&gt;=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a969edf608c4953dd7b4b34e99dbc686c">DEBUGLEVELIMPSOLVERMORE</a>) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;Using best: %g %g : %g %g\n&quot;</span>,errorabsf1[0],errorabsf1[1],errorabsbest[0],errorabsbest[1]);</div>
<div class="line"><a name="l07600"></a><span class="lineno"> 7600</span>&#160;</div>
<div class="line"><a name="l07601"></a><span class="lineno"> 7601</span>&#160;                <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) uu[pl]=bestuu[pl];</div>
<div class="line"><a name="l07602"></a><span class="lineno"> 7602</span>&#160;                <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) pp[pl]=bestpp[pl];</div>
<div class="line"><a name="l07603"></a><span class="lineno"> 7603</span>&#160;                errorabsf1[0]=errorabsbest[0];</div>
<div class="line"><a name="l07604"></a><span class="lineno"> 7604</span>&#160;                errorabsf1[1]=errorabsbest[1];</div>
<div class="line"><a name="l07605"></a><span class="lineno"> 7605</span>&#160;                <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) f1[pl] = lowestf1[pl];</div>
<div class="line"><a name="l07606"></a><span class="lineno"> 7606</span>&#160;                <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) f1norm[pl] = lowestf1norm[pl];</div>
<div class="line"><a name="l07607"></a><span class="lineno"> 7607</span>&#160;                <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) f1report[pl] = lowestf1report[pl];</div>
<div class="line"><a name="l07608"></a><span class="lineno"> 7608</span>&#160;                *radinvmod = radinvmodbest;</div>
<div class="line"><a name="l07609"></a><span class="lineno"> 7609</span>&#160;</div>
<div class="line"><a name="l07610"></a><span class="lineno"> 7610</span>&#160;                <span class="comment">// get whether converged</span></div>
<div class="line"><a name="l07611"></a><span class="lineno"> 7611</span>&#160;                convreturn=(errorabsf1[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>]&lt;trueimptryconvabs);</div>
<div class="line"><a name="l07612"></a><span class="lineno"> 7612</span>&#160;                convreturnallow=(errorabsf1[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>]&lt;trueimpallowconvabs);</div>
<div class="line"><a name="l07613"></a><span class="lineno"> 7613</span>&#160;                convreturnok=(errorabsf1[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>]&lt;trueimpokconvabs);</div>
<div class="line"><a name="l07614"></a><span class="lineno"> 7614</span>&#160;                <span class="keywordflow">if</span>(debugfail&gt;=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a969edf608c4953dd7b4b34e99dbc686c">DEBUGLEVELIMPSOLVERMORE</a>) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;GETBEST: convreturn=%d convreturnok=%d convreturnallow=%d (IMPOKCONV=%g IMPALLOWCONV=%g) f1report: %g %g %g %g : %g %g\n&quot;</span>,convreturn,convreturnok,convreturnallow,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#af7b72bf07e905af920a80341cad3ec60">IMPOKCONV</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aed356d684bdfb542015fcc82d0b8e46f">IMPALLOWCONV</a>,f1report[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[0]],f1report[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[1]],f1report[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[2]],f1report[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[3]],errorabsf1[0],errorabsf1[1]);</div>
<div class="line"><a name="l07615"></a><span class="lineno"> 7615</span>&#160;              }</div>
<div class="line"><a name="l07616"></a><span class="lineno"> 7616</span>&#160;              <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l07617"></a><span class="lineno"> 7617</span>&#160;                <span class="keywordflow">if</span>(debugfail&gt;=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a969edf608c4953dd7b4b34e99dbc686c">DEBUGLEVELIMPSOLVERMORE</a>) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;gotbest=%d but errorabsbest=%g %g while errorabsf1=%g %g\n&quot;</span>,gotbest,errorabsbest[0],errorabsbest[1],errorabsf1[0],errorabsf1[1]);</div>
<div class="line"><a name="l07618"></a><span class="lineno"> 7618</span>&#160;                <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) bestuu[pl]=uu[pl];</div>
<div class="line"><a name="l07619"></a><span class="lineno"> 7619</span>&#160;                <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) bestpp[pl]=pp[pl];</div>
<div class="line"><a name="l07620"></a><span class="lineno"> 7620</span>&#160;                errorabsbest[0]=errorabsf1[0];</div>
<div class="line"><a name="l07621"></a><span class="lineno"> 7621</span>&#160;                errorabsbest[1]=errorabsf1[1];</div>
<div class="line"><a name="l07622"></a><span class="lineno"> 7622</span>&#160;                radinvmodbest = *radinvmod;</div>
<div class="line"><a name="l07623"></a><span class="lineno"> 7623</span>&#160;                failreturnbest = failreturn;</div>
<div class="line"><a name="l07624"></a><span class="lineno"> 7624</span>&#160;              }</div>
<div class="line"><a name="l07625"></a><span class="lineno"> 7625</span>&#160;            }</div>
<div class="line"><a name="l07626"></a><span class="lineno"> 7626</span>&#160;          }<span class="comment">// end GETBEST</span></div>
<div class="line"><a name="l07627"></a><span class="lineno"> 7627</span>&#160;</div>
<div class="line"><a name="l07628"></a><span class="lineno"> 7628</span>&#160;</div>
<div class="line"><a name="l07629"></a><span class="lineno"> 7629</span>&#160;</div>
<div class="line"><a name="l07630"></a><span class="lineno"> 7630</span>&#160;</div>
<div class="line"><a name="l07631"></a><span class="lineno"> 7631</span>&#160;</div>
<div class="line"><a name="l07632"></a><span class="lineno"> 7632</span>&#160;</div>
<div class="line"><a name="l07633"></a><span class="lineno"> 7633</span>&#160;</div>
<div class="line"><a name="l07634"></a><span class="lineno"> 7634</span>&#160;</div>
<div class="line"><a name="l07635"></a><span class="lineno"> 7635</span>&#160;</div>
<div class="line"><a name="l07636"></a><span class="lineno"> 7636</span>&#160;</div>
<div class="line"><a name="l07637"></a><span class="lineno"> 7637</span>&#160;</div>
<div class="line"><a name="l07638"></a><span class="lineno"> 7638</span>&#160;</div>
<div class="line"><a name="l07639"></a><span class="lineno"> 7639</span>&#160;          <span class="comment">// KORALTODO: If convreturnallow doesn&#39;t work, but still (say) 10% error, might want to hold onto result in case explicit backup fails as well (which is likely), in which case *much* better to use 10% error because otherwise 4-force not accounted for, which can lead to very big changes in fluid behavior due to large flux from previous step.</span></div>
<div class="line"><a name="l07640"></a><span class="lineno"> 7640</span>&#160;          <span class="comment">// KORALTODO: Or, perhaps should really take it as a failure and use fixups.  Probably should allow for result to be written if error&lt;10%, but only use as super-backup in fixups.  So should set pflag still.</span></div>
<div class="line"><a name="l07641"></a><span class="lineno"> 7641</span>&#160;</div>
<div class="line"><a name="l07643"></a><span class="lineno"> 7643</span>&#160;          <span class="comment">//</span></div>
<div class="line"><a name="l07644"></a><span class="lineno"> 7644</span>&#160;          <span class="comment">// See if reached desired tolerance</span></div>
<div class="line"><a name="l07645"></a><span class="lineno"> 7645</span>&#160;          <span class="comment">//</span></div>
<div class="line"><a name="l07647"></a><span class="lineno"> 7647</span>&#160;<span class="comment"></span>          <span class="keywordflow">if</span>(convreturn || convreturnok){</div>
<div class="line"><a name="l07648"></a><span class="lineno"> 7648</span>&#160;            <span class="comment">// then really done</span></div>
<div class="line"><a name="l07649"></a><span class="lineno"> 7649</span>&#160;            failreturn=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a3d6e4da5640133efaad94738c97e5171">FAILRETURNNOFAIL</a>; mathfailtype=0;</div>
<div class="line"><a name="l07650"></a><span class="lineno"> 7650</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l07651"></a><span class="lineno"> 7651</span>&#160;          }</div>
<div class="line"><a name="l07652"></a><span class="lineno"> 7652</span>&#160;          <span class="keywordflow">else</span>{ <span class="comment">// convreturn==0 &amp;&amp; convreturnok==0</span></div>
<div class="line"><a name="l07653"></a><span class="lineno"> 7653</span>&#160;          </div>
<div class="line"><a name="l07654"></a><span class="lineno"> 7654</span>&#160;            <span class="comment">// see if at least allowed error</span></div>
<div class="line"><a name="l07655"></a><span class="lineno"> 7655</span>&#160;            <span class="keywordflow">if</span>(convreturnallow){</div>
<div class="line"><a name="l07656"></a><span class="lineno"> 7656</span>&#160;</div>
<div class="line"><a name="l07657"></a><span class="lineno"> 7657</span>&#160;              <span class="comment">// set as soft allowable failure</span></div>
<div class="line"><a name="l07658"></a><span class="lineno"> 7658</span>&#160;              failreturn=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a45adfa493bc8ab6857a43a11d9d649d1">FAILRETURNNOTTOLERROR</a>; mathfailtype=202;</div>
<div class="line"><a name="l07659"></a><span class="lineno"> 7659</span>&#160;</div>
<div class="line"><a name="l07660"></a><span class="lineno"> 7660</span>&#160;              <span class="keywordflow">if</span>(iter&gt;trueimpmaxiter){<span class="comment">// then reached maximum iterations</span></div>
<div class="line"><a name="l07661"></a><span class="lineno"> 7661</span>&#160;                <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a7df8286c59d491ba1117884d33499a7a">prod0dualfprintf</a>(debugfail&gt;=2,<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;trueimpmaxiter=%d eomtype=%d MAXcheckconv=%d havebackup=%d failreturnallowable=%d: f1report=%g %g %g %g : f1=%g %g %g %g\n&quot;</span>,trueimpmaxiter,eomtypelocal,checkconv,havebackup,failreturnallowable,f1report[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[0]],f1report[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[1]],f1report[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[2]],f1report[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[3]],f1[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[0]],f1[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[1]],f1[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[2]],f1[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[3]]);</div>
<div class="line"><a name="l07662"></a><span class="lineno"> 7662</span>&#160;</div>
<div class="line"><a name="l07663"></a><span class="lineno"> 7663</span>&#160;                <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a7df8286c59d491ba1117884d33499a7a">prod0dualfprintf</a>(showmessages &amp;&amp; debugfail&gt;=2,<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;iter&gt;trueimpmaxiter=%d : iter exceeded in solve_implicit_lab().  But f1 was allowed error. checkconv=%d (if checkconv=0, could be issue!) : %g %g %g %g : %g %g %g %g : errorabs=%g %g : %g %g %g\n&quot;</span>,trueimpmaxiter,checkconv,f1report[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[0]],f1report[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[1]],f1report[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[2]],f1report[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[3]],f1[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[0]],f1[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[1]],f1[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[2]],f1[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[3]],errorabsf1[0],errorabsf1[1],fracdtuu0,fracuup,fracdtG);</div>
<div class="line"><a name="l07664"></a><span class="lineno"> 7664</span>&#160;                <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afd4f53bb800de27cee3986b199f46f24" title="below 1 if reporting cases when MAXITER reached, but allowd error so not otherwise normally reported...">REPORTMAXITERALLOWED</a>){</div>
<div class="line"><a name="l07665"></a><span class="lineno"> 7665</span>&#160;                  <span class="keywordflow">if</span>(havebackup){</div>
<div class="line"><a name="l07666"></a><span class="lineno"> 7666</span>&#160;                    <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a7df8286c59d491ba1117884d33499a7a">prod0dualfprintf</a>(debugfail&gt;=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a969edf608c4953dd7b4b34e99dbc686c">DEBUGLEVELIMPSOLVERMORE</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;SWITCHING MODE: Detected MAXITER\n&quot;</span>);</div>
<div class="line"><a name="l07667"></a><span class="lineno"> 7667</span>&#160;                    <span class="comment">// don&#39;t break, just reporting or not</span></div>
<div class="line"><a name="l07668"></a><span class="lineno"> 7668</span>&#160;                    mathfailtype=50;</div>
<div class="line"><a name="l07669"></a><span class="lineno"> 7669</span>&#160;                  }</div>
<div class="line"><a name="l07670"></a><span class="lineno"> 7670</span>&#160;                  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l07671"></a><span class="lineno"> 7671</span>&#160;                    mathfailtype=(eomtypelocal==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a03d89f51ab60206791830c886d62bfd0">EOMGRMHD</a> ? 6 : 600);</div>
<div class="line"><a name="l07672"></a><span class="lineno"> 7672</span>&#160;                  }</div>
<div class="line"><a name="l07673"></a><span class="lineno"> 7673</span>&#160;                }</div>
<div class="line"><a name="l07674"></a><span class="lineno"> 7674</span>&#160;              }</div>
<div class="line"><a name="l07675"></a><span class="lineno"> 7675</span>&#160;</div>
<div class="line"><a name="l07676"></a><span class="lineno"> 7676</span>&#160;              <span class="comment">// then nothing else to do</span></div>
<div class="line"><a name="l07677"></a><span class="lineno"> 7677</span>&#160;              <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l07678"></a><span class="lineno"> 7678</span>&#160;            }</div>
<div class="line"><a name="l07679"></a><span class="lineno"> 7679</span>&#160;            <span class="keywordflow">else</span>{ <span class="comment">// didn&#39;t reach allowable error</span></div>
<div class="line"><a name="l07680"></a><span class="lineno"> 7680</span>&#160;              <span class="comment">// not allowable failure</span></div>
<div class="line"><a name="l07681"></a><span class="lineno"> 7681</span>&#160;              failreturn=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab0abd953f677a44020dc50259c410486">FAILRETURNGENERAL</a>; mathfailtype=203;</div>
<div class="line"><a name="l07682"></a><span class="lineno"> 7682</span>&#160;</div>
<div class="line"><a name="l07683"></a><span class="lineno"> 7683</span>&#160;</div>
<div class="line"><a name="l07684"></a><span class="lineno"> 7684</span>&#160;<span class="preprocessor">#if(PRODUCTION==0)</span></div>
<div class="line"><a name="l07685"></a><span class="lineno"> 7685</span>&#160;<span class="preprocessor"></span>              <span class="comment">// KORALTODO: Need backup that won&#39;t fail.</span></div>
<div class="line"><a name="l07686"></a><span class="lineno"> 7686</span>&#160;              <span class="keywordflow">if</span>(debugfail&gt;=2){</div>
<div class="line"><a name="l07687"></a><span class="lineno"> 7687</span>&#160;                <span class="keywordflow">if</span>(canbreak==1 &amp;&amp; havebackup==0) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;Held u_g, couldn&#39;t hold anymore and broke, but error still larger than allowed : iter=%d ijknstepsteppart=%d %d %d %ld %d\n&quot;</span>,iter,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a1a1088d87617078680f1fd0f0d707384">nstep</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a70170b90229f9fc05eebf8508a685c70">steppart</a>);</div>
<div class="line"><a name="l07688"></a><span class="lineno"> 7688</span>&#160;                <span class="keywordflow">if</span>(canbreak==2 &amp;&amp; havebackup==0) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;Aborted due to oscillatory error despite not having backup: iter=%d\n&quot;</span>,iter);</div>
<div class="line"><a name="l07689"></a><span class="lineno"> 7689</span>&#160;                <span class="keywordflow">if</span>(canbreak==3 &amp;&amp; havebackup==0) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;Aborted due to error not decreasing fast enough: iter=%d errorabsf1=%g %g\n&quot;</span>,iter,errorabsf1[0],errorabsf1[1]);</div>
<div class="line"><a name="l07690"></a><span class="lineno"> 7690</span>&#160;                <span class="keywordflow">if</span>(canbreak==4 &amp;&amp; havebackup==0) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;Aborted due to error not decreasing fast enough: iter=%d errorabsf1=%g %g\n&quot;</span>,iter,errorabsf1[0],errorabsf1[1]);</div>
<div class="line"><a name="l07691"></a><span class="lineno"> 7691</span>&#160;                <span class="keywordflow">if</span>(canbreak==5 &amp;&amp; havebackup==0) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;Aborted due to error not decreasing fast enough: iter=%d errorabsf1=%g %g\n&quot;</span>,iter,errorabsf1[0],errorabsf1[1]);</div>
<div class="line"><a name="l07692"></a><span class="lineno"> 7692</span>&#160;                <span class="keywordflow">if</span>(iter&gt;trueimpmaxiter &amp;&amp; havebackup==0) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;iter&gt;trueimpmaxiter=%d : iter exceeded in solve_implicit_lab(). nstep=%ld steppart=%d ijk=%d %d %d :  Bad error.\n&quot;</span>,trueimpmaxiter,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a1a1088d87617078680f1fd0f0d707384">nstep</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a70170b90229f9fc05eebf8508a685c70">steppart</a>,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k);</div>
<div class="line"><a name="l07693"></a><span class="lineno"> 7693</span>&#160;                <span class="keywordflow">if</span>(notfinite &amp;&amp; havebackup==0) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;IMPGOTNAN at iter=%d : in solve_implicit_lab(). ijk=%d %d %d :  Bad error.\n&quot;</span>,iter,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k);</div>
<div class="line"><a name="l07694"></a><span class="lineno"> 7694</span>&#160;                <span class="keywordflow">if</span>(havebackup==0) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;checkconv=%d havebackup=%d failreturnallowable=%d: f1report=%g %g %g %g : f1=%g %g %g %g\n&quot;</span>,checkconv,havebackup,failreturnallowable,f1report[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[0]],f1report[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[1]],f1report[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[2]],f1report[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[3]],f1[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[0]],f1[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[1]],f1[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[2]],f1[ru.<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[3]]);</div>
<div class="line"><a name="l07695"></a><span class="lineno"> 7695</span>&#160;                <span class="keywordflow">if</span>(1||showmessages){</div>
<div class="line"><a name="l07696"></a><span class="lineno"> 7696</span>&#160;                  <span class="keywordflow">if</span>(havebackup){</div>
<div class="line"><a name="l07697"></a><span class="lineno"> 7697</span>&#160;                    <span class="comment">// don&#39;t break, just don&#39;t report.</span></div>
<div class="line"><a name="l07698"></a><span class="lineno"> 7698</span>&#160;</div>
<div class="line"><a name="l07699"></a><span class="lineno"> 7699</span>&#160;                    mathfailtype=60;</div>
<div class="line"><a name="l07700"></a><span class="lineno"> 7700</span>&#160;                  }</div>
<div class="line"><a name="l07701"></a><span class="lineno"> 7701</span>&#160;                  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l07702"></a><span class="lineno"> 7702</span>&#160;                    mathfailtype=1;</div>
<div class="line"><a name="l07703"></a><span class="lineno"> 7703</span>&#160;                  }</div>
<div class="line"><a name="l07704"></a><span class="lineno"> 7704</span>&#160;                }</div>
<div class="line"><a name="l07705"></a><span class="lineno"> 7705</span>&#160;</div>
<div class="line"><a name="l07706"></a><span class="lineno"> 7706</span>&#160;              }<span class="comment">// debug</span></div>
<div class="line"><a name="l07707"></a><span class="lineno"> 7707</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l07708"></a><span class="lineno"> 7708</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l07709"></a><span class="lineno"> 7709</span>&#160;              <span class="comment">// nothing else to do except leave</span></div>
<div class="line"><a name="l07710"></a><span class="lineno"> 7710</span>&#160;              <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l07711"></a><span class="lineno"> 7711</span>&#160;            }<span class="comment">// end if convreturnallow=0 (didn&#39;t reach allowed error)</span></div>
<div class="line"><a name="l07712"></a><span class="lineno"> 7712</span>&#160;          }<span class="comment">// end if didn&#39;t reach desired error</span></div>
<div class="line"><a name="l07713"></a><span class="lineno"> 7713</span>&#160;</div>
<div class="line"><a name="l07714"></a><span class="lineno"> 7714</span>&#160;</div>
<div class="line"><a name="l07715"></a><span class="lineno"> 7715</span>&#160;</div>
<div class="line"><a name="l07716"></a><span class="lineno"> 7716</span>&#160;      </div>
<div class="line"><a name="l07717"></a><span class="lineno"> 7717</span>&#160;</div>
<div class="line"><a name="l07718"></a><span class="lineno"> 7718</span>&#160;        }<span class="comment">// end fake loop that can break out of</span></div>
<div class="line"><a name="l07719"></a><span class="lineno"> 7719</span>&#160;      }<span class="comment">// end if failreturn==0 originally</span></div>
<div class="line"><a name="l07720"></a><span class="lineno"> 7720</span>&#160;</div>
<div class="line"><a name="l07721"></a><span class="lineno"> 7721</span>&#160;</div>
<div class="line"><a name="l07722"></a><span class="lineno"> 7722</span>&#160;      <span class="comment">// get best failreturn</span></div>
<div class="line"><a name="l07723"></a><span class="lineno"> 7723</span>&#160;      <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a7b7fdf03aa53ba612d2d2344e4f6882a" title="whether to get lowest error solution instead of final one.">GETBEST</a>){</div>
<div class="line"><a name="l07724"></a><span class="lineno"> 7724</span>&#160;        <span class="keywordflow">if</span>(gotbest){</div>
<div class="line"><a name="l07725"></a><span class="lineno"> 7725</span>&#160;          failreturnbest=failreturn;</div>
<div class="line"><a name="l07726"></a><span class="lineno"> 7726</span>&#160;          radinvmodbest = *radinvmod;</div>
<div class="line"><a name="l07727"></a><span class="lineno"> 7727</span>&#160;        }</div>
<div class="line"><a name="l07728"></a><span class="lineno"> 7728</span>&#160;      }</div>
<div class="line"><a name="l07729"></a><span class="lineno"> 7729</span>&#160;</div>
<div class="line"><a name="l07730"></a><span class="lineno"> 7730</span>&#160;</div>
<div class="line"><a name="l07731"></a><span class="lineno"> 7731</span>&#160;      <span class="comment">// estimate effective work based on iterations done for each equation type</span></div>
<div class="line"><a name="l07732"></a><span class="lineno"> 7732</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fndim=(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a>)NDIM;</div>
<div class="line"><a name="l07733"></a><span class="lineno"> 7733</span>&#160;      totaliters += (int)( (3.0/fndim)*(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a>)momiters + (1.0/fndim)*(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a>)energyiters + (fndim/fndim)*(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a>)fulliters);</div>
<div class="line"><a name="l07734"></a><span class="lineno"> 7734</span>&#160;</div>
<div class="line"><a name="l07735"></a><span class="lineno"> 7735</span>&#160;    }<span class="comment">// end loop over damping</span></div>
<div class="line"><a name="l07736"></a><span class="lineno"> 7736</span>&#160;    <span class="keywordflow">if</span>(dampattempt==truenumdampattempts &amp;&amp; truenumdampattempts&gt;1){</div>
<div class="line"><a name="l07737"></a><span class="lineno"> 7737</span>&#160;      <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a7df8286c59d491ba1117884d33499a7a">prod0dualfprintf</a>(debugfail&gt;=2,<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;Damping failed to avoid max iterations (but error might have dropped: %21.15g %21.15g): failreturn=%d dampattempt=%d eomtypelocal=%d eomtypelocal=%d ijk=%d %d %d\n&quot;</span>,errorabsf1[0],errorabsf1[1],failreturn,dampattempt,eomtypelocal,eomtypelocal,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k);</div>
<div class="line"><a name="l07738"></a><span class="lineno"> 7738</span>&#160;    }</div>
<div class="line"><a name="l07739"></a><span class="lineno"> 7739</span>&#160;</div>
<div class="line"><a name="l07740"></a><span class="lineno"> 7740</span>&#160;</div>
<div class="line"><a name="l07741"></a><span class="lineno"> 7741</span>&#160;  }<span class="comment">// end explicitattempt</span></div>
<div class="line"><a name="l07742"></a><span class="lineno"> 7742</span>&#160;</div>
<div class="line"><a name="l07743"></a><span class="lineno"> 7743</span>&#160;</div>
<div class="line"><a name="l07744"></a><span class="lineno"> 7744</span>&#160;</div>
<div class="line"><a name="l07745"></a><span class="lineno"> 7745</span>&#160;</div>
<div class="line"><a name="l07746"></a><span class="lineno"> 7746</span>&#160;</div>
<div class="line"><a name="l07747"></a><span class="lineno"> 7747</span>&#160;</div>
<div class="line"><a name="l07748"></a><span class="lineno"> 7748</span>&#160;</div>
<div class="line"><a name="l07750"></a><span class="lineno"> 7750</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l07751"></a><span class="lineno"> 7751</span>&#160;  <span class="comment">// Once damping or explicitattemps are done, ensure choose best over all tries</span></div>
<div class="line"><a name="l07752"></a><span class="lineno"> 7752</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l07754"></a><span class="lineno"> 7754</span>&#160;<span class="comment"></span>  <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a7b7fdf03aa53ba612d2d2344e4f6882a" title="whether to get lowest error solution instead of final one.">GETBEST</a>){</div>
<div class="line"><a name="l07755"></a><span class="lineno"> 7755</span>&#160;    <span class="keywordflow">if</span>(gotbest){</div>
<div class="line"><a name="l07756"></a><span class="lineno"> 7756</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) uu[pl]=bestuu[pl];</div>
<div class="line"><a name="l07757"></a><span class="lineno"> 7757</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) pp[pl]=bestpp[pl];</div>
<div class="line"><a name="l07758"></a><span class="lineno"> 7758</span>&#160;      errorabsf1[0]=errorabsbest[0];</div>
<div class="line"><a name="l07759"></a><span class="lineno"> 7759</span>&#160;      errorabsf1[1]=errorabsbest[1];</div>
<div class="line"><a name="l07760"></a><span class="lineno"> 7760</span>&#160;      failreturn=failreturnbest;</div>
<div class="line"><a name="l07761"></a><span class="lineno"> 7761</span>&#160;      *radinvmod = radinvmodbest;</div>
<div class="line"><a name="l07762"></a><span class="lineno"> 7762</span>&#160;    }</div>
<div class="line"><a name="l07763"></a><span class="lineno"> 7763</span>&#160;  }</div>
<div class="line"><a name="l07764"></a><span class="lineno"> 7764</span>&#160;</div>
<div class="line"><a name="l07765"></a><span class="lineno"> 7765</span>&#160;</div>
<div class="line"><a name="l07766"></a><span class="lineno"> 7766</span>&#160;</div>
<div class="line"><a name="l07767"></a><span class="lineno"> 7767</span>&#160;</div>
<div class="line"><a name="l07768"></a><span class="lineno"> 7768</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a98e2c94d4fc861c61bc8dde7b4eec734">ACTUALHARDFAILURE</a>(failreturn)==0){ <span class="comment">// deal with radinv issue but only if didn&#39;t fail</span></div>
<div class="line"><a name="l07769"></a><span class="lineno"> 7769</span>&#160;</div>
<div class="line"><a name="l07771"></a><span class="lineno"> 7771</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l07772"></a><span class="lineno"> 7772</span>&#160;    <span class="comment">// But, in general, for QTYPMHD methods, might have use CAPTYPEFIX2 or CAPTYPEFIX1, but should use whichcap (probably CAPTYPEBASIC) to be conservative on value of Erf in general.  So while converged&quot;, could have avoided URAD0 error in total error for QTYPMHD methods.  So recover whichcap result before moving onto setting dUcomp.</span></div>
<div class="line"><a name="l07773"></a><span class="lineno"> 7773</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l07775"></a><span class="lineno"> 7775</span>&#160;<span class="comment"></span>    <span class="keywordflow">if</span>(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0685d01c4383c1608a7ea72cb7ce3791">RADINVBAD</a>(*radinvmod) &amp;&amp; <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a33425cd25de3bba0ed1613fd419efefd" title="MHD or RAD baseitermethod types.">IMPMHDTYPEBASE</a>(*baseitermethod)==1){</div>
<div class="line"><a name="l07776"></a><span class="lineno"> 7776</span>&#160;      <span class="keywordtype">int</span> whichcall=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a137120b9d350a5e9706de4a7a9dde9fb">FIMPLICITCALLTYPEFINALCHECK2</a>; <span class="comment">// KEY CHOICE IS THIS, which will use whichcap</span></div>
<div class="line"><a name="l07777"></a><span class="lineno"> 7777</span>&#160;      <span class="keywordtype">int</span> goexplicitfake;</div>
<div class="line"><a name="l07778"></a><span class="lineno"> 7778</span>&#160;      <span class="keywordtype">int</span> dimtypef=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a6c45d4170066340923e6ec67e05436f4">DIMTYPEFCONS</a>; <span class="comment">// 0 = conserved R^t_\nu type, 1 = primitive (u,v^i) type, i.e. v^i has no energy density term</span></div>
<div class="line"><a name="l07779"></a><span class="lineno"> 7779</span>&#160;      <span class="keywordtype">int</span> fakef1iter=-1;</div>
<div class="line"><a name="l07780"></a><span class="lineno"> 7780</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fakefracdtG=1.0;</div>
<div class="line"><a name="l07781"></a><span class="lineno"> 7781</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> f1fake[NPR],f1normfake[NPR],f1reportfake[NPR];</div>
<div class="line"><a name="l07782"></a><span class="lineno"> 7782</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> errorabsf1fake[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa63447acbbbc62cbedae23eac61c716e" title="determine which error will use when deciding if converged or not.">NUMERRORTYPES</a>];</div>
<div class="line"><a name="l07783"></a><span class="lineno"> 7783</span>&#160;      errorabsf1fake[0]=errorabsf1[0];</div>
<div class="line"><a name="l07784"></a><span class="lineno"> 7784</span>&#160;      errorabsf1fake[1]=errorabsf1[1];</div>
<div class="line"><a name="l07785"></a><span class="lineno"> 7785</span>&#160;      <span class="keywordtype">int</span> convreturnfake=1;</div>
<div class="line"><a name="l07786"></a><span class="lineno"> 7786</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fakeimpepsjac=1<a class="code" href="../../d8/d60/init_8c.html#a07484107e6d9fdf38b53edf631d6511d">E</a>-6;</div>
<div class="line"><a name="l07787"></a><span class="lineno"> 7787</span>&#160;      <span class="keywordtype">int</span> fakefailreturnf=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#af46d2b1cf89a70a7e2ef503146c649a9" title="uu0 - original cons.">f_implicit</a>(allowbaseitermethodswitch, iter,fakef1iter,failreturnallowableuse, whichcall,fakeimpepsjac,showmessages, showmessagesheavy, allowlocalfailurefixandnoreport, &amp;eomtypelocal, whichcap, itermode, baseitermethod, fracenergy, dissmeasure, radinvmod, trueimptryconv, trueimptryconvabs, trueimpallowconvabs, trueimpmaxiter, realdt, dimtypef, dimfactU, pp, pp, piin, uu, Uiin, uu0, uu, fakefracdtG*realdt, ptrgeom, q, f1fake, f1normfake, f1reportfake, &amp;goexplicitfake, &amp;errorabsf1fake[0], &amp;errorabsf1fake[1], <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>, &amp;convreturnfake, nummhdinvsreturn, &amp;tautotmaxreturn, &amp;mtd, &amp;ru);</div>
<div class="line"><a name="l07788"></a><span class="lineno"> 7788</span>&#160;      <span class="comment">// ONLY modifies uu and pp and q using true whichcap</span></div>
<div class="line"><a name="l07789"></a><span class="lineno"> 7789</span>&#160;      <span class="comment">// *and* radinvmod, which contains whether radiative inversion modified solution.</span></div>
<div class="line"><a name="l07790"></a><span class="lineno"> 7790</span>&#160;    }</div>
<div class="line"><a name="l07791"></a><span class="lineno"> 7791</span>&#160;</div>
<div class="line"><a name="l07793"></a><span class="lineno"> 7793</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l07794"></a><span class="lineno"> 7794</span>&#160;    <span class="comment">// In general, uu might still not be uu=uu(pp) because might have used uualt in f_implicit()</span></div>
<div class="line"><a name="l07795"></a><span class="lineno"> 7795</span>&#160;    <span class="comment">// But now that done with determining which solution we want to use with what error, now make consistent.</span></div>
<div class="line"><a name="l07796"></a><span class="lineno"> 7796</span>&#160;    <span class="comment">// This needs to come *before* radsource or dUcomp is computed using uu, because uualt was only for error and not actual value that we want to fix-up to no longer require uualt in sense of making U change enough to be like primitive p.</span></div>
<div class="line"><a name="l07797"></a><span class="lineno"> 7797</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l07799"></a><span class="lineno"> 7799</span>&#160;<span class="comment"></span>    <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8369e50da6c81920c90b241974d34e99" title="whether to try using uualt (see f_implicit())">ALLOWUSEUUALT</a>){</div>
<div class="line"><a name="l07800"></a><span class="lineno"> 7800</span>&#160;      <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a11e17cd8b0594d1ad52e3594aa9f477e" title="find ucon, ucov, bcon, bcov from primitive variables when calling get_state, users of this function e...">get_state</a>(pp, ptrgeom, q);</div>
<div class="line"><a name="l07801"></a><span class="lineno"> 7801</span>&#160;      <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a9a54096e4c40a15a2c1bf74266153616" title="calculate &quot;conserved&quot; quantities">primtoU</a>(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab2be21bd5eff40ca89c20eeecbeab5e0">UNOTHING</a>,pp,q,ptrgeom, uu, NULL);</div>
<div class="line"><a name="l07802"></a><span class="lineno"> 7802</span>&#160;    }</div>
<div class="line"><a name="l07803"></a><span class="lineno"> 7803</span>&#160;</div>
<div class="line"><a name="l07804"></a><span class="lineno"> 7804</span>&#160;</div>
<div class="line"><a name="l07805"></a><span class="lineno"> 7805</span>&#160;    <span class="keywordflow">if</span>(0){ <span class="comment">// no longer do this since do above full primtoU</span></div>
<div class="line"><a name="l07807"></a><span class="lineno"> 7807</span>&#160;<span class="comment"></span>      <span class="comment">//</span></div>
<div class="line"><a name="l07808"></a><span class="lineno"> 7808</span>&#160;      <span class="comment">// have to compute final uu[ENTROPY] if doing entropy optimization where avoid it during iterations if not needed.</span></div>
<div class="line"><a name="l07809"></a><span class="lineno"> 7809</span>&#160;      <span class="comment">//</span></div>
<div class="line"><a name="l07811"></a><span class="lineno"> 7811</span>&#160;<span class="comment"></span>      <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a842f854de025438920f9658ae820b4c6" title="whether to avoid computing entropy during iterations if not needed">ENTROPYOPT</a>){</div>
<div class="line"><a name="l07812"></a><span class="lineno"> 7812</span>&#160;        <span class="keywordtype">int</span> needentropy=1;</div>
<div class="line"><a name="l07813"></a><span class="lineno"> 7813</span>&#160;        <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#aae6a7d24b984236dae44b1a3e8ee37b6" title="find ucon, ucov, bcon, bcov from primitive variables when calling get_state, users of this function e...">get_state_norad_part2</a>(needentropy, pp, ptrgeom, q); <span class="comment">// where entropy would be computed</span></div>
<div class="line"><a name="l07814"></a><span class="lineno"> 7814</span>&#160;        <span class="comment">//    get_state(pp, ptrgeom, q);</span></div>
<div class="line"><a name="l07815"></a><span class="lineno"> 7815</span>&#160;        <span class="keyword">extern</span> <span class="keywordtype">int</span> <a class="code" href="../../d7/def/phys_8tools_8c.html#ad54ad99ee062beaf43518d6e9afae0a7">primtoflux_nonradonly</a>(<span class="keywordtype">int</span> needentropy, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *q, <span class="keywordtype">int</span> dir, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *geom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *flux, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *fluxabs);</div>
<div class="line"><a name="l07816"></a><span class="lineno"> 7816</span>&#160;        <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> uuentropy[NPR];</div>
<div class="line"><a name="l07817"></a><span class="lineno"> 7817</span>&#160;        <a class="code" href="../../d7/def/phys_8tools_8c.html#ad54ad99ee062beaf43518d6e9afae0a7">primtoflux_nonradonly</a>(needentropy,pp,q,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>,ptrgeom, uuentropy, NULL);</div>
<div class="line"><a name="l07818"></a><span class="lineno"> 7818</span>&#160;        uu[ENTROPY]=uuentropy[ENTROPY];</div>
<div class="line"><a name="l07819"></a><span class="lineno"> 7819</span>&#160;      }</div>
<div class="line"><a name="l07820"></a><span class="lineno"> 7820</span>&#160;    }</div>
<div class="line"><a name="l07821"></a><span class="lineno"> 7821</span>&#160;</div>
<div class="line"><a name="l07822"></a><span class="lineno"> 7822</span>&#160;  }</div>
<div class="line"><a name="l07823"></a><span class="lineno"> 7823</span>&#160;</div>
<div class="line"><a name="l07825"></a><span class="lineno"> 7825</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l07826"></a><span class="lineno"> 7826</span>&#160;  <span class="comment">// try to obtain total energy conservation *with* entropy solution for gas by borrowing from radiation.</span></div>
<div class="line"><a name="l07827"></a><span class="lineno"> 7827</span>&#160;  <span class="comment">// Do this by trying to keep entropy version of gas variables that have good enough total solution</span></div>
<div class="line"><a name="l07828"></a><span class="lineno"> 7828</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l07830"></a><span class="lineno"> 7830</span>&#160;<span class="comment"></span>  <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#a8bef86ed0f18583ebf2165ecc6466f0a">BORROWENTROPY</a> &amp;&amp; <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a6ce9f5de6e575be785e5f053882a0909">ACCEPTASNOFAILURE</a>(failreturn)==1 &amp;&amp; eomtypelocal==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a40b55e98bfcccde1a3f19d983ca7488c">EOMENTROPYGRMHD</a>){</div>
<div class="line"><a name="l07831"></a><span class="lineno"> 7831</span>&#160;</div>
<div class="line"><a name="l07832"></a><span class="lineno"> 7832</span>&#160;    <span class="comment">// set borrow version of uu</span></div>
<div class="line"><a name="l07833"></a><span class="lineno"> 7833</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> uuborrow[NPR];</div>
<div class="line"><a name="l07834"></a><span class="lineno"> 7834</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ppborrow[NPR];</div>
<div class="line"><a name="l07835"></a><span class="lineno"> 7835</span>&#160;    <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> qborrowdontuse;</div>
<div class="line"><a name="l07836"></a><span class="lineno"> 7836</span>&#160;    <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *qborrow=&amp;qborrowdontuse;</div>
<div class="line"><a name="l07837"></a><span class="lineno"> 7837</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) uuborrow[pl] = uu[pl];</div>
<div class="line"><a name="l07838"></a><span class="lineno"> 7838</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) ppborrow[pl] = pp[pl];</div>
<div class="line"><a name="l07839"></a><span class="lineno"> 7839</span>&#160;    *qborrow=*q;</div>
<div class="line"><a name="l07840"></a><span class="lineno"> 7840</span>&#160;</div>
<div class="line"><a name="l07841"></a><span class="lineno"> 7841</span>&#160;    <span class="comment">// energy added to gas</span></div>
<div class="line"><a name="l07842"></a><span class="lineno"> 7842</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dugas=uuborrow[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]-uu0[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>];</div>
<div class="line"><a name="l07843"></a><span class="lineno"> 7843</span>&#160;    <span class="comment">// try enforcing energy conservation</span></div>
<div class="line"><a name="l07844"></a><span class="lineno"> 7844</span>&#160;    uuborrow[URAD0] = uu0[URAD0] - dugas;</div>
<div class="line"><a name="l07845"></a><span class="lineno"> 7845</span>&#160;</div>
<div class="line"><a name="l07846"></a><span class="lineno"> 7846</span>&#160;</div>
<div class="line"><a name="l07847"></a><span class="lineno"> 7847</span>&#160;    <span class="comment">// invert full solution with errors</span></div>
<div class="line"><a name="l07848"></a><span class="lineno"> 7848</span>&#160;    <span class="keywordtype">int</span> whichcall=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a137120b9d350a5e9706de4a7a9dde9fb">FIMPLICITCALLTYPEFINALCHECK2</a>; <span class="comment">// KEY CHOICE IS THIS, which will use whichcap</span></div>
<div class="line"><a name="l07849"></a><span class="lineno"> 7849</span>&#160;    <span class="keywordtype">int</span> goexplicitborrow;</div>
<div class="line"><a name="l07850"></a><span class="lineno"> 7850</span>&#160;    <span class="keywordtype">int</span> dimtypef=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a6c45d4170066340923e6ec67e05436f4">DIMTYPEFCONS</a>; <span class="comment">// 0 = conserved R^t_\nu type, 1 = primitive (u,v^i) type, i.e. v^i has no energy density term</span></div>
<div class="line"><a name="l07851"></a><span class="lineno"> 7851</span>&#160;    <span class="keywordtype">int</span> borrowf1iter=-1;</div>
<div class="line"><a name="l07852"></a><span class="lineno"> 7852</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> borrowfracdtG=1.0;</div>
<div class="line"><a name="l07853"></a><span class="lineno"> 7853</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> f1borrow[NPR],f1normborrow[NPR],f1reportborrow[NPR];</div>
<div class="line"><a name="l07854"></a><span class="lineno"> 7854</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> errorabsf1borrow[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa63447acbbbc62cbedae23eac61c716e" title="determine which error will use when deciding if converged or not.">NUMERRORTYPES</a>];</div>
<div class="line"><a name="l07855"></a><span class="lineno"> 7855</span>&#160;    errorabsf1borrow[0]=errorabsf1[0];</div>
<div class="line"><a name="l07856"></a><span class="lineno"> 7856</span>&#160;    errorabsf1borrow[1]=errorabsf1[1];</div>
<div class="line"><a name="l07857"></a><span class="lineno"> 7857</span>&#160;    <span class="keywordtype">int</span> convreturnborrow=1;</div>
<div class="line"><a name="l07858"></a><span class="lineno"> 7858</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> borrowimpepsjac=1<a class="code" href="../../d8/d60/init_8c.html#a07484107e6d9fdf38b53edf631d6511d">E</a>-6;</div>
<div class="line"><a name="l07859"></a><span class="lineno"> 7859</span>&#160;    <span class="keywordtype">int</span> radinvmodborrow=0;</div>
<div class="line"><a name="l07860"></a><span class="lineno"> 7860</span>&#160;    <span class="keywordtype">int</span> borrowfailreturnf=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#af46d2b1cf89a70a7e2ef503146c649a9" title="uu0 - original cons.">f_implicit</a>(allowbaseitermethodswitch, iter,borrowf1iter,failreturnallowableuse, whichcall,borrowimpepsjac,showmessages, showmessagesheavy, allowlocalfailurefixandnoreport, &amp;eomtypelocal, whichcap, itermode, baseitermethod, fracenergy, dissmeasure, &amp;radinvmodborrow, trueimptryconv, trueimptryconvabs, trueimpallowconvabs, trueimpmaxiter, realdt, dimtypef, dimfactU, ppborrow, ppborrow, piin, uuborrow, Uiin, uu0, uuborrow, borrowfracdtG*realdt, ptrgeom, qborrow, f1borrow, f1normborrow, f1reportborrow, &amp;goexplicitborrow, &amp;errorabsf1borrow[0], &amp;errorabsf1borrow[1], <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>, &amp;convreturnborrow, nummhdinvsreturn, &amp;tautotmaxreturn, &amp;mtd, &amp;ru);</div>
<div class="line"><a name="l07861"></a><span class="lineno"> 7861</span>&#160;</div>
<div class="line"><a name="l07862"></a><span class="lineno"> 7862</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8369e50da6c81920c90b241974d34e99" title="whether to try using uualt (see f_implicit())">ALLOWUSEUUALT</a>){</div>
<div class="line"><a name="l07863"></a><span class="lineno"> 7863</span>&#160;      <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a11e17cd8b0594d1ad52e3594aa9f477e" title="find ucon, ucov, bcon, bcov from primitive variables when calling get_state, users of this function e...">get_state</a>(pp, ptrgeom, q);</div>
<div class="line"><a name="l07864"></a><span class="lineno"> 7864</span>&#160;      <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a9a54096e4c40a15a2c1bf74266153616" title="calculate &quot;conserved&quot; quantities">primtoU</a>(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab2be21bd5eff40ca89c20eeecbeab5e0">UNOTHING</a>,pp,q,ptrgeom, uu, NULL);</div>
<div class="line"><a name="l07865"></a><span class="lineno"> 7865</span>&#160;    }</div>
<div class="line"><a name="l07866"></a><span class="lineno"> 7866</span>&#160;</div>
<div class="line"><a name="l07867"></a><span class="lineno"> 7867</span>&#160;<span class="preprocessor">#define BORROWTOL (1E-1)</span></div>
<div class="line"><a name="l07868"></a><span class="lineno"> 7868</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l07869"></a><span class="lineno"> 7869</span>&#160;    <span class="comment">// only borrow if error is not order unity and if was and is plenty of energy in radiation to give</span></div>
<div class="line"><a name="l07870"></a><span class="lineno"> 7870</span>&#160;    <span class="comment">// e.g., borrowing from radiation can leave radiation hitting floor, do not improving total energy conservation in such cases.</span></div>
<div class="line"><a name="l07871"></a><span class="lineno"> 7871</span>&#160;    <span class="comment">// or allow shift in radiation energy if only adding energy to radiation</span></div>
<div class="line"><a name="l07872"></a><span class="lineno"> 7872</span>&#160;    <span class="comment">//    if(errorabsf1borrow[WHICHERROR]&lt;BORROWTOL &amp;&amp; ((-uuborrow[URAD0])&gt;(-uuborrow[UU]))   ){}</span></div>
<div class="line"><a name="l07873"></a><span class="lineno"> 7873</span>&#160;    <span class="comment">//    if(errorabsf1borrow[WHICHERROR]&lt;BORROWTOL &amp;&amp; ((-uuborrow[URAD0])&gt;(-dugas) || (-dugas&lt;0.0))   ){</span></div>
<div class="line"><a name="l07874"></a><span class="lineno"> 7874</span>&#160;    <span class="keywordflow">if</span>(radinvmodborrow==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6435e9609d622c9dbaf78c12658ecf8e">UTOPRIMRADNOFAIL</a> &amp;&amp; errorabsf1borrow[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>]&lt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a27aa29f058961f2328be6b440bf1e046">BORROWTOL</a> &amp;&amp; ((-uuborrow[URAD0])&gt;(-dugas) || (-dugas&lt;0.0))   ){</div>
<div class="line"><a name="l07875"></a><span class="lineno"> 7875</span>&#160;      <span class="comment">// then use new solution regardless of how it is correct 4-force, just so energy-momentum can be conserved</span></div>
<div class="line"><a name="l07876"></a><span class="lineno"> 7876</span>&#160;      <span class="comment">// if randinvmodborrow!=0, then not enough radiation energy to give, and would violate energy-momentum conservation anyways, so wait till very end for consfixup_1zone() to fixup things if it can</span></div>
<div class="line"><a name="l07877"></a><span class="lineno"> 7877</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l07878"></a><span class="lineno"> 7878</span>&#160;        uu[pl] = uuborrow[pl];</div>
<div class="line"><a name="l07879"></a><span class="lineno"> 7879</span>&#160;        pp[pl] = ppborrow[pl];</div>
<div class="line"><a name="l07880"></a><span class="lineno"> 7880</span>&#160;      }</div>
<div class="line"><a name="l07881"></a><span class="lineno"> 7881</span>&#160;      errorabsf1[0]=errorabsf1borrow[0];</div>
<div class="line"><a name="l07882"></a><span class="lineno"> 7882</span>&#160;      errorabsf1[1]=errorabsf1borrow[1];</div>
<div class="line"><a name="l07883"></a><span class="lineno"> 7883</span>&#160;<span class="preprocessor">#if(PRODUCTION==0&amp;&amp;0)</span></div>
<div class="line"><a name="l07884"></a><span class="lineno"> 7884</span>&#160;<span class="preprocessor"></span>      <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a7df8286c59d491ba1117884d33499a7a">prod0dualfprintf</a>(1,<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;YESSwitched: %g : uu=%g %g : dugas=%g\n&quot;</span>,errorabsf1borrow[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>],-uuborrow[URAD0],-uuborrow[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>],-dugas);</div>
<div class="line"><a name="l07885"></a><span class="lineno"> 7885</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l07886"></a><span class="lineno"> 7886</span>&#160;<span class="preprocessor"></span>    }</div>
<div class="line"><a name="l07887"></a><span class="lineno"> 7887</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l07888"></a><span class="lineno"> 7888</span>&#160;      <span class="comment">// if not good idea to borrow, still update uu as if did.  Might be able to recover if this is just sub-step being added to bigger step.  Plus, only use uu from here on as diagnostic if implicit solver obtained full solution to primitive inversion (as normal for most RK methods).</span></div>
<div class="line"><a name="l07889"></a><span class="lineno"> 7889</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l07890"></a><span class="lineno"> 7890</span>&#160;        uu[pl] = uuborrow[pl]; <span class="comment">// ensures full energy conservation even when entropy method used.  Or at least, diagnostic will have non-conservation part in &quot;fl&quot;</span></div>
<div class="line"><a name="l07891"></a><span class="lineno"> 7891</span>&#160;      }</div>
<div class="line"><a name="l07892"></a><span class="lineno"> 7892</span>&#160;      </div>
<div class="line"><a name="l07893"></a><span class="lineno"> 7893</span>&#160;<span class="preprocessor">#if(PRODUCTION==0&amp;&amp;0)</span></div>
<div class="line"><a name="l07894"></a><span class="lineno"> 7894</span>&#160;<span class="preprocessor"></span>      <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a7df8286c59d491ba1117884d33499a7a">prod0dualfprintf</a>(1,<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;NOSwitched: %g : uu=%g %g dugas=%g\n&quot;</span>,errorabsf1borrow[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>],-uuborrow[URAD0],-uuborrow[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>],dugas);</div>
<div class="line"><a name="l07895"></a><span class="lineno"> 7895</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l07896"></a><span class="lineno"> 7896</span>&#160;<span class="preprocessor"></span>    }</div>
<div class="line"><a name="l07897"></a><span class="lineno"> 7897</span>&#160;</div>
<div class="line"><a name="l07898"></a><span class="lineno"> 7898</span>&#160;</div>
<div class="line"><a name="l07899"></a><span class="lineno"> 7899</span>&#160;  }<span class="comment">// end if borrowing entropy/energy from radiation to give to gas</span></div>
<div class="line"><a name="l07900"></a><span class="lineno"> 7900</span>&#160;</div>
<div class="line"><a name="l07901"></a><span class="lineno"> 7901</span>&#160;</div>
<div class="line"><a name="l07902"></a><span class="lineno"> 7902</span>&#160;</div>
<div class="line"><a name="l07904"></a><span class="lineno"> 7904</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l07905"></a><span class="lineno"> 7905</span>&#160;  <span class="comment">// in case radinvmod==1 or no solution, force conservation so at least &quot;fl&quot; diagnostic works.</span></div>
<div class="line"><a name="l07906"></a><span class="lineno"> 7906</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l07908"></a><span class="lineno"> 7908</span>&#160;<span class="comment"></span>  <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a33425cd25de3bba0ed1613fd419efefd" title="MHD or RAD baseitermethod types.">IMPMHDTYPEBASE</a>(*baseitermethod)==1){</div>
<div class="line"><a name="l07909"></a><span class="lineno"> 7909</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dugas[4];</div>
<div class="line"><a name="l07910"></a><span class="lineno"> 7910</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) dugas[jj] = uu[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>+jj]-uu0[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>+jj];</div>
<div class="line"><a name="l07911"></a><span class="lineno"> 7911</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) uu[URAD0+jj] = uu0[URAD0+jj] - dugas[jj];</div>
<div class="line"><a name="l07912"></a><span class="lineno"> 7912</span>&#160;  }</div>
<div class="line"><a name="l07913"></a><span class="lineno"> 7913</span>&#160;  <span class="keywordflow">else</span>{<span class="comment">//    IMPRADTYPEBASE(*baseitermethod)</span></div>
<div class="line"><a name="l07914"></a><span class="lineno"> 7914</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> durad[4];</div>
<div class="line"><a name="l07915"></a><span class="lineno"> 7915</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) durad[jj] = uu[URAD0+jj]-uu0[URAD0+jj];</div>
<div class="line"><a name="l07916"></a><span class="lineno"> 7916</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) uu[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>+jj] = uu0[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>+jj] - durad[jj];    </div>
<div class="line"><a name="l07917"></a><span class="lineno"> 7917</span>&#160;  }</div>
<div class="line"><a name="l07918"></a><span class="lineno"> 7918</span>&#160;</div>
<div class="line"><a name="l07919"></a><span class="lineno"> 7919</span>&#160;</div>
<div class="line"><a name="l07921"></a><span class="lineno"> 7921</span>&#160;  <span class="comment">// ensure if failed that no changes in quantities</span></div>
<div class="line"><a name="l07923"></a><span class="lineno"> 7923</span>&#160;<span class="comment"></span>  <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a6ce9f5de6e575be785e5f053882a0909">ACCEPTASNOFAILURE</a>(failreturn)==0){</div>
<div class="line"><a name="l07924"></a><span class="lineno"> 7924</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) uu[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>+jj] = uu0[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>+jj];</div>
<div class="line"><a name="l07925"></a><span class="lineno"> 7925</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) uu[URAD0+jj] = uu0[URAD0+jj];</div>
<div class="line"><a name="l07926"></a><span class="lineno"> 7926</span>&#160;    <span class="keywordflow">if</span>(ENTROPY&gt;=0) uu[ENTROPY] = uu0[ENTROPY];</div>
<div class="line"><a name="l07927"></a><span class="lineno"> 7927</span>&#160;  }</div>
<div class="line"><a name="l07929"></a><span class="lineno"> 7929</span>&#160;  <span class="comment">// if cold method, then entropy change infinite.  Modify so no change in entropy.  Ok, because not using entropy conservation here.  Just need evolution of entropy to be reasonable in case revert to it, and also want ener diagnostics to be reasonable and show conservation properties of entropy.</span></div>
<div class="line"><a name="l07930"></a><span class="lineno"> 7930</span>&#160;  <span class="comment">// constant uu[ENTROPY] consistent with eventually averaging internal energy to get close to original internal energy (i.e. rather than formally zero).</span></div>
<div class="line"><a name="l07932"></a><span class="lineno"> 7932</span>&#160;<span class="comment"></span>  <span class="keywordflow">if</span>(*eomtype==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a757ad8b9c2c7611dad8aab853a87f61b">EOMCOLDGRMHD</a>){</div>
<div class="line"><a name="l07933"></a><span class="lineno"> 7933</span>&#160;    <span class="keywordflow">if</span>(ENTROPY&gt;=0) uu[ENTROPY]=uu0[ENTROPY];</div>
<div class="line"><a name="l07934"></a><span class="lineno"> 7934</span>&#160;  }</div>
<div class="line"><a name="l07935"></a><span class="lineno"> 7935</span>&#160;</div>
<div class="line"><a name="l07936"></a><span class="lineno"> 7936</span>&#160;</div>
<div class="line"><a name="l07937"></a><span class="lineno"> 7937</span>&#160;</div>
<div class="line"><a name="l07939"></a><span class="lineno"> 7939</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l07940"></a><span class="lineno"> 7940</span>&#160;  <span class="comment">// if didn&#39;t fail to get some reasonable solution, then now can use it.</span></div>
<div class="line"><a name="l07941"></a><span class="lineno"> 7941</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l07943"></a><span class="lineno"> 7943</span>&#160;<span class="comment"></span>  <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a6ce9f5de6e575be785e5f053882a0909">ACCEPTASNOFAILURE</a>(failreturn)==1){</div>
<div class="line"><a name="l07944"></a><span class="lineno"> 7944</span>&#160;</div>
<div class="line"><a name="l07946"></a><span class="lineno"> 7946</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l07947"></a><span class="lineno"> 7947</span>&#160;    <span class="comment">// get source update as &quot;dU&quot; = dU/dt using real dt that used during implicit iterations, and will eventually use to update U in advance.c.</span></div>
<div class="line"><a name="l07948"></a><span class="lineno"> 7948</span>&#160;    <span class="comment">// apply source update as force</span></div>
<div class="line"><a name="l07949"></a><span class="lineno"> 7949</span>&#160;    <span class="comment">// KORALNOTE: As long as f_implicit() updates both full primitive and full U, using uu below is fine and good.</span></div>
<div class="line"><a name="l07950"></a><span class="lineno"> 7950</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) radsource[pl] = +(uu[pl]-uu0[pl])/realdt;</div>
<div class="line"><a name="l07951"></a><span class="lineno"> 7951</span>&#160;    <span class="comment">// KORALNOTE: Could re-enforce energy conservation here, but would be inconsistenet with how applied error function.</span></div>
<div class="line"><a name="l07952"></a><span class="lineno"> 7952</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a9afde1f1647e18e733406a1566b8b550">PLOOPBONLY</a>(pl) radsource[pl]  = 0.0; <span class="comment">// force to machine accuracy</span></div>
<div class="line"><a name="l07953"></a><span class="lineno"> 7953</span>&#160;</div>
<div class="line"><a name="l07954"></a><span class="lineno"> 7954</span>&#160;    </div>
<div class="line"><a name="l07955"></a><span class="lineno"> 7955</span>&#160;    <span class="comment">//    DLOOPA(ii) radsource[ru.iotherU[ii]] = -radsource[ru.erefU[ii]]; // force energy conservation (NOTEMARK: Unsure if optimal since loop iterates and might break this for good reason -- e.g. no exactly valid corresponding MHD solution if iterating URAD)</span></div>
<div class="line"><a name="l07956"></a><span class="lineno"> 7956</span>&#160;</div>
<div class="line"><a name="l07957"></a><span class="lineno"> 7957</span>&#160;</div>
<div class="line"><a name="l07958"></a><span class="lineno"> 7958</span>&#160;    <span class="comment">// OLD, but misses rho changes due to u^t changes:</span></div>
<div class="line"><a name="l07959"></a><span class="lineno"> 7959</span>&#160;    <span class="comment">//  DLOOPA(jj) radsource[ru.iotherU[jj]]  = -(uu[ru.irefU[jj]]-uu0[ru.irefU[jj]])/realdt;</span></div>
<div class="line"><a name="l07960"></a><span class="lineno"> 7960</span>&#160;    <span class="comment">//  DLOOPA(jj) radsource[ru.irefU[jj]]    = +(uu[ru.irefU[jj]]-uu0[ru.irefU[jj]])/realdt;</span></div>
<div class="line"><a name="l07961"></a><span class="lineno"> 7961</span>&#160;</div>
<div class="line"><a name="l07962"></a><span class="lineno"> 7962</span>&#160;</div>
<div class="line"><a name="l07963"></a><span class="lineno"> 7963</span>&#160;    <span class="comment">// DEBUG:</span></div>
<div class="line"><a name="l07964"></a><span class="lineno"> 7964</span>&#160;    <span class="comment">//  DLOOPA(jj) dualfprintf(fail_file,&quot;nstep=%ld steppart=%d i=%d implicitGd[%d]=%g %g\n&quot;,nstep,steppart,ptrgeom-&gt;i,jj,radsource[ru.iotherU[jj]],radsource[ru.irefU[jj]]);</span></div>
<div class="line"><a name="l07965"></a><span class="lineno"> 7965</span>&#160;</div>
<div class="line"><a name="l07966"></a><span class="lineno"> 7966</span>&#160;</div>
<div class="line"><a name="l07968"></a><span class="lineno"> 7968</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l07969"></a><span class="lineno"> 7969</span>&#160;    <span class="comment">// store source update in dUcomp for return.</span></div>
<div class="line"><a name="l07970"></a><span class="lineno"> 7970</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l07972"></a><span class="lineno"> 7972</span>&#160;<span class="comment"></span>    sc = <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab130f34dd5996718289efe08bc68b518">RADSOURCE</a>;</div>
<div class="line"><a name="l07973"></a><span class="lineno"> 7973</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) dUcomp[sc][pl] += radsource[pl];</div>
<div class="line"><a name="l07974"></a><span class="lineno"> 7974</span>&#160;</div>
<div class="line"><a name="l07976"></a><span class="lineno"> 7976</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l07977"></a><span class="lineno"> 7977</span>&#160;    <span class="comment">// save better guess for later inversion from this inversion</span></div>
<div class="line"><a name="l07978"></a><span class="lineno"> 7978</span>&#160;    <span class="comment">// pp was modified by f_implicit(f1,pp) with output from inversion returned through pp0</span></div>
<div class="line"><a name="l07979"></a><span class="lineno"> 7979</span>&#160;    <span class="comment">// only use pp if successful with implicit method, since if not successful can be various bad reasons with no good pb</span></div>
<div class="line"><a name="l07980"></a><span class="lineno"> 7980</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l07982"></a><span class="lineno"> 7982</span>&#160;<span class="comment"></span>    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l07983"></a><span class="lineno"> 7983</span>&#160;      pb[pl]=pp[pl]; <span class="comment">// actual solution that&#39;s used</span></div>
<div class="line"><a name="l07984"></a><span class="lineno"> 7984</span>&#160;      uub[pl]=uu[pl]; <span class="comment">// used for getting whether solution really worked and switching methods, etc.</span></div>
<div class="line"><a name="l07985"></a><span class="lineno"> 7985</span>&#160;    }</div>
<div class="line"><a name="l07986"></a><span class="lineno"> 7986</span>&#160;</div>
<div class="line"><a name="l07987"></a><span class="lineno"> 7987</span>&#160;    <span class="comment">// DEBUG:</span></div>
<div class="line"><a name="l07988"></a><span class="lineno"> 7988</span>&#160;    <span class="comment">//  PLOOP(pliter,pl) dualfprintf(fail_file,&quot;POOP2: pl=%d uu=%21.15g uu0=%21.15g piin=%21.15g pb=%21.15g\n&quot;,pl,uu[pl],uu0[pl],piin[pl],pb[pl]);</span></div>
<div class="line"><a name="l07989"></a><span class="lineno"> 7989</span>&#160;</div>
<div class="line"><a name="l07991"></a><span class="lineno"> 7991</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l07992"></a><span class="lineno"> 7992</span>&#160;    <span class="comment">// choose new eomtype for external inverison or other checks</span></div>
<div class="line"><a name="l07993"></a><span class="lineno"> 7993</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l07994"></a><span class="lineno"> 7994</span>&#160;    <span class="comment">// This ensures whatever implicit solver settled on using, the external inversion doesn&#39;t switch.</span></div>
<div class="line"><a name="l07995"></a><span class="lineno"> 7995</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l07997"></a><span class="lineno"> 7997</span>&#160;<span class="comment"></span>    *eomtype=eomtypelocal;</div>
<div class="line"><a name="l07998"></a><span class="lineno"> 7998</span>&#160;</div>
<div class="line"><a name="l07999"></a><span class="lineno"> 7999</span>&#160;</div>
<div class="line"><a name="l08000"></a><span class="lineno"> 8000</span>&#160;</div>
<div class="line"><a name="l08001"></a><span class="lineno"> 8001</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ac640fcdc491ef83fb24e6f69193d910e" title="whether to use EOMDONOTHING if error is good enough.">SWITCHTODONOTHING</a>){</div>
<div class="line"><a name="l08002"></a><span class="lineno"> 8002</span>&#160;      <span class="comment">// always do nothing, so entropy won&#39;t try to revert to cold.</span></div>
<div class="line"><a name="l08003"></a><span class="lineno"> 8003</span>&#160;      <span class="keywordflow">if</span>(*eomtype==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a40b55e98bfcccde1a3f19d983ca7488c">EOMENTROPYGRMHD</a>) *eomtype=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a74427604dbc716cea325f65f5c927662">EOMDIDENTROPYGRMHD</a>;</div>
<div class="line"><a name="l08004"></a><span class="lineno"> 8004</span>&#160;      <span class="keywordflow">if</span>(*eomtype==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a757ad8b9c2c7611dad8aab853a87f61b">EOMCOLDGRMHD</a>) *eomtype=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a32a2f53eca0d980049cee1dd4680aa00">EOMDIDCOLDGRMHD</a>;</div>
<div class="line"><a name="l08005"></a><span class="lineno"> 8005</span>&#160;      <span class="keywordflow">if</span>(*eomtype==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a03d89f51ab60206791830c886d62bfd0">EOMGRMHD</a>) *eomtype=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a04d93d33dd8dba356800fa12cb80064e">EOMDIDGRMHD</a>;</div>
<div class="line"><a name="l08006"></a><span class="lineno"> 8006</span>&#160;    }</div>
<div class="line"><a name="l08007"></a><span class="lineno"> 8007</span>&#160;</div>
<div class="line"><a name="l08008"></a><span class="lineno"> 8008</span>&#160;  }<span class="comment">// end if didn&#39;t fail, so can set final solution.</span></div>
<div class="line"><a name="l08009"></a><span class="lineno"> 8009</span>&#160;</div>
<div class="line"><a name="l08010"></a><span class="lineno"> 8010</span>&#160;</div>
<div class="line"><a name="l08011"></a><span class="lineno"> 8011</span>&#160;</div>
<div class="line"><a name="l08012"></a><span class="lineno"> 8012</span>&#160;</div>
<div class="line"><a name="l08013"></a><span class="lineno"> 8013</span>&#160;</div>
<div class="line"><a name="l08014"></a><span class="lineno"> 8014</span>&#160;</div>
<div class="line"><a name="l08015"></a><span class="lineno"> 8015</span>&#160;</div>
<div class="line"><a name="l08017"></a><span class="lineno"> 8017</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l08018"></a><span class="lineno"> 8018</span>&#160;  <span class="comment">// Return error and iterations and fail mode</span></div>
<div class="line"><a name="l08019"></a><span class="lineno"> 8019</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l08021"></a><span class="lineno"> 8021</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l08022"></a><span class="lineno"> 8022</span>&#160;  <span class="comment">// report error no matter whether got solution or not.</span></div>
<div class="line"><a name="l08023"></a><span class="lineno"> 8023</span>&#160;  errorabsreturn[0]=errorabsf1[0];</div>
<div class="line"><a name="l08024"></a><span class="lineno"> 8024</span>&#160;  errorabsreturn[1]=errorabsf1[1];</div>
<div class="line"><a name="l08025"></a><span class="lineno"> 8025</span>&#160;</div>
<div class="line"><a name="l08026"></a><span class="lineno"> 8026</span>&#160;  <span class="comment">// report iters not matter what the error.</span></div>
<div class="line"><a name="l08027"></a><span class="lineno"> 8027</span>&#160;  *itersreturn=totaliters;</div>
<div class="line"><a name="l08028"></a><span class="lineno"> 8028</span>&#160;</div>
<div class="line"><a name="l08029"></a><span class="lineno"> 8029</span>&#160;  *nummhdstepsreturn = (int)(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a5f1c4a4bf07f7a6010404484cb9e6b50">nstroke</a>-nstrokeorig); <span class="comment">// get number of mhd inversion steps</span></div>
<div class="line"><a name="l08030"></a><span class="lineno"> 8030</span>&#160;</div>
<div class="line"><a name="l08031"></a><span class="lineno"> 8031</span>&#160;</div>
<div class="line"><a name="l08032"></a><span class="lineno"> 8032</span>&#160;</div>
<div class="line"><a name="l08033"></a><span class="lineno"> 8033</span>&#160;</div>
<div class="line"><a name="l08034"></a><span class="lineno"> 8034</span>&#160;  <span class="comment">// check if uncaught nan/inf</span></div>
<div class="line"><a name="l08035"></a><span class="lineno"> 8035</span>&#160;  <span class="keywordtype">int</span> caughtnan=0;</div>
<div class="line"><a name="l08036"></a><span class="lineno"> 8036</span>&#160;  <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9aa23a9a2b28d2c91e90a06c0025e91f">PLOOPDYNAMICAL</a>(pliter,pl){</div>
<div class="line"><a name="l08037"></a><span class="lineno"> 8037</span>&#160;    <span class="keywordflow">if</span>(!<a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(pb[pl])) caughtnan++;</div>
<div class="line"><a name="l08038"></a><span class="lineno"> 8038</span>&#160;    <span class="keywordflow">if</span>(!<a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(uub[pl])) caughtnan++;</div>
<div class="line"><a name="l08039"></a><span class="lineno"> 8039</span>&#160;    <span class="keywordflow">if</span>(!<a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(dUcomp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab130f34dd5996718289efe08bc68b518">RADSOURCE</a>][pl])) caughtnan++;</div>
<div class="line"><a name="l08040"></a><span class="lineno"> 8040</span>&#160;  }</div>
<div class="line"><a name="l08041"></a><span class="lineno"> 8041</span>&#160;  <span class="keywordflow">if</span>(!<a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(errorabsreturn[0])) caughtnan++;  </div>
<div class="line"><a name="l08042"></a><span class="lineno"> 8042</span>&#160;  <span class="keywordflow">if</span>(!<a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(errorabsreturn[1])) caughtnan++;  </div>
<div class="line"><a name="l08043"></a><span class="lineno"> 8043</span>&#160;</div>
<div class="line"><a name="l08044"></a><span class="lineno"> 8044</span>&#160;  <span class="keywordflow">if</span>(caughtnan){</div>
<div class="line"><a name="l08045"></a><span class="lineno"> 8045</span>&#160;    <span class="comment">// this doesn&#39;t seem to be hit even on Kraken</span></div>
<div class="line"><a name="l08046"></a><span class="lineno"> 8046</span>&#160;    <span class="keywordflow">if</span>(debugfail&gt;=2){</div>
<div class="line"><a name="l08047"></a><span class="lineno"> 8047</span>&#160;      dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;per mode implicit solver generated nan result and it wasn&#39;t caught\n&quot;</span>);</div>
<div class="line"><a name="l08048"></a><span class="lineno"> 8048</span>&#160;      dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;per mode implicit solver: %d %d %d %d %d %d %d %d : %g %g %g : %d %d : %g %g : %d\n&quot;</span>,allowbaseitermethodswitch, modprim, havebackup, didentropyalready, *eomtype, whichcap, itermode, *baseitermethod, trueimptryconv, trueimpokconv, trueimpallowconv, trueimpmaxiter, truenumdampattempts, fracenergy, dissmeasure, *radinvmod);</div>
<div class="line"><a name="l08049"></a><span class="lineno"> 8049</span>&#160;      <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9aa23a9a2b28d2c91e90a06c0025e91f">PLOOPDYNAMICAL</a>(pliter,pl) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;0implicit solver: pl=%d Uiin=%21.15g dUother=%21.15g dU=%21.15g\n&quot;</span>,pl,Uiin[pl],dUother[pl],dUcomp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab130f34dd5996718289efe08bc68b518">RADSOURCE</a>][pl]);</div>
<div class="line"><a name="l08050"></a><span class="lineno"> 8050</span>&#160;      <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9aa23a9a2b28d2c91e90a06c0025e91f">PLOOPDYNAMICAL</a>(pliter,pl) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;1implicit solver: pl=%d pb=%21.15g piin=%21.15g Ufin=%21.15g dU=%21.15g uub=%21.15g\n&quot;</span>,pl,pb[pl],piin[pl],Ufin[pl],dUcomp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab130f34dd5996718289efe08bc68b518">RADSOURCE</a>][pl],uub[pl]);</div>
<div class="line"><a name="l08051"></a><span class="lineno"> 8051</span>&#160;      <span class="keywordtype">int</span> jjj;</div>
<div class="line"><a name="l08052"></a><span class="lineno"> 8052</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jjj) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;2implicit solver: jj=%d ucon=%21.15g ucov=%21.15g uradcon=%21.15g uradcov=%21.15g\n&quot;</span>,jj,q-&gt;<a class="code" href="../../d1/d83/structof__state.html#aab723d3c7c2c48b7246cc7d7d5379eed">ucon</a>[jj],q-&gt;<a class="code" href="../../d1/d83/structof__state.html#a09881c3d05809ef27f8115d02a835e11">ucov</a>[jj],q-&gt;<a class="code" href="../../d1/d83/structof__state.html#a3bf8e15ee6ae95831230791baf2fc570">uradcon</a>[jj],q-&gt;<a class="code" href="../../d1/d83/structof__state.html#a87c04c4f890495e87a6682643a0c7955">uradcov</a>[jj]);</div>
<div class="line"><a name="l08053"></a><span class="lineno"> 8053</span>&#160;    }</div>
<div class="line"><a name="l08054"></a><span class="lineno"> 8054</span>&#160;    <span class="comment">// reset solution as bad error, so conditions don&#39;t get confused by nan always giving false</span></div>
<div class="line"><a name="l08055"></a><span class="lineno"> 8055</span>&#160;    errorabsreturn[0]=1.0;</div>
<div class="line"><a name="l08056"></a><span class="lineno"> 8056</span>&#160;    errorabsreturn[1]=1.0;</div>
<div class="line"><a name="l08057"></a><span class="lineno"> 8057</span>&#160;</div>
<div class="line"><a name="l08058"></a><span class="lineno"> 8058</span>&#160;    failreturn=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab0abd953f677a44020dc50259c410486">FAILRETURNGENERAL</a>;</div>
<div class="line"><a name="l08059"></a><span class="lineno"> 8059</span>&#160;  }</div>
<div class="line"><a name="l08060"></a><span class="lineno"> 8060</span>&#160; </div>
<div class="line"><a name="l08061"></a><span class="lineno"> 8061</span>&#160;</div>
<div class="line"><a name="l08062"></a><span class="lineno"> 8062</span>&#160;</div>
<div class="line"><a name="l08064"></a><span class="lineno"> 8064</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l08065"></a><span class="lineno"> 8065</span>&#160;  <span class="comment">// report any bad failure (using previously set mathfailtype value)</span></div>
<div class="line"><a name="l08066"></a><span class="lineno"> 8066</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l08068"></a><span class="lineno"> 8068</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l08069"></a><span class="lineno"> 8069</span>&#160;  <span class="comment">// for checking cases where tau&gt;=1 but still Erf&lt;0</span></div>
<div class="line"><a name="l08070"></a><span class="lineno"> 8070</span>&#160;  <span class="comment">//  FTYPE tautot[NDIM],tautotmax;</span></div>
<div class="line"><a name="l08071"></a><span class="lineno"> 8071</span>&#160;  <span class="comment">//  calc_tautot(pp, ptrgeom, q, tautot, &amp;tautotmax);</span></div>
<div class="line"><a name="l08072"></a><span class="lineno"> 8072</span>&#160;  <span class="comment">//  //  if(tautotmax&gt;1 &amp;&amp; pp[PRAD0]&lt;10.0*ERADLIMIT){</span></div>
<div class="line"><a name="l08073"></a><span class="lineno"> 8073</span>&#160;  <span class="comment">//  if(tautotmax&gt;2 &amp;&amp; pp[PRAD0]&lt;10.0*ERADLIMIT){</span></div>
<div class="line"><a name="l08074"></a><span class="lineno"> 8074</span>&#160;</div>
<div class="line"><a name="l08075"></a><span class="lineno"> 8075</span>&#160;</div>
<div class="line"><a name="l08076"></a><span class="lineno"> 8076</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#a6fc838c14c5e9fc17d6d8bb3d868ec2f">PRODUCTION</a>==0 &amp;&amp; <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ac2a8331792f5389e74e3b2865c305e6e">NOTACTUALFAILURE</a>(failreturn)==0 &amp;&amp; errorabsf1[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>]&gt;=trueimptryconvalt || <a class="code" href="../../da/d3e/definit_8h.html#a6fc838c14c5e9fc17d6d8bb3d868ec2f">PRODUCTION</a>==0 &amp;&amp; <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a1a5416db138e03cc24de865e636341e7">NOTBADFAILURE</a>(failreturn)==0 &amp;&amp; havebackup==0){ <span class="comment">// as in previous code</span></div>
<div class="line"><a name="l08077"></a><span class="lineno"> 8077</span>&#160;</div>
<div class="line"><a name="l08078"></a><span class="lineno"> 8078</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;ERRORCHECK: pl=%d f1=%21.15g f1norm=%21.15g f1report=%21.15g errorabsf1=%21.15g errorallabsf1=%21.15g\n&quot;</span>,pl,f1[pl],f1norm[pl],f1report[pl],errorabsf1[0],errorabsf1[1]);</div>
<div class="line"><a name="l08079"></a><span class="lineno"> 8079</span>&#160; </div>
<div class="line"><a name="l08080"></a><span class="lineno"> 8080</span>&#160;</div>
<div class="line"><a name="l08081"></a><span class="lineno"> 8081</span>&#160;</div>
<div class="line"><a name="l08082"></a><span class="lineno"> 8082</span>&#160;  <span class="comment">// for seeing Erf&lt;0 and small errors not tol errors.</span></div>
<div class="line"><a name="l08083"></a><span class="lineno"> 8083</span>&#160;  <span class="comment">//  if(failreturn!=FAILRETURNMODESWITCH &amp;&amp; (pp[PRAD0]&lt;10.0*ERADLIMIT) || PRODUCTION==0 &amp;&amp; NOTACTUALFAILURE(failreturn)==0 &amp;&amp; errorabsf1[WHICHERROR]&gt;=trueimptryconvalt || PRODUCTION&gt;0 &amp;&amp; NOTBADFAILURE(failreturn)==0 &amp;&amp; havebackup==0){</span></div>
<div class="line"><a name="l08084"></a><span class="lineno"> 8084</span>&#160;</div>
<div class="line"><a name="l08085"></a><span class="lineno"> 8085</span>&#160;  <span class="comment">// for catching oscillators at small error but still &gt;tol.</span></div>
<div class="line"><a name="l08086"></a><span class="lineno"> 8086</span>&#160;  <span class="comment">//  if(PRODUCTION==0 &amp;&amp; NOTACTUALFAILURE(failreturn)==0 || PRODUCTION&gt;0 &amp;&amp; NOTBADFAILURE(failreturn)==0){</span></div>
<div class="line"><a name="l08087"></a><span class="lineno"> 8087</span>&#160;</div>
<div class="line"><a name="l08088"></a><span class="lineno"> 8088</span>&#160;</div>
<div class="line"><a name="l08089"></a><span class="lineno"> 8089</span>&#160;  <span class="comment">//    if(REPORTERFNEG &amp;&amp; failreturn!=FAILRETURNMODESWITCH &amp;&amp; (pp[PRAD0]&lt;10.0*ERADLIMIT || RADINVBAD(*radinvmod) ) || PRODUCTION==0 &amp;&amp; NOTACTUALFAILURE(failreturn)==0 &amp;&amp; errorabsf1[WHICHERROR]&gt;=trueimptryconvalt || PRODUCTION&gt;0 &amp;&amp; NOTBADFAILURE(failreturn)==0 &amp;&amp; havebackup==0){</span></div>
<div class="line"><a name="l08090"></a><span class="lineno"> 8090</span>&#160;  <span class="comment">//  if(REPORTERFNEG &amp;&amp; failreturn!=FAILRETURNMODESWITCH &amp;&amp; (pp[PRAD0]&lt;10.0*ERADLIMIT) || PRODUCTION==0 &amp;&amp; NOTACTUALFAILURE(failreturn)==0 &amp;&amp; errorabsf1[WHICHERROR]&gt;=trueimptryconvalt || PRODUCTION&gt;0 &amp;&amp; NOTBADFAILURE(failreturn)==0 &amp;&amp; havebackup==0){</span></div>
<div class="line"><a name="l08091"></a><span class="lineno"> 8091</span>&#160;    <span class="comment">//    if(NOTBADFAILURE(failreturn)==0){</span></div>
<div class="line"><a name="l08092"></a><span class="lineno"> 8092</span>&#160;    <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> qcheck; <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a11e17cd8b0594d1ad52e3594aa9f477e" title="find ucon, ucov, bcon, bcov from primitive variables when calling get_state, users of this function e...">get_state</a>(pp, ptrgeom, &amp;qcheck);  <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a9a54096e4c40a15a2c1bf74266153616" title="calculate &quot;conserved&quot; quantities">primtoU</a>(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab2be21bd5eff40ca89c20eeecbeab5e0">UNOTHING</a>,pp,&amp;qcheck,ptrgeom, uu, NULL);</div>
<div class="line"><a name="l08093"></a><span class="lineno"> 8093</span>&#160;    failnum++; mathematica_report_check(*radinvmod, mathfailtype, failnum, gotfirstnofail, eomtypelocal, itermode, *baseitermethod, errorabsf1, errorabsbestexternal, iter, totaliters, realdt, ptrgeom, ppfirst,pp,pb,piin,prtestUiin,prtestUU0,uu0,uu,Uiin,Ufin, CUf, CUimp, q, dUother);</div>
<div class="line"><a name="l08094"></a><span class="lineno"> 8094</span>&#160;<span class="preprocessor">#if(DEBUGMAXITER)</span></div>
<div class="line"><a name="l08095"></a><span class="lineno"> 8095</span>&#160;<span class="preprocessor"></span>    <span class="keywordtype">int</span> usedebugiter=debugiteratteempts[0];</div>
<div class="line"><a name="l08096"></a><span class="lineno"> 8096</span>&#160;    showdebuglist(usedebugiter,pppreholdlist,ppposholdlist,f1reportlist,f1list,errorabsf1list,errorallabsf1list,realiterlist,jaclist,fracdamplist,implicititerlist, implicitferrlist);</div>
<div class="line"><a name="l08097"></a><span class="lineno"> 8097</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l08098"></a><span class="lineno"> 8098</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l08099"></a><span class="lineno"> 8099</span>&#160;    <span class="comment">// report how much MHD inversion used when failed</span></div>
<div class="line"><a name="l08100"></a><span class="lineno"> 8100</span>&#160;    dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;nummhdinvsreturn=%d nummhdstepsreturn=%d nstroke=%d\n&quot;</span>,*nummhdinvsreturn,*nummhdstepsreturn,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a5f1c4a4bf07f7a6010404484cb9e6b50">nstroke</a>);</div>
<div class="line"><a name="l08101"></a><span class="lineno"> 8101</span>&#160;  }</div>
<div class="line"><a name="l08102"></a><span class="lineno"> 8102</span>&#160;</div>
<div class="line"><a name="l08103"></a><span class="lineno"> 8103</span>&#160;</div>
<div class="line"><a name="l08104"></a><span class="lineno"> 8104</span>&#160;</div>
<div class="line"><a name="l08105"></a><span class="lineno"> 8105</span>&#160;</div>
<div class="line"><a name="l08106"></a><span class="lineno"> 8106</span>&#160;</div>
<div class="line"><a name="l08108"></a><span class="lineno"> 8108</span>&#160;  <span class="keywordflow">return</span>(failreturn);</div>
<div class="line"><a name="l08109"></a><span class="lineno"> 8109</span>&#160;  </div>
<div class="line"><a name="l08110"></a><span class="lineno"> 8110</span>&#160;}</div>
<div class="line"><a name="l08111"></a><span class="lineno"> 8111</span>&#160;</div>
<div class="line"><a name="l08112"></a><span class="lineno"> 8112</span>&#160;</div>
<div class="line"><a name="l08113"></a><span class="lineno"> 8113</span>&#160;</div>
<div class="line"><a name="l08114"></a><span class="lineno"> 8114</span>&#160;</div>
<div class="line"><a name="l08115"></a><span class="lineno"> 8115</span>&#160;</div>
<div class="line"><a name="l08116"></a><span class="lineno"> 8116</span>&#160;</div>
<div class="line"><a name="l08117"></a><span class="lineno"> 8117</span>&#160;</div>
<div class="line"><a name="l08118"></a><span class="lineno"> 8118</span>&#160;</div>
<div class="line"><a name="l08119"></a><span class="lineno"> 8119</span>&#160;</div>
<div class="line"><a name="l08120"></a><span class="lineno"> 8120</span>&#160;</div>
<div class="line"><a name="l08121"></a><span class="lineno"> 8121</span>&#160;</div>
<div class="line"><a name="l08122"></a><span class="lineno"> 8122</span>&#160;</div>
<div class="line"><a name="l08125"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a4b05614472c7005253be13002e1fab23"> 8125</a></span>&#160;<span class="preprocessor">#define DEBUGMAXMODE 1</span></div>
<div class="line"><a name="l08126"></a><span class="lineno"> 8126</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l08128"></a><span class="lineno"> 8128</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> showdebuglist(<span class="keywordtype">int</span> debugiter, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pppreholdlist)[NPR],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*ppposholdlist)[NPR],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*f1reportlist)[NPR],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*f1list)[NPR],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *errorabsf1list,<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *errorallabsf1list, <span class="keywordtype">int</span> *realiterlist, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*jaclist)[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8a1b3014b620253123af842109580dfe">JACNPR</a>][<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8a1b3014b620253123af842109580dfe">JACNPR</a>], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *fracdamplist, <span class="keywordtype">int</span> *implicititerlist, <span class="keywordtype">int</span> *implicitferrlist)</div>
<div class="line"><a name="l08129"></a><span class="lineno"> 8129</span>&#160;{</div>
<div class="line"><a name="l08130"></a><span class="lineno"> 8130</span>&#160;</div>
<div class="line"><a name="l08131"></a><span class="lineno"> 8131</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a586faef01165fe8c975094a5feaca256" title="whether to store steps for primitive and so debug max iteration cases">DEBUGMAXITER</a>==0) <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l08132"></a><span class="lineno"> 8132</span>&#160;</div>
<div class="line"><a name="l08133"></a><span class="lineno"> 8133</span>&#160;  <span class="keywordtype">int</span> listiter;</div>
<div class="line"><a name="l08134"></a><span class="lineno"> 8134</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a4b05614472c7005253be13002e1fab23" title="0 : full 1: optimal">DEBUGMAXMODE</a>==0) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;%3s : %3s : %21s %21s %21s %21s %21s %21s %21s %21s %21s : %21s %21s %21s %21s %21s %21s %21s %21s %21s : %21s %21s %21s %21s : %21s %21s : %21s\n&quot;</span>,<span class="stringliteral">&quot;li&quot;</span>,<span class="stringliteral">&quot;ri&quot;</span>,<span class="stringliteral">&quot;rho&quot;</span>,<span class="stringliteral">&quot;ug&quot;</span>,<span class="stringliteral">&quot;v1&quot;</span>,<span class="stringliteral">&quot;v2&quot;</span>,<span class="stringliteral">&quot;v3&quot;</span>,<span class="stringliteral">&quot;Erf&quot;</span>,<span class="stringliteral">&quot;vr1&quot;</span>,<span class="stringliteral">&quot;vr2&quot;</span>,<span class="stringliteral">&quot;vr3&quot;</span>,<span class="stringliteral">&quot;rho&quot;</span>,<span class="stringliteral">&quot;ug&quot;</span>,<span class="stringliteral">&quot;v1&quot;</span>,<span class="stringliteral">&quot;v2&quot;</span>,<span class="stringliteral">&quot;v3&quot;</span>,<span class="stringliteral">&quot;Erf&quot;</span>,<span class="stringliteral">&quot;vr1&quot;</span>,<span class="stringliteral">&quot;vr2&quot;</span>,<span class="stringliteral">&quot;vr3&quot;</span>,<span class="stringliteral">&quot;f1rep0&quot;</span>,<span class="stringliteral">&quot;f1rep1&quot;</span>,<span class="stringliteral">&quot;f1rep2&quot;</span>,<span class="stringliteral">&quot;f1rep3&quot;</span>,<span class="stringliteral">&quot;errorabs&quot;</span>,<span class="stringliteral">&quot;errorallabs&quot;</span>,<span class="stringliteral">&quot;umin&quot;</span>);</div>
<div class="line"><a name="l08135"></a><span class="lineno"> 8135</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a4b05614472c7005253be13002e1fab23" title="0 : full 1: optimal">DEBUGMAXMODE</a>==1) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;%3s : %3s : %21s %21s %21s %21s %21s %21s %21s %21s %21s : %21s %21s : %21s %21s %21s %21s %21s %21s %21s %21s %21s %21s %21s %21s : %21s %21s %21s %21s %21s %21s %21s %21s %21s %21s %21s %21s : %21s %21s : %21s : %21s %21s %21s %21s : %21s %21s %21s : %2d %2d\n&quot;</span>,<span class="stringliteral">&quot;li&quot;</span>,<span class="stringliteral">&quot;ri&quot;</span>,<span class="stringliteral">&quot;rho&quot;</span>,<span class="stringliteral">&quot;ug&quot;</span>,<span class="stringliteral">&quot;v1&quot;</span>,<span class="stringliteral">&quot;v2&quot;</span>,<span class="stringliteral">&quot;v3&quot;</span>,<span class="stringliteral">&quot;Erf&quot;</span>,<span class="stringliteral">&quot;vr1&quot;</span>,<span class="stringliteral">&quot;vr2&quot;</span>,<span class="stringliteral">&quot;vr3&quot;</span>,<span class="stringliteral">&quot;rho&quot;</span>,<span class="stringliteral">&quot;ug&quot;</span>,<span class="stringliteral">&quot;f0&quot;</span>,<span class="stringliteral">&quot;f1&quot;</span>,<span class="stringliteral">&quot;f2&quot;</span>,<span class="stringliteral">&quot;f3&quot;</span>,<span class="stringliteral">&quot;f4&quot;</span>,<span class="stringliteral">&quot;f5&quot;</span>,<span class="stringliteral">&quot;f6&quot;</span>,<span class="stringliteral">&quot;f7&quot;</span>,<span class="stringliteral">&quot;f8&quot;</span>,<span class="stringliteral">&quot;f9&quot;</span>,<span class="stringliteral">&quot;f10&quot;</span>,<span class="stringliteral">&quot;f11&quot;</span>,<span class="stringliteral">&quot;frep0&quot;</span>,<span class="stringliteral">&quot;frep1&quot;</span>,<span class="stringliteral">&quot;frep2&quot;</span>,<span class="stringliteral">&quot;frep3&quot;</span>,<span class="stringliteral">&quot;frep4&quot;</span>,<span class="stringliteral">&quot;frep5&quot;</span>,<span class="stringliteral">&quot;frep6&quot;</span>,<span class="stringliteral">&quot;frep7&quot;</span>,<span class="stringliteral">&quot;frep8&quot;</span>,<span class="stringliteral">&quot;frep9&quot;</span>,<span class="stringliteral">&quot;frep10&quot;</span>,<span class="stringliteral">&quot;frep11&quot;</span>,<span class="stringliteral">&quot;errorabs&quot;</span>,<span class="stringliteral">&quot;errorallabs&quot;</span>,<span class="stringliteral">&quot;umin&quot;</span>,<span class="stringliteral">&quot;jac00&quot;</span>,<span class="stringliteral">&quot;jac11&quot;</span>,<span class="stringliteral">&quot;jac22&quot;</span>,<span class="stringliteral">&quot;jac33&quot;</span>,<span class="stringliteral">&quot;fracdtuu0&quot;</span>,<span class="stringliteral">&quot;fracdtG&quot;</span>,<span class="stringliteral">&quot;DAMPFACTOR&quot;</span>,<span class="stringliteral">&quot;it&quot;</span>,<span class="stringliteral">&quot;fe&quot;</span>);</div>
<div class="line"><a name="l08136"></a><span class="lineno"> 8136</span>&#160;</div>
<div class="line"><a name="l08137"></a><span class="lineno"> 8137</span>&#160;  <span class="keywordflow">for</span>(listiter=0;listiter&lt;=debugiter;listiter++){</div>
<div class="line"><a name="l08138"></a><span class="lineno"> 8138</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> umin=<a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#a1c7052b05f1c8206988b52c760b2e4af" title="suplementary routines for conversions">calc_PEQ_ufromTrho</a>(<a class="code" href="../../da/d04/global_8depmnemonics_8rad_8h.html#a213757d7585988f6c552da30cc6fcc39">TEMPMIN</a>,pppreholdlist[listiter][<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>]);</div>
<div class="line"><a name="l08139"></a><span class="lineno"> 8139</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a4b05614472c7005253be13002e1fab23" title="0 : full 1: optimal">DEBUGMAXMODE</a>==0){</div>
<div class="line"><a name="l08140"></a><span class="lineno"> 8140</span>&#160;      <span class="comment">// full, but excessive</span></div>
<div class="line"><a name="l08141"></a><span class="lineno"> 8141</span>&#160;      dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a></div>
<div class="line"><a name="l08142"></a><span class="lineno"> 8142</span>&#160;                  ,<span class="stringliteral">&quot;%3d : %3d : %21.15g %21.15g %21.15g %21.15g %21.15g %21.15g %21.15g %21.15g %21.15g : %21.15g %21.15g %21.15g %21.15g %21.15g %21.15g %21.15g %21.15g %21.15g : %21.15g %21.15g %21.15g %21.15g : %21.15g %21.15g : %21.15g\n&quot;</span></div>
<div class="line"><a name="l08143"></a><span class="lineno"> 8143</span>&#160;                  ,listiter,realiterlist[listiter]</div>
<div class="line"><a name="l08144"></a><span class="lineno"> 8144</span>&#160;                  ,pppreholdlist[listiter][RHO],pppreholdlist[listiter][<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>],pppreholdlist[listiter][<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>],pppreholdlist[listiter][<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae907e773ef038f3fc0c2ad5de0cb0f07">U2</a>],pppreholdlist[listiter][<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8de9104f1fffa59f057b214d74c5cfea">U3</a>],pppreholdlist[listiter][PRAD0],pppreholdlist[listiter][PRAD1],pppreholdlist[listiter][PRAD2],pppreholdlist[listiter][PRAD3]</div>
<div class="line"><a name="l08145"></a><span class="lineno"> 8145</span>&#160;                  ,ppposholdlist[listiter][RHO],ppposholdlist[listiter][UU],ppposholdlist[listiter][U1],ppposholdlist[listiter][U2],ppposholdlist[listiter][U3],ppposholdlist[listiter][PRAD0],ppposholdlist[listiter][PRAD1],ppposholdlist[listiter][PRAD2],ppposholdlist[listiter][PRAD3]</div>
<div class="line"><a name="l08146"></a><span class="lineno"> 8146</span>&#160;                  ,f1reportlist[listiter][0],f1reportlist[listiter][1],f1reportlist[listiter][2],f1reportlist[listiter][3]</div>
<div class="line"><a name="l08147"></a><span class="lineno"> 8147</span>&#160;                  ,errorabsf1list[listiter]</div>
<div class="line"><a name="l08148"></a><span class="lineno"> 8148</span>&#160;                  ,errorallabsf1list[listiter]</div>
<div class="line"><a name="l08149"></a><span class="lineno"> 8149</span>&#160;                  ,umin</div>
<div class="line"><a name="l08150"></a><span class="lineno"> 8150</span>&#160;                  );</div>
<div class="line"><a name="l08151"></a><span class="lineno"> 8151</span>&#160;    }</div>
<div class="line"><a name="l08152"></a><span class="lineno"> 8152</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a4b05614472c7005253be13002e1fab23" title="0 : full 1: optimal">DEBUGMAXMODE</a>==1){</div>
<div class="line"><a name="l08153"></a><span class="lineno"> 8153</span>&#160;      <span class="comment">// optimal</span></div>
<div class="line"><a name="l08154"></a><span class="lineno"> 8154</span>&#160;      dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a></div>
<div class="line"><a name="l08155"></a><span class="lineno"> 8155</span>&#160;                  ,<span class="stringliteral">&quot;%3d : %3d : %21.15g %21.15g %21.15g %21.15g %21.15g %21.15g %21.15g %21.15g %21.15g : %21.15g %21.15g : %21.15g %21.15g %21.15g %21.15g %21.15g %21.15g %21.15g %21.15g %21.15g %21.15g %21.15g %21.15g : %21.15g %21.15g %21.15g %21.15g %21.15g %21.15g %21.15g %21.15g %21.15g %21.15g %21.15g %21.15g : %21.15g  %21.15g : %21.15g : %21.15g %21.15g %21.15g %21.15g : %21.15g %21.15g %21.15g : %d %d\n&quot;</span></div>
<div class="line"><a name="l08156"></a><span class="lineno"> 8156</span>&#160;                  ,listiter,realiterlist[listiter]</div>
<div class="line"><a name="l08157"></a><span class="lineno"> 8157</span>&#160;                  ,pppreholdlist[listiter][RHO],pppreholdlist[listiter][<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>],pppreholdlist[listiter][<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>],pppreholdlist[listiter][<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae907e773ef038f3fc0c2ad5de0cb0f07">U2</a>],pppreholdlist[listiter][<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8de9104f1fffa59f057b214d74c5cfea">U3</a>],pppreholdlist[listiter][PRAD0],pppreholdlist[listiter][PRAD1],pppreholdlist[listiter][PRAD2],pppreholdlist[listiter][PRAD3]</div>
<div class="line"><a name="l08158"></a><span class="lineno"> 8158</span>&#160;                  ,ppposholdlist[listiter][RHO],ppposholdlist[listiter][UU]</div>
<div class="line"><a name="l08159"></a><span class="lineno"> 8159</span>&#160;                  ,f1list[listiter][0],f1list[listiter][1],f1list[listiter][2],f1list[listiter][3],f1list[listiter][4],f1list[listiter][5],f1list[listiter][6],f1list[listiter][7],f1list[listiter][8],f1list[listiter][9],f1list[listiter][10],f1list[listiter][11]</div>
<div class="line"><a name="l08160"></a><span class="lineno"> 8160</span>&#160;                  ,f1reportlist[listiter][0],f1reportlist[listiter][1],f1reportlist[listiter][2],f1reportlist[listiter][3],f1reportlist[listiter][4],f1reportlist[listiter][5],f1reportlist[listiter][6],f1reportlist[listiter][7],f1reportlist[listiter][8],f1reportlist[listiter][9],f1reportlist[listiter][10],f1reportlist[listiter][11]</div>
<div class="line"><a name="l08161"></a><span class="lineno"> 8161</span>&#160;                  ,errorabsf1list[listiter]</div>
<div class="line"><a name="l08162"></a><span class="lineno"> 8162</span>&#160;                  ,errorallabsf1list[listiter]</div>
<div class="line"><a name="l08163"></a><span class="lineno"> 8163</span>&#160;                  ,umin</div>
<div class="line"><a name="l08164"></a><span class="lineno"> 8164</span>&#160;                  ,jaclist[listiter][0][0]</div>
<div class="line"><a name="l08165"></a><span class="lineno"> 8165</span>&#160;                  ,jaclist[listiter][1][1]</div>
<div class="line"><a name="l08166"></a><span class="lineno"> 8166</span>&#160;                  ,jaclist[listiter][2][2]</div>
<div class="line"><a name="l08167"></a><span class="lineno"> 8167</span>&#160;                  ,jaclist[listiter][3][3]</div>
<div class="line"><a name="l08168"></a><span class="lineno"> 8168</span>&#160;                  ,fracdamplist[0] <span class="comment">// fracdtuu0</span></div>
<div class="line"><a name="l08169"></a><span class="lineno"> 8169</span>&#160;                  ,fracdamplist[1] <span class="comment">// fracdtG</span></div>
<div class="line"><a name="l08170"></a><span class="lineno"> 8170</span>&#160;                  ,fracdamplist[2] <span class="comment">// DAMPFACTOR</span></div>
<div class="line"><a name="l08171"></a><span class="lineno"> 8171</span>&#160;                  ,implicititerlist[listiter], implicitferrlist[listiter]</div>
<div class="line"><a name="l08172"></a><span class="lineno"> 8172</span>&#160;                );</div>
<div class="line"><a name="l08173"></a><span class="lineno"> 8173</span>&#160;    }</div>
<div class="line"><a name="l08174"></a><span class="lineno"> 8174</span>&#160;  }<span class="comment">// end listiter loop</span></div>
<div class="line"><a name="l08175"></a><span class="lineno"> 8175</span>&#160;</div>
<div class="line"><a name="l08176"></a><span class="lineno"> 8176</span>&#160;}</div>
<div class="line"><a name="l08177"></a><span class="lineno"> 8177</span>&#160;</div>
<div class="line"><a name="l08178"></a><span class="lineno"> 8178</span>&#160;</div>
<div class="line"><a name="l08179"></a><span class="lineno"> 8179</span>&#160;</div>
<div class="line"><a name="l08180"></a><span class="lineno"> 8180</span>&#160;</div>
<div class="line"><a name="l08181"></a><span class="lineno"> 8181</span>&#160;</div>
<div class="line"><a name="l08182"></a><span class="lineno"> 8182</span>&#160;</div>
<div class="line"><a name="l08183"></a><span class="lineno"> 8183</span>&#160;                             </div>
<div class="line"><a name="l08184"></a><span class="lineno"> 8184</span>&#160;<span class="keywordtype">int</span> get_rameshsolution_wrapper(<span class="keywordtype">int</span> whichcall, <span class="keywordtype">int</span> eomtype, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *errorabs, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pp, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *piin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Uiin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ufin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *dUother, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUf, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUimp, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *q, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *ppeng, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *ppent, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *uueng, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *uuent, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*dUcompeng)[NPR], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*dUcompent)[NPR], <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *qeng, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *qent, <span class="keywordtype">int</span> *failtypeeng, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *errorabseng, <span class="keywordtype">int</span> *iterseng, <span class="keywordtype">int</span> *radinvmodeng, <span class="keywordtype">int</span> *failtypeent, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *errorabsent, <span class="keywordtype">int</span> *itersent, <span class="keywordtype">int</span> *radinvmodent)</div>
<div class="line"><a name="l08185"></a><span class="lineno"> 8185</span>&#160;{</div>
<div class="line"><a name="l08186"></a><span class="lineno"> 8186</span>&#160;  <span class="comment">// BEGIN get ramesh solution</span></div>
<div class="line"><a name="l08187"></a><span class="lineno"> 8187</span>&#160;  <span class="keywordtype">int</span> radinvmod=0; <span class="comment">// fake</span></div>
<div class="line"><a name="l08188"></a><span class="lineno"> 8188</span>&#160;  <span class="keywordtype">int</span> failreturnentropy=0; <span class="comment">// fake</span></div>
<div class="line"><a name="l08189"></a><span class="lineno"> 8189</span>&#160;  <span class="comment">//  int failtypeeng=1,failtypeent=1,iterseng=IMPMAXITERLONG,itersent=IMPMAXITERLONG;</span></div>
<div class="line"><a name="l08190"></a><span class="lineno"> 8190</span>&#160;  <span class="keywordtype">int</span> failnum=0,gotfirstnofail=0;</div>
<div class="line"><a name="l08191"></a><span class="lineno"> 8191</span>&#160;  <span class="keywordtype">int</span> itermode=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab9c7390f62ef08325e12b7110621d33a">ITERMODENORMAL</a>,iters=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a58cca3253f4dfcefde5fe864699e297a">IMPMAXITERLONG</a>;</div>
<div class="line"><a name="l08192"></a><span class="lineno"> 8192</span>&#160;  <span class="keywordtype">int</span> baseitermethod=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9cf5ca7f5e5aa1e0bdef53abe3f27c1c">QTYPMHD</a>;</div>
<div class="line"><a name="l08193"></a><span class="lineno"> 8193</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> errorabsbestexternal[2];</div>
<div class="line"><a name="l08194"></a><span class="lineno"> 8194</span>&#160;  set_array(errorabsbestexternal,2,MPI_FTYPE,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>);</div>
<div class="line"><a name="l08195"></a><span class="lineno"> 8195</span>&#160;  <span class="comment">// itersentropy is last, but might feed in best</span></div>
<div class="line"><a name="l08196"></a><span class="lineno"> 8196</span>&#160;  <span class="keywordtype">int</span> isexplicit=0;</div>
<div class="line"><a name="l08197"></a><span class="lineno"> 8197</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> realdt = <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5dcc789108ddf06ec44fb22770f18e90" title="compute dt for this sub-step">compute_dt</a>(isexplicit,CUf, CUimp,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a56db625f31229c5e8b208ff27d464931">dt</a>);</div>
<div class="line"><a name="l08198"></a><span class="lineno"> 8198</span>&#160;  <span class="comment">// get uu0</span></div>
<div class="line"><a name="l08199"></a><span class="lineno"> 8199</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> uu0[NPR];</div>
<div class="line"><a name="l08200"></a><span class="lineno"> 8200</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fracdtuu0=1.0;</div>
<div class="line"><a name="l08201"></a><span class="lineno"> 8201</span>&#160;  <span class="keywordtype">int</span> pliter,pl;</div>
<div class="line"><a name="l08202"></a><span class="lineno"> 8202</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dUnongeomall[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0a72db4856620ff1b9551c885f1b32b5">MAXTIMEORDER</a>]={0.0};</div>
<div class="line"><a name="l08203"></a><span class="lineno"> 8203</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) uu0[pl]=UFSET(CUf,fracdtuu0*<a class="code" href="../../d8/d5b/defs_8general_8h.html#a56db625f31229c5e8b208ff27d464931">dt</a>,Uiin[pl],Ufin[pl],dUother[pl],0.0,dUnongeomall);</div>
<div class="line"><a name="l08204"></a><span class="lineno"> 8204</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> uu[NPR]; <span class="comment">// not used except when doing diagnostics in ramesh code</span></div>
<div class="line"><a name="l08205"></a><span class="lineno"> 8205</span>&#160;  <span class="comment">//  FTYPE uueng[NPR],uuent[NPR]; // filled with answer if successful</span></div>
<div class="line"><a name="l08206"></a><span class="lineno"> 8206</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l08207"></a><span class="lineno"> 8207</span>&#160;  get_rameshsolution(whichcall, radinvmod, failreturnentropy, failnum,  gotfirstnofail,  eomtype,  itermode, baseitermethod, errorabs, errorabs, iters, iters, realdt, ptrgeom, pp, pp, piin, uu0, uu, Uiin, Ufin, CUf, CUimp, q, ppeng, ppent, uueng, uuent, qeng, qent, failtypeeng, errorabseng, iterseng, radinvmodeng, failtypeent, errorabsent, itersent, radinvmodent);</div>
<div class="line"><a name="l08208"></a><span class="lineno"> 8208</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l08209"></a><span class="lineno"> 8209</span>&#160;  <span class="comment">// pp and q are assigned, but external call might just use only *eng and *ent versions of these and other things.</span></div>
<div class="line"><a name="l08210"></a><span class="lineno"> 8210</span>&#160;  if(eomtype==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a03d89f51ab60206791830c886d62bfd0">EOMGRMHD</a>){</div>
<div class="line"><a name="l08211"></a><span class="lineno"> 8211</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) pp[pl]=ppeng[pl];</div>
<div class="line"><a name="l08212"></a><span class="lineno"> 8212</span>&#160;    *q=*qeng;</div>
<div class="line"><a name="l08213"></a><span class="lineno"> 8213</span>&#160;  }</div>
<div class="line"><a name="l08214"></a><span class="lineno"> 8214</span>&#160;  if(eomtype==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a40b55e98bfcccde1a3f19d983ca7488c">EOMENTROPYGRMHD</a>){</div>
<div class="line"><a name="l08215"></a><span class="lineno"> 8215</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) pp[pl]=ppent[pl];</div>
<div class="line"><a name="l08216"></a><span class="lineno"> 8216</span>&#160;    *q=*qent;</div>
<div class="line"><a name="l08217"></a><span class="lineno"> 8217</span>&#160;  }</div>
<div class="line"><a name="l08218"></a><span class="lineno"> 8218</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l08219"></a><span class="lineno"> 8219</span>&#160;  <span class="keywordtype">int</span> sc;</div>
<div class="line"><a name="l08220"></a><span class="lineno"> 8220</span>&#160;  sc = <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab130f34dd5996718289efe08bc68b518">RADSOURCE</a>;</div>
<div class="line"><a name="l08221"></a><span class="lineno"> 8221</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l08222"></a><span class="lineno"> 8222</span>&#160;    dUcompeng[sc][pl] = + (uueng[pl]-uu0[pl])/realdt;</div>
<div class="line"><a name="l08223"></a><span class="lineno"> 8223</span>&#160;    dUcompent[sc][pl] = + (uuent[pl]-uu0[pl])/realdt;</div>
<div class="line"><a name="l08224"></a><span class="lineno"> 8224</span>&#160;  }</div>
<div class="line"><a name="l08225"></a><span class="lineno"> 8225</span>&#160;  <span class="comment">// END WITH RAMESH SOLUTION</span></div>
<div class="line"><a name="l08226"></a><span class="lineno"> 8226</span>&#160;</div>
<div class="line"><a name="l08227"></a><span class="lineno"> 8227</span>&#160;<span class="preprocessor">#if(0)</span></div>
<div class="line"><a name="l08228"></a><span class="lineno"> 8228</span>&#160;<span class="preprocessor"></span>  <span class="comment">// DEBUG</span></div>
<div class="line"><a name="l08229"></a><span class="lineno"> 8229</span>&#160;  sc = <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab130f34dd5996718289efe08bc68b518">RADSOURCE</a>;</div>
<div class="line"><a name="l08230"></a><span class="lineno"> 8230</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l08231"></a><span class="lineno"> 8231</span>&#160;    <span class="keywordflow">if</span>(1||!<a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(dUcompeng[sc][pl])) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;POOPENG %g %g %g\n&quot;</span>,uueng[pl],uu0[pl],realdt);</div>
<div class="line"><a name="l08232"></a><span class="lineno"> 8232</span>&#160;    <span class="keywordflow">if</span>(1||!<a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(dUcompent[sc][pl])) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;POOPENT %g %g %g\n&quot;</span>,uuent[pl],uu0[pl],realdt);</div>
<div class="line"><a name="l08233"></a><span class="lineno"> 8233</span>&#160;  }</div>
<div class="line"><a name="l08234"></a><span class="lineno"> 8234</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l08235"></a><span class="lineno"> 8235</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l08236"></a><span class="lineno"> 8236</span>&#160;</div>
<div class="line"><a name="l08237"></a><span class="lineno"> 8237</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l08238"></a><span class="lineno"> 8238</span>&#160;}</div>
<div class="line"><a name="l08239"></a><span class="lineno"> 8239</span>&#160;</div>
<div class="line"><a name="l08240"></a><span class="lineno"> 8240</span>&#160;<span class="comment">//#define WHICHVELRAMESH VEL4 // should be same as WHICHVEL in test.f</span></div>
<div class="line"><a name="l08241"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab70c804ef76b5a40c40cc668723ee352"> 8241</a></span>&#160;<span class="preprocessor">#define WHICHVELRAMESH VELREL4 // should be same as WHICHVEL in test.f</span></div>
<div class="line"><a name="l08242"></a><span class="lineno"> 8242</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l08243"></a><span class="lineno"> 8243</span>&#160;<span class="keywordtype">int</span> get_rameshsolution(<span class="keywordtype">int</span> whichcallramesh, <span class="keywordtype">int</span> radinvmod, <span class="keywordtype">int</span> failtype, <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> failnum, <span class="keywordtype">int</span> gotfirstnofail, <span class="keywordtype">int</span> eomtypelocal, <span class="keywordtype">int</span> itermode, <span class="keywordtype">int</span> baseitermethod, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *errorabs, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *errorabsbestexternal, <span class="keywordtype">int</span> iters, <span class="keywordtype">int</span> totaliters, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> realdt, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pp, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pb, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *piin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *uu0, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *uu, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Uiin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ufin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUf, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUimp, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *q, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *ppeng, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *ppent, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *uueng, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *uuent, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *qeng, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *qent, <span class="keywordtype">int</span> *failtypeeng, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *errorabseng, <span class="keywordtype">int</span> *iterseng, <span class="keywordtype">int</span> *radinvmodeng, <span class="keywordtype">int</span> *failtypeent, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *errorabsent, <span class="keywordtype">int</span> *itersent, <span class="keywordtype">int</span> *radinvmodent)</div>
<div class="line"><a name="l08244"></a><span class="lineno"> 8244</span>&#160;{</div>
<div class="line"><a name="l08245"></a><span class="lineno"> 8245</span>&#160;  <span class="comment">//  int failtype=1;</span></div>
<div class="line"><a name="l08246"></a><span class="lineno"> 8246</span>&#160;  <span class="comment">//  long long int failnum=0;</span></div>
<div class="line"><a name="l08247"></a><span class="lineno"> 8247</span>&#160;  <span class="comment">//  int gotfirstnofail=0;</span></div>
<div class="line"><a name="l08248"></a><span class="lineno"> 8248</span>&#160;  <span class="comment">//  int eomtypelocal=EOMGRMHD;</span></div>
<div class="line"><a name="l08249"></a><span class="lineno"> 8249</span>&#160;  <span class="comment">//  int itermode=ITERMODENORMAL;</span></div>
<div class="line"><a name="l08250"></a><span class="lineno"> 8250</span>&#160;  <span class="comment">//  FTYPE errorabs=BIG;</span></div>
<div class="line"><a name="l08251"></a><span class="lineno"> 8251</span>&#160;  <span class="comment">//  FTYPE iters=IMPMAXITERLONG;</span></div>
<div class="line"><a name="l08252"></a><span class="lineno"> 8252</span>&#160;  <span class="comment">//  FTYPE errorabsbestexternal=BIG;</span></div>
<div class="line"><a name="l08253"></a><span class="lineno"> 8253</span>&#160;  <span class="comment">//  int totaliters=IMPMAXITERLONG;</span></div>
<div class="line"><a name="l08254"></a><span class="lineno"> 8254</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *ppfirst=pp,*prtestUiin=piin,*prtestUU0=piin;</div>
<div class="line"><a name="l08255"></a><span class="lineno"> 8255</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *qpp=q;</div>
<div class="line"><a name="l08256"></a><span class="lineno"> 8256</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *qpb=q;</div>
<div class="line"><a name="l08257"></a><span class="lineno"> 8257</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *qpiin=q;</div>
<div class="line"><a name="l08258"></a><span class="lineno"> 8258</span>&#160;  <span class="keywordtype">int</span> jj,kk;</div>
<div class="line"><a name="l08259"></a><span class="lineno"> 8259</span>&#160;  <span class="keywordtype">int</span> pliter,pl;</div>
<div class="line"><a name="l08260"></a><span class="lineno"> 8260</span>&#160;</div>
<div class="line"><a name="l08261"></a><span class="lineno"> 8261</span>&#160;</div>
<div class="line"><a name="l08262"></a><span class="lineno"> 8262</span>&#160;</div>
<div class="line"><a name="l08263"></a><span class="lineno"> 8263</span>&#160;  <span class="comment">// 11 vars, failcode, error, iterations</span></div>
<div class="line"><a name="l08264"></a><span class="lineno"> 8264</span>&#160;  <span class="comment">// MUST BE SAME AS IN test.f code</span></div>
<div class="line"><a name="l08265"></a><span class="lineno"> 8265</span>&#160;<span class="preprocessor">#define NUMRESULTS 15</span></div>
<div class="line"><a name="l08266"></a><span class="lineno"> 8266</span>&#160;<span class="preprocessor"></span>  <a class="code" href="../../dc/dc2/f2c_8h.html#a1e69afaa4e6077b67397e6c36454b97a">doublereal</a> resultseng[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad0a3850ca18e612651839ae14ee35c8d">NUMRESULTS</a>]={0},resultsent[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad0a3850ca18e612651839ae14ee35c8d">NUMRESULTS</a>]={0};</div>
<div class="line"><a name="l08267"></a><span class="lineno"> 8267</span>&#160;</div>
<div class="line"><a name="l08268"></a><span class="lineno"> 8268</span>&#160;</div>
<div class="line"><a name="l08269"></a><span class="lineno"> 8269</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab70c804ef76b5a40c40cc668723ee352">WHICHVELRAMESH</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aed3093e329892ebfc8bce578a2484d68" title="for WHICHVEL 0: 4-velocity (leads to ambiguous u^t +- discr part) 1: 3-velocity (unambiguous u^t but ...">VEL4</a> &amp;&amp; ptrgeom-&gt;gcov[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>)]&gt;=0.0 || <a class="code" href="../../da/d3e/definit_8h.html#ad7d4ae935d29d9f729e14124b737a430" title="which EOS (EoS) (equation of state) to use">WHICHEOS</a>!=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28c9c7186d70e30e840bcef7ff55fc57">IDEALGAS</a>){</div>
<div class="line"><a name="l08270"></a><span class="lineno"> 8270</span>&#160;    <span class="comment">// KORALTODO SUPERGODMARK: Also only can use ramesh if lambda cooling only includes kappaff inverse and only normal ff and es opacities.</span></div>
<div class="line"><a name="l08271"></a><span class="lineno"> 8271</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab70c804ef76b5a40c40cc668723ee352">WHICHVELRAMESH</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aed3093e329892ebfc8bce578a2484d68" title="for WHICHVEL 0: 4-velocity (leads to ambiguous u^t +- discr part) 1: 3-velocity (unambiguous u^t but ...">VEL4</a> &amp;&amp; ptrgeom-&gt;gcov[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>)]&gt;=0.0) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;Wanted to call ramesh, but inside ergosphere\n&quot;</span>);</div>
<div class="line"><a name="l08272"></a><span class="lineno"> 8272</span>&#160;    *failtypeeng = 1;</div>
<div class="line"><a name="l08273"></a><span class="lineno"> 8273</span>&#160;    *radinvmodent = 0;</div>
<div class="line"><a name="l08274"></a><span class="lineno"> 8274</span>&#160;    errorabseng[0] = errorabseng[1] = <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>;</div>
<div class="line"><a name="l08275"></a><span class="lineno"> 8275</span>&#160;    *iterseng = 0;</div>
<div class="line"><a name="l08276"></a><span class="lineno"> 8276</span>&#160;    *failtypeent = 1;</div>
<div class="line"><a name="l08277"></a><span class="lineno"> 8277</span>&#160;    *radinvmodent = 0;</div>
<div class="line"><a name="l08278"></a><span class="lineno"> 8278</span>&#160;    errorabsent[0] = errorabsent[1] = <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>;</div>
<div class="line"><a name="l08279"></a><span class="lineno"> 8279</span>&#160;    *itersent = 0;</div>
<div class="line"><a name="l08280"></a><span class="lineno"> 8280</span>&#160;    <span class="keywordflow">for</span>(pl=0;pl&lt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad0a3850ca18e612651839ae14ee35c8d">NUMRESULTS</a>;pl++) resultseng[pl]=resultsent[pl]=-1.0;</div>
<div class="line"><a name="l08281"></a><span class="lineno"> 8281</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) ppeng[pl]=ppent[pl]=-1.0;</div>
<div class="line"><a name="l08282"></a><span class="lineno"> 8282</span>&#160;  }</div>
<div class="line"><a name="l08283"></a><span class="lineno"> 8283</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l08284"></a><span class="lineno"> 8284</span>&#160;</div>
<div class="line"><a name="l08286"></a><span class="lineno"> 8286</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l08287"></a><span class="lineno"> 8287</span>&#160;    <span class="comment">// Call Ramesh&#39;s solver</span></div>
<div class="line"><a name="l08288"></a><span class="lineno"> 8288</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l08290"></a><span class="lineno"> 8290</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l08291"></a><span class="lineno"> 8291</span>&#160;</div>
<div class="line"><a name="l08292"></a><span class="lineno"> 8292</span>&#160;    <span class="comment">// below things must be same order as in test.f</span></div>
<div class="line"><a name="l08293"></a><span class="lineno"> 8293</span>&#160;    <span class="comment">// MUST BE SAME AS IN test.f code</span></div>
<div class="line"><a name="l08294"></a><span class="lineno"> 8294</span>&#160;<span class="preprocessor">#define NUMARGS (211+11)</span></div>
<div class="line"><a name="l08295"></a><span class="lineno"> 8295</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l08296"></a><span class="lineno"> 8296</span>&#160;    <span class="comment">// call fortran code</span></div>
<div class="line"><a name="l08297"></a><span class="lineno"> 8297</span>&#160;    <a class="code" href="../../dc/dc2/f2c_8h.html#a1e69afaa4e6077b67397e6c36454b97a">doublereal</a> <a class="code" href="../../d9/d54/other6_8txt.html#a777dd0bd6ddcf933ecdea7b59e52eef0">args</a>[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a812b646ce3e36b504eb71b37604eb6de">NUMARGS</a>]={0};</div>
<div class="line"><a name="l08298"></a><span class="lineno"> 8298</span>&#160;    <span class="keywordtype">int</span> na;</div>
<div class="line"><a name="l08299"></a><span class="lineno"> 8299</span>&#160;</div>
<div class="line"><a name="l08300"></a><span class="lineno"> 8300</span>&#160;    na=-1;</div>
<div class="line"><a name="l08301"></a><span class="lineno"> 8301</span>&#160;    na++; args[na]=(<a class="code" href="../../dc/dc2/f2c_8h.html#a1e69afaa4e6077b67397e6c36454b97a">doublereal</a>)<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a812b646ce3e36b504eb71b37604eb6de">NUMARGS</a>;</div>
<div class="line"><a name="l08302"></a><span class="lineno"> 8302</span>&#160;    na++; args[na]=(<a class="code" href="../../dc/dc2/f2c_8h.html#a1e69afaa4e6077b67397e6c36454b97a">doublereal</a>)<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad0a3850ca18e612651839ae14ee35c8d">NUMRESULTS</a>;</div>
<div class="line"><a name="l08303"></a><span class="lineno"> 8303</span>&#160;    na++; args[na]=(<a class="code" href="../../dc/dc2/f2c_8h.html#a1e69afaa4e6077b67397e6c36454b97a">doublereal</a>)<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab70c804ef76b5a40c40cc668723ee352">WHICHVELRAMESH</a>;</div>
<div class="line"><a name="l08304"></a><span class="lineno"> 8304</span>&#160;    na++; args[na]=(<a class="code" href="../../dc/dc2/f2c_8h.html#a1e69afaa4e6077b67397e6c36454b97a">doublereal</a>)failtype;</div>
<div class="line"><a name="l08305"></a><span class="lineno"> 8305</span>&#160;    na++; args[na]=(<a class="code" href="../../dc/dc2/f2c_8h.html#a1e69afaa4e6077b67397e6c36454b97a">doublereal</a>)myid;</div>
<div class="line"><a name="l08306"></a><span class="lineno"> 8306</span>&#160;    na++; args[na]=(<a class="code" href="../../dc/dc2/f2c_8h.html#a1e69afaa4e6077b67397e6c36454b97a">doublereal</a>)failnum;</div>
<div class="line"><a name="l08307"></a><span class="lineno"> 8307</span>&#160;    na++; args[na]=(<a class="code" href="../../dc/dc2/f2c_8h.html#a1e69afaa4e6077b67397e6c36454b97a">doublereal</a>)gotfirstnofail;</div>
<div class="line"><a name="l08308"></a><span class="lineno"> 8308</span>&#160;    na++; args[na]=(<a class="code" href="../../dc/dc2/f2c_8h.html#a1e69afaa4e6077b67397e6c36454b97a">doublereal</a>)eomtypelocal;</div>
<div class="line"><a name="l08309"></a><span class="lineno"> 8309</span>&#160;    na++; args[na]=(<a class="code" href="../../dc/dc2/f2c_8h.html#a1e69afaa4e6077b67397e6c36454b97a">doublereal</a>)itermode;</div>
<div class="line"><a name="l08310"></a><span class="lineno"> 8310</span>&#160;    na++; args[na]=errorabs[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>];</div>
<div class="line"><a name="l08311"></a><span class="lineno"> 8311</span>&#160;    na++; args[na]=errorabsbestexternal[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>];</div>
<div class="line"><a name="l08312"></a><span class="lineno"> 8312</span>&#160;    na++; args[na]=(<a class="code" href="../../dc/dc2/f2c_8h.html#a1e69afaa4e6077b67397e6c36454b97a">doublereal</a>)iters;</div>
<div class="line"><a name="l08313"></a><span class="lineno"> 8313</span>&#160;    na++; args[na]=(<a class="code" href="../../dc/dc2/f2c_8h.html#a1e69afaa4e6077b67397e6c36454b97a">doublereal</a>)totaliters;</div>
<div class="line"><a name="l08314"></a><span class="lineno"> 8314</span>&#160;    na++; args[na]=realdt;</div>
<div class="line"><a name="l08315"></a><span class="lineno"> 8315</span>&#160;    na++; args[na]=(<a class="code" href="../../dc/dc2/f2c_8h.html#a1e69afaa4e6077b67397e6c36454b97a">doublereal</a>)<a class="code" href="../../d8/d5b/defs_8general_8h.html#a1a1088d87617078680f1fd0f0d707384">nstep</a>;</div>
<div class="line"><a name="l08316"></a><span class="lineno"> 8316</span>&#160;    na++; args[na]=(<a class="code" href="../../dc/dc2/f2c_8h.html#a1e69afaa4e6077b67397e6c36454b97a">doublereal</a>)<a class="code" href="../../d8/d5b/defs_8general_8h.html#a70170b90229f9fc05eebf8508a685c70">steppart</a>;</div>
<div class="line"><a name="l08317"></a><span class="lineno"> 8317</span>&#160;    na++; args[na]=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a5db33bd66a02c92d495409fd6d6c7459" title="GLOBAL PARAMETERS SECTION.">gam</a>;</div>
<div class="line"><a name="l08318"></a><span class="lineno"> 8318</span>&#160;    na++; args[na]=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a51ef12e4cafc4a8fe70374c37f57d565">GAMMAMAXRAD</a>;</div>
<div class="line"><a name="l08319"></a><span class="lineno"> 8319</span>&#160;    na++; args[na]=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a5bd9da451f108352614cbc457524c5b0">ERADLIMIT</a>;</div>
<div class="line"><a name="l08320"></a><span class="lineno"> 8320</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> trueimptryconv=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afc9b116343212081b674a39ac69ce6ed" title="Funny, even 1E-5 does ok with torus, no worse at Erf~ERADLIMIT instances. Also, does ~3 iterations...">IMPTRYCONV</a>;</div>
<div class="line"><a name="l08321"></a><span class="lineno"> 8321</span>&#160;    na++; args[na]=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a37aa5c4b7b1b481299d87bf929d13b15" title="error for comparing to sum over all absolute errors">IMPTRYCONVABS</a>;</div>
<div class="line"><a name="l08322"></a><span class="lineno"> 8322</span>&#160;    na++; args[na]=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8469a53eb25c0eb3b81286c364d0e7f3">IMPALLOWCONVCONSTABS</a>;</div>
<div class="line"><a name="l08323"></a><span class="lineno"> 8323</span>&#160;    na++; args[na]=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a591d275f967baa00b6382aff77362636">ARAD_CODE</a>;</div>
<div class="line"><a name="l08324"></a><span class="lineno"> 8324</span>&#160;    <span class="comment">// so as really code uses:</span></div>
<div class="line"><a name="l08325"></a><span class="lineno"> 8325</span>&#160;    na++; args[na]=calc_kappaes_user(1.0,1.0,0,0,0);</div>
<div class="line"><a name="l08326"></a><span class="lineno"> 8326</span>&#160;    na++; args[na]=calc_kappa_user(1.0,1.0,1.0,1.0,1.0,0,0,0);</div>
<div class="line"><a name="l08327"></a><span class="lineno"> 8327</span>&#160;    na++; args[na]=0.0;</div>
<div class="line"><a name="l08328"></a><span class="lineno"> 8328</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a59b7ef1517ff22fd4dfce4cf6d380c55" title="loop over all Dimensions; second rank loop">DLOOP</a>(jj,kk){ na++; args[na]=ptrgeom-&gt;gcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(jj,kk)];}</div>
<div class="line"><a name="l08329"></a><span class="lineno"> 8329</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a59b7ef1517ff22fd4dfce4cf6d380c55" title="loop over all Dimensions; second rank loop">DLOOP</a>(jj,kk){ na++; args[na]=ptrgeom-&gt;gcov[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(jj,kk)];}</div>
<div class="line"><a name="l08330"></a><span class="lineno"> 8330</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){ na++; args[na]=pp[pl]; na++; args[na]=ppfirst[pl]; na++; args[na]=pb[pl]; na++; args[na]=piin[pl]; na++; args[na]=prtestUiin[pl]; na++; args[na]=prtestUU0[pl]; na++; args[na]=uu0[pl]; na++; args[na]=uu[pl]; na++; args[na]=Uiin[pl]; }</div>
<div class="line"><a name="l08331"></a><span class="lineno"> 8331</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#a99ba7daf58b283bc831b8f507f5873a4" title="#define EOMTYPE EOMCOLDGRMHD">EOMRADTYPE</a>!=<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a993e29ef4139116d822d89bccb92180d" title="radiation equations of motion">EOMRADNONE</a>) <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj){ na++; args[na]=qpp-&gt;<a class="code" href="../../d1/d83/structof__state.html#a3bf8e15ee6ae95831230791baf2fc570">uradcon</a>[jj]; na++; args[na]=qpp-&gt;<a class="code" href="../../d1/d83/structof__state.html#a87c04c4f890495e87a6682643a0c7955">uradcov</a>[jj]; }</div>
<div class="line"><a name="l08332"></a><span class="lineno"> 8332</span>&#160;    <span class="keywordflow">else</span> <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj){ na++; args[na]=0.0; na++; args[na]=0.0; }</div>
<div class="line"><a name="l08333"></a><span class="lineno"> 8333</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#a99ba7daf58b283bc831b8f507f5873a4" title="#define EOMTYPE EOMCOLDGRMHD">EOMRADTYPE</a>!=<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a993e29ef4139116d822d89bccb92180d" title="radiation equations of motion">EOMRADNONE</a>) <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj){ na++; args[na]=qpp-&gt;<a class="code" href="../../d1/d83/structof__state.html#aab723d3c7c2c48b7246cc7d7d5379eed">ucon</a>[jj]; na++; args[na]=qpp-&gt;<a class="code" href="../../d1/d83/structof__state.html#a09881c3d05809ef27f8115d02a835e11">ucov</a>[jj]; }</div>
<div class="line"><a name="l08334"></a><span class="lineno"> 8334</span>&#160;    <span class="keywordflow">else</span> <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj){ na++; args[na]=0.0; na++; args[na]=0.0; }</div>
<div class="line"><a name="l08335"></a><span class="lineno"> 8335</span>&#160;</div>
<div class="line"><a name="l08336"></a><span class="lineno"> 8336</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#a99ba7daf58b283bc831b8f507f5873a4" title="#define EOMTYPE EOMCOLDGRMHD">EOMRADTYPE</a>!=<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a993e29ef4139116d822d89bccb92180d" title="radiation equations of motion">EOMRADNONE</a>) <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj){ na++; args[na]=qpb-&gt;<a class="code" href="../../d1/d83/structof__state.html#a3bf8e15ee6ae95831230791baf2fc570">uradcon</a>[jj]; na++; args[na]=qpb-&gt;<a class="code" href="../../d1/d83/structof__state.html#a87c04c4f890495e87a6682643a0c7955">uradcov</a>[jj]; }</div>
<div class="line"><a name="l08337"></a><span class="lineno"> 8337</span>&#160;    <span class="keywordflow">else</span> <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj){ na++; args[na]=0.0; na++; args[na]=0.0; }</div>
<div class="line"><a name="l08338"></a><span class="lineno"> 8338</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#a99ba7daf58b283bc831b8f507f5873a4" title="#define EOMTYPE EOMCOLDGRMHD">EOMRADTYPE</a>!=<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a993e29ef4139116d822d89bccb92180d" title="radiation equations of motion">EOMRADNONE</a>) <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj){ na++; args[na]=qpb-&gt;<a class="code" href="../../d1/d83/structof__state.html#aab723d3c7c2c48b7246cc7d7d5379eed">ucon</a>[jj]; na++; args[na]=qpb-&gt;<a class="code" href="../../d1/d83/structof__state.html#a09881c3d05809ef27f8115d02a835e11">ucov</a>[jj]; }</div>
<div class="line"><a name="l08339"></a><span class="lineno"> 8339</span>&#160;    <span class="keywordflow">else</span> <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj){ na++; args[na]=0.0; na++; args[na]=0.0; }</div>
<div class="line"><a name="l08340"></a><span class="lineno"> 8340</span>&#160;</div>
<div class="line"><a name="l08341"></a><span class="lineno"> 8341</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#a99ba7daf58b283bc831b8f507f5873a4" title="#define EOMTYPE EOMCOLDGRMHD">EOMRADTYPE</a>!=<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a993e29ef4139116d822d89bccb92180d" title="radiation equations of motion">EOMRADNONE</a>) <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj){ na++; args[na]=qpiin-&gt;<a class="code" href="../../d1/d83/structof__state.html#a3bf8e15ee6ae95831230791baf2fc570">uradcon</a>[jj]; na++; args[na]=qpiin-&gt;<a class="code" href="../../d1/d83/structof__state.html#a87c04c4f890495e87a6682643a0c7955">uradcov</a>[jj]; }</div>
<div class="line"><a name="l08342"></a><span class="lineno"> 8342</span>&#160;    <span class="keywordflow">else</span> <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj){ na++; args[na]=0.0; na++; args[na]=0.0; }</div>
<div class="line"><a name="l08343"></a><span class="lineno"> 8343</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#a99ba7daf58b283bc831b8f507f5873a4" title="#define EOMTYPE EOMCOLDGRMHD">EOMRADTYPE</a>!=<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a993e29ef4139116d822d89bccb92180d" title="radiation equations of motion">EOMRADNONE</a>) <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj){ na++; args[na]=qpiin-&gt;<a class="code" href="../../d1/d83/structof__state.html#aab723d3c7c2c48b7246cc7d7d5379eed">ucon</a>[jj]; na++; args[na]=qpiin-&gt;<a class="code" href="../../d1/d83/structof__state.html#a09881c3d05809ef27f8115d02a835e11">ucov</a>[jj]; }</div>
<div class="line"><a name="l08344"></a><span class="lineno"> 8344</span>&#160;    <span class="keywordflow">else</span> <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj){ na++; args[na]=0.0; na++; args[na]=0.0; }</div>
<div class="line"><a name="l08345"></a><span class="lineno"> 8345</span>&#160;</div>
<div class="line"><a name="l08346"></a><span class="lineno"> 8346</span>&#160;    <span class="keywordflow">if</span>(na!=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a812b646ce3e36b504eb71b37604eb6de">NUMARGS</a>-1){</div>
<div class="line"><a name="l08347"></a><span class="lineno"> 8347</span>&#160;      dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;Wrong number of args=%d\n&quot;</span>,na);</div>
<div class="line"><a name="l08348"></a><span class="lineno"> 8348</span>&#160;      myexit(304583453);</div>
<div class="line"><a name="l08349"></a><span class="lineno"> 8349</span>&#160;    }</div>
<div class="line"><a name="l08350"></a><span class="lineno"> 8350</span>&#160;</div>
<div class="line"><a name="l08351"></a><span class="lineno"> 8351</span>&#160;    <span class="comment">// calling f2c generated code, which assumes single array as input of 211 items.</span></div>
<div class="line"><a name="l08352"></a><span class="lineno"> 8352</span>&#160;    rameshsolver_(args,resultseng,resultsent);</div>
<div class="line"><a name="l08353"></a><span class="lineno"> 8353</span>&#160;</div>
<div class="line"><a name="l08354"></a><span class="lineno"> 8354</span>&#160;    <span class="comment">// process results from rameshsolver()</span></div>
<div class="line"><a name="l08355"></a><span class="lineno"> 8355</span>&#160;</div>
<div class="line"><a name="l08356"></a><span class="lineno"> 8356</span>&#160;    *failtypeeng = (int)resultseng[11];</div>
<div class="line"><a name="l08357"></a><span class="lineno"> 8357</span>&#160;    <span class="keywordflow">if</span>(*failtypeeng==0){</div>
<div class="line"><a name="l08358"></a><span class="lineno"> 8358</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a9afde1f1647e18e733406a1566b8b550">PLOOPBONLY</a>(pl) ppeng[pl]=pp[pl]; <span class="comment">// ramesh solver doesn&#39;t pass this back</span></div>
<div class="line"><a name="l08359"></a><span class="lineno"> 8359</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> uconeng[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>],uradconeng[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l08360"></a><span class="lineno"> 8360</span>&#160;      <span class="comment">// return solution in harm format</span></div>
<div class="line"><a name="l08361"></a><span class="lineno"> 8361</span>&#160;      ppeng[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>] = resultseng[0];</div>
<div class="line"><a name="l08362"></a><span class="lineno"> 8362</span>&#160;      ppeng[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>] = ppeng[ENTROPY] = resultseng[1];</div>
<div class="line"><a name="l08363"></a><span class="lineno"> 8363</span>&#160;      <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab70c804ef76b5a40c40cc668723ee352">WHICHVELRAMESH</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aed3093e329892ebfc8bce578a2484d68" title="for WHICHVEL 0: 4-velocity (leads to ambiguous u^t +- discr part) 1: 3-velocity (unambiguous u^t but ...">VEL4</a>){</div>
<div class="line"><a name="l08364"></a><span class="lineno"> 8364</span>&#160;        uconeng[0] = resultseng[2];</div>
<div class="line"><a name="l08365"></a><span class="lineno"> 8365</span>&#160;        uconeng[1] = resultseng[3];</div>
<div class="line"><a name="l08366"></a><span class="lineno"> 8366</span>&#160;        uconeng[2] = resultseng[4];</div>
<div class="line"><a name="l08367"></a><span class="lineno"> 8367</span>&#160;        uconeng[3] = resultseng[5];</div>
<div class="line"><a name="l08368"></a><span class="lineno"> 8368</span>&#160;        <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a5910aabe5e76183d341ef5b830b01bab" title="find {u}^ from u^ only fill spatial parts so can feed in 3-vector">uconrel</a>(uconeng,&amp;ppeng[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>],ptrgeom); <span class="comment">// get \tilde{u}^i</span></div>
<div class="line"><a name="l08369"></a><span class="lineno"> 8369</span>&#160;      }</div>
<div class="line"><a name="l08370"></a><span class="lineno"> 8370</span>&#160;      <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l08371"></a><span class="lineno"> 8371</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) ppeng[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>+jj] = resultseng[2+jj];</div>
<div class="line"><a name="l08372"></a><span class="lineno"> 8372</span>&#160;      }</div>
<div class="line"><a name="l08373"></a><span class="lineno"> 8373</span>&#160;      ppeng[URAD0] = resultseng[6];</div>
<div class="line"><a name="l08374"></a><span class="lineno"> 8374</span>&#160;      <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab70c804ef76b5a40c40cc668723ee352">WHICHVELRAMESH</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aed3093e329892ebfc8bce578a2484d68" title="for WHICHVEL 0: 4-velocity (leads to ambiguous u^t +- discr part) 1: 3-velocity (unambiguous u^t but ...">VEL4</a>){</div>
<div class="line"><a name="l08375"></a><span class="lineno"> 8375</span>&#160;        uradconeng[0] = resultseng[7];</div>
<div class="line"><a name="l08376"></a><span class="lineno"> 8376</span>&#160;        uradconeng[1] = resultseng[8];</div>
<div class="line"><a name="l08377"></a><span class="lineno"> 8377</span>&#160;        uradconeng[2] = resultseng[9];</div>
<div class="line"><a name="l08378"></a><span class="lineno"> 8378</span>&#160;        uradconeng[3] = resultseng[10];</div>
<div class="line"><a name="l08379"></a><span class="lineno"> 8379</span>&#160;        <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a5910aabe5e76183d341ef5b830b01bab" title="find {u}^ from u^ only fill spatial parts so can feed in 3-vector">uconrel</a>(uradconeng,&amp;ppeng[URAD0],ptrgeom); <span class="comment">// get \tilde{u}^i_{\rm rad}</span></div>
<div class="line"><a name="l08380"></a><span class="lineno"> 8380</span>&#160;      }</div>
<div class="line"><a name="l08381"></a><span class="lineno"> 8381</span>&#160;      <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l08382"></a><span class="lineno"> 8382</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) ppeng[URAD0+jj] = resultseng[7+jj];</div>
<div class="line"><a name="l08383"></a><span class="lineno"> 8383</span>&#160;      }</div>
<div class="line"><a name="l08384"></a><span class="lineno"> 8384</span>&#160;      <span class="comment">// get full state (thermo and other stuff needed)</span></div>
<div class="line"><a name="l08385"></a><span class="lineno"> 8385</span>&#160;      <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a11e17cd8b0594d1ad52e3594aa9f477e" title="find ucon, ucov, bcon, bcov from primitive variables when calling get_state, users of this function e...">get_state</a>(ppeng,ptrgeom,qeng);</div>
<div class="line"><a name="l08386"></a><span class="lineno"> 8386</span>&#160;      <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a9a54096e4c40a15a2c1bf74266153616" title="calculate &quot;conserved&quot; quantities">primtoU</a>(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab2be21bd5eff40ca89c20eeecbeab5e0">UNOTHING</a>,ppeng, qeng, ptrgeom, uueng, NULL);</div>
<div class="line"><a name="l08387"></a><span class="lineno"> 8387</span>&#160;      <span class="keyword">extern</span> <span class="keywordtype">int</span> <a class="code" href="../../d1/d3e/utoprimgen_8c.html#abfc42de6975dd4ff02f2748404e10911" title="perform U-&gt;p inversion on advected scalars">invert_scalars1</a>(<span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ugeomfree, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr);</div>
<div class="line"><a name="l08388"></a><span class="lineno"> 8388</span>&#160;      <a class="code" href="../../d1/d3e/utoprimgen_8c.html#abfc42de6975dd4ff02f2748404e10911" title="perform U-&gt;p inversion on advected scalars">invert_scalars1</a>(ptrgeom, uueng,ppeng);</div>
<div class="line"><a name="l08389"></a><span class="lineno"> 8389</span>&#160;      <span class="keyword">extern</span> <span class="keywordtype">int</span> <a class="code" href="../../d1/d3e/utoprimgen_8c.html#a1118806d01e553c38ae5cf5f036f9f2e" title="perform U-&gt;p inversion on advected scalars">invert_scalars2</a>(<span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ugeomfree, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *q, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr);</div>
<div class="line"><a name="l08390"></a><span class="lineno"> 8390</span>&#160;      <a class="code" href="../../d1/d3e/utoprimgen_8c.html#a1118806d01e553c38ae5cf5f036f9f2e" title="perform U-&gt;p inversion on advected scalars">invert_scalars2</a>(ptrgeom, uueng,qeng,ppeng);</div>
<div class="line"><a name="l08391"></a><span class="lineno"> 8391</span>&#160;    }</div>
<div class="line"><a name="l08392"></a><span class="lineno"> 8392</span>&#160;    errorabseng[0] = resultseng[12];</div>
<div class="line"><a name="l08393"></a><span class="lineno"> 8393</span>&#160;    *iterseng = (int)resultseng[13];</div>
<div class="line"><a name="l08394"></a><span class="lineno"> 8394</span>&#160;    *radinvmodeng = (int)resultseng[14];</div>
<div class="line"><a name="l08395"></a><span class="lineno"> 8395</span>&#160;</div>
<div class="line"><a name="l08396"></a><span class="lineno"> 8396</span>&#160;    <span class="comment">// override ramesh error in case meaningless, if there is a failure.</span></div>
<div class="line"><a name="l08397"></a><span class="lineno"> 8397</span>&#160;    <span class="keywordflow">if</span>(*failtypeeng) errorabseng[0] = <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>;</div>
<div class="line"><a name="l08398"></a><span class="lineno"> 8398</span>&#160;</div>
<div class="line"><a name="l08399"></a><span class="lineno"> 8399</span>&#160;    <span class="comment">// return solution in harm format</span></div>
<div class="line"><a name="l08400"></a><span class="lineno"> 8400</span>&#160;    *failtypeent = (int)resultsent[11];</div>
<div class="line"><a name="l08401"></a><span class="lineno"> 8401</span>&#160;    <span class="keywordflow">if</span>(*failtypeent==0){</div>
<div class="line"><a name="l08402"></a><span class="lineno"> 8402</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a9afde1f1647e18e733406a1566b8b550">PLOOPBONLY</a>(pl) ppent[pl]=pp[pl]; <span class="comment">// ramesh solver doesn&#39;t pass this back</span></div>
<div class="line"><a name="l08403"></a><span class="lineno"> 8403</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> uconent[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>],uradconent[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l08404"></a><span class="lineno"> 8404</span>&#160;      ppent[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>] = resultsent[0];</div>
<div class="line"><a name="l08405"></a><span class="lineno"> 8405</span>&#160;      ppent[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>] = ppent[ENTROPY] = resultsent[1];</div>
<div class="line"><a name="l08406"></a><span class="lineno"> 8406</span>&#160;      <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab70c804ef76b5a40c40cc668723ee352">WHICHVELRAMESH</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aed3093e329892ebfc8bce578a2484d68" title="for WHICHVEL 0: 4-velocity (leads to ambiguous u^t +- discr part) 1: 3-velocity (unambiguous u^t but ...">VEL4</a>){</div>
<div class="line"><a name="l08407"></a><span class="lineno"> 8407</span>&#160;        uconent[0] = resultsent[2];</div>
<div class="line"><a name="l08408"></a><span class="lineno"> 8408</span>&#160;        uconent[1] = resultsent[3];</div>
<div class="line"><a name="l08409"></a><span class="lineno"> 8409</span>&#160;        uconent[2] = resultsent[4];</div>
<div class="line"><a name="l08410"></a><span class="lineno"> 8410</span>&#160;        uconent[3] = resultsent[5];</div>
<div class="line"><a name="l08411"></a><span class="lineno"> 8411</span>&#160;        <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a5910aabe5e76183d341ef5b830b01bab" title="find {u}^ from u^ only fill spatial parts so can feed in 3-vector">uconrel</a>(uconent,&amp;ppent[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>],ptrgeom); <span class="comment">// get \tilde{u}^i</span></div>
<div class="line"><a name="l08412"></a><span class="lineno"> 8412</span>&#160;      }</div>
<div class="line"><a name="l08413"></a><span class="lineno"> 8413</span>&#160;      <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l08414"></a><span class="lineno"> 8414</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) ppent[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>+jj] = resultsent[2+jj];</div>
<div class="line"><a name="l08415"></a><span class="lineno"> 8415</span>&#160;      }</div>
<div class="line"><a name="l08416"></a><span class="lineno"> 8416</span>&#160;      ppent[URAD0] = resultsent[6];</div>
<div class="line"><a name="l08417"></a><span class="lineno"> 8417</span>&#160;      <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab70c804ef76b5a40c40cc668723ee352">WHICHVELRAMESH</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aed3093e329892ebfc8bce578a2484d68" title="for WHICHVEL 0: 4-velocity (leads to ambiguous u^t +- discr part) 1: 3-velocity (unambiguous u^t but ...">VEL4</a>){</div>
<div class="line"><a name="l08418"></a><span class="lineno"> 8418</span>&#160;        uradconent[0] = resultsent[7];</div>
<div class="line"><a name="l08419"></a><span class="lineno"> 8419</span>&#160;        uradconent[1] = resultsent[8];</div>
<div class="line"><a name="l08420"></a><span class="lineno"> 8420</span>&#160;        uradconent[2] = resultsent[9];</div>
<div class="line"><a name="l08421"></a><span class="lineno"> 8421</span>&#160;        uradconent[3] = resultsent[10];</div>
<div class="line"><a name="l08422"></a><span class="lineno"> 8422</span>&#160;        <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a5910aabe5e76183d341ef5b830b01bab" title="find {u}^ from u^ only fill spatial parts so can feed in 3-vector">uconrel</a>(uradconent,&amp;ppent[URAD0],ptrgeom); <span class="comment">// get \tilde{u}^i_{\rm rad}</span></div>
<div class="line"><a name="l08423"></a><span class="lineno"> 8423</span>&#160;      }</div>
<div class="line"><a name="l08424"></a><span class="lineno"> 8424</span>&#160;      <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l08425"></a><span class="lineno"> 8425</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) ppent[URAD0+jj] = resultsent[7+jj];</div>
<div class="line"><a name="l08426"></a><span class="lineno"> 8426</span>&#160;      }</div>
<div class="line"><a name="l08427"></a><span class="lineno"> 8427</span>&#160;      <span class="comment">// get full state (thermo and other stuff needed)</span></div>
<div class="line"><a name="l08428"></a><span class="lineno"> 8428</span>&#160;      <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a11e17cd8b0594d1ad52e3594aa9f477e" title="find ucon, ucov, bcon, bcov from primitive variables when calling get_state, users of this function e...">get_state</a>(ppent,ptrgeom,qent);</div>
<div class="line"><a name="l08429"></a><span class="lineno"> 8429</span>&#160;      <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a9a54096e4c40a15a2c1bf74266153616" title="calculate &quot;conserved&quot; quantities">primtoU</a>(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab2be21bd5eff40ca89c20eeecbeab5e0">UNOTHING</a>,ppent, qent, ptrgeom, uuent, NULL);</div>
<div class="line"><a name="l08430"></a><span class="lineno"> 8430</span>&#160;      <span class="keyword">extern</span> <span class="keywordtype">int</span> <a class="code" href="../../d1/d3e/utoprimgen_8c.html#abfc42de6975dd4ff02f2748404e10911" title="perform U-&gt;p inversion on advected scalars">invert_scalars1</a>(<span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ugeomfree, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr);</div>
<div class="line"><a name="l08431"></a><span class="lineno"> 8431</span>&#160;      <a class="code" href="../../d1/d3e/utoprimgen_8c.html#abfc42de6975dd4ff02f2748404e10911" title="perform U-&gt;p inversion on advected scalars">invert_scalars1</a>(ptrgeom, uuent,ppent);</div>
<div class="line"><a name="l08432"></a><span class="lineno"> 8432</span>&#160;      <span class="keyword">extern</span> <span class="keywordtype">int</span> <a class="code" href="../../d1/d3e/utoprimgen_8c.html#a1118806d01e553c38ae5cf5f036f9f2e" title="perform U-&gt;p inversion on advected scalars">invert_scalars2</a>(<span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ugeomfree, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *q, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr);</div>
<div class="line"><a name="l08433"></a><span class="lineno"> 8433</span>&#160;      <a class="code" href="../../d1/d3e/utoprimgen_8c.html#a1118806d01e553c38ae5cf5f036f9f2e" title="perform U-&gt;p inversion on advected scalars">invert_scalars2</a>(ptrgeom, uuent,qent,ppent);</div>
<div class="line"><a name="l08434"></a><span class="lineno"> 8434</span>&#160;    }</div>
<div class="line"><a name="l08435"></a><span class="lineno"> 8435</span>&#160;    errorabsent[0] = resultsent[12];</div>
<div class="line"><a name="l08436"></a><span class="lineno"> 8436</span>&#160;    *itersent = (int)resultsent[13];</div>
<div class="line"><a name="l08437"></a><span class="lineno"> 8437</span>&#160;    *radinvmodent = (int)resultsent[14];</div>
<div class="line"><a name="l08438"></a><span class="lineno"> 8438</span>&#160;</div>
<div class="line"><a name="l08439"></a><span class="lineno"> 8439</span>&#160;    <span class="comment">// override ramesh error in case meaningless, if there is a failure.</span></div>
<div class="line"><a name="l08440"></a><span class="lineno"> 8440</span>&#160;    <span class="keywordflow">if</span>(*failtypeent) errorabsent[0] = <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>;</div>
<div class="line"><a name="l08441"></a><span class="lineno"> 8441</span>&#160;  }</div>
<div class="line"><a name="l08442"></a><span class="lineno"> 8442</span>&#160;</div>
<div class="line"><a name="l08443"></a><span class="lineno"> 8443</span>&#160;</div>
<div class="line"><a name="l08444"></a><span class="lineno"> 8444</span>&#160;</div>
<div class="line"><a name="l08446"></a><span class="lineno"> 8446</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l08447"></a><span class="lineno"> 8447</span>&#160;  <span class="comment">// Double check ramesh error with f_error_check() or f_implicit().  Also uses error as consistent with harm -- i.e. total error if WHICHERROR==1</span></div>
<div class="line"><a name="l08448"></a><span class="lineno"> 8448</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l08450"></a><span class="lineno"> 8450</span>&#160;<span class="comment"></span>  <span class="keywordtype">int</span> failreturnferr;</div>
<div class="line"><a name="l08451"></a><span class="lineno"> 8451</span>&#160;  <span class="keywordtype">int</span> allowbaseitermethodswitch=0;</div>
<div class="line"><a name="l08452"></a><span class="lineno"> 8452</span>&#160;  <span class="keywordtype">int</span> fakeiter=1;</div>
<div class="line"><a name="l08453"></a><span class="lineno"> 8453</span>&#160;  <span class="keywordtype">int</span> fakef1iter=-1;</div>
<div class="line"><a name="l08454"></a><span class="lineno"> 8454</span>&#160;  <span class="keywordtype">int</span> failreturnallowableuse=0;</div>
<div class="line"><a name="l08455"></a><span class="lineno"> 8455</span>&#160;  <span class="keywordtype">int</span> whichcall=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a137120b9d350a5e9706de4a7a9dde9fb">FIMPLICITCALLTYPEFINALCHECK2</a>;</div>
<div class="line"><a name="l08456"></a><span class="lineno"> 8456</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> impepsjac=0;</div>
<div class="line"><a name="l08457"></a><span class="lineno"> 8457</span>&#160;  <span class="keywordtype">int</span> showmessages=0;</div>
<div class="line"><a name="l08458"></a><span class="lineno"> 8458</span>&#160;  <span class="keywordtype">int</span> showmessagesheavy=0;</div>
<div class="line"><a name="l08459"></a><span class="lineno"> 8459</span>&#160;  <span class="keywordtype">int</span> allowlocalfailurefixandnoreport=0;</div>
<div class="line"><a name="l08460"></a><span class="lineno"> 8460</span>&#160;  <span class="comment">//int &amp;eomtypelocal;</span></div>
<div class="line"><a name="l08461"></a><span class="lineno"> 8461</span>&#160;  <span class="keywordtype">int</span> whichcap=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a4b6c6060c025e15f1d92aae3dcb9365b" title="which cap type to place in rad inversion">CAPTYPEBASIC</a>;</div>
<div class="line"><a name="l08462"></a><span class="lineno"> 8462</span>&#160;  <span class="comment">//  int itermode;</span></div>
<div class="line"><a name="l08463"></a><span class="lineno"> 8463</span>&#160;  <span class="comment">//  int baseitermethod;</span></div>
<div class="line"><a name="l08464"></a><span class="lineno"> 8464</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fracenergy=1.0;</div>
<div class="line"><a name="l08465"></a><span class="lineno"> 8465</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dissmeasure=-1.0;</div>
<div class="line"><a name="l08466"></a><span class="lineno"> 8466</span>&#160;  radinvmod=*radinvmodeng; <span class="comment">// default</span></div>
<div class="line"><a name="l08467"></a><span class="lineno"> 8467</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> trueimptryconv=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afc9b116343212081b674a39ac69ce6ed" title="Funny, even 1E-5 does ok with torus, no worse at Erf~ERADLIMIT instances. Also, does ~3 iterations...">IMPTRYCONV</a>;</div>
<div class="line"><a name="l08468"></a><span class="lineno"> 8468</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> trueimptryconvabs=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a37aa5c4b7b1b481299d87bf929d13b15" title="error for comparing to sum over all absolute errors">IMPTRYCONVABS</a>;</div>
<div class="line"><a name="l08469"></a><span class="lineno"> 8469</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> trueimpallowconvabs=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8469a53eb25c0eb3b81286c364d0e7f3">IMPALLOWCONVCONSTABS</a>;</div>
<div class="line"><a name="l08470"></a><span class="lineno"> 8470</span>&#160;  <span class="keywordtype">int</span> trueimpmaxiter=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a58cca3253f4dfcefde5fe864699e297a">IMPMAXITERLONG</a>;</div>
<div class="line"><a name="l08471"></a><span class="lineno"> 8471</span>&#160;  <span class="comment">//  FTYPE realdt;</span></div>
<div class="line"><a name="l08472"></a><span class="lineno"> 8472</span>&#160;  <span class="keywordtype">int</span> dimtypef=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a6c45d4170066340923e6ec67e05436f4">DIMTYPEFCONS</a>;</div>
<div class="line"><a name="l08473"></a><span class="lineno"> 8473</span>&#160;  <span class="comment">// some geometry stuff to store pre-step instead of for each step.</span></div>
<div class="line"><a name="l08474"></a><span class="lineno"> 8474</span>&#160;  <span class="keywordtype">int</span> jjdim;</div>
<div class="line"><a name="l08475"></a><span class="lineno"> 8475</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dimfactU[NPR];</div>
<div class="line"><a name="l08476"></a><span class="lineno"> 8476</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) dimfactU[pl]=1.0; <span class="comment">// default</span></div>
<div class="line"><a name="l08477"></a><span class="lineno"> 8477</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jjdim) dimfactU[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>+jjdim]=dimfactU[URAD0+jjdim]=sqrt(fabs(ptrgeom-&gt;gcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(jjdim,jjdim)]));</div>
<div class="line"><a name="l08478"></a><span class="lineno"> 8478</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jjdim) dimfactU[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>+jjdim-1] = 1.0/dimfactU[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>+jjdim-1];</div>
<div class="line"><a name="l08479"></a><span class="lineno"> 8479</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ppppp[NPR];</div>
<div class="line"><a name="l08480"></a><span class="lineno"> 8480</span>&#160;  <span class="comment">//  FTYPE pp[NPR];</span></div>
<div class="line"><a name="l08481"></a><span class="lineno"> 8481</span>&#160;  <span class="comment">//  FTYPE piin[NPR];</span></div>
<div class="line"><a name="l08482"></a><span class="lineno"> 8482</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> uuppp[NPR];</div>
<div class="line"><a name="l08483"></a><span class="lineno"> 8483</span>&#160;  <span class="comment">//FTYPE Uiin[NPR];</span></div>
<div class="line"><a name="l08484"></a><span class="lineno"> 8484</span>&#160;  <span class="comment">//  FTYPE uu0[NPR];</span></div>
<div class="line"><a name="l08485"></a><span class="lineno"> 8485</span>&#160;  <span class="comment">//  FTYPE uu[NPR];</span></div>
<div class="line"><a name="l08486"></a><span class="lineno"> 8486</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fracdtG=1.0;</div>
<div class="line"><a name="l08487"></a><span class="lineno"> 8487</span>&#160;  <span class="comment">//FTYPE ptrgeom;</span></div>
<div class="line"><a name="l08488"></a><span class="lineno"> 8488</span>&#160;  <span class="comment">//FTYPE q;</span></div>
<div class="line"><a name="l08489"></a><span class="lineno"> 8489</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> f1[NPR];</div>
<div class="line"><a name="l08490"></a><span class="lineno"> 8490</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> f1norm[NPR];</div>
<div class="line"><a name="l08491"></a><span class="lineno"> 8491</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> f1report[NPR];</div>
<div class="line"><a name="l08492"></a><span class="lineno"> 8492</span>&#160;  <span class="keywordtype">int</span> goexplicit=0;</div>
<div class="line"><a name="l08493"></a><span class="lineno"> 8493</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> errorabsf1[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa63447acbbbc62cbedae23eac61c716e" title="determine which error will use when deciding if converged or not.">NUMERRORTYPES</a>];</div>
<div class="line"><a name="l08494"></a><span class="lineno"> 8494</span>&#160;  <span class="comment">// WHICHERROR;</span></div>
<div class="line"><a name="l08495"></a><span class="lineno"> 8495</span>&#160;  <span class="keywordtype">int</span> convreturnf1;</div>
<div class="line"><a name="l08496"></a><span class="lineno"> 8496</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> tautotmaxreturn;</div>
<div class="line"><a name="l08497"></a><span class="lineno"> 8497</span>&#160;</div>
<div class="line"><a name="l08498"></a><span class="lineno"> 8498</span>&#160;</div>
<div class="line"><a name="l08499"></a><span class="lineno"> 8499</span>&#160;  <span class="keywordtype">int</span> nummhdinvsreturn=0;</div>
<div class="line"><a name="l08500"></a><span class="lineno"> 8500</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../d6/dbe/structof__method.html">of_method</a> mtd;</div>
<div class="line"><a name="l08501"></a><span class="lineno"> 8501</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../d2/d46/structof__ref_u.html">of_refU</a> ru;</div>
<div class="line"><a name="l08502"></a><span class="lineno"> 8502</span>&#160;  <span class="keywordflow">if</span>(*failtypeeng==0){</div>
<div class="line"><a name="l08504"></a><span class="lineno"> 8504</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l08505"></a><span class="lineno"> 8505</span>&#160;    <span class="comment">// test ppeng</span></div>
<div class="line"><a name="l08506"></a><span class="lineno"> 8506</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l08508"></a><span class="lineno"> 8508</span>&#160;<span class="comment"></span>    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l08509"></a><span class="lineno"> 8509</span>&#160;      ppppp[pl] = pp[pl] = ppeng[pl];</div>
<div class="line"><a name="l08510"></a><span class="lineno"> 8510</span>&#160;      uuppp[pl] = uu[pl] = uueng[pl];</div>
<div class="line"><a name="l08511"></a><span class="lineno"> 8511</span>&#160;    }</div>
<div class="line"><a name="l08512"></a><span class="lineno"> 8512</span>&#160;</div>
<div class="line"><a name="l08513"></a><span class="lineno"> 8513</span>&#160;</div>
<div class="line"><a name="l08514"></a><span class="lineno"> 8514</span>&#160;    failreturnferr=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#af46d2b1cf89a70a7e2ef503146c649a9" title="uu0 - original cons.">f_implicit</a>(allowbaseitermethodswitch, fakeiter, fakef1iter, failreturnallowableuse, whichcall, impepsjac, showmessages, showmessagesheavy, allowlocalfailurefixandnoreport, &amp;eomtypelocal, whichcap, itermode, &amp;baseitermethod, fracenergy, dissmeasure, &amp;radinvmod, trueimptryconv, trueimptryconvabs, trueimpallowconvabs, trueimpmaxiter, realdt, dimtypef, dimfactU, ppppp, pp, piin, uuppp, Uiin, uu0, uu, fracdtG*realdt, ptrgeom, q, f1, f1norm, f1report, &amp;goexplicit, &amp;errorabsf1[0], &amp;errorabsf1[1], <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>, &amp;convreturnf1, &amp;nummhdinvsreturn, &amp;tautotmaxreturn, &amp;mtd, &amp;ru); <span class="comment">// modifies uu and pp, f1poret, goexplicit, errorabsf1[0,1], convreturnf1</span></div>
<div class="line"><a name="l08515"></a><span class="lineno"> 8515</span>&#160;    <span class="comment">// translate result</span></div>
<div class="line"><a name="l08516"></a><span class="lineno"> 8516</span>&#160;    <span class="comment">//  *qeng=*q; // already done</span></div>
<div class="line"><a name="l08517"></a><span class="lineno"> 8517</span>&#160;    *failtypeeng=failreturnferr; <span class="comment">// trust my error report</span></div>
<div class="line"><a name="l08518"></a><span class="lineno"> 8518</span>&#160;    errorabseng[0]=errorabsf1[0]; <span class="comment">// trust my error measure</span></div>
<div class="line"><a name="l08519"></a><span class="lineno"> 8519</span>&#160;    errorabseng[1]=errorabsf1[1]; <span class="comment">// trust my error measure</span></div>
<div class="line"><a name="l08520"></a><span class="lineno"> 8520</span>&#160;    *radinvmodeng=radinvmod; <span class="comment">// trust my rad inv check</span></div>
<div class="line"><a name="l08521"></a><span class="lineno"> 8521</span>&#160;  }</div>
<div class="line"><a name="l08522"></a><span class="lineno"> 8522</span>&#160;</div>
<div class="line"><a name="l08523"></a><span class="lineno"> 8523</span>&#160;  <span class="keywordflow">if</span>(*failtypeent==0){</div>
<div class="line"><a name="l08525"></a><span class="lineno"> 8525</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l08526"></a><span class="lineno"> 8526</span>&#160;    <span class="comment">// test ppent</span></div>
<div class="line"><a name="l08527"></a><span class="lineno"> 8527</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l08529"></a><span class="lineno"> 8529</span>&#160;<span class="comment"></span>    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l08530"></a><span class="lineno"> 8530</span>&#160;      ppppp[pl] = pp[pl] = ppent[pl];</div>
<div class="line"><a name="l08531"></a><span class="lineno"> 8531</span>&#160;      uuppp[pl] = uu[pl] = uuent[pl];</div>
<div class="line"><a name="l08532"></a><span class="lineno"> 8532</span>&#160;    }</div>
<div class="line"><a name="l08533"></a><span class="lineno"> 8533</span>&#160; </div>
<div class="line"><a name="l08534"></a><span class="lineno"> 8534</span>&#160;    failreturnferr=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#af46d2b1cf89a70a7e2ef503146c649a9" title="uu0 - original cons.">f_implicit</a>(allowbaseitermethodswitch, fakeiter, fakef1iter, failreturnallowableuse, whichcall, impepsjac, showmessages, showmessagesheavy, allowlocalfailurefixandnoreport, &amp;eomtypelocal, whichcap, itermode, &amp;baseitermethod, fracenergy, dissmeasure, &amp;radinvmod, trueimptryconv, trueimptryconvabs, trueimpallowconvabs, trueimpmaxiter, realdt, dimtypef, dimfactU, ppppp, pp, piin, uuppp, Uiin, uu0, uu, fracdtG*realdt, ptrgeom, q, f1, f1norm, f1report, &amp;goexplicit, &amp;errorabsf1[0], &amp;errorabsf1[1], <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>, &amp;convreturnf1, &amp;nummhdinvsreturn, &amp;tautotmaxreturn, &amp;mtd, &amp;ru); <span class="comment">// modifies uu and pp, f1poret, goexplicit, errorabsf1[0,1], convreturnf1</span></div>
<div class="line"><a name="l08535"></a><span class="lineno"> 8535</span>&#160;    <span class="comment">// translate result</span></div>
<div class="line"><a name="l08536"></a><span class="lineno"> 8536</span>&#160;    <span class="comment">//  *qent=*q; // already done</span></div>
<div class="line"><a name="l08537"></a><span class="lineno"> 8537</span>&#160;    *failtypeent=failreturnferr; <span class="comment">// trust my error report</span></div>
<div class="line"><a name="l08538"></a><span class="lineno"> 8538</span>&#160;    errorabsent[0]=errorabsf1[0]; <span class="comment">// trust my error measure</span></div>
<div class="line"><a name="l08539"></a><span class="lineno"> 8539</span>&#160;    errorabsent[1]=errorabsf1[1]; <span class="comment">// trust my error measure</span></div>
<div class="line"><a name="l08540"></a><span class="lineno"> 8540</span>&#160;    *radinvmodent=radinvmod; <span class="comment">// trust my rad inv check</span></div>
<div class="line"><a name="l08541"></a><span class="lineno"> 8541</span>&#160;  }</div>
<div class="line"><a name="l08542"></a><span class="lineno"> 8542</span>&#160;</div>
<div class="line"><a name="l08543"></a><span class="lineno"> 8543</span>&#160;  </div>
<div class="line"><a name="l08544"></a><span class="lineno"> 8544</span>&#160;</div>
<div class="line"><a name="l08545"></a><span class="lineno"> 8545</span>&#160;</div>
<div class="line"><a name="l08546"></a><span class="lineno"> 8546</span>&#160;  <span class="comment">// DEBUG and only when real call (for now) and only show if one is not a bad solution</span></div>
<div class="line"><a name="l08547"></a><span class="lineno"> 8547</span>&#160;  <span class="keywordflow">if</span>(debugfail&gt;=2 &amp;&amp; whichcallramesh&gt;0 &amp;&amp; (*failtypeent==0 || *failtypeeng==0)){ <span class="comment">// NORMAL</span></div>
<div class="line"><a name="l08548"></a><span class="lineno"> 8548</span>&#160;  <span class="comment">//  if(debugfail&gt;=2 &amp;&amp; whichcallramesh==0){ // DEBUGGING Erf~0 solutions</span></div>
<div class="line"><a name="l08549"></a><span class="lineno"> 8549</span>&#160;  <span class="comment">//  if(PRODUCTION==0 &amp;&amp; debugfail&gt;=2 &amp;&amp; (*failtypeeng==0 || *failtypeent==0)){ // DEBUGGING Erf~0 solutions</span></div>
<div class="line"><a name="l08550"></a><span class="lineno"> 8550</span>&#160;</div>
<div class="line"><a name="l08551"></a><span class="lineno"> 8551</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> resultsjon[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad0a3850ca18e612651839ae14ee35c8d">NUMRESULTS</a>];</div>
<div class="line"><a name="l08552"></a><span class="lineno"> 8552</span>&#160;    resultsjon[0] = pp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>];</div>
<div class="line"><a name="l08553"></a><span class="lineno"> 8553</span>&#160;    resultsjon[1] = pp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>];</div>
<div class="line"><a name="l08554"></a><span class="lineno"> 8554</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab70c804ef76b5a40c40cc668723ee352">WHICHVELRAMESH</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aed3093e329892ebfc8bce578a2484d68" title="for WHICHVEL 0: 4-velocity (leads to ambiguous u^t +- discr part) 1: 3-velocity (unambiguous u^t but ...">VEL4</a>){</div>
<div class="line"><a name="l08555"></a><span class="lineno"> 8555</span>&#160;      resultsjon[2] = q-&gt;<a class="code" href="../../d1/d83/structof__state.html#aab723d3c7c2c48b7246cc7d7d5379eed">ucon</a>[0];</div>
<div class="line"><a name="l08556"></a><span class="lineno"> 8556</span>&#160;      resultsjon[3] = q-&gt;<a class="code" href="../../d1/d83/structof__state.html#aab723d3c7c2c48b7246cc7d7d5379eed">ucon</a>[1];</div>
<div class="line"><a name="l08557"></a><span class="lineno"> 8557</span>&#160;      resultsjon[4] = q-&gt;<a class="code" href="../../d1/d83/structof__state.html#aab723d3c7c2c48b7246cc7d7d5379eed">ucon</a>[2];</div>
<div class="line"><a name="l08558"></a><span class="lineno"> 8558</span>&#160;      resultsjon[5] = q-&gt;<a class="code" href="../../d1/d83/structof__state.html#aab723d3c7c2c48b7246cc7d7d5379eed">ucon</a>[3];</div>
<div class="line"><a name="l08559"></a><span class="lineno"> 8559</span>&#160;    }</div>
<div class="line"><a name="l08560"></a><span class="lineno"> 8560</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l08561"></a><span class="lineno"> 8561</span>&#160;      resultsjon[2] = 0.0;</div>
<div class="line"><a name="l08562"></a><span class="lineno"> 8562</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) resultsjon[2+jj] = pp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>+jj];</div>
<div class="line"><a name="l08563"></a><span class="lineno"> 8563</span>&#160;    }</div>
<div class="line"><a name="l08564"></a><span class="lineno"> 8564</span>&#160;    resultsjon[6] = pp[URAD0];</div>
<div class="line"><a name="l08565"></a><span class="lineno"> 8565</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab70c804ef76b5a40c40cc668723ee352">WHICHVELRAMESH</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aed3093e329892ebfc8bce578a2484d68" title="for WHICHVEL 0: 4-velocity (leads to ambiguous u^t +- discr part) 1: 3-velocity (unambiguous u^t but ...">VEL4</a>){</div>
<div class="line"><a name="l08566"></a><span class="lineno"> 8566</span>&#160;      resultsjon[7] = q-&gt;<a class="code" href="../../d1/d83/structof__state.html#a3bf8e15ee6ae95831230791baf2fc570">uradcon</a>[0];</div>
<div class="line"><a name="l08567"></a><span class="lineno"> 8567</span>&#160;      resultsjon[8] = q-&gt;<a class="code" href="../../d1/d83/structof__state.html#a3bf8e15ee6ae95831230791baf2fc570">uradcon</a>[1];</div>
<div class="line"><a name="l08568"></a><span class="lineno"> 8568</span>&#160;      resultsjon[9] = q-&gt;<a class="code" href="../../d1/d83/structof__state.html#a3bf8e15ee6ae95831230791baf2fc570">uradcon</a>[2];</div>
<div class="line"><a name="l08569"></a><span class="lineno"> 8569</span>&#160;      resultsjon[10] = q-&gt;<a class="code" href="../../d1/d83/structof__state.html#a3bf8e15ee6ae95831230791baf2fc570">uradcon</a>[3];</div>
<div class="line"><a name="l08570"></a><span class="lineno"> 8570</span>&#160;    }</div>
<div class="line"><a name="l08571"></a><span class="lineno"> 8571</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l08572"></a><span class="lineno"> 8572</span>&#160;      resultsjon[7]=0.0;</div>
<div class="line"><a name="l08573"></a><span class="lineno"> 8573</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) resultsjon[7+jj] = pp[URAD0+jj];</div>
<div class="line"><a name="l08574"></a><span class="lineno"> 8574</span>&#160;    }</div>
<div class="line"><a name="l08575"></a><span class="lineno"> 8575</span>&#160;    resultsjon[11] = (<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a>)failtype;</div>
<div class="line"><a name="l08576"></a><span class="lineno"> 8576</span>&#160;    resultsjon[12] = errorabs[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>];</div>
<div class="line"><a name="l08577"></a><span class="lineno"> 8577</span>&#160;    resultsjon[13] = (<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a>)iters;</div>
<div class="line"><a name="l08578"></a><span class="lineno"> 8578</span>&#160;    resultsjon[14] = radinvmod;</div>
<div class="line"><a name="l08579"></a><span class="lineno"> 8579</span>&#160;</div>
<div class="line"><a name="l08580"></a><span class="lineno"> 8580</span>&#160;    <span class="keywordflow">for</span>(pl=0;pl&lt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad0a3850ca18e612651839ae14ee35c8d">NUMRESULTS</a>;pl++) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;RAMESH1: pl=%d | resultsjon=%21.15g | resultseng=%21.15g resultsent=%21.15g\n&quot;</span>,pl,resultsjon[pl],resultseng[pl],resultsent[pl]);</div>
<div class="line"><a name="l08581"></a><span class="lineno"> 8581</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;RAMESH2: jj=%d utildegasjon=%21.15g utildegaseng=%21.15g utildegasent=%21.15g\n&quot;</span>,jj,pp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>+jj-1],ppeng[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>+jj-1],ppent[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>+jj-1]);</div>
<div class="line"><a name="l08582"></a><span class="lineno"> 8582</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;RAMESH3: jj=%d utilderadjon=%21.15g utilderadeng=%21.15g utilderadent=%21.15g\n&quot;</span>,jj,pp[URAD1+jj-1],ppeng[URAD1+jj-1],ppent[URAD1+jj-1]);</div>
<div class="line"><a name="l08583"></a><span class="lineno"> 8583</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;RAMESH3.5: pl=%d ppeng=%21.15g uueng=%21.15g ppent=%21.15g uuent=%21.15g\n&quot;</span>,pl,ppeng[pl],uueng[pl],ppent[pl],ppeng[pl]);</div>
<div class="line"><a name="l08584"></a><span class="lineno"> 8584</span>&#160;</div>
<div class="line"><a name="l08585"></a><span class="lineno"> 8585</span>&#160;    <span class="comment">// get radiative inversion stuff for Ramesh</span></div>
<div class="line"><a name="l08586"></a><span class="lineno"> 8586</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Er,Utildesq,Utildecon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l08587"></a><span class="lineno"> 8587</span>&#160;</div>
<div class="line"><a name="l08588"></a><span class="lineno"> 8588</span>&#160;    <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a77c546a7fb064266fef5a9e796dc63dc" title="compute ZAMO version of radiation quantities as in paper draft">compute_ZAMORAD</a>(uu0, ptrgeom, &amp;Er, &amp;Utildesq, Utildecon);</div>
<div class="line"><a name="l08589"></a><span class="lineno"> 8589</span>&#160;    dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;RAMESH4: E_r=%21.15g Utildesq=%21.15g Utildecon0=%21.15g Utildecon1=%21.15g Utildecon2=%21.15g Utildecon3=%21.15g\n&quot;</span>,Er,Utildesq,Utildecon[0],Utildecon[1],Utildecon[2],Utildecon[3]);</div>
<div class="line"><a name="l08590"></a><span class="lineno"> 8590</span>&#160;</div>
<div class="line"><a name="l08591"></a><span class="lineno"> 8591</span>&#160;    <span class="keywordflow">if</span>(*failtypeeng==0){</div>
<div class="line"><a name="l08592"></a><span class="lineno"> 8592</span>&#160;      <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a77c546a7fb064266fef5a9e796dc63dc" title="compute ZAMO version of radiation quantities as in paper draft">compute_ZAMORAD</a>(uueng, ptrgeom, &amp;Er, &amp;Utildesq, Utildecon);</div>
<div class="line"><a name="l08593"></a><span class="lineno"> 8593</span>&#160;      dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;RAMESH5: E_r=%21.15g Utildesq=%21.15g Utildecon0=%21.15g Utildecon1=%21.15g Utildecon2=%21.15g Utildecon3=%21.15g\n&quot;</span>,Er,Utildesq,Utildecon[0],Utildecon[1],Utildecon[2],Utildecon[3]);</div>
<div class="line"><a name="l08594"></a><span class="lineno"> 8594</span>&#160;    }</div>
<div class="line"><a name="l08595"></a><span class="lineno"> 8595</span>&#160;</div>
<div class="line"><a name="l08596"></a><span class="lineno"> 8596</span>&#160;    <span class="keywordflow">if</span>(*failtypeent==0){</div>
<div class="line"><a name="l08597"></a><span class="lineno"> 8597</span>&#160;      <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a77c546a7fb064266fef5a9e796dc63dc" title="compute ZAMO version of radiation quantities as in paper draft">compute_ZAMORAD</a>(uuent, ptrgeom, &amp;Er, &amp;Utildesq, Utildecon);</div>
<div class="line"><a name="l08598"></a><span class="lineno"> 8598</span>&#160;      dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;RAMESH6: E_r=%21.15g Utildesq=%21.15g Utildecon0=%21.15g Utildecon1=%21.15g Utildecon2=%21.15g Utildecon3=%21.15g\n&quot;</span>,Er,Utildesq,Utildecon[0],Utildecon[1],Utildecon[2],Utildecon[3]);</div>
<div class="line"><a name="l08599"></a><span class="lineno"> 8599</span>&#160;    }</div>
<div class="line"><a name="l08600"></a><span class="lineno"> 8600</span>&#160;</div>
<div class="line"><a name="l08601"></a><span class="lineno"> 8601</span>&#160;  }<span class="comment">// end if DEBUG</span></div>
<div class="line"><a name="l08602"></a><span class="lineno"> 8602</span>&#160;</div>
<div class="line"><a name="l08603"></a><span class="lineno"> 8603</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l08604"></a><span class="lineno"> 8604</span>&#160;}</div>
<div class="line"><a name="l08605"></a><span class="lineno"> 8605</span>&#160;</div>
<div class="line"><a name="l08606"></a><span class="lineno"> 8606</span>&#160;</div>
<div class="line"><a name="l08607"></a><span class="lineno"> 8607</span>&#160;</div>
<div class="line"><a name="l08608"></a><span class="lineno"> 8608</span>&#160;<span class="keywordtype">int</span> mathematica_report_check(<span class="keywordtype">int</span> radinvmod, <span class="keywordtype">int</span> failtype, <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> failnum, <span class="keywordtype">int</span> gotfirstnofail, <span class="keywordtype">int</span> eomtypelocal, <span class="keywordtype">int</span> itermode, <span class="keywordtype">int</span> baseitermethod, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *errorabs, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *errorabsbestexternal, <span class="keywordtype">int</span> iters, <span class="keywordtype">int</span> totaliters, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> realdt,<span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *ppfirst, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pp, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pb, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *piin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *prtestUiin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *prtestUU0, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *uu0, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *uu, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Uiin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ufin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUf, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUimp, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *q, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *dUother)</div>
<div class="line"><a name="l08609"></a><span class="lineno"> 8609</span>&#160;{</div>
<div class="line"><a name="l08610"></a><span class="lineno"> 8610</span>&#160;  <span class="keywordtype">int</span> jj,kk;</div>
<div class="line"><a name="l08611"></a><span class="lineno"> 8611</span>&#160;  <span class="keywordtype">int</span> pliter,pl;</div>
<div class="line"><a name="l08612"></a><span class="lineno"> 8612</span>&#160;</div>
<div class="line"><a name="l08613"></a><span class="lineno"> 8613</span>&#160;</div>
<div class="line"><a name="l08614"></a><span class="lineno"> 8614</span>&#160;  <span class="keywordflow">if</span>(0){ <span class="comment">// old mathematica style</span></div>
<div class="line"><a name="l08615"></a><span class="lineno"> 8615</span>&#160;    dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;FAILINFO: %d %d %lld %d\ndt=%21.15g\n&quot;</span>,failtype, myid, failnum, gotfirstnofail,realdt);</div>
<div class="line"><a name="l08616"></a><span class="lineno"> 8616</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a59b7ef1517ff22fd4dfce4cf6d380c55" title="loop over all Dimensions; second rank loop">DLOOP</a>(jj,kk) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,&quot;gn%d%d=%21.15g\n&quot;,jj+1,kk+1,ptrgeom-&gt;<a class="code" href="../../dc/dd2/newcodediff_8txt.html#a98399a5a291e3844900ecfbacdcb2da0">gcon</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(jj,kk)]);</div>
<div class="line"><a name="l08617"></a><span class="lineno"> 8617</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a59b7ef1517ff22fd4dfce4cf6d380c55" title="loop over all Dimensions; second rank loop">DLOOP</a>(jj,kk) dualfprintf(fail_file,&quot;gv%d%d=%21.15g\n&quot;,jj+1,kk+1,ptrgeom-&gt;<a class="code" href="../../dc/dd2/newcodediff_8txt.html#a93300df7bd864b90cc8ed9f3d96515ad">gcov</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(jj,kk)]);</div>
<div class="line"><a name="l08618"></a><span class="lineno"> 8618</span>&#160;    <span class="comment">// shows first pp(uu0)</span></div>
<div class="line"><a name="l08619"></a><span class="lineno"> 8619</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) dualfprintf(fail_file,&quot;pp%d=%21.15g\npb%d=%21.15g\nuu0%d=%21.15g\nuu%d=%21.15g\nuui%d=%21.15g\n&quot;,pl,pp[pl],pl,pb[pl],pl,uu0[pl],pl,uu[pl],pl,Uiin[pl]);</div>
<div class="line"><a name="l08620"></a><span class="lineno"> 8620</span>&#160;    struct <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> qreport;</div>
<div class="line"><a name="l08621"></a><span class="lineno"> 8621</span>&#160;    <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a11e17cd8b0594d1ad52e3594aa9f477e" title="find ucon, ucov, bcon, bcov from primitive variables when calling get_state, users of this function e...">get_state</a>(pp,ptrgeom,&amp;qreport);</div>
<div class="line"><a name="l08622"></a><span class="lineno"> 8622</span>&#160;    if(<a class="code" href="../../da/d3e/definit_8h.html#a99ba7daf58b283bc831b8f507f5873a4" title="#define EOMTYPE EOMCOLDGRMHD">EOMRADTYPE</a>!=<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a993e29ef4139116d822d89bccb92180d" title="radiation equations of motion">EOMRADNONE</a>) <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) dualfprintf(fail_file,&quot;uradcon%d=%21.15g\nuradcov%d=%21.15g\n&quot;,jj,qreport.uradcon[jj],jj,qreport.uradcov[jj]);</div>
<div class="line"><a name="l08623"></a><span class="lineno"> 8623</span>&#160;    else <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) dualfprintf(fail_file,&quot;uradcon%d=%21.15g\nuradcov%d=%21.15g\n&quot;,jj,0.0,jj,0.0);</div>
<div class="line"><a name="l08624"></a><span class="lineno"> 8624</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) dualfprintf(fail_file,&quot;ucon%d=%21.15g\nucov%d=%21.15g\n&quot;,jj,qreport.ucon[jj],jj,qreport.ucov[jj]);</div>
<div class="line"><a name="l08625"></a><span class="lineno"> 8625</span>&#160;    <span class="comment">// then do:</span></div>
<div class="line"><a name="l08626"></a><span class="lineno"> 8626</span>&#160;    <span class="comment">// 1) grep -A 134 --text FAILINFO 0_fail.out.grmhd* &gt; fails.txt</span></div>
<div class="line"><a name="l08627"></a><span class="lineno"> 8627</span>&#160;    <span class="comment">// 2) emacs regexp:  \([0-9]\)e\([-+]*[0-9]+\)   -&gt;   \1*10^(\2)</span></div>
<div class="line"><a name="l08628"></a><span class="lineno"> 8628</span>&#160;  }</div>
<div class="line"><a name="l08629"></a><span class="lineno"> 8629</span>&#160;  else{</div>
<div class="line"><a name="l08630"></a><span class="lineno"> 8630</span>&#160;</div>
<div class="line"><a name="l08632"></a><span class="lineno"> 8632</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l08633"></a><span class="lineno"> 8633</span>&#160;    <span class="comment">// Fix-up some terms to avoid nan or inf in output.</span></div>
<div class="line"><a name="l08634"></a><span class="lineno"> 8634</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l08636"></a><span class="lineno"> 8636</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l08637"></a><span class="lineno"> 8637</span>&#160;    <span class="keywordflow">if</span>(!<a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(pp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>])) pp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>;</div>
<div class="line"><a name="l08638"></a><span class="lineno"> 8638</span>&#160;    <span class="keywordflow">if</span>(!<a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(pp[ENTROPY])) pp[ENTROPY]=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>;</div>
<div class="line"><a name="l08639"></a><span class="lineno"> 8639</span>&#160;    <span class="keywordflow">if</span>(!<a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(errorabs[0])) errorabs[0]=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>;</div>
<div class="line"><a name="l08640"></a><span class="lineno"> 8640</span>&#160;    <span class="keywordflow">if</span>(!<a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(errorabs[1])) errorabs[1]=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>;</div>
<div class="line"><a name="l08641"></a><span class="lineno"> 8641</span>&#160;    <span class="keywordflow">if</span>(!<a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(errorabsbestexternal[0])) errorabsbestexternal[0]=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>;</div>
<div class="line"><a name="l08642"></a><span class="lineno"> 8642</span>&#160;    <span class="keywordflow">if</span>(!<a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(errorabsbestexternal[1])) errorabsbestexternal[1]=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>;</div>
<div class="line"><a name="l08643"></a><span class="lineno"> 8643</span>&#160;</div>
<div class="line"><a name="l08645"></a><span class="lineno"> 8645</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l08646"></a><span class="lineno"> 8646</span>&#160;    <span class="comment">// Get state for pp,pb,piin</span></div>
<div class="line"><a name="l08647"></a><span class="lineno"> 8647</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l08649"></a><span class="lineno"> 8649</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l08650"></a><span class="lineno"> 8650</span>&#160;</div>
<div class="line"><a name="l08651"></a><span class="lineno"> 8651</span>&#160;    <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> qpp;</div>
<div class="line"><a name="l08652"></a><span class="lineno"> 8652</span>&#160;    <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a11e17cd8b0594d1ad52e3594aa9f477e" title="find ucon, ucov, bcon, bcov from primitive variables when calling get_state, users of this function e...">get_state</a>(pp,ptrgeom,&amp;qpp);</div>
<div class="line"><a name="l08653"></a><span class="lineno"> 8653</span>&#160;    <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> qpb;</div>
<div class="line"><a name="l08654"></a><span class="lineno"> 8654</span>&#160;    <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a11e17cd8b0594d1ad52e3594aa9f477e" title="find ucon, ucov, bcon, bcov from primitive variables when calling get_state, users of this function e...">get_state</a>(pb,ptrgeom,&amp;qpb);</div>
<div class="line"><a name="l08655"></a><span class="lineno"> 8655</span>&#160;    <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> qpiin;</div>
<div class="line"><a name="l08656"></a><span class="lineno"> 8656</span>&#160;    <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a11e17cd8b0594d1ad52e3594aa9f477e" title="find ucon, ucov, bcon, bcov from primitive variables when calling get_state, users of this function e...">get_state</a>(piin,ptrgeom,&amp;qpiin);</div>
<div class="line"><a name="l08657"></a><span class="lineno"> 8657</span>&#160;</div>
<div class="line"><a name="l08659"></a><span class="lineno"> 8659</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l08660"></a><span class="lineno"> 8660</span>&#160;    <span class="comment">// Output stuff for mathematica</span></div>
<div class="line"><a name="l08661"></a><span class="lineno"> 8661</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l08663"></a><span class="lineno"> 8663</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l08664"></a><span class="lineno"> 8664</span>&#160;    <span class="comment">// 211+11 things</span></div>
<div class="line"><a name="l08665"></a><span class="lineno"> 8665</span>&#160;    dualfprintf(fail_file,<span class="stringliteral">&quot;\nFAILINFO: &quot;</span>);</div>
<div class="line"><a name="l08666"></a><span class="lineno"> 8666</span>&#160;    dualfprintf(fail_file,<span class="stringliteral">&quot;%d %d %d &quot;</span>,NUMARGS,NUMRESULTS,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab70c804ef76b5a40c40cc668723ee352">WHICHVELRAMESH</a>); <span class="comment">// 3</span></div>
<div class="line"><a name="l08667"></a><span class="lineno"> 8667</span>&#160;    dualfprintf(fail_file,<span class="stringliteral">&quot;%d %d %lld %d %d %d %21.15g %21.15g %d %d %21.15g %lld %d %21.15g &quot;</span>,failtype,myid,failnum,gotfirstnofail,eomtypelocal,itermode,errorabs[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5ed1fdd28c13ae84c7668b4a5432f36c">WHICHERROR</a>],errorabsbestexternal[WHICHERROR],iters,totaliters,realdt,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a1a1088d87617078680f1fd0f0d707384">nstep</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a70170b90229f9fc05eebf8508a685c70">steppart</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a5db33bd66a02c92d495409fd6d6c7459" title="GLOBAL PARAMETERS SECTION.">gam</a>); <span class="comment">// 14</span></div>
<div class="line"><a name="l08668"></a><span class="lineno"> 8668</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> trueimptryconv=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afc9b116343212081b674a39ac69ce6ed" title="Funny, even 1E-5 does ok with torus, no worse at Erf~ERADLIMIT instances. Also, does ~3 iterations...">IMPTRYCONV</a>;</div>
<div class="line"><a name="l08669"></a><span class="lineno"> 8669</span>&#160;    dualfprintf(fail_file,<span class="stringliteral">&quot;%21.15g %21.15g %21.15g %21.15g &quot;</span>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a51ef12e4cafc4a8fe70374c37f57d565">GAMMAMAXRAD</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a5bd9da451f108352614cbc457524c5b0">ERADLIMIT</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a37aa5c4b7b1b481299d87bf929d13b15" title="error for comparing to sum over all absolute errors">IMPTRYCONVABS</a>,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8469a53eb25c0eb3b81286c364d0e7f3">IMPALLOWCONVCONSTABS</a>); <span class="comment">// 4</span></div>
<div class="line"><a name="l08670"></a><span class="lineno"> 8670</span>&#160;    dualfprintf(fail_file,<span class="stringliteral">&quot;%21.15g %21.15g %21.15g %21.15g &quot;</span>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a591d275f967baa00b6382aff77362636">ARAD_CODE</a>,calc_kappaes_user(1.0,1.0,0,0,0),calc_kappa_user(1.0,1.0,1.0,1.0,1.0,0,0,0),0.0); <span class="comment">// 4</span></div>
<div class="line"><a name="l08671"></a><span class="lineno"> 8671</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a59b7ef1517ff22fd4dfce4cf6d380c55" title="loop over all Dimensions; second rank loop">DLOOP</a>(jj,kk) dualfprintf(fail_file,&quot;%21.15g &quot;,ptrgeom-&gt;<a class="code" href="../../dc/dd2/newcodediff_8txt.html#a98399a5a291e3844900ecfbacdcb2da0">gcon</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(jj,kk)]); <span class="comment">// 16</span></div>
<div class="line"><a name="l08672"></a><span class="lineno"> 8672</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a59b7ef1517ff22fd4dfce4cf6d380c55" title="loop over all Dimensions; second rank loop">DLOOP</a>(jj,kk) dualfprintf(fail_file,&quot;%21.15g &quot;,ptrgeom-&gt;<a class="code" href="../../dc/dd2/newcodediff_8txt.html#a93300df7bd864b90cc8ed9f3d96515ad">gcov</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(jj,kk)]); <span class="comment">// 16</span></div>
<div class="line"><a name="l08673"></a><span class="lineno"> 8673</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) dualfprintf(fail_file,&quot;%21.15g %21.15g %21.15g %21.15g %21.15g %21.15g %21.15g %21.15g %21.15g &quot;,pp[pl],ppfirst[pl],pb[pl],piin[pl],prtestUiin[pl],prtestUU0[pl],uu0[pl],uu[pl],Uiin[pl]);  <span class="comment">// 9*13</span></div>
<div class="line"><a name="l08674"></a><span class="lineno"> 8674</span>&#160;    if(<a class="code" href="../../da/d3e/definit_8h.html#a99ba7daf58b283bc831b8f507f5873a4" title="#define EOMTYPE EOMCOLDGRMHD">EOMRADTYPE</a>!=<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a993e29ef4139116d822d89bccb92180d" title="radiation equations of motion">EOMRADNONE</a>) <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) dualfprintf(fail_file,&quot;%21.15g %21.15g &quot;,qpp.<a class="code" href="../../d1/d83/structof__state.html#a3bf8e15ee6ae95831230791baf2fc570">uradcon</a>[jj],qpp.<a class="code" href="../../d1/d83/structof__state.html#a87c04c4f890495e87a6682643a0c7955">uradcov</a>[jj]); <span class="comment">// 4*2=8</span></div>
<div class="line"><a name="l08675"></a><span class="lineno"> 8675</span>&#160;    else <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) dualfprintf(fail_file,&quot;%21.15g %21.15g &quot;,0.0,0.0);</div>
<div class="line"><a name="l08676"></a><span class="lineno"> 8676</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) dualfprintf(fail_file,&quot;%21.15g %21.15g &quot;,qpp.<a class="code" href="../../d1/d83/structof__state.html#aab723d3c7c2c48b7246cc7d7d5379eed">ucon</a>[jj],qpp.<a class="code" href="../../d1/d83/structof__state.html#a09881c3d05809ef27f8115d02a835e11">ucov</a>[jj]); <span class="comment">// 4*2=8</span></div>
<div class="line"><a name="l08677"></a><span class="lineno"> 8677</span>&#160;    if(<a class="code" href="../../da/d3e/definit_8h.html#a99ba7daf58b283bc831b8f507f5873a4" title="#define EOMTYPE EOMCOLDGRMHD">EOMRADTYPE</a>!=<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a993e29ef4139116d822d89bccb92180d" title="radiation equations of motion">EOMRADNONE</a>) <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) dualfprintf(fail_file,&quot;%21.15g %21.15g &quot;,qpb.<a class="code" href="../../d1/d83/structof__state.html#a3bf8e15ee6ae95831230791baf2fc570">uradcon</a>[jj],qpb.<a class="code" href="../../d1/d83/structof__state.html#a87c04c4f890495e87a6682643a0c7955">uradcov</a>[jj]); <span class="comment">// 4*2=8</span></div>
<div class="line"><a name="l08678"></a><span class="lineno"> 8678</span>&#160;    else dualfprintf(fail_file,&quot;%21.15g %21.15g &quot;,0.0,0.0);</div>
<div class="line"><a name="l08679"></a><span class="lineno"> 8679</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) dualfprintf(fail_file,&quot;%21.15g %21.15g &quot;,qpb.<a class="code" href="../../d1/d83/structof__state.html#aab723d3c7c2c48b7246cc7d7d5379eed">ucon</a>[jj],qpb.<a class="code" href="../../d1/d83/structof__state.html#a09881c3d05809ef27f8115d02a835e11">ucov</a>[jj]); <span class="comment">// 4*2=8</span></div>
<div class="line"><a name="l08680"></a><span class="lineno"> 8680</span>&#160;    if(<a class="code" href="../../da/d3e/definit_8h.html#a99ba7daf58b283bc831b8f507f5873a4" title="#define EOMTYPE EOMCOLDGRMHD">EOMRADTYPE</a>!=<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a993e29ef4139116d822d89bccb92180d" title="radiation equations of motion">EOMRADNONE</a>) <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) dualfprintf(fail_file,&quot;%21.15g %21.15g &quot;,qpiin.<a class="code" href="../../d1/d83/structof__state.html#a3bf8e15ee6ae95831230791baf2fc570">uradcon</a>[jj],qpiin.<a class="code" href="../../d1/d83/structof__state.html#a87c04c4f890495e87a6682643a0c7955">uradcov</a>[jj]); <span class="comment">// 4*2=8</span></div>
<div class="line"><a name="l08681"></a><span class="lineno"> 8681</span>&#160;    else dualfprintf(fail_file,&quot;%21.15g %21.15g &quot;,0.0,0.0);</div>
<div class="line"><a name="l08682"></a><span class="lineno"> 8682</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) dualfprintf(fail_file,&quot;%21.15g %21.15g &quot;,qpiin.<a class="code" href="../../d1/d83/structof__state.html#aab723d3c7c2c48b7246cc7d7d5379eed">ucon</a>[jj],qpiin.<a class="code" href="../../d1/d83/structof__state.html#a09881c3d05809ef27f8115d02a835e11">ucov</a>[jj]); <span class="comment">// 4*2=8</span></div>
<div class="line"><a name="l08683"></a><span class="lineno"> 8683</span>&#160;    dualfprintf(fail_file,&quot;\n&quot;);</div>
<div class="line"><a name="l08684"></a><span class="lineno"> 8684</span>&#160;</div>
<div class="line"><a name="l08685"></a><span class="lineno"> 8685</span>&#160;</div>
<div class="line"><a name="l08686"></a><span class="lineno"> 8686</span>&#160;</div>
<div class="line"><a name="l08687"></a><span class="lineno"> 8687</span>&#160;    <span class="comment">// get ramesh solution</span></div>
<div class="line"><a name="l08688"></a><span class="lineno"> 8688</span>&#160;    <span class="keywordtype">int</span> whichcall=0; <span class="comment">// debug call</span></div>
<div class="line"><a name="l08689"></a><span class="lineno"> 8689</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ppeng[NPR]={0},ppent[NPR]={0},errorabseng[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa63447acbbbc62cbedae23eac61c716e" title="determine which error will use when deciding if converged or not.">NUMERRORTYPES</a>],errorabsent[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa63447acbbbc62cbedae23eac61c716e" title="determine which error will use when deciding if converged or not.">NUMERRORTYPES</a>];</div>
<div class="line"><a name="l08690"></a><span class="lineno"> 8690</span>&#160;    set_array(errorabseng,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa63447acbbbc62cbedae23eac61c716e" title="determine which error will use when deciding if converged or not.">NUMERRORTYPES</a>,MPI_FTYPE,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>);</div>
<div class="line"><a name="l08691"></a><span class="lineno"> 8691</span>&#160;    set_array(errorabsent,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa63447acbbbc62cbedae23eac61c716e" title="determine which error will use when deciding if converged or not.">NUMERRORTYPES</a>,MPI_FTYPE,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>);</div>
<div class="line"><a name="l08692"></a><span class="lineno"> 8692</span>&#160;</div>
<div class="line"><a name="l08693"></a><span class="lineno"> 8693</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> uueng[NPR]={0},uuent[NPR]={0};</div>
<div class="line"><a name="l08694"></a><span class="lineno"> 8694</span>&#160;    <span class="keywordtype">int</span> failtypeeng=1,failtypeent=1,iterseng=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a58cca3253f4dfcefde5fe864699e297a">IMPMAXITERLONG</a>,itersent=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a58cca3253f4dfcefde5fe864699e297a">IMPMAXITERLONG</a>, radinvmodeng=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ad987489760e6592057a80faf09588c88" title="unfixable inversion problems">UTOPRIMRADFAILBAD1</a>, radinvmodent=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ad987489760e6592057a80faf09588c88" title="unfixable inversion problems">UTOPRIMRADFAILBAD1</a>;</div>
<div class="line"><a name="l08695"></a><span class="lineno"> 8695</span>&#160;    <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> qeng=*q,qent=*q;</div>
<div class="line"><a name="l08696"></a><span class="lineno"> 8696</span>&#160;</div>
<div class="line"><a name="l08697"></a><span class="lineno"> 8697</span>&#160;    <span class="comment">// No longer is rameshsolution() up to date with # of args or opacity physics</span></div>
<div class="line"><a name="l08698"></a><span class="lineno"> 8698</span>&#160;    <span class="comment">//    get_rameshsolution(whichcall, radinvmod, failtype, failnum,  gotfirstnofail,  eomtypelocal,  itermode, baseitermethod, errorabs, errorabsbestexternal,  iters,  totaliters,realdt, ptrgeom, pp, pb, piin, uu0, uu, Uiin, Ufin, CUf, CUimp, q, ppeng, ppent, uueng, uuent, &amp;qeng, &amp;qent, &amp;failtypeeng, errorabseng, &amp;iterseng, &amp;radinvmodeng, &amp;failtypeent, errorabsent, &amp;itersent, &amp;radinvmodent);</span></div>
<div class="line"><a name="l08699"></a><span class="lineno"> 8699</span>&#160;</div>
<div class="line"><a name="l08700"></a><span class="lineno"> 8700</span>&#160;</div>
<div class="line"><a name="l08701"></a><span class="lineno"> 8701</span>&#160;</div>
<div class="line"><a name="l08703"></a><span class="lineno"> 8703</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l08704"></a><span class="lineno"> 8704</span>&#160;    <span class="comment">// FAILRETURNABLE</span></div>
<div class="line"><a name="l08705"></a><span class="lineno"> 8705</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l08707"></a><span class="lineno"> 8707</span>&#160;<span class="comment"></span>    dualfprintf(fail_file,<span class="stringliteral">&quot;\nFAILREPEATABLE: %d %d %lld : &quot;</span>,failtype,myid,failnum);</div>
<div class="line"><a name="l08708"></a><span class="lineno"> 8708</span>&#160;    dualfprintf(fail_file,<span class="stringliteral">&quot;dt=%21.15g;CUf[2]=%21.15g;gam=%21.15g;&quot;</span>,realdt,CUf[2],<a class="code" href="../../d8/d5b/defs_8general_8h.html#a5db33bd66a02c92d495409fd6d6c7459" title="GLOBAL PARAMETERS SECTION.">gam</a>);</div>
<div class="line"><a name="l08709"></a><span class="lineno"> 8709</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) dualfprintf(fail_file,&quot;pp[%d]=%21.15g;ppfirst[%d]=%21.15g;pb[%d]=%21.15g;piin[%d]=%21.15g;Uiin[%d]=%21.15g;Ufin[%d]=%21.15g;dUother[%d]=%21.15g;&quot;,pl,pp[pl],pl,ppfirst[pl],pl,pb[pl],pl,piin[pl],pl,Uiin[pl],pl,Ufin[pl],pl,dUother[pl]);</div>
<div class="line"><a name="l08710"></a><span class="lineno"> 8710</span>&#160;     <span class="comment">// ptrgeom stuff</span></div>
<div class="line"><a name="l08711"></a><span class="lineno"> 8711</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a59b7ef1517ff22fd4dfce4cf6d380c55" title="loop over all Dimensions; second rank loop">DLOOP</a>(jj,kk) dualfprintf(fail_file,&quot;ptrgeom-&gt;<a class="code" href="../../dc/dd2/newcodediff_8txt.html#a93300df7bd864b90cc8ed9f3d96515ad">gcov</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(%d,%d)]=%21.15g;ptrgeom-&gt;<a class="code" href="../../dc/dd2/newcodediff_8txt.html#a98399a5a291e3844900ecfbacdcb2da0">gcon</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(%d,%d)]=%21.15g;&quot;,jj,kk,ptrgeom-&gt;<a class="code" href="../../dc/dd2/newcodediff_8txt.html#a93300df7bd864b90cc8ed9f3d96515ad">gcov</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(jj,kk)],jj,kk,ptrgeom-&gt;<a class="code" href="../../dc/dd2/newcodediff_8txt.html#a98399a5a291e3844900ecfbacdcb2da0">gcon</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(jj,kk)]);</div>
<div class="line"><a name="l08712"></a><span class="lineno"> 8712</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) dualfprintf(fail_file,&quot;ptrgeom-&gt;gcovpert[%d]=%21.15g;ptrgeom-&gt;<a class="code" href="../../d8/d60/init_8c.html#a355acd73443366a551c12ccc7eab9f52">beta</a>[%d]=%21.15g;&quot;,jj,ptrgeom-&gt;gcovpert[jj],jj,ptrgeom-&gt;<a class="code" href="../../d8/d60/init_8c.html#a355acd73443366a551c12ccc7eab9f52">beta</a>[jj]);</div>
<div class="line"><a name="l08713"></a><span class="lineno"> 8713</span>&#160;    dualfprintf(fail_file,&quot;ptrgeom-&gt;alphalapse=%21.15g;ptrgeom-&gt;betasqoalphasq=%21.15g;ptrgeom-&gt;<a class="code" href="../../dc/dd2/newcodediff_8txt.html#a597ef3c829c23db3a2637f8b3aefe240">gdet</a>=%21.15g;ptrgeom-&gt;igdetnosing=%21.15g;ptrgeom-&gt;<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>=%d;ptrgeom-&gt;<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>=%d;ptrgeom-&gt;k=%d;ptrgeom-&gt;<a class="code" href="../../d9/d54/other6_8txt.html#a4c46d2d3bb1db943c0dce6af1c779ff5">p</a>=%d;&quot;,ptrgeom-&gt;alphalapse,ptrgeom-&gt;betasqoalphasq,ptrgeom-&gt;<a class="code" href="../../dc/dd2/newcodediff_8txt.html#a597ef3c829c23db3a2637f8b3aefe240">gdet</a>,ptrgeom-&gt;igdetnosing,ptrgeom-&gt;<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>,ptrgeom-&gt;<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>,ptrgeom-&gt;k,ptrgeom-&gt;<a class="code" href="../../d9/d54/other6_8txt.html#a4c46d2d3bb1db943c0dce6af1c779ff5">p</a>);</div>
<div class="line"><a name="l08714"></a><span class="lineno"> 8714</span>&#160;    if(q!=NULL){</div>
<div class="line"><a name="l08715"></a><span class="lineno"> 8715</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) dualfprintf(fail_file,&quot;q-&gt;<a class="code" href="../../d1/d83/structof__state.html#aab723d3c7c2c48b7246cc7d7d5379eed">ucon</a>[%d]=%21.15g;q-&gt;<a class="code" href="../../d1/d83/structof__state.html#a09881c3d05809ef27f8115d02a835e11">ucov</a>[%d]=%21.15g;&quot;,jj,q-&gt;<a class="code" href="../../d1/d83/structof__state.html#aab723d3c7c2c48b7246cc7d7d5379eed">ucon</a>[jj],jj,q-&gt;<a class="code" href="../../d1/d83/structof__state.html#a09881c3d05809ef27f8115d02a835e11">ucov</a>[jj]);</div>
<div class="line"><a name="l08716"></a><span class="lineno"> 8716</span>&#160;      if(<a class="code" href="../../da/d3e/definit_8h.html#a99ba7daf58b283bc831b8f507f5873a4" title="#define EOMTYPE EOMCOLDGRMHD">EOMRADTYPE</a>!=<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a993e29ef4139116d822d89bccb92180d" title="radiation equations of motion">EOMRADNONE</a>) <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) dualfprintf(fail_file,&quot;q-&gt;<a class="code" href="../../d1/d83/structof__state.html#a3bf8e15ee6ae95831230791baf2fc570">uradcon</a>[%d]=%21.15g;q-&gt;<a class="code" href="../../d1/d83/structof__state.html#a87c04c4f890495e87a6682643a0c7955">uradcov</a>[%d]=%21.15g;&quot;,jj,q-&gt;<a class="code" href="../../d1/d83/structof__state.html#a3bf8e15ee6ae95831230791baf2fc570">uradcon</a>[jj],jj,q-&gt;<a class="code" href="../../d1/d83/structof__state.html#a87c04c4f890495e87a6682643a0c7955">uradcov</a>[jj]);</div>
<div class="line"><a name="l08717"></a><span class="lineno"> 8717</span>&#160;      else <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) dualfprintf(fail_file,&quot;q-&gt;<a class="code" href="../../d1/d83/structof__state.html#a3bf8e15ee6ae95831230791baf2fc570">uradcon</a>[%d]=%21.15g;q-&gt;<a class="code" href="../../d1/d83/structof__state.html#a87c04c4f890495e87a6682643a0c7955">uradcov</a>[%d]=%21.15g;&quot;,jj,0.0,jj,0.0);</div>
<div class="line"><a name="l08718"></a><span class="lineno"> 8718</span>&#160;      dualfprintf(fail_file,&quot;q-&gt;<a class="code" href="../../d1/d83/structof__state.html#aab16dc2e08d2b2c558e1f6e06e4efada">pressure</a>=%21.15g;q-&gt;<a class="code" href="../../d1/d83/structof__state.html#a01940142e21045449cb4571d5380c580">entropy</a>=%21.15g;q-&gt;<a class="code" href="../../d1/d83/structof__state.html#a235582e934fdedaa5da9a5deb1ed698a">ifremoverestplus1ud0elseud0</a>=%21.15g;&quot;,q-&gt;<a class="code" href="../../d1/d83/structof__state.html#aab16dc2e08d2b2c558e1f6e06e4efada">pressure</a>,q-&gt;<a class="code" href="../../d1/d83/structof__state.html#a01940142e21045449cb4571d5380c580">entropy</a>,q-&gt;<a class="code" href="../../d1/d83/structof__state.html#a235582e934fdedaa5da9a5deb1ed698a">ifremoverestplus1ud0elseud0</a>);</div>
<div class="line"><a name="l08719"></a><span class="lineno"> 8719</span>&#160;    }</div>
<div class="line"><a name="l08720"></a><span class="lineno"> 8720</span>&#160;    dualfprintf(fail_file,&quot;\n&quot;);</div>
<div class="line"><a name="l08721"></a><span class="lineno"> 8721</span>&#160;    </div>
<div class="line"><a name="l08722"></a><span class="lineno"> 8722</span>&#160;</div>
<div class="line"><a name="l08723"></a><span class="lineno"> 8723</span>&#160;    <span class="comment">// then do:</span></div>
<div class="line"><a name="l08724"></a><span class="lineno"> 8724</span>&#160;    <span class="comment">// 1) grep -h --text FAILINFO 0_fail.out.grmhd* | sed &#39;s/FAILINFO: //g&#39;| sort -T ./ -r -g -k 10 &gt; fails.txt</span></div>
<div class="line"><a name="l08725"></a><span class="lineno"> 8725</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l08726"></a><span class="lineno"> 8726</span>&#160;    <span class="comment">// or:</span></div>
<div class="line"><a name="l08727"></a><span class="lineno"> 8727</span>&#160;    <span class="comment">// grep -h --text FAILINFO 0_fail.out.grmhd* | grep -v &quot;FAILINFO: 100&quot; |grep -v &quot;FAILINFO: 80&quot;| sed &#39;s/FAILINFO: //g&#39; | sort -T ./ -r -g -k 7 &gt; failshigherror.txt ; head -100 failshigherror.txt &gt; failshigherror100.txt</span></div>
<div class="line"><a name="l08728"></a><span class="lineno"> 8728</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l08729"></a><span class="lineno"> 8729</span>&#160;</div>
<div class="line"><a name="l08730"></a><span class="lineno"> 8730</span>&#160;    <span class="comment">// grep --text BAD 0_fail.out.grmhd.00*|wc -l ;  grep FAILINFO 0_fail.out.grmhd.00*|wc -l ; grep MAXF1 0_fail.out.grmhd.00*| wc -l ; grep MAXITER 0_fail.out.grmhd.00*|wc -l ; grep &quot;also failed&quot; 0_fail.out.grmhd.00*|wc -l </span></div>
<div class="line"><a name="l08731"></a><span class="lineno"> 8731</span>&#160;</div>
<div class="line"><a name="l08732"></a><span class="lineno"> 8732</span>&#160;    <span class="comment">// TO CHECK ON DAMPING:</span></div>
<div class="line"><a name="l08733"></a><span class="lineno"> 8733</span>&#160;    <span class="comment">//     grep -i &quot;Damping worked&quot; 0_fail.out.grmhd.00*|wc -l ; grep -i &quot;Damping failed&quot; 0_fail.out.grmhd.00*|wc -l</span></div>
<div class="line"><a name="l08734"></a><span class="lineno"> 8734</span>&#160;</div>
<div class="line"><a name="l08735"></a><span class="lineno"> 8735</span>&#160;    <span class="comment">//   see if any MAXF1ITER: less -S fails.txt| awk &#39;{print $1}&#39;|sort|less</span></div>
<div class="line"><a name="l08736"></a><span class="lineno"> 8736</span>&#160;</div>
<div class="line"><a name="l08737"></a><span class="lineno"> 8737</span>&#160;    <span class="comment">// 2) Choose numfails in below mathematica script</span></div>
<div class="line"><a name="l08738"></a><span class="lineno"> 8738</span>&#160;</div>
<div class="line"><a name="l08739"></a><span class="lineno"> 8739</span>&#160;    <span class="comment">// 3) ~/bin/math &lt; /data/jon/harm_math/solveimplicit_superwrapper.m</span></div>
<div class="line"><a name="l08740"></a><span class="lineno"> 8740</span>&#160;    <span class="comment">// or:  nohup ~/bin/math &lt; /data/jon/harm_math/solveimplicit_superwrapper.m &amp;&gt; math.out &amp;</span></div>
<div class="line"><a name="l08741"></a><span class="lineno"> 8741</span>&#160;    <span class="comment">// or: preferred:  ~/bin/math &lt; /data/jon/harm_math/solveimplicit_superwrapper.m &amp;&gt; math.out &amp;</span></div>
<div class="line"><a name="l08742"></a><span class="lineno"> 8742</span>&#160;</div>
<div class="line"><a name="l08743"></a><span class="lineno"> 8743</span>&#160;    <span class="comment">// 4) grep 0Good math.out</span></div>
<div class="line"><a name="l08744"></a><span class="lineno"> 8744</span>&#160;    <span class="comment">// if any Good&#39;s appear, mathematica found solution when harm did not.  Fix it!</span></div>
<div class="line"><a name="l08745"></a><span class="lineno"> 8745</span>&#160;</div>
<div class="line"><a name="l08746"></a><span class="lineno"> 8746</span>&#160;    <span class="comment">// If any appear in  grep 0WGood math.out   , then precision issue with long doubles in harm even.</span></div>
<div class="line"><a name="l08747"></a><span class="lineno"> 8747</span>&#160;</div>
<div class="line"><a name="l08748"></a><span class="lineno"> 8748</span>&#160;    <span class="comment">// If any appear in  grep 0MGood math.out   , then gammamax case should work!</span></div>
<div class="line"><a name="l08749"></a><span class="lineno"> 8749</span>&#160;</div>
<div class="line"><a name="l08750"></a><span class="lineno"> 8750</span>&#160;    <span class="comment">// 5) More advanced version of #4.  Use check.sh script:</span></div>
<div class="line"><a name="l08751"></a><span class="lineno"> 8751</span>&#160;    <span class="comment">// bash /data/jon/harmgit/scripts/check.sh math.out .  Gives overall report.</span></div>
<div class="line"><a name="l08752"></a><span class="lineno"> 8752</span>&#160;  }</div>
<div class="line"><a name="l08753"></a><span class="lineno"> 8753</span>&#160;</div>
<div class="line"><a name="l08754"></a><span class="lineno"> 8754</span>&#160;</div>
<div class="line"><a name="l08755"></a><span class="lineno"> 8755</span>&#160;</div>
<div class="line"><a name="l08756"></a><span class="lineno"> 8756</span>&#160;  return(0);</div>
<div class="line"><a name="l08757"></a><span class="lineno"> 8757</span>&#160;}</div>
<div class="line"><a name="l08758"></a><span class="lineno"> 8758</span>&#160;</div>
<div class="line"><a name="l08759"></a><span class="lineno"> 8759</span>&#160;</div>
<div class="line"><a name="l08760"></a><span class="lineno"> 8760</span>&#160;</div>
<div class="line"><a name="l08763"></a><span class="lineno"> 8763</span>&#160;static <span class="keywordtype">int</span> f_error_check(<span class="keywordtype">int</span> showmessages, <span class="keywordtype">int</span> showmessagesheavy, <span class="keywordtype">int</span> iter, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> conv, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> convabs, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> realdt, <span class="keywordtype">int</span> dimtypef, <span class="keywordtype">int</span> eomtype, <span class="keywordtype">int</span> radinvmod, <span class="keywordtype">int</span> itermode, <span class="keywordtype">int</span> baseitermethod, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fracenergy, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dissmeasure, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *dimfactU, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pp, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *piin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *fin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *finnorm, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *finreport, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Uiin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *uu0, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *uu, struct <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *errorabs, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *errorallabs, <span class="keywordtype">int</span> whicherror,struct <a class="code" href="../../d6/dbe/structof__method.html">of_method</a> *mtd, struct <a class="code" href="../../d2/d46/structof__ref_u.html">of_refU</a> *ru)</div>
<div class="line"><a name="l08764"></a><span class="lineno"> 8764</span>&#160;{</div>
<div class="line"><a name="l08765"></a><span class="lineno"> 8765</span>&#160;  <span class="keywordtype">int</span> ii,jj;</div>
<div class="line"><a name="l08766"></a><span class="lineno"> 8766</span>&#160;  <span class="keywordtype">int</span> pliter,pl;</div>
<div class="line"><a name="l08767"></a><span class="lineno"> 8767</span>&#160;  <span class="keywordtype">int</span> passedconv[2];</div>
<div class="line"><a name="l08768"></a><span class="lineno"> 8768</span>&#160;</div>
<div class="line"><a name="l08769"></a><span class="lineno"> 8769</span>&#160;  <span class="comment">// default</span></div>
<div class="line"><a name="l08770"></a><span class="lineno"> 8770</span>&#160;  passedconv[0]=passedconv[1]=0;</div>
<div class="line"><a name="l08771"></a><span class="lineno"> 8771</span>&#160;</div>
<div class="line"><a name="l08772"></a><span class="lineno"> 8772</span>&#160;  <span class="comment">// get error</span></div>
<div class="line"><a name="l08773"></a><span class="lineno"> 8773</span>&#160;  <span class="comment">// NOTE: use of gcov[ii,ii] so comparable dimensionally to fin[ru-&gt;erefU[ii]] and finnorm[ru-&gt;erefU[ii]] that are like R^t_\nu and so need sqrt(gcon[nu,nu]) multiplied on them.  This ensures error is non-dimensional (or, really only ^t dimensional)</span></div>
<div class="line"><a name="l08774"></a><span class="lineno"> 8774</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dimfactferr[NPR];</div>
<div class="line"><a name="l08775"></a><span class="lineno"> 8775</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) dimfactferr[pl]=dimfactU[pl]; <span class="comment">// default</span></div>
<div class="line"><a name="l08776"></a><span class="lineno"> 8776</span>&#160;  if(dimtypef==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a6c45d4170066340923e6ec67e05436f4">DIMTYPEFCONS</a>){</div>
<div class="line"><a name="l08777"></a><span class="lineno"> 8777</span>&#160;    <span class="comment">// assume fin and finnorm are conservative or source (R^t_\nu form)</span></div>
<div class="line"><a name="l08778"></a><span class="lineno"> 8778</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(ii) dimfactferr[ru-&gt;erefU[ii]]=dimfactU[ru-&gt;erefU[ii]];</div>
<div class="line"><a name="l08779"></a><span class="lineno"> 8779</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(ii) dimfactferr[ru-&gt;eotherU[ii]]=dimfactU[ru-&gt;eotherU[ii]];</div>
<div class="line"><a name="l08780"></a><span class="lineno"> 8780</span>&#160;  }</div>
<div class="line"><a name="l08781"></a><span class="lineno"> 8781</span>&#160;  else{</div>
<div class="line"><a name="l08782"></a><span class="lineno"> 8782</span>&#160;    <span class="comment">// assume fin and finnorm are primitve (u,vel^i form)</span></div>
<div class="line"><a name="l08783"></a><span class="lineno"> 8783</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(ii) dimfactferr[ru-&gt;erefU[ii]]=1.0/dimfactU[ru-&gt;erefU[ii]];</div>
<div class="line"><a name="l08784"></a><span class="lineno"> 8784</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(ii) dimfactferr[ru-&gt;eotherU[ii]]=1.0/dimfactU[ru-&gt;eotherU[ii]];</div>
<div class="line"><a name="l08785"></a><span class="lineno"> 8785</span>&#160;  }</div>
<div class="line"><a name="l08786"></a><span class="lineno"> 8786</span>&#160;</div>
<div class="line"><a name="l08787"></a><span class="lineno"> 8787</span>&#160;  <span class="comment">// replace finnorm -&gt; finnormnew that&#39;s already non-dimensionalized</span></div>
<div class="line"><a name="l08788"></a><span class="lineno"> 8788</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> finnormnew[NPR];</div>
<div class="line"><a name="l08789"></a><span class="lineno"> 8789</span>&#160;  <span class="comment">// Tds\rho_0 u^t \propto \rho_0 (v/c)^2 or higher  \propto \gamma in ultrarel limit</span></div>
<div class="line"><a name="l08790"></a><span class="lineno"> 8790</span>&#160;  <span class="comment">// T^t_t + \rho_0 u^t \propto \rho_0 (v/c)^2 or higher  \propto \rho_0\gamma^2 in ultrarel limit</span></div>
<div class="line"><a name="l08791"></a><span class="lineno"> 8791</span>&#160;  ii=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>;</div>
<div class="line"><a name="l08792"></a><span class="lineno"> 8792</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fnormtime = fabs(finnorm[ru-&gt;erefU[ii]]*dimfactferr[ru-&gt;erefU[ii]]);</div>
<div class="line"><a name="l08793"></a><span class="lineno"> 8793</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fnormtimeother = fabs(finnorm[ru-&gt;eotherU[ii]]*dimfactferr[ru-&gt;eotherU[ii]]);</div>
<div class="line"><a name="l08794"></a><span class="lineno"> 8794</span>&#160;  <span class="comment">// T^t_i \propto \rho_0 (v/c)^1 or higher  \propto \gamma^2 \rho_0 (v/c) in ultrarel limit</span></div>
<div class="line"><a name="l08795"></a><span class="lineno"> 8795</span>&#160;  <span class="comment">// get spatial contributions as total term so not dominated by small errors in some dimensions</span></div>
<div class="line"><a name="l08796"></a><span class="lineno"> 8796</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fnormspace=0.0; <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(ii) fnormspace += fabs(finnorm[ru-&gt;erefU[ii]]*dimfactferr[ru-&gt;erefU[ii]]);</div>
<div class="line"><a name="l08797"></a><span class="lineno"> 8797</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fnormspaceother=0.0; <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(ii) fnormspaceother += fabs(finnorm[ru-&gt;eotherU[ii]]*dimfactferr[ru-&gt;eotherU[ii]]);</div>
<div class="line"><a name="l08798"></a><span class="lineno"> 8798</span>&#160;</div>
<div class="line"><a name="l08799"></a><span class="lineno"> 8799</span>&#160;  <span class="comment">// need to account for errors when momentum~0</span></div>
<div class="line"><a name="l08800"></a><span class="lineno"> 8800</span>&#160;<span class="preprocessor">#if(0)</span></div>
<div class="line"><a name="l08801"></a><span class="lineno"> 8801</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#if(0)</span></div>
<div class="line"><a name="l08802"></a><span class="lineno"> 8802</span>&#160;<span class="preprocessor"></span>  <span class="comment">// only kinda applicable for QTYPMHD</span></div>
<div class="line"><a name="l08803"></a><span class="lineno"> 8803</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> rhoref=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(pp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>],piin[RHO]);</div>
<div class="line"><a name="l08804"></a><span class="lineno"> 8804</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fnormspace2 = rhoref*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a69bd42b8d6735e7aab1cfae5629cd680">prpow</a>(fabs(fnormtime)/rhoref,0.5); <span class="comment">// energy term in correct scale with \rho_0(v/c)^1 to get reference in case v\sim 0 NOTE: This assumes rho v term dominates</span></div>
<div class="line"><a name="l08805"></a><span class="lineno"> 8805</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fnormtime2=rhoref*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a69bd42b8d6735e7aab1cfae5629cd680">prpow</a>(fabs(fnormspace/rhoref),2.0); <span class="comment">// momentum term in correct scale with \rho_0(v/c)^2 in case E\sim 0.  NOTE: assumes rho v term dominates.</span></div>
<div class="line"><a name="l08806"></a><span class="lineno"> 8806</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l08807"></a><span class="lineno"> 8807</span>&#160;<span class="preprocessor"></span>  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fakevel = <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(1.0,fnormspace/(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a09c78d2f8feb311dd9fc969a0bf84979">SMALL</a>+fnormtime));</div>
<div class="line"><a name="l08808"></a><span class="lineno"> 8808</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fnormspace2 = fabs(fnormtime)*fakevel;</div>
<div class="line"><a name="l08809"></a><span class="lineno"> 8809</span>&#160;  <span class="comment">//  FTYPE fnormtime2 = fabs(fnormspace)/fakevel;</span></div>
<div class="line"><a name="l08810"></a><span class="lineno"> 8810</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fnormtime2 = fnormtime; <span class="comment">// no problem with this since now include absolute sum version</span></div>
<div class="line"><a name="l08811"></a><span class="lineno"> 8811</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l08812"></a><span class="lineno"> 8812</span>&#160;<span class="preprocessor"></span>  <span class="comment">//  dualfprintf(fail_file,&quot;fnormspacetime: %g %g %g %g: uu0=%g fakevel=%g\n&quot;,fnormspace,fnormspace2,fnormtime,fnormtime2,fabs(uu0[ru-&gt;erefU[0]]*dimfactU[ru-&gt;erefU[0]]),fakevel);</span></div>
<div class="line"><a name="l08813"></a><span class="lineno"> 8813</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l08814"></a><span class="lineno"> 8814</span>&#160;<span class="preprocessor"></span>  <span class="comment">// These suggest that velocity can be no better than NUMEPSILON*c=NUMEPSILON, but non-rel velocities can be much smaller.  But with rad inversion, v^i comes from mixed-up R^t_\mu -- catastrophic cancellation issue.  What about MHD?</span></div>
<div class="line"><a name="l08815"></a><span class="lineno"> 8815</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fnormspace2 = fnormtime; <span class="comment">// maybe ok SUPERGODMARK -- problem for very small non-rel velocities. __WORKINGONIT__</span></div>
<div class="line"><a name="l08816"></a><span class="lineno"> 8816</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fnormtime2 = fnormtime; <span class="comment">// no problem with this since now include absolute sum version</span></div>
<div class="line"><a name="l08817"></a><span class="lineno"> 8817</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fnormspaceother2 = fnormtimeother; <span class="comment">// maybe ok SUPERGODMARK -- problem for very small non-rel velocities. __WORKINGONIT__</span></div>
<div class="line"><a name="l08818"></a><span class="lineno"> 8818</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fnormtimeother2 = fnormtimeother; <span class="comment">// no problem with this since now include absolute sum version</span></div>
<div class="line"><a name="l08819"></a><span class="lineno"> 8819</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l08820"></a><span class="lineno"> 8820</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l08821"></a><span class="lineno"> 8821</span>&#160;</div>
<div class="line"><a name="l08822"></a><span class="lineno"> 8822</span>&#160;  <span class="comment">// YFLx (because can be negative (zero) and so can&#39;t use itself only)</span></div>
<div class="line"><a name="l08823"></a><span class="lineno"> 8823</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l08824"></a><span class="lineno"> 8824</span>&#160;    <span class="keywordflow">if</span>(pl==YFL1) finnorm[pl] = fabs(finnorm[pl]) + fabs(finnorm[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>]);</div>
<div class="line"><a name="l08825"></a><span class="lineno"> 8825</span>&#160;    <span class="keywordflow">if</span>(pl==YFL2) finnorm[pl] = fabs(finnorm[pl]) + fabs(finnorm[UU]);</div>
<div class="line"><a name="l08826"></a><span class="lineno"> 8826</span>&#160;    <span class="keywordflow">if</span>(pl==YFL3) finnorm[pl] = fabs(finnorm[pl]) + fabs(finnorm[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8de9104f1fffa59f057b214d74c5cfea">U3</a>]);</div>
<div class="line"><a name="l08827"></a><span class="lineno"> 8827</span>&#160;    <span class="keywordflow">if</span>(pl==YFL4) finnorm[pl] = fabs(finnorm[pl]) + fabs(finnorm[URAD0]);</div>
<div class="line"><a name="l08828"></a><span class="lineno"> 8828</span>&#160;    <span class="keywordflow">if</span>(pl==YFL5) finnorm[pl] = fabs(finnorm[pl]) + fabs(finnorm[URAD3]);</div>
<div class="line"><a name="l08829"></a><span class="lineno"> 8829</span>&#160;  }</div>
<div class="line"><a name="l08830"></a><span class="lineno"> 8830</span>&#160;</div>
<div class="line"><a name="l08831"></a><span class="lineno"> 8831</span>&#160;  <span class="comment">// now assign</span></div>
<div class="line"><a name="l08832"></a><span class="lineno"> 8832</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) finnormnew[pl] = finnorm[pl]; <span class="comment">// default</span></div>
<div class="line"><a name="l08833"></a><span class="lineno"> 8833</span>&#160;  ii=TT; finnormnew[ru-&gt;erefU[ii]] = fnormtime + fnormtime2;</div>
<div class="line"><a name="l08834"></a><span class="lineno"> 8834</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(ii) finnormnew[ru-&gt;erefU[ii]] = fnormspace + fnormspace2;</div>
<div class="line"><a name="l08835"></a><span class="lineno"> 8835</span>&#160;  ii=TT; finnormnew[ru-&gt;eotherU[ii]] = fnormtimeother + fnormtimeother2;</div>
<div class="line"><a name="l08836"></a><span class="lineno"> 8836</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(ii) finnormnew[ru-&gt;eotherU[ii]] = fnormspaceother + fnormspaceother2;</div>
<div class="line"><a name="l08837"></a><span class="lineno"> 8837</span>&#160;</div>
<div class="line"><a name="l08838"></a><span class="lineno"> 8838</span>&#160;</div>
<div class="line"><a name="l08839"></a><span class="lineno"> 8839</span>&#160;  <span class="comment">// get non-dimensionalized fin</span></div>
<div class="line"><a name="l08840"></a><span class="lineno"> 8840</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> finnew[NPR];</div>
<div class="line"><a name="l08841"></a><span class="lineno"> 8841</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) finnew[pl]=fin[pl]*dimfactferr[pl];</div>
<div class="line"><a name="l08842"></a><span class="lineno"> 8842</span>&#160;</div>
<div class="line"><a name="l08843"></a><span class="lineno"> 8843</span>&#160;  <span class="comment">// get relative errors (keep sign)</span></div>
<div class="line"><a name="l08844"></a><span class="lineno"> 8844</span>&#160;  <span class="comment">//  JACLOOPALT(ii,ru-&gt;startjac,ru-&gt;endjac)</span></div>
<div class="line"><a name="l08845"></a><span class="lineno"> 8845</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) finreport[pl]=finnew[pl]/fabs(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a59bf6804cf154be810df9b1b0f83e949">IMPMINABSERROR</a>+fabs(finnormnew[pl]));</div>
<div class="line"><a name="l08846"></a><span class="lineno"> 8846</span>&#160;</div>
<div class="line"><a name="l08847"></a><span class="lineno"> 8847</span>&#160;  <span class="comment">// get absolute error over all (baseitermethod)-iterated terms</span></div>
<div class="line"><a name="l08848"></a><span class="lineno"> 8848</span>&#160;  <span class="comment">// NOTE: the SUBJACJ methods directly use freport[] as needed, not errorabs or passedconv</span></div>
<div class="line"><a name="l08849"></a><span class="lineno"> 8849</span>&#160;  *errorabs=0.0;</div>
<div class="line"><a name="l08850"></a><span class="lineno"> 8850</span>&#160;  <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a60eea34b552378df229a78747fda6857">JACLOOPFULLERROR</a>(itermode,jj,ru-&gt;startjac,ru-&gt;endjac)      *errorabs     += fabs(finreport[ru-&gt;erefU[jj]]); <span class="comment">// always full error.</span></div>
<div class="line"><a name="l08851"></a><span class="lineno"> 8851</span>&#160;</div>
<div class="line"><a name="l08852"></a><span class="lineno"> 8852</span>&#160;  <span class="comment">// completely full relevant error</span></div>
<div class="line"><a name="l08853"></a><span class="lineno"> 8853</span>&#160;  *errorallabs=0.0; <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aef340eabe2a41c05add2b3d8527b0fd0">JACLOOPSUPERFULL</a>(pliter,pl,eomtype,baseitermethod,radinvmod) *errorallabs += fabs(finreport[pl]);</div>
<div class="line"><a name="l08854"></a><span class="lineno"> 8854</span>&#160;</div>
<div class="line"><a name="l08856"></a><span class="lineno"> 8856</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l08857"></a><span class="lineno"> 8857</span>&#160;  <span class="comment">// see if passed convergence test criteria</span></div>
<div class="line"><a name="l08858"></a><span class="lineno"> 8858</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l08860"></a><span class="lineno"> 8860</span>&#160;<span class="comment"></span>  passedconv[0]=(*errorabs&lt;convabs);</div>
<div class="line"><a name="l08861"></a><span class="lineno"> 8861</span>&#160;  passedconv[1]=(*errorallabs&lt;convabs);</div>
<div class="line"><a name="l08862"></a><span class="lineno"> 8862</span>&#160;  </div>
<div class="line"><a name="l08863"></a><span class="lineno"> 8863</span>&#160;  </div>
<div class="line"><a name="l08864"></a><span class="lineno"> 8864</span>&#160;  </div>
<div class="line"><a name="l08865"></a><span class="lineno"> 8865</span>&#160;</div>
<div class="line"><a name="l08866"></a><span class="lineno"> 8866</span>&#160;  <span class="comment">// report if passed convergence test</span></div>
<div class="line"><a name="l08867"></a><span class="lineno"> 8867</span>&#160;  if(passedconv[whicherror]){</div>
<div class="line"><a name="l08868"></a><span class="lineno"> 8868</span>&#160;    <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a7df8286c59d491ba1117884d33499a7a">prod0dualfprintf</a>(showmessagesheavy,fail_file,<span class="stringliteral">&quot;nstep=%ld steppart=%d dt=%g realdt=%g i=%d iter=%d DONE1 for conv=%g : finreport=%g %g %g %g\n&quot;</span>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a1a1088d87617078680f1fd0f0d707384">nstep</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a70170b90229f9fc05eebf8508a685c70">steppart</a>,dt,realdt,ptrgeom-&gt;i,iter,conv,finreport[ru-&gt;erefU[0]],finreport[ru-&gt;erefU[1]],finreport[ru-&gt;erefU[2]],finreport[ru-&gt;erefU[3]]);</div>
<div class="line"><a name="l08869"></a><span class="lineno"> 8869</span>&#160;    <span class="keywordflow">return</span>(1);</div>
<div class="line"><a name="l08870"></a><span class="lineno"> 8870</span>&#160;  }</div>
<div class="line"><a name="l08871"></a><span class="lineno"> 8871</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l08872"></a><span class="lineno"> 8872</span>&#160;    <span class="comment">// report if didn&#39;t pass</span></div>
<div class="line"><a name="l08873"></a><span class="lineno"> 8873</span>&#160;<span class="preprocessor">#if(PRODUCTION==0)</span></div>
<div class="line"><a name="l08874"></a><span class="lineno"> 8874</span>&#160;<span class="preprocessor"></span>    <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a7df8286c59d491ba1117884d33499a7a">prod0dualfprintf</a>(showmessagesheavy,fail_file,<span class="stringliteral">&quot;POSTFIN (conv=%21.15g): uu: %21.15g %21.15g %21.15g %21.15g : uu0=%21.15g %21.15g %21.15g %21.15g\n&quot;</span>,conv,uu[ru-&gt;irefU[0]],uu[ru-&gt;irefU[1]],uu[ru-&gt;irefU[2]],uu[ru-&gt;irefU[3]],uu0[ru-&gt;irefU[0]],uu0[ru-&gt;irefU[1]],uu0[ru-&gt;irefU[2]],uu0[ru-&gt;irefU[3]]);</div>
<div class="line"><a name="l08875"></a><span class="lineno"> 8875</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a7df8286c59d491ba1117884d33499a7a">prod0dualfprintf</a>(showmessagesheavy,fail_file,&quot;pl=%d fin=%21.15g finnorm=%21.15g\n&quot;,pl,fin[pl],finnorm[pl]);</div>
<div class="line"><a name="l08876"></a><span class="lineno"> 8876</span>&#160;    <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a7df8286c59d491ba1117884d33499a7a">prod0dualfprintf</a>(showmessagesheavy,fail_file,&quot;<a class="code" href="../../d8/d5b/defs_8general_8h.html#a1a1088d87617078680f1fd0f0d707384">nstep</a>=%ld <a class="code" href="../../d8/d5b/defs_8general_8h.html#a70170b90229f9fc05eebf8508a685c70">steppart</a>=%d dt=%g i=%d iter=%d : %g %g %g %g\n&quot;,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a1a1088d87617078680f1fd0f0d707384">nstep</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a70170b90229f9fc05eebf8508a685c70">steppart</a>,dt,ptrgeom-&gt;i,iter,finreport[ru-&gt;erefU[0]],finreport[ru-&gt;erefU[1]],finreport[ru-&gt;erefU[2]],finreport[ru-&gt;erefU[3]]);</div>
<div class="line"><a name="l08877"></a><span class="lineno"> 8877</span>&#160;<span class="preprocessor">#endif    </span></div>
<div class="line"><a name="l08878"></a><span class="lineno"> 8878</span>&#160;<span class="preprocessor"></span>    <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l08879"></a><span class="lineno"> 8879</span>&#160;  }</div>
<div class="line"><a name="l08880"></a><span class="lineno"> 8880</span>&#160;</div>
<div class="line"><a name="l08881"></a><span class="lineno"> 8881</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l08882"></a><span class="lineno"> 8882</span>&#160;}</div>
<div class="line"><a name="l08883"></a><span class="lineno"> 8883</span>&#160;</div>
<div class="line"><a name="l08884"></a><span class="lineno"> 8884</span>&#160;</div>
<div class="line"><a name="l08885"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab99044bc2c43ca8e2c2e4bff3b733414"> 8885</a></span>&#160;<span class="preprocessor">#define JDIFFONESIDED 0</span></div>
<div class="line"><a name="l08886"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad30f79890966f9754a0439b796b83192"> 8886</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define JDIFFCENTERED 1</span></div>
<div class="line"><a name="l08887"></a><span class="lineno"> 8887</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l08888"></a><span class="lineno"> 8888</span>&#160;</div>
<div class="line"><a name="l08889"></a><span class="lineno"> 8889</span>&#160;</div>
<div class="line"><a name="l08892"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afa73a2caa3209e565a64f92447058507"> 8892</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afa73a2caa3209e565a64f92447058507" title="calculating approximate Jacobian: dUresid(dUrad,G(Urad))/dUrad = dy(x)/dx then compute inverse Jacobi...">get_implicit_iJ</a>(<span class="keywordtype">int</span> allowbaseitermethodswitch, <span class="keywordtype">int</span> failreturnallowableuse, <span class="keywordtype">int</span> showmessages, <span class="keywordtype">int</span> showmessagesheavy, <span class="keywordtype">int</span> allowlocalfailurefixandnoreport, <span class="keywordtype">int</span> *eomtypelocal, <span class="keywordtype">int</span> whichcap, <span class="keywordtype">int</span> itermode, <span class="keywordtype">int</span> *baseitermethod, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fracenergy, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dissmeasure, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> impepsjac, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> trueimptryconv, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> trueimptryconvabs, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> trueimpallowconvabs, <span class="keywordtype">int</span> trueimpmaxiter, <span class="keywordtype">int</span> iter, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> errorabs, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> errorallabs, <span class="keywordtype">int</span> whicherror, <span class="keywordtype">int</span> dimtypef, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *dimfactU, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Uiin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *uu, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *uup, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *uu0, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *piin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pp, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *ppp, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fracdtG, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> realdt, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *q, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *f1, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *f1norm, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*iJ)[NPR], <span class="keywordtype">int</span> *nummhdinvsreturn, <span class="keyword">struct</span> <a class="code" href="../../d6/dbe/structof__method.html">of_method</a> *mtd, <span class="keyword">struct</span> <a class="code" href="../../d2/d46/structof__ref_u.html">of_refU</a> *ru)</div>
<div class="line"><a name="l08893"></a><span class="lineno"> 8893</span>&#160;{</div>
<div class="line"><a name="l08894"></a><span class="lineno"> 8894</span>&#160;  <span class="keywordtype">int</span> ii,jj;</div>
<div class="line"><a name="l08895"></a><span class="lineno"> 8895</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> qjac=*q; <span class="comment">// not required as input, but set as output.</span></div>
<div class="line"><a name="l08896"></a><span class="lineno"> 8896</span>&#160;</div>
<div class="line"><a name="l08897"></a><span class="lineno"> 8897</span>&#160;  <span class="keywordtype">int</span> eomtypelocallocal=*eomtypelocal; <span class="comment">// default</span></div>
<div class="line"><a name="l08898"></a><span class="lineno"> 8898</span>&#160;</div>
<div class="line"><a name="l08899"></a><span class="lineno"> 8899</span>&#160;  <span class="keywordtype">int</span> JDIFFTYPE;</div>
<div class="line"><a name="l08900"></a><span class="lineno"> 8900</span>&#160;<span class="preprocessor">#if(DOPERF==0)</span></div>
<div class="line"><a name="l08901"></a><span class="lineno"> 8901</span>&#160;<span class="preprocessor"></span>  <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a003b3a1fbd946c173da7ba3c6312e8e1" title="P or U types.">IMPPTYPE</a>(mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>)){</div>
<div class="line"><a name="l08902"></a><span class="lineno"> 8902</span>&#160;    <span class="comment">// with mtd-&gt;implicititer==QTYPMHD, no longer expensive so can do JDIFFCENTERED</span></div>
<div class="line"><a name="l08903"></a><span class="lineno"> 8903</span>&#160;    <span class="comment">// choose:</span></div>
<div class="line"><a name="l08904"></a><span class="lineno"> 8904</span>&#160;    <span class="comment">//    if(itermode==ITERMODENORMAL) JDIFFTYPE=JDIFFCENTERED; // and only helps rarely and makes 2X slower.</span></div>
<div class="line"><a name="l08905"></a><span class="lineno"> 8905</span>&#160;    <span class="comment">//    else if(itermode==ITERMODESTAGES) JDIFFTYPE=JDIFFONESIDED; // seems accurate enough</span></div>
<div class="line"><a name="l08906"></a><span class="lineno"> 8906</span>&#160;    <span class="keywordflow">if</span>(itermode==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a480c56e263c4874ccb40f3bbc1b32032">ITERMODESTAGES</a>) JDIFFTYPE=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad30f79890966f9754a0439b796b83192">JDIFFCENTERED</a>; <span class="comment">// and only helps rarely and makes 2X slower.</span></div>
<div class="line"><a name="l08907"></a><span class="lineno"> 8907</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(itermode==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab9c7390f62ef08325e12b7110621d33a">ITERMODENORMAL</a>) JDIFFTYPE=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab99044bc2c43ca8e2c2e4bff3b733414">JDIFFONESIDED</a>; <span class="comment">// seems accurate enough</span></div>
<div class="line"><a name="l08908"></a><span class="lineno"> 8908</span>&#160;    <span class="comment">//    JDIFFTYPE=JDIFFCENTERED; // and only helps rarely and makes 2X slower.</span></div>
<div class="line"><a name="l08909"></a><span class="lineno"> 8909</span>&#160;    <span class="comment">//    JDIFFTYPE=JDIFFONESIDED; // and only helps rarely and makes 2X slower.</span></div>
<div class="line"><a name="l08910"></a><span class="lineno"> 8910</span>&#160;  }</div>
<div class="line"><a name="l08911"></a><span class="lineno"> 8911</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l08912"></a><span class="lineno"> 8912</span>&#160;    JDIFFTYPE=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab99044bc2c43ca8e2c2e4bff3b733414">JDIFFONESIDED</a>;</div>
<div class="line"><a name="l08913"></a><span class="lineno"> 8913</span>&#160;  }</div>
<div class="line"><a name="l08914"></a><span class="lineno"> 8914</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l08915"></a><span class="lineno"> 8915</span>&#160;<span class="preprocessor"></span>  JDIFFTYPE=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab99044bc2c43ca8e2c2e4bff3b733414">JDIFFONESIDED</a>; <span class="comment">// avoid expense</span></div>
<div class="line"><a name="l08916"></a><span class="lineno"> 8916</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l08917"></a><span class="lineno"> 8917</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l08918"></a><span class="lineno"> 8918</span>&#160;  <span class="comment">// ensure uu and pp don&#39;t get modified by del-shifts to get Jacobian, which can change primitives to order unity at high radiation gamma</span></div>
<div class="line"><a name="l08919"></a><span class="lineno"> 8919</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> uujac[NPR],ppjac[NPR];</div>
<div class="line"><a name="l08920"></a><span class="lineno"> 8920</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> uujacalt[NPR],ppjacalt[NPR];</div>
<div class="line"><a name="l08921"></a><span class="lineno"> 8921</span>&#160;  <span class="keywordtype">int</span> pliter,pl;</div>
<div class="line"><a name="l08922"></a><span class="lineno"> 8922</span>&#160;</div>
<div class="line"><a name="l08923"></a><span class="lineno"> 8923</span>&#160;</div>
<div class="line"><a name="l08925"></a><span class="lineno"> 8925</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l08926"></a><span class="lineno"> 8926</span>&#160;  <span class="comment">// Setup which quantitiy iterating</span></div>
<div class="line"><a name="l08927"></a><span class="lineno"> 8927</span>&#160;  <span class="comment">// Scale-out dimensional stuff before forming predel</span></div>
<div class="line"><a name="l08928"></a><span class="lineno"> 8928</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l08930"></a><span class="lineno"> 8930</span>&#160;<span class="comment"></span>  <span class="comment">// for scaling del&#39;s norm.  Applies to time component to make as if like space component.</span></div>
<div class="line"><a name="l08931"></a><span class="lineno"> 8931</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> upitoup0[NPR], upitoup0U[NPR], upitoup0P[NPR];</div>
<div class="line"><a name="l08932"></a><span class="lineno"> 8932</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> x[NPR],xp[NPR],xjac[2][NPR],xjacalt[NPR];</div>
<div class="line"><a name="l08933"></a><span class="lineno"> 8933</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> velmomscale;</div>
<div class="line"><a name="l08934"></a><span class="lineno"> 8934</span>&#160;</div>
<div class="line"><a name="l08935"></a><span class="lineno"> 8935</span>&#160;  <span class="comment">//  FTYPE dimfactU[NPR];</span></div>
<div class="line"><a name="l08936"></a><span class="lineno"> 8936</span>&#160;  <span class="comment">//  PLOOP(pliter,pl) dimfactU[pl]=1.0; // default</span></div>
<div class="line"><a name="l08937"></a><span class="lineno"> 8937</span>&#160;  <span class="comment">//  DLOOPA(jjdim) dimfactU[UU+jjdim]=dimfactU[URAD0+jjdim]=sqrt(fabs(ptrgeom-&gt;gcon[GIND(jjdim,jjdim)]));</span></div>
<div class="line"><a name="l08938"></a><span class="lineno"> 8938</span>&#160;  <span class="comment">//  SLOOPA(jjdim) dimfactU[B1+jjdim-1] = 1.0/dimfactU[U1+jjdim-1];</span></div>
<div class="line"><a name="l08939"></a><span class="lineno"> 8939</span>&#160;</div>
<div class="line"><a name="l08940"></a><span class="lineno"> 8940</span>&#160;  <span class="comment">// U</span></div>
<div class="line"><a name="l08941"></a><span class="lineno"> 8941</span>&#160;  <span class="comment">// \rho_0 u^t * sqrt(-1/g^{tt})  and most things will be scalars like S u^t as well</span></div>
<div class="line"><a name="l08942"></a><span class="lineno"> 8942</span>&#160;  <span class="comment">// R^t_nu * sqrt(g^{ii}/g^{tt}) = R^t_orthonu</span></div>
<div class="line"><a name="l08943"></a><span class="lineno"> 8943</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) upitoup0U[pl] = dimfactU[pl]*ptrgeom-&gt;alphalapse ;</div>
<div class="line"><a name="l08944"></a><span class="lineno"> 8944</span>&#160;</div>
<div class="line"><a name="l08945"></a><span class="lineno"> 8945</span>&#160;  <span class="comment">// P</span></div>
<div class="line"><a name="l08946"></a><span class="lineno"> 8946</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) upitoup0P[pl] = 1.0; <span class="comment">// comoving quantities</span></div>
<div class="line"><a name="l08947"></a><span class="lineno"> 8947</span>&#160;  <span class="comment">// v^i / sqrt(g^{ii}) = vortho^i</span></div>
<div class="line"><a name="l08948"></a><span class="lineno"> 8948</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) upitoup0P[UU+jj] =upitoup0P[URAD0+jj] = 1.0/dimfactU[UU+jj];</div>
<div class="line"><a name="l08949"></a><span class="lineno"> 8949</span>&#160;</div>
<div class="line"><a name="l08950"></a><span class="lineno"> 8950</span>&#160;</div>
<div class="line"><a name="l08952"></a><span class="lineno"> 8952</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l08953"></a><span class="lineno"> 8953</span>&#160;  <span class="comment">// use uucopy as uu instead of modifying uu in case uu needs adjusting</span></div>
<div class="line"><a name="l08954"></a><span class="lineno"> 8954</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l08956"></a><span class="lineno"> 8956</span>&#160;<span class="comment"></span>  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> uucopy[NPR],ppcopy[NPR];</div>
<div class="line"><a name="l08957"></a><span class="lineno"> 8957</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l08958"></a><span class="lineno"> 8958</span>&#160;    uucopy[pl]=uu[pl];</div>
<div class="line"><a name="l08959"></a><span class="lineno"> 8959</span>&#160;    ppcopy[pl]=pp[pl];</div>
<div class="line"><a name="l08960"></a><span class="lineno"> 8960</span>&#160;  }</div>
<div class="line"><a name="l08961"></a><span class="lineno"> 8961</span>&#160;</div>
<div class="line"><a name="l08962"></a><span class="lineno"> 8962</span>&#160;<span class="preprocessor">#define MAXSIGN(x,y) (fabs(x)&gt;fabs(y) ? (x) : (y))</span></div>
<div class="line"><a name="l08963"></a><span class="lineno"> 8963</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define MINSIGN(x,y) (fabs(x)&lt;fabs(y) ? (x) : (y))</span></div>
<div class="line"><a name="l08964"></a><span class="lineno"> 8964</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l08966"></a><span class="lineno"> 8966</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l08967"></a><span class="lineno"> 8967</span>&#160;  <span class="comment">// check whether origin point is too small relative to uu0</span></div>
<div class="line"><a name="l08968"></a><span class="lineno"> 8968</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l08970"></a><span class="lineno"> 8970</span>&#160;<span class="comment"></span>  <span class="comment">//  JACLOOP(jj,ru-&gt;startjac,ru-&gt;endjac){</span></div>
<div class="line"><a name="l08971"></a><span class="lineno"> 8971</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj){ <span class="comment">// so all related U&#39;s are changed.</span></div>
<div class="line"><a name="l08972"></a><span class="lineno"> 8972</span>&#160;    <span class="comment">//    if(fabs(uucopy[ru-&gt;irefU[jj]])&lt;100.0*NUMEPSILON*fabs(uu0[ru-&gt;irefU[jj]])){</span></div>
<div class="line"><a name="l08973"></a><span class="lineno"> 8973</span>&#160;    <span class="comment">// then set &quot;floor&quot; on uucopy used for Jacobian because otherwise uu is unresolved by f_implicit() error function</span></div>
<div class="line"><a name="l08974"></a><span class="lineno"> 8974</span>&#160;    uucopy[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]]=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a7decdaa8bfa4cb01f2d7178fc5c7acde">MAXSIGN</a>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a7decdaa8bfa4cb01f2d7178fc5c7acde">MAXSIGN</a>(uucopy[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]],100.0*<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a8913cb5d64cfec23ae1a3052930ec468">NUMEPSILON</a>*uu0[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]]),100.0*<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a8913cb5d64cfec23ae1a3052930ec468">NUMEPSILON</a>*uup[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]]);</div>
<div class="line"><a name="l08975"></a><span class="lineno"> 8975</span>&#160;    <span class="comment">// modify associated pp in reasonable way in case P method since otherwise error will be unresolved using that p associated with that uu</span></div>
<div class="line"><a name="l08976"></a><span class="lineno"> 8976</span>&#160;    <span class="comment">// only modify primitives associated with those conserved quantities (i.e. gas uu and pp or rad uu and pp)</span></div>
<div class="line"><a name="l08977"></a><span class="lineno"> 8977</span>&#160;    ppcopy[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]]=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a7decdaa8bfa4cb01f2d7178fc5c7acde">MAXSIGN</a>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a7decdaa8bfa4cb01f2d7178fc5c7acde">MAXSIGN</a>(ppcopy[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]],100.0*<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a8913cb5d64cfec23ae1a3052930ec468">NUMEPSILON</a>*piin[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]]),100.0*<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a8913cb5d64cfec23ae1a3052930ec468">NUMEPSILON</a>*ppp[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]]);</div>
<div class="line"><a name="l08978"></a><span class="lineno"> 8978</span>&#160;  }</div>
<div class="line"><a name="l08979"></a><span class="lineno"> 8979</span>&#160;</div>
<div class="line"><a name="l08980"></a><span class="lineno"> 8980</span>&#160;</div>
<div class="line"><a name="l08981"></a><span class="lineno"> 8981</span>&#160;</div>
<div class="line"><a name="l08983"></a><span class="lineno"> 8983</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l08984"></a><span class="lineno"> 8984</span>&#160;  <span class="comment">// setup origin point for difference</span></div>
<div class="line"><a name="l08985"></a><span class="lineno"> 8985</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l08987"></a><span class="lineno"> 8987</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l08988"></a><span class="lineno"> 8988</span>&#160;  <span class="comment">// U</span></div>
<div class="line"><a name="l08989"></a><span class="lineno"> 8989</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a54453e145c6408911f60070de366b11a">IMPUTYPE</a>(mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>)){</div>
<div class="line"><a name="l08990"></a><span class="lineno"> 8990</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) x[pl]=uucopy[pl];</div>
<div class="line"><a name="l08991"></a><span class="lineno"> 8991</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) xp[pl]=uup[pl];</div>
<div class="line"><a name="l08992"></a><span class="lineno"> 8992</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) xjac[0][pl]=xjac[1][pl]=xjacalt[pl]=uucopy[pl];</div>
<div class="line"><a name="l08993"></a><span class="lineno"> 8993</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) upitoup0[pl] = upitoup0U[pl];</div>
<div class="line"><a name="l08994"></a><span class="lineno"> 8994</span>&#160;    <span class="comment">// velmomscale is set such that when (e.g.) T^t_i is near zero, we use T^t_t as reference since we consider T^t_i/T^t_t to be velocity scale that is up to order unity.</span></div>
<div class="line"><a name="l08995"></a><span class="lineno"> 8995</span>&#160;    <span class="comment">//    velmomscale=prpow(fabs(x[ru-&gt;irefU[TT]]*upitoup0[ru-&gt;irefU[TT]]),1.5);</span></div>
<div class="line"><a name="l08996"></a><span class="lineno"> 8996</span>&#160;    velmomscale=<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a69bd42b8d6735e7aab1cfae5629cd680">prpow</a>(fabs(x[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[TT]]*upitoup0[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[TT]]),1.0); <span class="comment">// __WORKINGONIT__</span></div>
<div class="line"><a name="l08997"></a><span class="lineno"> 8997</span>&#160;  }</div>
<div class="line"><a name="l08998"></a><span class="lineno"> 8998</span>&#160;  <span class="comment">// P</span></div>
<div class="line"><a name="l08999"></a><span class="lineno"> 8999</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a003b3a1fbd946c173da7ba3c6312e8e1" title="P or U types.">IMPPTYPE</a>(mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>)){</div>
<div class="line"><a name="l09000"></a><span class="lineno"> 9000</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) x[pl]=ppcopy[pl];</div>
<div class="line"><a name="l09001"></a><span class="lineno"> 9001</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) xp[pl]=ppp[pl];</div>
<div class="line"><a name="l09002"></a><span class="lineno"> 9002</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) xjac[0][pl]=xjac[1][pl]=xjacalt[pl]=ppcopy[pl];</div>
<div class="line"><a name="l09003"></a><span class="lineno"> 9003</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) upitoup0[pl] = upitoup0P[pl];</div>
<div class="line"><a name="l09004"></a><span class="lineno"> 9004</span>&#160;    <span class="comment">// for velocity, assume ortho-scale is order unity (i.e. v=1.0*c)</span></div>
<div class="line"><a name="l09005"></a><span class="lineno"> 9005</span>&#160;    <span class="comment">//    velmomscale=1.0; // reference scale considered to be order unity  KORALTODO: Not sure if should use something like T^t_i/T^t_t with denominator something more non-zero-ish.</span></div>
<div class="line"><a name="l09006"></a><span class="lineno"> 9006</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a4d6b9e1b70703c6aa1d0f9dd9a7acb6b" title="MHD or RAD type.">IMPMHDTYPE</a>(mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>)) velmomscale=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a09c78d2f8feb311dd9fc969a0bf84979">SMALL</a>,sqrt(fabs(x[UU])/<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(ppp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>],ppcopy[RHO]))); <span class="comment">// u_g/\rho_0\propto (v/c)^2, so this gives \propto (v/c) .  Leads to more problems for RADTUBE</span></div>
<div class="line"><a name="l09007"></a><span class="lineno"> 9007</span>&#160;    <span class="keywordflow">else</span> velmomscale=1.0; <span class="comment">// __WORKINGONIT__</span></div>
<div class="line"><a name="l09008"></a><span class="lineno"> 9008</span>&#160;</div>
<div class="line"><a name="l09009"></a><span class="lineno"> 9009</span>&#160;    <span class="comment">// limit</span></div>
<div class="line"><a name="l09010"></a><span class="lineno"> 9010</span>&#160;    velmomscale=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(1.0,velmomscale);</div>
<div class="line"><a name="l09011"></a><span class="lineno"> 9011</span>&#160;</div>
<div class="line"><a name="l09012"></a><span class="lineno"> 9012</span>&#160;    <span class="comment">//    velmomscale=1.0; // __WORKINGONIT__</span></div>
<div class="line"><a name="l09013"></a><span class="lineno"> 9013</span>&#160;  }</div>
<div class="line"><a name="l09014"></a><span class="lineno"> 9014</span>&#160;</div>
<div class="line"><a name="l09016"></a><span class="lineno"> 9016</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l09017"></a><span class="lineno"> 9017</span>&#160;  <span class="comment">// form pre-del</span></div>
<div class="line"><a name="l09018"></a><span class="lineno"> 9018</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l09020"></a><span class="lineno"> 9020</span>&#160;<span class="comment"></span>  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> delspace,deltime,predel[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l09021"></a><span class="lineno"> 9021</span>&#160;</div>
<div class="line"><a name="l09022"></a><span class="lineno"> 9022</span>&#160;  <span class="comment">// get everything in terms of quasi-orthonormal quantities</span></div>
<div class="line"><a name="l09023"></a><span class="lineno"> 9023</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> vsqnorm=0.0;</div>
<div class="line"><a name="l09024"></a><span class="lineno"> 9024</span>&#160;  <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad362268c94979b8c041e986c54f7f59e">JACLOOPALT</a>(jj,ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#a9f3d856dcdd8fa240dfbdcedfad888ef">startjac</a>,ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#af67164c1a42e2aefe0603597dd2ea25e">endjac</a>){</div>
<div class="line"><a name="l09025"></a><span class="lineno"> 9025</span>&#160;    predel[jj] = fabs(x[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]]*upitoup0[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]]);</div>
<div class="line"><a name="l09026"></a><span class="lineno"> 9026</span>&#160;    <span class="keywordflow">if</span>(ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]==UU || ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]==URAD0 || <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a54453e145c6408911f60070de366b11a">IMPUTYPE</a>(mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>)){</div>
<div class="line"><a name="l09027"></a><span class="lineno"> 9027</span>&#160;      <span class="comment">// below makes sense because U and ferr are linear in x and same dimensional units</span></div>
<div class="line"><a name="l09028"></a><span class="lineno"> 9028</span>&#160;      <span class="comment">// TT term (e.g. u_g) can be too small primitive or otherwise, so use maximum of ferr, uu, and x.</span></div>
<div class="line"><a name="l09029"></a><span class="lineno"> 9029</span>&#160;      <span class="comment">// This avoids issue with Jacobian giving J44[0][0]=0 so that can&#39;t iterate u_g because u_g itself is very small.</span></div>
<div class="line"><a name="l09030"></a><span class="lineno"> 9030</span>&#160;      predel[jj] = <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(predel[jj],fabs(uup[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]]*upitoup0U[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]]));</div>
<div class="line"><a name="l09031"></a><span class="lineno"> 9031</span>&#160;      predel[jj] = <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(predel[jj],fabs(uu0[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]]*upitoup0U[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]]));</div>
<div class="line"><a name="l09032"></a><span class="lineno"> 9032</span>&#160;      <span class="comment">// using error function to normalize is too risky since error is not linear in irefU.  e.g., error is not linear in u_g.</span></div>
<div class="line"><a name="l09033"></a><span class="lineno"> 9033</span>&#160;      <span class="comment">//      predel[jj] = MAX(predel[jj],fabs(f1[ru-&gt;erefU[jj]]*upitoup0U[ru-&gt;erefU[jj]]));</span></div>
<div class="line"><a name="l09034"></a><span class="lineno"> 9034</span>&#160;      <span class="comment">//      predel[jj] = MAX(predel[jj],fabs(f1norm[ru-&gt;erefU[jj]]*upitoup0U[ru-&gt;erefU[jj]]));</span></div>
<div class="line"><a name="l09035"></a><span class="lineno"> 9035</span>&#160;    }</div>
<div class="line"><a name="l09036"></a><span class="lineno"> 9036</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l09037"></a><span class="lineno"> 9037</span>&#160;      <span class="comment">// if primitive velocity, then different units than conserved or error function that have energy density scale</span></div>
<div class="line"><a name="l09038"></a><span class="lineno"> 9038</span>&#160;    }</div>
<div class="line"><a name="l09039"></a><span class="lineno"> 9039</span>&#160;</div>
<div class="line"><a name="l09040"></a><span class="lineno"> 9040</span>&#160;    <span class="keywordflow">if</span>((jj==1 || jj==2 || jj==3) &amp;&amp; <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a003b3a1fbd946c173da7ba3c6312e8e1" title="P or U types.">IMPPTYPE</a>(mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>)){</div>
<div class="line"><a name="l09041"></a><span class="lineno"> 9041</span>&#160;      <span class="comment">// v^2 quasi-orthonormal</span></div>
<div class="line"><a name="l09042"></a><span class="lineno"> 9042</span>&#160;      vsqnorm += fabs(x[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]]*upitoup0[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]])*fabs(x[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]]*upitoup0[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]]);</div>
<div class="line"><a name="l09043"></a><span class="lineno"> 9043</span>&#160;    }</div>
<div class="line"><a name="l09044"></a><span class="lineno"> 9044</span>&#160;  }</div>
<div class="line"><a name="l09045"></a><span class="lineno"> 9045</span>&#160;  <span class="comment">// limit</span></div>
<div class="line"><a name="l09046"></a><span class="lineno"> 9046</span>&#160;  vsqnorm=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(1.0,vsqnorm);</div>
<div class="line"><a name="l09047"></a><span class="lineno"> 9047</span>&#160;</div>
<div class="line"><a name="l09049"></a><span class="lineno"> 9049</span>&#160;  <span class="comment">// form delspace that absorbs all spatial values into a single dimensionless scale to avoid one dimensions smallness causing issues.</span></div>
<div class="line"><a name="l09050"></a><span class="lineno"> 9050</span>&#160;  <span class="comment">// KORALTODO: Maybe causes problems if Jacobian becomes singular because no change in small velocity-momentum values when should be change.  But can&#39;t resolve it really, so should be ok.</span></div>
<div class="line"><a name="l09051"></a><span class="lineno"> 9051</span>&#160;  <span class="comment">// NOTE: If JACLOOPALT doesn&#39;t include momentum, the below doesn&#39;t hurt.</span></div>
<div class="line"><a name="l09053"></a><span class="lineno"> 9053</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l09054"></a><span class="lineno"> 9054</span>&#160;  <span class="comment">// Add all spatial terms in quasi-orthonormal way</span></div>
<div class="line"><a name="l09055"></a><span class="lineno"> 9055</span>&#160;  <span class="comment">// Also add (u_g)^{1/2} \propto \rho_0(v/c)</span></div>
<div class="line"><a name="l09056"></a><span class="lineno"> 9056</span>&#160;  delspace=0.0; <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) delspace = <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(delspace,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(fabs(predel[jj]) , velmomscale )); <span class="comment">// dimensionless-ortho</span></div>
<div class="line"><a name="l09057"></a><span class="lineno"> 9057</span>&#160;</div>
<div class="line"><a name="l09058"></a><span class="lineno"> 9058</span>&#160;  <span class="comment">//__WORKINGONIT__: Needs to improve and be more general</span></div>
<div class="line"><a name="l09059"></a><span class="lineno"> 9059</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa8c4409b81bebfe2ff9dc6f2f1c2472a" title="PMHD types.">IMPPMHDTYPE</a>(mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>)){</div>
<div class="line"><a name="l09060"></a><span class="lineno"> 9060</span>&#160;    <span class="comment">// u_g goes like \rho_0 v^2</span></div>
<div class="line"><a name="l09061"></a><span class="lineno"> 9061</span>&#160;    jj=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>; deltime = <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(fabs(predel[jj]),<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(ppp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>],ppcopy[RHO])*vsqnorm); <span class="comment">// __WORKINGONIT__ : Leads to more problems for RADTUBE</span></div>
<div class="line"><a name="l09062"></a><span class="lineno"> 9062</span>&#160;    <span class="comment">//jj=TT; deltime = fabs(predel[jj]);</span></div>
<div class="line"><a name="l09063"></a><span class="lineno"> 9063</span>&#160;  }</div>
<div class="line"><a name="l09064"></a><span class="lineno"> 9064</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a003b3a1fbd946c173da7ba3c6312e8e1" title="P or U types.">IMPPTYPE</a>(mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>)){</div>
<div class="line"><a name="l09065"></a><span class="lineno"> 9065</span>&#160;    jj=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>; deltime = fabs(predel[jj]);</div>
<div class="line"><a name="l09066"></a><span class="lineno"> 9066</span>&#160;  }</div>
<div class="line"><a name="l09067"></a><span class="lineno"> 9067</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l09068"></a><span class="lineno"> 9068</span>&#160;    jj=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>; deltime = fabs(predel[jj]);</div>
<div class="line"><a name="l09069"></a><span class="lineno"> 9069</span>&#160;  }</div>
<div class="line"><a name="l09070"></a><span class="lineno"> 9070</span>&#160;</div>
<div class="line"><a name="l09072"></a><span class="lineno"> 9072</span>&#160;  <span class="comment">// back to actual spatial dimension-space scale for application to x and xjac</span></div>
<div class="line"><a name="l09073"></a><span class="lineno"> 9073</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) predel[jj] = delspace/upitoup0[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]];</div>
<div class="line"><a name="l09074"></a><span class="lineno"> 9074</span>&#160;</div>
<div class="line"><a name="l09075"></a><span class="lineno"> 9075</span>&#160;</div>
<div class="line"><a name="l09076"></a><span class="lineno"> 9076</span>&#160;</div>
<div class="line"><a name="l09077"></a><span class="lineno"> 9077</span>&#160;  <span class="comment">// back to actual time dimension scale</span></div>
<div class="line"><a name="l09078"></a><span class="lineno"> 9078</span>&#160;  <span class="comment">// NOTE: If JACLOOPALT doesn&#39;t include energy, the below doesn&#39;t hurt.</span></div>
<div class="line"><a name="l09079"></a><span class="lineno"> 9079</span>&#160;  jj=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>;</div>
<div class="line"><a name="l09080"></a><span class="lineno"> 9080</span>&#160;  predel[jj] = predel[jj]/upitoup0[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]];</div>
<div class="line"><a name="l09081"></a><span class="lineno"> 9081</span>&#160;</div>
<div class="line"><a name="l09082"></a><span class="lineno"> 9082</span>&#160;</div>
<div class="line"><a name="l09083"></a><span class="lineno"> 9083</span>&#160;</div>
<div class="line"><a name="l09084"></a><span class="lineno"> 9084</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> J[NPR][NPR];</div>
<div class="line"><a name="l09085"></a><span class="lineno"> 9085</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> f2[2][NPR],f2norm[2][NPR],f2report[2][NPR],errorabsf2[<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa63447acbbbc62cbedae23eac61c716e" title="determine which error will use when deciding if converged or not.">NUMERRORTYPES</a>];</div>
<div class="line"><a name="l09086"></a><span class="lineno"> 9086</span>&#160;  set_array(errorabsf2,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa63447acbbbc62cbedae23eac61c716e" title="determine which error will use when deciding if converged or not.">NUMERRORTYPES</a>,MPI_FTYPE,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>);</div>
<div class="line"><a name="l09087"></a><span class="lineno"> 9087</span>&#160;</div>
<div class="line"><a name="l09088"></a><span class="lineno"> 9088</span>&#160;  <span class="comment">// set defaults for one-sided case.</span></div>
<div class="line"><a name="l09089"></a><span class="lineno"> 9089</span>&#160;  <span class="keywordflow">if</span>(JDIFFTYPE==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab99044bc2c43ca8e2c2e4bff3b733414">JDIFFONESIDED</a>){</div>
<div class="line"><a name="l09090"></a><span class="lineno"> 9090</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) f2[0][pl]=f1[pl];</div>
<div class="line"><a name="l09091"></a><span class="lineno"> 9091</span>&#160;    <span class="comment">//  Note that xjac[0] already set correctly.</span></div>
<div class="line"><a name="l09092"></a><span class="lineno"> 9092</span>&#160;  }</div>
<div class="line"><a name="l09093"></a><span class="lineno"> 9093</span>&#160;</div>
<div class="line"><a name="l09094"></a><span class="lineno"> 9094</span>&#160;  <span class="keywordtype">int</span> failreturn;</div>
<div class="line"><a name="l09095"></a><span class="lineno"> 9095</span>&#160;  <span class="keywordtype">int</span> fulljaciter=0;</div>
<div class="line"><a name="l09096"></a><span class="lineno"> 9096</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> FRACIMPEPSCHANGE=0.1;</div>
<div class="line"><a name="l09097"></a><span class="lineno"> 9097</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> del;</div>
<div class="line"><a name="l09098"></a><span class="lineno"> 9098</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> IMPEPSSTART=impepsjac;</div>
<div class="line"><a name="l09099"></a><span class="lineno"> 9099</span>&#160;  <span class="keywordflow">while</span>(1){ <span class="comment">// ensuring that Jacobian is non-singular if only because del too small (and then if singular, increase del)</span></div>
<div class="line"><a name="l09100"></a><span class="lineno"> 9100</span>&#160;</div>
<div class="line"><a name="l09101"></a><span class="lineno"> 9101</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> localIMPEPS=IMPEPSSTART; <span class="comment">// start with fresh del</span></div>
<div class="line"><a name="l09102"></a><span class="lineno"> 9102</span>&#160;    </div>
<div class="line"><a name="l09103"></a><span class="lineno"> 9103</span>&#160;    <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a33e29fbc91c598484cbeb76769ce1fd2">JACLOOP</a>(jj,ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#a9f3d856dcdd8fa240dfbdcedfad888ef">startjac</a>,ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#af67164c1a42e2aefe0603597dd2ea25e">endjac</a>){</div>
<div class="line"><a name="l09104"></a><span class="lineno"> 9104</span>&#160;</div>
<div class="line"><a name="l09105"></a><span class="lineno"> 9105</span>&#160;      <span class="keywordtype">int</span> sided,signside;</div>
<div class="line"><a name="l09106"></a><span class="lineno"> 9106</span>&#160;      <span class="keywordtype">int</span> numsides=2; <span class="comment">// fixed at 2</span></div>
<div class="line"><a name="l09107"></a><span class="lineno"> 9107</span>&#160;      <span class="keywordflow">for</span>(sided=0;sided&lt;numsides;sided++){</div>
<div class="line"><a name="l09108"></a><span class="lineno"> 9108</span>&#160;        <span class="keywordflow">if</span>(JDIFFTYPE==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab99044bc2c43ca8e2c2e4bff3b733414">JDIFFONESIDED</a> &amp;&amp; sided==0) <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l09109"></a><span class="lineno"> 9109</span>&#160;</div>
<div class="line"><a name="l09110"></a><span class="lineno"> 9110</span>&#160;        <span class="comment">// want chosen energy to have controlled drop, so other energy rises and doesn&#39;t drop out of bounds</span></div>
<div class="line"><a name="l09111"></a><span class="lineno"> 9111</span>&#160;        <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a003b3a1fbd946c173da7ba3c6312e8e1" title="P or U types.">IMPPTYPE</a>(mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>)){</div>
<div class="line"><a name="l09112"></a><span class="lineno"> 9112</span>&#160;          <span class="keywordflow">if</span>(sided==1) signside=-1.0;</div>
<div class="line"><a name="l09113"></a><span class="lineno"> 9113</span>&#160;          <span class="keywordflow">else</span> signside=+1.0;</div>
<div class="line"><a name="l09114"></a><span class="lineno"> 9114</span>&#160;        }</div>
<div class="line"><a name="l09115"></a><span class="lineno"> 9115</span>&#160;        <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l09116"></a><span class="lineno"> 9116</span>&#160;          <span class="keywordflow">if</span>(sided==1) signside=+1.0;</div>
<div class="line"><a name="l09117"></a><span class="lineno"> 9117</span>&#160;          <span class="keywordflow">else</span> signside=-1.0;</div>
<div class="line"><a name="l09118"></a><span class="lineno"> 9118</span>&#160;        }</div>
<div class="line"><a name="l09119"></a><span class="lineno"> 9119</span>&#160;</div>
<div class="line"><a name="l09120"></a><span class="lineno"> 9120</span>&#160;        <span class="keywordflow">while</span>(1){</div>
<div class="line"><a name="l09121"></a><span class="lineno"> 9121</span>&#160;</div>
<div class="line"><a name="l09122"></a><span class="lineno"> 9122</span>&#160;          <span class="comment">// when |irefU[0]|&gt;&gt;|irefU[1]|, then can&#39;t get better than machine error on irefU[0], not irefU[1], so using small del just for irefU[1] makes no sense, so avoid above</span></div>
<div class="line"><a name="l09123"></a><span class="lineno"> 9123</span>&#160;          del = localIMPEPS*predel[jj];</div>
<div class="line"><a name="l09124"></a><span class="lineno"> 9124</span>&#160;</div>
<div class="line"><a name="l09125"></a><span class="lineno"> 9125</span>&#160;         </div>
<div class="line"><a name="l09126"></a><span class="lineno"> 9126</span>&#160;          <span class="comment">// origin point</span></div>
<div class="line"><a name="l09127"></a><span class="lineno"> 9127</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) xjac[sided][pl]=xjacalt[pl]=x[pl];</div>
<div class="line"><a name="l09128"></a><span class="lineno"> 9128</span>&#160;</div>
<div class="line"><a name="l09129"></a><span class="lineno"> 9129</span>&#160;         </div>
<div class="line"><a name="l09130"></a><span class="lineno"> 9130</span>&#160;          <span class="keywordflow">if</span>(JDIFFTYPE==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab99044bc2c43ca8e2c2e4bff3b733414">JDIFFONESIDED</a> &amp;&amp; sided==1){</div>
<div class="line"><a name="l09131"></a><span class="lineno"> 9131</span>&#160;            <span class="keywordflow">if</span>(*baseitermethod==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9cf5ca7f5e5aa1e0bdef53abe3f27c1c">QTYPMHD</a> || *baseitermethod==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#add9bc1d07725fe2851182eccaa8eb385">QTYPRAD</a>){</div>
<div class="line"><a name="l09132"></a><span class="lineno"> 9132</span>&#160;              <span class="comment">// then choose direction so that decrease u_g and decreases magnitude of \gamma</span></div>
<div class="line"><a name="l09133"></a><span class="lineno"> 9133</span>&#160;              <span class="keywordflow">if</span>(x[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]]&gt;0.0){</div>
<div class="line"><a name="l09134"></a><span class="lineno"> 9134</span>&#160;                xjac[sided][ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]]=x[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]] + signside*del;</div>
<div class="line"><a name="l09135"></a><span class="lineno"> 9135</span>&#160;                xjacalt[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]]=x[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]] - signside*del;</div>
<div class="line"><a name="l09136"></a><span class="lineno"> 9136</span>&#160;              }</div>
<div class="line"><a name="l09137"></a><span class="lineno"> 9137</span>&#160;              <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l09138"></a><span class="lineno"> 9138</span>&#160;                xjac[sided][ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]]=x[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]] - signside*del;</div>
<div class="line"><a name="l09139"></a><span class="lineno"> 9139</span>&#160;                xjacalt[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]]=x[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]] + signside*del;</div>
<div class="line"><a name="l09140"></a><span class="lineno"> 9140</span>&#160;              }</div>
<div class="line"><a name="l09141"></a><span class="lineno"> 9141</span>&#160;            }</div>
<div class="line"><a name="l09142"></a><span class="lineno"> 9142</span>&#160;            <span class="keywordflow">else</span> <span class="keywordflow">if</span>(*baseitermethod==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad919bedc37c48678c11e7e45cd1394cf">QTYURAD</a>){</div>
<div class="line"><a name="l09143"></a><span class="lineno"> 9143</span>&#160;              <span class="comment">// ensure R^t_t decreases so Erf doesn&#39;t drop out</span></div>
<div class="line"><a name="l09144"></a><span class="lineno"> 9144</span>&#160;              <span class="keywordflow">if</span>(x[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]]&gt;0.0){</div>
<div class="line"><a name="l09145"></a><span class="lineno"> 9145</span>&#160;                xjac[sided][ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]]=x[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]] + signside*del*(jj==TT ? -1.0 : 1.0);</div>
<div class="line"><a name="l09146"></a><span class="lineno"> 9146</span>&#160;                xjacalt[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]]=x[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]] - signside*del*(jj==TT ? -1.0 : 1.0);</div>
<div class="line"><a name="l09147"></a><span class="lineno"> 9147</span>&#160;              }</div>
<div class="line"><a name="l09148"></a><span class="lineno"> 9148</span>&#160;              <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l09149"></a><span class="lineno"> 9149</span>&#160;                xjac[sided][ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]]=x[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]] - signside*del*(jj==TT ? -1.0 : 1.0);</div>
<div class="line"><a name="l09150"></a><span class="lineno"> 9150</span>&#160;                xjacalt[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]]=x[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]] + signside*del*(jj==TT ? -1.0 : 1.0);</div>
<div class="line"><a name="l09151"></a><span class="lineno"> 9151</span>&#160;              }</div>
<div class="line"><a name="l09152"></a><span class="lineno"> 9152</span>&#160;            }</div>
<div class="line"><a name="l09153"></a><span class="lineno"> 9153</span>&#160;            <span class="keywordflow">else</span> <span class="keywordflow">if</span>(*baseitermethod==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aea080032b13db4a71781aee78fef9902" title="whether iterate or have as error function: MHD T^t_ or RAD R^t_, etc.">QTYUMHD</a>){</div>
<div class="line"><a name="l09154"></a><span class="lineno"> 9154</span>&#160;              <span class="comment">// STILL for this method, ensure R^t_t decreases so Erf doesn&#39;t drop out</span></div>
<div class="line"><a name="l09155"></a><span class="lineno"> 9155</span>&#160;              <span class="keywordflow">if</span>(x[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]]&gt;0.0){</div>
<div class="line"><a name="l09156"></a><span class="lineno"> 9156</span>&#160;                xjac[sided][ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]]=x[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]] - signside*del*(jj==TT ? -1.0 : 1.0);</div>
<div class="line"><a name="l09157"></a><span class="lineno"> 9157</span>&#160;                xjacalt[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]]=x[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]] + signside*del*(jj==TT ? -1.0 : 1.0);</div>
<div class="line"><a name="l09158"></a><span class="lineno"> 9158</span>&#160;              }</div>
<div class="line"><a name="l09159"></a><span class="lineno"> 9159</span>&#160;              <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l09160"></a><span class="lineno"> 9160</span>&#160;                xjac[sided][ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]]=x[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]] + signside*del*(jj==TT ? -1.0 : 1.0);</div>
<div class="line"><a name="l09161"></a><span class="lineno"> 9161</span>&#160;                xjacalt[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]]=x[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]] - signside*del*(jj==TT ? -1.0 : 1.0);</div>
<div class="line"><a name="l09162"></a><span class="lineno"> 9162</span>&#160;              }</div>
<div class="line"><a name="l09163"></a><span class="lineno"> 9163</span>&#160;            }</div>
<div class="line"><a name="l09164"></a><span class="lineno"> 9164</span>&#160;            <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l09165"></a><span class="lineno"> 9165</span>&#160;              xjac[sided][ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]]=x[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]] + signside*del;</div>
<div class="line"><a name="l09166"></a><span class="lineno"> 9166</span>&#160;              xjacalt[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]]=x[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]] - signside*del;</div>
<div class="line"><a name="l09167"></a><span class="lineno"> 9167</span>&#160;            }</div>
<div class="line"><a name="l09168"></a><span class="lineno"> 9168</span>&#160;          }</div>
<div class="line"><a name="l09169"></a><span class="lineno"> 9169</span>&#160;          <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l09170"></a><span class="lineno"> 9170</span>&#160;            <span class="comment">// offset xjac (KORALTODO: How to ensure this doesn&#39;t have machine precision problems or is good enough difference?)</span></div>
<div class="line"><a name="l09171"></a><span class="lineno"> 9171</span>&#160;            xjac[sided][ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]]=x[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]] + signside*del; <span class="comment">// KORALNOTE: Not sure why koral was using uup or xp here.  Should use x (or uu or pp) because as updated from f_implicit() and uup or ppp for xp hasn&#39;t been set yet, so not consistent with desired jacobian or ferr for Newton step.</span></div>
<div class="line"><a name="l09172"></a><span class="lineno"> 9172</span>&#160;            xjacalt[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]]=x[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]] - signside*del;</div>
<div class="line"><a name="l09173"></a><span class="lineno"> 9173</span>&#160;            <span class="comment">//          dualfprintf(fail_file,&quot;NEW: jj=%d del=%g xjac=%g x=%g\n&quot;,jj,del,xjac[sided][ru-&gt;irefU[jj]],x[ru-&gt;irefU[jj]]);</span></div>
<div class="line"><a name="l09174"></a><span class="lineno"> 9174</span>&#160;          }</div>
<div class="line"><a name="l09175"></a><span class="lineno"> 9175</span>&#160;</div>
<div class="line"><a name="l09176"></a><span class="lineno"> 9176</span>&#160;          <span class="comment">// set uujac and ppjac using xjac</span></div>
<div class="line"><a name="l09177"></a><span class="lineno"> 9177</span>&#160;          <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a54453e145c6408911f60070de366b11a">IMPUTYPE</a>(mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>)){</div>
<div class="line"><a name="l09178"></a><span class="lineno"> 9178</span>&#160;            <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l09179"></a><span class="lineno"> 9179</span>&#160;              uujac[pl]=xjac[sided][pl];</div>
<div class="line"><a name="l09180"></a><span class="lineno"> 9180</span>&#160;              uujacalt[pl]=xjacalt[pl];</div>
<div class="line"><a name="l09181"></a><span class="lineno"> 9181</span>&#160;              ppjac[pl]=ppjacalt[pl]=ppcopy[pl];</div>
<div class="line"><a name="l09182"></a><span class="lineno"> 9182</span>&#160;            }</div>
<div class="line"><a name="l09183"></a><span class="lineno"> 9183</span>&#160;          }</div>
<div class="line"><a name="l09184"></a><span class="lineno"> 9184</span>&#160;          <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a003b3a1fbd946c173da7ba3c6312e8e1" title="P or U types.">IMPPTYPE</a>(mtd-&gt;<a class="code" href="../../d6/dbe/structof__method.html#afd3ae8b5f4b49948aba4c15fdfeff33d">implicititer</a>)){</div>
<div class="line"><a name="l09185"></a><span class="lineno"> 9185</span>&#160;            <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l09186"></a><span class="lineno"> 9186</span>&#160;              uujac[pl]=uujacalt[pl]=uucopy[pl];</div>
<div class="line"><a name="l09187"></a><span class="lineno"> 9187</span>&#160;              ppjac[pl]=xjac[sided][pl];</div>
<div class="line"><a name="l09188"></a><span class="lineno"> 9188</span>&#160;              ppjacalt[pl]=xjacalt[pl];</div>
<div class="line"><a name="l09189"></a><span class="lineno"> 9189</span>&#160;            }</div>
<div class="line"><a name="l09190"></a><span class="lineno"> 9190</span>&#160;            <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a2e2505ff5f52002b4119c4e41ec4f7b8" title="whether to ensure rho and u_g in Jacobian calculation difference do not cross over 0 and stay on same...">FORCEJDIFFNOCROSS</a>){</div>
<div class="line"><a name="l09191"></a><span class="lineno"> 9191</span>&#160;              <span class="comment">// constrain that which enters jacobian</span></div>
<div class="line"><a name="l09192"></a><span class="lineno"> 9192</span>&#160;              <span class="keywordtype">int</span> subjj;</div>
<div class="line"><a name="l09193"></a><span class="lineno"> 9193</span>&#160;              <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a33e29fbc91c598484cbeb76769ce1fd2">JACLOOP</a>(subjj,ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#a9f3d856dcdd8fa240dfbdcedfad888ef">startjac</a>,ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#af67164c1a42e2aefe0603597dd2ea25e">endjac</a>){</div>
<div class="line"><a name="l09194"></a><span class="lineno"> 9194</span>&#160;                pl=ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[subjj];</div>
<div class="line"><a name="l09195"></a><span class="lineno"> 9195</span>&#160;                <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ppmin=100.0*<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a8913cb5d64cfec23ae1a3052930ec468">NUMEPSILON</a>*fabs(predel[subjj]);</div>
<div class="line"><a name="l09196"></a><span class="lineno"> 9196</span>&#160;                <span class="comment">//            FTYPE umin=calc_PEQ_ufromTrho(TEMPMIN,ppjac[RHO]);</span></div>
<div class="line"><a name="l09197"></a><span class="lineno"> 9197</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l09198"></a><span class="lineno"> 9198</span>&#160;                <span class="keywordflow">if</span>(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#aee91c8e98d94e4d8a80a5b4b6d64a84b">POSPL</a>(pl)){</div>
<div class="line"><a name="l09199"></a><span class="lineno"> 9199</span>&#160;                  <span class="keywordflow">if</span>(xjac[sided][pl]&lt;ppmin &amp;&amp; x[pl]&gt;0.0){</div>
<div class="line"><a name="l09200"></a><span class="lineno"> 9200</span>&#160;                    xjac[sided][pl]=ppmin;</div>
<div class="line"><a name="l09201"></a><span class="lineno"> 9201</span>&#160;                    <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a7df8286c59d491ba1117884d33499a7a">prod0dualfprintf</a>(debugfail&gt;=3,fail_file,<span class="stringliteral">&quot;Got 1: sided=%d\n&quot;</span>,sided);</div>
<div class="line"><a name="l09202"></a><span class="lineno"> 9202</span>&#160;                  }</div>
<div class="line"><a name="l09203"></a><span class="lineno"> 9203</span>&#160;                  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(xjac[sided][pl]&gt;-ppmin &amp;&amp; x[pl]&lt;0.0){</div>
<div class="line"><a name="l09204"></a><span class="lineno"> 9204</span>&#160;                    xjac[sided][pl]=-ppmin;</div>
<div class="line"><a name="l09205"></a><span class="lineno"> 9205</span>&#160;                    <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a7df8286c59d491ba1117884d33499a7a">prod0dualfprintf</a>(debugfail&gt;=3,fail_file,<span class="stringliteral">&quot;Got 2: sided=%d\n&quot;</span>,sided);</div>
<div class="line"><a name="l09206"></a><span class="lineno"> 9206</span>&#160;                  }</div>
<div class="line"><a name="l09207"></a><span class="lineno"> 9207</span>&#160;                  <span class="comment">// now fix ppjac</span></div>
<div class="line"><a name="l09208"></a><span class="lineno"> 9208</span>&#160;                  ppjac[pl]=xjac[sided][pl];</div>
<div class="line"><a name="l09209"></a><span class="lineno"> 9209</span>&#160;                }<span class="comment">// end if supposed to normally be positive value quantity</span></div>
<div class="line"><a name="l09210"></a><span class="lineno"> 9210</span>&#160;              }</div>
<div class="line"><a name="l09211"></a><span class="lineno"> 9211</span>&#160;            }</div>
<div class="line"><a name="l09212"></a><span class="lineno"> 9212</span>&#160;          } </div>
<div class="line"><a name="l09213"></a><span class="lineno"> 9213</span>&#160;</div>
<div class="line"><a name="l09214"></a><span class="lineno"> 9214</span>&#160;</div>
<div class="line"><a name="l09215"></a><span class="lineno"> 9215</span>&#160;          <span class="comment">// get dUresid for this offset xjac</span></div>
<div class="line"><a name="l09216"></a><span class="lineno"> 9216</span>&#160;          <span class="keywordtype">int</span> whichcall=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a195d482ffa46307e2e7ed74f457d5300">FIMPLICITCALLTYPEJAC</a>;</div>
<div class="line"><a name="l09217"></a><span class="lineno"> 9217</span>&#160;          eomtypelocallocal=*eomtypelocal; <span class="comment">// re-default</span></div>
<div class="line"><a name="l09218"></a><span class="lineno"> 9218</span>&#160;          <span class="keywordtype">int</span> fakeiter=iter;</div>
<div class="line"><a name="l09219"></a><span class="lineno"> 9219</span>&#160;          <span class="keywordtype">int</span> fakef1iter=-1;</div>
<div class="line"><a name="l09220"></a><span class="lineno"> 9220</span>&#160;          <span class="keywordtype">int</span> radinvmod=0; <span class="comment">// ignore, assume normal error check will be where this information is used.</span></div>
<div class="line"><a name="l09221"></a><span class="lineno"> 9221</span>&#160;          <span class="comment">//          dualfprintf(fail_file,&quot;iJ calls f_implicit: iter=%d\n&quot;,iter);</span></div>
<div class="line"><a name="l09222"></a><span class="lineno"> 9222</span>&#160;          <span class="keywordtype">int</span> goexplicitfake; <span class="comment">// in Jacobian, so don&#39;t try to abort.</span></div>
<div class="line"><a name="l09223"></a><span class="lineno"> 9223</span>&#160;          <span class="keywordtype">int</span> convreturnf2;</div>
<div class="line"><a name="l09224"></a><span class="lineno"> 9224</span>&#160;          <span class="keywordtype">int</span> whichcapnew=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#af4a8ea9a61541490ee05c096ae984f20">CAPTYPEFIX2</a>; <span class="comment">// so Erf stays well-defined even if innaccurate a bit.  So J stays well-defined so iJ doesn&#39;t nan-out</span></div>
<div class="line"><a name="l09225"></a><span class="lineno"> 9225</span>&#160;          <span class="comment">//          PLOOP(pliter,pl) dualfprintf(fail_file,&quot;pl=%d ppjac=%21.15g uu0=%21.15g uujac=%21.15g\n&quot;,pl,ppjac[pl],uu0[pl],uujac[pl]);</span></div>
<div class="line"><a name="l09226"></a><span class="lineno"> 9226</span>&#160;          <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> tautotmaxreturn;</div>
<div class="line"><a name="l09227"></a><span class="lineno"> 9227</span>&#160;          failreturn=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#af46d2b1cf89a70a7e2ef503146c649a9" title="uu0 - original cons.">f_implicit</a>(allowbaseitermethodswitch, fakeiter,fakef1iter,failreturnallowableuse, whichcall,localIMPEPS,showmessages,showmessagesheavy, allowlocalfailurefixandnoreport, &amp;eomtypelocallocal, whichcapnew,itermode, baseitermethod, fracenergy, dissmeasure, &amp;radinvmod, trueimptryconv, trueimptryconvabs, trueimpallowconvabs, trueimpmaxiter, realdt, dimtypef, dimfactU, ppjacalt, ppjac,piin,uujacalt, Uiin,uu0,uujac,fracdtG*realdt,ptrgeom,&amp;qjac,f2[sided],f2norm[sided],f2report[sided], &amp;goexplicitfake, &amp;errorabsf2[0], &amp;errorabsf2[1], whicherror, &amp;convreturnf2, nummhdinvsreturn, &amp;tautotmaxreturn, mtd, ru);</div>
<div class="line"><a name="l09228"></a><span class="lineno"> 9228</span>&#160;          <span class="keywordflow">if</span>(failreturn){ <span class="comment">// __WORKINGONIT__: Noticed if ==1 (radinv failure), then hits this and tries again.  Maybe costly, and maybe not required with CAPTYPEFIX2 used at least for PMHD,PRAD methods.</span></div>
<div class="line"><a name="l09229"></a><span class="lineno"> 9229</span>&#160;            <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a7df8286c59d491ba1117884d33499a7a">prod0dualfprintf</a>(showmessages&amp;&amp; debugfail&gt;=2,fail_file,<span class="stringliteral">&quot;f_implicit for f2 failed: jj=%d.  Trying smaller localIMPEPS=%g (giving del=%g) to %g\n&quot;</span>,jj,localIMPEPS,del,localIMPEPS*FRACIMPEPSCHANGE);</div>
<div class="line"><a name="l09230"></a><span class="lineno"> 9230</span>&#160;            localIMPEPS*=FRACIMPEPSCHANGE;</div>
<div class="line"><a name="l09231"></a><span class="lineno"> 9231</span>&#160;            <span class="comment">// try making smaller until no error, unless doesn&#39;t work out</span></div>
<div class="line"><a name="l09232"></a><span class="lineno"> 9232</span>&#160;            <span class="comment">// see if will be able to resolve differences</span></div>
<div class="line"><a name="l09233"></a><span class="lineno"> 9233</span>&#160;            <span class="keywordtype">int</span> baddiff = fabs(xjac[sided][ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]]-x[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]])/(fabs(xjac[sided][ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]])+fabs(x[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]])) &lt; 10.0*<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a8913cb5d64cfec23ae1a3052930ec468">NUMEPSILON</a>;</div>
<div class="line"><a name="l09234"></a><span class="lineno"> 9234</span>&#160;            <span class="keywordflow">if</span>(localIMPEPS&lt;10.0*<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a8913cb5d64cfec23ae1a3052930ec468">NUMEPSILON</a> || baddiff){</div>
<div class="line"><a name="l09235"></a><span class="lineno"> 9235</span>&#160;              <span class="comment">// then probably can&#39;t resolve difference due to too small </span></div>
<div class="line"><a name="l09236"></a><span class="lineno"> 9236</span>&#160;              <span class="keywordflow">if</span>(failreturnallowableuse&gt;=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a3dc38d50c77a49ac41a760b684ad7aab">UTOPRIMGENWRAPPERRETURNFAILRAD</a>){</div>
<div class="line"><a name="l09237"></a><span class="lineno"> 9237</span>&#160;                <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a7df8286c59d491ba1117884d33499a7a">prod0dualfprintf</a>(debugfail&gt;=2,fail_file,<span class="stringliteral">&quot;Bad error: f_implicit for f2 failed: jj=%d with localIMPEPS=%g (giving del=%g)\n&quot;</span>,jj,localIMPEPS,del);</div>
<div class="line"><a name="l09238"></a><span class="lineno"> 9238</span>&#160;                <span class="keywordflow">return</span>(1); <span class="comment">// can&#39;t go below machine precision for difference else will be 0-0 and no reversion to do.</span></div>
<div class="line"><a name="l09239"></a><span class="lineno"> 9239</span>&#160;              }</div>
<div class="line"><a name="l09240"></a><span class="lineno"> 9240</span>&#160;              <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l09241"></a><span class="lineno"> 9241</span>&#160;                <span class="comment">// instead of failing, allow radiation error, and restart process</span></div>
<div class="line"><a name="l09242"></a><span class="lineno"> 9242</span>&#160;                failreturnallowableuse=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a3dc38d50c77a49ac41a760b684ad7aab">UTOPRIMGENWRAPPERRETURNFAILRAD</a>; <span class="comment">// just changes value in this function only.  Assume that once do this, applies to all further terms in Jacobian.</span></div>
<div class="line"><a name="l09243"></a><span class="lineno"> 9243</span>&#160;                localIMPEPS=IMPEPSSTART; <span class="comment">// start with fresh del</span></div>
<div class="line"><a name="l09244"></a><span class="lineno"> 9244</span>&#160;              }</div>
<div class="line"><a name="l09245"></a><span class="lineno"> 9245</span>&#160;            }</div>
<div class="line"><a name="l09246"></a><span class="lineno"> 9246</span>&#160;          }<span class="comment">// end if failreturn!=0</span></div>
<div class="line"><a name="l09247"></a><span class="lineno"> 9247</span>&#160;          <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l09248"></a><span class="lineno"> 9248</span>&#160;            <span class="comment">// didn&#39;t fail</span></div>
<div class="line"><a name="l09249"></a><span class="lineno"> 9249</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l09250"></a><span class="lineno"> 9250</span>&#160;          }</div>
<div class="line"><a name="l09251"></a><span class="lineno"> 9251</span>&#160;        }<span class="comment">// end while(1), checking if ferr failed due to (e.g.) inversion issue.</span></div>
<div class="line"><a name="l09252"></a><span class="lineno"> 9252</span>&#160;      }<span class="comment">// end sided=0,1</span></div>
<div class="line"><a name="l09253"></a><span class="lineno"> 9253</span>&#160;      </div>
<div class="line"><a name="l09254"></a><span class="lineno"> 9254</span>&#160;</div>
<div class="line"><a name="l09255"></a><span class="lineno"> 9255</span>&#160;      <span class="comment">// get Jacobian</span></div>
<div class="line"><a name="l09256"></a><span class="lineno"> 9256</span>&#160;      <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a33e29fbc91c598484cbeb76769ce1fd2">JACLOOP</a>(ii,ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#a9f3d856dcdd8fa240dfbdcedfad888ef">startjac</a>,ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#af67164c1a42e2aefe0603597dd2ea25e">endjac</a>) J[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[ii]][ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]]=(f2[1][ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[ii]] - f2[0][ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[ii]])/(xjac[1][ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]]-xjac[0][ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]]);</div>
<div class="line"><a name="l09257"></a><span class="lineno"> 9257</span>&#160;</div>
<div class="line"><a name="l09258"></a><span class="lineno"> 9258</span>&#160;      <span class="comment">//JACLOOP(ii,ru-&gt;startjac,ru-&gt;endjac) dualfprintf(fail_file,&quot;NEW: ii=%d jj=%d J=%g : %g %g : %g %g\n&quot;,ii,jj,J[ru-&gt;erefU[ii]][ru-&gt;irefU[jj]], f2[1][ru-&gt;erefU[ii]],f2[0][ru-&gt;erefU[ii]],xjac[1][ru-&gt;irefU[jj]],xjac[0][ru-&gt;irefU[jj]]);</span></div>
<div class="line"><a name="l09259"></a><span class="lineno"> 9259</span>&#160;</div>
<div class="line"><a name="l09260"></a><span class="lineno"> 9260</span>&#160;</div>
<div class="line"><a name="l09261"></a><span class="lineno"> 9261</span>&#160;<span class="preprocessor">#if(PRODUCTION==0)</span></div>
<div class="line"><a name="l09262"></a><span class="lineno"> 9262</span>&#160;<span class="preprocessor"></span>      <span class="comment">// debug info</span></div>
<div class="line"><a name="l09263"></a><span class="lineno"> 9263</span>&#160;      <span class="keywordflow">if</span>(debugfail&gt;=2){</div>
<div class="line"><a name="l09264"></a><span class="lineno"> 9264</span>&#160;        <span class="keywordtype">int</span> badcond=0;</div>
<div class="line"><a name="l09265"></a><span class="lineno"> 9265</span>&#160;        <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a33e29fbc91c598484cbeb76769ce1fd2">JACLOOP</a>(ii,ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#a9f3d856dcdd8fa240dfbdcedfad888ef">startjac</a>,ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#af67164c1a42e2aefe0603597dd2ea25e">endjac</a>){</div>
<div class="line"><a name="l09266"></a><span class="lineno"> 9266</span>&#160;          <span class="keywordflow">if</span>(showmessagesheavy || !<a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(J[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[ii]][ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]])|| fabs(J[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[jj]][ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]])&lt;<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a09c78d2f8feb311dd9fc969a0bf84979">SMALL</a>  ) {</div>
<div class="line"><a name="l09267"></a><span class="lineno"> 9267</span>&#160;            badcond++;</div>
<div class="line"><a name="l09268"></a><span class="lineno"> 9268</span>&#160;          }</div>
<div class="line"><a name="l09269"></a><span class="lineno"> 9269</span>&#160;        }</div>
<div class="line"><a name="l09270"></a><span class="lineno"> 9270</span>&#160;        <span class="keywordflow">if</span>(badcond){</div>
<div class="line"><a name="l09271"></a><span class="lineno"> 9271</span>&#160;          <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a33e29fbc91c598484cbeb76769ce1fd2">JACLOOP</a>(ii,ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#a9f3d856dcdd8fa240dfbdcedfad888ef">startjac</a>,ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#af67164c1a42e2aefe0603597dd2ea25e">endjac</a>){</div>
<div class="line"><a name="l09272"></a><span class="lineno"> 9272</span>&#160;            dualfprintf(fail_file,<span class="stringliteral">&quot;JISNAN: iter=%d startjac=%d endjac=%d ii=%d jj=%d irefU[jj]=%d erefU[ii]=%d : xjac[0]: %21.15g :  xjac[1]: %21.15g : x=%21.15g (del=%21.15g localIMPEPS=%21.15g) : f2[0]=%21.15g f2[1]=%21.15g J=%21.15g : f2norm[0]=%21.15g f2norm[1]=%21.15g\n&quot;</span>,</div>
<div class="line"><a name="l09273"></a><span class="lineno"> 9273</span>&#160;                        iter,ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#a9f3d856dcdd8fa240dfbdcedfad888ef">startjac</a>,ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#af67164c1a42e2aefe0603597dd2ea25e">endjac</a>,</div>
<div class="line"><a name="l09274"></a><span class="lineno"> 9274</span>&#160;                        ii,jj,ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj],ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[ii],</div>
<div class="line"><a name="l09275"></a><span class="lineno"> 9275</span>&#160;                        xjac[0][ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]],</div>
<div class="line"><a name="l09276"></a><span class="lineno"> 9276</span>&#160;                        xjac[1][ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]],</div>
<div class="line"><a name="l09277"></a><span class="lineno"> 9277</span>&#160;                        x[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]],</div>
<div class="line"><a name="l09278"></a><span class="lineno"> 9278</span>&#160;                        del,localIMPEPS,</div>
<div class="line"><a name="l09279"></a><span class="lineno"> 9279</span>&#160;                        f2[0][ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[ii]],f2[1][ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[ii]],J[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[ii]][ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]],</div>
<div class="line"><a name="l09280"></a><span class="lineno"> 9280</span>&#160;                        f2norm[0][ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[ii]],f2norm[1][ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[ii]]</div>
<div class="line"><a name="l09281"></a><span class="lineno"> 9281</span>&#160;                        );</div>
<div class="line"><a name="l09282"></a><span class="lineno"> 9282</span>&#160;          }</div>
<div class="line"><a name="l09283"></a><span class="lineno"> 9283</span>&#160;          <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a33e29fbc91c598484cbeb76769ce1fd2">JACLOOP</a>(ii,ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#a9f3d856dcdd8fa240dfbdcedfad888ef">startjac</a>,ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#af67164c1a42e2aefe0603597dd2ea25e">endjac</a>){</div>
<div class="line"><a name="l09284"></a><span class="lineno"> 9284</span>&#160;            dualfprintf(fail_file,<span class="stringliteral">&quot;NEW: ii=%d jj=%d J=%21.15g : %21.15g %21.15g : %21.15g %21.15g\n&quot;</span>,ii,jj,J[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[ii]][ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]], f2[1][ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[ii]],f2[0][ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[ii]],xjac[1][ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]],xjac[0][ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]]);</div>
<div class="line"><a name="l09285"></a><span class="lineno"> 9285</span>&#160;          }</div>
<div class="line"><a name="l09286"></a><span class="lineno"> 9286</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) dualfprintf(fail_file,<span class="stringliteral">&quot;JISNAN2: pl=%d ppjac=%21.15g uu0=%21.15g uujac=%21.15g\n&quot;</span>,pl,ppjac[pl],uu0[pl],uujac[pl]);</div>
<div class="line"><a name="l09287"></a><span class="lineno"> 9287</span>&#160;          <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a33e29fbc91c598484cbeb76769ce1fd2">JACLOOP</a>(ii,ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#a9f3d856dcdd8fa240dfbdcedfad888ef">startjac</a>,ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#af67164c1a42e2aefe0603597dd2ea25e">endjac</a>) dualfprintf(fail_file,<span class="stringliteral">&quot;ii=%d uucopy=%21.15g uu=%21.15g\n&quot;</span>,ii,uucopy[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[ii]],uu[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[ii]]);</div>
<div class="line"><a name="l09288"></a><span class="lineno"> 9288</span>&#160;        }<span class="comment">//end if badcond&gt;0</span></div>
<div class="line"><a name="l09289"></a><span class="lineno"> 9289</span>&#160;      }<span class="comment">//end debug</span></div>
<div class="line"><a name="l09290"></a><span class="lineno"> 9290</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l09291"></a><span class="lineno"> 9291</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l09292"></a><span class="lineno"> 9292</span>&#160;    }<span class="comment">// end JACLOOP</span></div>
<div class="line"><a name="l09293"></a><span class="lineno"> 9293</span>&#160;    </div>
<div class="line"><a name="l09294"></a><span class="lineno"> 9294</span>&#160;</div>
<div class="line"><a name="l09295"></a><span class="lineno"> 9295</span>&#160;</div>
<div class="line"><a name="l09296"></a><span class="lineno"> 9296</span>&#160;</div>
<div class="line"><a name="l09297"></a><span class="lineno"> 9297</span>&#160;<span class="preprocessor">#if(PRODUCTION==0)</span></div>
<div class="line"><a name="l09298"></a><span class="lineno"> 9298</span>&#160;<span class="preprocessor"></span>    <span class="keywordflow">if</span>(showmessagesheavy){</div>
<div class="line"><a name="l09299"></a><span class="lineno"> 9299</span>&#160;      dualfprintf(fail_file,<span class="stringliteral">&quot;POSTJAC: x: %21.15g %21.15g %21.15g %21.15g : x=%21.15g %21.15g %21.15g %21.15g\n&quot;</span>,x[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[0]],x[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[1]],x[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[2]],x[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[3]],x[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[0]],x[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[1]],x[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[2]],x[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[3]]);</div>
<div class="line"><a name="l09300"></a><span class="lineno"> 9300</span>&#160;      <span class="keywordtype">int</span> iii,jjj;</div>
<div class="line"><a name="l09301"></a><span class="lineno"> 9301</span>&#160;      <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a06f52b18202ad535ff7c470055f5cb02">JACLOOP2D</a>(iii,jjj,ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#a9f3d856dcdd8fa240dfbdcedfad888ef">startjac</a>,ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#af67164c1a42e2aefe0603597dd2ea25e">endjac</a>) dualfprintf(fail_file,<span class="stringliteral">&quot;J[%d][%d]=%21.15g\n&quot;</span>,iii,jjj,J[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[iii]][ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jjj]]);</div>
<div class="line"><a name="l09302"></a><span class="lineno"> 9302</span>&#160;    }</div>
<div class="line"><a name="l09303"></a><span class="lineno"> 9303</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l09304"></a><span class="lineno"> 9304</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l09305"></a><span class="lineno"> 9305</span>&#160;</div>
<div class="line"><a name="l09306"></a><span class="lineno"> 9306</span>&#160;</div>
<div class="line"><a name="l09307"></a><span class="lineno"> 9307</span>&#160;</div>
<div class="line"><a name="l09309"></a><span class="lineno"> 9309</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l09310"></a><span class="lineno"> 9310</span>&#160;    <span class="comment">//invert Jacobian</span></div>
<div class="line"><a name="l09311"></a><span class="lineno"> 9311</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l09313"></a><span class="lineno"> 9313</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l09314"></a><span class="lineno"> 9314</span>&#160;</div>
<div class="line"><a name="l09315"></a><span class="lineno"> 9315</span>&#160;    <span class="comment">// copy over matrix to sub (up to) 4x4 version</span></div>
<div class="line"><a name="l09316"></a><span class="lineno"> 9316</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Jsub[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>][<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l09317"></a><span class="lineno"> 9317</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> iJsub[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>][<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l09318"></a><span class="lineno"> 9318</span>&#160;    <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a06f52b18202ad535ff7c470055f5cb02">JACLOOP2D</a>(ii,jj,ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#a9f3d856dcdd8fa240dfbdcedfad888ef">startjac</a>,ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#af67164c1a42e2aefe0603597dd2ea25e">endjac</a>) Jsub[ii][jj]=J[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[ii]][ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[jj]];</div>
<div class="line"><a name="l09319"></a><span class="lineno"> 9319</span>&#160;</div>
<div class="line"><a name="l09320"></a><span class="lineno"> 9320</span>&#160;    <span class="keywordflow">if</span>(ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#af67164c1a42e2aefe0603597dd2ea25e">endjac</a>-ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#a9f3d856dcdd8fa240dfbdcedfad888ef">startjac</a>+1==NDIM){</div>
<div class="line"><a name="l09321"></a><span class="lineno"> 9321</span>&#160;      <span class="comment">// inverse *and* transpose index order, so J[erefU][irefU] -&gt;  iJ[irefU][erefU]</span></div>
<div class="line"><a name="l09322"></a><span class="lineno"> 9322</span>&#160;      failreturn=inverse_44matrix(Jsub,iJsub);</div>
<div class="line"><a name="l09323"></a><span class="lineno"> 9323</span>&#160;    }    </div>
<div class="line"><a name="l09324"></a><span class="lineno"> 9324</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#af67164c1a42e2aefe0603597dd2ea25e">endjac</a>-ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#a9f3d856dcdd8fa240dfbdcedfad888ef">startjac</a>+1==NDIM-1){ <span class="comment">// probably momentum only</span></div>
<div class="line"><a name="l09325"></a><span class="lineno"> 9325</span>&#160;      <span class="comment">// inverse *and* transpose index order, so J[erefU][irefU] -&gt;  iJ[irefU][erefU]</span></div>
<div class="line"><a name="l09326"></a><span class="lineno"> 9326</span>&#160;      failreturn=inverse_33matrix(ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#a9f3d856dcdd8fa240dfbdcedfad888ef">startjac</a>,ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#af67164c1a42e2aefe0603597dd2ea25e">endjac</a>,Jsub,iJsub);</div>
<div class="line"><a name="l09327"></a><span class="lineno"> 9327</span>&#160;    }    </div>
<div class="line"><a name="l09328"></a><span class="lineno"> 9328</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#af67164c1a42e2aefe0603597dd2ea25e">endjac</a>-ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#a9f3d856dcdd8fa240dfbdcedfad888ef">startjac</a>+1==1){ <span class="comment">// probably energy only</span></div>
<div class="line"><a name="l09329"></a><span class="lineno"> 9329</span>&#160;      <span class="comment">// inverse *and* transpose index order, so J[erefU][irefU] -&gt;  iJ[irefU][erefU]</span></div>
<div class="line"><a name="l09330"></a><span class="lineno"> 9330</span>&#160;      failreturn=inverse_11matrix(ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#a9f3d856dcdd8fa240dfbdcedfad888ef">startjac</a>,ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#af67164c1a42e2aefe0603597dd2ea25e">endjac</a>,Jsub,iJsub);</div>
<div class="line"><a name="l09331"></a><span class="lineno"> 9331</span>&#160;    }    </div>
<div class="line"><a name="l09332"></a><span class="lineno"> 9332</span>&#160;    </div>
<div class="line"><a name="l09333"></a><span class="lineno"> 9333</span>&#160;    <span class="comment">// copy back inverse matrix from sub-version</span></div>
<div class="line"><a name="l09334"></a><span class="lineno"> 9334</span>&#160;    <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a06f52b18202ad535ff7c470055f5cb02">JACLOOP2D</a>(ii,jj,ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#a9f3d856dcdd8fa240dfbdcedfad888ef">startjac</a>,ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#af67164c1a42e2aefe0603597dd2ea25e">endjac</a>){</div>
<div class="line"><a name="l09335"></a><span class="lineno"> 9335</span>&#160;      iJ[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[ii]][ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aedc2b979e9dfc65c78e0312b50993267">erefU</a>[jj]]=iJsub[ii][jj]; <span class="comment">// iJsub has been transposed from input Jsub, so iJsub[irefU][erefU]</span></div>
<div class="line"><a name="l09336"></a><span class="lineno"> 9336</span>&#160;      <span class="comment">// dualfprintf(fail_file,&quot;NEW: ii=%d jj=%d iJ=%g\n&quot;,ii,jj,iJ[ru-&gt;irefU[ii]][ru-&gt;erefU[jj]]);</span></div>
<div class="line"><a name="l09337"></a><span class="lineno"> 9337</span>&#160;    }</div>
<div class="line"><a name="l09338"></a><span class="lineno"> 9338</span>&#160;</div>
<div class="line"><a name="l09339"></a><span class="lineno"> 9339</span>&#160;</div>
<div class="line"><a name="l09340"></a><span class="lineno"> 9340</span>&#160;    <span class="keywordflow">if</span>(failreturn){</div>
<div class="line"><a name="l09341"></a><span class="lineno"> 9341</span>&#160;</div>
<div class="line"><a name="l09342"></a><span class="lineno"> 9342</span>&#160;      </div>
<div class="line"><a name="l09343"></a><span class="lineno"> 9343</span>&#160;<span class="preprocessor">#if(PRODUCTION==0)</span></div>
<div class="line"><a name="l09344"></a><span class="lineno"> 9344</span>&#160;<span class="preprocessor"></span>      <span class="comment">// debug:</span></div>
<div class="line"><a name="l09345"></a><span class="lineno"> 9345</span>&#160;      <span class="keywordflow">if</span>(debugfail&gt;=2){</div>
<div class="line"><a name="l09346"></a><span class="lineno"> 9346</span>&#160;        dualfprintf(fail_file,<span class="stringliteral">&quot;Tried to invert Jacobian with %d %d %d %d : %g %g %g : %g %g %g : %d %d : %g %g : %d : %g %g\n&quot;</span>,*eomtypelocal, whichcap, itermode, *baseitermethod, fracenergy, dissmeasure, impepsjac, trueimptryconv, trueimptryconvabs, trueimpallowconvabs, trueimpmaxiter, iter, errorabs, errorallabs, whicherror,fracdtG,realdt);</div>
<div class="line"><a name="l09347"></a><span class="lineno"> 9347</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) dualfprintf(fail_file,<span class="stringliteral">&quot;1Tried: pl=%d Uiin=%g uu=%g uup=%g uu0=%g piin=%g pp=%g ppp=%g f1=%g f1norm=%g\n&quot;</span>, pl, Uiin[pl], uu[pl], uup[pl], uu0[pl], piin[pl], pp[pl], ppp[pl], f1[pl], f1norm[pl]);</div>
<div class="line"><a name="l09348"></a><span class="lineno"> 9348</span>&#160;        <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a06f52b18202ad535ff7c470055f5cb02">JACLOOP2D</a>(ii,jj,ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#a9f3d856dcdd8fa240dfbdcedfad888ef">startjac</a>,ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#af67164c1a42e2aefe0603597dd2ea25e">endjac</a>){</div>
<div class="line"><a name="l09349"></a><span class="lineno"> 9349</span>&#160;          dualfprintf(fail_file,<span class="stringliteral">&quot;2Tried: ii=%d jj=%d (%d %d) : j=%g iJ=%g\n&quot;</span>,ii,jj,ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#a9f3d856dcdd8fa240dfbdcedfad888ef">startjac</a>,ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#af67164c1a42e2aefe0603597dd2ea25e">endjac</a>,Jsub[ii][jj],iJsub[ii][jj]);</div>
<div class="line"><a name="l09350"></a><span class="lineno"> 9350</span>&#160;        }</div>
<div class="line"><a name="l09351"></a><span class="lineno"> 9351</span>&#160;      }</div>
<div class="line"><a name="l09352"></a><span class="lineno"> 9352</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l09353"></a><span class="lineno"> 9353</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l09354"></a><span class="lineno"> 9354</span>&#160;      <span class="comment">// act on failure?</span></div>
<div class="line"><a name="l09355"></a><span class="lineno"> 9355</span>&#160;</div>
<div class="line"><a name="l09356"></a><span class="lineno"> 9356</span>&#160;    }<span class="comment">// end if failreturn!=0</span></div>
<div class="line"><a name="l09357"></a><span class="lineno"> 9357</span>&#160;</div>
<div class="line"><a name="l09358"></a><span class="lineno"> 9358</span>&#160;</div>
<div class="line"><a name="l09359"></a><span class="lineno"> 9359</span>&#160;</div>
<div class="line"><a name="l09361"></a><span class="lineno"> 9361</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l09362"></a><span class="lineno"> 9362</span>&#160;    <span class="comment">// check if Jacobian inversion was successful</span></div>
<div class="line"><a name="l09363"></a><span class="lineno"> 9363</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l09365"></a><span class="lineno"> 9365</span>&#160;<span class="comment"></span>    <span class="keywordflow">if</span>(failreturn){</div>
<div class="line"><a name="l09366"></a><span class="lineno"> 9366</span>&#160;      <span class="comment">// try increasing localIMPEPS</span></div>
<div class="line"><a name="l09367"></a><span class="lineno"> 9367</span>&#160;      IMPEPSSTART/=FRACIMPEPSCHANGE;</div>
<div class="line"><a name="l09368"></a><span class="lineno"> 9368</span>&#160;      <span class="keywordtype">int</span> condnotdiff;</div>
<div class="line"><a name="l09369"></a><span class="lineno"> 9369</span>&#160;      condnotdiff=IMPEPSSTART &gt; <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#acc67470ff1c715385df90c64aaaa52ec" title="maximum EPS for getting Jacobian">MAXIMPEPS</a>;</div>
<div class="line"><a name="l09370"></a><span class="lineno"> 9370</span>&#160;</div>
<div class="line"><a name="l09371"></a><span class="lineno"> 9371</span>&#160;      <span class="keywordflow">if</span>(condnotdiff){ <span class="comment">// KORALTODO: But error relative to x needs to be accounted for!</span></div>
<div class="line"><a name="l09372"></a><span class="lineno"> 9372</span>&#160;</div>
<div class="line"><a name="l09373"></a><span class="lineno"> 9373</span>&#160;<span class="preprocessor">#if(PRODUCTION==0)</span></div>
<div class="line"><a name="l09374"></a><span class="lineno"> 9374</span>&#160;<span class="preprocessor"></span>        <span class="keywordflow">if</span>(debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;f_implicit for f2 failed to be different enough from f1 and gave singular Jacobian: IMPEPSSTART=%g (giving del=%g)\n&quot;</span>,IMPEPSSTART,del);</div>
<div class="line"><a name="l09375"></a><span class="lineno"> 9375</span>&#160;        <span class="keywordflow">if</span>(debugfail&gt;=2 || showmessagesheavy){</div>
<div class="line"><a name="l09376"></a><span class="lineno"> 9376</span>&#160;          dualfprintf(fail_file,<span class="stringliteral">&quot;POSTJAC1: x: %21.15g %21.15g %21.15g %21.15g : x=%21.15g %21.15g %21.15g %21.15g\n&quot;</span>,x[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[0]],x[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[1]],x[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[2]],x[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[3]],x[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[0]],x[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[1]],x[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[2]],x[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[3]]);</div>
<div class="line"><a name="l09377"></a><span class="lineno"> 9377</span>&#160;          <span class="keywordtype">int</span> iii,jjj;</div>
<div class="line"><a name="l09378"></a><span class="lineno"> 9378</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a59b7ef1517ff22fd4dfce4cf6d380c55" title="loop over all Dimensions; second rank loop">DLOOP</a>(iii,jjj) dualfprintf(fail_file,<span class="stringliteral">&quot;Jsub[%d][%d]=%21.15g\n&quot;</span>,iii,jjj,Jsub[iii][jjj]);</div>
<div class="line"><a name="l09379"></a><span class="lineno"> 9379</span>&#160;        }</div>
<div class="line"><a name="l09380"></a><span class="lineno"> 9380</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l09381"></a><span class="lineno"> 9381</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l09382"></a><span class="lineno"> 9382</span>&#160;        <span class="keywordflow">return</span>(1); <span class="comment">// can&#39;t expect good derivative above ~0.3, so just return as failure of implicit method.</span></div>
<div class="line"><a name="l09383"></a><span class="lineno"> 9383</span>&#160;      }</div>
<div class="line"><a name="l09384"></a><span class="lineno"> 9384</span>&#160;      <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l09385"></a><span class="lineno"> 9385</span>&#160;</div>
<div class="line"><a name="l09386"></a><span class="lineno"> 9386</span>&#160;<span class="preprocessor">#if(PRODUCTION==0)</span></div>
<div class="line"><a name="l09387"></a><span class="lineno"> 9387</span>&#160;<span class="preprocessor"></span>        <span class="keywordflow">if</span>(debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;inverse_44matrix(J,iJ) failed with eomtypelocallocal=%d, trying IMPEPSSTART=%g :: ijk=%d %d %d\n&quot;</span>,eomtypelocallocal,IMPEPSSTART,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k);</div>
<div class="line"><a name="l09388"></a><span class="lineno"> 9388</span>&#160;        <span class="keywordflow">if</span>(debugfail&gt;=2 || showmessagesheavy){</div>
<div class="line"><a name="l09389"></a><span class="lineno"> 9389</span>&#160;          dualfprintf(fail_file,<span class="stringliteral">&quot;POSTJAC2: x: %21.15g %21.15g %21.15g %21.15g : x=%21.15g %21.15g %21.15g %21.15g\n&quot;</span>,x[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[0]],x[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[1]],x[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[2]],x[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[3]],x[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[0]],x[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[1]],x[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[2]],x[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[3]]);</div>
<div class="line"><a name="l09390"></a><span class="lineno"> 9390</span>&#160;          <span class="keywordtype">int</span> iii,jjj;</div>
<div class="line"><a name="l09391"></a><span class="lineno"> 9391</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(iii) dualfprintf(fail_file,<span class="stringliteral">&quot;predel[%d]=%21.15g\n&quot;</span>,iii,predel[iii]);</div>
<div class="line"><a name="l09392"></a><span class="lineno"> 9392</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a59b7ef1517ff22fd4dfce4cf6d380c55" title="loop over all Dimensions; second rank loop">DLOOP</a>(iii,jjj) dualfprintf(fail_file,<span class="stringliteral">&quot;Jsub[%d][%d]=%21.15g\n&quot;</span>,iii,jjj,Jsub[iii][jjj]);</div>
<div class="line"><a name="l09393"></a><span class="lineno"> 9393</span>&#160;        }</div>
<div class="line"><a name="l09394"></a><span class="lineno"> 9394</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l09395"></a><span class="lineno"> 9395</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l09396"></a><span class="lineno"> 9396</span>&#160;      }</div>
<div class="line"><a name="l09397"></a><span class="lineno"> 9397</span>&#160;    }<span class="comment">// end if failred to invert J</span></div>
<div class="line"><a name="l09398"></a><span class="lineno"> 9398</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">break</span>; <span class="comment">// good Jacobian</span></div>
<div class="line"><a name="l09399"></a><span class="lineno"> 9399</span>&#160;</div>
<div class="line"><a name="l09400"></a><span class="lineno"> 9400</span>&#160;    <span class="comment">// check if trying too many times to get Jacobian</span></div>
<div class="line"><a name="l09401"></a><span class="lineno"> 9401</span>&#160;    fulljaciter++;</div>
<div class="line"><a name="l09402"></a><span class="lineno"> 9402</span>&#160;    <span class="keywordflow">if</span>(fulljaciter&gt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad08222721945a85c235d11ea56f6cc20" title="maximum number of times to (typically) increase EPS in getting Jacobian for implicit scheme...">MAXJACITER</a>){</div>
<div class="line"><a name="l09403"></a><span class="lineno"> 9403</span>&#160;      <span class="comment">// this is a catch in case bouncing back and forth between singular Jac and no inversion for P(U) to get f2</span></div>
<div class="line"><a name="l09404"></a><span class="lineno"> 9404</span>&#160;</div>
<div class="line"><a name="l09405"></a><span class="lineno"> 9405</span>&#160;<span class="preprocessor">#if(PRODUCTION==0)</span></div>
<div class="line"><a name="l09406"></a><span class="lineno"> 9406</span>&#160;<span class="preprocessor"></span>      <span class="keywordflow">if</span>(debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;Failed to get inverse Jacobian with fulljaciter=%d with IMPEPSSTART=%g (giving del=%g)\n&quot;</span>,fulljaciter,IMPEPSSTART,del);</div>
<div class="line"><a name="l09407"></a><span class="lineno"> 9407</span>&#160;      <span class="keywordflow">if</span>(debugfail&gt;=2 || showmessagesheavy){</div>
<div class="line"><a name="l09408"></a><span class="lineno"> 9408</span>&#160;        dualfprintf(fail_file,<span class="stringliteral">&quot;POSTJAC3: x: %g %g %g %g : x=%g %g %g %g\n&quot;</span>,x[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[0]],x[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[1]],x[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[2]],x[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[3]],x[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[0]],x[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[1]],x[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[2]],x[ru-&gt;<a class="code" href="../../d2/d46/structof__ref_u.html#aa243c09c40d290b443f4512d83149e73">irefU</a>[3]]);</div>
<div class="line"><a name="l09409"></a><span class="lineno"> 9409</span>&#160;        <span class="keywordtype">int</span> iii,jjj;</div>
<div class="line"><a name="l09410"></a><span class="lineno"> 9410</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a59b7ef1517ff22fd4dfce4cf6d380c55" title="loop over all Dimensions; second rank loop">DLOOP</a>(iii,jjj) dualfprintf(fail_file,<span class="stringliteral">&quot;Jsub[%d][%d]=%g\n&quot;</span>,iii,jjj,Jsub[iii][jjj]);</div>
<div class="line"><a name="l09411"></a><span class="lineno"> 9411</span>&#160;      }</div>
<div class="line"><a name="l09412"></a><span class="lineno"> 9412</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l09413"></a><span class="lineno"> 9413</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l09414"></a><span class="lineno"> 9414</span>&#160;      <span class="keywordflow">return</span>(1);</div>
<div class="line"><a name="l09415"></a><span class="lineno"> 9415</span>&#160;    }</div>
<div class="line"><a name="l09416"></a><span class="lineno"> 9416</span>&#160;  }<span class="comment">// end over ensuring Jacobian is non-singular for the given del</span></div>
<div class="line"><a name="l09417"></a><span class="lineno"> 9417</span>&#160;</div>
<div class="line"><a name="l09418"></a><span class="lineno"> 9418</span>&#160;</div>
<div class="line"><a name="l09419"></a><span class="lineno"> 9419</span>&#160;</div>
<div class="line"><a name="l09420"></a><span class="lineno"> 9420</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l09421"></a><span class="lineno"> 9421</span>&#160;</div>
<div class="line"><a name="l09422"></a><span class="lineno"> 9422</span>&#160;}</div>
<div class="line"><a name="l09423"></a><span class="lineno"> 9423</span>&#160;</div>
<div class="line"><a name="l09424"></a><span class="lineno"> 9424</span>&#160;</div>
<div class="line"><a name="l09425"></a><span class="lineno"> 9425</span>&#160;</div>
<div class="line"><a name="l09426"></a><span class="lineno"> 9426</span>&#160;</div>
<div class="line"><a name="l09427"></a><span class="lineno"> 9427</span>&#160;</div>
<div class="line"><a name="l09428"></a><span class="lineno"> 9428</span>&#160;</div>
<div class="line"><a name="l09429"></a><span class="lineno"> 9429</span>&#160;</div>
<div class="line"><a name="l09430"></a><span class="lineno"> 9430</span>&#160;</div>
<div class="line"><a name="l09431"></a><span class="lineno"> 9431</span>&#160;</div>
<div class="line"><a name="l09432"></a><span class="lineno"> 9432</span>&#160;</div>
<div class="line"><a name="l09433"></a><span class="lineno"> 9433</span>&#160;</div>
<div class="line"><a name="l09434"></a><span class="lineno"> 9434</span>&#160;</div>
<div class="line"><a name="l09435"></a><span class="lineno"> 9435</span>&#160;</div>
<div class="line"><a name="l09436"></a><span class="lineno"> 9436</span>&#160;</div>
<div class="line"><a name="l09437"></a><span class="lineno"> 9437</span>&#160;</div>
<div class="line"><a name="l09438"></a><span class="lineno"> 9438</span>&#160;</div>
<div class="line"><a name="l09439"></a><span class="lineno"> 9439</span>&#160;</div>
<div class="line"><a name="l09440"></a><span class="lineno"> 9440</span>&#160;</div>
<div class="line"><a name="l09441"></a><span class="lineno"> 9441</span>&#160;</div>
<div class="line"><a name="l09442"></a><span class="lineno"> 9442</span>&#160;</div>
<div class="line"><a name="l09443"></a><span class="lineno"> 9443</span>&#160;</div>
<div class="line"><a name="l09445"></a><span class="lineno"> 9445</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> get_dtsub(<span class="keywordtype">int</span> method, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *q, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ui, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Uf, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *dUother,  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUf, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUimp, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Gdpl, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> chi, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Gdplabs, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *dtsub)</div>
<div class="line"><a name="l09446"></a><span class="lineno"> 9446</span>&#160;{</div>
<div class="line"><a name="l09447"></a><span class="lineno"> 9447</span>&#160;  <span class="keywordtype">int</span> jj;</div>
<div class="line"><a name="l09448"></a><span class="lineno"> 9448</span>&#160;  <span class="keywordtype">int</span> pliter,pl;</div>
<div class="line"><a name="l09449"></a><span class="lineno"> 9449</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> idtsub0,idtsub;</div>
<div class="line"><a name="l09450"></a><span class="lineno"> 9450</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l09451"></a><span class="lineno"> 9451</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Umhd,Urad,Gmhd,Grad,iUmhd,iUrad;</div>
<div class="line"><a name="l09452"></a><span class="lineno"> 9452</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l09453"></a><span class="lineno"> 9453</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> idtsubs,idtsubt;</div>
<div class="line"><a name="l09454"></a><span class="lineno"> 9454</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> idtsubmhd,idtsubrad;</div>
<div class="line"><a name="l09455"></a><span class="lineno"> 9455</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Usmhd,Usrad,Gsmhd,Gsrad,iUsmhd,iUsrad;</div>
<div class="line"><a name="l09456"></a><span class="lineno"> 9456</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Utmhd,Utrad,Gtmhd,Gtrad,iUtmhd,iUtrad;</div>
<div class="line"><a name="l09457"></a><span class="lineno"> 9457</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Gddtpl[NPR];</div>
<div class="line"><a name="l09458"></a><span class="lineno"> 9458</span>&#160;</div>
<div class="line"><a name="l09459"></a><span class="lineno"> 9459</span>&#160;</div>
<div class="line"><a name="l09460"></a><span class="lineno"> 9460</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#af48e1348f10b3468e425c084365f5e64" title="which velocity to compute in (init can be anything (see init.c&#39;s for transformations)">REMOVERESTMASSFROMUU</a>!=2){</div>
<div class="line"><a name="l09461"></a><span class="lineno"> 9461</span>&#160;    dualfprintf(fail_file,<span class="stringliteral">&quot;get_dtsub() assumes removed rest mass from UU so can compare G and U[UU]\n&quot;</span>);</div>
<div class="line"><a name="l09462"></a><span class="lineno"> 9462</span>&#160;    myexit(9285345);</div>
<div class="line"><a name="l09463"></a><span class="lineno"> 9463</span>&#160;  }</div>
<div class="line"><a name="l09464"></a><span class="lineno"> 9464</span>&#160;</div>
<div class="line"><a name="l09465"></a><span class="lineno"> 9465</span>&#160;  <span class="comment">// KORALTODO: If Umhd is very small and dynamically unimportant, should probably ignore trying to subcycle, but at least limit number of sub-cycles.  May be more of a problem when deal with MHD in force-free magnetosphere.</span></div>
<div class="line"><a name="l09466"></a><span class="lineno"> 9466</span>&#160;</div>
<div class="line"><a name="l09467"></a><span class="lineno"> 9467</span>&#160;  <span class="comment">// NOTE: The timestep does not fllow NR1992 S19.2L on diffusion equation step size.  That applies if diffusion was part of flux calculation, not source term.  And it applies to the radiative velocity limiter for the advection&#39;s effective wave speed.</span></div>
<div class="line"><a name="l09468"></a><span class="lineno"> 9468</span>&#160;  <span class="comment">// The relevant NR1992 is S16.6L on stiff source terms.</span></div>
<div class="line"><a name="l09469"></a><span class="lineno"> 9469</span>&#160;</div>
<div class="line"><a name="l09470"></a><span class="lineno"> 9470</span>&#160;  <span class="comment">// get G*dt that can be compared to Umhd or Urad</span></div>
<div class="line"><a name="l09471"></a><span class="lineno"> 9471</span>&#160;  <span class="keywordtype">int</span> isexplicit=1;</div>
<div class="line"><a name="l09472"></a><span class="lineno"> 9472</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> realdt=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5dcc789108ddf06ec44fb22770f18e90" title="compute dt for this sub-step">compute_dt</a>(isexplicit,CUf, CUimp,dt);</div>
<div class="line"><a name="l09473"></a><span class="lineno"> 9473</span>&#160;</div>
<div class="line"><a name="l09474"></a><span class="lineno"> 9474</span>&#160;  <span class="comment">// choose if using actual 4-force or absolutified 4-force</span></div>
<div class="line"><a name="l09475"></a><span class="lineno"> 9475</span>&#160;  <span class="keywordflow">if</span>(0){</div>
<div class="line"><a name="l09476"></a><span class="lineno"> 9476</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) Gddtpl[pl] = Gdpl[pl]*realdt;</div>
<div class="line"><a name="l09477"></a><span class="lineno"> 9477</span>&#160;  }</div>
<div class="line"><a name="l09478"></a><span class="lineno"> 9478</span>&#160;  else{</div>
<div class="line"><a name="l09479"></a><span class="lineno"> 9479</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) Gddtpl[pl] = Gdplabs[pl]*realdt;</div>
<div class="line"><a name="l09480"></a><span class="lineno"> 9480</span>&#160;  }</div>
<div class="line"><a name="l09481"></a><span class="lineno"> 9481</span>&#160;</div>
<div class="line"><a name="l09482"></a><span class="lineno"> 9482</span>&#160;</div>
<div class="line"><a name="l09484"></a><span class="lineno"> 9484</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l09485"></a><span class="lineno"> 9485</span>&#160;  <span class="comment">// get updated uu from dUother in case leads to different result</span></div>
<div class="line"><a name="l09486"></a><span class="lineno"> 9486</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> U0[NPR];</div>
<div class="line"><a name="l09487"></a><span class="lineno"> 9487</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dUnongeomall[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0a72db4856620ff1b9551c885f1b32b5">MAXTIMEORDER</a>]={0.0};</div>
<div class="line"><a name="l09488"></a><span class="lineno"> 9488</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) U0[pl]=UFSET(CUf,dt,Ui[pl],Uf[pl],dUother[pl],0.0,dUnongeomall);</div>
<div class="line"><a name="l09489"></a><span class="lineno"> 9489</span>&#160;</div>
<div class="line"><a name="l09490"></a><span class="lineno"> 9490</span>&#160;  <span class="comment">//  PLOOP(pliter,pl) dualfprintf(fail_file,&quot;pl=%d U0=%g realdt=%g dt=%g Ui=%g Uf=%g dUother=%g\n&quot;,pl,U0[pl],realdt,dt,Ui[pl],Uf[pl],dUother[pl]);</span></div>
<div class="line"><a name="l09491"></a><span class="lineno"> 9491</span>&#160;</div>
<div class="line"><a name="l09492"></a><span class="lineno"> 9492</span>&#160;</div>
<div class="line"><a name="l09493"></a><span class="lineno"> 9493</span>&#160;</div>
<div class="line"><a name="l09494"></a><span class="lineno"> 9494</span>&#160;  <span class="comment">// get original U</span></div>
<div class="line"><a name="l09495"></a><span class="lineno"> 9495</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> U[NPR];</div>
<div class="line"><a name="l09496"></a><span class="lineno"> 9496</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) U[pl]=Ui[pl];</div>
<div class="line"><a name="l09497"></a><span class="lineno"> 9497</span>&#160;</div>
<div class="line"><a name="l09498"></a><span class="lineno"> 9498</span>&#160;</div>
<div class="line"><a name="l09499"></a><span class="lineno"> 9499</span>&#160;</div>
<div class="line"><a name="l09500"></a><span class="lineno"> 9500</span>&#160;</div>
<div class="line"><a name="l09501"></a><span class="lineno"> 9501</span>&#160;  <span class="comment">// get smallest timestep for stiff source terms of 8 equations with a single source term vector.</span></div>
<div class="line"><a name="l09502"></a><span class="lineno"> 9502</span>&#160;  <span class="comment">// Based upon NR 16.6.6L with removal of factor of two</span></div>
<div class="line"><a name="l09503"></a><span class="lineno"> 9503</span>&#160;  if(method==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a96e9f8c7659cf4e2775a3e65536611fb" title="0 : tau suppression 1 : space-time merged 2 : all space merged but separate from time 3 : full split ...">TAUSUPPRESS</a>){</div>
<div class="line"><a name="l09504"></a><span class="lineno"> 9504</span>&#160;    <span class="comment">// KORALTODO: \tau suppression not general enough because G\propto R\tau + \gamma R \tau + \gamma B, and further, this assumes T\sim R.  If T&lt;&lt;R, then suppression by \tau won&#39;t be enough to treat stiffness effect on fluid&#39;s T.</span></div>
<div class="line"><a name="l09505"></a><span class="lineno"> 9505</span>&#160;    <span class="comment">// dR^t_t/R^t_t \sim c \gamma_{fluid} \chi dt = \sim c \gamma_{fluid} \tau dt/dx , but might as well just use first version</span></div>
<div class="line"><a name="l09506"></a><span class="lineno"> 9506</span>&#160;    </div>
<div class="line"><a name="l09507"></a><span class="lineno"> 9507</span>&#160;</div>
<div class="line"><a name="l09508"></a><span class="lineno"> 9508</span>&#160;    <span class="keywordflow">if</span>(0){</div>
<div class="line"><a name="l09509"></a><span class="lineno"> 9509</span>&#160;      <span class="comment">// Older Olek method</span></div>
<div class="line"><a name="l09510"></a><span class="lineno"> 9510</span>&#160;      <span class="comment">// use approximate dt along each spatial direction.  chi is based in orthonormal basis</span></div>
<div class="line"><a name="l09511"></a><span class="lineno"> 9511</span>&#160;      <span class="comment">// get maximum \tau for all relevant directions</span></div>
<div class="line"><a name="l09512"></a><span class="lineno"> 9512</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dxortho[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>],tautotdir[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l09513"></a><span class="lineno"> 9513</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) dxortho[jj] = (<a class="code" href="../../d8/d5b/defs_8general_8h.html#a99b91d8e229e5df70958f2aed7fd15bf">dx</a>[jj]*sqrt(fabs(ptrgeom-&gt;<a class="code" href="../../dc/dd2/newcodediff_8txt.html#a93300df7bd864b90cc8ed9f3d96515ad">gcov</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(jj,jj)])));</div>
<div class="line"><a name="l09514"></a><span class="lineno"> 9514</span>&#160;      <span class="comment">// KORALTODO: Should this only depend upon kappa and not kappaes?  Stiffness in source term comes from full chi, so seems to be full chi.</span></div>
<div class="line"><a name="l09515"></a><span class="lineno"> 9515</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) tautotdir[jj] = chi * dxortho[jj];</div>
<div class="line"><a name="l09516"></a><span class="lineno"> 9516</span>&#160;      <span class="comment">// only include relevant directions</span></div>
<div class="line"><a name="l09517"></a><span class="lineno"> 9517</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> taumax=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a09c78d2f8feb311dd9fc969a0bf84979">SMALL</a>+<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(tautotdir[1]*<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a51b48b29d7903bb94a3d7879c3ff8eb9">N1NOT1</a>,tautotdir[2]*<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9d8b7e3d088c68f51e7b29b95326a4ac">N2NOT1</a>),tautotdir[3]*<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#aabbd6bada71f73d78d57d14e9adc0c29">N3NOT1</a>);</div>
<div class="line"><a name="l09518"></a><span class="lineno"> 9518</span>&#160;      </div>
<div class="line"><a name="l09519"></a><span class="lineno"> 9519</span>&#160;      idtsub0=taumax/realdt;</div>
<div class="line"><a name="l09520"></a><span class="lineno"> 9520</span>&#160;    }</div>
<div class="line"><a name="l09521"></a><span class="lineno"> 9521</span>&#160;    else{</div>
<div class="line"><a name="l09522"></a><span class="lineno"> 9522</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ratchangeRtt=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ae83fc4364d7c6bc0b717418cd5345297">calc_approx_ratchangeRtt</a>(q, chi, realdt);</div>
<div class="line"><a name="l09523"></a><span class="lineno"> 9523</span>&#160;</div>
<div class="line"><a name="l09524"></a><span class="lineno"> 9524</span>&#160;      idtsub0 = ratchangeRtt/realdt; <span class="comment">// if ratchange=1, then in principle right at edge of big change.</span></div>
<div class="line"><a name="l09525"></a><span class="lineno"> 9525</span>&#160;</div>
<div class="line"><a name="l09526"></a><span class="lineno"> 9526</span>&#160;      <span class="comment">//      dualfprintf(fail_file,&quot;ucon0=%g chi=%g ratchangeRtt=%g idtsub=%g\n&quot;,ucon0,chi,ratchangeRtt,idtsub0);</span></div>
<div class="line"><a name="l09527"></a><span class="lineno"> 9527</span>&#160;</div>
<div class="line"><a name="l09528"></a><span class="lineno"> 9528</span>&#160;</div>
<div class="line"><a name="l09529"></a><span class="lineno"> 9529</span>&#160;    }</div>
<div class="line"><a name="l09530"></a><span class="lineno"> 9530</span>&#160;</div>
<div class="line"><a name="l09531"></a><span class="lineno"> 9531</span>&#160;</div>
<div class="line"><a name="l09532"></a><span class="lineno"> 9532</span>&#160;    <span class="comment">// pre-ratio idtsub</span></div>
<div class="line"><a name="l09533"></a><span class="lineno"> 9533</span>&#160;    idtsub=idtsub0;</div>
<div class="line"><a name="l09534"></a><span class="lineno"> 9534</span>&#160;</div>
<div class="line"><a name="l09535"></a><span class="lineno"> 9535</span>&#160;</div>
<div class="line"><a name="l09536"></a><span class="lineno"> 9536</span>&#160;</div>
<div class="line"><a name="l09537"></a><span class="lineno"> 9537</span>&#160;    <span class="comment">//    dualfprintf(fail_file,&quot;i=%d dtsub0=%g (realdt=%g)\n&quot;,ptrgeom-&gt;i,1/idtsub,realdt);</span></div>
<div class="line"><a name="l09538"></a><span class="lineno"> 9538</span>&#160;</div>
<div class="line"><a name="l09539"></a><span class="lineno"> 9539</span>&#160;    <span class="comment">// account for case where effect on fluid is more than on radiation (where above would only account for effect on radiation)</span></div>
<div class="line"><a name="l09540"></a><span class="lineno"> 9540</span>&#160;</div>
<div class="line"><a name="l09541"></a><span class="lineno"> 9541</span>&#160;    <span class="comment">// first compare to original U</span></div>
<div class="line"><a name="l09542"></a><span class="lineno"> 9542</span>&#160;    jj=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>; Umhd=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a13f615d7832e3abc6abd54325112daf3">UUMINLIMIT</a>+fabs(U[UU+jj]);</div>
<div class="line"><a name="l09543"></a><span class="lineno"> 9543</span>&#160;    jj=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>; Urad=fabs(U[URAD0+jj]);</div>
<div class="line"><a name="l09544"></a><span class="lineno"> 9544</span>&#160;    idtsub=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(idtsub,idtsub0*Urad/Umhd);</div>
<div class="line"><a name="l09545"></a><span class="lineno"> 9545</span>&#160;</div>
<div class="line"><a name="l09546"></a><span class="lineno"> 9546</span>&#160;    <span class="comment">//    dualfprintf(fail_file,&quot;i=%d dtsub1=%g (realdt=%g)\n&quot;,ptrgeom-&gt;i,1/idtsub,realdt);</span></div>
<div class="line"><a name="l09547"></a><span class="lineno"> 9547</span>&#160;       </div>
<div class="line"><a name="l09548"></a><span class="lineno"> 9548</span>&#160;    <span class="comment">// also compare against changed U=U0</span></div>
<div class="line"><a name="l09549"></a><span class="lineno"> 9549</span>&#160;    jj=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>; Umhd=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a13f615d7832e3abc6abd54325112daf3">UUMINLIMIT</a>+fabs(U0[UU+jj]);</div>
<div class="line"><a name="l09550"></a><span class="lineno"> 9550</span>&#160;    jj=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>; Urad=fabs(U0[URAD0+jj]);</div>
<div class="line"><a name="l09551"></a><span class="lineno"> 9551</span>&#160;    idtsub=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(idtsub,idtsub0*Urad/Umhd);</div>
<div class="line"><a name="l09552"></a><span class="lineno"> 9552</span>&#160;</div>
<div class="line"><a name="l09553"></a><span class="lineno"> 9553</span>&#160;    <span class="comment">//    dualfprintf(fail_file,&quot;i=%d dtsub2=%g (realdt=%g)  Urad=%g Umhd=%g\n&quot;,ptrgeom-&gt;i,1/idtsub,realdt,Urad,Umhd);</span></div>
<div class="line"><a name="l09554"></a><span class="lineno"> 9554</span>&#160;       </div>
<div class="line"><a name="l09555"></a><span class="lineno"> 9555</span>&#160;  }</div>
<div class="line"><a name="l09556"></a><span class="lineno"> 9556</span>&#160;  <span class="comment">// below is if Diffusion is part of source term as in Koral</span></div>
<div class="line"><a name="l09557"></a><span class="lineno"> 9557</span>&#160;  <span class="comment">// source term should lead to small (&lt;1/2) change in conserved quantities</span></div>
<div class="line"><a name="l09558"></a><span class="lineno"> 9558</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(method==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a83fe2126d8f6ed5d51c403cc0c76e403">SPACETIMESUBSPLITNONE</a>){</div>
<div class="line"><a name="l09559"></a><span class="lineno"> 9559</span>&#160;    <span class="comment">// merged space-time to avoid negligible total momentum with large update needing to be resolved.</span></div>
<div class="line"><a name="l09560"></a><span class="lineno"> 9560</span>&#160;    Umhd=Urad=Gmhd=Grad=0.0;</div>
<div class="line"><a name="l09561"></a><span class="lineno"> 9561</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) Umhd += fabs(U[UU+jj]*U[UU+jj]*ptrgeom-&gt;<a class="code" href="../../dc/dd2/newcodediff_8txt.html#a98399a5a291e3844900ecfbacdcb2da0">gcon</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(jj,jj)]);</div>
<div class="line"><a name="l09562"></a><span class="lineno"> 9562</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) Urad += fabs(U[URAD0+jj]*U[URAD0+jj]*ptrgeom-&gt;<a class="code" href="../../dc/dd2/newcodediff_8txt.html#a98399a5a291e3844900ecfbacdcb2da0">gcon</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(jj,jj)]);</div>
<div class="line"><a name="l09563"></a><span class="lineno"> 9563</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) Gmhd += fabs(Gddtpl[UU+jj]*Gddtpl[UU+jj]*ptrgeom-&gt;<a class="code" href="../../dc/dd2/newcodediff_8txt.html#a98399a5a291e3844900ecfbacdcb2da0">gcon</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(jj,jj)]);</div>
<div class="line"><a name="l09564"></a><span class="lineno"> 9564</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) Grad += fabs(Gddtpl[URAD0+jj]*Gddtpl[URAD0+jj]*ptrgeom-&gt;<a class="code" href="../../dc/dd2/newcodediff_8txt.html#a98399a5a291e3844900ecfbacdcb2da0">gcon</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(jj,jj)]);</div>
<div class="line"><a name="l09565"></a><span class="lineno"> 9565</span>&#160;    iUmhd=1.0/(fabs(Umhd)+<a class="code" href="../../d8/d5b/defs_8general_8h.html#a13f615d7832e3abc6abd54325112daf3">UUMINLIMIT</a>);</div>
<div class="line"><a name="l09566"></a><span class="lineno"> 9566</span>&#160;    iUrad=1.0/(fabs(Urad)+UUMINLIMIT);</div>
<div class="line"><a name="l09567"></a><span class="lineno"> 9567</span>&#160;    idtsub=UUMINLIMIT+fabs(Gmhd*iUmhd);</div>
<div class="line"><a name="l09568"></a><span class="lineno"> 9568</span>&#160;    idtsub=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(idtsub,UUMINLIMIT+fabs(Grad*iUrad));</div>
<div class="line"><a name="l09569"></a><span class="lineno"> 9569</span>&#160;    idtsub=sqrt(idtsub);</div>
<div class="line"><a name="l09570"></a><span class="lineno"> 9570</span>&#160;</div>
<div class="line"><a name="l09571"></a><span class="lineno"> 9571</span>&#160;    <span class="comment">//    if(1||realdt/(COURRADEXPLICIT/idtsub)&gt;1.0) dualfprintf(fail_file,&quot;UMHD: Umhdrad=%g %g : G=%g %g %g %g : Gmhdrad= %g %g :: iUmhdrad=%g %g ::: dtsub=%g realdt/dtsub=%g\n&quot;,Umhd,Urad,Gddtpl[UU],Gddtpl[U1],Gddtpl[U2],Gddtpl[U3],Gmhd,Grad,iUmhd,iUrad,COURRADEXPLICIT/idtsub,realdt/(COURRADEXPLICIT/idtsub));</span></div>
<div class="line"><a name="l09572"></a><span class="lineno"> 9572</span>&#160;</div>
<div class="line"><a name="l09573"></a><span class="lineno"> 9573</span>&#160;  }</div>
<div class="line"><a name="l09574"></a><span class="lineno"> 9574</span>&#160;  else if(method==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a4d98ec6b860124fb970995509f049ce6">SPACETIMESUBSPLITTIME</a>){</div>
<div class="line"><a name="l09575"></a><span class="lineno"> 9575</span>&#160;    <span class="comment">// won&#39;t be efficient if v~0</span></div>
<div class="line"><a name="l09576"></a><span class="lineno"> 9576</span>&#160;    <span class="comment">// if v&lt;&lt;1 and G is mid-range but still negligible, then dt will be incredibly small and code will halt if sub-cycling.</span></div>
<div class="line"><a name="l09577"></a><span class="lineno"> 9577</span>&#160;    Usmhd=Usrad=Gsmhd=Gsrad=0.0;</div>
<div class="line"><a name="l09578"></a><span class="lineno"> 9578</span>&#160;    Utmhd=Utrad=Gtmhd=Gtrad=0.0;</div>
<div class="line"><a name="l09579"></a><span class="lineno"> 9579</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) Usmhd += fabs(U[UU+jj]*U[UU+jj]*ptrgeom-&gt;<a class="code" href="../../dc/dd2/newcodediff_8txt.html#a98399a5a291e3844900ecfbacdcb2da0">gcon</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(jj,jj)]);</div>
<div class="line"><a name="l09580"></a><span class="lineno"> 9580</span>&#160;    jj=TT;     Utmhd += fabs(U[UU+jj]*U[UU+jj]*ptrgeom-&gt;<a class="code" href="../../dc/dd2/newcodediff_8txt.html#a98399a5a291e3844900ecfbacdcb2da0">gcon</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(jj,jj)]);</div>
<div class="line"><a name="l09581"></a><span class="lineno"> 9581</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) Usrad += fabs(U[URAD0+jj]*U[URAD0+jj]*ptrgeom-&gt;<a class="code" href="../../dc/dd2/newcodediff_8txt.html#a98399a5a291e3844900ecfbacdcb2da0">gcon</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(jj,jj)]);</div>
<div class="line"><a name="l09582"></a><span class="lineno"> 9582</span>&#160;    jj=TT;     Utrad += fabs(U[URAD0+jj]*U[URAD0+jj]*ptrgeom-&gt;<a class="code" href="../../dc/dd2/newcodediff_8txt.html#a98399a5a291e3844900ecfbacdcb2da0">gcon</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(jj,jj)]);</div>
<div class="line"><a name="l09583"></a><span class="lineno"> 9583</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) Gsmhd += fabs(Gddtpl[UU+jj]*Gddtpl[UU+jj]*ptrgeom-&gt;<a class="code" href="../../dc/dd2/newcodediff_8txt.html#a98399a5a291e3844900ecfbacdcb2da0">gcon</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(jj,jj)]);</div>
<div class="line"><a name="l09584"></a><span class="lineno"> 9584</span>&#160;    jj=TT;     Gtmhd += fabs(Gddtpl[UU+jj]*Gddtpl[UU+jj]*ptrgeom-&gt;<a class="code" href="../../dc/dd2/newcodediff_8txt.html#a98399a5a291e3844900ecfbacdcb2da0">gcon</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(jj,jj)]);</div>
<div class="line"><a name="l09585"></a><span class="lineno"> 9585</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) Gsrad += fabs(Gddtpl[URAD0+jj]*Gddtpl[URAD0+jj]*ptrgeom-&gt;<a class="code" href="../../dc/dd2/newcodediff_8txt.html#a98399a5a291e3844900ecfbacdcb2da0">gcon</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(jj,jj)]);</div>
<div class="line"><a name="l09586"></a><span class="lineno"> 9586</span>&#160;    jj=TT;     Gtrad += fabs(Gddtpl[URAD0+jj]*Gddtpl[URAD0+jj]*ptrgeom-&gt;<a class="code" href="../../dc/dd2/newcodediff_8txt.html#a98399a5a291e3844900ecfbacdcb2da0">gcon</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(jj,jj)]);</div>
<div class="line"><a name="l09587"></a><span class="lineno"> 9587</span>&#160;    iUsmhd=1.0/(fabs(Usmhd)+UUMINLIMIT);</div>
<div class="line"><a name="l09588"></a><span class="lineno"> 9588</span>&#160;    iUtmhd=1.0/(fabs(Utmhd)+UUMINLIMIT);</div>
<div class="line"><a name="l09589"></a><span class="lineno"> 9589</span>&#160;    iUsrad=1.0/(fabs(Usrad)+UUMINLIMIT);</div>
<div class="line"><a name="l09590"></a><span class="lineno"> 9590</span>&#160;    iUtrad=1.0/(fabs(Utrad)+UUMINLIMIT);</div>
<div class="line"><a name="l09591"></a><span class="lineno"> 9591</span>&#160;    idtsubs=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a09c78d2f8feb311dd9fc969a0bf84979">SMALL</a>+fabs(Gsmhd*iUsmhd);</div>
<div class="line"><a name="l09592"></a><span class="lineno"> 9592</span>&#160;    idtsubs=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(idtsubs,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a09c78d2f8feb311dd9fc969a0bf84979">SMALL</a>+fabs(Gsrad*iUsrad));</div>
<div class="line"><a name="l09593"></a><span class="lineno"> 9593</span>&#160;    idtsubt=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a09c78d2f8feb311dd9fc969a0bf84979">SMALL</a>+fabs(Gtmhd*iUtmhd);</div>
<div class="line"><a name="l09594"></a><span class="lineno"> 9594</span>&#160;    idtsubt=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(idtsubt,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a09c78d2f8feb311dd9fc969a0bf84979">SMALL</a>+fabs(Gtrad*iUtrad));</div>
<div class="line"><a name="l09595"></a><span class="lineno"> 9595</span>&#160;    idtsub=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(idtsubs,idtsubt);</div>
<div class="line"><a name="l09596"></a><span class="lineno"> 9596</span>&#160;    idtsub=sqrt(idtsub);</div>
<div class="line"><a name="l09597"></a><span class="lineno"> 9597</span>&#160;  }</div>
<div class="line"><a name="l09598"></a><span class="lineno"> 9598</span>&#160;  else if(method==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a0d4cb4961f7d88836e6b8761c5b616ee">SPACETIMESUBSPLITALL</a>){</div>
<div class="line"><a name="l09599"></a><span class="lineno"> 9599</span>&#160;    <span class="comment">// won&#39;t be efficient if flow becomes grid-aligned or if v~0</span></div>
<div class="line"><a name="l09600"></a><span class="lineno"> 9600</span>&#160;    Usmhd=Usrad=Gsmhd=Gsrad=0.0;</div>
<div class="line"><a name="l09601"></a><span class="lineno"> 9601</span>&#160;    idtsub=0.0;</div>
<div class="line"><a name="l09602"></a><span class="lineno"> 9602</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj){</div>
<div class="line"><a name="l09603"></a><span class="lineno"> 9603</span>&#160;      Umhd = fabs(U[UU+jj]*U[UU+jj]*ptrgeom-&gt;gcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(jj,jj)]);</div>
<div class="line"><a name="l09604"></a><span class="lineno"> 9604</span>&#160;      Urad = fabs(U[URAD0+jj]*U[URAD0+jj]*ptrgeom-&gt;gcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(jj,jj)]);</div>
<div class="line"><a name="l09605"></a><span class="lineno"> 9605</span>&#160;      Gmhd = fabs(Gddtpl[UU+jj]*Gddtpl[UU+jj]*ptrgeom-&gt;gcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(jj,jj)]);</div>
<div class="line"><a name="l09606"></a><span class="lineno"> 9606</span>&#160;      Grad = fabs(Gddtpl[URAD0+jj]*Gddtpl[URAD0+jj]*ptrgeom-&gt;gcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(jj,jj)]);</div>
<div class="line"><a name="l09607"></a><span class="lineno"> 9607</span>&#160;      iUmhd=1.0/(fabs(Umhd)+<a class="code" href="../../d8/d5b/defs_8general_8h.html#a13f615d7832e3abc6abd54325112daf3">UUMINLIMIT</a>);</div>
<div class="line"><a name="l09608"></a><span class="lineno"> 9608</span>&#160;      iUrad=1.0/(fabs(Urad)+<a class="code" href="../../d8/d5b/defs_8general_8h.html#a13f615d7832e3abc6abd54325112daf3">UUMINLIMIT</a>);</div>
<div class="line"><a name="l09609"></a><span class="lineno"> 9609</span>&#160;      idtsub=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(idtsub,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a09c78d2f8feb311dd9fc969a0bf84979">SMALL</a>+fabs(Gmhd*iUmhd));</div>
<div class="line"><a name="l09610"></a><span class="lineno"> 9610</span>&#160;      idtsub=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(idtsub,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a09c78d2f8feb311dd9fc969a0bf84979">SMALL</a>+fabs(Grad*iUrad));</div>
<div class="line"><a name="l09611"></a><span class="lineno"> 9611</span>&#160;    }</div>
<div class="line"><a name="l09612"></a><span class="lineno"> 9612</span>&#160;  }</div>
<div class="line"><a name="l09613"></a><span class="lineno"> 9613</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(method==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a0f25129d2628f77ee64c975864c8a3a8">SPACETIMESUBSPLITSUPERALL</a>){</div>
<div class="line"><a name="l09614"></a><span class="lineno"> 9614</span>&#160;    <span class="comment">// won&#39;t be efficient if flow becomes grid-aligned or if v~0 or if radiation neglibile contribution to fluid dynamics</span></div>
<div class="line"><a name="l09615"></a><span class="lineno"> 9615</span>&#160;    Usmhd=Usrad=Gsmhd=Gsrad=0.0;</div>
<div class="line"><a name="l09616"></a><span class="lineno"> 9616</span>&#160;    idtsub=0.0;</div>
<div class="line"><a name="l09617"></a><span class="lineno"> 9617</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj){</div>
<div class="line"><a name="l09618"></a><span class="lineno"> 9618</span>&#160;      Umhd = fabs(U[UU+jj]*U[UU+jj]*ptrgeom-&gt;gcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(jj,jj)]);</div>
<div class="line"><a name="l09619"></a><span class="lineno"> 9619</span>&#160;      Urad = fabs(U[URAD0+jj]*U[URAD0+jj]*ptrgeom-&gt;gcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(jj,jj)]);</div>
<div class="line"><a name="l09620"></a><span class="lineno"> 9620</span>&#160;      Gmhd = fabs(Gddtpl[UU+jj]*Gddtpl[UU+jj]*ptrgeom-&gt;gcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(jj,jj)]);</div>
<div class="line"><a name="l09621"></a><span class="lineno"> 9621</span>&#160;      Grad = fabs(Gddtpl[URAD0+jj]*Gddtpl[URAD0+jj]*ptrgeom-&gt;gcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(jj,jj)]);</div>
<div class="line"><a name="l09622"></a><span class="lineno"> 9622</span>&#160;      iUmhd=1.0/(fabs(Umhd)+<a class="code" href="../../d8/d5b/defs_8general_8h.html#a13f615d7832e3abc6abd54325112daf3">UUMINLIMIT</a>);</div>
<div class="line"><a name="l09623"></a><span class="lineno"> 9623</span>&#160;      iUrad=1.0/(fabs(Urad)+<a class="code" href="../../d8/d5b/defs_8general_8h.html#a13f615d7832e3abc6abd54325112daf3">UUMINLIMIT</a>);</div>
<div class="line"><a name="l09624"></a><span class="lineno"> 9624</span>&#160;      idtsub=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(idtsub,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a09c78d2f8feb311dd9fc969a0bf84979">SMALL</a>+fabs(Gmhd*iUmhd));</div>
<div class="line"><a name="l09625"></a><span class="lineno"> 9625</span>&#160;      idtsub=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(idtsub,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a09c78d2f8feb311dd9fc969a0bf84979">SMALL</a>+fabs(Grad*iUrad));</div>
<div class="line"><a name="l09626"></a><span class="lineno"> 9626</span>&#160;    }</div>
<div class="line"><a name="l09627"></a><span class="lineno"> 9627</span>&#160;  }</div>
<div class="line"><a name="l09628"></a><span class="lineno"> 9628</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(method==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a71fa85e8a367b335d86a1f6d7f214f9d">SPACETIMESUBSPLITMHDRAD</a>){</div>
<div class="line"><a name="l09629"></a><span class="lineno"> 9629</span>&#160;    <span class="comment">// merged space-time to avoid negligible total momentum with large update needing to be resolved.</span></div>
<div class="line"><a name="l09630"></a><span class="lineno"> 9630</span>&#160;    Umhd=Urad=Gmhd=Grad=0.0;</div>
<div class="line"><a name="l09631"></a><span class="lineno"> 9631</span>&#160;    idtsub=0.0;</div>
<div class="line"><a name="l09632"></a><span class="lineno"> 9632</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) Umhd += fabs(U[UU+jj]*U[UU+jj]*ptrgeom-&gt;<a class="code" href="../../dc/dd2/newcodediff_8txt.html#a98399a5a291e3844900ecfbacdcb2da0">gcon</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(jj,jj)]);</div>
<div class="line"><a name="l09633"></a><span class="lineno"> 9633</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) Urad += fabs(U[URAD0+jj]*U[URAD0+jj]*ptrgeom-&gt;<a class="code" href="../../dc/dd2/newcodediff_8txt.html#a98399a5a291e3844900ecfbacdcb2da0">gcon</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(jj,jj)]);</div>
<div class="line"><a name="l09634"></a><span class="lineno"> 9634</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) Gmhd += fabs(Gddtpl[UU+jj]*Gddtpl[UU+jj]*ptrgeom-&gt;<a class="code" href="../../dc/dd2/newcodediff_8txt.html#a98399a5a291e3844900ecfbacdcb2da0">gcon</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(jj,jj)]);</div>
<div class="line"><a name="l09635"></a><span class="lineno"> 9635</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) Grad += fabs(Gddtpl[URAD0+jj]*Gddtpl[URAD0+jj]*ptrgeom-&gt;<a class="code" href="../../dc/dd2/newcodediff_8txt.html#a98399a5a291e3844900ecfbacdcb2da0">gcon</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(jj,jj)]);</div>
<div class="line"><a name="l09636"></a><span class="lineno"> 9636</span>&#160;    iUmhd=1.0/(fabs(Umhd)+UUMINLIMIT);</div>
<div class="line"><a name="l09637"></a><span class="lineno"> 9637</span>&#160;    iUrad=1.0/(fabs(Urad)+UUMINLIMIT);</div>
<div class="line"><a name="l09638"></a><span class="lineno"> 9638</span>&#160;    idtsub=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(idtsub,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a09c78d2f8feb311dd9fc969a0bf84979">SMALL</a>+fabs(Gmhd*iUmhd));</div>
<div class="line"><a name="l09639"></a><span class="lineno"> 9639</span>&#160;    idtsub=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(idtsub,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a09c78d2f8feb311dd9fc969a0bf84979">SMALL</a>+fabs(Grad*iUrad));</div>
<div class="line"><a name="l09640"></a><span class="lineno"> 9640</span>&#160;</div>
<div class="line"><a name="l09641"></a><span class="lineno"> 9641</span>&#160;    <span class="comment">//    dualfprintf(fail_file,&quot;UMHD: %g %g %g %g %g %g\n&quot;,Umhd,Urad,Gtot,iUmhd,iUrad);</span></div>
<div class="line"><a name="l09642"></a><span class="lineno"> 9642</span>&#160;</div>
<div class="line"><a name="l09643"></a><span class="lineno"> 9643</span>&#160;  }</div>
<div class="line"><a name="l09644"></a><span class="lineno"> 9644</span>&#160;  else if(method==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a6a21302ee0f8977df980aca4959a0f2e">SPACETIMESUBSPLITTIMEMHDRAD</a>){</div>
<div class="line"><a name="l09645"></a><span class="lineno"> 9645</span>&#160;    <span class="comment">// won&#39;t be efficient if v~0</span></div>
<div class="line"><a name="l09646"></a><span class="lineno"> 9646</span>&#160;    <span class="comment">// if v&lt;&lt;1 and G is mid-range but still negligible, then dt will be incredibly small and code will halt.</span></div>
<div class="line"><a name="l09647"></a><span class="lineno"> 9647</span>&#160;    Usmhd=Usrad=Gsmhd=Gsrad=0.0;</div>
<div class="line"><a name="l09648"></a><span class="lineno"> 9648</span>&#160;    Utmhd=Utrad=Gtmhd=Gtrad=0.0;</div>
<div class="line"><a name="l09649"></a><span class="lineno"> 9649</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) Usmhd += fabs(U[UU+jj]*U[UU+jj]*ptrgeom-&gt;<a class="code" href="../../dc/dd2/newcodediff_8txt.html#a98399a5a291e3844900ecfbacdcb2da0">gcon</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(jj,jj)]);</div>
<div class="line"><a name="l09650"></a><span class="lineno"> 9650</span>&#160;    jj=TT;     Utmhd += fabs(U[UU+jj]*U[UU+jj]*ptrgeom-&gt;<a class="code" href="../../dc/dd2/newcodediff_8txt.html#a98399a5a291e3844900ecfbacdcb2da0">gcon</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(jj,jj)]);</div>
<div class="line"><a name="l09651"></a><span class="lineno"> 9651</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) Usrad += fabs(U[URAD0+jj]*U[URAD0+jj]*ptrgeom-&gt;<a class="code" href="../../dc/dd2/newcodediff_8txt.html#a98399a5a291e3844900ecfbacdcb2da0">gcon</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(jj,jj)]);</div>
<div class="line"><a name="l09652"></a><span class="lineno"> 9652</span>&#160;    jj=TT;     Utrad += fabs(U[URAD0+jj]*U[URAD0+jj]*ptrgeom-&gt;<a class="code" href="../../dc/dd2/newcodediff_8txt.html#a98399a5a291e3844900ecfbacdcb2da0">gcon</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(jj,jj)]);</div>
<div class="line"><a name="l09653"></a><span class="lineno"> 9653</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) Gsmhd += fabs(Gddtpl[UU+jj]*Gddtpl[UU+jj]*ptrgeom-&gt;<a class="code" href="../../dc/dd2/newcodediff_8txt.html#a98399a5a291e3844900ecfbacdcb2da0">gcon</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(jj,jj)]);</div>
<div class="line"><a name="l09654"></a><span class="lineno"> 9654</span>&#160;    jj=TT;     Gtmhd += fabs(Gddtpl[UU+jj]*Gddtpl[UU+jj]*ptrgeom-&gt;<a class="code" href="../../dc/dd2/newcodediff_8txt.html#a98399a5a291e3844900ecfbacdcb2da0">gcon</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(jj,jj)]);</div>
<div class="line"><a name="l09655"></a><span class="lineno"> 9655</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) Gsrad += fabs(Gddtpl[URAD0+jj]*Gddtpl[URAD0+jj]*ptrgeom-&gt;<a class="code" href="../../dc/dd2/newcodediff_8txt.html#a98399a5a291e3844900ecfbacdcb2da0">gcon</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(jj,jj)]);</div>
<div class="line"><a name="l09656"></a><span class="lineno"> 9656</span>&#160;    jj=TT;     Gtrad += fabs(Gddtpl[URAD0+jj]*Gddtpl[URAD0+jj]*ptrgeom-&gt;<a class="code" href="../../dc/dd2/newcodediff_8txt.html#a98399a5a291e3844900ecfbacdcb2da0">gcon</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(jj,jj)]);</div>
<div class="line"><a name="l09657"></a><span class="lineno"> 9657</span>&#160;    iUsmhd=1.0/(fabs(Usmhd)+UUMINLIMIT);</div>
<div class="line"><a name="l09658"></a><span class="lineno"> 9658</span>&#160;    iUtmhd=1.0/(fabs(Utmhd)+UUMINLIMIT);</div>
<div class="line"><a name="l09659"></a><span class="lineno"> 9659</span>&#160;    iUsrad=1.0/(fabs(Usrad)+UUMINLIMIT);</div>
<div class="line"><a name="l09660"></a><span class="lineno"> 9660</span>&#160;    iUtrad=1.0/(fabs(Utrad)+UUMINLIMIT);</div>
<div class="line"><a name="l09661"></a><span class="lineno"> 9661</span>&#160;    idtsub=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a09c78d2f8feb311dd9fc969a0bf84979">SMALL</a>;</div>
<div class="line"><a name="l09662"></a><span class="lineno"> 9662</span>&#160;    idtsub=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(idtsub,SMALL+fabs(Gsmhd*iUsmhd));</div>
<div class="line"><a name="l09663"></a><span class="lineno"> 9663</span>&#160;    idtsub=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(idtsub,SMALL+fabs(Gsrad*iUsrad));</div>
<div class="line"><a name="l09664"></a><span class="lineno"> 9664</span>&#160;    idtsub=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(idtsub,SMALL+fabs(Gtmhd*iUtmhd));</div>
<div class="line"><a name="l09665"></a><span class="lineno"> 9665</span>&#160;    idtsub=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(idtsub,SMALL+fabs(Gtrad*iUtrad));</div>
<div class="line"><a name="l09666"></a><span class="lineno"> 9666</span>&#160;  }</div>
<div class="line"><a name="l09667"></a><span class="lineno"> 9667</span>&#160;</div>
<div class="line"><a name="l09668"></a><span class="lineno"> 9668</span>&#160;</div>
<div class="line"><a name="l09669"></a><span class="lineno"> 9669</span>&#160;  </div>
<div class="line"><a name="l09670"></a><span class="lineno"> 9670</span>&#160;  <span class="comment">// what to return</span></div>
<div class="line"><a name="l09671"></a><span class="lineno"> 9671</span>&#160;  *dtsub=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a05e8058a59ca22b59a8409813e650033">COURRADEXPLICIT</a>/idtsub;</div>
<div class="line"><a name="l09672"></a><span class="lineno"> 9672</span>&#160;</div>
<div class="line"><a name="l09673"></a><span class="lineno"> 9673</span>&#160;</div>
<div class="line"><a name="l09674"></a><span class="lineno"> 9674</span>&#160;</div>
<div class="line"><a name="l09675"></a><span class="lineno"> 9675</span>&#160;  <span class="comment">//  dualfprintf(fail_file,&quot;*dtsub=%g idtsub=%g method=%d\n&quot;,*dtsub,idtsub,method);</span></div>
<div class="line"><a name="l09676"></a><span class="lineno"> 9676</span>&#160; </div>
<div class="line"><a name="l09677"></a><span class="lineno"> 9677</span>&#160;}</div>
<div class="line"><a name="l09678"></a><span class="lineno"> 9678</span>&#160;</div>
<div class="line"><a name="l09679"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afa05900437da5eb66c5a97c28e4283d8"> 9679</a></span>&#160;<span class="preprocessor">#define EXPLICITFAILEDBUTWENTTHROUGH -2</span></div>
<div class="line"><a name="l09680"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a6bc50dd87820f78f39f35a72c34ed74e"> 9680</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define EXPLICITNOTNECESSARY -1</span></div>
<div class="line"><a name="l09681"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a0782a90dc1ab7f4c99bd38970280e6d4"> 9681</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define EXPLICITNOTFAILED 0 // should stay zero</span></div>
<div class="line"><a name="l09682"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ac38828263c28e7d566ff97bb7cbd1ccc"> 9682</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define EXPLICITFAILED 1 // should stay one</span></div>
<div class="line"><a name="l09683"></a><span class="lineno"> 9683</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l09684"></a><span class="lineno"> 9684</span>&#160;</div>
<div class="line"><a name="l09685"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#abe3dbe8e01255eeeb3a780c24ea6cee8"> 9685</a></span>&#160;<span class="preprocessor">#define GETADVANCEDUNEW0FOREXPLICIT 1 // Use this to check if single explicit step was really allowable, but get_dtsub() already uses advanced U.  But chi will be not updated for fluid dUriemann update, so still might want to do this (with proper code changes) in order to get chi good.</span></div>
<div class="line"><a name="l09686"></a><span class="lineno"> 9686</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l09694"></a><span class="lineno"> 9694</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> source_explicit(<span class="keywordtype">int</span> whichsc, <span class="keywordtype">int</span> whichradsourcemethod, <span class="keywordtype">int</span> methoddtsub,<span class="keywordtype">int</span> *eomtype,</div>
<div class="line"><a name="l09695"></a><span class="lineno"> 9695</span>&#160;                           <span class="keywordtype">void</span> (*sourcefunc)(<span class="keywordtype">int</span> methoddtsub, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ui, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Uf, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *dUother, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUf, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUimp, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Gpl, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *dtsub),</div>
<div class="line"><a name="l09696"></a><span class="lineno"> 9696</span>&#160;                           <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pb, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *piin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Uiin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ufin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUf, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUimp, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *q, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *dUother, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*dUcomp)[NPR])</div>
<div class="line"><a name="l09697"></a><span class="lineno"> 9697</span>&#160;{</div>
<div class="line"><a name="l09698"></a><span class="lineno"> 9698</span>&#160;  <span class="keywordtype">int</span> pliter, pl;</div>
<div class="line"><a name="l09699"></a><span class="lineno"> 9699</span>&#160;</div>
<div class="line"><a name="l09700"></a><span class="lineno"> 9700</span>&#160;  <span class="keywordtype">int</span> eomtypelocal=*eomtype; <span class="comment">// default</span></div>
<div class="line"><a name="l09701"></a><span class="lineno"> 9701</span>&#160;</div>
<div class="line"><a name="l09703"></a><span class="lineno"> 9703</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l09704"></a><span class="lineno"> 9704</span>&#160;  <span class="comment">// SETUP LOOPS</span></div>
<div class="line"><a name="l09705"></a><span class="lineno"> 9705</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l09707"></a><span class="lineno"> 9707</span>&#160;<span class="comment"></span>  <span class="keywordtype">int</span> showmessages=0;</div>
<div class="line"><a name="l09708"></a><span class="lineno"> 9708</span>&#160;  <span class="keywordtype">int</span> showmessagesheavy=0;</div>
<div class="line"><a name="l09709"></a><span class="lineno"> 9709</span>&#160;  <span class="keywordtype">int</span> allowlocalfailurefixandnoreport=0; <span class="comment">// need to see if any failures.</span></div>
<div class="line"><a name="l09710"></a><span class="lineno"> 9710</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../db/d3a/structof__newtonstats.html">of_newtonstats</a> newtonstats; setnewtonstatsdefault(&amp;newtonstats);</div>
<div class="line"><a name="l09711"></a><span class="lineno"> 9711</span>&#160;  <span class="comment">// initialize counters</span></div>
<div class="line"><a name="l09712"></a><span class="lineno"> 9712</span>&#160;  newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a073783ba864c07681c8999a67162202b">nstroke</a>=newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a83280998e47831044a7e35299495a9bb">lntries</a>=0;</div>
<div class="line"><a name="l09713"></a><span class="lineno"> 9713</span>&#160;  <span class="keywordtype">int</span> finalstep = 0;  <span class="comment">//can choose either 1 or 0 depending on whether want floor-like fixups (1) or not (0).  unclear which one would work best since for Newton method to converge might want to allow negative density on the way to the correct solution, on the other hand want to prevent runaway into rho &lt; 0 region and so want floors.</span></div>
<div class="line"><a name="l09714"></a><span class="lineno"> 9714</span>&#160;</div>
<div class="line"><a name="l09715"></a><span class="lineno"> 9715</span>&#160;</div>
<div class="line"><a name="l09716"></a><span class="lineno"> 9716</span>&#160;  <span class="comment">//  if(1||nstep&gt;=800){</span></div>
<div class="line"><a name="l09717"></a><span class="lineno"> 9717</span>&#160;  <span class="comment">//    showmessages=showmessagesheavy=1;</span></div>
<div class="line"><a name="l09718"></a><span class="lineno"> 9718</span>&#160;  <span class="comment">//  }</span></div>
<div class="line"><a name="l09719"></a><span class="lineno"> 9719</span>&#160;</div>
<div class="line"><a name="l09721"></a><span class="lineno"> 9721</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l09722"></a><span class="lineno"> 9722</span>&#160;  <span class="comment">// SETUP U and P and q</span></div>
<div class="line"><a name="l09723"></a><span class="lineno"> 9723</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l09725"></a><span class="lineno"> 9725</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l09726"></a><span class="lineno"> 9726</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> pb0[NPR],Uiin0[NPR];</div>
<div class="line"><a name="l09727"></a><span class="lineno"> 9727</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> prnew[NPR],Unew[NPR],Unew0[NPR];</div>
<div class="line"><a name="l09728"></a><span class="lineno"> 9728</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> prforG[NPR];</div>
<div class="line"><a name="l09729"></a><span class="lineno"> 9729</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> q0,qnew;</div>
<div class="line"><a name="l09730"></a><span class="lineno"> 9730</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Gpl[NPR];</div>
<div class="line"><a name="l09731"></a><span class="lineno"> 9731</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> chi;</div>
<div class="line"><a name="l09732"></a><span class="lineno"> 9732</span>&#160;</div>
<div class="line"><a name="l09733"></a><span class="lineno"> 9733</span>&#160;  <span class="comment">// backup pb, Uiin, and q and setup &quot;new&quot; versions to be iterated</span></div>
<div class="line"><a name="l09734"></a><span class="lineno"> 9734</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) prnew[pl]=pb0[pl]=pb[pl];</div>
<div class="line"><a name="l09735"></a><span class="lineno"> 9735</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) Unew[pl]=Uiin0[pl]=Uiin[pl];</div>
<div class="line"><a name="l09736"></a><span class="lineno"> 9736</span>&#160;  qnew=q0=*q;</div>
<div class="line"><a name="l09737"></a><span class="lineno"> 9737</span>&#160;</div>
<div class="line"><a name="l09738"></a><span class="lineno"> 9738</span>&#160;</div>
<div class="line"><a name="l09739"></a><span class="lineno"> 9739</span>&#160;  <span class="comment">// get updated U (try getting full update)</span></div>
<div class="line"><a name="l09740"></a><span class="lineno"> 9740</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fracdtuu0=1.0; <span class="comment">// try full uu0 at first</span></div>
<div class="line"><a name="l09741"></a><span class="lineno"> 9741</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dUnongeomall[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0a72db4856620ff1b9551c885f1b32b5">MAXTIMEORDER</a>]={0.0};</div>
<div class="line"><a name="l09742"></a><span class="lineno"> 9742</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) Unew[pl]=Unew0[pl]=UFSET(CUf,fracdtuu0*dt,Uiin[pl],Ufin[pl],dUother[pl],0.0,dUnongeomall);</div>
<div class="line"><a name="l09743"></a><span class="lineno"> 9743</span>&#160;</div>
<div class="line"><a name="l09744"></a><span class="lineno"> 9744</span>&#160;  <span class="comment">// if reversion from implicit, then no choice but to push through CASE radiation errors and hope the reductions there are ok.  Would be worse to have no reversion solution!</span></div>
<div class="line"><a name="l09745"></a><span class="lineno"> 9745</span>&#160;  <span class="keywordtype">int</span> pushthroughraderror=0;</div>
<div class="line"><a name="l09746"></a><span class="lineno"> 9746</span>&#160;  <span class="keywordflow">if</span>(whichradsourcemethod==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a949d43d3fb82c7d2aa55662bdfbb9c24">SOURCEMETHODEXPLICITREVERSIONFROMIMPLICIT</a> || whichradsourcemethod==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#af1f9940068a692ba76bb69e27206b729">SOURCEMETHODEXPLICITSUBCYCLEREVERSIONFROMIMPLICIT</a>){</div>
<div class="line"><a name="l09747"></a><span class="lineno"> 9747</span>&#160;    pushthroughraderror=1;</div>
<div class="line"><a name="l09748"></a><span class="lineno"> 9748</span>&#160;  }</div>
<div class="line"><a name="l09749"></a><span class="lineno"> 9749</span>&#160;</div>
<div class="line"><a name="l09750"></a><span class="lineno"> 9750</span>&#160;</div>
<div class="line"><a name="l09751"></a><span class="lineno"> 9751</span>&#160;</div>
<div class="line"><a name="l09752"></a><span class="lineno"> 9752</span>&#160;  <span class="comment">// Get prnew(Unew) using largest fracdtuu0 possible in order to get realistic estimate of dtsub</span></div>
<div class="line"><a name="l09753"></a><span class="lineno"> 9753</span>&#160;  <span class="comment">// used to use this as starting point for U, but that wasn&#39;t consistent with explicit stepping</span></div>
<div class="line"><a name="l09754"></a><span class="lineno"> 9754</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#abe3dbe8e01255eeeb3a780c24ea6cee8">GETADVANCEDUNEW0FOREXPLICIT</a>){</div>
<div class="line"><a name="l09756"></a><span class="lineno"> 9756</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l09757"></a><span class="lineno"> 9757</span>&#160;    <span class="comment">// Get good Unew0 that has P(Unew0) solution</span></div>
<div class="line"><a name="l09758"></a><span class="lineno"> 9758</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l09760"></a><span class="lineno"> 9760</span>&#160;<span class="comment"></span>    <span class="keywordflow">while</span>(1){ <span class="comment">// loop bounded by fracdtuu0 becoming too small</span></div>
<div class="line"><a name="l09761"></a><span class="lineno"> 9761</span>&#160;      <span class="comment">// Get pnew from Unew</span></div>
<div class="line"><a name="l09762"></a><span class="lineno"> 9762</span>&#160;      <span class="comment">// OPTMARK: Should optimize this to  not try to get down to machine precision</span></div>
<div class="line"><a name="l09763"></a><span class="lineno"> 9763</span>&#160;      <span class="comment">// initialize counters</span></div>
<div class="line"><a name="l09764"></a><span class="lineno"> 9764</span>&#160;      newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a073783ba864c07681c8999a67162202b">nstroke</a>=newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a83280998e47831044a7e35299495a9bb">lntries</a>=0;</div>
<div class="line"><a name="l09765"></a><span class="lineno"> 9765</span>&#160;      <span class="keywordtype">int</span> doradonly=0;</div>
<div class="line"><a name="l09766"></a><span class="lineno"> 9766</span>&#160;      <span class="keywordtype">int</span> whichcap=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a4b6c6060c025e15f1d92aae3dcb9365b" title="which cap type to place in rad inversion">CAPTYPEBASIC</a>;</div>
<div class="line"><a name="l09767"></a><span class="lineno"> 9767</span>&#160;      eomtypelocal=*eomtype; <span class="comment">// re-default</span></div>
<div class="line"><a name="l09768"></a><span class="lineno"> 9768</span>&#160;      <span class="keywordtype">int</span> radinvmod=0;</div>
<div class="line"><a name="l09769"></a><span class="lineno"> 9769</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dissmeasure=-1.0; <span class="comment">// assume ok to try energy</span></div>
<div class="line"><a name="l09770"></a><span class="lineno"> 9770</span>&#160;      <span class="keywordtype">int</span> checkoninversiongas;</div>
<div class="line"><a name="l09771"></a><span class="lineno"> 9771</span>&#160;      <span class="keywordtype">int</span> checkoninversionrad;</div>
<div class="line"><a name="l09772"></a><span class="lineno"> 9772</span>&#160;      <span class="comment">// don&#39;t check since slows down code and could be good enough solution if original error says ok.</span></div>
<div class="line"><a name="l09773"></a><span class="lineno"> 9773</span>&#160;      checkoninversiongas=checkoninversionrad=0;</div>
<div class="line"><a name="l09774"></a><span class="lineno"> 9774</span>&#160;      <span class="comment">//</span></div>
<div class="line"><a name="l09775"></a><span class="lineno"> 9775</span>&#160;      <span class="keywordtype">int</span> failutoprim=Utoprimgen_failwrapper(doradonly,&amp;radinvmod,showmessages,checkoninversiongas,checkoninversionrad, allowlocalfailurefixandnoreport, finalstep, &amp;eomtypelocal, whichcap, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7d1dc231c422450f87fdb3e71b4a7aff" title="defines how Utoprimgen is used">EVOLVEUTOPRIM</a>, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab2be21bd5eff40ca89c20eeecbeab5e0">UNOTHING</a>, Unew, q, ptrgeom, dissmeasure, prnew, &amp;newtonstats);</div>
<div class="line"><a name="l09776"></a><span class="lineno"> 9776</span>&#160;</div>
<div class="line"><a name="l09777"></a><span class="lineno"> 9777</span>&#160;      <span class="keywordflow">if</span>(failutoprim){</div>
<div class="line"><a name="l09778"></a><span class="lineno"> 9778</span>&#160;</div>
<div class="line"><a name="l09779"></a><span class="lineno"> 9779</span>&#160;        <span class="keywordflow">if</span>(whichradsourcemethod==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#abdac9826c3cf9ac8e2eb664896d00ddc">SOURCEMETHODEXPLICIT</a> || whichradsourcemethod==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ada88bbc566d5599a97c21ab9adfd0e2c">SOURCEMETHODEXPLICITSUBCYCLE</a> || whichradsourcemethod==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a949d43d3fb82c7d2aa55662bdfbb9c24">SOURCEMETHODEXPLICITREVERSIONFROMIMPLICIT</a> || whichradsourcemethod==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#af1f9940068a692ba76bb69e27206b729">SOURCEMETHODEXPLICITSUBCYCLEREVERSIONFROMIMPLICIT</a>){</div>
<div class="line"><a name="l09780"></a><span class="lineno"> 9780</span>&#160;          <span class="comment">// then ok to be here</span></div>
<div class="line"><a name="l09781"></a><span class="lineno"> 9781</span>&#160;        }</div>
<div class="line"><a name="l09782"></a><span class="lineno"> 9782</span>&#160;        <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l09783"></a><span class="lineno"> 9783</span>&#160;          <span class="comment">// if here, then must be doing implicit checks, so return that should just do implicit instead of any more expensive calculations here.</span></div>
<div class="line"><a name="l09784"></a><span class="lineno"> 9784</span>&#160;          <span class="keywordflow">return</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ac38828263c28e7d566ff97bb7cbd1ccc">EXPLICITFAILED</a>);</div>
<div class="line"><a name="l09785"></a><span class="lineno"> 9785</span>&#160;        }</div>
<div class="line"><a name="l09786"></a><span class="lineno"> 9786</span>&#160;</div>
<div class="line"><a name="l09787"></a><span class="lineno"> 9787</span>&#160;        <span class="comment">// backing off dU</span></div>
<div class="line"><a name="l09788"></a><span class="lineno"> 9788</span>&#160;        fracdtuu0*=0.5;</div>
<div class="line"><a name="l09789"></a><span class="lineno"> 9789</span>&#160;</div>
<div class="line"><a name="l09790"></a><span class="lineno"> 9790</span>&#160;        <span class="keywordflow">if</span>(showmessagesheavy &amp;&amp; debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;Backing off fracdtuu0=%g\n&quot;</span>,fracdtuu0);</div>
<div class="line"><a name="l09791"></a><span class="lineno"> 9791</span>&#160;</div>
<div class="line"><a name="l09792"></a><span class="lineno"> 9792</span>&#160;        <span class="keywordflow">if</span>(fracdtuu0&lt;<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a8913cb5d64cfec23ae1a3052930ec468">NUMEPSILON</a>){</div>
<div class="line"><a name="l09793"></a><span class="lineno"> 9793</span>&#160;          <span class="keywordflow">if</span>(showmessagesheavy &amp;&amp; debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;In explicit, backed-off to very small level of fracdtuu0=%g, so must abort\n&quot;</span>,fracdtuu0);</div>
<div class="line"><a name="l09794"></a><span class="lineno"> 9794</span>&#160;          <span class="keywordflow">if</span>(whichradsourcemethod==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#abdac9826c3cf9ac8e2eb664896d00ddc">SOURCEMETHODEXPLICIT</a> || whichradsourcemethod==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ada88bbc566d5599a97c21ab9adfd0e2c">SOURCEMETHODEXPLICITSUBCYCLE</a> || whichradsourcemethod==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a949d43d3fb82c7d2aa55662bdfbb9c24">SOURCEMETHODEXPLICITREVERSIONFROMIMPLICIT</a> || whichradsourcemethod==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#af1f9940068a692ba76bb69e27206b729">SOURCEMETHODEXPLICITSUBCYCLEREVERSIONFROMIMPLICIT</a>){</div>
<div class="line"><a name="l09795"></a><span class="lineno"> 9795</span>&#160;            <span class="comment">// just use initial Unew0 then</span></div>
<div class="line"><a name="l09796"></a><span class="lineno"> 9796</span>&#160;            fracdtuu0=0.0;</div>
<div class="line"><a name="l09797"></a><span class="lineno"> 9797</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l09798"></a><span class="lineno"> 9798</span>&#160;          }</div>
<div class="line"><a name="l09799"></a><span class="lineno"> 9799</span>&#160;          <span class="keywordflow">else</span> <span class="keywordflow">return</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ac38828263c28e7d566ff97bb7cbd1ccc">EXPLICITFAILED</a>);</div>
<div class="line"><a name="l09800"></a><span class="lineno"> 9800</span>&#160;        }</div>
<div class="line"><a name="l09801"></a><span class="lineno"> 9801</span>&#160;        <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l09802"></a><span class="lineno"> 9802</span>&#160;          <span class="comment">// recompute use of full dU so Unew0 is updated</span></div>
<div class="line"><a name="l09803"></a><span class="lineno"> 9803</span>&#160;          <span class="comment">//          FTYPE dUnongeomall[MAXTIMEORDER]={0.0};</span></div>
<div class="line"><a name="l09804"></a><span class="lineno"> 9804</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) Unew[pl]=Unew0[pl]=UFSET(CUf,fracdtuu0*dt,Uiin[pl],Ufin[pl],dUother[pl],0.0,dUnongeomall);</div>
<div class="line"><a name="l09805"></a><span class="lineno"> 9805</span>&#160;          <span class="comment">// reset prnew</span></div>
<div class="line"><a name="l09806"></a><span class="lineno"> 9806</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) prnew[pl]=pb0[pl]=pb[pl];</div>
<div class="line"><a name="l09807"></a><span class="lineno"> 9807</span>&#160;        }</div>
<div class="line"><a name="l09808"></a><span class="lineno"> 9808</span>&#160;            </div>
<div class="line"><a name="l09809"></a><span class="lineno"> 9809</span>&#160;      }</div>
<div class="line"><a name="l09810"></a><span class="lineno"> 9810</span>&#160;      <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l09811"></a><span class="lineno"> 9811</span>&#160;        <span class="comment">// then found good Unew0</span></div>
<div class="line"><a name="l09812"></a><span class="lineno"> 9812</span>&#160;        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l09813"></a><span class="lineno"> 9813</span>&#160;      }</div>
<div class="line"><a name="l09814"></a><span class="lineno"> 9814</span>&#160;    }<span class="comment">// end while trying to get good Unew0</span></div>
<div class="line"><a name="l09815"></a><span class="lineno"> 9815</span>&#160;</div>
<div class="line"><a name="l09816"></a><span class="lineno"> 9816</span>&#160;  }</div>
<div class="line"><a name="l09817"></a><span class="lineno"> 9817</span>&#160;</div>
<div class="line"><a name="l09819"></a><span class="lineno"> 9819</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l09820"></a><span class="lineno"> 9820</span>&#160;  <span class="comment">// Get future force and dtsub so don&#39;t overestimate dtsub for first sub-cycle steps and end-up possibly jumping too far</span></div>
<div class="line"><a name="l09821"></a><span class="lineno"> 9821</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l09823"></a><span class="lineno"> 9823</span>&#160;<span class="comment"></span>  <span class="comment">// get prforG to compute G and chi for calc_dtsub() to ensure future update doesn&#39;t have radically different opacity and so 4-force and underpredict that implicit or sub-cycles are needed.</span></div>
<div class="line"><a name="l09824"></a><span class="lineno"> 9824</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) prforG[pl]=prnew[pl];</div>
<div class="line"><a name="l09825"></a><span class="lineno"> 9825</span>&#160;</div>
<div class="line"><a name="l09826"></a><span class="lineno"> 9826</span>&#160; </div>
<div class="line"><a name="l09827"></a><span class="lineno"> 9827</span>&#160;  <span class="comment">// get dtsubforG (don&#39;t use Gpl from this)</span></div>
<div class="line"><a name="l09828"></a><span class="lineno"> 9828</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dtsubforG;</div>
<div class="line"><a name="l09829"></a><span class="lineno"> 9829</span>&#160;  sourcefunc(methoddtsub, prforG, Uiin, Ufin, dUother, CUf, CUimp, Gpl, ptrgeom, &amp;dtsubforG);</div>
<div class="line"><a name="l09830"></a><span class="lineno"> 9830</span>&#160;  <span class="comment">//  dualfprintf(fail_file,&quot;dtsubforG=%g\n&quot;,dtsubforG);</span></div>
<div class="line"><a name="l09831"></a><span class="lineno"> 9831</span>&#160;</div>
<div class="line"><a name="l09832"></a><span class="lineno"> 9832</span>&#160;  <span class="keywordflow">if</span>(!(whichradsourcemethod==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#abdac9826c3cf9ac8e2eb664896d00ddc">SOURCEMETHODEXPLICIT</a> || whichradsourcemethod==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a949d43d3fb82c7d2aa55662bdfbb9c24">SOURCEMETHODEXPLICITREVERSIONFROMIMPLICIT</a> || whichradsourcemethod==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aca22384dd0085c835b968fc59699182f">SOURCEMETHODEXPLICITCHECKSFROMIMPLICIT</a>)){</div>
<div class="line"><a name="l09833"></a><span class="lineno"> 9833</span>&#160;    <span class="comment">// then if sub-cycling, really want to start with beginning pb so consistently do sub-steps for effective flux force and full-pl fluid force in time.</span></div>
<div class="line"><a name="l09834"></a><span class="lineno"> 9834</span>&#160;    <span class="comment">// But if end-up doing just one explcit step, then probably wanted to use time-advanced prnew as estimate.  That gives more stable result.</span></div>
<div class="line"><a name="l09835"></a><span class="lineno"> 9835</span>&#160;    <span class="comment">// then prforG is only used to ensure not getting bad guess for whether *should* sub-cycle.</span></div>
<div class="line"><a name="l09836"></a><span class="lineno"> 9836</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) prnew[pl]=pb[pl];</div>
<div class="line"><a name="l09837"></a><span class="lineno"> 9837</span>&#160;  }</div>
<div class="line"><a name="l09838"></a><span class="lineno"> 9838</span>&#160;</div>
<div class="line"><a name="l09839"></a><span class="lineno"> 9839</span>&#160;</div>
<div class="line"><a name="l09841"></a><span class="lineno"> 9841</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l09842"></a><span class="lineno"> 9842</span>&#160;  <span class="comment">// SETUP explicit sub-cycle LOOP</span></div>
<div class="line"><a name="l09843"></a><span class="lineno"> 9843</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l09845"></a><span class="lineno"> 9845</span>&#160;<span class="comment"></span>  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dttrue=0.0,dtcum=0.0;  <span class="comment">// cumulative sub-cycle time</span></div>
<div class="line"><a name="l09846"></a><span class="lineno"> 9846</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dtdiff;</div>
<div class="line"><a name="l09847"></a><span class="lineno"> 9847</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dtsub,dtsubold,dtsubuse;</div>
<div class="line"><a name="l09848"></a><span class="lineno"> 9848</span>&#160;  <span class="keywordtype">int</span> isexplicit=1;</div>
<div class="line"><a name="l09849"></a><span class="lineno"> 9849</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> realdt=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5dcc789108ddf06ec44fb22770f18e90" title="compute dt for this sub-step">compute_dt</a>(isexplicit,CUf, CUimp,dt);</div>
<div class="line"><a name="l09850"></a><span class="lineno"> 9850</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fracdtG;</div>
<div class="line"><a name="l09851"></a><span class="lineno"> 9851</span>&#160;</div>
<div class="line"><a name="l09852"></a><span class="lineno"> 9852</span>&#160;  <span class="keywordtype">int</span> jj;</div>
<div class="line"><a name="l09853"></a><span class="lineno"> 9853</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Gplprevious[NPR]={0}, sourcepl[NPR];</div>
<div class="line"><a name="l09854"></a><span class="lineno"> 9854</span>&#160;</div>
<div class="line"><a name="l09855"></a><span class="lineno"> 9855</span>&#160;</div>
<div class="line"><a name="l09856"></a><span class="lineno"> 9856</span>&#160;  <span class="comment">// initialize source update</span></div>
<div class="line"><a name="l09857"></a><span class="lineno"> 9857</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) sourcepl[pl] = 0;</div>
<div class="line"><a name="l09858"></a><span class="lineno"> 9858</span>&#160;</div>
<div class="line"><a name="l09860"></a><span class="lineno"> 9860</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l09861"></a><span class="lineno"> 9861</span>&#160;  <span class="comment">// explicit source LOOP</span></div>
<div class="line"><a name="l09862"></a><span class="lineno"> 9862</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l09864"></a><span class="lineno"> 9864</span>&#160;<span class="comment"></span>  <span class="keywordtype">int</span> itersub=0;</div>
<div class="line"><a name="l09865"></a><span class="lineno"> 9865</span>&#160;  <span class="keywordtype">int</span> done=0;</div>
<div class="line"><a name="l09866"></a><span class="lineno"> 9866</span>&#160;  <span class="keywordflow">while</span>(1){</div>
<div class="line"><a name="l09867"></a><span class="lineno"> 9867</span>&#160;</div>
<div class="line"><a name="l09868"></a><span class="lineno"> 9868</span>&#160;  </div>
<div class="line"><a name="l09869"></a><span class="lineno"> 9869</span>&#160;    <span class="comment">// get 4-force for full pl set</span></div>
<div class="line"><a name="l09870"></a><span class="lineno"> 9870</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) Gplprevious[pl]=Gpl[pl];</div>
<div class="line"><a name="l09871"></a><span class="lineno"> 9871</span>&#160;    <span class="comment">// get Gpl and dtsub for sub-cycling</span></div>
<div class="line"><a name="l09872"></a><span class="lineno"> 9872</span>&#160;    sourcefunc(methoddtsub, prnew, Uiin, Ufin, dUother, CUf, CUimp, Gpl, ptrgeom, &amp;dtsub);</div>
<div class="line"><a name="l09873"></a><span class="lineno"> 9873</span>&#160;    <span class="keywordflow">if</span>(itersub==0)  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) Gplprevious[pl]=Gpl[pl]; <span class="comment">// constant interpolation rather than just using zero for midpoint method</span></div>
<div class="line"><a name="l09874"></a><span class="lineno"> 9874</span>&#160;    <span class="keywordflow">if</span>(itersub==0 &amp;&amp; dtsub&gt;dtsubforG) dtsub=dtsubforG; <span class="comment">// ensure initial sub-stepping is not too large due to large state changes not accounted for yet.  Assuming slow safety factor growth in dtsub can occur from then on and that&#39;s ok since will catch updated state change to some fraction.</span></div>
<div class="line"><a name="l09875"></a><span class="lineno"> 9875</span>&#160;    <span class="comment">//    dualfprintf(fail_file,&quot;itersub=%d dtsub=%g\n&quot;,itersub,dtsub);</span></div>
<div class="line"><a name="l09876"></a><span class="lineno"> 9876</span>&#160;</div>
<div class="line"><a name="l09877"></a><span class="lineno"> 9877</span>&#160;</div>
<div class="line"><a name="l09878"></a><span class="lineno"> 9878</span>&#160;    <span class="comment">// if no solution for implicit and come to explicit, then failure can manifest as T large and then Gpl-&gt;nan or inf.  Must fail this scenario.</span></div>
<div class="line"><a name="l09879"></a><span class="lineno"> 9879</span>&#160;    <span class="comment">// This can happen even when have gotten quite close to end of step, but just no actually solution for the accurate value of U0 and G</span></div>
<div class="line"><a name="l09880"></a><span class="lineno"> 9880</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) <span class="keywordflow">if</span>(!<a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(Gpl[pl])) <span class="keywordflow">return</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ac38828263c28e7d566ff97bb7cbd1ccc">EXPLICITFAILED</a>);</div>
<div class="line"><a name="l09881"></a><span class="lineno"> 9881</span>&#160;</div>
<div class="line"><a name="l09882"></a><span class="lineno"> 9882</span>&#160;</div>
<div class="line"><a name="l09883"></a><span class="lineno"> 9883</span>&#160;    <span class="keywordflow">if</span>(showmessagesheavy&amp;&amp;debugfail&gt;=2){</div>
<div class="line"><a name="l09884"></a><span class="lineno"> 9884</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) dualfprintf(fail_file,<span class="stringliteral">&quot;SOURCE: pl=%d Gpl=%g dtsub=%g realdt=%g prnew=%g Uiin=%g Ufin=%g dUother=%g\n&quot;</span>,pl,Gpl[pl],dtsub,realdt,prnew[pl],Uiin[pl],Ufin[pl],dUother[pl]);</div>
<div class="line"><a name="l09885"></a><span class="lineno"> 9885</span>&#160;    }</div>
<div class="line"><a name="l09886"></a><span class="lineno"> 9886</span>&#160;</div>
<div class="line"><a name="l09887"></a><span class="lineno"> 9887</span>&#160;    <span class="keywordflow">if</span>(whichradsourcemethod==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aca22384dd0085c835b968fc59699182f">SOURCEMETHODEXPLICITCHECKSFROMIMPLICIT</a> || whichradsourcemethod==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aaf1fb98748cca01322e21e510b5fe11a">SOURCEMETHODEXPLICITSUBCYCLECHECKSFROMIMPLICIT</a>){</div>
<div class="line"><a name="l09888"></a><span class="lineno"> 9888</span>&#160;      <span class="comment">// then just check if need sub-cycles, and exit if so</span></div>
<div class="line"><a name="l09889"></a><span class="lineno"> 9889</span>&#160;      <span class="keywordflow">if</span>(realdt&gt;dtsub) <span class="keywordflow">return</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ac38828263c28e7d566ff97bb7cbd1ccc">EXPLICITFAILED</a>);</div>
<div class="line"><a name="l09890"></a><span class="lineno"> 9890</span>&#160;      <span class="comment">// else can do explicit step (or sub-cycles if happen to switch to them) and can avoid implicit step</span></div>
<div class="line"><a name="l09891"></a><span class="lineno"> 9891</span>&#160;    }</div>
<div class="line"><a name="l09892"></a><span class="lineno"> 9892</span>&#160;    <span class="comment">// if still here, then even with implicit checks, doing either explicit or sub-cycle explicit stepping</span></div>
<div class="line"><a name="l09893"></a><span class="lineno"> 9893</span>&#160;</div>
<div class="line"><a name="l09895"></a><span class="lineno"> 9895</span>&#160;    <span class="comment">// get fracdtG</span></div>
<div class="line"><a name="l09897"></a><span class="lineno"> 9897</span>&#160;<span class="comment"></span>      </div>
<div class="line"><a name="l09898"></a><span class="lineno"> 9898</span>&#160;    <span class="keywordflow">if</span>(whichradsourcemethod==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#abdac9826c3cf9ac8e2eb664896d00ddc">SOURCEMETHODEXPLICIT</a> || whichradsourcemethod==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a949d43d3fb82c7d2aa55662bdfbb9c24">SOURCEMETHODEXPLICITREVERSIONFROMIMPLICIT</a> || whichradsourcemethod==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aca22384dd0085c835b968fc59699182f">SOURCEMETHODEXPLICITCHECKSFROMIMPLICIT</a>){</div>
<div class="line"><a name="l09899"></a><span class="lineno"> 9899</span>&#160;      fracdtG=1.0;</div>
<div class="line"><a name="l09900"></a><span class="lineno"> 9900</span>&#160;    }</div>
<div class="line"><a name="l09901"></a><span class="lineno"> 9901</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l09902"></a><span class="lineno"> 9902</span>&#160;</div>
<div class="line"><a name="l09903"></a><span class="lineno"> 9903</span>&#160;      <span class="keywordflow">if</span>(realdt/dtsub&gt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ac0299384734a4247a9ca4d8581b3aa72" title="if tries more than this number of sub-cycles, just fail and assume no 4-force since probably due to n...">MAXSUBCYCLESFAIL</a>){</div>
<div class="line"><a name="l09904"></a><span class="lineno"> 9904</span>&#160;        <span class="comment">// then some major issue</span></div>
<div class="line"><a name="l09905"></a><span class="lineno"> 9905</span>&#160;        <span class="keywordflow">if</span>(debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;MAJOR explicit issue: realdt=%g dtsub=%g and aborted assuming no real solution and that best approximation is no force.\n&quot;</span>);</div>
<div class="line"><a name="l09906"></a><span class="lineno"> 9906</span>&#160;        <span class="keywordflow">return</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ac38828263c28e7d566ff97bb7cbd1ccc">EXPLICITFAILED</a>);</div>
<div class="line"><a name="l09907"></a><span class="lineno"> 9907</span>&#160;      }</div>
<div class="line"><a name="l09908"></a><span class="lineno"> 9908</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span>(realdt/dtsub&gt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a78196418cbe072d23bb7e7e5be7c6606">MAXSUBCYCLES</a> &amp;&amp; whichradsourcemethod==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#af1f9940068a692ba76bb69e27206b729">SOURCEMETHODEXPLICITSUBCYCLEREVERSIONFROMIMPLICIT</a>){</div>
<div class="line"><a name="l09909"></a><span class="lineno"> 9909</span>&#160;        <span class="comment">// Use MAXSUBCYCLES if otherwise was trying implicit.</span></div>
<div class="line"><a name="l09910"></a><span class="lineno"> 9910</span>&#160;        <span class="comment">// Impractical to assume if really revert to explicit (or really trying to use it) then rarely occurs or want to solve for actual solution, so do all needed sub-cycles!</span></div>
<div class="line"><a name="l09911"></a><span class="lineno"> 9911</span>&#160;        <span class="comment">// Semi-required to limit number of cycles for non-simple &quot;methoddtsub&quot; procedure that can produce arbitrarily small dtsub due to (e.g.) momentum term or something like that.</span></div>
<div class="line"><a name="l09912"></a><span class="lineno"> 9912</span>&#160;        <span class="comment">// NOTE: For high \tau, rad velocity entering chars goes like 1/\tau, so that timestep is higher.  But dtsub remains what it should be for explicit stepping, and so in high-tau case, explicit steps required per actual step goes like \tau^2.  So &quot;kinda&quot; ok that takes long time for explicit sub-stepping since ultimately reaching longer time.</span></div>
<div class="line"><a name="l09913"></a><span class="lineno"> 9913</span>&#160;        <span class="keywordflow">if</span>(showmessages &amp;&amp; debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;itersub=%d dtsub very small: %g with realdt=%g and only allowing MAXSUBCYCLES=%d subcycles, so limit dtsub: ijk=%d %d %d\n&quot;</span>,itersub,dtsub,realdt,<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a78196418cbe072d23bb7e7e5be7c6606">MAXSUBCYCLES</a>,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k);</div>
<div class="line"><a name="l09914"></a><span class="lineno"> 9914</span>&#160;        dtsub=realdt/(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a>)<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a78196418cbe072d23bb7e7e5be7c6606">MAXSUBCYCLES</a>;</div>
<div class="line"><a name="l09915"></a><span class="lineno"> 9915</span>&#160;      }</div>
<div class="line"><a name="l09916"></a><span class="lineno"> 9916</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a8913cb5d64cfec23ae1a3052930ec468">NUMEPSILON</a>*dtsub&gt;=realdt &amp;&amp; itersub==0){</div>
<div class="line"><a name="l09917"></a><span class="lineno"> 9917</span>&#160;        <span class="keywordflow">if</span>(showmessagesheavy &amp;&amp; debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;explicit not necessary\n&quot;</span>);</div>
<div class="line"><a name="l09918"></a><span class="lineno"> 9918</span>&#160;        <span class="comment">// then no need for source term at all</span></div>
<div class="line"><a name="l09919"></a><span class="lineno"> 9919</span>&#160;        <span class="keywordflow">return</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a6bc50dd87820f78f39f35a72c34ed74e">EXPLICITNOTNECESSARY</a>);</div>
<div class="line"><a name="l09920"></a><span class="lineno"> 9920</span>&#160;      }</div>
<div class="line"><a name="l09921"></a><span class="lineno"> 9921</span>&#160;</div>
<div class="line"><a name="l09922"></a><span class="lineno"> 9922</span>&#160;</div>
<div class="line"><a name="l09923"></a><span class="lineno"> 9923</span>&#160;      <span class="keywordflow">if</span>(itersub==0) dtsubold=dtsubuse=dtsub;</div>
<div class="line"><a name="l09924"></a><span class="lineno"> 9924</span>&#160;      <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l09925"></a><span class="lineno"> 9925</span>&#160;        <span class="comment">// override if dtsub is larger than realdt, indicating really done with iterations and reached some equilibrium, so no longer necessary to check vs. dtsubold</span></div>
<div class="line"><a name="l09926"></a><span class="lineno"> 9926</span>&#160;        <span class="comment">// No, too speculative.</span></div>
<div class="line"><a name="l09927"></a><span class="lineno"> 9927</span>&#160;        <span class="comment">//        if(dtsub&gt;realdt) dtsub=realdt;</span></div>
<div class="line"><a name="l09928"></a><span class="lineno"> 9928</span>&#160;        </div>
<div class="line"><a name="l09929"></a><span class="lineno"> 9929</span>&#160;        <span class="comment">// ensure don&#39;t change step too fast.  Sometimes first guess for dtsub can be small, and very next iteration suggests very large.  Not trustable, so stay slow.</span></div>
<div class="line"><a name="l09930"></a><span class="lineno"> 9930</span>&#160;        <span class="keywordflow">if</span>(dtsub&gt;dtsubold*(1.0+<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a036d2cbd64de942abfaf87cd4bad1863" title="like SAFE for normal dt step, don&#39;t allow explicit substepping to change dt too fast to avoid instabi...">MAXEXPLICITSUBSTEPCHANGE</a>)) dtsubuse=dtsubold*(1.0+<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a036d2cbd64de942abfaf87cd4bad1863" title="like SAFE for normal dt step, don&#39;t allow explicit substepping to change dt too fast to avoid instabi...">MAXEXPLICITSUBSTEPCHANGE</a>);</div>
<div class="line"><a name="l09931"></a><span class="lineno"> 9931</span>&#160;        <span class="keywordflow">else</span> dtsubuse=dtsub;</div>
<div class="line"><a name="l09932"></a><span class="lineno"> 9932</span>&#160;</div>
<div class="line"><a name="l09933"></a><span class="lineno"> 9933</span>&#160;        <span class="comment">// need to compare with previous actual dt</span></div>
<div class="line"><a name="l09934"></a><span class="lineno"> 9934</span>&#160;        dtsubold=dtsubuse;</div>
<div class="line"><a name="l09935"></a><span class="lineno"> 9935</span>&#160;      }</div>
<div class="line"><a name="l09936"></a><span class="lineno"> 9936</span>&#160;        </div>
<div class="line"><a name="l09937"></a><span class="lineno"> 9937</span>&#160;      <span class="comment">// time left to go in sub-cycling</span></div>
<div class="line"><a name="l09938"></a><span class="lineno"> 9938</span>&#160;      dtdiff=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(realdt-dtcum,0.0);</div>
<div class="line"><a name="l09939"></a><span class="lineno"> 9939</span>&#160;      dttrue=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(dtsubuse,dtdiff);</div>
<div class="line"><a name="l09940"></a><span class="lineno"> 9940</span>&#160;      fracdtG=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(1.0,dttrue/realdt); <span class="comment">// expect fraction of G that can be handled is similar to what sub-cycle requires for stable explicit stepping</span></div>
<div class="line"><a name="l09941"></a><span class="lineno"> 9941</span>&#160;</div>
<div class="line"><a name="l09942"></a><span class="lineno"> 9942</span>&#160;      </div>
<div class="line"><a name="l09943"></a><span class="lineno"> 9943</span>&#160;      <span class="keywordflow">if</span>(showmessagesheavy&amp;&amp;debugfail&gt;=2){</div>
<div class="line"><a name="l09944"></a><span class="lineno"> 9944</span>&#160;        dualfprintf(fail_file,<span class="stringliteral">&quot;DoingSUBCYCLE: itersub=%d : dtsub=%g dtsubuse=%g dtdiff=%g dttrue=%g dtcum=%g realdt=%g fracdtG=%g ijk=%d %d %d\n&quot;</span>,itersub,dtsub,dtsubuse,dtdiff,dttrue,dtcum,realdt,fracdtG,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k);</div>
<div class="line"><a name="l09945"></a><span class="lineno"> 9945</span>&#160;      }</div>
<div class="line"><a name="l09946"></a><span class="lineno"> 9946</span>&#160;      <span class="keywordflow">if</span>(debugfail&gt;=2 &amp;&amp; (1||showmessages)&amp;&amp;(1.0/fracdtG&gt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a78196418cbe072d23bb7e7e5be7c6606">MAXSUBCYCLES</a> &amp;&amp; itersub==0)){ <span class="comment">// have to use itersub==0 since already might be done with itersub==1 and then fracdtG=inf (but itersub=0 might be using bad force)</span></div>
<div class="line"><a name="l09947"></a><span class="lineno"> 9947</span>&#160;        dualfprintf(fail_file,<span class="stringliteral">&quot;DoingLOTSofsub-cycles: ijk=%d %d %d  1/fracdtG=%g\n&quot;</span>,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,1.0/fracdtG);</div>
<div class="line"><a name="l09948"></a><span class="lineno"> 9948</span>&#160;      }</div>
<div class="line"><a name="l09949"></a><span class="lineno"> 9949</span>&#160;    }<span class="comment">// end else if not explicit</span></div>
<div class="line"><a name="l09950"></a><span class="lineno"> 9950</span>&#160;      </div>
<div class="line"><a name="l09951"></a><span class="lineno"> 9951</span>&#160;</div>
<div class="line"><a name="l09952"></a><span class="lineno"> 9952</span>&#160;</div>
<div class="line"><a name="l09953"></a><span class="lineno"> 9953</span>&#160;    <span class="comment">// add to final result if starting point is full U0</span></div>
<div class="line"><a name="l09954"></a><span class="lineno"> 9954</span>&#160;    <span class="comment">// forward step integration</span></div>
<div class="line"><a name="l09955"></a><span class="lineno"> 9955</span>&#160;    <span class="comment">//    PLOOP(pliter,pl) sourcepl[pl] += Gpl[pl]*fracdtG;</span></div>
<div class="line"><a name="l09956"></a><span class="lineno"> 9956</span>&#160;    <span class="comment">// Trapezoidal Rule (midpoint method):</span></div>
<div class="line"><a name="l09957"></a><span class="lineno"> 9957</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) sourcepl[pl] += 0.5*(Gplprevious[pl]+Gpl[pl])*fracdtG;</div>
<div class="line"><a name="l09958"></a><span class="lineno"> 9958</span>&#160;</div>
<div class="line"><a name="l09959"></a><span class="lineno"> 9959</span>&#160;</div>
<div class="line"><a name="l09960"></a><span class="lineno"> 9960</span>&#160;</div>
<div class="line"><a name="l09962"></a><span class="lineno"> 9962</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l09963"></a><span class="lineno"> 9963</span>&#160;    <span class="comment">// see if done</span></div>
<div class="line"><a name="l09964"></a><span class="lineno"> 9964</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l09966"></a><span class="lineno"> 9966</span>&#160;<span class="comment"></span>    <span class="keywordflow">if</span>(whichradsourcemethod==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#abdac9826c3cf9ac8e2eb664896d00ddc">SOURCEMETHODEXPLICIT</a> || whichradsourcemethod==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a949d43d3fb82c7d2aa55662bdfbb9c24">SOURCEMETHODEXPLICITREVERSIONFROMIMPLICIT</a> || whichradsourcemethod==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aca22384dd0085c835b968fc59699182f">SOURCEMETHODEXPLICITCHECKSFROMIMPLICIT</a>){</div>
<div class="line"><a name="l09967"></a><span class="lineno"> 9967</span>&#160;      <span class="keywordflow">if</span>(showmessagesheavy &amp;&amp; debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;explicit done\n&quot;</span>);</div>
<div class="line"><a name="l09968"></a><span class="lineno"> 9968</span>&#160;      <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l09969"></a><span class="lineno"> 9969</span>&#160;    }</div>
<div class="line"><a name="l09970"></a><span class="lineno"> 9970</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(whichradsourcemethod==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ada88bbc566d5599a97c21ab9adfd0e2c">SOURCEMETHODEXPLICITSUBCYCLE</a> || whichradsourcemethod==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#af1f9940068a692ba76bb69e27206b729">SOURCEMETHODEXPLICITSUBCYCLEREVERSIONFROMIMPLICIT</a> || whichradsourcemethod==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aaf1fb98748cca01322e21e510b5fe11a">SOURCEMETHODEXPLICITSUBCYCLECHECKSFROMIMPLICIT</a>){</div>
<div class="line"><a name="l09971"></a><span class="lineno"> 9971</span>&#160;      <span class="keywordflow">if</span>(dtcum&gt;=realdt){</div>
<div class="line"><a name="l09972"></a><span class="lineno"> 9972</span>&#160;        <span class="comment">// then done</span></div>
<div class="line"><a name="l09973"></a><span class="lineno"> 9973</span>&#160;        <span class="keywordflow">if</span>(showmessagesheavy &amp;&amp; debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;explicit sub-cycle done\n&quot;</span>);</div>
<div class="line"><a name="l09974"></a><span class="lineno"> 9974</span>&#160;        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l09975"></a><span class="lineno"> 9975</span>&#160;      }</div>
<div class="line"><a name="l09976"></a><span class="lineno"> 9976</span>&#160;      <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l09977"></a><span class="lineno"> 9977</span>&#160;        <span class="comment">// then keep sub-cycling _or_ getting balance of U and G</span></div>
<div class="line"><a name="l09978"></a><span class="lineno"> 9978</span>&#160;      }</div>
<div class="line"><a name="l09979"></a><span class="lineno"> 9979</span>&#160;    }</div>
<div class="line"><a name="l09980"></a><span class="lineno"> 9980</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l09981"></a><span class="lineno"> 9981</span>&#160;      <span class="keywordflow">if</span>(fracdtG!=1.0){</div>
<div class="line"><a name="l09982"></a><span class="lineno"> 9982</span>&#160;        <span class="comment">// if here, then must be doing implicit checks, so return that should just do implicit instead of sub-cycling.</span></div>
<div class="line"><a name="l09983"></a><span class="lineno"> 9983</span>&#160;        <span class="keywordflow">if</span>(showmessagesheavy &amp;&amp; debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;explicit sub-cycle can&#39;t be done.\n&quot;</span>);</div>
<div class="line"><a name="l09984"></a><span class="lineno"> 9984</span>&#160;        <span class="keywordflow">return</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ac38828263c28e7d566ff97bb7cbd1ccc">EXPLICITFAILED</a>);</div>
<div class="line"><a name="l09985"></a><span class="lineno"> 9985</span>&#160;      }</div>
<div class="line"><a name="l09986"></a><span class="lineno"> 9986</span>&#160;      <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l09987"></a><span class="lineno"> 9987</span>&#160;        <span class="comment">// then implicit testing, and had to do step, but only 1 step, so consider success.</span></div>
<div class="line"><a name="l09988"></a><span class="lineno"> 9988</span>&#160;        <span class="comment">// still need to fill dUcomp[] below</span></div>
<div class="line"><a name="l09989"></a><span class="lineno"> 9989</span>&#160;        <span class="keywordflow">if</span>(showmessagesheavy &amp;&amp; debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;explicit success, just one step.\n&quot;</span>);</div>
<div class="line"><a name="l09990"></a><span class="lineno"> 9990</span>&#160;        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l09991"></a><span class="lineno"> 9991</span>&#160;      }</div>
<div class="line"><a name="l09992"></a><span class="lineno"> 9992</span>&#160;    }</div>
<div class="line"><a name="l09993"></a><span class="lineno"> 9993</span>&#160;</div>
<div class="line"><a name="l09995"></a><span class="lineno"> 9995</span>&#160;    <span class="comment">// If not done, get prnew from Unew for next step</span></div>
<div class="line"><a name="l09997"></a><span class="lineno"> 9997</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l09998"></a><span class="lineno"> 9998</span>&#160;    <span class="comment">// get new Unew0</span></div>
<div class="line"><a name="l09999"></a><span class="lineno"> 9999</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> xint=(dtcum/realdt);</div>
<div class="line"><a name="l10000"></a><span class="lineno">10000</span>&#160;    <span class="comment">// NOTE: Below interpolates from Unew0 could use up to final, but not consistent with explicit stepping and leads to erroneous 0-force results.</span></div>
<div class="line"><a name="l10001"></a><span class="lineno">10001</span>&#160;    <span class="comment">//    FTYPE fakefracdtuu0=fracdtuu0*(1.0-xint) + 1.0*(xint);</span></div>
<div class="line"><a name="l10002"></a><span class="lineno">10002</span>&#160;    <span class="comment">// NOTE: Below interpolates from step&#39;s true starting Unew0 to step&#39;s final Unew0 assuming linear interpolation between -- *most* consistent with explicit stepping!!</span></div>
<div class="line"><a name="l10003"></a><span class="lineno">10003</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fakefracdtuu0=1.0*(xint);</div>
<div class="line"><a name="l10004"></a><span class="lineno">10004</span>&#160;    <span class="comment">// NOTE: Below sticks to the Unew0 that could use, but not consistent with explicit stepping and leads to erroneous 0-force results.</span></div>
<div class="line"><a name="l10005"></a><span class="lineno">10005</span>&#160;    <span class="comment">//    FTYPE fakefracdtuu0=fracdtuu0;</span></div>
<div class="line"><a name="l10006"></a><span class="lineno">10006</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> tempdt= fakefracdtuu0*<a class="code" href="../../d8/d5b/defs_8general_8h.html#a56db625f31229c5e8b208ff27d464931">dt</a>; <span class="comment">// uses dt here, because below UFSET() computes &quot;realdt&quot; using CUf internally</span></div>
<div class="line"><a name="l10007"></a><span class="lineno">10007</span>&#160;    <span class="comment">//    FTYPE dUnongeomall[MAXTIMEORDER]={0.0};</span></div>
<div class="line"><a name="l10008"></a><span class="lineno">10008</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) Unew0[pl]=UFSET(CUf,tempdt,Uiin[pl],Ufin[pl],dUother[pl],0.0,dUnongeomall);</div>
<div class="line"><a name="l10009"></a><span class="lineno">10009</span>&#160;    </div>
<div class="line"><a name="l10010"></a><span class="lineno">10010</span>&#160;</div>
<div class="line"><a name="l10011"></a><span class="lineno">10011</span>&#160;    <span class="comment">// get new Unew using 1) current Unew0 (so Unew updates a bit towards final Unew0 as if fracdtuu0=1) and 2) cumulative 4-force so far</span></div>
<div class="line"><a name="l10012"></a><span class="lineno">10012</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) Unew[pl] = Unew0[pl] + sourcepl[pl] * realdt;</div>
<div class="line"><a name="l10013"></a><span class="lineno">10013</span>&#160;</div>
<div class="line"><a name="l10014"></a><span class="lineno">10014</span>&#160;    <span class="comment">// get prnew(Unew)</span></div>
<div class="line"><a name="l10015"></a><span class="lineno">10015</span>&#160;    newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a073783ba864c07681c8999a67162202b">nstroke</a>=newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a83280998e47831044a7e35299495a9bb">lntries</a>=0;</div>
<div class="line"><a name="l10016"></a><span class="lineno">10016</span>&#160;    <span class="keywordtype">int</span> doradonly=0;</div>
<div class="line"><a name="l10017"></a><span class="lineno">10017</span>&#160;    eomtypelocal=*eomtype; <span class="comment">// re-default</span></div>
<div class="line"><a name="l10018"></a><span class="lineno">10018</span>&#160;    <span class="keywordtype">int</span> whichcap=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a4b6c6060c025e15f1d92aae3dcb9365b" title="which cap type to place in rad inversion">CAPTYPEBASIC</a>;</div>
<div class="line"><a name="l10019"></a><span class="lineno">10019</span>&#160;    <span class="keywordtype">int</span> radinvmod=0;</div>
<div class="line"><a name="l10020"></a><span class="lineno">10020</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dissmeasure=-1.0; <span class="comment">// assume ok to try energy</span></div>
<div class="line"><a name="l10021"></a><span class="lineno">10021</span>&#160;    <span class="keywordtype">int</span> checkoninversiongas=<a class="code" href="../../da/d3e/definit_8h.html#a5dc18e6d15e4420586d45d912fccebac" title="whether to check on inversion and report problem Also, use diag_fixup() to account for changes in U w...">CHECKONINVERSION</a>;</div>
<div class="line"><a name="l10022"></a><span class="lineno">10022</span>&#160;    <span class="keywordtype">int</span> checkoninversionrad=<a class="code" href="../../da/d3e/definit_8h.html#a70e4418eb8c6479afc202024b46ad581">CHECKONINVERSIONRAD</a>;</div>
<div class="line"><a name="l10023"></a><span class="lineno">10023</span>&#160;    <span class="keywordtype">int</span> failutoprim=Utoprimgen_failwrapper(doradonly,&amp;radinvmod,showmessages,checkoninversiongas,checkoninversionrad, allowlocalfailurefixandnoreport, finalstep, &amp;eomtypelocal, whichcap, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7d1dc231c422450f87fdb3e71b4a7aff" title="defines how Utoprimgen is used">EVOLVEUTOPRIM</a>, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab2be21bd5eff40ca89c20eeecbeab5e0">UNOTHING</a>, Unew, q, ptrgeom, dissmeasure, prnew, &amp;newtonstats);</div>
<div class="line"><a name="l10024"></a><span class="lineno">10024</span>&#160;    <span class="comment">// push through inversion failure if just radiation inversion failure since have local fixups that can be ok or even recovered from.  Bad to just stop if doing reversion from implicit.</span></div>
<div class="line"><a name="l10025"></a><span class="lineno">10025</span>&#160;    <span class="keywordflow">if</span>(pushthroughraderror==0 &amp;&amp; failutoprim==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a3dc38d50c77a49ac41a760b684ad7aab">UTOPRIMGENWRAPPERRETURNFAILRAD</a> || pushthroughraderror==1 &amp;&amp; failutoprim==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a37d8e953a25b51ce606f181bbc18d562">UTOPRIMGENWRAPPERRETURNFAILMHD</a>){</div>
<div class="line"><a name="l10026"></a><span class="lineno">10026</span>&#160;      <span class="keywordflow">if</span>(showmessages &amp;&amp; debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;BAD: Utoprimgen_wrapper() failed during explicit sub-stepping.  So sub-cycling failed.\n&quot;</span>);</div>
<div class="line"><a name="l10027"></a><span class="lineno">10027</span>&#160;      <span class="keywordflow">return</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ac38828263c28e7d566ff97bb7cbd1ccc">EXPLICITFAILED</a>);</div>
<div class="line"><a name="l10028"></a><span class="lineno">10028</span>&#160;    }</div>
<div class="line"><a name="l10029"></a><span class="lineno">10029</span>&#160;</div>
<div class="line"><a name="l10030"></a><span class="lineno">10030</span>&#160;</div>
<div class="line"><a name="l10031"></a><span class="lineno">10031</span>&#160;    <span class="comment">// DEBUG:</span></div>
<div class="line"><a name="l10032"></a><span class="lineno">10032</span>&#160;    <span class="keywordflow">if</span>(showmessagesheavy &amp;&amp;debugfail&gt;=2) <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) dualfprintf(fail_file,<span class="stringliteral">&quot;POSTEXSTEP: pl=%2d Unew0=%21.15g Unew=%21.15g sourcepl*realdt=%21.15g fakefracdtuu0=%g\n&quot;</span>,pl,Unew0[pl],Unew[pl],sourcepl[pl]*realdt,fakefracdtuu0);</div>
<div class="line"><a name="l10033"></a><span class="lineno">10033</span>&#160;</div>
<div class="line"><a name="l10034"></a><span class="lineno">10034</span>&#160;</div>
<div class="line"><a name="l10035"></a><span class="lineno">10035</span>&#160;    <span class="comment">// step      </span></div>
<div class="line"><a name="l10036"></a><span class="lineno">10036</span>&#160;    dtcum += realdt*fracdtG; <span class="comment">// cumulative true time</span></div>
<div class="line"><a name="l10037"></a><span class="lineno">10037</span>&#160;    itersub++;</div>
<div class="line"><a name="l10038"></a><span class="lineno">10038</span>&#160;</div>
<div class="line"><a name="l10039"></a><span class="lineno">10039</span>&#160;</div>
<div class="line"><a name="l10040"></a><span class="lineno">10040</span>&#160;  }<span class="comment">// done looping</span></div>
<div class="line"><a name="l10041"></a><span class="lineno">10041</span>&#160;</div>
<div class="line"><a name="l10042"></a><span class="lineno">10042</span>&#160;</div>
<div class="line"><a name="l10044"></a><span class="lineno">10044</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l10045"></a><span class="lineno">10045</span>&#160;  <span class="comment">// apply 4-force as update in dUcomp[][]</span></div>
<div class="line"><a name="l10046"></a><span class="lineno">10046</span>&#160;  <span class="comment">// only changed this quantity, none of other among function arguments</span></div>
<div class="line"><a name="l10047"></a><span class="lineno">10047</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l10049"></a><span class="lineno">10049</span>&#160;<span class="comment"></span>  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) dUcomp[whichsc][pl] += sourcepl[pl];</div>
<div class="line"><a name="l10050"></a><span class="lineno">10050</span>&#160;</div>
<div class="line"><a name="l10051"></a><span class="lineno">10051</span>&#160;  <span class="comment">// save better guess for later inversion from this inversion</span></div>
<div class="line"><a name="l10052"></a><span class="lineno">10052</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) pb[pl]=prnew[pl];</div>
<div class="line"><a name="l10053"></a><span class="lineno">10053</span>&#160;</div>
<div class="line"><a name="l10054"></a><span class="lineno">10054</span>&#160;  <span class="comment">// save eomtype settled on</span></div>
<div class="line"><a name="l10055"></a><span class="lineno">10055</span>&#160;  *eomtype=eomtypelocal;</div>
<div class="line"><a name="l10056"></a><span class="lineno">10056</span>&#160;</div>
<div class="line"><a name="l10057"></a><span class="lineno">10057</span>&#160;</div>
<div class="line"><a name="l10058"></a><span class="lineno">10058</span>&#160;  <span class="keywordflow">return</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a0782a90dc1ab7f4c99bd38970280e6d4">EXPLICITNOTFAILED</a>);</div>
<div class="line"><a name="l10059"></a><span class="lineno">10059</span>&#160;  </div>
<div class="line"><a name="l10060"></a><span class="lineno">10060</span>&#160;}</div>
<div class="line"><a name="l10061"></a><span class="lineno">10061</span>&#160;</div>
<div class="line"><a name="l10062"></a><span class="lineno">10062</span>&#160;</div>
<div class="line"><a name="l10063"></a><span class="lineno">10063</span>&#160;</div>
<div class="line"><a name="l10064"></a><span class="lineno">10064</span>&#160;</div>
<div class="line"><a name="l10065"></a><span class="lineno">10065</span>&#160;</div>
<div class="line"><a name="l10066"></a><span class="lineno">10066</span>&#160;</div>
<div class="line"><a name="l10067"></a><span class="lineno">10067</span>&#160;</div>
<div class="line"><a name="l10068"></a><span class="lineno">10068</span>&#160;</div>
<div class="line"><a name="l10073"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa8c5c0d5de580899948f9f22e10aff23">10073</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa8c5c0d5de580899948f9f22e10aff23" title="General radiation source term calculation (EXTERNALLY called) NOTE: source_explicit() takes as first ...">koral_source_rad</a>(<span class="keywordtype">int</span> whichradsourcemethod, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *piin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pb, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pf, <span class="keywordtype">int</span> *didreturnpf, <span class="keywordtype">int</span> *eomtype, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Uiin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ufin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUf, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUimp, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *q, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dissmeasure, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *dUother, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*dUcomp)[NPR])</div>
<div class="line"><a name="l10074"></a><span class="lineno">10074</span>&#160;{</div>
<div class="line"><a name="l10075"></a><span class="lineno">10075</span>&#160;  <span class="keywordtype">int</span> pliter,pl;</div>
<div class="line"><a name="l10076"></a><span class="lineno">10076</span>&#160;  <span class="keywordtype">int</span> showmessages=0; <span class="comment">// 0 ok if not debugging and think everything works.</span></div>
<div class="line"><a name="l10077"></a><span class="lineno">10077</span>&#160;  <span class="keywordtype">int</span> showmessagesheavy=0;</div>
<div class="line"><a name="l10078"></a><span class="lineno">10078</span>&#160;</div>
<div class="line"><a name="l10079"></a><span class="lineno">10079</span>&#160;  <span class="comment">//  if(1||nstep&gt;=800){</span></div>
<div class="line"><a name="l10080"></a><span class="lineno">10080</span>&#160;  <span class="comment">//    showmessages=showmessagesheavy=1;</span></div>
<div class="line"><a name="l10081"></a><span class="lineno">10081</span>&#160;  <span class="comment">//  }</span></div>
<div class="line"><a name="l10082"></a><span class="lineno">10082</span>&#160;</div>
<div class="line"><a name="l10083"></a><span class="lineno">10083</span>&#160;</div>
<div class="line"><a name="l10084"></a><span class="lineno">10084</span>&#160;  <span class="comment">// make code use &quot;orig&quot; values that below can modify, so return preserves no changes to these no matter what internal functions do.</span></div>
<div class="line"><a name="l10085"></a><span class="lineno">10085</span>&#160;  <span class="comment">// save pb, Uiin, Ufin, and q to avoid being modified upon return</span></div>
<div class="line"><a name="l10086"></a><span class="lineno">10086</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> pborig[NPR],pforig[NPR],piinorig[NPR],Uiinorig[NPR],Ufinorig[NPR];</div>
<div class="line"><a name="l10087"></a><span class="lineno">10087</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> qorigmem;</div>
<div class="line"><a name="l10088"></a><span class="lineno">10088</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *qorig=&amp;qorigmem;</div>
<div class="line"><a name="l10089"></a><span class="lineno">10089</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l10090"></a><span class="lineno">10090</span>&#160;    pborig[pl]=pb[pl];</div>
<div class="line"><a name="l10091"></a><span class="lineno">10091</span>&#160;    pforig[pl]=pf[pl];</div>
<div class="line"><a name="l10092"></a><span class="lineno">10092</span>&#160;    piinorig[pl]=piin[pl];</div>
<div class="line"><a name="l10093"></a><span class="lineno">10093</span>&#160;    Uiinorig[pl]=Uiin[pl];</div>
<div class="line"><a name="l10094"></a><span class="lineno">10094</span>&#160;    Ufinorig[pl]=Ufin[pl];</div>
<div class="line"><a name="l10095"></a><span class="lineno">10095</span>&#160;  }</div>
<div class="line"><a name="l10096"></a><span class="lineno">10096</span>&#160;  *qorig=*q;</div>
<div class="line"><a name="l10097"></a><span class="lineno">10097</span>&#160;</div>
<div class="line"><a name="l10098"></a><span class="lineno">10098</span>&#160;</div>
<div class="line"><a name="l10100"></a><span class="lineno">10100</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l10101"></a><span class="lineno">10101</span>&#160;  <span class="comment">// Check energy density to see if even any radiation or will be any radiation</span></div>
<div class="line"><a name="l10102"></a><span class="lineno">10102</span>&#160;  <span class="comment">// Note, can&#39;t just check size of Erf, because in non-LTE, B can be large even if E is not.</span></div>
<div class="line"><a name="l10103"></a><span class="lineno">10103</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l10105"></a><span class="lineno">10105</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l10106"></a><span class="lineno">10106</span>&#160;</div>
<div class="line"><a name="l10107"></a><span class="lineno">10107</span>&#160;</div>
<div class="line"><a name="l10109"></a><span class="lineno">10109</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l10110"></a><span class="lineno">10110</span>&#160;  <span class="comment">// EXPLICIT TYPES</span></div>
<div class="line"><a name="l10111"></a><span class="lineno">10111</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l10113"></a><span class="lineno">10113</span>&#160;<span class="comment"></span>  <span class="keywordflow">if</span>(whichradsourcemethod==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#abdac9826c3cf9ac8e2eb664896d00ddc">SOURCEMETHODEXPLICIT</a> || whichradsourcemethod==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ada88bbc566d5599a97c21ab9adfd0e2c">SOURCEMETHODEXPLICITSUBCYCLE</a> || whichradsourcemethod==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a949d43d3fb82c7d2aa55662bdfbb9c24">SOURCEMETHODEXPLICITREVERSIONFROMIMPLICIT</a> || whichradsourcemethod==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#af1f9940068a692ba76bb69e27206b729">SOURCEMETHODEXPLICITSUBCYCLEREVERSIONFROMIMPLICIT</a> || whichradsourcemethod==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aca22384dd0085c835b968fc59699182f">SOURCEMETHODEXPLICITCHECKSFROMIMPLICIT</a> || whichradsourcemethod==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aaf1fb98748cca01322e21e510b5fe11a">SOURCEMETHODEXPLICITSUBCYCLECHECKSFROMIMPLICIT</a>){</div>
<div class="line"><a name="l10114"></a><span class="lineno">10114</span>&#160;</div>
<div class="line"><a name="l10115"></a><span class="lineno">10115</span>&#160;</div>
<div class="line"><a name="l10116"></a><span class="lineno">10116</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a10228b0cb639e1d94eded72900312334">TIMETYPE</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ad898cf724e1b1416d754ec94320d9770">TIMEIMPLICIT</a>){</div>
<div class="line"><a name="l10117"></a><span class="lineno">10117</span>&#160;      dualfprintf(fail_file,<span class="stringliteral">&quot;Makes no sense to do explicit source (with or without subcycling) and IMEX stepping\n&quot;</span>);</div>
<div class="line"><a name="l10118"></a><span class="lineno">10118</span>&#160;      myexit(937453984);</div>
<div class="line"><a name="l10119"></a><span class="lineno">10119</span>&#160;    }</div>
<div class="line"><a name="l10120"></a><span class="lineno">10120</span>&#160;    </div>
<div class="line"><a name="l10121"></a><span class="lineno">10121</span>&#160;</div>
<div class="line"><a name="l10122"></a><span class="lineno">10122</span>&#160;</div>
<div class="line"><a name="l10123"></a><span class="lineno">10123</span>&#160;    <span class="keywordtype">int</span> methoddtsub;</div>
<div class="line"><a name="l10124"></a><span class="lineno">10124</span>&#160;    <span class="comment">// SPACETIMESUBSPLITMHDRAD doesn&#39;t work -- generates tons of noise in prad1 with COURRADEXPLICIT=0.2, and was asymmetric in x.</span></div>
<div class="line"><a name="l10125"></a><span class="lineno">10125</span>&#160;    methoddtsub=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a96e9f8c7659cf4e2775a3e65536611fb" title="0 : tau suppression 1 : space-time merged 2 : all space merged but separate from time 3 : full split ...">TAUSUPPRESS</a>; <span class="comment">// forced -- only method that is efficient and effective and noise free at moderate optical depths.</span></div>
<div class="line"><a name="l10126"></a><span class="lineno">10126</span>&#160;    <span class="comment">//    methoddtsub=SPACETIMESUBSPLITNONE;</span></div>
<div class="line"><a name="l10127"></a><span class="lineno">10127</span>&#160;    <span class="comment">//    methoddtsub=SPACETIMESUBSPLITTIME;</span></div>
<div class="line"><a name="l10128"></a><span class="lineno">10128</span>&#160;</div>
<div class="line"><a name="l10129"></a><span class="lineno">10129</span>&#160;</div>
<div class="line"><a name="l10130"></a><span class="lineno">10130</span>&#160;    <span class="keywordtype">int</span> whichsc = <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab130f34dd5996718289efe08bc68b518">RADSOURCE</a>;</div>
<div class="line"><a name="l10131"></a><span class="lineno">10131</span>&#160;    <span class="comment">// try explicit (with or without sub-cycling)</span></div>
<div class="line"><a name="l10132"></a><span class="lineno">10132</span>&#160;    <span class="comment">//    dualfprintf(fail_file,&quot;Trying explicit: whichradsourcemethod=%d\n&quot;,whichradsourcemethod);</span></div>
<div class="line"><a name="l10133"></a><span class="lineno">10133</span>&#160;    <span class="keywordtype">int</span> failexplicit=source_explicit(whichsc, whichradsourcemethod,methoddtsub,eomtype,koral_source_dtsub_rad_calc,pborig, piinorig, Uiinorig, Ufinorig, CUf, CUimp, ptrgeom, qorig, dUother, dUcomp);</div>
<div class="line"><a name="l10134"></a><span class="lineno">10134</span>&#160;    <span class="keywordflow">if</span>(failexplicit==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ac38828263c28e7d566ff97bb7cbd1ccc">EXPLICITFAILED</a>){</div>
<div class="line"><a name="l10135"></a><span class="lineno">10135</span>&#160;      <span class="keywordflow">if</span>(whichradsourcemethod==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#abdac9826c3cf9ac8e2eb664896d00ddc">SOURCEMETHODEXPLICIT</a> || whichradsourcemethod==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ada88bbc566d5599a97c21ab9adfd0e2c">SOURCEMETHODEXPLICITSUBCYCLE</a> || whichradsourcemethod==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a949d43d3fb82c7d2aa55662bdfbb9c24">SOURCEMETHODEXPLICITREVERSIONFROMIMPLICIT</a> || whichradsourcemethod==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#af1f9940068a692ba76bb69e27206b729">SOURCEMETHODEXPLICITSUBCYCLEREVERSIONFROMIMPLICIT</a>){</div>
<div class="line"><a name="l10136"></a><span class="lineno">10136</span>&#160;        <span class="comment">// still do explicit anyways, since best can do with the choice of method -- will fail possibly to work if stiff regime, but ok in non-stiff.</span></div>
<div class="line"><a name="l10137"></a><span class="lineno">10137</span>&#160;        <span class="comment">// assume nothing else to do, BUT DEFINITELY report this.</span></div>
<div class="line"><a name="l10138"></a><span class="lineno">10138</span>&#160;        <span class="keywordflow">if</span>(debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;BAD: explicit failed: ijk=%d %d %d : whichradsourcemethod=%d\n&quot;</span>,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,whichradsourcemethod);</div>
<div class="line"><a name="l10139"></a><span class="lineno">10139</span>&#160;        *didreturnpf=0;</div>
<div class="line"><a name="l10140"></a><span class="lineno">10140</span>&#160;        GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>)=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#af579ffe7cc5645924d03173aa13af579">UTOPRIMRADFAILCASE3A</a>; <span class="comment">// must set as failure in case can fixup.</span></div>
<div class="line"><a name="l10141"></a><span class="lineno">10141</span>&#160;        <span class="keywordflow">return</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afa05900437da5eb66c5a97c28e4283d8">EXPLICITFAILEDBUTWENTTHROUGH</a>);</div>
<div class="line"><a name="l10142"></a><span class="lineno">10142</span>&#160;      }</div>
<div class="line"><a name="l10143"></a><span class="lineno">10143</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span>(whichradsourcemethod==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aca22384dd0085c835b968fc59699182f">SOURCEMETHODEXPLICITCHECKSFROMIMPLICIT</a> || whichradsourcemethod==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aaf1fb98748cca01322e21e510b5fe11a">SOURCEMETHODEXPLICITSUBCYCLECHECKSFROMIMPLICIT</a>){</div>
<div class="line"><a name="l10144"></a><span class="lineno">10144</span>&#160;        <span class="comment">// tells that explicit didn&#39;t work for implicit checks</span></div>
<div class="line"><a name="l10145"></a><span class="lineno">10145</span>&#160;        <span class="keywordflow">if</span>(showmessages &amp;&amp; debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;explicit failed for implicit check. ijk=%d %d %d\n&quot;</span>,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k);</div>
<div class="line"><a name="l10146"></a><span class="lineno">10146</span>&#160;        *didreturnpf=0;</div>
<div class="line"><a name="l10147"></a><span class="lineno">10147</span>&#160;        <span class="keywordflow">return</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ac38828263c28e7d566ff97bb7cbd1ccc">EXPLICITFAILED</a>);</div>
<div class="line"><a name="l10148"></a><span class="lineno">10148</span>&#160;      }</div>
<div class="line"><a name="l10149"></a><span class="lineno">10149</span>&#160;      <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l10150"></a><span class="lineno">10150</span>&#160;        <span class="comment">// tells that explicit didn&#39;t work</span></div>
<div class="line"><a name="l10151"></a><span class="lineno">10151</span>&#160;        <span class="keywordflow">if</span>(showmessages &amp;&amp; debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;explicit failed. ijk=%d %d %d\n&quot;</span>,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k);</div>
<div class="line"><a name="l10152"></a><span class="lineno">10152</span>&#160;        GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>)=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0ef4f7b1581d3a52ce8d9f09a1febd6b">UTOPRIMRADFAILCASE3B</a>; <span class="comment">// must set as failure in case can fixup.</span></div>
<div class="line"><a name="l10153"></a><span class="lineno">10153</span>&#160;        *didreturnpf=0;</div>
<div class="line"><a name="l10154"></a><span class="lineno">10154</span>&#160;        <span class="keywordflow">return</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ac38828263c28e7d566ff97bb7cbd1ccc">EXPLICITFAILED</a>);</div>
<div class="line"><a name="l10155"></a><span class="lineno">10155</span>&#160;      }</div>
<div class="line"><a name="l10156"></a><span class="lineno">10156</span>&#160;    }</div>
<div class="line"><a name="l10157"></a><span class="lineno">10157</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(failexplicit==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a6bc50dd87820f78f39f35a72c34ed74e">EXPLICITNOTNECESSARY</a>){</div>
<div class="line"><a name="l10158"></a><span class="lineno">10158</span>&#160;      <span class="comment">// then don&#39;t need any source term</span></div>
<div class="line"><a name="l10159"></a><span class="lineno">10159</span>&#160;      <span class="keywordflow">if</span>(debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;ODD: explicit found not necessary while implicit failed: ijk=%d %d %d\n&quot;</span>,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k);</div>
<div class="line"><a name="l10160"></a><span class="lineno">10160</span>&#160;      *didreturnpf=0;</div>
<div class="line"><a name="l10161"></a><span class="lineno">10161</span>&#160;      <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l10162"></a><span class="lineno">10162</span>&#160;    }</div>
<div class="line"><a name="l10163"></a><span class="lineno">10163</span>&#160;</div>
<div class="line"><a name="l10164"></a><span class="lineno">10164</span>&#160;    <span class="comment">//else explicit succeeded, so just return</span></div>
<div class="line"><a name="l10165"></a><span class="lineno">10165</span>&#160;    <span class="keywordflow">if</span>(whichradsourcemethod==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ada88bbc566d5599a97c21ab9adfd0e2c">SOURCEMETHODEXPLICITSUBCYCLE</a> || whichradsourcemethod==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#af1f9940068a692ba76bb69e27206b729">SOURCEMETHODEXPLICITSUBCYCLEREVERSIONFROMIMPLICIT</a>){</div>
<div class="line"><a name="l10166"></a><span class="lineno">10166</span>&#160;      <span class="comment">// if sub-cycled, then have better pf than pb assumed saved in pborig[].</span></div>
<div class="line"><a name="l10167"></a><span class="lineno">10167</span>&#160;      <span class="keywordflow">if</span>(showmessagesheavy &amp;&amp; debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;explicit didn&#39;t fail. ijk=%d %d %d\n&quot;</span>,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k);</div>
<div class="line"><a name="l10168"></a><span class="lineno">10168</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) pf[pl]=pborig[pl];</div>
<div class="line"><a name="l10169"></a><span class="lineno">10169</span>&#160;      *didreturnpf=1;</div>
<div class="line"><a name="l10170"></a><span class="lineno">10170</span>&#160;    }</div>
<div class="line"><a name="l10171"></a><span class="lineno">10171</span>&#160;    <span class="keywordflow">return</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a0782a90dc1ab7f4c99bd38970280e6d4">EXPLICITNOTFAILED</a>);</div>
<div class="line"><a name="l10172"></a><span class="lineno">10172</span>&#160;  }</div>
<div class="line"><a name="l10174"></a><span class="lineno">10174</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l10175"></a><span class="lineno">10175</span>&#160;  <span class="comment">// IMPLICIT TYPES (implicit function should handle pflag (rad or gas) error issues), but still leave explicit as handling error mode here</span></div>
<div class="line"><a name="l10176"></a><span class="lineno">10176</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l10178"></a><span class="lineno">10178</span>&#160;<span class="comment"></span>  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(whichradsourcemethod==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a9a88f6a38ab5e7428dd23769b2f87518">SOURCEMETHODIMPLICIT</a>){</div>
<div class="line"><a name="l10179"></a><span class="lineno">10179</span>&#160;</div>
<div class="line"><a name="l10180"></a><span class="lineno">10180</span>&#160;</div>
<div class="line"><a name="l10181"></a><span class="lineno">10181</span>&#160;    <span class="comment">// If doing implicit, first check if using TIMEIMPLICIT.  If so, then check if CUf CUnew implies no contribution to compute.  If so, return without computation</span></div>
<div class="line"><a name="l10182"></a><span class="lineno">10182</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a10228b0cb639e1d94eded72900312334">TIMETYPE</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ad898cf724e1b1416d754ec94320d9770">TIMEIMPLICIT</a>){</div>
<div class="line"><a name="l10183"></a><span class="lineno">10183</span>&#160;      <span class="keywordtype">int</span> doradimplicit = (CUimp[0]!=0.0); <span class="comment">// || CUnewimp[0]!=0.0); // assuming M^i only created and added if added to Uf and U^{n+1} at same step.</span></div>
<div class="line"><a name="l10184"></a><span class="lineno">10184</span>&#160;      <span class="keywordflow">if</span>(doradimplicit){</div>
<div class="line"><a name="l10185"></a><span class="lineno">10185</span>&#160;        <span class="comment">// then continue and do implicit solution and compute_dt() will use CUimp[]</span></div>
<div class="line"><a name="l10186"></a><span class="lineno">10186</span>&#160;      }</div>
<div class="line"><a name="l10187"></a><span class="lineno">10187</span>&#160;      <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l10188"></a><span class="lineno">10188</span>&#160;        <span class="comment">// then return as if successful, but don&#39;t assume inversion already done for pf (since not)</span></div>
<div class="line"><a name="l10189"></a><span class="lineno">10189</span>&#160;        <span class="comment">// NOTE: We don&#39;t return explicit version of answer either -- just simply zero.  Since dUcomp already set as zero when initialized, nothing to do. (as if never was doing source term)</span></div>
<div class="line"><a name="l10190"></a><span class="lineno">10190</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) pf[pl]=pborig[pl];</div>
<div class="line"><a name="l10191"></a><span class="lineno">10191</span>&#160;        *didreturnpf=0;</div>
<div class="line"><a name="l10192"></a><span class="lineno">10192</span>&#160;        <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l10193"></a><span class="lineno">10193</span>&#160;      }</div>
<div class="line"><a name="l10194"></a><span class="lineno">10194</span>&#160;      <span class="comment">// then do implicit step</span></div>
<div class="line"><a name="l10195"></a><span class="lineno">10195</span>&#160;    }</div>
<div class="line"><a name="l10196"></a><span class="lineno">10196</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l10197"></a><span class="lineno">10197</span>&#160;      <span class="comment">// else just follow flux behavior</span></div>
<div class="line"><a name="l10198"></a><span class="lineno">10198</span>&#160;    }</div>
<div class="line"><a name="l10199"></a><span class="lineno">10199</span>&#160;</div>
<div class="line"><a name="l10200"></a><span class="lineno">10200</span>&#160; </div>
<div class="line"><a name="l10201"></a><span class="lineno">10201</span>&#160;    <span class="keywordtype">int</span> failimplicit=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a675bb3f12a77c62cf2540bc42c4867f8" title="wrapper for mode method">koral_source_rad_implicit</a>(eomtype, pborig, pforig, piinorig, Uiinorig, Ufinorig, CUf, CUimp, ptrgeom, qorig, dissmeasure, dUother, dUcomp);</div>
<div class="line"><a name="l10202"></a><span class="lineno">10202</span>&#160; </div>
<div class="line"><a name="l10203"></a><span class="lineno">10203</span>&#160;    <span class="keywordflow">if</span>(failimplicit&gt;0){</div>
<div class="line"><a name="l10204"></a><span class="lineno">10204</span>&#160;      <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a24229740b34d000bdadf74e1acf22c6e" title="whether to revert to sub-cycle explicit if implicit fails. Only alternative is die.">IMPLICITREVERTEXPLICIT</a>){ <span class="comment">// single level recusive call (to avoid duplicate confusing code)</span></div>
<div class="line"><a name="l10205"></a><span class="lineno">10205</span>&#160;        <span class="comment">// assume if revert from implicit, then need to do sub-cycles</span></div>
<div class="line"><a name="l10206"></a><span class="lineno">10206</span>&#160;        <span class="keywordtype">int</span> failexplicit=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa8c5c0d5de580899948f9f22e10aff23" title="General radiation source term calculation (EXTERNALLY called) NOTE: source_explicit() takes as first ...">koral_source_rad</a>(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#af1f9940068a692ba76bb69e27206b729">SOURCEMETHODEXPLICITSUBCYCLEREVERSIONFROMIMPLICIT</a>, piinorig, pborig, pf, didreturnpf, eomtype, Uiinorig, Ufinorig, CUf, CUimp, ptrgeom, qorig, dissmeasure, dUother, dUcomp);</div>
<div class="line"><a name="l10207"></a><span class="lineno">10207</span>&#160;        <span class="keywordflow">if</span>(failexplicit==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ac38828263c28e7d566ff97bb7cbd1ccc">EXPLICITFAILED</a>){</div>
<div class="line"><a name="l10208"></a><span class="lineno">10208</span>&#160;          <span class="comment">// nothing else to revert to, but just continue and report</span></div>
<div class="line"><a name="l10209"></a><span class="lineno">10209</span>&#160;          *didreturnpf=0;</div>
<div class="line"><a name="l10210"></a><span class="lineno">10210</span>&#160;          <span class="keywordflow">if</span>(debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;BAD: explicit failed while implicit failed: ijk=%d %d %d\n&quot;</span>,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k);</div>
<div class="line"><a name="l10211"></a><span class="lineno">10211</span>&#160;          GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>)=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aba9c5f566b4227c5e5d8faef0f62e4e6" title="locally fixed inversion problems (as possible sometimes with radiation): see phys.tools.rad.c:u2p_rad()">UTOPRIMRADFAILCASE1A</a>; <span class="comment">// must set as failure in case can fixup.</span></div>
<div class="line"><a name="l10212"></a><span class="lineno">10212</span>&#160;          <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l10213"></a><span class="lineno">10213</span>&#160;        }</div>
<div class="line"><a name="l10214"></a><span class="lineno">10214</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(failexplicit==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a6bc50dd87820f78f39f35a72c34ed74e">EXPLICITNOTNECESSARY</a>){</div>
<div class="line"><a name="l10215"></a><span class="lineno">10215</span>&#160;          <span class="comment">// then don&#39;t need any source term</span></div>
<div class="line"><a name="l10216"></a><span class="lineno">10216</span>&#160;          <span class="keywordflow">if</span>(debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;ODD: explicit found not necessary while implicit failed: ijk=%d %d %d\n&quot;</span>,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k);</div>
<div class="line"><a name="l10217"></a><span class="lineno">10217</span>&#160;          GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>)=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a9e4e88357dad17ae401b91f65e4fd3f9">UTOPRIMRADFAILCASE1B</a>; <span class="comment">// must set as failure in case can fixup.</span></div>
<div class="line"><a name="l10218"></a><span class="lineno">10218</span>&#160;          *didreturnpf=0;</div>
<div class="line"><a name="l10219"></a><span class="lineno">10219</span>&#160;          <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l10220"></a><span class="lineno">10220</span>&#160;        }</div>
<div class="line"><a name="l10221"></a><span class="lineno">10221</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(failexplicit==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afa05900437da5eb66c5a97c28e4283d8">EXPLICITFAILEDBUTWENTTHROUGH</a>){</div>
<div class="line"><a name="l10222"></a><span class="lineno">10222</span>&#160;          <span class="comment">// then had issues, but nothing else can do.</span></div>
<div class="line"><a name="l10223"></a><span class="lineno">10223</span>&#160;          <span class="keywordflow">if</span>(debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;HMM: explicit found necessary and had problems while implicit failed: ijk=%d %d %d\n&quot;</span>,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k);</div>
<div class="line"><a name="l10224"></a><span class="lineno">10224</span>&#160;          GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>)=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#af1ba8d5f13f64649f7f731147526401d">UTOPRIMRADFAILCASE2A</a>; <span class="comment">// must set as failure in case can fixup.</span></div>
<div class="line"><a name="l10225"></a><span class="lineno">10225</span>&#160;          *didreturnpf=0;</div>
<div class="line"><a name="l10226"></a><span class="lineno">10226</span>&#160;          <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l10227"></a><span class="lineno">10227</span>&#160;        }</div>
<div class="line"><a name="l10228"></a><span class="lineno">10228</span>&#160;        <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l10229"></a><span class="lineno">10229</span>&#160;          <span class="comment">// if sub-cycled, then have better pf than pb assumed saved in pborig[].</span></div>
<div class="line"><a name="l10230"></a><span class="lineno">10230</span>&#160;          <span class="keywordflow">if</span>(debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;GOOD: explicit worked while implicit failed (%d): ijk=%d %d %d\n&quot;</span>,failexplicit,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k);</div>
<div class="line"><a name="l10231"></a><span class="lineno">10231</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) pf[pl]=pborig[pl];</div>
<div class="line"><a name="l10232"></a><span class="lineno">10232</span>&#160;          *didreturnpf=1;</div>
<div class="line"><a name="l10233"></a><span class="lineno">10233</span>&#160;          <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l10234"></a><span class="lineno">10234</span>&#160;        }</div>
<div class="line"><a name="l10235"></a><span class="lineno">10235</span>&#160;      }<span class="comment">// end if reverting to explicit</span></div>
<div class="line"><a name="l10236"></a><span class="lineno">10236</span>&#160;      <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l10237"></a><span class="lineno">10237</span>&#160;        *didreturnpf=0;</div>
<div class="line"><a name="l10238"></a><span class="lineno">10238</span>&#160;        <span class="keywordflow">if</span>(debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;BAD: implicit failed and didn&#39;t choose to revert: ijknstepsteppart=%d %d %d %ld %d\n&quot;</span>,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,nstep,steppart);</div>
<div class="line"><a name="l10239"></a><span class="lineno">10239</span>&#160;        <span class="comment">//        GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,FLAGUTOPRIMRADFAIL)=UTOPRIMRADFAILCASE2B; // must set as failure in case can fixup. // NO, leave implicit call as handling error mode.</span></div>
<div class="line"><a name="l10240"></a><span class="lineno">10240</span>&#160;        <span class="keywordflow">return</span>(0);        </div>
<div class="line"><a name="l10241"></a><span class="lineno">10241</span>&#160;      }</div>
<div class="line"><a name="l10242"></a><span class="lineno">10242</span>&#160;    }<span class="comment">// end if failed to do implicit</span></div>
<div class="line"><a name="l10243"></a><span class="lineno">10243</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(failimplicit==0){</div>
<div class="line"><a name="l10244"></a><span class="lineno">10244</span>&#160;      <span class="comment">// no failure in implicit, then just return</span></div>
<div class="line"><a name="l10245"></a><span class="lineno">10245</span>&#160;      <span class="comment">// and if did implicit, then better pf guess for any future inversions</span></div>
<div class="line"><a name="l10246"></a><span class="lineno">10246</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) pf[pl]=pborig[pl];</div>
<div class="line"><a name="l10247"></a><span class="lineno">10247</span>&#160;      *didreturnpf=1;</div>
<div class="line"><a name="l10248"></a><span class="lineno">10248</span>&#160;    }</div>
<div class="line"><a name="l10249"></a><span class="lineno">10249</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l10250"></a><span class="lineno">10250</span>&#160;      *didreturnpf=0;</div>
<div class="line"><a name="l10251"></a><span class="lineno">10251</span>&#160;      <span class="comment">// e.g. if failimplicit==FAILRETURNGOTRIVIALEXPLICIT, then aborted implicit and letting trivial explicit operate.</span></div>
<div class="line"><a name="l10252"></a><span class="lineno">10252</span>&#160;    }</div>
<div class="line"><a name="l10253"></a><span class="lineno">10253</span>&#160;    <span class="comment">//    if(debugfail&gt;=2) dualfprintf(fail_file,&quot;Good: Imlicit good.: ijk=%d %d %d\n&quot;,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k);</span></div>
<div class="line"><a name="l10254"></a><span class="lineno">10254</span>&#160;    <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l10255"></a><span class="lineno">10255</span>&#160;</div>
<div class="line"><a name="l10256"></a><span class="lineno">10256</span>&#160;  }</div>
<div class="line"><a name="l10258"></a><span class="lineno">10258</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l10259"></a><span class="lineno">10259</span>&#160;  <span class="comment">// IMPLICIT WITH EXPLICIT CHECK TYPES</span></div>
<div class="line"><a name="l10260"></a><span class="lineno">10260</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l10262"></a><span class="lineno">10262</span>&#160;<span class="comment"></span>  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(whichradsourcemethod==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a4796a4beebfc5f81106846d0e7c1c320">SOURCEMETHODIMPLICITEXPLICITCHECK</a>){</div>
<div class="line"><a name="l10263"></a><span class="lineno">10263</span>&#160;</div>
<div class="line"><a name="l10264"></a><span class="lineno">10264</span>&#160;    <span class="comment">// try explicit (or see if no source at all required)</span></div>
<div class="line"><a name="l10265"></a><span class="lineno">10265</span>&#160;    <span class="comment">// Just check using explicit method, since if sub-cycles required then should just do implicit</span></div>
<div class="line"><a name="l10266"></a><span class="lineno">10266</span>&#160;    <span class="keywordtype">int</span> failreturn=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa8c5c0d5de580899948f9f22e10aff23" title="General radiation source term calculation (EXTERNALLY called) NOTE: source_explicit() takes as first ...">koral_source_rad</a>(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aca22384dd0085c835b968fc59699182f">SOURCEMETHODEXPLICITCHECKSFROMIMPLICIT</a>, piinorig, pborig, pf, didreturnpf, eomtype, Uiinorig, Ufinorig, CUf, CUimp, ptrgeom, qorig, dissmeasure, dUother, dUcomp);</div>
<div class="line"><a name="l10267"></a><span class="lineno">10267</span>&#160;</div>
<div class="line"><a name="l10268"></a><span class="lineno">10268</span>&#160;    <span class="comment">// determine if still need to do implicit</span></div>
<div class="line"><a name="l10269"></a><span class="lineno">10269</span>&#160;    <span class="comment">// don&#39;t set didreturnpf since already was set</span></div>
<div class="line"><a name="l10270"></a><span class="lineno">10270</span>&#160;    <span class="keywordtype">int</span> doimplicit;</div>
<div class="line"><a name="l10271"></a><span class="lineno">10271</span>&#160;    <span class="keywordflow">if</span>(failreturn==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ac38828263c28e7d566ff97bb7cbd1ccc">EXPLICITFAILED</a> || failreturn==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#afa05900437da5eb66c5a97c28e4283d8">EXPLICITFAILEDBUTWENTTHROUGH</a> || GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>)&gt;<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6435e9609d622c9dbaf78c12658ecf8e">UTOPRIMRADNOFAIL</a>){</div>
<div class="line"><a name="l10272"></a><span class="lineno">10272</span>&#160;      doimplicit=1;</div>
<div class="line"><a name="l10273"></a><span class="lineno">10273</span>&#160;      GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>)=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6435e9609d622c9dbaf78c12658ecf8e">UTOPRIMRADNOFAIL</a>; <span class="comment">// reset and let implicit set this</span></div>
<div class="line"><a name="l10274"></a><span class="lineno">10274</span>&#160;      <span class="keywordflow">if</span>(showmessagesheavy &amp;&amp; debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;NOTE: Tried explicit step, but wasn&#39;t good choice or failed: ijk=%d %d %d\n&quot;</span>,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k);</div>
<div class="line"><a name="l10275"></a><span class="lineno">10275</span>&#160;      <span class="comment">// don&#39;t return until do implicit</span></div>
<div class="line"><a name="l10276"></a><span class="lineno">10276</span>&#160;    }</div>
<div class="line"><a name="l10277"></a><span class="lineno">10277</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(failreturn==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a6bc50dd87820f78f39f35a72c34ed74e">EXPLICITNOTNECESSARY</a>){</div>
<div class="line"><a name="l10278"></a><span class="lineno">10278</span>&#160;      <span class="comment">// then no source at all required</span></div>
<div class="line"><a name="l10279"></a><span class="lineno">10279</span>&#160;      doimplicit=0;</div>
<div class="line"><a name="l10280"></a><span class="lineno">10280</span>&#160;      <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l10281"></a><span class="lineno">10281</span>&#160;    }</div>
<div class="line"><a name="l10282"></a><span class="lineno">10282</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l10283"></a><span class="lineno">10283</span>&#160;      doimplicit=0;</div>
<div class="line"><a name="l10284"></a><span class="lineno">10284</span>&#160;      <span class="keywordflow">if</span>(showmessagesheavy &amp;&amp; debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;NOTE: Was able to take explicit step: ijk=%d %d %d : failreturn=%d\n&quot;</span>,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,failreturn);</div>
<div class="line"><a name="l10285"></a><span class="lineno">10285</span>&#160;      <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l10286"></a><span class="lineno">10286</span>&#160;    }</div>
<div class="line"><a name="l10287"></a><span class="lineno">10287</span>&#160;  </div>
<div class="line"><a name="l10288"></a><span class="lineno">10288</span>&#160;</div>
<div class="line"><a name="l10289"></a><span class="lineno">10289</span>&#160;    <span class="keywordflow">if</span>(doimplicit){</div>
<div class="line"><a name="l10290"></a><span class="lineno">10290</span>&#160;      <span class="keywordflow">if</span>(showmessagesheavy &amp;&amp; debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;NOTE: Had to take implicit step: %d %d %d\n&quot;</span>,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k);</div>
<div class="line"><a name="l10291"></a><span class="lineno">10291</span>&#160;</div>
<div class="line"><a name="l10292"></a><span class="lineno">10292</span>&#160;      <span class="comment">// one-deep recursive call to implicit scheme</span></div>
<div class="line"><a name="l10293"></a><span class="lineno">10293</span>&#160;      <span class="keywordflow">return</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa8c5c0d5de580899948f9f22e10aff23" title="General radiation source term calculation (EXTERNALLY called) NOTE: source_explicit() takes as first ...">koral_source_rad</a>(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a9a88f6a38ab5e7428dd23769b2f87518">SOURCEMETHODIMPLICIT</a>, piinorig, pborig, pf, didreturnpf, eomtype, Uiinorig, Ufinorig, CUf, CUimp, ptrgeom, qorig, dissmeasure, dUother, dUcomp));</div>
<div class="line"><a name="l10294"></a><span class="lineno">10294</span>&#160;    }<span class="comment">// end if doimplicit==1</span></div>
<div class="line"><a name="l10295"></a><span class="lineno">10295</span>&#160;</div>
<div class="line"><a name="l10296"></a><span class="lineno">10296</span>&#160;  }</div>
<div class="line"><a name="l10298"></a><span class="lineno">10298</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l10299"></a><span class="lineno">10299</span>&#160;  <span class="comment">// NO SOURCE TYPE</span></div>
<div class="line"><a name="l10300"></a><span class="lineno">10300</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l10302"></a><span class="lineno">10302</span>&#160;<span class="comment"></span>  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(whichradsourcemethod==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae3967ce21b0779cb95c1db4029c976f6" title="order of algorithm in time from 1 to 4.">SOURCEMETHODNONE</a>){</div>
<div class="line"><a name="l10303"></a><span class="lineno">10303</span>&#160;    <span class="comment">// then no source applied even if required</span></div>
<div class="line"><a name="l10304"></a><span class="lineno">10304</span>&#160;    *didreturnpf=0;</div>
<div class="line"><a name="l10305"></a><span class="lineno">10305</span>&#160;    <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l10306"></a><span class="lineno">10306</span>&#160;  }</div>
<div class="line"><a name="l10308"></a><span class="lineno">10308</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l10309"></a><span class="lineno">10309</span>&#160;  <span class="comment">// UNKNOWN TYPE</span></div>
<div class="line"><a name="l10310"></a><span class="lineno">10310</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l10312"></a><span class="lineno">10312</span>&#160;<span class="comment"></span>  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l10313"></a><span class="lineno">10313</span>&#160;</div>
<div class="line"><a name="l10314"></a><span class="lineno">10314</span>&#160;    dualfprintf(fail_file,<span class="stringliteral">&quot;3 No Such EOMRADTYPE=%d\n&quot;</span>,<a class="code" href="../../da/d3e/definit_8h.html#a99ba7daf58b283bc831b8f507f5873a4" title="#define EOMTYPE EOMCOLDGRMHD">EOMRADTYPE</a>);</div>
<div class="line"><a name="l10315"></a><span class="lineno">10315</span>&#160;    myexit(18754363);</div>
<div class="line"><a name="l10316"></a><span class="lineno">10316</span>&#160;</div>
<div class="line"><a name="l10317"></a><span class="lineno">10317</span>&#160;  }</div>
<div class="line"><a name="l10318"></a><span class="lineno">10318</span>&#160;</div>
<div class="line"><a name="l10319"></a><span class="lineno">10319</span>&#160;  <span class="comment">// KORALTODO: SUPERGODMARK: Need to add NR 2007 page940 17.5.2L StepperSie method here as higher-order alternative if 1st order Newton breaks</span></div>
<div class="line"><a name="l10320"></a><span class="lineno">10320</span>&#160;</div>
<div class="line"><a name="l10321"></a><span class="lineno">10321</span>&#160;</div>
<div class="line"><a name="l10322"></a><span class="lineno">10322</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l10323"></a><span class="lineno">10323</span>&#160;</div>
<div class="line"><a name="l10324"></a><span class="lineno">10324</span>&#160;}</div>
<div class="line"><a name="l10325"></a><span class="lineno">10325</span>&#160;</div>
<div class="line"><a name="l10326"></a><span class="lineno">10326</span>&#160;</div>
<div class="line"><a name="l10327"></a><span class="lineno">10327</span>&#160;</div>
<div class="line"><a name="l10328"></a><span class="lineno">10328</span>&#160;</div>
<div class="line"><a name="l10329"></a><span class="lineno">10329</span>&#160;</div>
<div class="line"><a name="l10330"></a><span class="lineno">10330</span>&#160;</div>
<div class="line"><a name="l10331"></a><span class="lineno">10331</span>&#160;</div>
<div class="line"><a name="l10332"></a><span class="lineno">10332</span>&#160;</div>
<div class="line"><a name="l10333"></a><span class="lineno">10333</span>&#160;</div>
<div class="line"><a name="l10334"></a><span class="lineno">10334</span>&#160;</div>
<div class="line"><a name="l10335"></a><span class="lineno">10335</span>&#160;</div>
<div class="line"><a name="l10340"></a><span class="lineno">10340</span>&#160;<span class="comment">// just for chi and tautot</span></div>
<div class="line"><a name="l10341"></a><span class="lineno">10341</span>&#160;<span class="keywordtype">void</span> calc_kappa(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *q, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *kappa)</div>
<div class="line"><a name="l10342"></a><span class="lineno">10342</span>&#160;{</div>
<div class="line"><a name="l10343"></a><span class="lineno">10343</span>&#160;  <span class="keyword">extern</span> <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> calc_kappa_user(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> rho, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> B, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Tg,<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Tr,<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> expfactorrad, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> x,<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> y,<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> z);</div>
<div class="line"><a name="l10344"></a><span class="lineno">10344</span>&#160;  <span class="comment">//user_calc_kappa()</span></div>
<div class="line"><a name="l10345"></a><span class="lineno">10345</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> rho=pr[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>];</div>
<div class="line"><a name="l10346"></a><span class="lineno">10346</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> u=pr[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>];</div>
<div class="line"><a name="l10347"></a><span class="lineno">10347</span>&#160;  <span class="keywordtype">int</span> ii=ptrgeom-&gt;i;</div>
<div class="line"><a name="l10348"></a><span class="lineno">10348</span>&#160;  <span class="keywordtype">int</span> jj=ptrgeom-&gt;j;</div>
<div class="line"><a name="l10349"></a><span class="lineno">10349</span>&#160;  <span class="keywordtype">int</span> kk=ptrgeom-&gt;k;</div>
<div class="line"><a name="l10350"></a><span class="lineno">10350</span>&#160;  <span class="keywordtype">int</span> loc=ptrgeom-&gt;p;</div>
<div class="line"><a name="l10351"></a><span class="lineno">10351</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Tgas=compute_temp_simple(ii,jj,kk,loc,rho,u);</div>
<div class="line"><a name="l10352"></a><span class="lineno">10352</span>&#160;</div>
<div class="line"><a name="l10353"></a><span class="lineno">10353</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Tradff,nradff,expfactorradff;</div>
<div class="line"><a name="l10354"></a><span class="lineno">10354</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> <a class="code" href="../../d1/d83/structof__state.html#a2b38c522ec7321af3368706fa4632834">bsq</a>,B;</div>
<div class="line"><a name="l10355"></a><span class="lineno">10355</span>&#160;  <span class="keywordflow">if</span>(q==NULL){</div>
<div class="line"><a name="l10356"></a><span class="lineno">10356</span>&#160;    <span class="comment">//    Trad=Tgas; // estimate for opacity (worse than below)</span></div>
<div class="line"><a name="l10357"></a><span class="lineno">10357</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Ruufake=pr[PRAD0]; <span class="comment">// estimate for opacity</span></div>
<div class="line"><a name="l10358"></a><span class="lineno">10358</span>&#160;    Tradff = pow(fabs(Ruufake)/<a class="code" href="../../d8/d5b/defs_8general_8h.html#a591d275f967baa00b6382aff77362636">ARAD_CODE</a>,0.25); <span class="comment">// ASSUMPTION: PLANCK</span></div>
<div class="line"><a name="l10359"></a><span class="lineno">10359</span>&#160;    expfactorradff=1.0; <span class="comment">// Planck</span></div>
<div class="line"><a name="l10360"></a><span class="lineno">10360</span>&#160;    <span class="comment">//nradff not used here, so don&#39;t have to set</span></div>
<div class="line"><a name="l10361"></a><span class="lineno">10361</span>&#160;    <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a837cc5e285c9e98d2b74a324352b0117">bsq_calc</a>(pr,ptrgeom,&amp;bsq);</div>
<div class="line"><a name="l10362"></a><span class="lineno">10362</span>&#160;  }</div>
<div class="line"><a name="l10363"></a><span class="lineno">10363</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l10364"></a><span class="lineno">10364</span>&#160;    <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8242523b45077ccd783a2867dddb731a" title="compute Trad (also computed directly in calc_Gu() above) using only primitives (not using conserved q...">calc_Trad</a>(pr,ptrgeom,q,&amp;Tradff,&amp;nradff,&amp;expfactorradff); <span class="comment">// kinda expensive, avoid if not really necessary (could set Trad=Tgas, just for opacity purposes)</span></div>
<div class="line"><a name="l10365"></a><span class="lineno">10365</span>&#160;    bsq = <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a7aac0a38641f2d6b53549677fa052a79">dot</a>(q-&gt;<a class="code" href="../../d1/d83/structof__state.html#a9a5aa459c68ba51073dd9a245c1a7798">bcon</a>, q-&gt;<a class="code" href="../../d1/d83/structof__state.html#a60ad0baeb54ce3584309ba5567a72f41">bcov</a>);</div>
<div class="line"><a name="l10366"></a><span class="lineno">10366</span>&#160;  }</div>
<div class="line"><a name="l10367"></a><span class="lineno">10367</span>&#160;  B=sqrt(bsq);</div>
<div class="line"><a name="l10368"></a><span class="lineno">10368</span>&#160; </div>
<div class="line"><a name="l10369"></a><span class="lineno">10369</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> <a class="code" href="../../dc/dd2/newcodediff_8txt.html#af84f2c3bf153920b7c8d186132d39bc7">V</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>]={0.0},xx=0.0,yy=0.0,zz=0.0;</div>
<div class="line"><a name="l10370"></a><span class="lineno">10370</span>&#160;<span class="preprocessor">#if(ALLOWKAPPAEXPLICITPOSDEPENDENCE)</span></div>
<div class="line"><a name="l10371"></a><span class="lineno">10371</span>&#160;<span class="preprocessor"></span>  <a class="code" href="../../d9/de9/coord_8c.html#a96290375e27d5d0aa4d843b07e228e14" title="normally-used bl_coord[i,j,k] {i,j,k} -&gt; V only">bl_coord_ijk</a>(ii,jj,kk,loc,V);</div>
<div class="line"><a name="l10372"></a><span class="lineno">10372</span>&#160;  xx=V[1];</div>
<div class="line"><a name="l10373"></a><span class="lineno">10373</span>&#160;  yy=V[2];</div>
<div class="line"><a name="l10374"></a><span class="lineno">10374</span>&#160;  zz=V[3];</div>
<div class="line"><a name="l10375"></a><span class="lineno">10375</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l10376"></a><span class="lineno">10376</span>&#160;<span class="preprocessor"></span>  *kappa = calc_kappa_user(rho,B,Tgas,Tradff,expfactorradff,xx,yy,zz);</div>
<div class="line"><a name="l10377"></a><span class="lineno">10377</span>&#160;  <span class="comment">//  dualfprintf(fail_file,&quot;kappaabs=%g\n&quot;,*kappa);</span></div>
<div class="line"><a name="l10378"></a><span class="lineno">10378</span>&#160;</div>
<div class="line"><a name="l10379"></a><span class="lineno">10379</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a1f582d2dfcca528d70f908cc28394cc9">AVOIDTAUFORFLOOR</a>==1){</div>
<div class="line"><a name="l10380"></a><span class="lineno">10380</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> bsqorholimit=10.0; <span class="comment">//BSQORHOLIMIT/5.0;</span></div>
<div class="line"><a name="l10381"></a><span class="lineno">10381</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> factor;</div>
<div class="line"><a name="l10382"></a><span class="lineno">10382</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> thebsqorho=bsq/rho;</div>
<div class="line"><a name="l10383"></a><span class="lineno">10383</span>&#160;    <span class="keywordflow">if</span>(bsq/rho&lt;0 || bsq/rho&gt;<a class="code" href="../../d8/d5b/defs_8general_8h.html#a0fe8d3c7642e667dd8ae3635506c4273">BSQORHOLIMIT</a>) thebsqorho=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a0fe8d3c7642e667dd8ae3635506c4273">BSQORHOLIMIT</a>;</div>
<div class="line"><a name="l10384"></a><span class="lineno">10384</span>&#160;    factor=exp(-thebsqorho/bsqorholimit);</div>
<div class="line"><a name="l10385"></a><span class="lineno">10385</span>&#160;    *kappa *= factor;</div>
<div class="line"><a name="l10386"></a><span class="lineno">10386</span>&#160;  }</div>
<div class="line"><a name="l10387"></a><span class="lineno">10387</span>&#160;</div>
<div class="line"><a name="l10388"></a><span class="lineno">10388</span>&#160;</div>
<div class="line"><a name="l10389"></a><span class="lineno">10389</span>&#160;}</div>
<div class="line"><a name="l10390"></a><span class="lineno">10390</span>&#160;</div>
<div class="line"><a name="l10391"></a><span class="lineno">10391</span>&#160;</div>
<div class="line"><a name="l10393"></a><span class="lineno">10393</span>&#160;<span class="comment">// just for chi and tautot</span></div>
<div class="line"><a name="l10394"></a><span class="lineno">10394</span>&#160;<span class="keywordtype">void</span> calc_kappaes(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *kappaes)</div>
<div class="line"><a name="l10395"></a><span class="lineno">10395</span>&#160;{  </div>
<div class="line"><a name="l10396"></a><span class="lineno">10396</span>&#160;  <span class="keyword">extern</span> <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> calc_kappaes_user(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> rho, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> T,<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> x,<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> y,<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> z);</div>
<div class="line"><a name="l10397"></a><span class="lineno">10397</span>&#160;  <span class="comment">//user_calc_kappaes()</span></div>
<div class="line"><a name="l10398"></a><span class="lineno">10398</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> rho=pr[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>];</div>
<div class="line"><a name="l10399"></a><span class="lineno">10399</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> u=pr[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>];</div>
<div class="line"><a name="l10400"></a><span class="lineno">10400</span>&#160;  <span class="keywordtype">int</span> ii=ptrgeom-&gt;i;</div>
<div class="line"><a name="l10401"></a><span class="lineno">10401</span>&#160;  <span class="keywordtype">int</span> jj=ptrgeom-&gt;j;</div>
<div class="line"><a name="l10402"></a><span class="lineno">10402</span>&#160;  <span class="keywordtype">int</span> kk=ptrgeom-&gt;k;</div>
<div class="line"><a name="l10403"></a><span class="lineno">10403</span>&#160;  <span class="keywordtype">int</span> loc=ptrgeom-&gt;p;</div>
<div class="line"><a name="l10404"></a><span class="lineno">10404</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> T=compute_temp_simple(ii,jj,kk,loc,rho,u);</div>
<div class="line"><a name="l10405"></a><span class="lineno">10405</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> V[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>]={0.0},xx=0.0,yy=0.0,zz=0.0;</div>
<div class="line"><a name="l10406"></a><span class="lineno">10406</span>&#160;<span class="preprocessor">#if(ALLOWKAPPAEXPLICITPOSDEPENDENCE)</span></div>
<div class="line"><a name="l10407"></a><span class="lineno">10407</span>&#160;<span class="preprocessor"></span>  <a class="code" href="../../d9/de9/coord_8c.html#a96290375e27d5d0aa4d843b07e228e14" title="normally-used bl_coord[i,j,k] {i,j,k} -&gt; V only">bl_coord_ijk</a>(ii,jj,kk,loc,V);</div>
<div class="line"><a name="l10408"></a><span class="lineno">10408</span>&#160;  xx=V[1];</div>
<div class="line"><a name="l10409"></a><span class="lineno">10409</span>&#160;  yy=V[2];</div>
<div class="line"><a name="l10410"></a><span class="lineno">10410</span>&#160;  zz=V[3];</div>
<div class="line"><a name="l10411"></a><span class="lineno">10411</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l10412"></a><span class="lineno">10412</span>&#160;<span class="preprocessor"></span>  *kappaes = calc_kappaes_user(rho,T,xx,yy,zz);</div>
<div class="line"><a name="l10413"></a><span class="lineno">10413</span>&#160;  <span class="comment">//  dualfprintf(fail_file,&quot;kappaes=%g\n&quot;,*kappa);</span></div>
<div class="line"><a name="l10414"></a><span class="lineno">10414</span>&#160;</div>
<div class="line"><a name="l10415"></a><span class="lineno">10415</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a1f582d2dfcca528d70f908cc28394cc9">AVOIDTAUFORFLOOR</a>==1){</div>
<div class="line"><a name="l10416"></a><span class="lineno">10416</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> <a class="code" href="../../d1/d83/structof__state.html#a2b38c522ec7321af3368706fa4632834">bsq</a>;</div>
<div class="line"><a name="l10417"></a><span class="lineno">10417</span>&#160;    <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a837cc5e285c9e98d2b74a324352b0117">bsq_calc</a>(pr, ptrgeom, &amp;bsq);</div>
<div class="line"><a name="l10418"></a><span class="lineno">10418</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> bsqorholimit=10.0; <span class="comment">//BSQORHOLIMIT/5.0;</span></div>
<div class="line"><a name="l10419"></a><span class="lineno">10419</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> factor;</div>
<div class="line"><a name="l10420"></a><span class="lineno">10420</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> thebsqorho=bsq/rho;</div>
<div class="line"><a name="l10421"></a><span class="lineno">10421</span>&#160;    <span class="keywordflow">if</span>(bsq/rho&lt;0 || bsq/rho&gt;<a class="code" href="../../d8/d5b/defs_8general_8h.html#a0fe8d3c7642e667dd8ae3635506c4273">BSQORHOLIMIT</a>) thebsqorho=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a0fe8d3c7642e667dd8ae3635506c4273">BSQORHOLIMIT</a>;</div>
<div class="line"><a name="l10422"></a><span class="lineno">10422</span>&#160;    factor=exp(-thebsqorho/bsqorholimit);</div>
<div class="line"><a name="l10423"></a><span class="lineno">10423</span>&#160;    *kappaes *= factor;</div>
<div class="line"><a name="l10424"></a><span class="lineno">10424</span>&#160;  }</div>
<div class="line"><a name="l10425"></a><span class="lineno">10425</span>&#160;</div>
<div class="line"><a name="l10426"></a><span class="lineno">10426</span>&#160;}</div>
<div class="line"><a name="l10427"></a><span class="lineno">10427</span>&#160; </div>
<div class="line"><a name="l10428"></a><span class="lineno">10428</span>&#160;</div>
<div class="line"><a name="l10429"></a><span class="lineno">10429</span>&#160;<span class="comment">// compute \chi TODOMARK: Should compute this and wavespeed (how this used) just after implicit stepping to avoid repeating opacity calculation.</span></div>
<div class="line"><a name="l10430"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a63256be4e6a63216cb736012e36a6375">10430</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a63256be4e6a63216cb736012e36a6375">calc_chi</a>(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *q, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *chi)</div>
<div class="line"><a name="l10431"></a><span class="lineno">10431</span>&#160;{</div>
<div class="line"><a name="l10432"></a><span class="lineno">10432</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> kappa,kappaes;</div>
<div class="line"><a name="l10433"></a><span class="lineno">10433</span>&#160;  calc_kappa(pr,ptrgeom,q,&amp;kappa);</div>
<div class="line"><a name="l10434"></a><span class="lineno">10434</span>&#160;  calc_kappaes(pr,ptrgeom,&amp;kappaes);</div>
<div class="line"><a name="l10435"></a><span class="lineno">10435</span>&#160;  </div>
<div class="line"><a name="l10436"></a><span class="lineno">10436</span>&#160;  *chi=kappa+kappaes;</div>
<div class="line"><a name="l10437"></a><span class="lineno">10437</span>&#160;}</div>
<div class="line"><a name="l10438"></a><span class="lineno">10438</span>&#160;</div>
<div class="line"><a name="l10439"></a><span class="lineno">10439</span>&#160;</div>
<div class="line"><a name="l10442"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a41e256325d07de60fa8b6b8e743cf7b8">10442</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#af8e0b77aba8b494909392ceca6f551a0" title="get {abs} and {es} in /mass * rho = 1/cm form.">calc_Tandopacityandemission</a>(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *q, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Ruu, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammaradgas, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> B, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Tgas, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Tradff, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *nradff, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *expfactorradff, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *kappa, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *kappan, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *kappaemit, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *kappanemit, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *kappaes, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *lambda, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *nlambda)</div>
<div class="line"><a name="l10443"></a><span class="lineno">10443</span>&#160;{</div>
<div class="line"><a name="l10444"></a><span class="lineno">10444</span>&#160;  <span class="keyword">extern</span> <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> calc_kappa_user(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> rho, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> B, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Tg,<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Tr,<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> expfactorrad, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> x,<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> y,<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> z);</div>
<div class="line"><a name="l10445"></a><span class="lineno">10445</span>&#160;  <span class="comment">//user_calc_kappa()</span></div>
<div class="line"><a name="l10446"></a><span class="lineno">10446</span>&#160;</div>
<div class="line"><a name="l10447"></a><span class="lineno">10447</span>&#160;  <span class="comment">// get rho,u</span></div>
<div class="line"><a name="l10448"></a><span class="lineno">10448</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> rho=pr[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>];</div>
<div class="line"><a name="l10449"></a><span class="lineno">10449</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> u=pr[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>];</div>
<div class="line"><a name="l10450"></a><span class="lineno">10450</span>&#160;</div>
<div class="line"><a name="l10451"></a><span class="lineno">10451</span>&#160;  <span class="comment">// get Tgas</span></div>
<div class="line"><a name="l10452"></a><span class="lineno">10452</span>&#160;  <span class="keywordtype">int</span> ii=ptrgeom-&gt;i;</div>
<div class="line"><a name="l10453"></a><span class="lineno">10453</span>&#160;  <span class="keywordtype">int</span> jj=ptrgeom-&gt;j;</div>
<div class="line"><a name="l10454"></a><span class="lineno">10454</span>&#160;  <span class="keywordtype">int</span> kk=ptrgeom-&gt;k;</div>
<div class="line"><a name="l10455"></a><span class="lineno">10455</span>&#160;  <span class="keywordtype">int</span> loc=ptrgeom-&gt;p;</div>
<div class="line"><a name="l10456"></a><span class="lineno">10456</span>&#160;  *Tgas=compute_temp_simple(ii,jj,kk,loc,rho,u);</div>
<div class="line"><a name="l10457"></a><span class="lineno">10457</span>&#160;  *Tgas = fabs(*Tgas) + <a class="code" href="../../da/d04/global_8depmnemonics_8rad_8h.html#a213757d7585988f6c552da30cc6fcc39">TEMPMIN</a>;</div>
<div class="line"><a name="l10458"></a><span class="lineno">10458</span>&#160;</div>
<div class="line"><a name="l10459"></a><span class="lineno">10459</span>&#160;  <span class="comment">// get Tradff and nradff</span></div>
<div class="line"><a name="l10460"></a><span class="lineno">10460</span>&#160;  <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a864793af319e70c0d099679fa81dd398" title="compute Trad (also computed directly in calc_Gu() above) using only primitives (not using conserved q...">calc_Trad_fromRuuandgamma</a>(pr, ptrgeom, Ruu, gammaradgas, Tradff, nradff, expfactorradff);</div>
<div class="line"><a name="l10461"></a><span class="lineno">10461</span>&#160;  *Tradff = fabs(*Tradff) + <a class="code" href="../../da/d04/global_8depmnemonics_8rad_8h.html#a213757d7585988f6c552da30cc6fcc39">TEMPMIN</a>;  <span class="comment">// avoid division by zero in later calculations</span></div>
<div class="line"><a name="l10462"></a><span class="lineno">10462</span>&#160;  *nradff = fabs(*nradff) + <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a09c78d2f8feb311dd9fc969a0bf84979">SMALL</a>;</div>
<div class="line"><a name="l10463"></a><span class="lineno">10463</span>&#160;</div>
<div class="line"><a name="l10464"></a><span class="lineno">10464</span>&#160;  <span class="comment">// get position for opacity if needed</span></div>
<div class="line"><a name="l10465"></a><span class="lineno">10465</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> V[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>]={0.0},xx=0.0,yy=0.0,zz=0.0;</div>
<div class="line"><a name="l10466"></a><span class="lineno">10466</span>&#160;<span class="preprocessor">#if(ALLOWKAPPAEXPLICITPOSDEPENDENCE)</span></div>
<div class="line"><a name="l10467"></a><span class="lineno">10467</span>&#160;<span class="preprocessor"></span>  <a class="code" href="../../d9/de9/coord_8c.html#a96290375e27d5d0aa4d843b07e228e14" title="normally-used bl_coord[i,j,k] {i,j,k} -&gt; V only">bl_coord_ijk</a>(ii,jj,kk,loc,V);</div>
<div class="line"><a name="l10468"></a><span class="lineno">10468</span>&#160;  xx=V[1];</div>
<div class="line"><a name="l10469"></a><span class="lineno">10469</span>&#160;  yy=V[2];</div>
<div class="line"><a name="l10470"></a><span class="lineno">10470</span>&#160;  zz=V[3];</div>
<div class="line"><a name="l10471"></a><span class="lineno">10471</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l10472"></a><span class="lineno">10472</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l10473"></a><span class="lineno">10473</span>&#160;</div>
<div class="line"><a name="l10474"></a><span class="lineno">10474</span>&#160;<span class="preprocessor">#if(WHICHFIT==ISFITNEW)</span></div>
<div class="line"><a name="l10475"></a><span class="lineno">10475</span>&#160;<span class="preprocessor"></span>  <span class="comment">// get opacities</span></div>
<div class="line"><a name="l10476"></a><span class="lineno">10476</span>&#160;  <span class="comment">//  calc_kappaall_user(rho,B,*Tgas,*Tradff,*expfactorradff,xx,yy,zz, kappa, kappaemit, kappan, kappanemit, kappaes);</span></div>
<div class="line"><a name="l10477"></a><span class="lineno">10477</span>&#160;</div>
<div class="line"><a name="l10478"></a><span class="lineno">10478</span>&#160;<span class="preprocessor">#if(EOMRADTYPE!=EOMRADNONE)</span></div>
<div class="line"><a name="l10479"></a><span class="lineno">10479</span>&#160;<span class="preprocessor"></span>  <a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#ab4537b80f4788d1a81759b595c8441a9">kappa_func_fits_all</a>(rho, B, *Tgas, *Tradff, *expfactorradff, kappa, kappaemit, kappan, kappanemit, kappaes);</div>
<div class="line"><a name="l10480"></a><span class="lineno">10480</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l10481"></a><span class="lineno">10481</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l10482"></a><span class="lineno">10482</span>&#160;</div>
<div class="line"><a name="l10483"></a><span class="lineno">10483</span>&#160;  <span class="comment">// energy density loss rate integrated over frequency and solid angle, based upon those processes written as an opacity</span></div>
<div class="line"><a name="l10484"></a><span class="lineno">10484</span>&#160;  <span class="comment">// below lambda and nlambda now generally true</span></div>
<div class="line"><a name="l10485"></a><span class="lineno">10485</span>&#160;  *lambda = (*kappaemit)*<a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#a0fb687f68b97453843fc3c085f05f1b4" title="E=urad=arad T^4 (this is LTE only if put in T was gas T)">calc_LTE_EfromT</a>(*Tradff);</div>
<div class="line"><a name="l10486"></a><span class="lineno">10486</span>&#160;</div>
<div class="line"><a name="l10487"></a><span class="lineno">10487</span>&#160;<span class="preprocessor">#if(EVOLVENRAD)</span></div>
<div class="line"><a name="l10488"></a><span class="lineno">10488</span>&#160;<span class="preprocessor"></span>  *nlambda = (*kappanemit)*<a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#a7dc2e853cec9b6f9a5e83ce23c468d03" title="nrad(T) = nrad=arad T^3/2.70118 (this is LTE only if put in T was gas T)">calc_LTE_NfromT</a>(*Tradff);</div>
<div class="line"><a name="l10489"></a><span class="lineno">10489</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l10490"></a><span class="lineno">10490</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l10491"></a><span class="lineno">10491</span>&#160;<span class="preprocessor">#else // WHICHFIT==ISFITORIG</span></div>
<div class="line"><a name="l10492"></a><span class="lineno">10492</span>&#160;<span class="preprocessor"></span>  <span class="comment">// get scattering opacity (elastic with no detailed energy or number weighting)</span></div>
<div class="line"><a name="l10493"></a><span class="lineno">10493</span>&#160;  *kappaes = calc_kappaes_user(rho,*Tgas,xx,yy,zz);</div>
<div class="line"><a name="l10494"></a><span class="lineno">10494</span>&#160;</div>
<div class="line"><a name="l10495"></a><span class="lineno">10495</span>&#160;  <span class="comment">// get energy-based absorption opacity</span></div>
<div class="line"><a name="l10496"></a><span class="lineno">10496</span>&#160;  *kappa = calc_kappa_user(rho,B,*Tgas,*Tradff,*expfactorradff,xx,yy,zz);</div>
<div class="line"><a name="l10497"></a><span class="lineno">10497</span>&#160;</div>
<div class="line"><a name="l10498"></a><span class="lineno">10498</span>&#160;  <span class="comment">// get energy-based emission opacity</span></div>
<div class="line"><a name="l10499"></a><span class="lineno">10499</span>&#160;  <span class="comment">//  *kappaemit = calc_kappa_user(rho,B,*Tgas,*Tgas,xx,yy,zz); // Here Trad was set to Tgas for emission of radiation</span></div>
<div class="line"><a name="l10500"></a><span class="lineno">10500</span>&#160;  *kappaemit = calc_kappaemit_user(rho,B,*Tgas,*Tradff,*expfactorradff,xx,yy,zz);</div>
<div class="line"><a name="l10501"></a><span class="lineno">10501</span>&#160;</div>
<div class="line"><a name="l10502"></a><span class="lineno">10502</span>&#160;  <span class="comment">// This is aT^4/(4\pi) that is the specific black body emission rate in B_\nu d\nu d\Omega corresponding to energy density rate per unit frequency per unit solid angle, which has been integrated over frequency.</span></div>
<div class="line"><a name="l10503"></a><span class="lineno">10503</span>&#160;  <span class="comment">// More generally, kappa*4*Pi*B can be replaced by some \Lambda that is some energy density rate</span></div>
<div class="line"><a name="l10504"></a><span class="lineno">10504</span>&#160;  <span class="comment">// But, have to be careful that &quot;kappa rho&quot; is constructed from \Lambda/(u*c) or else balance won&#39;t occur.</span></div>
<div class="line"><a name="l10505"></a><span class="lineno">10505</span>&#160;  <span class="comment">// This is issue because &quot;kappa&quot; is often frequency integrated directly, giving different answer than frequency integrating j_v -&gt; \Lambda/(4\pi) and B_\nu -&gt; (aT^4)/(4\pi) each and then taking the ratio.</span></div>
<div class="line"><a name="l10506"></a><span class="lineno">10506</span>&#160;  <span class="comment">// Note if T is near maximum for FTYPE, then aradT^4 likely too large.</span></div>
<div class="line"><a name="l10507"></a><span class="lineno">10507</span>&#160;  <span class="comment">//  FTYPE B=0.25*ARAD_CODE*pow(Tgas,4.)/Pi;</span></div>
<div class="line"><a name="l10508"></a><span class="lineno">10508</span>&#160;</div>
<div class="line"><a name="l10509"></a><span class="lineno">10509</span>&#160;  <span class="comment">// energy density loss rate integrated over frequency and solid angle, based upon those processes written as an opacity</span></div>
<div class="line"><a name="l10510"></a><span class="lineno">10510</span>&#160;  *lambda = (*kappaemit)*<a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#a0fb687f68b97453843fc3c085f05f1b4" title="E=urad=arad T^4 (this is LTE only if put in T was gas T)">calc_LTE_EfromT</a>(*Tradff);  <span class="comment">//(4.*Pi*B); / i.e. 4\pi B = arad Trad^4</span></div>
<div class="line"><a name="l10511"></a><span class="lineno">10511</span>&#160;</div>
<div class="line"><a name="l10512"></a><span class="lineno">10512</span>&#160;</div>
<div class="line"><a name="l10513"></a><span class="lineno">10513</span>&#160;<span class="preprocessor">#if(EVOLVENRAD)</span></div>
<div class="line"><a name="l10514"></a><span class="lineno">10514</span>&#160;<span class="preprocessor"></span>  <span class="comment">// get number-based absorption opacity</span></div>
<div class="line"><a name="l10515"></a><span class="lineno">10515</span>&#160;  *kappan = calc_kappan_user(rho,B,*Tgas,*Tradff,*expfactorradff,xx,yy,zz);</div>
<div class="line"><a name="l10516"></a><span class="lineno">10516</span>&#160;  <span class="comment">// get number-based emission opacity</span></div>
<div class="line"><a name="l10517"></a><span class="lineno">10517</span>&#160;  <span class="comment">//  *kappanemit = calc_kappan_user(rho,B,*Tgas,*Tgas,xx,yy,zz); // Here Trad was set to Tgas for emission of radiation</span></div>
<div class="line"><a name="l10518"></a><span class="lineno">10518</span>&#160;  *kappanemit = calc_kappanemit_user(rho,B,*Tgas,*Tradff,*expfactorradff,xx,yy,zz);</div>
<div class="line"><a name="l10519"></a><span class="lineno">10519</span>&#160;</div>
<div class="line"><a name="l10520"></a><span class="lineno">10520</span>&#160;  <span class="comment">// ASSUMPTION: Emitting radiation has average photon energy for gas at temperatures Tgas (isn&#39;t true for synchrotron, for example)</span></div>
<div class="line"><a name="l10521"></a><span class="lineno">10521</span>&#160;  <span class="comment">//  FTYPE ebar = EBAR0 * (TEMPMIN+*Tgas);</span></div>
<div class="line"><a name="l10522"></a><span class="lineno">10522</span>&#160;  <span class="comment">//  // result based upon opacity-based calculation of lambda, so includes free-free, bound-free, bound-bound, etc.</span></div>
<div class="line"><a name="l10523"></a><span class="lineno">10523</span>&#160;  <span class="comment">//  *nlambda = (*lambda)/ebar;</span></div>
<div class="line"><a name="l10524"></a><span class="lineno">10524</span>&#160;  *nlambda = (*kappanemit)*<a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#a7dc2e853cec9b6f9a5e83ce23c468d03" title="nrad(T) = nrad=arad T^3/2.70118 (this is LTE only if put in T was gas T)">calc_LTE_NfromT</a>(*Tradff);</div>
<div class="line"><a name="l10525"></a><span class="lineno">10525</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l10526"></a><span class="lineno">10526</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l10527"></a><span class="lineno">10527</span>&#160;</div>
<div class="line"><a name="l10528"></a><span class="lineno">10528</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l10529"></a><span class="lineno">10529</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l10530"></a><span class="lineno">10530</span>&#160;</div>
<div class="line"><a name="l10531"></a><span class="lineno">10531</span>&#160;</div>
<div class="line"><a name="l10532"></a><span class="lineno">10532</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a1f582d2dfcca528d70f908cc28394cc9">AVOIDTAUFORFLOOR</a>==1){</div>
<div class="line"><a name="l10533"></a><span class="lineno">10533</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> bsq=B*B;</div>
<div class="line"><a name="l10534"></a><span class="lineno">10534</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> bsqorholimit=10.0; <span class="comment">//BSQORHOLIMIT/5.0;</span></div>
<div class="line"><a name="l10535"></a><span class="lineno">10535</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> factor;</div>
<div class="line"><a name="l10536"></a><span class="lineno">10536</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> thebsqorho=bsq/rho;</div>
<div class="line"><a name="l10537"></a><span class="lineno">10537</span>&#160;    <span class="keywordflow">if</span>(bsq/rho&lt;0 || bsq/rho&gt;<a class="code" href="../../d8/d5b/defs_8general_8h.html#a0fe8d3c7642e667dd8ae3635506c4273">BSQORHOLIMIT</a>) thebsqorho=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a0fe8d3c7642e667dd8ae3635506c4273">BSQORHOLIMIT</a>;</div>
<div class="line"><a name="l10538"></a><span class="lineno">10538</span>&#160;    factor=exp(-thebsqorho/bsqorholimit);</div>
<div class="line"><a name="l10539"></a><span class="lineno">10539</span>&#160;</div>
<div class="line"><a name="l10540"></a><span class="lineno">10540</span>&#160;    *kappaes *= factor;</div>
<div class="line"><a name="l10541"></a><span class="lineno">10541</span>&#160;    *kappa *= factor;</div>
<div class="line"><a name="l10542"></a><span class="lineno">10542</span>&#160;    *kappaemit *= factor;</div>
<div class="line"><a name="l10543"></a><span class="lineno">10543</span>&#160;    *lambda *= factor;</div>
<div class="line"><a name="l10544"></a><span class="lineno">10544</span>&#160;</div>
<div class="line"><a name="l10545"></a><span class="lineno">10545</span>&#160;    *kappan *= factor;</div>
<div class="line"><a name="l10546"></a><span class="lineno">10546</span>&#160;    *kappanemit *= factor;</div>
<div class="line"><a name="l10547"></a><span class="lineno">10547</span>&#160;    *nlambda *= factor;</div>
<div class="line"><a name="l10548"></a><span class="lineno">10548</span>&#160;  }</div>
<div class="line"><a name="l10549"></a><span class="lineno">10549</span>&#160;</div>
<div class="line"><a name="l10550"></a><span class="lineno">10550</span>&#160;</div>
<div class="line"><a name="l10551"></a><span class="lineno">10551</span>&#160;</div>
<div class="line"><a name="l10552"></a><span class="lineno">10552</span>&#160;</div>
<div class="line"><a name="l10553"></a><span class="lineno">10553</span>&#160;</div>
<div class="line"><a name="l10554"></a><span class="lineno">10554</span>&#160;  <span class="comment">//  dualfprintf(fail_file,&quot;kappaabs=%g kappaes=%g\n&quot;,*kappa,*kappaes);</span></div>
<div class="line"><a name="l10555"></a><span class="lineno">10555</span>&#160;}</div>
<div class="line"><a name="l10556"></a><span class="lineno">10556</span>&#160;</div>
<div class="line"><a name="l10557"></a><span class="lineno">10557</span>&#160;</div>
<div class="line"><a name="l10559"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aaa32f967773a287ecb6647732157606f">10559</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aaa32f967773a287ecb6647732157606f" title="get G_">calc_Gd</a>(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pp, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *q ,<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *GG, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Tgas, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Trad, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a>* chieffreturn, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *ndotffreturn, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *ndotffabsreturn, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Gabs)</div>
<div class="line"><a name="l10560"></a><span class="lineno">10560</span>&#160;{</div>
<div class="line"><a name="l10561"></a><span class="lineno">10561</span>&#160;  <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab62b07a8cbcc04f20c05a468ad6de636" title="compute G^ 4-force">calc_Gu</a>(pp, ptrgeom, q, GG, Tgas, Trad, chieffreturn,ndotffreturn,ndotffabsreturn,Gabs);</div>
<div class="line"><a name="l10562"></a><span class="lineno">10562</span>&#160;  indices_21(GG, GG, ptrgeom);</div>
<div class="line"><a name="l10563"></a><span class="lineno">10563</span>&#160;}</div>
<div class="line"><a name="l10564"></a><span class="lineno">10564</span>&#160;</div>
<div class="line"><a name="l10565"></a><span class="lineno">10565</span>&#160;</div>
<div class="line"><a name="l10566"></a><span class="lineno">10566</span>&#160;</div>
<div class="line"><a name="l10568"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a2a80e3b7ea37b9536f0e49cc740425c9">10568</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#a0a9afe086334630c217cca3b3dbf7f7d" title="get 4-force for all pl&#39;s">koral_source_rad_calc</a>(<span class="keywordtype">int</span> computestate, <span class="keywordtype">int</span> computeentropy, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Gdpl, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Gdplabs, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *chi, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Tgas, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Trad, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *q)</div>
<div class="line"><a name="l10569"></a><span class="lineno">10569</span>&#160;{</div>
<div class="line"><a name="l10570"></a><span class="lineno">10570</span>&#160;  <span class="keywordtype">int</span> jj;</div>
<div class="line"><a name="l10571"></a><span class="lineno">10571</span>&#160;  <span class="keywordtype">int</span> pliter,pl;</div>
<div class="line"><a name="l10572"></a><span class="lineno">10572</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Gd[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>],Gdabs[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l10573"></a><span class="lineno">10573</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ndotff,ndotffabs;</div>
<div class="line"><a name="l10574"></a><span class="lineno">10574</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> qlocal;</div>
<div class="line"><a name="l10575"></a><span class="lineno">10575</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> chilocal,Tgaslocal,Tradlocal;</div>
<div class="line"><a name="l10576"></a><span class="lineno">10576</span>&#160;</div>
<div class="line"><a name="l10577"></a><span class="lineno">10577</span>&#160;  <span class="keywordflow">if</span>(q==NULL){ q=&amp;qlocal; computestate=1; }</div>
<div class="line"><a name="l10578"></a><span class="lineno">10578</span>&#160;  <span class="keywordflow">if</span>(chi==NULL) chi=&amp;chilocal;</div>
<div class="line"><a name="l10579"></a><span class="lineno">10579</span>&#160;  <span class="keywordflow">if</span>(Tgas==NULL) Tgas=&amp;Tgaslocal;</div>
<div class="line"><a name="l10580"></a><span class="lineno">10580</span>&#160;  <span class="keywordflow">if</span>(Trad==NULL) Trad=&amp;Tradlocal;</div>
<div class="line"><a name="l10581"></a><span class="lineno">10581</span>&#160;</div>
<div class="line"><a name="l10582"></a><span class="lineno">10582</span>&#160;</div>
<div class="line"><a name="l10584"></a><span class="lineno">10584</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l10585"></a><span class="lineno">10585</span>&#160;  <span class="comment">// energy-momentum density rate in lab-frame</span></div>
<div class="line"><a name="l10586"></a><span class="lineno">10586</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l10588"></a><span class="lineno">10588</span>&#160;<span class="comment"></span>  <span class="comment">// no, thermodynamics stuff can change since MHD fluid U changes, so must do get_state() as above</span></div>
<div class="line"><a name="l10589"></a><span class="lineno">10589</span>&#160;  <span class="comment">//  get_state_uconucovonly(pr, ptrgeom, q);</span></div>
<div class="line"><a name="l10590"></a><span class="lineno">10590</span>&#160;  <span class="comment">//  get_state_uradconuradcovonly(pr, ptrgeom, q);</span></div>
<div class="line"><a name="l10591"></a><span class="lineno">10591</span>&#160;  <span class="keywordflow">if</span>(computestate) <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a11e17cd8b0594d1ad52e3594aa9f477e" title="find ucon, ucov, bcon, bcov from primitive variables when calling get_state, users of this function e...">get_state</a>(pr,ptrgeom,q);</div>
<div class="line"><a name="l10592"></a><span class="lineno">10592</span>&#160;</div>
<div class="line"><a name="l10593"></a><span class="lineno">10593</span>&#160;  <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aaa32f967773a287ecb6647732157606f" title="get G_">calc_Gd</a>(pr, ptrgeom, q, Gd, Tgas, Trad, chi, &amp;ndotff, &amp;ndotffabs, Gdabs);</div>
<div class="line"><a name="l10594"></a><span class="lineno">10594</span>&#160;</div>
<div class="line"><a name="l10595"></a><span class="lineno">10595</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) Gdpl[pl] = 0.0;</div>
<div class="line"><a name="l10596"></a><span class="lineno">10596</span>&#160;  <span class="comment">// equal and opposite forces on fluid and radiation due to radiation 4-force</span></div>
<div class="line"><a name="l10597"></a><span class="lineno">10597</span>&#160;  <span class="comment">// </span></div>
<div class="line"><a name="l10598"></a><span class="lineno">10598</span>&#160;  <span class="comment">//    f[pl] = ((uu[pl] - uu0[pl]) + (sign[pl] * localdt * Gdpl[pl]))*extrafactor[pl]; -&gt; T^t_t[new] = T^t_t[old] - Gdpl[UU] -&gt; dT^t_t = -Gdpl = Gd   and so dR^t_t = -Gdpl = -Gd</span></div>
<div class="line"><a name="l10599"></a><span class="lineno">10599</span>&#160;  </div>
<div class="line"><a name="l10600"></a><span class="lineno">10600</span>&#160;</div>
<div class="line"><a name="l10601"></a><span class="lineno">10601</span>&#160;<span class="preprocessor">#define SIGNGD (1.0)</span></div>
<div class="line"><a name="l10602"></a><span class="lineno">10602</span>&#160;<span class="preprocessor"></span>  <span class="comment">// keep SIGNGD as 1.0.  Just apply signgd2 in front of Gdpl in other places.</span></div>
<div class="line"><a name="l10603"></a><span class="lineno">10603</span>&#160;  <span class="comment">// sign fixed-linked as + for URAD0 case.</span></div>
<div class="line"><a name="l10604"></a><span class="lineno">10604</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) Gdpl[UU+jj]     = -<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8dce9a0abd16361703533d4cff9b3f8a">SIGNGD</a>*Gd[jj];</div>
<div class="line"><a name="l10605"></a><span class="lineno">10605</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) Gdpl[URAD0+jj]  = +<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8dce9a0abd16361703533d4cff9b3f8a">SIGNGD</a>*Gd[jj];</div>
<div class="line"><a name="l10606"></a><span class="lineno">10606</span>&#160;</div>
<div class="line"><a name="l10607"></a><span class="lineno">10607</span>&#160;  <span class="keywordflow">if</span>(Gdplabs!=NULL){</div>
<div class="line"><a name="l10608"></a><span class="lineno">10608</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) Gdplabs[pl] = 0.0;</div>
<div class="line"><a name="l10609"></a><span class="lineno">10609</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) Gdplabs[UU+jj]     = Gdabs[jj];</div>
<div class="line"><a name="l10610"></a><span class="lineno">10610</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) Gdplabs[URAD0+jj]  = Gdabs[jj];</div>
<div class="line"><a name="l10611"></a><span class="lineno">10611</span>&#160;  }</div>
<div class="line"><a name="l10612"></a><span class="lineno">10612</span>&#160;</div>
<div class="line"><a name="l10614"></a><span class="lineno">10614</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l10615"></a><span class="lineno">10615</span>&#160;  <span class="comment">// entropy density rate -- invariant</span></div>
<div class="line"><a name="l10616"></a><span class="lineno">10616</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l10618"></a><span class="lineno">10618</span>&#160;<span class="comment"></span><span class="preprocessor">#if(DOENTROPY!=DONOENTROPY &amp;&amp; ENTROPY!=-100)</span></div>
<div class="line"><a name="l10619"></a><span class="lineno">10619</span>&#160;<span class="preprocessor"></span>  <span class="keywordflow">if</span>(computeentropy){</div>
<div class="line"><a name="l10620"></a><span class="lineno">10620</span>&#160;    pl=ENTROPY;</div>
<div class="line"><a name="l10621"></a><span class="lineno">10621</span>&#160;    <span class="comment">// The equation is (1/\sqrt{-g})*d_\mu(\sqrt{-g} s\rho_0 u^\mu) + Gdpl[mu].ucon[mu] = 0</span></div>
<div class="line"><a name="l10622"></a><span class="lineno">10622</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Gdplentropycontribs[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l10623"></a><span class="lineno">10623</span>&#160;    <span class="comment">// -Gdpl[UU+jj] is so heating (so lowering of T^t_t to be more negative) implies increases entropy.</span></div>
<div class="line"><a name="l10624"></a><span class="lineno">10624</span>&#160;    <span class="comment">// assumes Gpl includes kappa already with rho so that Gpl is energy per unit volume per unit time.  Dividing by T (energy) gives a dimensionless thing (entropy) per unit volume.</span></div>
<div class="line"><a name="l10625"></a><span class="lineno">10625</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) Gdplentropycontribs[jj] = (-Gdpl[UU+jj])*(q-&gt;<a class="code" href="../../d1/d83/structof__state.html#aab723d3c7c2c48b7246cc7d7d5379eed">ucon</a>[jj])/(*Tgas);</div>
<div class="line"><a name="l10626"></a><span class="lineno">10626</span>&#160;</div>
<div class="line"><a name="l10627"></a><span class="lineno">10627</span>&#160;    Gdpl[pl] = 0.0;</div>
<div class="line"><a name="l10628"></a><span class="lineno">10628</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) Gdpl[pl] += Gdplentropycontribs[jj];</div>
<div class="line"><a name="l10629"></a><span class="lineno">10629</span>&#160;</div>
<div class="line"><a name="l10630"></a><span class="lineno">10630</span>&#160;    <span class="keywordflow">if</span>(Gdplabs!=NULL){</div>
<div class="line"><a name="l10631"></a><span class="lineno">10631</span>&#160;      Gdplabs[pl] = 0.0;</div>
<div class="line"><a name="l10632"></a><span class="lineno">10632</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) Gdplabs[pl] += fabs(Gdplentropycontribs[jj]);</div>
<div class="line"><a name="l10633"></a><span class="lineno">10633</span>&#160;    }</div>
<div class="line"><a name="l10634"></a><span class="lineno">10634</span>&#160;  }</div>
<div class="line"><a name="l10635"></a><span class="lineno">10635</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l10636"></a><span class="lineno">10636</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l10638"></a><span class="lineno">10638</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l10639"></a><span class="lineno">10639</span>&#160;  <span class="comment">// number density of photon rate -- invariant</span></div>
<div class="line"><a name="l10640"></a><span class="lineno">10640</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l10642"></a><span class="lineno">10642</span>&#160;<span class="comment"></span><span class="preprocessor">#if(EVOLVENRAD)</span></div>
<div class="line"><a name="l10643"></a><span class="lineno">10643</span>&#160;<span class="preprocessor"></span>    pl=NRAD;</div>
<div class="line"><a name="l10644"></a><span class="lineno">10644</span>&#160;    Gdpl[pl] = ndotff;</div>
<div class="line"><a name="l10645"></a><span class="lineno">10645</span>&#160;    Gdplabs[pl] = ndotffabs;</div>
<div class="line"><a name="l10646"></a><span class="lineno">10646</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l10647"></a><span class="lineno">10647</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l10648"></a><span class="lineno">10648</span>&#160;</div>
<div class="line"><a name="l10649"></a><span class="lineno">10649</span>&#160;}</div>
<div class="line"><a name="l10650"></a><span class="lineno">10650</span>&#160;</div>
<div class="line"><a name="l10651"></a><span class="lineno">10651</span>&#160;</div>
<div class="line"><a name="l10653"></a><span class="lineno">10653</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> koral_source_dtsub_rad_calc(<span class="keywordtype">int</span> method, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ui, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Uf, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *dUother, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUf, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUimp, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Gdpl, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *dtsub)</div>
<div class="line"><a name="l10654"></a><span class="lineno">10654</span>&#160;{</div>
<div class="line"><a name="l10655"></a><span class="lineno">10655</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Gdplabs[NPR];</div>
<div class="line"><a name="l10656"></a><span class="lineno">10656</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> chi,Tgas,Trad;</div>
<div class="line"><a name="l10657"></a><span class="lineno">10657</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> q;</div>
<div class="line"><a name="l10658"></a><span class="lineno">10658</span>&#160;</div>
<div class="line"><a name="l10659"></a><span class="lineno">10659</span>&#160;  <span class="keywordtype">int</span> computestate=1;</div>
<div class="line"><a name="l10660"></a><span class="lineno">10660</span>&#160;  <span class="keywordtype">int</span> computeentropy=1;</div>
<div class="line"><a name="l10661"></a><span class="lineno">10661</span>&#160;  <a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#a0a9afe086334630c217cca3b3dbf7f7d" title="get 4-force for all pl&#39;s">koral_source_rad_calc</a>(computestate,computeentropy,pr,ptrgeom,Gdpl,Gdplabs,&amp;chi,&amp;Tgas,&amp;Trad,&amp;q);</div>
<div class="line"><a name="l10662"></a><span class="lineno">10662</span>&#160;</div>
<div class="line"><a name="l10663"></a><span class="lineno">10663</span>&#160;  <span class="keywordflow">if</span>(dtsub!=NULL){</div>
<div class="line"><a name="l10664"></a><span class="lineno">10664</span>&#160;    <span class="comment">// then assume expect calculation of dtsub</span></div>
<div class="line"><a name="l10665"></a><span class="lineno">10665</span>&#160;    get_dtsub(method, pr, &amp;q, Ui, Uf, dUother, CUf, CUimp, Gdpl, chi, Gdplabs, ptrgeom, dtsub);</div>
<div class="line"><a name="l10666"></a><span class="lineno">10666</span>&#160;  }</div>
<div class="line"><a name="l10667"></a><span class="lineno">10667</span>&#160;  <span class="comment">// else &quot;method&quot; can be anything and it doesn&#39;t matter</span></div>
<div class="line"><a name="l10668"></a><span class="lineno">10668</span>&#160;</div>
<div class="line"><a name="l10669"></a><span class="lineno">10669</span>&#160;</div>
<div class="line"><a name="l10670"></a><span class="lineno">10670</span>&#160;}</div>
<div class="line"><a name="l10671"></a><span class="lineno">10671</span>&#160;</div>
<div class="line"><a name="l10672"></a><span class="lineno">10672</span>&#160;</div>
<div class="line"><a name="l10674"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab62b07a8cbcc04f20c05a468ad6de636">10674</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab62b07a8cbcc04f20c05a468ad6de636" title="compute G^ 4-force">calc_Gu</a>(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pp, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *q ,<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Gu, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Tgasreturn, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Tradreturn, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a>* chieffreturn, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *ndotffreturn, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *ndotffabsreturn, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Gabs) </div>
<div class="line"><a name="l10675"></a><span class="lineno">10675</span>&#160;{</div>
<div class="line"><a name="l10676"></a><span class="lineno">10676</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>,<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>,k;</div>
<div class="line"><a name="l10677"></a><span class="lineno">10677</span>&#160;  </div>
<div class="line"><a name="l10678"></a><span class="lineno">10678</span>&#160;  <span class="comment">//radiative stress tensor in the lab frame</span></div>
<div class="line"><a name="l10679"></a><span class="lineno">10679</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Rij[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>][<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l10680"></a><span class="lineno">10680</span>&#160;</div>
<div class="line"><a name="l10681"></a><span class="lineno">10681</span>&#160;  <span class="comment">//this call returns R^i_j, i.e., the first index is contra-variant and the last index is co-variant</span></div>
<div class="line"><a name="l10682"></a><span class="lineno">10682</span>&#160;  <a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#aba8efc1e2ea7a31f67bb6c06ce3c164a">mhdfull_calc_rad</a>(pp, ptrgeom, q, Rij);</div>
<div class="line"><a name="l10683"></a><span class="lineno">10683</span>&#160;</div>
<div class="line"><a name="l10684"></a><span class="lineno">10684</span>&#160;  <span class="comment">//the four-velocity of fluid in lab frame</span></div>
<div class="line"><a name="l10685"></a><span class="lineno">10685</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *<a class="code" href="../../d1/d83/structof__state.html#aab723d3c7c2c48b7246cc7d7d5379eed">ucon</a>,*<a class="code" href="../../d1/d83/structof__state.html#a09881c3d05809ef27f8115d02a835e11">ucov</a>;</div>
<div class="line"><a name="l10686"></a><span class="lineno">10686</span>&#160;  ucon = q-&gt;<a class="code" href="../../d1/d83/structof__state.html#aab723d3c7c2c48b7246cc7d7d5379eed">ucon</a>;</div>
<div class="line"><a name="l10687"></a><span class="lineno">10687</span>&#160;  ucov = q-&gt;<a class="code" href="../../d1/d83/structof__state.html#a09881c3d05809ef27f8115d02a835e11">ucov</a>;</div>
<div class="line"><a name="l10688"></a><span class="lineno">10688</span>&#160;  </div>
<div class="line"><a name="l10689"></a><span class="lineno">10689</span>&#160;  <span class="comment">//Eradff = R^a_b u_a u^b</span></div>
<div class="line"><a name="l10690"></a><span class="lineno">10690</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Ruu=0.; <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a59b7ef1517ff22fd4dfce4cf6d380c55" title="loop over all Dimensions; second rank loop">DLOOP</a>(i,j) Ruu+=Rij[<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>][<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>]*ucov[<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>]*ucon[<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>];</div>
<div class="line"><a name="l10691"></a><span class="lineno">10691</span>&#160;</div>
<div class="line"><a name="l10692"></a><span class="lineno">10692</span>&#160;  <span class="comment">// get relative Lorentz factor between gas and radiation</span></div>
<div class="line"><a name="l10693"></a><span class="lineno">10693</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammaradgas = 0.0;</div>
<div class="line"><a name="l10694"></a><span class="lineno">10694</span>&#160;  <span class="keywordtype">int</span> jj;</div>
<div class="line"><a name="l10695"></a><span class="lineno">10695</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) gammaradgas += - (q-&gt;<a class="code" href="../../d1/d83/structof__state.html#a09881c3d05809ef27f8115d02a835e11">ucov</a>[jj] * q-&gt;<a class="code" href="../../d1/d83/structof__state.html#a3bf8e15ee6ae95831230791baf2fc570">uradcon</a>[jj]);</div>
<div class="line"><a name="l10696"></a><span class="lineno">10696</span>&#160;</div>
<div class="line"><a name="l10697"></a><span class="lineno">10697</span>&#160;  <span class="comment">// get B</span></div>
<div class="line"><a name="l10698"></a><span class="lineno">10698</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> bsq = <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a7aac0a38641f2d6b53549677fa052a79">dot</a>(q-&gt;<a class="code" href="../../d1/d83/structof__state.html#a9a5aa459c68ba51073dd9a245c1a7798">bcon</a>, q-&gt;<a class="code" href="../../d1/d83/structof__state.html#a60ad0baeb54ce3584309ba5567a72f41">bcov</a>);</div>
<div class="line"><a name="l10699"></a><span class="lineno">10699</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> B=sqrt(bsq);</div>
<div class="line"><a name="l10700"></a><span class="lineno">10700</span>&#160;</div>
<div class="line"><a name="l10701"></a><span class="lineno">10701</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> rho=pp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>];</div>
<div class="line"><a name="l10702"></a><span class="lineno">10702</span>&#160;</div>
<div class="line"><a name="l10703"></a><span class="lineno">10703</span>&#160;  <span class="comment">// get absorption opacities</span></div>
<div class="line"><a name="l10704"></a><span class="lineno">10704</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Tgas;</div>
<div class="line"><a name="l10705"></a><span class="lineno">10705</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Tradff,nradff,expfactorradff;</div>
<div class="line"><a name="l10706"></a><span class="lineno">10706</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> kappa,kappan;</div>
<div class="line"><a name="l10707"></a><span class="lineno">10707</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> kappaemit,kappanemit;</div>
<div class="line"><a name="l10708"></a><span class="lineno">10708</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> kappaes;</div>
<div class="line"><a name="l10709"></a><span class="lineno">10709</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> lambda,nlambda;</div>
<div class="line"><a name="l10710"></a><span class="lineno">10710</span>&#160;  <a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#af8e0b77aba8b494909392ceca6f551a0" title="get {abs} and {es} in /mass * rho = 1/cm form.">calc_Tandopacityandemission</a>(pp,ptrgeom,q,Ruu,gammaradgas,B,&amp;Tgas,&amp;Tradff,&amp;nradff,&amp;expfactorradff,&amp;kappa,&amp;kappan,&amp;kappaemit,&amp;kappanemit,&amp;kappaes, &amp;lambda, &amp;nlambda);</div>
<div class="line"><a name="l10711"></a><span class="lineno">10711</span>&#160;  <span class="comment">// get chi (absorption energy opacity total)</span></div>
<div class="line"><a name="l10712"></a><span class="lineno">10712</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> chi=kappa+kappaes;</div>
<div class="line"><a name="l10713"></a><span class="lineno">10713</span>&#160;</div>
<div class="line"><a name="l10714"></a><span class="lineno">10714</span>&#160;</div>
<div class="line"><a name="l10715"></a><span class="lineno">10715</span>&#160;</div>
<div class="line"><a name="l10717"></a><span class="lineno">10717</span>&#160;  <span class="comment">// compute contravariant four-force in the lab frame</span></div>
<div class="line"><a name="l10718"></a><span class="lineno">10718</span>&#160;  </div>
<div class="line"><a name="l10719"></a><span class="lineno">10719</span>&#160;</div>
<div class="line"><a name="l10720"></a><span class="lineno">10720</span>&#160;</div>
<div class="line"><a name="l10721"></a><span class="lineno">10721</span>&#160;<span class="preprocessor">#if(0)</span></div>
<div class="line"><a name="l10722"></a><span class="lineno">10722</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l10723"></a><span class="lineno">10723</span>&#160;  <span class="comment">// Ru^\mu = R^\mu_\nu u^\nu</span></div>
<div class="line"><a name="l10724"></a><span class="lineno">10724</span>&#160;  <span class="comment">// Ruu = R^a_b u_a u^b</span></div>
<div class="line"><a name="l10725"></a><span class="lineno">10725</span>&#160;</div>
<div class="line"><a name="l10726"></a><span class="lineno">10726</span>&#160;  <span class="comment">// Ruuu^\mu = Ru^\mu + Ruu u^\mu</span></div>
<div class="line"><a name="l10727"></a><span class="lineno">10727</span>&#160;  <span class="comment">//          = R^\mu_c u^c + R^a_b u_a u^b u^\mu</span></div>
<div class="line"><a name="l10728"></a><span class="lineno">10728</span>&#160;</div>
<div class="line"><a name="l10729"></a><span class="lineno">10729</span>&#160;  <span class="comment">// Ruuu^t = R^t_t u^t + R^t_t u_t u^t u^t   + R^t_i u^i   + R^i_t u_i u^t u^t + R^t_j u_t u^j u^t</span></div>
<div class="line"><a name="l10730"></a><span class="lineno">10730</span>&#160;</div>
<div class="line"><a name="l10731"></a><span class="lineno">10731</span>&#160;  <span class="comment">// Ruuu^t = R^t_t u^t (1 + u_t u^t)         + Rus + Ruuss</span></div>
<div class="line"><a name="l10732"></a><span class="lineno">10732</span>&#160;</div>
<div class="line"><a name="l10733"></a><span class="lineno">10733</span>&#160;  <span class="comment">// (1 + u_t u^t) = 1 + u^t (u^t g_{tt} + u^i g_{ti}) = 1+ u^t^2 g_{tt} + u^t u^i g_{ti} = 1 - (\gamma/\alpha)^2 (-g_{tt}) + u^t u^i g_{ti}</span></div>
<div class="line"><a name="l10734"></a><span class="lineno">10734</span>&#160;</div>
<div class="line"><a name="l10735"></a><span class="lineno">10735</span>&#160;  <span class="comment">// = 1 - (\gamma/\alpha)^2 (-(1 + g_{tt} -1)) = 1 - (\gamma/\alpha)^2 + (\gamma/\alpha)^2 (1+g_{tt})</span></div>
<div class="line"><a name="l10736"></a><span class="lineno">10736</span>&#160;</div>
<div class="line"><a name="l10737"></a><span class="lineno">10737</span>&#160;  <span class="comment">// </span></div>
<div class="line"><a name="l10738"></a><span class="lineno">10738</span>&#160;</div>
<div class="line"><a name="l10739"></a><span class="lineno">10739</span>&#160;  <span class="comment">// get R^t_t u^t + (R^t_t u^t u_t)u^t and avoid catastrophic cancellation</span></div>
<div class="line"><a name="l10740"></a><span class="lineno">10740</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Ruuss=0.; <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a59b7ef1517ff22fd4dfce4cf6d380c55" title="loop over all Dimensions; second rank loop">DLOOP</a>(i,j) <span class="keywordflow">if</span>(i!=TT &amp;&amp; j!=TT) Ruuss+=Rij[<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>][<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>]*ucov[<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>]*ucon[<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>];</div>
<div class="line"><a name="l10741"></a><span class="lineno">10741</span>&#160;  <span class="comment">// __WORKINGONIT__: Check again.</span></div>
<div class="line"><a name="l10742"></a><span class="lineno">10742</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fact=(-ptrgeom-&gt;gcov[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(TT,TT)])*(-ptrgeom-&gt;gcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(TT,TT)]);</div>
<div class="line"><a name="l10743"></a><span class="lineno">10743</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fact2=1.0-fact;</div>
<div class="line"><a name="l10744"></a><span class="lineno">10744</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> utildecon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>]={0.0,pp[URAD1],pp[URAD2],pp[URAD3]};</div>
<div class="line"><a name="l10745"></a><span class="lineno">10745</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> utsq = 0.0,utildecov[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>]; lower_vec(utildecon,ptrgeom,utildecov); <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(j) utsq+=utildecon[<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>]*utildecov[<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>];</div>
<div class="line"><a name="l10746"></a><span class="lineno">10746</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ucontucovt = ( fact2 - utsq*fact + ucon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>]*(ucon[1]*ptrgeom-&gt;gcov[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(TT,1)]+ucon[2]*ptrgeom-&gt;gcov[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(TT,2)]+ucon[3]*ptrgeom-&gt;gcov[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(TT,3)]));</div>
<div class="line"><a name="l10747"></a><span class="lineno">10747</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Rut=Rij[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>][<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>]*ucon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>] * ucontucovt;</div>
<div class="line"><a name="l10748"></a><span class="lineno">10748</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Rus;</div>
<div class="line"><a name="l10749"></a><span class="lineno">10749</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l10750"></a><span class="lineno">10750</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l10751"></a><span class="lineno">10751</span>&#160;</div>
<div class="line"><a name="l10752"></a><span class="lineno">10752</span>&#160;</div>
<div class="line"><a name="l10753"></a><span class="lineno">10753</span>&#160;<span class="preprocessor">#if(DOCOMPTON)</span></div>
<div class="line"><a name="l10754"></a><span class="lineno">10754</span>&#160;<span class="preprocessor"></span>  <span class="keyword">extern</span> <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> <a class="code" href="../../d8/d60/init_8c.html#a9118b79d84fe3dccfed3b28ee0fd84b5">Gcompt</a>(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> rho, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Tgas, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Tradff, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Ruu);</div>
<div class="line"><a name="l10755"></a><span class="lineno">10755</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> preterm3 = <a class="code" href="../../d8/d60/init_8c.html#a9118b79d84fe3dccfed3b28ee0fd84b5">Gcompt</a>(rho,Tgas,Tradff,Ruu);</div>
<div class="line"><a name="l10756"></a><span class="lineno">10756</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l10757"></a><span class="lineno">10757</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l10758"></a><span class="lineno">10758</span>&#160;</div>
<div class="line"><a name="l10759"></a><span class="lineno">10759</span>&#160;</div>
<div class="line"><a name="l10760"></a><span class="lineno">10760</span>&#160;</div>
<div class="line"><a name="l10762"></a><span class="lineno">10762</span>&#160;  <span class="comment">// LOOP over i</span></div>
<div class="line"><a name="l10763"></a><span class="lineno">10763</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Ru,Ruuu,Ruuuabs,term1a,term1b,term2,term2abs,term3;</div>
<div class="line"><a name="l10764"></a><span class="lineno">10764</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(i){</div>
<div class="line"><a name="l10765"></a><span class="lineno">10765</span>&#160;    Ru=0.; <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(j) Ru+=Rij[<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>][<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>]*ucon[<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>];</div>
<div class="line"><a name="l10766"></a><span class="lineno">10766</span>&#160;<span class="preprocessor">#if(1)</span></div>
<div class="line"><a name="l10767"></a><span class="lineno">10767</span>&#160;<span class="preprocessor"></span>    Ruuu=(Ru + Ruu*ucon[<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>]);</div>
<div class="line"><a name="l10768"></a><span class="lineno">10768</span>&#160;    Ruuuabs=fabs(Ru) + fabs(Ruu*ucon[i]);</div>
<div class="line"><a name="l10769"></a><span class="lineno">10769</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l10770"></a><span class="lineno">10770</span>&#160;<span class="preprocessor"></span>    <span class="keywordflow">if</span>(i!=TT) Ruuu=(Ru + Ruu*ucon[<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>]);</div>
<div class="line"><a name="l10771"></a><span class="lineno">10771</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l10772"></a><span class="lineno">10772</span>&#160;      Rus=0.; <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(j) <span class="keywordflow">if</span>(j!=TT) Rus+=Rij[<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>][<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>]*ucon[<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>];</div>
<div class="line"><a name="l10773"></a><span class="lineno">10773</span>&#160;      Ruuu=Ruuss + Rus + Rut;</div>
<div class="line"><a name="l10774"></a><span class="lineno">10774</span>&#160;    }</div>
<div class="line"><a name="l10775"></a><span class="lineno">10775</span>&#160;    Ruuuabs=fabs(Ru) + fabs(Ruu*ucon[i]);</div>
<div class="line"><a name="l10776"></a><span class="lineno">10776</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l10777"></a><span class="lineno">10777</span>&#160;<span class="preprocessor"></span>  </div>
<div class="line"><a name="l10778"></a><span class="lineno">10778</span>&#160;    <span class="comment">// group by independent terms</span></div>
<div class="line"><a name="l10779"></a><span class="lineno">10779</span>&#160;    term1a = -(kappa*Ru);</div>
<div class="line"><a name="l10780"></a><span class="lineno">10780</span>&#160;    term1b = -(lambda*ucon[<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>]);</div>
<div class="line"><a name="l10781"></a><span class="lineno">10781</span>&#160;  </div>
<div class="line"><a name="l10782"></a><span class="lineno">10782</span>&#160;    term2 = -kappaes*Ruuu;</div>
<div class="line"><a name="l10783"></a><span class="lineno">10783</span>&#160;    term2abs = fabs(kappaes*Ruuuabs);</div>
<div class="line"><a name="l10784"></a><span class="lineno">10784</span>&#160;</div>
<div class="line"><a name="l10785"></a><span class="lineno">10785</span>&#160;<span class="preprocessor">#if(DOCOMPTON)</span></div>
<div class="line"><a name="l10786"></a><span class="lineno">10786</span>&#160;<span class="preprocessor"></span>    term3 = preterm3*ucon[<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>]; <span class="comment">// ASSUMPTION: in fluid frame only energy exchange, no momentum exchange.</span></div>
<div class="line"><a name="l10787"></a><span class="lineno">10787</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l10788"></a><span class="lineno">10788</span>&#160;<span class="preprocessor"></span>    term3 = 0.0;</div>
<div class="line"><a name="l10789"></a><span class="lineno">10789</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l10790"></a><span class="lineno">10790</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l10791"></a><span class="lineno">10791</span>&#160;    <span class="comment">// actual source term</span></div>
<div class="line"><a name="l10792"></a><span class="lineno">10792</span>&#160;    <span class="comment">//    Gu[i]=-chi*Ru - (kappaes*Ruu + lambda)*ucon[i] + term3;</span></div>
<div class="line"><a name="l10793"></a><span class="lineno">10793</span>&#160;    Gu[<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>] = term1a + term1b + term2 + term3;</div>
<div class="line"><a name="l10794"></a><span class="lineno">10794</span>&#160;    </div>
<div class="line"><a name="l10795"></a><span class="lineno">10795</span>&#160;    <span class="comment">// absolute magnitude of source term that can be used for estimating importance of 4-force relative to existing conserved quantities to get dtsub.  But don&#39;t split kappa terms because if those cancel then physically no contribution.</span></div>
<div class="line"><a name="l10796"></a><span class="lineno">10796</span>&#160;    Gabs[<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>] = fabs(term1a) + fabs(term1b) + fabs(term2abs) + fabs(term3);</div>
<div class="line"><a name="l10797"></a><span class="lineno">10797</span>&#160;</div>
<div class="line"><a name="l10798"></a><span class="lineno">10798</span>&#160;<span class="preprocessor">#if(0)</span></div>
<div class="line"><a name="l10799"></a><span class="lineno">10799</span>&#160;<span class="preprocessor"></span>    <span class="comment">// DEBUG:</span></div>
<div class="line"><a name="l10800"></a><span class="lineno">10800</span>&#160;    <span class="keywordflow">if</span>(ptrgeom-&gt;i==3 &amp;&amp; ptrgeom-&gt;j==26){</div>
<div class="line"><a name="l10801"></a><span class="lineno">10801</span>&#160;      dualfprintf(fail_file,<span class="stringliteral">&quot;i=%d term1a=%g term1b=%g term2=%g kappa=%g lambda=%g kappaes=%g ucon=%g Gu=%g Gabs=%g\n&quot;</span>,i,term1a,term1b,term2,kappa,lambda,kappaes,ucon[i],Gu[i],Gabs[i]);</div>
<div class="line"><a name="l10802"></a><span class="lineno">10802</span>&#160;    }</div>
<div class="line"><a name="l10803"></a><span class="lineno">10803</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l10804"></a><span class="lineno">10804</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l10805"></a><span class="lineno">10805</span>&#160;  }<span class="comment">// END LOOP over ENERGY-MOMENTUM terms</span></div>
<div class="line"><a name="l10806"></a><span class="lineno">10806</span>&#160;</div>
<div class="line"><a name="l10807"></a><span class="lineno">10807</span>&#160;</div>
<div class="line"><a name="l10808"></a><span class="lineno">10808</span>&#160;</div>
<div class="line"><a name="l10809"></a><span class="lineno">10809</span>&#160;</div>
<div class="line"><a name="l10810"></a><span class="lineno">10810</span>&#160;  <span class="comment">// return some other things that may be useful beyond Gu and Gabs</span></div>
<div class="line"><a name="l10811"></a><span class="lineno">10811</span>&#160;  *Tgasreturn=Tgas;</div>
<div class="line"><a name="l10812"></a><span class="lineno">10812</span>&#160;  *Tradreturn=Tradff;</div>
<div class="line"><a name="l10813"></a><span class="lineno">10813</span>&#160;  <span class="comment">// *expfactorradreturn=expfactorradff; // not used in return (yet)</span></div>
<div class="line"><a name="l10814"></a><span class="lineno">10814</span>&#160;  <span class="comment">// really a chi-effective that also includes lambda term in case cooling unrelated to absorption</span></div>
<div class="line"><a name="l10815"></a><span class="lineno">10815</span>&#160;  *chieffreturn=chi + lambda/(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a5bd9da451f108352614cbc457524c5b0">ERADLIMIT</a>+fabs(pp[PRAD0])); <span class="comment">// if needed</span></div>
<div class="line"><a name="l10816"></a><span class="lineno">10816</span>&#160;</div>
<div class="line"><a name="l10817"></a><span class="lineno">10817</span>&#160;</div>
<div class="line"><a name="l10818"></a><span class="lineno">10818</span>&#160;</div>
<div class="line"><a name="l10819"></a><span class="lineno">10819</span>&#160;</div>
<div class="line"><a name="l10820"></a><span class="lineno">10820</span>&#160;</div>
<div class="line"><a name="l10821"></a><span class="lineno">10821</span>&#160;  <span class="comment">// get photon number source term, dnrad/dtau in comoving frame, which acts as source term.</span></div>
<div class="line"><a name="l10822"></a><span class="lineno">10822</span>&#160;<span class="preprocessor">#if(EVOLVENRAD&amp;&amp;NRAD&gt;0)</span></div>
<div class="line"><a name="l10823"></a><span class="lineno">10823</span>&#160;<span class="preprocessor"></span>  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ndotff,ndotffabs;</div>
<div class="line"><a name="l10824"></a><span class="lineno">10824</span>&#160;  <span class="comment">// in limit that Tgas=Trad, must have balance such that ndotff-&gt;0, so nlambda must come from kappan and nradff-&gt;LTE_N</span></div>
<div class="line"><a name="l10825"></a><span class="lineno">10825</span>&#160;  ndotff = -(kappan*nradff - nlambda);</div>
<div class="line"><a name="l10826"></a><span class="lineno">10826</span>&#160;  ndotffabs = fabs(kappan*nradff) + fabs(nlambda);</div>
<div class="line"><a name="l10827"></a><span class="lineno">10827</span>&#160;  <span class="comment">// return \dot{nrad} : photon density in fluid frame per unit fluid frame time</span></div>
<div class="line"><a name="l10828"></a><span class="lineno">10828</span>&#160;  *ndotffreturn=ndotff;</div>
<div class="line"><a name="l10829"></a><span class="lineno">10829</span>&#160;  *ndotffabsreturn=ndotffabs;</div>
<div class="line"><a name="l10830"></a><span class="lineno">10830</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l10831"></a><span class="lineno">10831</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l10832"></a><span class="lineno">10832</span>&#160;</div>
<div class="line"><a name="l10833"></a><span class="lineno">10833</span>&#160;</div>
<div class="line"><a name="l10834"></a><span class="lineno">10834</span>&#160;</div>
<div class="line"><a name="l10835"></a><span class="lineno">10835</span>&#160;}</div>
<div class="line"><a name="l10836"></a><span class="lineno">10836</span>&#160;</div>
<div class="line"><a name="l10837"></a><span class="lineno">10837</span>&#160;</div>
<div class="line"><a name="l10838"></a><span class="lineno">10838</span>&#160;<span class="comment">// compute Trad with only primitive sand geometry</span></div>
<div class="line"><a name="l10839"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a3ad3833ac14b93095e76f8d915c5c9ad">10839</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a3ad3833ac14b93095e76f8d915c5c9ad">calcfull_Trad</a>(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pp, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Trad, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *nrad, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *expfactorrad)</div>
<div class="line"><a name="l10840"></a><span class="lineno">10840</span>&#160;{</div>
<div class="line"><a name="l10841"></a><span class="lineno">10841</span>&#160;</div>
<div class="line"><a name="l10842"></a><span class="lineno">10842</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> q;</div>
<div class="line"><a name="l10843"></a><span class="lineno">10843</span>&#160;  <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a11e17cd8b0594d1ad52e3594aa9f477e" title="find ucon, ucov, bcon, bcov from primitive variables when calling get_state, users of this function e...">get_state</a>(pp, ptrgeom, &amp;q);</div>
<div class="line"><a name="l10844"></a><span class="lineno">10844</span>&#160;  <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8242523b45077ccd783a2867dddb731a" title="compute Trad (also computed directly in calc_Gu() above) using only primitives (not using conserved q...">calc_Trad</a>(pp,ptrgeom,&amp;q,Trad,nrad,expfactorrad);</div>
<div class="line"><a name="l10845"></a><span class="lineno">10845</span>&#160;  </div>
<div class="line"><a name="l10846"></a><span class="lineno">10846</span>&#160;}</div>
<div class="line"><a name="l10847"></a><span class="lineno">10847</span>&#160;</div>
<div class="line"><a name="l10848"></a><span class="lineno">10848</span>&#160;</div>
<div class="line"><a name="l10850"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8242523b45077ccd783a2867dddb731a">10850</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8242523b45077ccd783a2867dddb731a" title="compute Trad (also computed directly in calc_Gu() above) using only primitives (not using conserved q...">calc_Trad</a>(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pp, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *q , <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Trad, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *nrad, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *expfactorrad)</div>
<div class="line"><a name="l10851"></a><span class="lineno">10851</span>&#160;{</div>
<div class="line"><a name="l10852"></a><span class="lineno">10852</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>,<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>,k;</div>
<div class="line"><a name="l10853"></a><span class="lineno">10853</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Tradff,nradff,expfactorradff;</div>
<div class="line"><a name="l10854"></a><span class="lineno">10854</span>&#160;</div>
<div class="line"><a name="l10855"></a><span class="lineno">10855</span>&#160;  <span class="keywordflow">if</span>(q==NULL){<span class="comment">// if q==NULL, assume don&#39;t want to do something expensive an accurate, just basics</span></div>
<div class="line"><a name="l10856"></a><span class="lineno">10856</span>&#160;    <span class="comment">// so get radiation frame things even if should have gotten fluid frame things</span></div>
<div class="line"><a name="l10857"></a><span class="lineno">10857</span>&#160;    <span class="comment">//get_state(pp, ptrgeom, &amp;q);</span></div>
<div class="line"><a name="l10858"></a><span class="lineno">10858</span>&#160;    Tradff = <a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#af07558357c906b4dfa61cd34656d9f02" title="E=urad=arad T^4 and just solve for T (this is LTE only if assume resulting T is gas T)...">calc_LTE_TfromE</a>(pp[PRAD0]);</div>
<div class="line"><a name="l10859"></a><span class="lineno">10859</span>&#160;    nradff = <a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#a3e47afcfc5c42719999d851395fd032d" title="nrad(E)">calc_LTE_NfromE</a>(pp[PRAD0]);</div>
<div class="line"><a name="l10860"></a><span class="lineno">10860</span>&#160;    expfactorradff=1.0;</div>
<div class="line"><a name="l10861"></a><span class="lineno">10861</span>&#160;  }</div>
<div class="line"><a name="l10862"></a><span class="lineno">10862</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l10863"></a><span class="lineno">10863</span>&#160;</div>
<div class="line"><a name="l10864"></a><span class="lineno">10864</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> rho=pp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>];</div>
<div class="line"><a name="l10865"></a><span class="lineno">10865</span>&#160;  </div>
<div class="line"><a name="l10866"></a><span class="lineno">10866</span>&#160;    <span class="comment">//radiative stress tensor in the lab frame</span></div>
<div class="line"><a name="l10867"></a><span class="lineno">10867</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Rij[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>][<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l10868"></a><span class="lineno">10868</span>&#160;</div>
<div class="line"><a name="l10869"></a><span class="lineno">10869</span>&#160;    <span class="comment">//this call returns R^i_j, i.e., the first index is contra-variant and the last index is co-variant</span></div>
<div class="line"><a name="l10870"></a><span class="lineno">10870</span>&#160;    <a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#aba8efc1e2ea7a31f67bb6c06ce3c164a">mhdfull_calc_rad</a>(pp, ptrgeom, q, Rij);</div>
<div class="line"><a name="l10871"></a><span class="lineno">10871</span>&#160;</div>
<div class="line"><a name="l10872"></a><span class="lineno">10872</span>&#160;    <span class="comment">//the four-velocity of fluid in lab frame</span></div>
<div class="line"><a name="l10873"></a><span class="lineno">10873</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *<a class="code" href="../../d1/d83/structof__state.html#aab723d3c7c2c48b7246cc7d7d5379eed">ucon</a>,*<a class="code" href="../../d1/d83/structof__state.html#a09881c3d05809ef27f8115d02a835e11">ucov</a>;</div>
<div class="line"><a name="l10874"></a><span class="lineno">10874</span>&#160;    ucon = q-&gt;<a class="code" href="../../d1/d83/structof__state.html#aab723d3c7c2c48b7246cc7d7d5379eed">ucon</a>;</div>
<div class="line"><a name="l10875"></a><span class="lineno">10875</span>&#160;    ucov = q-&gt;<a class="code" href="../../d1/d83/structof__state.html#a09881c3d05809ef27f8115d02a835e11">ucov</a>;</div>
<div class="line"><a name="l10876"></a><span class="lineno">10876</span>&#160;  </div>
<div class="line"><a name="l10877"></a><span class="lineno">10877</span>&#160;    <span class="comment">// Get fluid-frame radiation energy density = Eradff = R^a_b u_a u^b</span></div>
<div class="line"><a name="l10878"></a><span class="lineno">10878</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Ruu=0.; <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a59b7ef1517ff22fd4dfce4cf6d380c55" title="loop over all Dimensions; second rank loop">DLOOP</a>(i,j) Ruu+=Rij[<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>][<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>]*ucov[<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>]*ucon[<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>];</div>
<div class="line"><a name="l10879"></a><span class="lineno">10879</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammaradgas = 0.0;</div>
<div class="line"><a name="l10880"></a><span class="lineno">10880</span>&#160;    <span class="keywordtype">int</span> jj;</div>
<div class="line"><a name="l10881"></a><span class="lineno">10881</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) gammaradgas += - (q-&gt;<a class="code" href="../../d1/d83/structof__state.html#a09881c3d05809ef27f8115d02a835e11">ucov</a>[jj] * q-&gt;<a class="code" href="../../d1/d83/structof__state.html#a3bf8e15ee6ae95831230791baf2fc570">uradcon</a>[jj]);</div>
<div class="line"><a name="l10882"></a><span class="lineno">10882</span>&#160;</div>
<div class="line"><a name="l10883"></a><span class="lineno">10883</span>&#160;    <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a864793af319e70c0d099679fa81dd398" title="compute Trad (also computed directly in calc_Gu() above) using only primitives (not using conserved q...">calc_Trad_fromRuuandgamma</a>(pp, ptrgeom, Ruu, gammaradgas, &amp;Tradff, &amp;nradff, &amp;expfactorradff);</div>
<div class="line"><a name="l10884"></a><span class="lineno">10884</span>&#160;  }</div>
<div class="line"><a name="l10885"></a><span class="lineno">10885</span>&#160;</div>
<div class="line"><a name="l10886"></a><span class="lineno">10886</span>&#160;  <span class="comment">// return quantities</span></div>
<div class="line"><a name="l10887"></a><span class="lineno">10887</span>&#160;  *Trad=Tradff; <span class="comment">// radiation temperature in fluid frame</span></div>
<div class="line"><a name="l10888"></a><span class="lineno">10888</span>&#160;  *nrad=nradff; <span class="comment">// radiation number density in fluid frame</span></div>
<div class="line"><a name="l10889"></a><span class="lineno">10889</span>&#160;  *expfactorrad=expfactorradff;</div>
<div class="line"><a name="l10890"></a><span class="lineno">10890</span>&#160;}</div>
<div class="line"><a name="l10891"></a><span class="lineno">10891</span>&#160;</div>
<div class="line"><a name="l10892"></a><span class="lineno">10892</span>&#160;</div>
<div class="line"><a name="l10894"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a864793af319e70c0d099679fa81dd398">10894</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a864793af319e70c0d099679fa81dd398" title="compute Trad (also computed directly in calc_Gu() above) using only primitives (not using conserved q...">calc_Trad_fromRuuandgamma</a>(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pp, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Ruu, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammaradgas, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Trad, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *nrad, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *expfactorrad)</div>
<div class="line"><a name="l10895"></a><span class="lineno">10895</span>&#160;{</div>
<div class="line"><a name="l10896"></a><span class="lineno">10896</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Tradff,nradff,expfactorradff;</div>
<div class="line"><a name="l10897"></a><span class="lineno">10897</span>&#160;</div>
<div class="line"><a name="l10898"></a><span class="lineno">10898</span>&#160;  <span class="comment">// Get fluid-frame radiation temperature and number density</span></div>
<div class="line"><a name="l10899"></a><span class="lineno">10899</span>&#160;</div>
<div class="line"><a name="l10900"></a><span class="lineno">10900</span>&#160;</div>
<div class="line"><a name="l10901"></a><span class="lineno">10901</span>&#160;</div>
<div class="line"><a name="l10902"></a><span class="lineno">10902</span>&#160;<span class="preprocessor">#if(EVOLVENRAD==0)</span></div>
<div class="line"><a name="l10903"></a><span class="lineno">10903</span>&#160;<span class="preprocessor"></span>  <span class="comment">// ASSUMPTION: PLANCK</span></div>
<div class="line"><a name="l10904"></a><span class="lineno">10904</span>&#160;  Tradff = <a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#af07558357c906b4dfa61cd34656d9f02" title="E=urad=arad T^4 and just solve for T (this is LTE only if assume resulting T is gas T)...">calc_LTE_TfromE</a>(fabs(Ruu));</div>
<div class="line"><a name="l10905"></a><span class="lineno">10905</span>&#160;  nradff = <a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#a3e47afcfc5c42719999d851395fd032d" title="nrad(E)">calc_LTE_NfromE</a>(fabs(Ruu));</div>
<div class="line"><a name="l10906"></a><span class="lineno">10906</span>&#160;  expfactorradff=1.0; <span class="comment">// Planck</span></div>
<div class="line"><a name="l10907"></a><span class="lineno">10907</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l10908"></a><span class="lineno">10908</span>&#160;<span class="preprocessor"></span>  <span class="comment">// Color-corrected/shifted Planck</span></div>
<div class="line"><a name="l10909"></a><span class="lineno">10909</span>&#160;  nradff = pp[NRAD]*gammaradgas;</div>
<div class="line"><a name="l10910"></a><span class="lineno">10910</span>&#160;  </div>
<div class="line"><a name="l10911"></a><span class="lineno">10911</span>&#160;  <span class="comment">// 0 = assume 0 chemical potential.</span></div>
<div class="line"><a name="l10912"></a><span class="lineno">10912</span>&#160;  <span class="comment">// 1 = account for finite chemical potential using Ramesh fit</span></div>
<div class="line"><a name="l10913"></a><span class="lineno">10913</span>&#160;  <span class="comment">// 2 = like 1 but Jon fit without divergent issues.</span></div>
<div class="line"><a name="l10914"></a><span class="lineno">10914</span>&#160;  <span class="comment">// But 1,2 only change T_r by 10% at most for any Ruu,nradff, and would have to include chemical potential in opacity and use (say Jon&#39;s) chemical potential vs. Ruu,nradff fit and have \kappa(Tg,Tr,\mu).  So avoid.</span></div>
<div class="line"><a name="l10915"></a><span class="lineno">10915</span>&#160;<span class="preprocessor">#define TRADTYPE 0</span></div>
<div class="line"><a name="l10916"></a><span class="lineno">10916</span>&#160;<span class="preprocessor"></span>  </div>
<div class="line"><a name="l10917"></a><span class="lineno">10917</span>&#160;<span class="preprocessor">#if(TRADTYPE==0)</span></div>
<div class="line"><a name="l10918"></a><span class="lineno">10918</span>&#160;<span class="preprocessor"></span>  Tradff = Ruu/(nradff*<a class="code" href="../../da/d04/global_8depmnemonics_8rad_8h.html#a0f38d83a4a498cf6f9c2897f3eb6f1e8">EBAR0</a>); <span class="comment">// EBAR0 kb T = Ruu/nradff = average energy per photon</span></div>
<div class="line"><a name="l10919"></a><span class="lineno">10919</span>&#160;  expfactorradff = 1.0; <span class="comment">// but really inconsistent since should be able to get Tradff directly from Ruu if \mu=0</span></div>
<div class="line"><a name="l10920"></a><span class="lineno">10920</span>&#160;<span class="preprocessor">#elif(TRADTYPE==1)</span></div>
<div class="line"><a name="l10921"></a><span class="lineno">10921</span>&#160;<span class="preprocessor"></span>  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> CRAD = <a class="code" href="../../da/d04/global_8depmnemonics_8rad_8h.html#a8ded610d7fb238e05e68de5e2fff557c">CRAD0</a>*<a class="code" href="../../d8/d5b/defs_8general_8h.html#a591d275f967baa00b6382aff77362636">ARAD_CODE</a>;</div>
<div class="line"><a name="l10922"></a><span class="lineno">10922</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> BB = <a class="code" href="../../da/d04/global_8depmnemonics_8rad_8h.html#a8ded610d7fb238e05e68de5e2fff557c">CRAD0</a> * <a class="code" href="../../da/d04/global_8depmnemonics_8rad_8h.html#a0f38d83a4a498cf6f9c2897f3eb6f1e8">EBAR0</a>*<a class="code" href="../../da/d04/global_8depmnemonics_8rad_8h.html#a0f38d83a4a498cf6f9c2897f3eb6f1e8">EBAR0</a>*<a class="code" href="../../da/d04/global_8depmnemonics_8rad_8h.html#a0f38d83a4a498cf6f9c2897f3eb6f1e8">EBAR0</a>*<a class="code" href="../../da/d04/global_8depmnemonics_8rad_8h.html#a0f38d83a4a498cf6f9c2897f3eb6f1e8">EBAR0</a> * (3.0-<a class="code" href="../../da/d04/global_8depmnemonics_8rad_8h.html#a0f38d83a4a498cf6f9c2897f3eb6f1e8">EBAR0</a>); <span class="comment">// FTYPE BB=2.449724;</span></div>
<div class="line"><a name="l10923"></a><span class="lineno">10923</span>&#160;  <span class="comment">//       below avoids assuming that EBAR0 kb T is average energy per photon</span></div>
<div class="line"><a name="l10924"></a><span class="lineno">10924</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> EBAR1=3.0-BB*nradff*nradff*nradff*nradff/(CRAD*Ruu*Ruu*Ruu+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a09c78d2f8feb311dd9fc969a0bf84979">SMALL</a>); <span class="comment">// physically reasonable to be limited to *larger* than EBAR0</span></div>
<div class="line"><a name="l10925"></a><span class="lineno">10925</span>&#160;  <span class="keywordflow">if</span>(EBAR1&lt;<a class="code" href="../../da/d04/global_8depmnemonics_8rad_8h.html#a0f38d83a4a498cf6f9c2897f3eb6f1e8">EBAR0</a>) EBAR1=<a class="code" href="../../da/d04/global_8depmnemonics_8rad_8h.html#a0f38d83a4a498cf6f9c2897f3eb6f1e8">EBAR0</a>; <span class="comment">// hard cut</span></div>
<div class="line"><a name="l10926"></a><span class="lineno">10926</span>&#160;  <span class="comment">//if(EBAR1&lt;0.5*EBAR0) EBAR1=0.5*EBAR0; // hard cut but at lower value, allowing a bit lower than BB value that is rare but avoids Jacobian problems</span></div>
<div class="line"><a name="l10927"></a><span class="lineno">10927</span>&#160;  Tradff = Ruu/(SMALL+nradff*EBAR1); <span class="comment">// Accounts for non-zero chemical potential of photons giving them higher average energy per photon than thermal case for a given temperature</span></div>
<div class="line"><a name="l10928"></a><span class="lineno">10928</span>&#160;<span class="preprocessor">#elif(TRADTYPE==2)</span></div>
<div class="line"><a name="l10929"></a><span class="lineno">10929</span>&#160;<span class="preprocessor"></span>  Tradff = (Ruu*(0.333333333327962 + 0.060724957534625555/(0.6467556546674441 + (0.12198190033984817*CRAD*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Ruu,3))/<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(SMALL+nradff,4))))/(SMALL+nradff);</div>
<div class="line"><a name="l10930"></a><span class="lineno">10930</span>&#160;  expfactorradff = 1.6467556546674442/(0.6467556546674441 + (0.12198190033984817*CRAD*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Ruu,3))/<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(SMALL+nradff,4));</div>
<div class="line"><a name="l10931"></a><span class="lineno">10931</span>&#160;  <span class="keywordflow">if</span>(expfactorradff&gt;1.0) expfactorradff=1.0; <span class="comment">// account for BE condensation.</span></div>
<div class="line"><a name="l10932"></a><span class="lineno">10932</span>&#160;  <span class="comment">// expfactorradff = exp(-\xi) = exp(-\mu/(k_B Tradff))</span></div>
<div class="line"><a name="l10933"></a><span class="lineno">10933</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l10934"></a><span class="lineno">10934</span>&#160;<span class="preprocessor"></span>  <span class="comment">// Tradff/TradLTE = fco = color correction factor</span></div>
<div class="line"><a name="l10935"></a><span class="lineno">10935</span>&#160;  </div>
<div class="line"><a name="l10936"></a><span class="lineno">10936</span>&#160;<span class="preprocessor">#endif    </span></div>
<div class="line"><a name="l10937"></a><span class="lineno">10937</span>&#160;<span class="preprocessor"></span>  </div>
<div class="line"><a name="l10938"></a><span class="lineno">10938</span>&#160;  *Trad=Tradff; <span class="comment">// radiation temperature in fluid frame</span></div>
<div class="line"><a name="l10939"></a><span class="lineno">10939</span>&#160;  *nrad=nradff; <span class="comment">// radiation number density in fluid frame</span></div>
<div class="line"><a name="l10940"></a><span class="lineno">10940</span>&#160;  *expfactorrad=expfactorradff;<span class="comment">// expf = e^{-\mu/(k_b T_r)} for chemical potential mu of radiation</span></div>
<div class="line"><a name="l10941"></a><span class="lineno">10941</span>&#160;}</div>
<div class="line"><a name="l10942"></a><span class="lineno">10942</span>&#160;</div>
<div class="line"><a name="l10943"></a><span class="lineno">10943</span>&#160;</div>
<div class="line"><a name="l10944"></a><span class="lineno">10944</span>&#160;</div>
<div class="line"><a name="l10945"></a><span class="lineno">10945</span>&#160;</div>
<div class="line"><a name="l10946"></a><span class="lineno">10946</span>&#160;</div>
<div class="line"><a name="l10947"></a><span class="lineno">10947</span>&#160;</div>
<div class="line"><a name="l10948"></a><span class="lineno">10948</span>&#160;</div>
<div class="line"><a name="l10949"></a><span class="lineno">10949</span>&#160;</div>
<div class="line"><a name="l10950"></a><span class="lineno">10950</span>&#160;</div>
<div class="line"><a name="l10951"></a><span class="lineno">10951</span>&#160;<span class="comment">// compute approximate dRtt/Rtt based upon all source terms to be used to compare ratchangeRtt*uu vs. NUMEPSILON*uuallabs or idtsub=ratchangeRtt/realdt gives dtsub&lt;realdt</span></div>
<div class="line"><a name="l10952"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ae83fc4364d7c6bc0b717418cd5345297">10952</a></span>&#160;<span class="keyword">static</span> <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ae83fc4364d7c6bc0b717418cd5345297">calc_approx_ratchangeRtt</a>(<span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *q, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> chieff, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> realdt)</div>
<div class="line"><a name="l10953"></a><span class="lineno">10953</span>&#160;{</div>
<div class="line"><a name="l10954"></a><span class="lineno">10954</span>&#160;</div>
<div class="line"><a name="l10955"></a><span class="lineno">10955</span>&#160;  <span class="comment">// New Jon method (problem is this only makes sense in perfectly LTE.  If T gets high quickly, then G gets high before the density reacts.)</span></div>
<div class="line"><a name="l10956"></a><span class="lineno">10956</span>&#160;  <span class="comment">// this is like having a &quot;source speed&quot; of v_s\sim \tau \gamma^2 c and limiting the timestep so the source wave only reaches across a cell dxortho in time dt.</span></div>
<div class="line"><a name="l10957"></a><span class="lineno">10957</span>&#160;</div>
<div class="line"><a name="l10958"></a><span class="lineno">10958</span>&#160;</div>
<div class="line"><a name="l10959"></a><span class="lineno">10959</span>&#160;  <span class="comment">// as due to non-Compton 4-force</span></div>
<div class="line"><a name="l10960"></a><span class="lineno">10960</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ucon0=q-&gt;<a class="code" href="../../d1/d83/structof__state.html#aab723d3c7c2c48b7246cc7d7d5379eed">ucon</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>]; <span class="comment">// what enters G for dR^t_t/R^t_t from time part</span></div>
<div class="line"><a name="l10961"></a><span class="lineno">10961</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ratchangeRtt=SMALL+fabs(chieff * ucon0 * ucon0 * realdt * 1.0); <span class="comment">// 1.0 = c (2nd term with chi instead of kappaes to be severe and account for B-based term)</span></div>
<div class="line"><a name="l10962"></a><span class="lineno">10962</span>&#160;</div>
<div class="line"><a name="l10963"></a><span class="lineno">10963</span>&#160;  <span class="comment">// assume Compton term good enough with Gabs</span></div>
<div class="line"><a name="l10964"></a><span class="lineno">10964</span>&#160;</div>
<div class="line"><a name="l10965"></a><span class="lineno">10965</span>&#160;</div>
<div class="line"><a name="l10966"></a><span class="lineno">10966</span>&#160;  <span class="keywordflow">return</span>(ratchangeRtt);</div>
<div class="line"><a name="l10967"></a><span class="lineno">10967</span>&#160;  </div>
<div class="line"><a name="l10968"></a><span class="lineno">10968</span>&#160;}</div>
<div class="line"><a name="l10969"></a><span class="lineno">10969</span>&#160;</div>
<div class="line"><a name="l10970"></a><span class="lineno">10970</span>&#160;</div>
<div class="line"><a name="l10971"></a><span class="lineno">10971</span>&#160;</div>
<div class="line"><a name="l10972"></a><span class="lineno">10972</span>&#160;</div>
<div class="line"><a name="l10973"></a><span class="lineno">10973</span>&#160;</div>
<div class="line"><a name="l10975"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a56f468401f08e66966f0318198ca6e85">10975</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#a2f3df15638b9795556ef2bdf1e8c8f97" title="compute radiative characteristics as limited by opacity">vchar_rad</a>(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *q, <span class="keywordtype">int</span> dir, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *geom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *vmax, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *vmin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *vmax2, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *vmin2,<span class="keywordtype">int</span> *ignorecourant)</div>
<div class="line"><a name="l10976"></a><span class="lineno">10976</span>&#160;{</div>
<div class="line"><a name="l10977"></a><span class="lineno">10977</span>&#160;</div>
<div class="line"><a name="l10978"></a><span class="lineno">10978</span>&#160;  </div>
<div class="line"><a name="l10979"></a><span class="lineno">10979</span>&#160;  <span class="comment">// compute chi</span></div>
<div class="line"><a name="l10980"></a><span class="lineno">10980</span>&#160;  <span class="comment">// Assume computed as d\tau/dorthonormallength as defined by user.</span></div>
<div class="line"><a name="l10981"></a><span class="lineno">10981</span>&#160;  <span class="comment">// Assume \chi defined in fluid frame (i.e. not radiation frame).</span></div>
<div class="line"><a name="l10982"></a><span class="lineno">10982</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> kappa,chi;</div>
<div class="line"><a name="l10983"></a><span class="lineno">10983</span>&#160;  <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a63256be4e6a63216cb736012e36a6375">calc_chi</a>(pr,geom,q,&amp;chi);</div>
<div class="line"><a name="l10984"></a><span class="lineno">10984</span>&#160;  <span class="comment">// KORALTODO: in paper, suggests only kappaes should matter?</span></div>
<div class="line"><a name="l10985"></a><span class="lineno">10985</span>&#160;  <span class="comment">//  calc_kappa(pr,geom,q,&amp;kappa);</span></div>
<div class="line"><a name="l10986"></a><span class="lineno">10986</span>&#160;  <span class="comment">//  chi=kappa;</span></div>
<div class="line"><a name="l10987"></a><span class="lineno">10987</span>&#160;</div>
<div class="line"><a name="l10988"></a><span class="lineno">10988</span>&#160;</div>
<div class="line"><a name="l10989"></a><span class="lineno">10989</span>&#160;  <span class="comment">//characterisitic wavespeed in the radiation rest frame</span></div>
<div class="line"><a name="l10990"></a><span class="lineno">10990</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> vrad2=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a987db2b5d50589e097378a13c5d87fef">THIRD</a>;</div>
<div class="line"><a name="l10991"></a><span class="lineno">10991</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> vrad2limited;</div>
<div class="line"><a name="l10992"></a><span class="lineno">10992</span>&#160;</div>
<div class="line"><a name="l10993"></a><span class="lineno">10993</span>&#160;  <span class="keywordflow">if</span>(chi&gt;0.0){<span class="comment">// &amp;&amp; WHICHRADSOURCEMETHOD==SOURCEMETHODIMPLICIT){</span></div>
<div class="line"><a name="l10994"></a><span class="lineno">10994</span>&#160;    <span class="comment">// NOT DOING THIS:</span></div>
<div class="line"><a name="l10995"></a><span class="lineno">10995</span>&#160;    <span class="comment">// compute tautot assuming chi is optical depth per unit grid dx[1-3].  I.e. calc_chi() computes grid-based opacity</span></div>
<div class="line"><a name="l10996"></a><span class="lineno">10996</span>&#160;    <span class="comment">// tautot is the total optical depth of the cell in dim dimension</span></div>
<div class="line"><a name="l10997"></a><span class="lineno">10997</span>&#160;    <span class="comment">//  tautot = chi * dx[dir];</span></div>
<div class="line"><a name="l10998"></a><span class="lineno">10998</span>&#160;</div>
<div class="line"><a name="l10999"></a><span class="lineno">10999</span>&#160;    <span class="comment">// DOING THIS:</span></div>
<div class="line"><a name="l11000"></a><span class="lineno">11000</span>&#160;    <span class="comment">// KORALTODO: Approximation to any true path, but approximation is sufficient for approximate wave speeds.</span></div>
<div class="line"><a name="l11001"></a><span class="lineno">11001</span>&#160;    <span class="comment">// \tau_{\rm tot}^2 \approx \chi^2 [dxff^{dir} \sqrt{g_{dirdir}}]^2  where dxff is dx in fluid-frame where chi is measured</span></div>
<div class="line"><a name="l11002"></a><span class="lineno">11002</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> tautotsq,vrad2tau;</div>
<div class="line"><a name="l11003"></a><span class="lineno">11003</span>&#160;    <span class="comment">// Note that tautot is frame independent once multiple \chi by the cell length.  I.e. it&#39;s a Lorentz invariant.</span></div>
<div class="line"><a name="l11004"></a><span class="lineno">11004</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> tautot[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l11005"></a><span class="lineno">11005</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> tautotmax;</div>
<div class="line"><a name="l11006"></a><span class="lineno">11006</span>&#160;    <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a795959353203e99366b456b16d0d0bab" title="calculates total opacity over dx[] for given chi or chieff">calc_tautot_chieff</a>(pr, chi, geom, q, tautot, &amp;tautotmax);</div>
<div class="line"><a name="l11007"></a><span class="lineno">11007</span>&#160;    tautotsq = tautot[dir]*tautot[dir];</div>
<div class="line"><a name="l11008"></a><span class="lineno">11008</span>&#160;</div>
<div class="line"><a name="l11009"></a><span class="lineno">11009</span>&#160;    <span class="comment">// below previous version was not Lorentz invariant.</span></div>
<div class="line"><a name="l11010"></a><span class="lineno">11010</span>&#160;    <span class="comment">//    tautotsq = chi*chi * dx[dir]*dx[dir]*fabs(geom-&gt;gcov[GIND(dir,dir)]);</span></div>
<div class="line"><a name="l11011"></a><span class="lineno">11011</span>&#160;</div>
<div class="line"><a name="l11012"></a><span class="lineno">11012</span>&#160;    <span class="comment">//    dualfprintf(fail_file,&quot;chi=%g dx=%g dir=%d tautot=%g\n&quot;,chi,dx[dir],dir,sqrt(tautotsq));</span></div>
<div class="line"><a name="l11013"></a><span class="lineno">11013</span>&#160;  </div>
<div class="line"><a name="l11014"></a><span class="lineno">11014</span>&#160;    vrad2tau=(4.0/3.0)*(4.0/3.0)/tautotsq; <span class="comment">// KORALTODO: Why 4.0/3.0 ?  Seems like it should be 2.0/3.0 according to NR1992 S19.2.6L or NR2007 S20.2L with D=1/(3\chi), but twice higher speed is only more robust.</span></div>
<div class="line"><a name="l11015"></a><span class="lineno">11015</span>&#160;    vrad2limited=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(vrad2,vrad2tau);</div>
<div class="line"><a name="l11016"></a><span class="lineno">11016</span>&#160;</div>
<div class="line"><a name="l11017"></a><span class="lineno">11017</span>&#160;    <span class="comment">// NOTEMARK: For explicit method, this will lead to very large dt relative to step desired by explicit method, leading to ever more sub-cycles for WHICHRADSOURCEMETHOD==SOURCEMETHODEXPLICITSUBCYCLE method.</span></div>
<div class="line"><a name="l11018"></a><span class="lineno">11018</span>&#160;</div>
<div class="line"><a name="l11019"></a><span class="lineno">11019</span>&#160;    <span class="comment">// TODOMARK: I wonder if another possibility is to use a speed limiter in the advection equation. With my pseudo-Newtonian code is has a limiter on the sound and Alfven speeds following the idea of limiting the Alfven speed by Miller &amp; Stone (2000, http://adsabs.harvard.edu/abs/2000ApJ...534..398M). That is, there must be a way to insert a term into the radiation advection equations to limit the velocity to ~c/\tau that only becomes effective at and beyond that speed. Then the Jacobian would be modified (Or thinking of how the Jacobian could get modified, one gets a different equation of motion).</span></div>
<div class="line"><a name="l11020"></a><span class="lineno">11020</span>&#160;</div>
<div class="line"><a name="l11021"></a><span class="lineno">11021</span>&#160;  }</div>
<div class="line"><a name="l11022"></a><span class="lineno">11022</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l11023"></a><span class="lineno">11023</span>&#160;    vrad2limited=vrad2;</div>
<div class="line"><a name="l11024"></a><span class="lineno">11024</span>&#160;  }</div>
<div class="line"><a name="l11025"></a><span class="lineno">11025</span>&#160;</div>
<div class="line"><a name="l11026"></a><span class="lineno">11026</span>&#160;</div>
<div class="line"><a name="l11027"></a><span class="lineno">11027</span>&#160;  <span class="comment">// for setting flux so diffusive term is not exaggerated in high \tau regions</span></div>
<div class="line"><a name="l11028"></a><span class="lineno">11028</span>&#160;  <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#abd01208ba3c5754ea5587bcaefcaa01b" title="get lab-frame 3-velocity for radiative emission in radiative frame">simplefast_rad</a>(dir,geom,q,vrad2limited,vmin,vmax);</div>
<div class="line"><a name="l11029"></a><span class="lineno">11029</span>&#160;</div>
<div class="line"><a name="l11030"></a><span class="lineno">11030</span>&#160;  </div>
<div class="line"><a name="l11031"></a><span class="lineno">11031</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#af70eec68410d03110e81bd8cbc4ee4e0" title="below changes how fluxes are computed">FORCESOLVELFLUX</a>){</div>
<div class="line"><a name="l11032"></a><span class="lineno">11032</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ftemp=1.0/sqrt(fabs(geom-&gt;gcov[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(dir,dir)]));</div>
<div class="line"><a name="l11033"></a><span class="lineno">11033</span>&#160;    *vmin=-ftemp;</div>
<div class="line"><a name="l11034"></a><span class="lineno">11034</span>&#160;    *vmax=+ftemp;</div>
<div class="line"><a name="l11035"></a><span class="lineno">11035</span>&#160;  }</div>
<div class="line"><a name="l11036"></a><span class="lineno">11036</span>&#160;  <span class="comment">//    cminmaxrad_l[CMIN]=-ftemp;</span></div>
<div class="line"><a name="l11037"></a><span class="lineno">11037</span>&#160;  <span class="comment">//    cminmaxrad_l[CMAX]=+ftemp;</span></div>
<div class="line"><a name="l11038"></a><span class="lineno">11038</span>&#160;  <span class="comment">//      cminmax_calc(cminmaxrad_l[CMIN],cminmaxrad_r[CMIN],cminmaxrad_l[CMAX],cminmaxrad_r[CMAX],&amp;cminmaxrad[CMIN],&amp;cminmaxrad[CMAX],ctopradptr);</span></div>
<div class="line"><a name="l11039"></a><span class="lineno">11039</span>&#160;  <span class="comment">//      ctoprad=ftemp;</span></div>
<div class="line"><a name="l11040"></a><span class="lineno">11040</span>&#160;</div>
<div class="line"><a name="l11041"></a><span class="lineno">11041</span>&#160;<span class="preprocessor">#if(1)</span></div>
<div class="line"><a name="l11042"></a><span class="lineno">11042</span>&#160;<span class="preprocessor"></span>  *vmin2=*vmin;</div>
<div class="line"><a name="l11043"></a><span class="lineno">11043</span>&#160;  *vmax2=*vmax;</div>
<div class="line"><a name="l11044"></a><span class="lineno">11044</span>&#160;<span class="preprocessor">#elif(0)</span></div>
<div class="line"><a name="l11045"></a><span class="lineno">11045</span>&#160;<span class="preprocessor"></span>  <span class="comment">// for setting timestep since advective part has no knowledge of \tau-limited velocity</span></div>
<div class="line"><a name="l11046"></a><span class="lineno">11046</span>&#160;  <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#abd01208ba3c5754ea5587bcaefcaa01b" title="get lab-frame 3-velocity for radiative emission in radiative frame">simplefast_rad</a>(dir,geom,q,vrad2,vmin2,vmax2);</div>
<div class="line"><a name="l11047"></a><span class="lineno">11047</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l11048"></a><span class="lineno">11048</span>&#160;<span class="preprocessor"></span>  <span class="comment">// works even if not using damping of implicit solver</span></div>
<div class="line"><a name="l11049"></a><span class="lineno">11049</span>&#160;  <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#abd01208ba3c5754ea5587bcaefcaa01b" title="get lab-frame 3-velocity for radiative emission in radiative frame">simplefast_rad</a>(dir,geom,q,2.0/3.0,vmin2,vmax2);</div>
<div class="line"><a name="l11050"></a><span class="lineno">11050</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l11051"></a><span class="lineno">11051</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l11052"></a><span class="lineno">11052</span>&#160;  </div>
<div class="line"><a name="l11053"></a><span class="lineno">11053</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l11054"></a><span class="lineno">11054</span>&#160;}</div>
<div class="line"><a name="l11055"></a><span class="lineno">11055</span>&#160;</div>
<div class="line"><a name="l11057"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#abd01208ba3c5754ea5587bcaefcaa01b">11057</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#abd01208ba3c5754ea5587bcaefcaa01b" title="get lab-frame 3-velocity for radiative emission in radiative frame">simplefast_rad</a>(<span class="keywordtype">int</span> dir, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *geom,<span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *q, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> vrad2,<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *vmin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *vmax)</div>
<div class="line"><a name="l11058"></a><span class="lineno">11058</span>&#160;{</div>
<div class="line"><a name="l11059"></a><span class="lineno">11059</span>&#160;  <span class="keyword">extern</span> <span class="keywordtype">int</span> <a class="code" href="../../d8/d20/vchar_8c.html#acad033b60e7ca6404ffcd9b0fdfd13b4">simplefast</a>(<span class="keywordtype">int</span> whichcall, <span class="keywordtype">int</span> dir, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *geom,<span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *q, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> cms2,<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *vmin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *vmax);</div>
<div class="line"><a name="l11060"></a><span class="lineno">11060</span>&#160;</div>
<div class="line"><a name="l11061"></a><span class="lineno">11061</span>&#160;  <span class="comment">//need to substitute ucon,ucov with uradcon,uradcov to fool simplefast</span></div>
<div class="line"><a name="l11062"></a><span class="lineno">11062</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> <a class="code" href="../../d1/d83/structof__state.html#aab723d3c7c2c48b7246cc7d7d5379eed">ucon</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>],<a class="code" href="../../d1/d83/structof__state.html#a09881c3d05809ef27f8115d02a835e11">ucov</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l11063"></a><span class="lineno">11063</span>&#160;  <span class="keywordtype">int</span> ii;</div>
<div class="line"><a name="l11064"></a><span class="lineno">11064</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(ii){</div>
<div class="line"><a name="l11065"></a><span class="lineno">11065</span>&#160;    ucon[ii]=q-&gt;<a class="code" href="../../d1/d83/structof__state.html#aab723d3c7c2c48b7246cc7d7d5379eed">ucon</a>[ii];</div>
<div class="line"><a name="l11066"></a><span class="lineno">11066</span>&#160;    ucov[ii]=q-&gt;<a class="code" href="../../d1/d83/structof__state.html#a09881c3d05809ef27f8115d02a835e11">ucov</a>[ii];</div>
<div class="line"><a name="l11067"></a><span class="lineno">11067</span>&#160;    q-&gt;<a class="code" href="../../d1/d83/structof__state.html#aab723d3c7c2c48b7246cc7d7d5379eed">ucon</a>[ii]=q-&gt;<a class="code" href="../../d1/d83/structof__state.html#a3bf8e15ee6ae95831230791baf2fc570">uradcon</a>[ii];</div>
<div class="line"><a name="l11068"></a><span class="lineno">11068</span>&#160;    q-&gt;<a class="code" href="../../d1/d83/structof__state.html#a09881c3d05809ef27f8115d02a835e11">ucov</a>[ii]=q-&gt;<a class="code" href="../../d1/d83/structof__state.html#a87c04c4f890495e87a6682643a0c7955">uradcov</a>[ii];</div>
<div class="line"><a name="l11069"></a><span class="lineno">11069</span>&#160;  }</div>
<div class="line"><a name="l11070"></a><span class="lineno">11070</span>&#160;</div>
<div class="line"><a name="l11071"></a><span class="lineno">11071</span>&#160;  <span class="comment">//calculating vmin, vmax</span></div>
<div class="line"><a name="l11072"></a><span class="lineno">11072</span>&#160;  <a class="code" href="../../d8/d20/vchar_8c.html#acad033b60e7ca6404ffcd9b0fdfd13b4">simplefast</a>(0, dir,geom,q,vrad2,vmin,vmax); <span class="comment">// simplefast(0) means first call rather than an resursive attempt.</span></div>
<div class="line"><a name="l11073"></a><span class="lineno">11073</span>&#160;</div>
<div class="line"><a name="l11074"></a><span class="lineno">11074</span>&#160;  <span class="comment">//restoring gas 4-velocities</span></div>
<div class="line"><a name="l11075"></a><span class="lineno">11075</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(ii){</div>
<div class="line"><a name="l11076"></a><span class="lineno">11076</span>&#160;    q-&gt;<a class="code" href="../../d1/d83/structof__state.html#aab723d3c7c2c48b7246cc7d7d5379eed">ucon</a>[ii]=ucon[ii];</div>
<div class="line"><a name="l11077"></a><span class="lineno">11077</span>&#160;    q-&gt;<a class="code" href="../../d1/d83/structof__state.html#a09881c3d05809ef27f8115d02a835e11">ucov</a>[ii]=ucov[ii];</div>
<div class="line"><a name="l11078"></a><span class="lineno">11078</span>&#160;  }</div>
<div class="line"><a name="l11079"></a><span class="lineno">11079</span>&#160;</div>
<div class="line"><a name="l11080"></a><span class="lineno">11080</span>&#160;</div>
<div class="line"><a name="l11081"></a><span class="lineno">11081</span>&#160;<span class="preprocessor">#if(0)</span></div>
<div class="line"><a name="l11082"></a><span class="lineno">11082</span>&#160;<span class="preprocessor"></span>  <span class="comment">// Cartesian-Minkowski speed-of-light limit of radiation velocity</span></div>
<div class="line"><a name="l11083"></a><span class="lineno">11083</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> <a class="code" href="../../dc/dd2/newcodediff_8txt.html#a9a663b46497bd8f1608c548396d23320">dxdxp</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>][<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l11084"></a><span class="lineno">11084</span>&#160;  <a class="code" href="../../d9/de9/coord_8c.html#a0672d8c0ee4ff07c7265d0ecbc365cdc" title="normally-used dxdxp[i,j,k] = dV/dX">dxdxprim_ijk</a>(geom-&gt;i, geom-&gt;j, geom-&gt;k, geom-&gt;p, dxdxp);</div>
<div class="line"><a name="l11085"></a><span class="lineno">11085</span>&#160;  <span class="comment">// characeristic wavespeeds are 3-velocity in lab-frame</span></div>
<div class="line"><a name="l11086"></a><span class="lineno">11086</span>&#160;  *vmin=-1.0/dxdxp[dir][dir]; <span class="comment">// e.g. dxdxp = dr/dx1</span></div>
<div class="line"><a name="l11087"></a><span class="lineno">11087</span>&#160;  *vmax=+1.0/dxdxp[dir][dir];</div>
<div class="line"><a name="l11088"></a><span class="lineno">11088</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l11089"></a><span class="lineno">11089</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l11090"></a><span class="lineno">11090</span>&#160;</div>
<div class="line"><a name="l11091"></a><span class="lineno">11091</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l11092"></a><span class="lineno">11092</span>&#160;}</div>
<div class="line"><a name="l11093"></a><span class="lineno">11093</span>&#160;</div>
<div class="line"><a name="l11094"></a><span class="lineno">11094</span>&#160;</div>
<div class="line"><a name="l11096"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a8a762bf6582e6f7e1199de9c43b98454">11096</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#a8a762bf6582e6f7e1199de9c43b98454" title="Get only u^ and u_ assumine b^ and b_ not used.">get_state_uradconuradcovonly</a>(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *q)</div>
<div class="line"><a name="l11097"></a><span class="lineno">11097</span>&#160;{</div>
<div class="line"><a name="l11098"></a><span class="lineno">11098</span>&#160;  <span class="keywordtype">void</span> <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a9d8f2ff21b603eabf98bf7c100c5af7d">compute_1plusud0</a>(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *geom, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *q, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *plus1ud0); <span class="comment">// plus1ud0=(1+q-&gt;ucov[TT])</span></div>
<div class="line"><a name="l11099"></a><span class="lineno">11099</span>&#160;</div>
<div class="line"><a name="l11100"></a><span class="lineno">11100</span>&#160;  <span class="comment">// urad^\mu</span></div>
<div class="line"><a name="l11101"></a><span class="lineno">11101</span>&#160;  <span class="comment">// ucon_calc() assumes primitive velocities are in U1 through U3, but otherwise calculation is identical for radiation velocity, so just shift effective list of primitives so ucon_calc() operates on U1RAD through U3RAD</span></div>
<div class="line"><a name="l11102"></a><span class="lineno">11102</span>&#160;  <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#afc93fd4a6f7a2b87a9315d5fba5a529c">ucon_calc</a>(&amp;pr[URAD1-<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>], ptrgeom, q-&gt;<a class="code" href="../../d1/d83/structof__state.html#a3bf8e15ee6ae95831230791baf2fc570">uradcon</a>,q-&gt;<a class="code" href="../../d1/d83/structof__state.html#a146d7d52bceb5d40f0efeefa4daa6b2f">othersrad</a>) ,<span class="stringliteral">&quot;phys.c:get_state()&quot;</span>, <span class="stringliteral">&quot;ucon_calc()&quot;</span>, 1);</div>
<div class="line"><a name="l11103"></a><span class="lineno">11103</span>&#160;  <span class="comment">// urad_\mu</span></div>
<div class="line"><a name="l11104"></a><span class="lineno">11104</span>&#160;  lower_vec(q-&gt;<a class="code" href="../../d1/d83/structof__state.html#a3bf8e15ee6ae95831230791baf2fc570">uradcon</a>, ptrgeom, q-&gt;<a class="code" href="../../d1/d83/structof__state.html#a87c04c4f890495e87a6682643a0c7955">uradcov</a>);</div>
<div class="line"><a name="l11105"></a><span class="lineno">11105</span>&#160;</div>
<div class="line"><a name="l11106"></a><span class="lineno">11106</span>&#160;</div>
<div class="line"><a name="l11107"></a><span class="lineno">11107</span>&#160;  <span class="keywordflow">return</span> (0);</div>
<div class="line"><a name="l11108"></a><span class="lineno">11108</span>&#160;}</div>
<div class="line"><a name="l11109"></a><span class="lineno">11109</span>&#160;</div>
<div class="line"><a name="l11110"></a><span class="lineno">11110</span>&#160;</div>
<div class="line"><a name="l11111"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aba8efc1e2ea7a31f67bb6c06ce3c164a">11111</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#aba8efc1e2ea7a31f67bb6c06ce3c164a">mhdfull_calc_rad</a>(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *q, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*radstressdir)[NDIM])</div>
<div class="line"><a name="l11112"></a><span class="lineno">11112</span>&#160;{</div>
<div class="line"><a name="l11113"></a><span class="lineno">11113</span>&#160;  <span class="keywordtype">int</span> jj,kk;</div>
<div class="line"><a name="l11114"></a><span class="lineno">11114</span>&#160;  </div>
<div class="line"><a name="l11115"></a><span class="lineno">11115</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#a99ba7daf58b283bc831b8f507f5873a4" title="#define EOMTYPE EOMCOLDGRMHD">EOMRADTYPE</a>!=<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a993e29ef4139116d822d89bccb92180d" title="radiation equations of motion">EOMRADNONE</a>){</div>
<div class="line"><a name="l11116"></a><span class="lineno">11116</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj){</div>
<div class="line"><a name="l11117"></a><span class="lineno">11117</span>&#160;      <a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#a389bf7e41d2fd117af996e3392067cdc" title="compute radiation stres-energy tensor assuming M1 closure">mhd_calc_rad</a>( pr, jj, ptrgeom, q, &amp;(radstressdir[jj][0]) , NULL );</div>
<div class="line"><a name="l11118"></a><span class="lineno">11118</span>&#160;    }</div>
<div class="line"><a name="l11119"></a><span class="lineno">11119</span>&#160;  }</div>
<div class="line"><a name="l11120"></a><span class="lineno">11120</span>&#160;  <span class="keywordflow">else</span> <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a59b7ef1517ff22fd4dfce4cf6d380c55" title="loop over all Dimensions; second rank loop">DLOOP</a>(jj,kk) radstressdir[jj][kk]=0.0; <span class="comment">// mhd_calc_rad() called with no condition in phys.tools.c and elsewhere, and just fills normal tempo-spatial components (not RAD0-&gt;RAD3), so need to ensure zero.</span></div>
<div class="line"><a name="l11121"></a><span class="lineno">11121</span>&#160;}</div>
<div class="line"><a name="l11122"></a><span class="lineno">11122</span>&#160;</div>
<div class="line"><a name="l11124"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a980ebcc846cf2863c430106cc08fdb72">11124</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#a389bf7e41d2fd117af996e3392067cdc" title="compute radiation stres-energy tensor assuming M1 closure">mhd_calc_rad</a>(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr, <span class="keywordtype">int</span> dir, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *q, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *radstressdir, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *radstressdirabs)</div>
<div class="line"><a name="l11125"></a><span class="lineno">11125</span>&#160;{</div>
<div class="line"><a name="l11126"></a><span class="lineno">11126</span>&#160;  <span class="keywordtype">int</span> jj;</div>
<div class="line"><a name="l11127"></a><span class="lineno">11127</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> term1[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>],term2[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l11128"></a><span class="lineno">11128</span>&#160;</div>
<div class="line"><a name="l11129"></a><span class="lineno">11129</span>&#160;  <span class="comment">// R^{dir}_{jj} radiation stress-energy tensor</span></div>
<div class="line"><a name="l11130"></a><span class="lineno">11130</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#a99ba7daf58b283bc831b8f507f5873a4" title="#define EOMTYPE EOMCOLDGRMHD">EOMRADTYPE</a>==<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#aeecbb1829400fae0bc7971d41ca4222d">EOMRADEDD</a>){</div>
<div class="line"><a name="l11131"></a><span class="lineno">11131</span>&#160;    <span class="comment">// force radiation frame to be fluid frame</span></div>
<div class="line"><a name="l11132"></a><span class="lineno">11132</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj){</div>
<div class="line"><a name="l11133"></a><span class="lineno">11133</span>&#160;      term1[jj]=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a987db2b5d50589e097378a13c5d87fef">THIRD</a>*pr[PRAD0]*(4.0*q-&gt;<a class="code" href="../../d1/d83/structof__state.html#aab723d3c7c2c48b7246cc7d7d5379eed">ucon</a>[dir]*q-&gt;<a class="code" href="../../d1/d83/structof__state.html#a09881c3d05809ef27f8115d02a835e11">ucov</a>[jj]);</div>
<div class="line"><a name="l11134"></a><span class="lineno">11134</span>&#160;      term2[jj]=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a987db2b5d50589e097378a13c5d87fef">THIRD</a>*pr[PRAD0]*(<a class="code" href="../../d9/d43/global_8variousmacros_8h.html#aa5ebb2763dd5546bc40222826cea731f">delta</a>(dir,jj));</div>
<div class="line"><a name="l11135"></a><span class="lineno">11135</span>&#160;      radstressdir[jj]=term1[jj]+term2[jj];</div>
<div class="line"><a name="l11136"></a><span class="lineno">11136</span>&#160;      <span class="keywordflow">if</span>(radstressdirabs!=NULL) radstressdirabs[jj]=fabs(term1[jj])+fabs(term2[jj]);</div>
<div class="line"><a name="l11137"></a><span class="lineno">11137</span>&#160;    }</div>
<div class="line"><a name="l11138"></a><span class="lineno">11138</span>&#160;  }</div>
<div class="line"><a name="l11139"></a><span class="lineno">11139</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#a99ba7daf58b283bc831b8f507f5873a4" title="#define EOMTYPE EOMCOLDGRMHD">EOMRADTYPE</a>==<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#aef9536ef5213153f07b830f3fd1f70aa">EOMRADM1CLOSURE</a>){</div>
<div class="line"><a name="l11140"></a><span class="lineno">11140</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj){</div>
<div class="line"><a name="l11141"></a><span class="lineno">11141</span>&#160;      term1[jj]=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a987db2b5d50589e097378a13c5d87fef">THIRD</a>*pr[PRAD0]*(4.0*q-&gt;<a class="code" href="../../d1/d83/structof__state.html#a3bf8e15ee6ae95831230791baf2fc570">uradcon</a>[dir]*q-&gt;<a class="code" href="../../d1/d83/structof__state.html#a87c04c4f890495e87a6682643a0c7955">uradcov</a>[jj]);</div>
<div class="line"><a name="l11142"></a><span class="lineno">11142</span>&#160;      term2[jj]=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a987db2b5d50589e097378a13c5d87fef">THIRD</a>*pr[PRAD0]*(<a class="code" href="../../d9/d43/global_8variousmacros_8h.html#aa5ebb2763dd5546bc40222826cea731f">delta</a>(dir,jj));</div>
<div class="line"><a name="l11143"></a><span class="lineno">11143</span>&#160;      radstressdir[jj]=term1[jj]+term2[jj];</div>
<div class="line"><a name="l11144"></a><span class="lineno">11144</span>&#160;      <span class="keywordflow">if</span>(radstressdirabs!=NULL) radstressdirabs[jj]=fabs(term1[jj])+fabs(term2[jj]);</div>
<div class="line"><a name="l11145"></a><span class="lineno">11145</span>&#160;    }</div>
<div class="line"><a name="l11146"></a><span class="lineno">11146</span>&#160;  }</div>
<div class="line"><a name="l11147"></a><span class="lineno">11147</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l11148"></a><span class="lineno">11148</span>&#160;    <span class="comment">// mhd_calc_rad() called with no condition in phys.tools.c and elsewhere, and just fills normal tempo-spatial components (not RAD0-&gt;RAD3), so need to ensure zero.</span></div>
<div class="line"><a name="l11149"></a><span class="lineno">11149</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj){</div>
<div class="line"><a name="l11150"></a><span class="lineno">11150</span>&#160;      radstressdir[jj]=0.0;</div>
<div class="line"><a name="l11151"></a><span class="lineno">11151</span>&#160;      <span class="keywordflow">if</span>(radstressdirabs!=NULL) radstressdirabs[jj]=0.0;</div>
<div class="line"><a name="l11152"></a><span class="lineno">11152</span>&#160;    }</div>
<div class="line"><a name="l11153"></a><span class="lineno">11153</span>&#160;  }</div>
<div class="line"><a name="l11154"></a><span class="lineno">11154</span>&#160;</div>
<div class="line"><a name="l11155"></a><span class="lineno">11155</span>&#160;</div>
<div class="line"><a name="l11156"></a><span class="lineno">11156</span>&#160;}</div>
<div class="line"><a name="l11157"></a><span class="lineno">11157</span>&#160;</div>
<div class="line"><a name="l11159"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a949a0736746df92cb2600c6c015976e1">11159</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a949a0736746df92cb2600c6c015976e1" title="compute fluid frame orthonormal basis radiation stress-energy tensor assuming M1 closure">calc_Rij_ff</a>(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pp, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Rij[][NDIM])</div>
<div class="line"><a name="l11160"></a><span class="lineno">11160</span>&#160;{</div>
<div class="line"><a name="l11161"></a><span class="lineno">11161</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> <a class="code" href="../../d8/d60/init_8c.html#a07484107e6d9fdf38b53edf631d6511d">E</a>=pp[PRAD0];</div>
<div class="line"><a name="l11162"></a><span class="lineno">11162</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> F[NDIM-1]={pp[PRAD1],pp[PRAD2],pp[PRAD3]};</div>
<div class="line"><a name="l11163"></a><span class="lineno">11163</span>&#160;</div>
<div class="line"><a name="l11164"></a><span class="lineno">11164</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> nx,ny,nz,nlen,f;</div>
<div class="line"><a name="l11165"></a><span class="lineno">11165</span>&#160;</div>
<div class="line"><a name="l11166"></a><span class="lineno">11166</span>&#160;  nx=F[0]/<a class="code" href="../../d8/d60/init_8c.html#a07484107e6d9fdf38b53edf631d6511d">E</a>;</div>
<div class="line"><a name="l11167"></a><span class="lineno">11167</span>&#160;  ny=F[1]/<a class="code" href="../../d8/d60/init_8c.html#a07484107e6d9fdf38b53edf631d6511d">E</a>;</div>
<div class="line"><a name="l11168"></a><span class="lineno">11168</span>&#160;  nz=F[2]/<a class="code" href="../../d8/d60/init_8c.html#a07484107e6d9fdf38b53edf631d6511d">E</a>;</div>
<div class="line"><a name="l11169"></a><span class="lineno">11169</span>&#160;  nlen=sqrt(nx*nx+ny*ny+nz*nz);</div>
<div class="line"><a name="l11170"></a><span class="lineno">11170</span>&#160;  </div>
<div class="line"><a name="l11171"></a><span class="lineno">11171</span>&#160; </div>
<div class="line"><a name="l11172"></a><span class="lineno">11172</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#a99ba7daf58b283bc831b8f507f5873a4" title="#define EOMTYPE EOMCOLDGRMHD">EOMRADTYPE</a>==<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#aeecbb1829400fae0bc7971d41ca4222d">EOMRADEDD</a>){</div>
<div class="line"><a name="l11173"></a><span class="lineno">11173</span>&#160;    f=1./3.; <span class="comment">// f and Rij are both as if nx=ny=nz=0</span></div>
<div class="line"><a name="l11174"></a><span class="lineno">11174</span>&#160;    <span class="comment">//  f=(3.+4.*(nx*nx+ny*ny+nz*nz))/(5.+2.*sqrt(4.-3.*(nx*nx+ny*ny+nz*nz)));  </span></div>
<div class="line"><a name="l11175"></a><span class="lineno">11175</span>&#160;  }</div>
<div class="line"><a name="l11176"></a><span class="lineno">11176</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#a99ba7daf58b283bc831b8f507f5873a4" title="#define EOMTYPE EOMCOLDGRMHD">EOMRADTYPE</a>==<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#aef9536ef5213153f07b830f3fd1f70aa">EOMRADM1CLOSURE</a>){</div>
<div class="line"><a name="l11177"></a><span class="lineno">11177</span>&#160;</div>
<div class="line"><a name="l11178"></a><span class="lineno">11178</span>&#160;    <span class="keywordflow">if</span>(nlen&gt;=1.) f=1.; <span class="comment">// KORALTODO: limiter, but only used so far for IC</span></div>
<div class="line"><a name="l11179"></a><span class="lineno">11179</span>&#160;    <span class="keywordflow">else</span>  f=(3.+4.*(nx*nx+ny*ny+nz*nz))/(5.+2.*sqrt(4.-3.*(nx*nx+ny*ny+nz*nz)));  <span class="comment">//M1</span></div>
<div class="line"><a name="l11180"></a><span class="lineno">11180</span>&#160;  }</div>
<div class="line"><a name="l11181"></a><span class="lineno">11181</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#a99ba7daf58b283bc831b8f507f5873a4" title="#define EOMTYPE EOMCOLDGRMHD">EOMRADTYPE</a>==<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a993e29ef4139116d822d89bccb92180d" title="radiation equations of motion">EOMRADNONE</a>){</div>
<div class="line"><a name="l11182"></a><span class="lineno">11182</span>&#160;</div>
<div class="line"><a name="l11183"></a><span class="lineno">11183</span>&#160;  }</div>
<div class="line"><a name="l11184"></a><span class="lineno">11184</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l11185"></a><span class="lineno">11185</span>&#160;    dualfprintf(fail_file,<span class="stringliteral">&quot;1 No Such EOMRADTYPE=%d\n&quot;</span>,<a class="code" href="../../da/d3e/definit_8h.html#a99ba7daf58b283bc831b8f507f5873a4" title="#define EOMTYPE EOMCOLDGRMHD">EOMRADTYPE</a>);</div>
<div class="line"><a name="l11186"></a><span class="lineno">11186</span>&#160;    myexit(837453242);</div>
<div class="line"><a name="l11187"></a><span class="lineno">11187</span>&#160;  }</div>
<div class="line"><a name="l11188"></a><span class="lineno">11188</span>&#160;  </div>
<div class="line"><a name="l11190"></a><span class="lineno">11190</span>&#160;  Rij[0][0]=<a class="code" href="../../d8/d60/init_8c.html#a07484107e6d9fdf38b53edf631d6511d">E</a>;</div>
<div class="line"><a name="l11191"></a><span class="lineno">11191</span>&#160;</div>
<div class="line"><a name="l11192"></a><span class="lineno">11192</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#a99ba7daf58b283bc831b8f507f5873a4" title="#define EOMTYPE EOMCOLDGRMHD">EOMRADTYPE</a>==<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#aeecbb1829400fae0bc7971d41ca4222d">EOMRADEDD</a>){</div>
<div class="line"><a name="l11193"></a><span class="lineno">11193</span>&#160;    <span class="comment">// KORALTODO: Below 3 should be zero for Eddington approximation, but only if F=0 exactly.</span></div>
<div class="line"><a name="l11194"></a><span class="lineno">11194</span>&#160;    Rij[0][1]=Rij[1][0]=0.0;</div>
<div class="line"><a name="l11195"></a><span class="lineno">11195</span>&#160;    Rij[0][2]=Rij[2][0]=0.0;</div>
<div class="line"><a name="l11196"></a><span class="lineno">11196</span>&#160;    Rij[0][3]=Rij[3][0]=0.0;</div>
<div class="line"><a name="l11197"></a><span class="lineno">11197</span>&#160;  }</div>
<div class="line"><a name="l11198"></a><span class="lineno">11198</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#a99ba7daf58b283bc831b8f507f5873a4" title="#define EOMTYPE EOMCOLDGRMHD">EOMRADTYPE</a>==<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#aef9536ef5213153f07b830f3fd1f70aa">EOMRADM1CLOSURE</a>){</div>
<div class="line"><a name="l11199"></a><span class="lineno">11199</span>&#160;    Rij[0][1]=Rij[1][0]=F[0];</div>
<div class="line"><a name="l11200"></a><span class="lineno">11200</span>&#160;    Rij[0][2]=Rij[2][0]=F[1];</div>
<div class="line"><a name="l11201"></a><span class="lineno">11201</span>&#160;    Rij[0][3]=Rij[3][0]=F[2];</div>
<div class="line"><a name="l11202"></a><span class="lineno">11202</span>&#160;  }</div>
<div class="line"><a name="l11203"></a><span class="lineno">11203</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#a99ba7daf58b283bc831b8f507f5873a4" title="#define EOMTYPE EOMCOLDGRMHD">EOMRADTYPE</a>==<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a993e29ef4139116d822d89bccb92180d" title="radiation equations of motion">EOMRADNONE</a>){</div>
<div class="line"><a name="l11204"></a><span class="lineno">11204</span>&#160;</div>
<div class="line"><a name="l11205"></a><span class="lineno">11205</span>&#160;  }</div>
<div class="line"><a name="l11206"></a><span class="lineno">11206</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l11207"></a><span class="lineno">11207</span>&#160;    dualfprintf(fail_file,<span class="stringliteral">&quot;2 No Such EOMRADTYPE=%d\n&quot;</span>,<a class="code" href="../../da/d3e/definit_8h.html#a99ba7daf58b283bc831b8f507f5873a4" title="#define EOMTYPE EOMCOLDGRMHD">EOMRADTYPE</a>);</div>
<div class="line"><a name="l11208"></a><span class="lineno">11208</span>&#160;    myexit(837453243);</div>
<div class="line"><a name="l11209"></a><span class="lineno">11209</span>&#160;  }</div>
<div class="line"><a name="l11210"></a><span class="lineno">11210</span>&#160;</div>
<div class="line"><a name="l11211"></a><span class="lineno">11211</span>&#160;</div>
<div class="line"><a name="l11212"></a><span class="lineno">11212</span>&#160;  <span class="comment">// normalize n^i for Rij calculation</span></div>
<div class="line"><a name="l11213"></a><span class="lineno">11213</span>&#160;  <span class="keywordflow">if</span>(nlen&gt;0){</div>
<div class="line"><a name="l11214"></a><span class="lineno">11214</span>&#160;    nx/=nlen;</div>
<div class="line"><a name="l11215"></a><span class="lineno">11215</span>&#160;    ny/=nlen;</div>
<div class="line"><a name="l11216"></a><span class="lineno">11216</span>&#160;    nz/=nlen;</div>
<div class="line"><a name="l11217"></a><span class="lineno">11217</span>&#160;  }</div>
<div class="line"><a name="l11218"></a><span class="lineno">11218</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l11219"></a><span class="lineno">11219</span>&#160;    ;</div>
<div class="line"><a name="l11220"></a><span class="lineno">11220</span>&#160;  }</div>
<div class="line"><a name="l11221"></a><span class="lineno">11221</span>&#160;</div>
<div class="line"><a name="l11222"></a><span class="lineno">11222</span>&#160;  Rij[1][1]=E*(.5*(1.-f) + .5*(3.*f - 1.)*nx*nx);</div>
<div class="line"><a name="l11223"></a><span class="lineno">11223</span>&#160;  Rij[1][2]=E*(.5*(3.*f - 1.)*nx*ny);</div>
<div class="line"><a name="l11224"></a><span class="lineno">11224</span>&#160;  Rij[1][3]=E*(.5*(3.*f - 1.)*nx*nz);</div>
<div class="line"><a name="l11225"></a><span class="lineno">11225</span>&#160;</div>
<div class="line"><a name="l11226"></a><span class="lineno">11226</span>&#160;  Rij[2][1]=E*(.5*(3.*f - 1.)*ny*nx);</div>
<div class="line"><a name="l11227"></a><span class="lineno">11227</span>&#160;  Rij[2][2]=E*(.5*(1.-f) + .5*(3.*f - 1.)*ny*ny);</div>
<div class="line"><a name="l11228"></a><span class="lineno">11228</span>&#160;  Rij[2][3]=E*(.5*(3.*f - 1.)*ny*nz);</div>
<div class="line"><a name="l11229"></a><span class="lineno">11229</span>&#160;</div>
<div class="line"><a name="l11230"></a><span class="lineno">11230</span>&#160;  Rij[3][1]=E*(.5*(3.*f - 1.)*nz*nx);</div>
<div class="line"><a name="l11231"></a><span class="lineno">11231</span>&#160;  Rij[3][2]=E*(.5*(3.*f - 1.)*nz*ny);</div>
<div class="line"><a name="l11232"></a><span class="lineno">11232</span>&#160;  Rij[3][3]=E*(.5*(1.-f) + .5*(3.*f - 1.)*nz*nz);</div>
<div class="line"><a name="l11233"></a><span class="lineno">11233</span>&#160;</div>
<div class="line"><a name="l11234"></a><span class="lineno">11234</span>&#160;  <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l11235"></a><span class="lineno">11235</span>&#160;}</div>
<div class="line"><a name="l11236"></a><span class="lineno">11236</span>&#160;</div>
<div class="line"><a name="l11237"></a><span class="lineno">11237</span>&#160;</div>
<div class="line"><a name="l11238"></a><span class="lineno">11238</span>&#160;</div>
<div class="line"><a name="l11239"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#af75967c1015cdcd3d448ea3ba7782071">11239</a></span>&#160;<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> <a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#ae5672d3575bbbb87acb183714955fb7b">my_min</a>(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> aa, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> bb)</div>
<div class="line"><a name="l11240"></a><span class="lineno">11240</span>&#160;{</div>
<div class="line"><a name="l11241"></a><span class="lineno">11241</span>&#160;  <span class="keywordflow">if</span>(aa&lt;bb) <span class="keywordflow">return</span> aa;</div>
<div class="line"><a name="l11242"></a><span class="lineno">11242</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">return</span> bb;</div>
<div class="line"><a name="l11243"></a><span class="lineno">11243</span>&#160;}</div>
<div class="line"><a name="l11244"></a><span class="lineno">11244</span>&#160;</div>
<div class="line"><a name="l11245"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a267140b3112324c12f7ac5ce328da64a">11245</a></span>&#160;<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> <a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#a267140b3112324c12f7ac5ce328da64a">my_sign</a>(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> x)</div>
<div class="line"><a name="l11246"></a><span class="lineno">11246</span>&#160;{</div>
<div class="line"><a name="l11247"></a><span class="lineno">11247</span>&#160;  <span class="keywordflow">if</span>(x&gt;0.) <span class="keywordflow">return</span> 1.;</div>
<div class="line"><a name="l11248"></a><span class="lineno">11248</span>&#160;  <span class="keywordflow">if</span>(x&lt;0.) <span class="keywordflow">return</span> -1.;</div>
<div class="line"><a name="l11249"></a><span class="lineno">11249</span>&#160;  <span class="keywordflow">if</span>(x==0.) <span class="keywordflow">return</span> 0.;</div>
<div class="line"><a name="l11250"></a><span class="lineno">11250</span>&#160;  <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l11251"></a><span class="lineno">11251</span>&#160;}</div>
<div class="line"><a name="l11252"></a><span class="lineno">11252</span>&#160;</div>
<div class="line"><a name="l11253"></a><span class="lineno">11253</span>&#160;</div>
<div class="line"><a name="l11254"></a><span class="lineno">11254</span>&#160;</div>
<div class="line"><a name="l11255"></a><span class="lineno">11255</span>&#160;</div>
<div class="line"><a name="l11261"></a><span class="lineno">11261</span>&#160;<span class="keywordtype">int</span> inverse_44matrix(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> aa[][NDIM], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ia[][NDIM])</div>
<div class="line"><a name="l11262"></a><span class="lineno">11262</span>&#160;{</div>
<div class="line"><a name="l11263"></a><span class="lineno">11263</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> mat[16],dst[16];</div>
<div class="line"><a name="l11264"></a><span class="lineno">11264</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>,<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>;</div>
<div class="line"><a name="l11265"></a><span class="lineno">11265</span>&#160;  <span class="keywordflow">for</span>(i=0;i&lt;4;i++)</div>
<div class="line"><a name="l11266"></a><span class="lineno">11266</span>&#160;    <span class="keywordflow">for</span>(j=0;j&lt;4;j++)</div>
<div class="line"><a name="l11267"></a><span class="lineno">11267</span>&#160;      mat[i*4+j]=aa[i][j];</div>
<div class="line"><a name="l11268"></a><span class="lineno">11268</span>&#160;</div>
<div class="line"><a name="l11269"></a><span class="lineno">11269</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> tmp[12]; <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> src[16]; <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> det, idet;</div>
<div class="line"><a name="l11270"></a><span class="lineno">11270</span>&#160;  <span class="comment">/* transpose matrix */</span></div>
<div class="line"><a name="l11271"></a><span class="lineno">11271</span>&#160;  <span class="keywordflow">for</span> (i = 0; i &lt;4; i++)</div>
<div class="line"><a name="l11272"></a><span class="lineno">11272</span>&#160;    {</div>
<div class="line"><a name="l11273"></a><span class="lineno">11273</span>&#160;      src[<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>]=mat[i*4];</div>
<div class="line"><a name="l11274"></a><span class="lineno">11274</span>&#160;      src[i+4]=mat[i*4+1];</div>
<div class="line"><a name="l11275"></a><span class="lineno">11275</span>&#160;      src[i+8]=mat[i*4+2];</div>
<div class="line"><a name="l11276"></a><span class="lineno">11276</span>&#160;      src[i+12]=mat[i*4+3];</div>
<div class="line"><a name="l11277"></a><span class="lineno">11277</span>&#160;    }</div>
<div class="line"><a name="l11278"></a><span class="lineno">11278</span>&#160;  <span class="comment">/* calculate pairs for first 8 elements (cofactors) */</span></div>
<div class="line"><a name="l11279"></a><span class="lineno">11279</span>&#160;  tmp[0] = src[10] * src[15];</div>
<div class="line"><a name="l11280"></a><span class="lineno">11280</span>&#160;  tmp[1] = src[11] * src[14];</div>
<div class="line"><a name="l11281"></a><span class="lineno">11281</span>&#160;  tmp[2] = src[9] * src[15];</div>
<div class="line"><a name="l11282"></a><span class="lineno">11282</span>&#160;  tmp[3] = src[11] * src[13]; </div>
<div class="line"><a name="l11283"></a><span class="lineno">11283</span>&#160;  tmp[4] = src[9] * src[14]; </div>
<div class="line"><a name="l11284"></a><span class="lineno">11284</span>&#160;  tmp[5] = src[10] * src[13];</div>
<div class="line"><a name="l11285"></a><span class="lineno">11285</span>&#160;  tmp[6] = src[8] * src[15];</div>
<div class="line"><a name="l11286"></a><span class="lineno">11286</span>&#160;  tmp[7] = src[11] * src[12];</div>
<div class="line"><a name="l11287"></a><span class="lineno">11287</span>&#160;  tmp[8] = src[8] * src[14];</div>
<div class="line"><a name="l11288"></a><span class="lineno">11288</span>&#160;  tmp[9] = src[10] * src[12];</div>
<div class="line"><a name="l11289"></a><span class="lineno">11289</span>&#160;  tmp[10] = src[8] * src[13];</div>
<div class="line"><a name="l11290"></a><span class="lineno">11290</span>&#160;  tmp[11] = src[9] * src[12];</div>
<div class="line"><a name="l11291"></a><span class="lineno">11291</span>&#160;  <span class="comment">/* calculate first 8 elements (cofactors) */</span></div>
<div class="line"><a name="l11292"></a><span class="lineno">11292</span>&#160;  dst[0] = tmp[0]*src[5] + tmp[3]*src[6] + tmp[4]*src[7]; </div>
<div class="line"><a name="l11293"></a><span class="lineno">11293</span>&#160;  dst[0] -= tmp[1]*src[5] + tmp[2]*src[6] + tmp[5]*src[7];</div>
<div class="line"><a name="l11294"></a><span class="lineno">11294</span>&#160;  dst[1] = tmp[1]*src[4] + tmp[6]*src[6] + tmp[9]*src[7]; </div>
<div class="line"><a name="l11295"></a><span class="lineno">11295</span>&#160;  dst[1] -= tmp[0]*src[4] + tmp[7]*src[6] + tmp[8]*src[7]; </div>
<div class="line"><a name="l11296"></a><span class="lineno">11296</span>&#160;  dst[2] = tmp[2]*src[4] + tmp[7]*src[5] + tmp[10]*src[7];</div>
<div class="line"><a name="l11297"></a><span class="lineno">11297</span>&#160;  dst[2] -= tmp[3]*src[4] + tmp[6]*src[5] + tmp[11]*src[7]; </div>
<div class="line"><a name="l11298"></a><span class="lineno">11298</span>&#160;  dst[3] = tmp[5]*src[4] + tmp[8]*src[5] + tmp[11]*src[6]; </div>
<div class="line"><a name="l11299"></a><span class="lineno">11299</span>&#160;  dst[3] -= tmp[4]*src[4] + tmp[9]*src[5] + tmp[10]*src[6]; </div>
<div class="line"><a name="l11300"></a><span class="lineno">11300</span>&#160;  dst[4] = tmp[1]*src[1] + tmp[2]*src[2] + tmp[5]*src[3]; </div>
<div class="line"><a name="l11301"></a><span class="lineno">11301</span>&#160;  dst[4] -= tmp[0]*src[1] + tmp[3]*src[2] + tmp[4]*src[3]; </div>
<div class="line"><a name="l11302"></a><span class="lineno">11302</span>&#160;  dst[5] = tmp[0]*src[0] + tmp[7]*src[2] + tmp[8]*src[3]; </div>
<div class="line"><a name="l11303"></a><span class="lineno">11303</span>&#160;  dst[5] -= tmp[1]*src[0] + tmp[6]*src[2] + tmp[9]*src[3];</div>
<div class="line"><a name="l11304"></a><span class="lineno">11304</span>&#160;  dst[6] = tmp[3]*src[0] + tmp[6]*src[1] + tmp[11]*src[3]; </div>
<div class="line"><a name="l11305"></a><span class="lineno">11305</span>&#160;  dst[6] -= tmp[2]*src[0] + tmp[7]*src[1] + tmp[10]*src[3];</div>
<div class="line"><a name="l11306"></a><span class="lineno">11306</span>&#160;  dst[7] = tmp[4]*src[0] + tmp[9]*src[1] + tmp[10]*src[2];</div>
<div class="line"><a name="l11307"></a><span class="lineno">11307</span>&#160;  dst[7] -= tmp[5]*src[0] + tmp[8]*src[1] + tmp[11]*src[2];</div>
<div class="line"><a name="l11308"></a><span class="lineno">11308</span>&#160;  <span class="comment">/* calculate pairs for second 8 elements (cofactors) */</span></div>
<div class="line"><a name="l11309"></a><span class="lineno">11309</span>&#160;  tmp[0] = src[2]*src[7]; </div>
<div class="line"><a name="l11310"></a><span class="lineno">11310</span>&#160;  tmp[1] = src[3]*src[6];</div>
<div class="line"><a name="l11311"></a><span class="lineno">11311</span>&#160;  tmp[2] = src[1]*src[7];</div>
<div class="line"><a name="l11312"></a><span class="lineno">11312</span>&#160;  tmp[3] = src[3]*src[5]; </div>
<div class="line"><a name="l11313"></a><span class="lineno">11313</span>&#160;  tmp[4] = src[1]*src[6];</div>
<div class="line"><a name="l11314"></a><span class="lineno">11314</span>&#160;  tmp[5] = src[2]*src[5];</div>
<div class="line"><a name="l11315"></a><span class="lineno">11315</span>&#160;  tmp[6] = src[0]*src[7];</div>
<div class="line"><a name="l11316"></a><span class="lineno">11316</span>&#160;  tmp[7] = src[3]*src[4];</div>
<div class="line"><a name="l11317"></a><span class="lineno">11317</span>&#160;  tmp[8] = src[0]*src[6];</div>
<div class="line"><a name="l11318"></a><span class="lineno">11318</span>&#160;  tmp[9] = src[2]*src[4];</div>
<div class="line"><a name="l11319"></a><span class="lineno">11319</span>&#160;  tmp[10] = src[0]*src[5];</div>
<div class="line"><a name="l11320"></a><span class="lineno">11320</span>&#160;  tmp[11] = src[1]*src[4];</div>
<div class="line"><a name="l11321"></a><span class="lineno">11321</span>&#160;  <span class="comment">/* calculate second 8 elements (cofactors) */</span></div>
<div class="line"><a name="l11322"></a><span class="lineno">11322</span>&#160;  dst[8] = tmp[0]*src[13] + tmp[3]*src[14] + tmp[4]*src[15]; </div>
<div class="line"><a name="l11323"></a><span class="lineno">11323</span>&#160;  dst[8] -= tmp[1]*src[13] + tmp[2]*src[14] + tmp[5]*src[15];</div>
<div class="line"><a name="l11324"></a><span class="lineno">11324</span>&#160;  dst[9] = tmp[1]*src[12] + tmp[6]*src[14] + tmp[9]*src[15]; </div>
<div class="line"><a name="l11325"></a><span class="lineno">11325</span>&#160;  dst[9] -= tmp[0]*src[12] + tmp[7]*src[14] + tmp[8]*src[15]; </div>
<div class="line"><a name="l11326"></a><span class="lineno">11326</span>&#160;  dst[10] = tmp[2]*src[12] + tmp[7]*src[13] + tmp[10]*src[15];</div>
<div class="line"><a name="l11327"></a><span class="lineno">11327</span>&#160;  dst[10]-= tmp[3]*src[12] + tmp[6]*src[13] + tmp[11]*src[15]; </div>
<div class="line"><a name="l11328"></a><span class="lineno">11328</span>&#160;  dst[11] = tmp[5]*src[12] + tmp[8]*src[13] + tmp[11]*src[14];</div>
<div class="line"><a name="l11329"></a><span class="lineno">11329</span>&#160;  dst[11]-= tmp[4]*src[12] + tmp[9]*src[13] + tmp[10]*src[14]; </div>
<div class="line"><a name="l11330"></a><span class="lineno">11330</span>&#160;  dst[12] = tmp[2]*src[10] + tmp[5]*src[11] + tmp[1]*src[9];</div>
<div class="line"><a name="l11331"></a><span class="lineno">11331</span>&#160;  dst[12]-= tmp[4]*src[11] + tmp[0]*src[9] + tmp[3]*src[10]; </div>
<div class="line"><a name="l11332"></a><span class="lineno">11332</span>&#160;  dst[13] = tmp[8]*src[11] + tmp[0]*src[8] + tmp[7]*src[10]; </div>
<div class="line"><a name="l11333"></a><span class="lineno">11333</span>&#160;  dst[13]-= tmp[6]*src[10] + tmp[9]*src[11] + tmp[1]*src[8]; </div>
<div class="line"><a name="l11334"></a><span class="lineno">11334</span>&#160;  dst[14] = tmp[6]*src[9] + tmp[11]*src[11] + tmp[3]*src[8]; </div>
<div class="line"><a name="l11335"></a><span class="lineno">11335</span>&#160;  dst[14]-= tmp[10]*src[11] + tmp[2]*src[8] + tmp[7]*src[9]; </div>
<div class="line"><a name="l11336"></a><span class="lineno">11336</span>&#160;  dst[15] = tmp[10]*src[10] + tmp[4]*src[8] + tmp[9]*src[9]; </div>
<div class="line"><a name="l11337"></a><span class="lineno">11337</span>&#160;  dst[15]-= tmp[8]*src[9] + tmp[11]*src[10] + tmp[5]*src[8];</div>
<div class="line"><a name="l11338"></a><span class="lineno">11338</span>&#160;  <span class="comment">/* calculate determinant */</span></div>
<div class="line"><a name="l11339"></a><span class="lineno">11339</span>&#160;  det=src[0]*dst[0]+src[1]*dst[1]+src[2]*dst[2]+src[3]*dst[3];</div>
<div class="line"><a name="l11340"></a><span class="lineno">11340</span>&#160;</div>
<div class="line"><a name="l11341"></a><span class="lineno">11341</span>&#160; </div>
<div class="line"><a name="l11342"></a><span class="lineno">11342</span>&#160;  <span class="comment">/* calculate matrix inverse */</span></div>
<div class="line"><a name="l11343"></a><span class="lineno">11343</span>&#160;  idet = 1.0/det;</div>
<div class="line"><a name="l11344"></a><span class="lineno">11344</span>&#160;</div>
<div class="line"><a name="l11345"></a><span class="lineno">11345</span>&#160;  <span class="comment">//  if(isnan(idet)){</span></div>
<div class="line"><a name="l11346"></a><span class="lineno">11346</span>&#160;  <span class="keywordflow">if</span>(!<a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(idet) || !<a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(det)){</div>
<div class="line"><a name="l11347"></a><span class="lineno">11347</span>&#160;    <span class="keywordflow">if</span>(debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;idet (det=%26.15g idet=%26.15g) in inverse 4x4 zero or nan\n&quot;</span>,det,idet);</div>
<div class="line"><a name="l11348"></a><span class="lineno">11348</span>&#160;    <span class="keywordflow">return</span>(1); <span class="comment">// indicates failure</span></div>
<div class="line"><a name="l11349"></a><span class="lineno">11349</span>&#160;    <span class="comment">//    myexit(13235);</span></div>
<div class="line"><a name="l11350"></a><span class="lineno">11350</span>&#160;  }</div>
<div class="line"><a name="l11351"></a><span class="lineno">11351</span>&#160;</div>
<div class="line"><a name="l11352"></a><span class="lineno">11352</span>&#160;  <span class="keywordflow">for</span> (j = 0; j &lt; 16; j++)</div>
<div class="line"><a name="l11353"></a><span class="lineno">11353</span>&#160;    dst[j] *= idet;</div>
<div class="line"><a name="l11354"></a><span class="lineno">11354</span>&#160;</div>
<div class="line"><a name="l11355"></a><span class="lineno">11355</span>&#160;  <span class="keywordflow">for</span>(i=0;i&lt;4;i++)</div>
<div class="line"><a name="l11356"></a><span class="lineno">11356</span>&#160;    <span class="keywordflow">for</span>(j=0;j&lt;4;j++)</div>
<div class="line"><a name="l11357"></a><span class="lineno">11357</span>&#160;      ia[i][j]= dst[i*4+j];</div>
<div class="line"><a name="l11358"></a><span class="lineno">11358</span>&#160;</div>
<div class="line"><a name="l11359"></a><span class="lineno">11359</span>&#160;  <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l11360"></a><span class="lineno">11360</span>&#160;}</div>
<div class="line"><a name="l11361"></a><span class="lineno">11361</span>&#160;</div>
<div class="line"><a name="l11362"></a><span class="lineno">11362</span>&#160;</div>
<div class="line"><a name="l11363"></a><span class="lineno">11363</span>&#160;</div>
<div class="line"><a name="l11369"></a><span class="lineno">11369</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> inverse_33matrix(<span class="keywordtype">int</span> sj, <span class="keywordtype">int</span> ej, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> aa[][NDIM], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ia[][NDIM])</div>
<div class="line"><a name="l11370"></a><span class="lineno">11370</span>&#160;{</div>
<div class="line"><a name="l11371"></a><span class="lineno">11371</span>&#160;</div>
<div class="line"><a name="l11372"></a><span class="lineno">11372</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> det = +aa[sj+0][sj+0]*(aa[sj+1][sj+1]*aa[sj+2][sj+2]-aa[sj+2][sj+1]*aa[sj+1][sj+2])</div>
<div class="line"><a name="l11373"></a><span class="lineno">11373</span>&#160;    -aa[sj+0][sj+1]*(aa[sj+1][sj+0]*aa[sj+2][sj+2]-aa[sj+1][sj+2]*aa[sj+2][sj+0])</div>
<div class="line"><a name="l11374"></a><span class="lineno">11374</span>&#160;    +aa[sj+0][sj+2]*(aa[sj+1][sj+0]*aa[sj+2][sj+1]-aa[sj+1][sj+1]*aa[sj+2][sj+0]);</div>
<div class="line"><a name="l11375"></a><span class="lineno">11375</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> idet = 1.0/det;</div>
<div class="line"><a name="l11376"></a><span class="lineno">11376</span>&#160;  ia[sj+0][sj+0] =  (aa[sj+1][sj+1]*aa[sj+2][sj+2]-aa[sj+2][sj+1]*aa[sj+1][sj+2])*idet;</div>
<div class="line"><a name="l11377"></a><span class="lineno">11377</span>&#160;  ia[sj+1][sj+0] = -(aa[sj+0][sj+1]*aa[sj+2][sj+2]-aa[sj+0][sj+2]*aa[sj+2][sj+1])*idet;</div>
<div class="line"><a name="l11378"></a><span class="lineno">11378</span>&#160;  ia[sj+2][sj+0] =  (aa[sj+0][sj+1]*aa[sj+1][sj+2]-aa[sj+0][sj+2]*aa[sj+1][sj+1])*idet;</div>
<div class="line"><a name="l11379"></a><span class="lineno">11379</span>&#160;  ia[sj+0][sj+1] = -(aa[sj+1][sj+0]*aa[sj+2][sj+2]-aa[sj+1][sj+2]*aa[sj+2][sj+0])*idet;</div>
<div class="line"><a name="l11380"></a><span class="lineno">11380</span>&#160;  ia[sj+1][sj+1] =  (aa[sj+0][sj+0]*aa[sj+2][sj+2]-aa[sj+0][sj+2]*aa[sj+2][sj+0])*idet;</div>
<div class="line"><a name="l11381"></a><span class="lineno">11381</span>&#160;  ia[sj+2][sj+1] = -(aa[sj+0][sj+0]*aa[sj+1][sj+2]-aa[sj+1][sj+0]*aa[sj+0][sj+2])*idet;</div>
<div class="line"><a name="l11382"></a><span class="lineno">11382</span>&#160;  ia[sj+0][sj+2] =  (aa[sj+1][sj+0]*aa[sj+2][sj+1]-aa[sj+2][sj+0]*aa[sj+1][sj+1])*idet;</div>
<div class="line"><a name="l11383"></a><span class="lineno">11383</span>&#160;  ia[sj+1][sj+2] = -(aa[sj+0][sj+0]*aa[sj+2][sj+1]-aa[sj+2][sj+0]*aa[sj+0][sj+1])*idet;</div>
<div class="line"><a name="l11384"></a><span class="lineno">11384</span>&#160;  ia[sj+2][sj+2] =  (aa[sj+0][sj+0]*aa[sj+1][sj+1]-aa[sj+1][sj+0]*aa[sj+0][sj+1])*idet;</div>
<div class="line"><a name="l11385"></a><span class="lineno">11385</span>&#160;</div>
<div class="line"><a name="l11386"></a><span class="lineno">11386</span>&#160;  <span class="keywordflow">if</span>(!<a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(det) || !<a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(idet)){</div>
<div class="line"><a name="l11387"></a><span class="lineno">11387</span>&#160;    <span class="keywordflow">if</span>(debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;inverse_33matrix got singular det=%g idet=%g\n&quot;</span>,det,idet);</div>
<div class="line"><a name="l11388"></a><span class="lineno">11388</span>&#160;    <span class="keywordflow">return</span>(1); <span class="comment">// indicates failure</span></div>
<div class="line"><a name="l11389"></a><span class="lineno">11389</span>&#160;    <span class="comment">//    myexit(13235);</span></div>
<div class="line"><a name="l11390"></a><span class="lineno">11390</span>&#160;  }</div>
<div class="line"><a name="l11391"></a><span class="lineno">11391</span>&#160;</div>
<div class="line"><a name="l11392"></a><span class="lineno">11392</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l11393"></a><span class="lineno">11393</span>&#160;}</div>
<div class="line"><a name="l11394"></a><span class="lineno">11394</span>&#160;</div>
<div class="line"><a name="l11395"></a><span class="lineno">11395</span>&#160;</div>
<div class="line"><a name="l11401"></a><span class="lineno">11401</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> inverse_11matrix(<span class="keywordtype">int</span> sj, <span class="keywordtype">int</span> ej, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> aa[][NDIM], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ia[][NDIM])</div>
<div class="line"><a name="l11402"></a><span class="lineno">11402</span>&#160;{</div>
<div class="line"><a name="l11403"></a><span class="lineno">11403</span>&#160;  <span class="comment">// trivial inversion, and can&#39;t fail unless divide by zero</span></div>
<div class="line"><a name="l11404"></a><span class="lineno">11404</span>&#160;  <span class="comment">// sj==ru-&gt;endjac</span></div>
<div class="line"><a name="l11405"></a><span class="lineno">11405</span>&#160;</div>
<div class="line"><a name="l11406"></a><span class="lineno">11406</span>&#160;  ia[sj][sj]=1.0/aa[sj][sj];</div>
<div class="line"><a name="l11407"></a><span class="lineno">11407</span>&#160;</div>
<div class="line"><a name="l11408"></a><span class="lineno">11408</span>&#160;  <span class="keywordflow">if</span>(!<a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(ia[sj][sj])){</div>
<div class="line"><a name="l11409"></a><span class="lineno">11409</span>&#160;    <span class="keywordflow">if</span>(debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;inverse 1x1 zero or nan\n&quot;</span>,aa[sj][sj]);</div>
<div class="line"><a name="l11410"></a><span class="lineno">11410</span>&#160;    <span class="keywordflow">return</span>(1); <span class="comment">// indicates failure</span></div>
<div class="line"><a name="l11411"></a><span class="lineno">11411</span>&#160;    <span class="comment">//    myexit(13235);</span></div>
<div class="line"><a name="l11412"></a><span class="lineno">11412</span>&#160;  }</div>
<div class="line"><a name="l11413"></a><span class="lineno">11413</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l11414"></a><span class="lineno">11414</span>&#160;</div>
<div class="line"><a name="l11415"></a><span class="lineno">11415</span>&#160;}</div>
<div class="line"><a name="l11416"></a><span class="lineno">11416</span>&#160;</div>
<div class="line"><a name="l11417"></a><span class="lineno">11417</span>&#160;</div>
<div class="line"><a name="l11418"></a><span class="lineno">11418</span>&#160;</div>
<div class="line"><a name="l11419"></a><span class="lineno">11419</span>&#160;</div>
<div class="line"><a name="l11420"></a><span class="lineno">11420</span>&#160;</div>
<div class="line"><a name="l11432"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#af50896d039d660550b738862b3390b07">11432</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#af50896d039d660550b738862b3390b07" title="radiative ortonormal ff primitives (E,F^i) &lt;-&gt; primitives in lab frame Used only for initial conditio...">prad_fforlab</a>(<span class="keywordtype">int</span> *whichvel, <span class="keywordtype">int</span> *<a class="code" href="../../dc/dd2/newcodediff_8txt.html#ab29c7802084b56a574b83eb818d2fdda">whichcoord</a>, <span class="keywordtype">int</span> whichdir, <span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k, <span class="keywordtype">int</span> loc, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pradffortho, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pout)</div>
<div class="line"><a name="l11433"></a><span class="lineno">11433</span>&#160;{</div>
<div class="line"><a name="l11434"></a><span class="lineno">11434</span>&#160;</div>
<div class="line"><a name="l11435"></a><span class="lineno">11435</span>&#160;  <span class="keywordflow">if</span>(whichdir==<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a0f3447461a389d1bef312bd4a6e84dd9">FF2LAB</a>) <a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#a2ec6ee79c76351868a725b22dac62135" title="like prad_fforlab() but for only whichdir=FF2LAB used for IC">prad_fftolab</a>(whichvel, whichcoord, i, j, k, loc, ptrgeom, pradffortho, pin, pout);</div>
<div class="line"><a name="l11436"></a><span class="lineno">11436</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(whichdir==<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a88a1143fe44212183756a9ca513c160c">LAB2FF</a>) <a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#ad1313c275fb108d10f866373d9bb227a" title="like prad_fforlab() but for only whichdir=LAB2FF used for dumps or diags">prad_labtoff</a>(whichvel, whichcoord, i, j, k, loc, ptrgeom, pradffortho, pin, pout);</div>
<div class="line"><a name="l11437"></a><span class="lineno">11437</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l11438"></a><span class="lineno">11438</span>&#160;    dualfprintf(fail_file,<span class="stringliteral">&quot;prad_fforlab() not yet setup for whichdir=%d.&quot;</span>,whichdir);</div>
<div class="line"><a name="l11439"></a><span class="lineno">11439</span>&#160;    myexit(652526624);</div>
<div class="line"><a name="l11440"></a><span class="lineno">11440</span>&#160;  }</div>
<div class="line"><a name="l11441"></a><span class="lineno">11441</span>&#160;</div>
<div class="line"><a name="l11442"></a><span class="lineno">11442</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l11443"></a><span class="lineno">11443</span>&#160;</div>
<div class="line"><a name="l11444"></a><span class="lineno">11444</span>&#160;}</div>
<div class="line"><a name="l11445"></a><span class="lineno">11445</span>&#160;</div>
<div class="line"><a name="l11448"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad1313c275fb108d10f866373d9bb227a">11448</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#ad1313c275fb108d10f866373d9bb227a" title="like prad_fforlab() but for only whichdir=LAB2FF used for dumps or diags">prad_labtoff</a>(<span class="keywordtype">int</span> *whichvel, <span class="keywordtype">int</span> *<a class="code" href="../../dc/dd2/newcodediff_8txt.html#ab29c7802084b56a574b83eb818d2fdda">whichcoord</a>, <span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k, <span class="keywordtype">int</span> loc, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pradffortho, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pout)</div>
<div class="line"><a name="l11449"></a><span class="lineno">11449</span>&#160;{</div>
<div class="line"><a name="l11450"></a><span class="lineno">11450</span>&#160;  <span class="keywordtype">int</span> jj;</div>
<div class="line"><a name="l11451"></a><span class="lineno">11451</span>&#160;</div>
<div class="line"><a name="l11452"></a><span class="lineno">11452</span>&#160;  <span class="comment">//  DLOOPA(jj) dualfprintf(fail_file,&quot;ijk=%d %d %d : jj=%d pin=%g\n&quot;,i,j,k,jj,pin[PRAD0+jj]);</span></div>
<div class="line"><a name="l11453"></a><span class="lineno">11453</span>&#160;</div>
<div class="line"><a name="l11454"></a><span class="lineno">11454</span>&#160;  <span class="comment">// assume ptrgeom is PRIMECOORDS lab-frame geometry</span></div>
<div class="line"><a name="l11455"></a><span class="lineno">11455</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> geomdontuse;</div>
<div class="line"><a name="l11456"></a><span class="lineno">11456</span>&#160;  <span class="keywordflow">if</span>(ptrgeom==NULL){</div>
<div class="line"><a name="l11457"></a><span class="lineno">11457</span>&#160;    ptrgeom=&amp;geomdontuse;</div>
<div class="line"><a name="l11458"></a><span class="lineno">11458</span>&#160;    <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a3059ed7bfcfb692cbe8014d55fd7c1e4">get_geometry</a>(i, j, k, loc, ptrgeom);</div>
<div class="line"><a name="l11459"></a><span class="lineno">11459</span>&#160;  }</div>
<div class="line"><a name="l11460"></a><span class="lineno">11460</span>&#160;</div>
<div class="line"><a name="l11461"></a><span class="lineno">11461</span>&#160;</div>
<div class="line"><a name="l11462"></a><span class="lineno">11462</span>&#160;  </div>
<div class="line"><a name="l11463"></a><span class="lineno">11463</span>&#160;  <span class="comment">// get state</span></div>
<div class="line"><a name="l11464"></a><span class="lineno">11464</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> q;</div>
<div class="line"><a name="l11465"></a><span class="lineno">11465</span>&#160;  <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a11e17cd8b0594d1ad52e3594aa9f477e" title="find ucon, ucov, bcon, bcov from primitive variables when calling get_state, users of this function e...">get_state</a>(pin,ptrgeom,&amp;q);</div>
<div class="line"><a name="l11466"></a><span class="lineno">11466</span>&#160;</div>
<div class="line"><a name="l11467"></a><span class="lineno">11467</span>&#160;  <span class="comment">//  DLOOPA(jj) dualfprintf(fail_file,&quot;ijk=%d %d %d : jj=%d uradcon=%g uradcov=%g\n&quot;,i,j,k,jj,q.uradcon[jj],q.uradcov[jj]);</span></div>
<div class="line"><a name="l11468"></a><span class="lineno">11468</span>&#160;</div>
<div class="line"><a name="l11469"></a><span class="lineno">11469</span>&#160;</div>
<div class="line"><a name="l11470"></a><span class="lineno">11470</span>&#160;  <span class="comment">// get lab-frame R^\mu_\nu</span></div>
<div class="line"><a name="l11471"></a><span class="lineno">11471</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Rijlab[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>][<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l11472"></a><span class="lineno">11472</span>&#160;  <a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#aba8efc1e2ea7a31f67bb6c06ce3c164a">mhdfull_calc_rad</a>(pin, ptrgeom, &amp;q, Rijlab);</div>
<div class="line"><a name="l11473"></a><span class="lineno">11473</span>&#160;</div>
<div class="line"><a name="l11474"></a><span class="lineno">11474</span>&#160;<span class="preprocessor">#if(0) // STAY AS ZERO</span></div>
<div class="line"><a name="l11475"></a><span class="lineno">11475</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l11476"></a><span class="lineno">11476</span>&#160;  <span class="comment">// get U=R^t_\mu [harm type]</span></div>
<div class="line"><a name="l11477"></a><span class="lineno">11477</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> U[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l11478"></a><span class="lineno">11478</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) U[jj]=Rijlab[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>][jj];</div>
<div class="line"><a name="l11479"></a><span class="lineno">11479</span>&#160;</div>
<div class="line"><a name="l11480"></a><span class="lineno">11480</span>&#160;  <span class="comment">//  DLOOPA(jj) dualfprintf(fail_file,&quot;ijk=%d %d %d : jj=%d U=%g ucon=%g ucov=%g\n&quot;,i,j,k,jj,U[jj],q.ucon[jj],q.ucov[jj]);</span></div>
<div class="line"><a name="l11481"></a><span class="lineno">11481</span>&#160;</div>
<div class="line"><a name="l11482"></a><span class="lineno">11482</span>&#160;  <span class="comment">// transform lab-frame R^t_\nu [harm type] to fluid-frame version</span></div>
<div class="line"><a name="l11483"></a><span class="lineno">11483</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Uff[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l11484"></a><span class="lineno">11484</span>&#160;  <a class="code" href="../../d5/d0a/tetrad_8c.html#ae8d70957690f267632e5db4f4b06a490" title="Wrapper for vector_lab2orthofluidorback()">vector_harm2orthofluidorback</a>(<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a94d83bcb35c53a4419b7afddc7998916">TYPEUCOV</a>, <a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a88a1143fe44212183756a9ca513c160c">LAB2FF</a>, ptrgeom, <a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a2bbc1db2b84f7d7738a65be5cdeda4e0">TYPEUCON</a>, q.<a class="code" href="../../d1/d83/structof__state.html#aab723d3c7c2c48b7246cc7d7d5379eed">ucon</a>, <a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a94d83bcb35c53a4419b7afddc7998916">TYPEUCOV</a>, U, Uff);</div>
<div class="line"><a name="l11485"></a><span class="lineno">11485</span>&#160;</div>
<div class="line"><a name="l11486"></a><span class="lineno">11486</span>&#160;  <span class="comment">//  DLOOPA(jj) dualfprintf(fail_file,&quot;ijk=%d %d %d : jj=%d Uff=%g alpha=%g\n&quot;,i,j,k,jj,Uff[jj],ptrgeom-&gt;alphalapse);</span></div>
<div class="line"><a name="l11487"></a><span class="lineno">11487</span>&#160;</div>
<div class="line"><a name="l11488"></a><span class="lineno">11488</span>&#160;  <span class="comment">//                            00 01 02 03 11 12 13 22 23 33</span></div>
<div class="line"><a name="l11489"></a><span class="lineno">11489</span>&#160;  <span class="comment">//  FTYPE etamink[SYMMATRIXNDIM]={-1 ,0 ,0 ,0, 1 ,0 ,0 ,1 ,0 ,1};</span></div>
<div class="line"><a name="l11490"></a><span class="lineno">11490</span>&#160;  Uff[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>]*=1.0; <span class="comment">// if original was R_\mu get R^\mu in fluid frame orthonormal basis</span></div>
<div class="line"><a name="l11491"></a><span class="lineno">11491</span>&#160;</div>
<div class="line"><a name="l11492"></a><span class="lineno">11492</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) pradffortho[PRAD0+jj] = Uff[jj];</div>
<div class="line"><a name="l11493"></a><span class="lineno">11493</span>&#160;</div>
<div class="line"><a name="l11494"></a><span class="lineno">11494</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l11495"></a><span class="lineno">11495</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l11496"></a><span class="lineno">11496</span>&#160;  <span class="comment">//  int kk;</span></div>
<div class="line"><a name="l11497"></a><span class="lineno">11497</span>&#160;  <span class="comment">//  DLOOP(jj,kk) dualfprintf(fail_file,&quot;gn%d%d=%21.15g\n&quot;,jj+1,kk+1,ptrgeom-&gt;gcon[GIND(jj,kk)]);</span></div>
<div class="line"><a name="l11498"></a><span class="lineno">11498</span>&#160;  <span class="comment">//  DLOOP(jj,kk) dualfprintf(fail_file,&quot;gv%d%d=%21.15g\n&quot;,jj+1,kk+1,ptrgeom-&gt;gcov[GIND(jj,kk)]);</span></div>
<div class="line"><a name="l11499"></a><span class="lineno">11499</span>&#160;</div>
<div class="line"><a name="l11500"></a><span class="lineno">11500</span>&#160;  indices_2122(Rijlab,Rijlab,ptrgeom);</div>
<div class="line"><a name="l11501"></a><span class="lineno">11501</span>&#160;</div>
<div class="line"><a name="l11502"></a><span class="lineno">11502</span>&#160;  <span class="comment">// Need to use full Rijlab since can be mixing between components in general</span></div>
<div class="line"><a name="l11503"></a><span class="lineno">11503</span>&#160;  <span class="comment">// transform and boost (ultimately converts pin -&gt; Rijlab-&gt; pradffortho -&gt; Rijff effectively)</span></div>
<div class="line"><a name="l11504"></a><span class="lineno">11504</span>&#160;  <span class="keywordtype">int</span> tconcovtypeA=<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a2bbc1db2b84f7d7738a65be5cdeda4e0">TYPEUCON</a>;</div>
<div class="line"><a name="l11505"></a><span class="lineno">11505</span>&#160;  <span class="keywordtype">int</span> tconcovtypeB=<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a2bbc1db2b84f7d7738a65be5cdeda4e0">TYPEUCON</a>;</div>
<div class="line"><a name="l11506"></a><span class="lineno">11506</span>&#160;  <span class="keywordtype">int</span> primcoord=1;<span class="comment">// 1 so that will use optimal way to get tetrads</span></div>
<div class="line"><a name="l11507"></a><span class="lineno">11507</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Rijff[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>][<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l11508"></a><span class="lineno">11508</span>&#160;  <a class="code" href="../../d5/d0a/tetrad_8c.html#a6999a0ba04240d0dcbe3ae46adba0510" title="convert lab frame 4-tensor to fluid frame orthonormal 4-tensor">tensor_lab2orthofluidorback</a>(primcoord, <a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a88a1143fe44212183756a9ca513c160c">LAB2FF</a>, ptrgeom, <a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a2bbc1db2b84f7d7738a65be5cdeda4e0">TYPEUCON</a>, q.<a class="code" href="../../d1/d83/structof__state.html#aab723d3c7c2c48b7246cc7d7d5379eed">ucon</a>, tconcovtypeA, tconcovtypeB, Rijlab, Rijff);</div>
<div class="line"><a name="l11509"></a><span class="lineno">11509</span>&#160;</div>
<div class="line"><a name="l11510"></a><span class="lineno">11510</span>&#160;  <span class="comment">//  DLOOPA(jj) dualfprintf(fail_file,&quot;ijk=%d %d %d : jj=%d Rijff[TT]=%g alpha=%g\n&quot;,i,j,k,jj,Rijff[TT][jj],ptrgeom-&gt;alphalapse);</span></div>
<div class="line"><a name="l11511"></a><span class="lineno">11511</span>&#160;</div>
<div class="line"><a name="l11512"></a><span class="lineno">11512</span>&#160;  <span class="comment">// get in pradffortho form</span></div>
<div class="line"><a name="l11513"></a><span class="lineno">11513</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) pradffortho[PRAD0+jj] = Rijff[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>][jj];</div>
<div class="line"><a name="l11514"></a><span class="lineno">11514</span>&#160;  </div>
<div class="line"><a name="l11515"></a><span class="lineno">11515</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l11516"></a><span class="lineno">11516</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l11517"></a><span class="lineno">11517</span>&#160;  <span class="comment">// just copy pout</span></div>
<div class="line"><a name="l11518"></a><span class="lineno">11518</span>&#160;  <span class="keywordtype">int</span> pliter,pl;</div>
<div class="line"><a name="l11519"></a><span class="lineno">11519</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) pout[pl]=pin[pl];</div>
<div class="line"><a name="l11520"></a><span class="lineno">11520</span>&#160;</div>
<div class="line"><a name="l11521"></a><span class="lineno">11521</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l11522"></a><span class="lineno">11522</span>&#160;}</div>
<div class="line"><a name="l11523"></a><span class="lineno">11523</span>&#160;</div>
<div class="line"><a name="l11526"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a2ec6ee79c76351868a725b22dac62135">11526</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#a2ec6ee79c76351868a725b22dac62135" title="like prad_fforlab() but for only whichdir=FF2LAB used for IC">prad_fftolab</a>(<span class="keywordtype">int</span> *whichvel, <span class="keywordtype">int</span> *<a class="code" href="../../dc/dd2/newcodediff_8txt.html#ab29c7802084b56a574b83eb818d2fdda">whichcoord</a>, <span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k, <span class="keywordtype">int</span> loc, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pradffortho, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pout)</div>
<div class="line"><a name="l11527"></a><span class="lineno">11527</span>&#160;{</div>
<div class="line"><a name="l11528"></a><span class="lineno">11528</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Rijff[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>][<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>],Rijlab[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>][<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>],U[NPR]={0};</div>
<div class="line"><a name="l11529"></a><span class="lineno">11529</span>&#160;  <span class="keywordtype">int</span> pliter,pl;</div>
<div class="line"><a name="l11530"></a><span class="lineno">11530</span>&#160;  <span class="keywordtype">int</span> primcoord;</div>
<div class="line"><a name="l11531"></a><span class="lineno">11531</span>&#160;  <span class="keywordtype">int</span> jj,kk;</div>
<div class="line"><a name="l11532"></a><span class="lineno">11532</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> geomtousedontuse;</div>
<div class="line"><a name="l11533"></a><span class="lineno">11533</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeomtouse=&amp;geomtousedontuse;</div>
<div class="line"><a name="l11534"></a><span class="lineno">11534</span>&#160;</div>
<div class="line"><a name="l11535"></a><span class="lineno">11535</span>&#160;</div>
<div class="line"><a name="l11536"></a><span class="lineno">11536</span>&#160;  <span class="keywordflow">if</span>(ptrgeom==NULL){</div>
<div class="line"><a name="l11537"></a><span class="lineno">11537</span>&#160;    <span class="keywordflow">if</span>(*whichcoord!=<a class="code" href="../../d2/dbf/metric_8h.html#a401668353c0216165cf6f1c7b2d34e94">PRIMECOORDS</a>){</div>
<div class="line"><a name="l11538"></a><span class="lineno">11538</span>&#160;      <span class="comment">// get metric grid geometry for these ICs</span></div>
<div class="line"><a name="l11539"></a><span class="lineno">11539</span>&#160;      <span class="keywordtype">int</span> <a class="code" href="../../dc/dd2/newcodediff_8txt.html#aba79df536b86921bebbe2b33fb409b68">getprim</a>=0;</div>
<div class="line"><a name="l11540"></a><span class="lineno">11540</span>&#160;      gset_genloc(getprim,*whichcoord,i,j,k,loc,ptrgeomtouse);</div>
<div class="line"><a name="l11541"></a><span class="lineno">11541</span>&#160;    }</div>
<div class="line"><a name="l11542"></a><span class="lineno">11542</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l11543"></a><span class="lineno">11543</span>&#160;      <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a3059ed7bfcfb692cbe8014d55fd7c1e4">get_geometry</a>(i, j, k, loc, ptrgeomtouse);</div>
<div class="line"><a name="l11544"></a><span class="lineno">11544</span>&#160;    }</div>
<div class="line"><a name="l11545"></a><span class="lineno">11545</span>&#160;  }</div>
<div class="line"><a name="l11546"></a><span class="lineno">11546</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l11547"></a><span class="lineno">11547</span>&#160;    <span class="comment">// then assumes ptrgeom is in *whichcoord coordinates</span></div>
<div class="line"><a name="l11548"></a><span class="lineno">11548</span>&#160;    ptrgeomtouse=ptrgeom;</div>
<div class="line"><a name="l11549"></a><span class="lineno">11549</span>&#160;  }</div>
<div class="line"><a name="l11550"></a><span class="lineno">11550</span>&#160;</div>
<div class="line"><a name="l11551"></a><span class="lineno">11551</span>&#160;</div>
<div class="line"><a name="l11552"></a><span class="lineno">11552</span>&#160;  <span class="comment">// set primitive that can use as pre-existing fluid velocity if need to use for reduction</span></div>
<div class="line"><a name="l11553"></a><span class="lineno">11553</span>&#160;  <span class="comment">// also use pout instead of pin so preserves pin no matter what (unless user set pin=pout)</span></div>
<div class="line"><a name="l11554"></a><span class="lineno">11554</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) pout[pl]=pin[pl];</div>
<div class="line"><a name="l11555"></a><span class="lineno">11555</span>&#160;</div>
<div class="line"><a name="l11556"></a><span class="lineno">11556</span>&#160;</div>
<div class="line"><a name="l11557"></a><span class="lineno">11557</span>&#160;  <span class="comment">// radiative stress tensor in the fluid frame orthonormal basis</span></div>
<div class="line"><a name="l11558"></a><span class="lineno">11558</span>&#160;  <span class="comment">// assuming input pradffortho for radiation is in fluid frame orthonormal basis, but in &quot;primitive&quot; format so using pradffortho[PRAD0-PRAD3]</span></div>
<div class="line"><a name="l11559"></a><span class="lineno">11559</span>&#160;  <span class="comment">// gets R^{ij} in fluid frame orthonormal basis from primitive quantities in fluid frame orthonormal basis</span></div>
<div class="line"><a name="l11560"></a><span class="lineno">11560</span>&#160;  <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a949a0736746df92cb2600c6c015976e1" title="compute fluid frame orthonormal basis radiation stress-energy tensor assuming M1 closure">calc_Rij_ff</a>(pradffortho,Rijff);</div>
<div class="line"><a name="l11561"></a><span class="lineno">11561</span>&#160;  </div>
<div class="line"><a name="l11562"></a><span class="lineno">11562</span>&#160;  <span class="comment">//  PLOOPRADONLY(pl) dualfprintf(fail_file,&quot;pl=%d pout=%g\n&quot;,pl,pout[pl]);</span></div>
<div class="line"><a name="l11563"></a><span class="lineno">11563</span>&#160;  <span class="comment">//  DLOOP(jj,kk) dualfprintf(fail_file,&quot;jj=%d kk=%d Rijff=%g\n&quot;,jj,kk,Rijff[jj][kk]);</span></div>
<div class="line"><a name="l11564"></a><span class="lineno">11564</span>&#160;  <span class="comment">//  DLOOP(jj,kk) dualfprintf(fail_file,&quot;gn%d%d=%21.15g\n&quot;,jj+1,kk+1,ptrgeomtouse-&gt;gcon[GIND(jj,kk)]);</span></div>
<div class="line"><a name="l11565"></a><span class="lineno">11565</span>&#160;  <span class="comment">//  DLOOP(jj,kk) dualfprintf(fail_file,&quot;gv%d%d=%21.15g\n&quot;,jj+1,kk+1,ptrgeomtouse-&gt;gcov[GIND(jj,kk)]);</span></div>
<div class="line"><a name="l11566"></a><span class="lineno">11566</span>&#160;</div>
<div class="line"><a name="l11567"></a><span class="lineno">11567</span>&#160;</div>
<div class="line"><a name="l11568"></a><span class="lineno">11568</span>&#160;  <span class="comment">// get ucon (assumed primitive velocity in ptrgeomtouse coordinates)</span></div>
<div class="line"><a name="l11569"></a><span class="lineno">11569</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ucon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>],others[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a266c1c3ab2959dbfc603c7d3f12783fb" title="strict limit (doesn&#39;t work in general)">NUMOTHERSTATERESULTS</a>];</div>
<div class="line"><a name="l11570"></a><span class="lineno">11570</span>&#160;  <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a35c4399eb86e3fa77e2221000e077572">ucon_calc_whichvel</a>(*whichvel,pout,ptrgeomtouse,ucon,others);</div>
<div class="line"><a name="l11571"></a><span class="lineno">11571</span>&#160;</div>
<div class="line"><a name="l11572"></a><span class="lineno">11572</span>&#160;  <span class="comment">//  DLOOPA(jj) dualfprintf(fail_file,&quot;jj=%d ucon=%g\n&quot;,jj,ucon[jj]);</span></div>
<div class="line"><a name="l11573"></a><span class="lineno">11573</span>&#160;</div>
<div class="line"><a name="l11574"></a><span class="lineno">11574</span>&#160;</div>
<div class="line"><a name="l11575"></a><span class="lineno">11575</span>&#160;  <span class="comment">// also convert whichvel ucon to VELREL4 primitive velocity for use by u2p_rad() and as needed for consistent final output from this function and as possible backup value</span></div>
<div class="line"><a name="l11576"></a><span class="lineno">11576</span>&#160;  <span class="keywordflow">if</span>(*whichvel!=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7d5588994345227982f0ed709b28e1f1">VELREL4</a>) ucon2pr(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7d5588994345227982f0ed709b28e1f1">VELREL4</a>,ucon,ptrgeomtouse,pout);</div>
<div class="line"><a name="l11577"></a><span class="lineno">11577</span>&#160;</div>
<div class="line"><a name="l11578"></a><span class="lineno">11578</span>&#160;  <span class="comment">//  SLOOPA(jj) dualfprintf(fail_file,&quot;jj=%d u4rel=%g\n&quot;,jj,pout[UU+jj]);</span></div>
<div class="line"><a name="l11579"></a><span class="lineno">11579</span>&#160;  </div>
<div class="line"><a name="l11580"></a><span class="lineno">11580</span>&#160;  <span class="comment">// transform and boost (ultimately converts pradffortho -&gt; Rijff -&gt; Rijlab -&gt; U)</span></div>
<div class="line"><a name="l11581"></a><span class="lineno">11581</span>&#160;  <span class="keywordtype">int</span> tconcovtypeA=<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a2bbc1db2b84f7d7738a65be5cdeda4e0">TYPEUCON</a>;</div>
<div class="line"><a name="l11582"></a><span class="lineno">11582</span>&#160;  <span class="keywordtype">int</span> tconcovtypeB=<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a2bbc1db2b84f7d7738a65be5cdeda4e0">TYPEUCON</a>;</div>
<div class="line"><a name="l11583"></a><span class="lineno">11583</span>&#160;  <span class="keywordflow">if</span>(*whichcoord==<a class="code" href="../../d2/dbf/metric_8h.html#a401668353c0216165cf6f1c7b2d34e94">PRIMECOORDS</a>) primcoord=1;</div>
<div class="line"><a name="l11584"></a><span class="lineno">11584</span>&#160;  <span class="keywordflow">else</span> primcoord=0;</div>
<div class="line"><a name="l11585"></a><span class="lineno">11585</span>&#160;  <a class="code" href="../../d5/d0a/tetrad_8c.html#a6999a0ba04240d0dcbe3ae46adba0510" title="convert lab frame 4-tensor to fluid frame orthonormal 4-tensor">tensor_lab2orthofluidorback</a>(primcoord, <a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a0f3447461a389d1bef312bd4a6e84dd9">FF2LAB</a>, ptrgeomtouse, <a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a2bbc1db2b84f7d7738a65be5cdeda4e0">TYPEUCON</a>, ucon, tconcovtypeA, tconcovtypeB, Rijff, Rijlab);</div>
<div class="line"><a name="l11586"></a><span class="lineno">11586</span>&#160;</div>
<div class="line"><a name="l11587"></a><span class="lineno">11587</span>&#160;  <span class="comment">//  DLOOP(jj,kk) dualfprintf(fail_file,&quot;jj=%d kk=%d Rijlab=%g\n&quot;,jj,kk,Rijlab[jj][kk]);</span></div>
<div class="line"><a name="l11588"></a><span class="lineno">11588</span>&#160;</div>
<div class="line"><a name="l11589"></a><span class="lineno">11589</span>&#160;  <span class="comment">//R^munu -&gt; R^mu_nu so in standard form to extract conserved quantity R^t_\nu</span></div>
<div class="line"><a name="l11590"></a><span class="lineno">11590</span>&#160;  indices_2221(Rijlab,Rijlab,ptrgeomtouse);</div>
<div class="line"><a name="l11591"></a><span class="lineno">11591</span>&#160;</div>
<div class="line"><a name="l11592"></a><span class="lineno">11592</span>&#160;  <span class="comment">//  DLOOP(jj,kk) dualfprintf(fail_file,&quot;jj=%d kk=%d Ridownjlab=%g\n&quot;,jj,kk,Rijlab[jj][kk]);</span></div>
<div class="line"><a name="l11593"></a><span class="lineno">11593</span>&#160;</div>
<div class="line"><a name="l11594"></a><span class="lineno">11594</span>&#160;  <span class="comment">// Store radiation conserved quantity from R^t_\nu .  u2p_rad() below only uses radiation U&#39;s.</span></div>
<div class="line"><a name="l11595"></a><span class="lineno">11595</span>&#160;<span class="preprocessor">#if(0) // STAY ZERO NOW</span></div>
<div class="line"><a name="l11596"></a><span class="lineno">11596</span>&#160;<span class="preprocessor"></span>  <span class="comment">// for true lab to fake-harm lab, end up dividing by alpha (see vector_harm2orthofluidorback() in tetrad.c)</span></div>
<div class="line"><a name="l11597"></a><span class="lineno">11597</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> alpha=ptrgeomtouse-&gt;alphalapse;</div>
<div class="line"><a name="l11598"></a><span class="lineno">11598</span>&#160;  U[URAD0]=Rijlab[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>][<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>]/alpha;</div>
<div class="line"><a name="l11599"></a><span class="lineno">11599</span>&#160;  U[URAD1]=Rijlab[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>][<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a63979cf6054f403eab1d354e6dcc4ce9">RR</a>]/alpha;</div>
<div class="line"><a name="l11600"></a><span class="lineno">11600</span>&#160;  U[URAD2]=Rijlab[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>][<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8ccbf4850176503992b0295081d5f4bc">TH</a>]/alpha;</div>
<div class="line"><a name="l11601"></a><span class="lineno">11601</span>&#160;  U[URAD3]=Rijlab[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>][<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae0fcc909f5a4166b625a6707cbdfa643">PH</a>]/alpha;</div>
<div class="line"><a name="l11602"></a><span class="lineno">11602</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l11603"></a><span class="lineno">11603</span>&#160;<span class="preprocessor"></span>  U[URAD0]=Rijlab[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>][<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>];</div>
<div class="line"><a name="l11604"></a><span class="lineno">11604</span>&#160;  U[URAD1]=Rijlab[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>][<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a63979cf6054f403eab1d354e6dcc4ce9">RR</a>];</div>
<div class="line"><a name="l11605"></a><span class="lineno">11605</span>&#160;  U[URAD2]=Rijlab[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>][<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8ccbf4850176503992b0295081d5f4bc">TH</a>];</div>
<div class="line"><a name="l11606"></a><span class="lineno">11606</span>&#160;  U[URAD3]=Rijlab[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>][<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae0fcc909f5a4166b625a6707cbdfa643">PH</a>];</div>
<div class="line"><a name="l11607"></a><span class="lineno">11607</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l11608"></a><span class="lineno">11608</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l11609"></a><span class="lineno">11609</span>&#160;  <span class="comment">//  DLOOPA(jj) dualfprintf(fail_file,&quot;jj=%d URAD=%g\n&quot;,jj,U[URAD0+jj]);</span></div>
<div class="line"><a name="l11610"></a><span class="lineno">11610</span>&#160;</div>
<div class="line"><a name="l11611"></a><span class="lineno">11611</span>&#160;</div>
<div class="line"><a name="l11612"></a><span class="lineno">11612</span>&#160;</div>
<div class="line"><a name="l11613"></a><span class="lineno">11613</span>&#160;</div>
<div class="line"><a name="l11614"></a><span class="lineno">11614</span>&#160;  <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> lpflag=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#abdf9e55b7b15ec0bcd386055f1787f47">UTOPRIMNOFAIL</a>,lpflagrad=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6435e9609d622c9dbaf78c12658ecf8e">UTOPRIMRADNOFAIL</a>;</div>
<div class="line"><a name="l11615"></a><span class="lineno">11615</span>&#160;  <span class="keywordtype">int</span> showmessages=1; <span class="comment">// LEAVE on (not normal debugging)</span></div>
<div class="line"><a name="l11616"></a><span class="lineno">11616</span>&#160;  <span class="keywordtype">int</span> allowlocalfailurefixandnoreport=1;</div>
<div class="line"><a name="l11617"></a><span class="lineno">11617</span>&#160;  <span class="comment">// NOTEMARK: lpflag=UTOPRIMNOFAIL means accept input pout for velocity to maybe be used in local reductions to fluid frame.</span></div>
<div class="line"><a name="l11618"></a><span class="lineno">11618</span>&#160;  <span class="comment">// u2p_rad() only uses U[URAD0-URAD3]</span></div>
<div class="line"><a name="l11619"></a><span class="lineno">11619</span>&#160;  <span class="comment">// generally u2p_rad() could use all of pout[] except only assigns pout[PRAD0-PRAD3] and doesn&#39;t use that for anything except as &quot;static&quot; solution (i.e. uses pin effectively)</span></div>
<div class="line"><a name="l11620"></a><span class="lineno">11620</span>&#160;  <a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#a9fe58e7f372421d18633c8fc5007b815">u2p_rad</a>(showmessages, allowlocalfailurefixandnoreport, <a class="code" href="../../d8/d5b/defs_8general_8h.html#a51ef12e4cafc4a8fe70374c37f57d565">GAMMAMAXRAD</a>, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a4b6c6060c025e15f1d92aae3dcb9365b" title="which cap type to place in rad inversion">CAPTYPEBASIC</a>, U, pout, ptrgeomtouse, &amp;lpflag, &amp;lpflagrad);</div>
<div class="line"><a name="l11621"></a><span class="lineno">11621</span>&#160;</div>
<div class="line"><a name="l11622"></a><span class="lineno">11622</span>&#160;  <span class="comment">//  DLOOPA(jj) dualfprintf(fail_file,&quot;u2p_rad: jj=%d pout=%g\n&quot;,jj,pout[PRAD0+jj]);</span></div>
<div class="line"><a name="l11623"></a><span class="lineno">11623</span>&#160;</div>
<div class="line"><a name="l11624"></a><span class="lineno">11624</span>&#160;</div>
<div class="line"><a name="l11625"></a><span class="lineno">11625</span>&#160;</div>
<div class="line"><a name="l11626"></a><span class="lineno">11626</span>&#160;  <span class="comment">// get back to whichvel</span></div>
<div class="line"><a name="l11627"></a><span class="lineno">11627</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> uconback[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>],othersback[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a266c1c3ab2959dbfc603c7d3f12783fb" title="strict limit (doesn&#39;t work in general)">NUMOTHERSTATERESULTS</a>];</div>
<div class="line"><a name="l11628"></a><span class="lineno">11628</span>&#160;  <span class="comment">// for fluid</span></div>
<div class="line"><a name="l11629"></a><span class="lineno">11629</span>&#160;  <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a35c4399eb86e3fa77e2221000e077572">ucon_calc_whichvel</a>(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7d5588994345227982f0ed709b28e1f1">VELREL4</a>,pout,ptrgeomtouse,uconback,othersback);</div>
<div class="line"><a name="l11630"></a><span class="lineno">11630</span>&#160;  ucon2pr(*whichvel,uconback,ptrgeomtouse,pout);</div>
<div class="line"><a name="l11631"></a><span class="lineno">11631</span>&#160;  <span class="comment">// KORALTODO: for radiation (always returned as VELREL4 so far).</span></div>
<div class="line"><a name="l11632"></a><span class="lineno">11632</span>&#160;  <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a35c4399eb86e3fa77e2221000e077572">ucon_calc_whichvel</a>(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7d5588994345227982f0ed709b28e1f1">VELREL4</a>,&amp;pout[URAD1-<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>],ptrgeomtouse,uconback,othersback);</div>
<div class="line"><a name="l11633"></a><span class="lineno">11633</span>&#160;  ucon2pr(*whichvel,uconback,ptrgeomtouse,&amp;pout[URAD1-<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>]);</div>
<div class="line"><a name="l11634"></a><span class="lineno">11634</span>&#160;</div>
<div class="line"><a name="l11635"></a><span class="lineno">11635</span>&#160;</div>
<div class="line"><a name="l11636"></a><span class="lineno">11636</span>&#160;</div>
<div class="line"><a name="l11637"></a><span class="lineno">11637</span>&#160;  <span class="comment">// DEBUG:</span></div>
<div class="line"><a name="l11638"></a><span class="lineno">11638</span>&#160;  <span class="keywordflow">if</span>(lpflag!=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#abdf9e55b7b15ec0bcd386055f1787f47">UTOPRIMNOFAIL</a> || lpflagrad!=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6435e9609d622c9dbaf78c12658ecf8e">UTOPRIMRADNOFAIL</a>){ <span class="comment">// DEBUG with 1||</span></div>
<div class="line"><a name="l11639"></a><span class="lineno">11639</span>&#160;    <span class="comment">// allows fixups to be applied, such as gamma radiation limiting</span></div>
<div class="line"><a name="l11640"></a><span class="lineno">11640</span>&#160;    <span class="keywordflow">if</span>(lpflag&gt;<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#abdf9e55b7b15ec0bcd386055f1787f47">UTOPRIMNOFAIL</a> || lpflagrad&gt;<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6435e9609d622c9dbaf78c12658ecf8e">UTOPRIMRADNOFAIL</a>){ <span class="comment">// DEBUG with 1||</span></div>
<div class="line"><a name="l11641"></a><span class="lineno">11641</span>&#160;      <span class="keywordflow">if</span>(debugfail&gt;=2){</div>
<div class="line"><a name="l11642"></a><span class="lineno">11642</span>&#160;        dualfprintf(fail_file,<span class="stringliteral">&quot;Failed to invert during prad_fftolab().  Assuming fixups won&#39;t be applied: %d %d\n&quot;</span>,lpflag,lpflagrad);</div>
<div class="line"><a name="l11643"></a><span class="lineno">11643</span>&#160;        dualfprintf(fail_file,<span class="stringliteral">&quot;ijk=%d %d %d : %d\n&quot;</span>,ptrgeomtouse-&gt;i,ptrgeomtouse-&gt;j,ptrgeomtouse-&gt;k,ptrgeomtouse-&gt;p);</div>
<div class="line"><a name="l11644"></a><span class="lineno">11644</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) dualfprintf(fail_file,<span class="stringliteral">&quot;pl=%d pin=%g U=%g\n&quot;</span>,pl,pin[pl],U[pl]);</div>
<div class="line"><a name="l11645"></a><span class="lineno">11645</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) dualfprintf(fail_file,<span class="stringliteral">&quot;jj=%d ucon=%g\n&quot;</span>,jj,ucon[jj]);</div>
<div class="line"><a name="l11646"></a><span class="lineno">11646</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a59b7ef1517ff22fd4dfce4cf6d380c55" title="loop over all Dimensions; second rank loop">DLOOP</a>(jj,kk) dualfprintf(fail_file,<span class="stringliteral">&quot;jj=%d kk=%d Rijff=%g Rijlab=%g\n&quot;</span>,jj,kk,Rijff[jj][kk],Rijlab[jj][kk]);</div>
<div class="line"><a name="l11647"></a><span class="lineno">11647</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a59b7ef1517ff22fd4dfce4cf6d380c55" title="loop over all Dimensions; second rank loop">DLOOP</a>(jj,kk) dualfprintf(fail_file,<span class="stringliteral">&quot;jj=%d kk=%d gcov=%g gcon=%g\n&quot;</span>,jj,kk,ptrgeomtouse-&gt;gcov[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(jj,kk)],ptrgeomtouse-&gt;gcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(jj,kk)]);</div>
<div class="line"><a name="l11648"></a><span class="lineno">11648</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) dualfprintf(fail_file,<span class="stringliteral">&quot;pl=%d pout=%g\n&quot;</span>,pl,pout[pl]);</div>
<div class="line"><a name="l11649"></a><span class="lineno">11649</span>&#160;      }</div>
<div class="line"><a name="l11650"></a><span class="lineno">11650</span>&#160;      <span class="keywordflow">if</span>(lpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#abdf9e55b7b15ec0bcd386055f1787f47">UTOPRIMNOFAIL</a> &amp;&amp; (lpflagrad==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a38b0585ec02d900ad0413645acb00918">UTOPRIMRADFAILERFNEG</a> || lpflagrad==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a36f23f21f8e90ce3e39940621c912714">UTOPRIMRADFAILGAMMAHIGH</a>) ){</div>
<div class="line"><a name="l11651"></a><span class="lineno">11651</span>&#160;        <span class="comment">// then probably not really failure, just have high ERADLIMIT for other reasons.</span></div>
<div class="line"><a name="l11652"></a><span class="lineno">11652</span>&#160;      }</div>
<div class="line"><a name="l11653"></a><span class="lineno">11653</span>&#160;      <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l11654"></a><span class="lineno">11654</span>&#160;        myexit(189235);</div>
<div class="line"><a name="l11655"></a><span class="lineno">11655</span>&#160;        <span class="comment">// KORALTODO: Check whether really succeeded?  Need to call fixups?  Probably, but need per-cell fixup.  Hard to do if other cells not even set yet as in ICs.  Should probably include fixup process during initbase.c stuff.</span></div>
<div class="line"><a name="l11656"></a><span class="lineno">11656</span>&#160;      }</div>
<div class="line"><a name="l11657"></a><span class="lineno">11657</span>&#160;    }</div>
<div class="line"><a name="l11658"></a><span class="lineno">11658</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l11659"></a><span class="lineno">11659</span>&#160;      <span class="keywordflow">if</span>(debugfail&gt;=2){</div>
<div class="line"><a name="l11660"></a><span class="lineno">11660</span>&#160;        dualfprintf(fail_file,<span class="stringliteral">&quot;Fixups applied during invert during prad_fftolab(): %d %d\n&quot;</span>,lpflag,lpflagrad);</div>
<div class="line"><a name="l11661"></a><span class="lineno">11661</span>&#160;        dualfprintf(fail_file,<span class="stringliteral">&quot;ijk=%d %d %d : %d\n&quot;</span>,ptrgeomtouse-&gt;i,ptrgeomtouse-&gt;j,ptrgeomtouse-&gt;k,ptrgeomtouse-&gt;p);</div>
<div class="line"><a name="l11662"></a><span class="lineno">11662</span>&#160;      }</div>
<div class="line"><a name="l11663"></a><span class="lineno">11663</span>&#160;    }</div>
<div class="line"><a name="l11664"></a><span class="lineno">11664</span>&#160;  }</div>
<div class="line"><a name="l11665"></a><span class="lineno">11665</span>&#160;</div>
<div class="line"><a name="l11666"></a><span class="lineno">11666</span>&#160;</div>
<div class="line"><a name="l11667"></a><span class="lineno">11667</span>&#160;</div>
<div class="line"><a name="l11668"></a><span class="lineno">11668</span>&#160;  <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l11669"></a><span class="lineno">11669</span>&#160;} </div>
<div class="line"><a name="l11670"></a><span class="lineno">11670</span>&#160;</div>
<div class="line"><a name="l11671"></a><span class="lineno">11671</span>&#160;</div>
<div class="line"><a name="l11672"></a><span class="lineno">11672</span>&#160;</div>
<div class="line"><a name="l11673"></a><span class="lineno">11673</span>&#160;</div>
<div class="line"><a name="l11674"></a><span class="lineno">11674</span>&#160;</div>
<div class="line"><a name="l11675"></a><span class="lineno">11675</span>&#160;</div>
<div class="line"><a name="l11676"></a><span class="lineno">11676</span>&#160;</div>
<div class="line"><a name="l11677"></a><span class="lineno">11677</span>&#160;</div>
<div class="line"><a name="l11678"></a><span class="lineno">11678</span>&#160;</div>
<div class="line"><a name="l11679"></a><span class="lineno">11679</span>&#160;</div>
<div class="line"><a name="l11680"></a><span class="lineno">11680</span>&#160;</div>
<div class="line"><a name="l11681"></a><span class="lineno">11681</span>&#160;</div>
<div class="line"><a name="l11684"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa25aa4dfb3559619f276abca5f4b3ca0">11684</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#aa25aa4dfb3559619f276abca5f4b3ca0" title="for BCs, to take E[radiation frame] and u^i as radiation primitives in whichvel/whichcoord obtains WH...">primefluid_EVrad_to_primeall</a>(<span class="keywordtype">int</span> *whichvel, <span class="keywordtype">int</span> *<a class="code" href="../../dc/dd2/newcodediff_8txt.html#ab29c7802084b56a574b83eb818d2fdda">whichcoord</a>, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pout)</div>
<div class="line"><a name="l11685"></a><span class="lineno">11685</span>&#160;{</div>
<div class="line"><a name="l11686"></a><span class="lineno">11686</span>&#160;  <span class="keywordtype">int</span> pliter,pl;</div>
<div class="line"><a name="l11687"></a><span class="lineno">11687</span>&#160;  <span class="keywordtype">int</span> i=ptrgeom-&gt;i;</div>
<div class="line"><a name="l11688"></a><span class="lineno">11688</span>&#160;  <span class="keywordtype">int</span> j=ptrgeom-&gt;j;</div>
<div class="line"><a name="l11689"></a><span class="lineno">11689</span>&#160;  <span class="keywordtype">int</span> k=ptrgeom-&gt;k;</div>
<div class="line"><a name="l11690"></a><span class="lineno">11690</span>&#160;  <span class="keywordtype">int</span> loc=ptrgeom-&gt;p;</div>
<div class="line"><a name="l11691"></a><span class="lineno">11691</span>&#160;</div>
<div class="line"><a name="l11692"></a><span class="lineno">11692</span>&#160;  <span class="comment">// copy over</span></div>
<div class="line"><a name="l11693"></a><span class="lineno">11693</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) pout[pl]=pin[pl];</div>
<div class="line"><a name="l11694"></a><span class="lineno">11694</span>&#160;</div>
<div class="line"><a name="l11695"></a><span class="lineno">11695</span>&#160;  <span class="comment">// get metric grid geometry for these ICs</span></div>
<div class="line"><a name="l11696"></a><span class="lineno">11696</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../dc/dd2/newcodediff_8txt.html#aba79df536b86921bebbe2b33fb409b68">getprim</a>=0;</div>
<div class="line"><a name="l11697"></a><span class="lineno">11697</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> geomrealdontuse;</div>
<div class="line"><a name="l11698"></a><span class="lineno">11698</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeomreal=&amp;geomrealdontuse;</div>
<div class="line"><a name="l11699"></a><span class="lineno">11699</span>&#160;  gset_genloc(getprim,*whichcoord,i,j,k,loc,ptrgeomreal);</div>
<div class="line"><a name="l11700"></a><span class="lineno">11700</span>&#160;</div>
<div class="line"><a name="l11701"></a><span class="lineno">11701</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> uradcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>],othersrad[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a266c1c3ab2959dbfc603c7d3f12783fb" title="strict limit (doesn&#39;t work in general)">NUMOTHERSTATERESULTS</a>];</div>
<div class="line"><a name="l11702"></a><span class="lineno">11702</span>&#160;  <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a35c4399eb86e3fa77e2221000e077572">ucon_calc_whichvel</a>(*whichvel,&amp;pout[URAD1-<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>],ptrgeomreal,uradcon,othersrad);</div>
<div class="line"><a name="l11703"></a><span class="lineno">11703</span>&#160;</div>
<div class="line"><a name="l11704"></a><span class="lineno">11704</span>&#160;  <span class="comment">// now convert velocity so in PRIMECOORDS assuming whichcoord=MCOORD</span></div>
<div class="line"><a name="l11705"></a><span class="lineno">11705</span>&#160;  <a class="code" href="../../d3/d09/transforms_8c.html#a0c5044bf89287cf41d59999d96f9fc12" title="MCOORD -&gt; prime MCOORD.">mettometp_genloc</a>(i,j,k,loc,uradcon);</div>
<div class="line"><a name="l11706"></a><span class="lineno">11706</span>&#160;</div>
<div class="line"><a name="l11707"></a><span class="lineno">11707</span>&#160;  <span class="keywordflow">if</span>(*whichcoord!=<a class="code" href="../../da/d3e/definit_8h.html#ab343edb2f60f3de2d654dcf1c58e06a2" title="#else define MAXBND 3 endif">MCOORD</a>){</div>
<div class="line"><a name="l11708"></a><span class="lineno">11708</span>&#160;    dualfprintf(fail_file,<span class="stringliteral">&quot;primefluid_EVrad_to_primeall() needs whichcoord (%d) to be MCOORD (%d)\n&quot;</span>,whichcoord,<a class="code" href="../../da/d3e/definit_8h.html#ab343edb2f60f3de2d654dcf1c58e06a2" title="#else define MAXBND 3 endif">MCOORD</a>);</div>
<div class="line"><a name="l11709"></a><span class="lineno">11709</span>&#160;    myexit(87345246);</div>
<div class="line"><a name="l11710"></a><span class="lineno">11710</span>&#160;  }</div>
<div class="line"><a name="l11711"></a><span class="lineno">11711</span>&#160;</div>
<div class="line"><a name="l11712"></a><span class="lineno">11712</span>&#160;  <span class="comment">// assumed already inputted PRIMECOORDS WHICHVEL for fluid velocity, so no conversion for the fluid velocity</span></div>
<div class="line"><a name="l11713"></a><span class="lineno">11713</span>&#160;</div>
<div class="line"><a name="l11714"></a><span class="lineno">11714</span>&#160;  <span class="comment">// now go from ucon[PRIMECOORDS] -&gt; primitive[PRIMECOORDS] for radiation velocity and get WHICHVEL version</span></div>
<div class="line"><a name="l11715"></a><span class="lineno">11715</span>&#160;  ucon2pr(<a class="code" href="../../da/d3e/definit_8h.html#a3d14480f30d39eff4e51ae8bc93df56f" title="whether we use ultimately precise inversion or &quot;workable&quot; inversion precision (see utoprim&#39;s for ho...">WHICHVEL</a>,uradcon,ptrgeom,&amp;pout[URAD1-<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>]);</div>
<div class="line"><a name="l11716"></a><span class="lineno">11716</span>&#160;</div>
<div class="line"><a name="l11717"></a><span class="lineno">11717</span>&#160;  <span class="comment">// now all PRIMECOORDS WHICHVEL type assuming ptrgeom inputted PRIMECOORDS version as expected</span></div>
<div class="line"><a name="l11718"></a><span class="lineno">11718</span>&#160;  *whichvel=<a class="code" href="../../da/d3e/definit_8h.html#a3d14480f30d39eff4e51ae8bc93df56f" title="whether we use ultimately precise inversion or &quot;workable&quot; inversion precision (see utoprim&#39;s for ho...">WHICHVEL</a>;</div>
<div class="line"><a name="l11719"></a><span class="lineno">11719</span>&#160;  *whichcoord=<a class="code" href="../../d2/dbf/metric_8h.html#a401668353c0216165cf6f1c7b2d34e94">PRIMECOORDS</a>;</div>
<div class="line"><a name="l11720"></a><span class="lineno">11720</span>&#160;  </div>
<div class="line"><a name="l11721"></a><span class="lineno">11721</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l11722"></a><span class="lineno">11722</span>&#160;}</div>
<div class="line"><a name="l11723"></a><span class="lineno">11723</span>&#160;</div>
<div class="line"><a name="l11724"></a><span class="lineno">11724</span>&#160;</div>
<div class="line"><a name="l11729"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a64226cb28f52020ffe18ac6c6b1a2f5c">11729</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#a64226cb28f52020ffe18ac6c6b1a2f5c" title="Input: start with pin [with fluid in whichvel velocity and whichcoordfluid coordinates (PRIMECOORDS o...">whichfluid_ffrad_to_primeall</a>(<span class="keywordtype">int</span> *whichvel, <span class="keywordtype">int</span> *whichcoordfluid, <span class="keywordtype">int</span> *whichcoordrad, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeomprimecoords, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pradffortho, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pout)</div>
<div class="line"><a name="l11730"></a><span class="lineno">11730</span>&#160;{</div>
<div class="line"><a name="l11731"></a><span class="lineno">11731</span>&#160;  <span class="keywordtype">int</span> pliter,pl;</div>
<div class="line"><a name="l11732"></a><span class="lineno">11732</span>&#160;  <span class="keywordtype">int</span> i=ptrgeomprimecoords-&gt;i;</div>
<div class="line"><a name="l11733"></a><span class="lineno">11733</span>&#160;  <span class="keywordtype">int</span> j=ptrgeomprimecoords-&gt;j;</div>
<div class="line"><a name="l11734"></a><span class="lineno">11734</span>&#160;  <span class="keywordtype">int</span> k=ptrgeomprimecoords-&gt;k;</div>
<div class="line"><a name="l11735"></a><span class="lineno">11735</span>&#160;  <span class="keywordtype">int</span> loc=ptrgeomprimecoords-&gt;p;</div>
<div class="line"><a name="l11736"></a><span class="lineno">11736</span>&#160;</div>
<div class="line"><a name="l11737"></a><span class="lineno">11737</span>&#160;</div>
<div class="line"><a name="l11738"></a><span class="lineno">11738</span>&#160;  <span class="comment">//  PLOOP(pliter,pl) dualfprintf(fail_file,&quot;ijk=%d %d %d pl=%d pin0=%g pout0=%g\n&quot;,i,j,k,pl,pin[pl],pout[pl]);</span></div>
<div class="line"><a name="l11739"></a><span class="lineno">11739</span>&#160;</div>
<div class="line"><a name="l11740"></a><span class="lineno">11740</span>&#160;  <span class="comment">// prad_fforlab() should only use radiation primitives, but copy all primitives so can form ucon for transformation</span></div>
<div class="line"><a name="l11741"></a><span class="lineno">11741</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) pout[pl]=pin[pl];</div>
<div class="line"><a name="l11742"></a><span class="lineno">11742</span>&#160;</div>
<div class="line"><a name="l11743"></a><span class="lineno">11743</span>&#160;  <span class="comment">// 4 cases:</span></div>
<div class="line"><a name="l11744"></a><span class="lineno">11744</span>&#160;  <span class="comment">// rad   fluid</span></div>
<div class="line"><a name="l11745"></a><span class="lineno">11745</span>&#160;  <span class="comment">// PRIME PRIME</span></div>
<div class="line"><a name="l11746"></a><span class="lineno">11746</span>&#160;  <span class="comment">// PRIME other</span></div>
<div class="line"><a name="l11747"></a><span class="lineno">11747</span>&#160;  <span class="comment">// other PRIME</span></div>
<div class="line"><a name="l11748"></a><span class="lineno">11748</span>&#160;  <span class="comment">// other other</span></div>
<div class="line"><a name="l11749"></a><span class="lineno">11749</span>&#160;</div>
<div class="line"><a name="l11750"></a><span class="lineno">11750</span>&#160;  <span class="comment">// get real geometry if needed</span></div>
<div class="line"><a name="l11751"></a><span class="lineno">11751</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> geomrealraddontuse;</div>
<div class="line"><a name="l11752"></a><span class="lineno">11752</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeomrealrad=&amp;geomrealraddontuse;</div>
<div class="line"><a name="l11753"></a><span class="lineno">11753</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> geomrealfluiddontuse;</div>
<div class="line"><a name="l11754"></a><span class="lineno">11754</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeomrealfluid=&amp;geomrealfluiddontuse;</div>
<div class="line"><a name="l11755"></a><span class="lineno">11755</span>&#160;  <span class="keywordflow">if</span>(*whichcoordrad!=<a class="code" href="../../d2/dbf/metric_8h.html#a401668353c0216165cf6f1c7b2d34e94">PRIMECOORDS</a>){</div>
<div class="line"><a name="l11756"></a><span class="lineno">11756</span>&#160;    <span class="keywordtype">int</span> <a class="code" href="../../dc/dd2/newcodediff_8txt.html#aba79df536b86921bebbe2b33fb409b68">getprim</a>=0;</div>
<div class="line"><a name="l11757"></a><span class="lineno">11757</span>&#160;    gset_genloc(getprim,*whichcoordrad,i,j,k,loc,ptrgeomrealrad);</div>
<div class="line"><a name="l11758"></a><span class="lineno">11758</span>&#160;  }</div>
<div class="line"><a name="l11759"></a><span class="lineno">11759</span>&#160;  <span class="keywordflow">else</span> ptrgeomrealrad=ptrgeomprimecoords;</div>
<div class="line"><a name="l11760"></a><span class="lineno">11760</span>&#160;  <span class="keywordflow">if</span>(*whichcoordfluid!=<a class="code" href="../../d2/dbf/metric_8h.html#a401668353c0216165cf6f1c7b2d34e94">PRIMECOORDS</a>){</div>
<div class="line"><a name="l11761"></a><span class="lineno">11761</span>&#160;    <span class="keywordtype">int</span> <a class="code" href="../../dc/dd2/newcodediff_8txt.html#aba79df536b86921bebbe2b33fb409b68">getprim</a>=0;</div>
<div class="line"><a name="l11762"></a><span class="lineno">11762</span>&#160;    gset_genloc(getprim,*whichcoordfluid,i,j,k,loc,ptrgeomrealfluid);</div>
<div class="line"><a name="l11763"></a><span class="lineno">11763</span>&#160;  }</div>
<div class="line"><a name="l11764"></a><span class="lineno">11764</span>&#160;  <span class="keywordflow">else</span> ptrgeomrealfluid=ptrgeomprimecoords;</div>
<div class="line"><a name="l11765"></a><span class="lineno">11765</span>&#160;</div>
<div class="line"><a name="l11766"></a><span class="lineno">11766</span>&#160;</div>
<div class="line"><a name="l11767"></a><span class="lineno">11767</span>&#160;</div>
<div class="line"><a name="l11768"></a><span class="lineno">11768</span>&#160;  <span class="comment">// make whichcoord for fluid same as for rad before continuing (make fluid same as radiation by only changing fluid whichcoord)</span></div>
<div class="line"><a name="l11769"></a><span class="lineno">11769</span>&#160;  <span class="keywordflow">if</span>(*whichcoordfluid!=*whichcoordrad){</div>
<div class="line"><a name="l11770"></a><span class="lineno">11770</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ucon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l11771"></a><span class="lineno">11771</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> others[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a266c1c3ab2959dbfc603c7d3f12783fb" title="strict limit (doesn&#39;t work in general)">NUMOTHERSTATERESULTS</a>];</div>
<div class="line"><a name="l11772"></a><span class="lineno">11772</span>&#160;</div>
<div class="line"><a name="l11773"></a><span class="lineno">11773</span>&#160;    <span class="comment">// pr-&gt;ucon for fluid</span></div>
<div class="line"><a name="l11774"></a><span class="lineno">11774</span>&#160;    <span class="keywordflow">if</span> (pr2ucon(*whichvel,pout, ptrgeomrealfluid, ucon) &gt;= 1) <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a5febb92786c5f7a1479e7e65f1c23ef3">FAILSTATEMENT</a>(<span class="stringliteral">&quot;bounds.koral.c:bl2met2metp2v_genloc() for radiation&quot;</span>, <span class="stringliteral">&quot;pr2ucon()&quot;</span>, 2);</div>
<div class="line"><a name="l11775"></a><span class="lineno">11775</span>&#160;</div>
<div class="line"><a name="l11776"></a><span class="lineno">11776</span>&#160;    <span class="keywordflow">if</span>(*whichcoordfluid==<a class="code" href="../../d2/dbf/metric_8h.html#a401668353c0216165cf6f1c7b2d34e94">PRIMECOORDS</a>){ <span class="comment">// then radiation is not PRIMECOORDS, so go to radiation coords</span></div>
<div class="line"><a name="l11777"></a><span class="lineno">11777</span>&#160;      <a class="code" href="../../d3/d09/transforms_8c.html#a30134f0b6967fd3c2326b305300d07dc" title="prime MCOORD -&gt; MCOORD for u^">metptomet_genloc</a>(i,j,k,loc,ucon); <span class="comment">// now ucon is in MCOORD</span></div>
<div class="line"><a name="l11778"></a><span class="lineno">11778</span>&#160;      <span class="comment">// convert MCOORD-&gt;whichcoordrad</span></div>
<div class="line"><a name="l11779"></a><span class="lineno">11779</span>&#160;      <a class="code" href="../../d3/d09/transforms_8c.html#a0a76b7b5c088e56618389fe3acf60119" title="whichcoordin -&gt; whichcoordout">coordtrans</a>(<a class="code" href="../../da/d3e/definit_8h.html#ab343edb2f60f3de2d654dcf1c58e06a2" title="#else define MAXBND 3 endif">MCOORD</a>,*whichcoordrad,i,j,k,loc,ucon);</div>
<div class="line"><a name="l11780"></a><span class="lineno">11780</span>&#160;    }</div>
<div class="line"><a name="l11781"></a><span class="lineno">11781</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(*whichcoordrad==<a class="code" href="../../d2/dbf/metric_8h.html#a401668353c0216165cf6f1c7b2d34e94">PRIMECOORDS</a>){ <span class="comment">// then go to PRIMECOORDS for fluid</span></div>
<div class="line"><a name="l11782"></a><span class="lineno">11782</span>&#160;      <span class="comment">// convert whichcoordfluid-&gt;MCOORD</span></div>
<div class="line"><a name="l11783"></a><span class="lineno">11783</span>&#160;      <a class="code" href="../../d3/d09/transforms_8c.html#a0a76b7b5c088e56618389fe3acf60119" title="whichcoordin -&gt; whichcoordout">coordtrans</a>(*whichcoordfluid,<a class="code" href="../../da/d3e/definit_8h.html#ab343edb2f60f3de2d654dcf1c58e06a2" title="#else define MAXBND 3 endif">MCOORD</a>,i,j,k,loc,ucon);</div>
<div class="line"><a name="l11784"></a><span class="lineno">11784</span>&#160;      <a class="code" href="../../d3/d09/transforms_8c.html#a0c5044bf89287cf41d59999d96f9fc12" title="MCOORD -&gt; prime MCOORD.">mettometp_genloc</a>(i,j,k,loc,ucon); <span class="comment">// now ucon is in PRIMECOORDS</span></div>
<div class="line"><a name="l11785"></a><span class="lineno">11785</span>&#160;    }</div>
<div class="line"><a name="l11786"></a><span class="lineno">11786</span>&#160;    <span class="keywordflow">else</span>{ <span class="comment">// then neither is PRIMECOORDS, so just transform and skip mettometp() or metptomet()</span></div>
<div class="line"><a name="l11787"></a><span class="lineno">11787</span>&#160;      <span class="comment">// convert whichcoordfluid-&gt;whichcoordrad</span></div>
<div class="line"><a name="l11788"></a><span class="lineno">11788</span>&#160;      <a class="code" href="../../d3/d09/transforms_8c.html#a0a76b7b5c088e56618389fe3acf60119" title="whichcoordin -&gt; whichcoordout">coordtrans</a>(*whichcoordfluid,*whichcoordrad,i,j,k,loc,ucon);</div>
<div class="line"><a name="l11789"></a><span class="lineno">11789</span>&#160;    }</div>
<div class="line"><a name="l11790"></a><span class="lineno">11790</span>&#160;</div>
<div class="line"><a name="l11791"></a><span class="lineno">11791</span>&#160;    <span class="comment">// get whichvel primitive</span></div>
<div class="line"><a name="l11792"></a><span class="lineno">11792</span>&#160;    ucon2pr(*whichvel,ucon,ptrgeomrealrad,pout);</div>
<div class="line"><a name="l11793"></a><span class="lineno">11793</span>&#160;</div>
<div class="line"><a name="l11794"></a><span class="lineno">11794</span>&#160;    <span class="comment">// changed fluid to have same whichcoord as radiation (set by radiation), so set that</span></div>
<div class="line"><a name="l11795"></a><span class="lineno">11795</span>&#160;    *whichcoordfluid=*whichcoordrad;</div>
<div class="line"><a name="l11796"></a><span class="lineno">11796</span>&#160;</div>
<div class="line"><a name="l11797"></a><span class="lineno">11797</span>&#160;  }</div>
<div class="line"><a name="l11798"></a><span class="lineno">11798</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l11799"></a><span class="lineno">11799</span>&#160;    <span class="comment">// otherwise, whichcoord same for fluid and radiation, so can continue</span></div>
<div class="line"><a name="l11800"></a><span class="lineno">11800</span>&#160;  }</div>
<div class="line"><a name="l11801"></a><span class="lineno">11801</span>&#160;</div>
<div class="line"><a name="l11802"></a><span class="lineno">11802</span>&#160;</div>
<div class="line"><a name="l11803"></a><span class="lineno">11803</span>&#160;  <span class="comment">//  PLOOP(pliter,pl) dualfprintf(fail_file,&quot;PRE:  ijk=%d %d %d pl=%d pout=%g\n&quot;,i,j,k,pl,pout[pl]);</span></div>
<div class="line"><a name="l11804"></a><span class="lineno">11804</span>&#160;</div>
<div class="line"><a name="l11805"></a><span class="lineno">11805</span>&#160;</div>
<div class="line"><a name="l11806"></a><span class="lineno">11806</span>&#160;</div>
<div class="line"><a name="l11807"></a><span class="lineno">11807</span>&#160;  <span class="comment">// get WHICHVEL primitives (still will be in whichcoord coordinates)</span></div>
<div class="line"><a name="l11808"></a><span class="lineno">11808</span>&#160;  <span class="comment">// whichvel here is for fluid velocity (prad_fforlab() converts velocity to WHICHVEL for consistency with only currently allowed output of radiation velocity)</span></div>
<div class="line"><a name="l11809"></a><span class="lineno">11809</span>&#160;  <span class="comment">// pradffortho assumed as in orthonormal fluid frame, but coordinates of whichcoordrad</span></div>
<div class="line"><a name="l11810"></a><span class="lineno">11810</span>&#160;  <span class="keywordtype">int</span> whichframedir=<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a0f3447461a389d1bef312bd4a6e84dd9">FF2LAB</a>; <span class="comment">// fluid frame orthonormal to lab-frame</span></div>
<div class="line"><a name="l11811"></a><span class="lineno">11811</span>&#160;  <a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#af50896d039d660550b738862b3390b07" title="radiative ortonormal ff primitives (E,F^i) &lt;-&gt; primitives in lab frame Used only for initial conditio...">prad_fforlab</a>(whichvel, whichcoordrad, whichframedir, i, j, k, loc, ptrgeomrealrad, pradffortho, pout, pout);</div>
<div class="line"><a name="l11812"></a><span class="lineno">11812</span>&#160;</div>
<div class="line"><a name="l11813"></a><span class="lineno">11813</span>&#160;  <span class="comment">// output from prad_fforlab() is always WHICHVEL for both fluid and radiation primitives</span></div>
<div class="line"><a name="l11814"></a><span class="lineno">11814</span>&#160;  <span class="comment">// changed whichvel&#39;s, so report that back if needed</span></div>
<div class="line"><a name="l11815"></a><span class="lineno">11815</span>&#160;  <span class="comment">//  *whichvel=WHICHVEL;</span></div>
<div class="line"><a name="l11816"></a><span class="lineno">11816</span>&#160;  <span class="comment">// above change of whichvel no longer true (and anyways, whichvel was changed in prad_fforlab() directly)</span></div>
<div class="line"><a name="l11817"></a><span class="lineno">11817</span>&#160; </div>
<div class="line"><a name="l11818"></a><span class="lineno">11818</span>&#160;  <span class="comment">//  PLOOP(pliter,pl) dualfprintf(fail_file,&quot;POST: ijk=%d %d %d pl=%d pout=%g\n&quot;,i,j,k,pl,pout[pl]);</span></div>
<div class="line"><a name="l11819"></a><span class="lineno">11819</span>&#160;</div>
<div class="line"><a name="l11820"></a><span class="lineno">11820</span>&#160; </div>
<div class="line"><a name="l11821"></a><span class="lineno">11821</span>&#160;  <span class="comment">// output from prad_fforlab() not yet necessarily PRIMECOORDS.</span></div>
<div class="line"><a name="l11822"></a><span class="lineno">11822</span>&#160;  <span class="keywordflow">if</span>(*whichcoordrad==<a class="code" href="../../da/d3e/definit_8h.html#ab343edb2f60f3de2d654dcf1c58e06a2" title="#else define MAXBND 3 endif">MCOORD</a>){</div>
<div class="line"><a name="l11823"></a><span class="lineno">11823</span>&#160;    <span class="comment">// Get all primitives in WHICHVEL/PRIMECOORDS (no conversion for WHICHVEL since prad_fforlab() already put quantities in WHICHVEL due to u2p_rad() only setup for WHICHVEL)</span></div>
<div class="line"><a name="l11824"></a><span class="lineno">11824</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../d3/d09/transforms_8c.html#a571104584acab566d6eb37f51cfb2102" title="converts whichvel/whichcoord velocity to WHICHVEL/(-&gt;MCOORD-&gt;PRIMECOORDS) converts field too...">bl2met2metp2v_genloc</a>(*whichvel, *whichcoordrad, pout, i,j,k,loc) &gt;= 1){</div>
<div class="line"><a name="l11825"></a><span class="lineno">11825</span>&#160;      <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a5febb92786c5f7a1479e7e65f1c23ef3">FAILSTATEMENT</a>(<span class="stringliteral">&quot;bounds.koral.c:bound_radatmbeaminflow()&quot;</span>, <span class="stringliteral">&quot;bl2ks2ksp2v()&quot;</span>, 1);</div>
<div class="line"><a name="l11826"></a><span class="lineno">11826</span>&#160;    }</div>
<div class="line"><a name="l11827"></a><span class="lineno">11827</span>&#160;  }</div>
<div class="line"><a name="l11828"></a><span class="lineno">11828</span>&#160;</div>
<div class="line"><a name="l11829"></a><span class="lineno">11829</span>&#160;  <span class="comment">// changed coordinates to PRIMECOORDS, so set that as the case</span></div>
<div class="line"><a name="l11830"></a><span class="lineno">11830</span>&#160;  *whichcoordfluid=*whichcoordrad=<a class="code" href="../../d2/dbf/metric_8h.html#a401668353c0216165cf6f1c7b2d34e94">PRIMECOORDS</a>;</div>
<div class="line"><a name="l11831"></a><span class="lineno">11831</span>&#160;</div>
<div class="line"><a name="l11832"></a><span class="lineno">11832</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l11833"></a><span class="lineno">11833</span>&#160;</div>
<div class="line"><a name="l11834"></a><span class="lineno">11834</span>&#160;}</div>
<div class="line"><a name="l11835"></a><span class="lineno">11835</span>&#160;</div>
<div class="line"><a name="l11836"></a><span class="lineno">11836</span>&#160;</div>
<div class="line"><a name="l11837"></a><span class="lineno">11837</span>&#160;<span class="comment">/*****************************************************************/</span></div>
<div class="line"><a name="l11838"></a><span class="lineno">11838</span>&#160;<span class="comment">/*****************************************************************/</span></div>
<div class="line"><a name="l11839"></a><span class="lineno">11839</span>&#160;<span class="comment">/*****************************************************************/</span></div>
<div class="line"><a name="l11841"></a><span class="lineno">11841</span>&#160;<span class="keywordtype">int</span> indices_2221(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> T1[][NDIM],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> T2[][NDIM], <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom)</div>
<div class="line"><a name="l11842"></a><span class="lineno">11842</span>&#160;{</div>
<div class="line"><a name="l11843"></a><span class="lineno">11843</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>,<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>,k;</div>
<div class="line"><a name="l11844"></a><span class="lineno">11844</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Tt[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>][<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l11845"></a><span class="lineno">11845</span>&#160;</div>
<div class="line"><a name="l11846"></a><span class="lineno">11846</span>&#160;  <span class="keywordflow">for</span>(i=0;i&lt;<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>;i++)</div>
<div class="line"><a name="l11847"></a><span class="lineno">11847</span>&#160;    {</div>
<div class="line"><a name="l11848"></a><span class="lineno">11848</span>&#160;      <span class="keywordflow">for</span>(j=0;j&lt;<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>;j++)</div>
<div class="line"><a name="l11849"></a><span class="lineno">11849</span>&#160;        {</div>
<div class="line"><a name="l11850"></a><span class="lineno">11850</span>&#160;          Tt[<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>][<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>]=0.;</div>
<div class="line"><a name="l11851"></a><span class="lineno">11851</span>&#160;          <span class="keywordflow">for</span>(k=0;k&lt;<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>;k++)</div>
<div class="line"><a name="l11852"></a><span class="lineno">11852</span>&#160;            {</div>
<div class="line"><a name="l11853"></a><span class="lineno">11853</span>&#160;              Tt[<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>][<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>]+=T1[<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>][k]*ptrgeom-&gt;gcov[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(k,j)];</div>
<div class="line"><a name="l11854"></a><span class="lineno">11854</span>&#160;            }   </div>
<div class="line"><a name="l11855"></a><span class="lineno">11855</span>&#160;        }</div>
<div class="line"><a name="l11856"></a><span class="lineno">11856</span>&#160;    }</div>
<div class="line"><a name="l11857"></a><span class="lineno">11857</span>&#160;</div>
<div class="line"><a name="l11858"></a><span class="lineno">11858</span>&#160;  <span class="keywordflow">for</span>(i=0;i&lt;<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>;i++)</div>
<div class="line"><a name="l11859"></a><span class="lineno">11859</span>&#160;    {</div>
<div class="line"><a name="l11860"></a><span class="lineno">11860</span>&#160;      <span class="keywordflow">for</span>(j=0;j&lt;<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>;j++)</div>
<div class="line"><a name="l11861"></a><span class="lineno">11861</span>&#160;        {</div>
<div class="line"><a name="l11862"></a><span class="lineno">11862</span>&#160;          T2[<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>][<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>]=Tt[<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>][<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>];</div>
<div class="line"><a name="l11863"></a><span class="lineno">11863</span>&#160;        }</div>
<div class="line"><a name="l11864"></a><span class="lineno">11864</span>&#160;    }</div>
<div class="line"><a name="l11865"></a><span class="lineno">11865</span>&#160;</div>
<div class="line"><a name="l11866"></a><span class="lineno">11866</span>&#160;  <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l11867"></a><span class="lineno">11867</span>&#160;}</div>
<div class="line"><a name="l11868"></a><span class="lineno">11868</span>&#160;</div>
<div class="line"><a name="l11869"></a><span class="lineno">11869</span>&#160;<span class="comment">/*****************************************************************/</span></div>
<div class="line"><a name="l11870"></a><span class="lineno">11870</span>&#160;<span class="comment">/*****************************************************************/</span></div>
<div class="line"><a name="l11871"></a><span class="lineno">11871</span>&#160;<span class="comment">/*****************************************************************/</span></div>
<div class="line"><a name="l11873"></a><span class="lineno">11873</span>&#160;<span class="keywordtype">int</span> indices_2212(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> T1[][NDIM],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> T2[][NDIM], <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom)</div>
<div class="line"><a name="l11874"></a><span class="lineno">11874</span>&#160;{</div>
<div class="line"><a name="l11875"></a><span class="lineno">11875</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>,<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>,k;</div>
<div class="line"><a name="l11876"></a><span class="lineno">11876</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Tt[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>][<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l11877"></a><span class="lineno">11877</span>&#160;</div>
<div class="line"><a name="l11878"></a><span class="lineno">11878</span>&#160;  <span class="keywordflow">for</span>(i=0;i&lt;<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>;i++)</div>
<div class="line"><a name="l11879"></a><span class="lineno">11879</span>&#160;    {</div>
<div class="line"><a name="l11880"></a><span class="lineno">11880</span>&#160;      <span class="keywordflow">for</span>(j=0;j&lt;<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>;j++)</div>
<div class="line"><a name="l11881"></a><span class="lineno">11881</span>&#160;        {</div>
<div class="line"><a name="l11882"></a><span class="lineno">11882</span>&#160;          Tt[<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>][<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>]=0.;</div>
<div class="line"><a name="l11883"></a><span class="lineno">11883</span>&#160;          <span class="keywordflow">for</span>(k=0;k&lt;<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>;k++)</div>
<div class="line"><a name="l11884"></a><span class="lineno">11884</span>&#160;            {</div>
<div class="line"><a name="l11885"></a><span class="lineno">11885</span>&#160;              Tt[<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>][<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>]+=T1[k][<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>]*ptrgeom-&gt;gcov[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(k,i)];</div>
<div class="line"><a name="l11886"></a><span class="lineno">11886</span>&#160;            }   </div>
<div class="line"><a name="l11887"></a><span class="lineno">11887</span>&#160;        }</div>
<div class="line"><a name="l11888"></a><span class="lineno">11888</span>&#160;    }</div>
<div class="line"><a name="l11889"></a><span class="lineno">11889</span>&#160;</div>
<div class="line"><a name="l11890"></a><span class="lineno">11890</span>&#160;  <span class="keywordflow">for</span>(i=0;i&lt;<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>;i++)</div>
<div class="line"><a name="l11891"></a><span class="lineno">11891</span>&#160;    {</div>
<div class="line"><a name="l11892"></a><span class="lineno">11892</span>&#160;      <span class="keywordflow">for</span>(j=0;j&lt;<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>;j++)</div>
<div class="line"><a name="l11893"></a><span class="lineno">11893</span>&#160;        {</div>
<div class="line"><a name="l11894"></a><span class="lineno">11894</span>&#160;          T2[<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>][<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>]=Tt[<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>][<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>];</div>
<div class="line"><a name="l11895"></a><span class="lineno">11895</span>&#160;        }</div>
<div class="line"><a name="l11896"></a><span class="lineno">11896</span>&#160;    }</div>
<div class="line"><a name="l11897"></a><span class="lineno">11897</span>&#160;</div>
<div class="line"><a name="l11898"></a><span class="lineno">11898</span>&#160;  <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l11899"></a><span class="lineno">11899</span>&#160;}</div>
<div class="line"><a name="l11900"></a><span class="lineno">11900</span>&#160;</div>
<div class="line"><a name="l11902"></a><span class="lineno">11902</span>&#160;<span class="keywordtype">int</span> indices_2122(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> T1[][NDIM],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> T2[][NDIM], <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom)</div>
<div class="line"><a name="l11903"></a><span class="lineno">11903</span>&#160;{</div>
<div class="line"><a name="l11904"></a><span class="lineno">11904</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>,<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>,k;</div>
<div class="line"><a name="l11905"></a><span class="lineno">11905</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Tt[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>][<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l11906"></a><span class="lineno">11906</span>&#160;</div>
<div class="line"><a name="l11907"></a><span class="lineno">11907</span>&#160;  <span class="keywordflow">for</span>(i=0;i&lt;<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>;i++)</div>
<div class="line"><a name="l11908"></a><span class="lineno">11908</span>&#160;    {</div>
<div class="line"><a name="l11909"></a><span class="lineno">11909</span>&#160;      <span class="keywordflow">for</span>(j=0;j&lt;<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>;j++)</div>
<div class="line"><a name="l11910"></a><span class="lineno">11910</span>&#160;        {</div>
<div class="line"><a name="l11911"></a><span class="lineno">11911</span>&#160;          Tt[<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>][<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>]=0.;</div>
<div class="line"><a name="l11912"></a><span class="lineno">11912</span>&#160;          <span class="keywordflow">for</span>(k=0;k&lt;<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>;k++)</div>
<div class="line"><a name="l11913"></a><span class="lineno">11913</span>&#160;            {</div>
<div class="line"><a name="l11914"></a><span class="lineno">11914</span>&#160;              Tt[<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>][<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>]+=T1[<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>][k]*ptrgeom-&gt;gcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(k,j)];</div>
<div class="line"><a name="l11915"></a><span class="lineno">11915</span>&#160;            }   </div>
<div class="line"><a name="l11916"></a><span class="lineno">11916</span>&#160;        }</div>
<div class="line"><a name="l11917"></a><span class="lineno">11917</span>&#160;    }</div>
<div class="line"><a name="l11918"></a><span class="lineno">11918</span>&#160;</div>
<div class="line"><a name="l11919"></a><span class="lineno">11919</span>&#160;  <span class="keywordflow">for</span>(i=0;i&lt;<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>;i++)</div>
<div class="line"><a name="l11920"></a><span class="lineno">11920</span>&#160;    {</div>
<div class="line"><a name="l11921"></a><span class="lineno">11921</span>&#160;      <span class="keywordflow">for</span>(j=0;j&lt;<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>;j++)</div>
<div class="line"><a name="l11922"></a><span class="lineno">11922</span>&#160;        {</div>
<div class="line"><a name="l11923"></a><span class="lineno">11923</span>&#160;          T2[<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>][<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>]=Tt[<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>][<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>];</div>
<div class="line"><a name="l11924"></a><span class="lineno">11924</span>&#160;        }</div>
<div class="line"><a name="l11925"></a><span class="lineno">11925</span>&#160;    }</div>
<div class="line"><a name="l11926"></a><span class="lineno">11926</span>&#160;</div>
<div class="line"><a name="l11927"></a><span class="lineno">11927</span>&#160;  <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l11928"></a><span class="lineno">11928</span>&#160;}</div>
<div class="line"><a name="l11929"></a><span class="lineno">11929</span>&#160;</div>
<div class="line"><a name="l11930"></a><span class="lineno">11930</span>&#160;<span class="comment">/*****************************************************************/</span></div>
<div class="line"><a name="l11931"></a><span class="lineno">11931</span>&#160;<span class="comment">/*****************************************************************/</span></div>
<div class="line"><a name="l11932"></a><span class="lineno">11932</span>&#160;<span class="comment">/*****************************************************************/</span></div>
<div class="line"><a name="l11934"></a><span class="lineno">11934</span>&#160;<span class="keywordtype">int</span> indices_21(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> A1[NDIM],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> A2[NDIM],<span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom)</div>
<div class="line"><a name="l11935"></a><span class="lineno">11935</span>&#160;{</div>
<div class="line"><a name="l11936"></a><span class="lineno">11936</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>,<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>,k;</div>
<div class="line"><a name="l11937"></a><span class="lineno">11937</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> At[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l11938"></a><span class="lineno">11938</span>&#160;</div>
<div class="line"><a name="l11939"></a><span class="lineno">11939</span>&#160;  <span class="keywordflow">for</span>(i=0;i&lt;<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>;i++)</div>
<div class="line"><a name="l11940"></a><span class="lineno">11940</span>&#160;    {</div>
<div class="line"><a name="l11941"></a><span class="lineno">11941</span>&#160;      At[<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>]=0.;</div>
<div class="line"><a name="l11942"></a><span class="lineno">11942</span>&#160;      <span class="keywordflow">for</span>(k=0;k&lt;<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>;k++)</div>
<div class="line"><a name="l11943"></a><span class="lineno">11943</span>&#160;        {</div>
<div class="line"><a name="l11944"></a><span class="lineno">11944</span>&#160;          At[<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>]+=A1[k]*ptrgeom-&gt;gcov[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(i,k)];</div>
<div class="line"><a name="l11945"></a><span class="lineno">11945</span>&#160;        }   </div>
<div class="line"><a name="l11946"></a><span class="lineno">11946</span>&#160;    }</div>
<div class="line"><a name="l11947"></a><span class="lineno">11947</span>&#160;</div>
<div class="line"><a name="l11948"></a><span class="lineno">11948</span>&#160;  <span class="keywordflow">for</span>(i=0;i&lt;<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>;i++)</div>
<div class="line"><a name="l11949"></a><span class="lineno">11949</span>&#160;    {</div>
<div class="line"><a name="l11950"></a><span class="lineno">11950</span>&#160;      A2[<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>]=At[<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>];</div>
<div class="line"><a name="l11951"></a><span class="lineno">11951</span>&#160;    }</div>
<div class="line"><a name="l11952"></a><span class="lineno">11952</span>&#160;</div>
<div class="line"><a name="l11953"></a><span class="lineno">11953</span>&#160;  <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l11954"></a><span class="lineno">11954</span>&#160;}</div>
<div class="line"><a name="l11955"></a><span class="lineno">11955</span>&#160;</div>
<div class="line"><a name="l11956"></a><span class="lineno">11956</span>&#160;<span class="comment">/*****************************************************************/</span></div>
<div class="line"><a name="l11957"></a><span class="lineno">11957</span>&#160;<span class="comment">/*****************************************************************/</span></div>
<div class="line"><a name="l11958"></a><span class="lineno">11958</span>&#160;<span class="comment">/*****************************************************************/</span></div>
<div class="line"><a name="l11960"></a><span class="lineno">11960</span>&#160;<span class="keywordtype">int</span> indices_12(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> A1[NDIM],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> A2[NDIM],<span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom)</div>
<div class="line"><a name="l11961"></a><span class="lineno">11961</span>&#160;{</div>
<div class="line"><a name="l11962"></a><span class="lineno">11962</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>,<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>,k;</div>
<div class="line"><a name="l11963"></a><span class="lineno">11963</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> At[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l11964"></a><span class="lineno">11964</span>&#160;</div>
<div class="line"><a name="l11965"></a><span class="lineno">11965</span>&#160;  <span class="keywordflow">for</span>(i=0;i&lt;<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>;i++)</div>
<div class="line"><a name="l11966"></a><span class="lineno">11966</span>&#160;    {</div>
<div class="line"><a name="l11967"></a><span class="lineno">11967</span>&#160;      At[<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>]=0.;</div>
<div class="line"><a name="l11968"></a><span class="lineno">11968</span>&#160;      <span class="keywordflow">for</span>(k=0;k&lt;<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>;k++)</div>
<div class="line"><a name="l11969"></a><span class="lineno">11969</span>&#160;        {</div>
<div class="line"><a name="l11970"></a><span class="lineno">11970</span>&#160;          At[<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>]+=A1[k]*ptrgeom-&gt;gcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(i,k)];</div>
<div class="line"><a name="l11971"></a><span class="lineno">11971</span>&#160;        }   </div>
<div class="line"><a name="l11972"></a><span class="lineno">11972</span>&#160;    }</div>
<div class="line"><a name="l11973"></a><span class="lineno">11973</span>&#160;</div>
<div class="line"><a name="l11974"></a><span class="lineno">11974</span>&#160;  <span class="keywordflow">for</span>(i=0;i&lt;<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>;i++)</div>
<div class="line"><a name="l11975"></a><span class="lineno">11975</span>&#160;    {</div>
<div class="line"><a name="l11976"></a><span class="lineno">11976</span>&#160;      A2[<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>]=At[<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>];</div>
<div class="line"><a name="l11977"></a><span class="lineno">11977</span>&#160;    }</div>
<div class="line"><a name="l11978"></a><span class="lineno">11978</span>&#160;</div>
<div class="line"><a name="l11979"></a><span class="lineno">11979</span>&#160;  <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l11980"></a><span class="lineno">11980</span>&#160;}</div>
<div class="line"><a name="l11981"></a><span class="lineno">11981</span>&#160;</div>
<div class="line"><a name="l11982"></a><span class="lineno">11982</span>&#160;</div>
<div class="line"><a name="l11983"></a><span class="lineno">11983</span>&#160;</div>
<div class="line"><a name="l11984"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aca8e86da8eb620a3a3e3487b420df3e1">11984</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#a9fe58e7f372421d18633c8fc5007b815">u2p_rad</a>(<span class="keywordtype">int</span> showmessages, <span class="keywordtype">int</span> allowlocalfailurefixandnoreport, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammamaxrad, <span class="keywordtype">int</span> whichcap, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *uu, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pin, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflag, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflagrad)</div>
<div class="line"><a name="l11985"></a><span class="lineno">11985</span>&#160;{</div>
<div class="line"><a name="l11986"></a><span class="lineno">11986</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a67b370af2fa58283bc590ff4e895fb90" title="Like u2p_rad_orig(), but uses Jon&#39;s paper draft ZAMO RAD version.">u2p_rad_new</a>(<span class="keywordtype">int</span> showmessages, <span class="keywordtype">int</span> allowlocalfailurefixandnoreport, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammamaxrad, <span class="keywordtype">int</span> whichcap, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *uu, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pin, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflag, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflagrad);</div>
<div class="line"><a name="l11987"></a><span class="lineno">11987</span>&#160;  <span class="keywordtype">int</span> u2p_rad_orig(<span class="keywordtype">int</span> showmessages, <span class="keywordtype">int</span> allowlocalfailurefixandnoreport, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammamaxrad, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *uu, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pin, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflag, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflagrad);</div>
<div class="line"><a name="l11988"></a><span class="lineno">11988</span>&#160;  <span class="keywordtype">int</span> u2p_rad_new_pre(<span class="keywordtype">int</span> showmessages, <span class="keywordtype">int</span> allowlocalfailurefixandnoreport, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammamaxrad, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *uu, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pin, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflag, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflagrad);</div>
<div class="line"><a name="l11989"></a><span class="lineno">11989</span>&#160;  <span class="keywordtype">int</span> toreturn;</div>
<div class="line"><a name="l11990"></a><span class="lineno">11990</span>&#160;  <span class="keywordtype">int</span> pliter,pl;</div>
<div class="line"><a name="l11991"></a><span class="lineno">11991</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> prorig[NPR];</div>
<div class="line"><a name="l11992"></a><span class="lineno">11992</span>&#160;</div>
<div class="line"><a name="l11993"></a><span class="lineno">11993</span>&#160;</div>
<div class="line"><a name="l11995"></a><span class="lineno">11995</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l11996"></a><span class="lineno">11996</span>&#160;  <span class="comment">// CHECK if should abort inversion attempt if already dropped-out value in uu</span></div>
<div class="line"><a name="l11997"></a><span class="lineno">11997</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l11999"></a><span class="lineno">11999</span>&#160;<span class="comment"></span><span class="preprocessor">#if(0)</span></div>
<div class="line"><a name="l12000"></a><span class="lineno">12000</span>&#160;<span class="preprocessor"></span>    <span class="comment">// put in a catch for when inputted uu[URAD0] has dropped-out already and don&#39;t try to invert.</span></div>
<div class="line"><a name="l12001"></a><span class="lineno">12001</span>&#160;    <span class="keywordflow">if</span>(fabs(uu[URAD0]&lt;=2.0*10.0*<a class="code" href="../../d8/d5b/defs_8general_8h.html#a5bd9da451f108352614cbc457524c5b0">ERADLIMIT</a>)){ <span class="comment">// often 10*ERADLIMIT is used to set as above ERADLIMIT, so here a higher catch is 2*10*ERADLIMIT</span></div>
<div class="line"><a name="l12002"></a><span class="lineno">12002</span>&#160;      <span class="comment">// force to be reasonable</span></div>
<div class="line"><a name="l12003"></a><span class="lineno">12003</span>&#160;      <span class="comment">// currently always return WHICHVEL=VELREL4, so just set to floor values</span></div>
<div class="line"><a name="l12004"></a><span class="lineno">12004</span>&#160;      pin[URAD0]=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a5bd9da451f108352614cbc457524c5b0">ERADLIMIT</a>;</div>
<div class="line"><a name="l12005"></a><span class="lineno">12005</span>&#160;      <span class="keywordtype">int</span> jj;</div>
<div class="line"><a name="l12006"></a><span class="lineno">12006</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) pin[URAD1+jj-1] = 0.0;</div>
<div class="line"><a name="l12007"></a><span class="lineno">12007</span>&#160;      <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l12008"></a><span class="lineno">12008</span>&#160;    }</div>
<div class="line"><a name="l12009"></a><span class="lineno">12009</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l12010"></a><span class="lineno">12010</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l12011"></a><span class="lineno">12011</span>&#160;</div>
<div class="line"><a name="l12013"></a><span class="lineno">12013</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l12014"></a><span class="lineno">12014</span>&#160;  <span class="comment">// NORMAL ATTEMPT where we compute inversion</span></div>
<div class="line"><a name="l12015"></a><span class="lineno">12015</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l12017"></a><span class="lineno">12017</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l12018"></a><span class="lineno">12018</span>&#160;</div>
<div class="line"><a name="l12019"></a><span class="lineno">12019</span>&#160;  <span class="comment">// store orig</span></div>
<div class="line"><a name="l12020"></a><span class="lineno">12020</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) prorig[pl] = pin[pl];</div>
<div class="line"><a name="l12021"></a><span class="lineno">12021</span>&#160;</div>
<div class="line"><a name="l12022"></a><span class="lineno">12022</span>&#160;<span class="preprocessor">#if(WHICHU2PRAD==0)</span></div>
<div class="line"><a name="l12023"></a><span class="lineno">12023</span>&#160;<span class="preprocessor"></span>  toreturn=u2p_rad_orig(showmessages, allowlocalfailurefixandnoreport, gammamaxrad, uu, pin, ptrgeom,lpflag, lpflagrad);</div>
<div class="line"><a name="l12024"></a><span class="lineno">12024</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l12025"></a><span class="lineno">12025</span>&#160;<span class="preprocessor"></span>  <span class="comment">//toreturn=u2p_rad_new_pre(showmessages, allowlocalfailurefixandnoreport, gammamaxrad, uu, pin, ptrgeom,lpflag, lpflagrad);</span></div>
<div class="line"><a name="l12026"></a><span class="lineno">12026</span>&#160;  toreturn=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a67b370af2fa58283bc590ff4e895fb90" title="Like u2p_rad_orig(), but uses Jon&#39;s paper draft ZAMO RAD version.">u2p_rad_new</a>(showmessages, allowlocalfailurefixandnoreport, gammamaxrad, whichcap, uu, pin, ptrgeom,lpflag, lpflagrad);</div>
<div class="line"><a name="l12027"></a><span class="lineno">12027</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l12028"></a><span class="lineno">12028</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l12029"></a><span class="lineno">12029</span>&#160;</div>
<div class="line"><a name="l12030"></a><span class="lineno">12030</span>&#160;  <span class="comment">// scalar inversions</span></div>
<div class="line"><a name="l12031"></a><span class="lineno">12031</span>&#160;  </div>
<div class="line"><a name="l12032"></a><span class="lineno">12032</span>&#160;</div>
<div class="line"><a name="l12033"></a><span class="lineno">12033</span>&#160;</div>
<div class="line"><a name="l12034"></a><span class="lineno">12034</span>&#160;</div>
<div class="line"><a name="l12035"></a><span class="lineno">12035</span>&#160;</div>
<div class="line"><a name="l12036"></a><span class="lineno">12036</span>&#160;<span class="preprocessor">#if(PRODUCTION==0)</span></div>
<div class="line"><a name="l12037"></a><span class="lineno">12037</span>&#160;<span class="preprocessor"></span>  <span class="keywordtype">int</span> caughtnan=0;</div>
<div class="line"><a name="l12038"></a><span class="lineno">12038</span>&#160;  <span class="keywordflow">if</span>(!finite(pin[URAD0]) || !finite(pin[URAD1]) || !finite(pin[URAD2]) || !finite(pin[URAD3])){</div>
<div class="line"><a name="l12039"></a><span class="lineno">12039</span>&#160;    <span class="comment">// __WORKINGONIT__: Shouldn&#39;t happen, but does on Kraken</span></div>
<div class="line"><a name="l12040"></a><span class="lineno">12040</span>&#160;    caughtnan=1;</div>
<div class="line"><a name="l12041"></a><span class="lineno">12041</span>&#160;  }</div>
<div class="line"><a name="l12042"></a><span class="lineno">12042</span>&#160;</div>
<div class="line"><a name="l12043"></a><span class="lineno">12043</span>&#160;  <span class="keywordflow">if</span>(caughtnan){</div>
<div class="line"><a name="l12044"></a><span class="lineno">12044</span>&#160;</div>
<div class="line"><a name="l12045"></a><span class="lineno">12045</span>&#160;    <span class="keywordflow">if</span>(debugfail&gt;=2){</div>
<div class="line"><a name="l12046"></a><span class="lineno">12046</span>&#160;      dualfprintf(fail_file,<span class="stringliteral">&quot;u2p_rad() generated nan result: %d %d %g %d\n&quot;</span>,showmessages, allowlocalfailurefixandnoreport, gammamaxrad, whichcap);</div>
<div class="line"><a name="l12047"></a><span class="lineno">12047</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) dualfprintf(fail_file,<span class="stringliteral">&quot;u2p_rad: pl=%d prorig=%21.15g uu=%21.15g pin=%21.15g\n&quot;</span>,pl,prorig[pl],uu[pl],pin[pl]);</div>
<div class="line"><a name="l12048"></a><span class="lineno">12048</span>&#160;    }</div>
<div class="line"><a name="l12049"></a><span class="lineno">12049</span>&#160;</div>
<div class="line"><a name="l12050"></a><span class="lineno">12050</span>&#160;</div>
<div class="line"><a name="l12051"></a><span class="lineno">12051</span>&#160;    <span class="keywordflow">if</span>(0){ <span class="comment">// __WORKINGONIT__: if doing iterations, need to let fail with nan so aborts and stops trying right away.  Otherwise huge waste.</span></div>
<div class="line"><a name="l12052"></a><span class="lineno">12052</span>&#160;      <span class="comment">// force to be reasonable</span></div>
<div class="line"><a name="l12053"></a><span class="lineno">12053</span>&#160;      <span class="comment">// currently always return WHICHVEL=VELREL4, so just set to floor values</span></div>
<div class="line"><a name="l12054"></a><span class="lineno">12054</span>&#160;      pin[URAD0]=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a5bd9da451f108352614cbc457524c5b0">ERADLIMIT</a>;</div>
<div class="line"><a name="l12055"></a><span class="lineno">12055</span>&#160;      <span class="keywordtype">int</span> jj;</div>
<div class="line"><a name="l12056"></a><span class="lineno">12056</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) pin[URAD1+jj-1] = 0.0;</div>
<div class="line"><a name="l12057"></a><span class="lineno">12057</span>&#160;    }</div>
<div class="line"><a name="l12058"></a><span class="lineno">12058</span>&#160;</div>
<div class="line"><a name="l12059"></a><span class="lineno">12059</span>&#160;  }</div>
<div class="line"><a name="l12060"></a><span class="lineno">12060</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l12061"></a><span class="lineno">12061</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l12062"></a><span class="lineno">12062</span>&#160;</div>
<div class="line"><a name="l12063"></a><span class="lineno">12063</span>&#160;</div>
<div class="line"><a name="l12064"></a><span class="lineno">12064</span>&#160;</div>
<div class="line"><a name="l12065"></a><span class="lineno">12065</span>&#160;</div>
<div class="line"><a name="l12066"></a><span class="lineno">12066</span>&#160;  <span class="keywordflow">return</span>(toreturn);</div>
<div class="line"><a name="l12067"></a><span class="lineno">12067</span>&#160;}</div>
<div class="line"><a name="l12068"></a><span class="lineno">12068</span>&#160;</div>
<div class="line"><a name="l12069"></a><span class="lineno">12069</span>&#160;</div>
<div class="line"><a name="l12070"></a><span class="lineno">12070</span>&#160;</div>
<div class="line"><a name="l12076"></a><span class="lineno">12076</span>&#160;<span class="keywordtype">int</span> u2p_rad_new_pre(<span class="keywordtype">int</span> showmessages, <span class="keywordtype">int</span> allowlocalfailurefixandnoreport, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammamaxrad, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *uu, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pin, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflag, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflagrad)</div>
<div class="line"><a name="l12077"></a><span class="lineno">12077</span>&#160;{</div>
<div class="line"><a name="l12078"></a><span class="lineno">12078</span>&#160;  <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> numyvarneg,numyvarbig,numErneg,nummod;</div>
<div class="line"><a name="l12079"></a><span class="lineno">12079</span>&#160;  <span class="keywordtype">int</span> recomputegamma=0;</div>
<div class="line"><a name="l12080"></a><span class="lineno">12080</span>&#160;</div>
<div class="line"><a name="l12081"></a><span class="lineno">12081</span>&#160;<span class="preprocessor">#if(WHICHVEL!=VELREL4)</span></div>
<div class="line"><a name="l12082"></a><span class="lineno">12082</span>&#160;<span class="preprocessor"></span>  dualfprintf(fail_file,<span class="stringliteral">&quot;u2p_rad() only setup for relative 4-velocity, currently.\n&quot;</span>);</div>
<div class="line"><a name="l12083"></a><span class="lineno">12083</span>&#160;  myexit(137432636);</div>
<div class="line"><a name="l12084"></a><span class="lineno">12084</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l12085"></a><span class="lineno">12085</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l12086"></a><span class="lineno">12086</span>&#160;</div>
<div class="line"><a name="l12087"></a><span class="lineno">12087</span>&#160;  <span class="comment">// copy over pin so pin isn&#39;t modified until end</span></div>
<div class="line"><a name="l12088"></a><span class="lineno">12088</span>&#160;  <span class="keywordtype">int</span> pliter,pl;</div>
<div class="line"><a name="l12089"></a><span class="lineno">12089</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> pp[NPR];</div>
<div class="line"><a name="l12090"></a><span class="lineno">12090</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) pp[pl]=pin[pl];</div>
<div class="line"><a name="l12091"></a><span class="lineno">12091</span>&#160;</div>
<div class="line"><a name="l12093"></a><span class="lineno">12093</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l12094"></a><span class="lineno">12094</span>&#160;  <span class="comment">// Prepare inversion from U-&gt;p for radiation assuming M1 closure</span></div>
<div class="line"><a name="l12095"></a><span class="lineno">12095</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l12097"></a><span class="lineno">12097</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l12098"></a><span class="lineno">12098</span>&#160;  *lpflagrad=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6435e9609d622c9dbaf78c12658ecf8e">UTOPRIMRADNOFAIL</a>;</div>
<div class="line"><a name="l12099"></a><span class="lineno">12099</span>&#160;</div>
<div class="line"><a name="l12100"></a><span class="lineno">12100</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Er,Utildesq,Utildecon[NDIM];</div>
<div class="line"><a name="l12101"></a><span class="lineno">12101</span>&#160;  <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a77c546a7fb064266fef5a9e796dc63dc" title="compute ZAMO version of radiation quantities as in paper draft">compute_ZAMORAD</a>(uu, ptrgeom, &amp;Er, &amp;Utildesq, Utildecon);</div>
<div class="line"><a name="l12102"></a><span class="lineno">12102</span>&#160;  </div>
<div class="line"><a name="l12103"></a><span class="lineno">12103</span>&#160;</div>
<div class="line"><a name="l12104"></a><span class="lineno">12104</span>&#160;</div>
<div class="line"><a name="l12105"></a><span class="lineno">12105</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Ersq,yvar;</div>
<div class="line"><a name="l12106"></a><span class="lineno">12106</span>&#160;  <span class="keywordtype">int</span> didmod=0;</div>
<div class="line"><a name="l12107"></a><span class="lineno">12107</span>&#160;</div>
<div class="line"><a name="l12108"></a><span class="lineno">12108</span>&#160;  <span class="comment">//  if(1||gammamaxrad&gt;0.9*GAMMAMAXRADIMPLICITSOLVER || Er&gt;=ERADLIMIT){ // then good solution.  Avoid caps during implicit solver to allow progress on solution in smooth way.</span></div>
<div class="line"><a name="l12109"></a><span class="lineno">12109</span>&#160;  if(Er&gt;=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a5bd9da451f108352614cbc457524c5b0">ERADLIMIT</a>){ <span class="comment">// then good solution.  Avoid caps during implicit solver to allow progress on solution in smooth way.</span></div>
<div class="line"><a name="l12110"></a><span class="lineno">12110</span>&#160;    <span class="comment">// Er^2</span></div>
<div class="line"><a name="l12111"></a><span class="lineno">12111</span>&#160;    Ersq=Er*Er;</div>
<div class="line"><a name="l12112"></a><span class="lineno">12112</span>&#160;    <span class="comment">// y</span></div>
<div class="line"><a name="l12113"></a><span class="lineno">12113</span>&#160;    yvar = Utildesq / (ERADLIMIT*ERADLIMIT + Ersq); <span class="comment">// ERADLIMIT*ERADLIMIT better be machine representable in case Ersq is not.</span></div>
<div class="line"><a name="l12114"></a><span class="lineno">12114</span>&#160;  }</div>
<div class="line"><a name="l12115"></a><span class="lineno">12115</span>&#160;  <span class="keywordflow">else</span>{<span class="comment">// then bad solution</span></div>
<div class="line"><a name="l12116"></a><span class="lineno">12116</span>&#160;    <span class="comment">//    dualfprintf(fail_file,&quot;Er=%26.20g&lt;ERADLIMIT=%26.20g yvar=%26.20g Utildesq=%26.20g Ersq=%26.20g\n&quot;,Er,ERADLIMIT,yvar,Utildesq,Ersq);</span></div>
<div class="line"><a name="l12117"></a><span class="lineno">12117</span>&#160;    Ersq=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a5bd9da451f108352614cbc457524c5b0">ERADLIMIT</a>*<a class="code" href="../../d8/d5b/defs_8general_8h.html#a5bd9da451f108352614cbc457524c5b0">ERADLIMIT</a>;</div>
<div class="line"><a name="l12118"></a><span class="lineno">12118</span>&#160;    yvar = 0.0;</div>
<div class="line"><a name="l12119"></a><span class="lineno">12119</span>&#160;    didmod=1;</div>
<div class="line"><a name="l12120"></a><span class="lineno">12120</span>&#160;    numErneg++;</div>
<div class="line"><a name="l12121"></a><span class="lineno">12121</span>&#160;  }</div>
<div class="line"><a name="l12122"></a><span class="lineno">12122</span>&#160;</div>
<div class="line"><a name="l12123"></a><span class="lineno">12123</span>&#160;  <span class="comment">//  dualfprintf(fail_file,&quot;Er=%g Utildesq=%g\n&quot;,Er,Utildesq);</span></div>
<div class="line"><a name="l12124"></a><span class="lineno">12124</span>&#160;</div>
<div class="line"><a name="l12125"></a><span class="lineno">12125</span>&#160;  <span class="comment">// \gamma_{\rm rad}^2 :  only 1 root</span></div>
<div class="line"><a name="l12126"></a><span class="lineno">12126</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammasq,gamma;</div>
<div class="line"><a name="l12127"></a><span class="lineno">12127</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammamax=gammamaxrad;</div>
<div class="line"><a name="l12128"></a><span class="lineno">12128</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammamaxsq=gammamax*gammamax;</div>
<div class="line"><a name="l12129"></a><span class="lineno">12129</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ylimit = 16.0*gammamaxsq*(gammamaxsq-1.0)/((4.0*gammamaxsq-1.0)*(4.0*gammamaxsq-1.0));</div>
<div class="line"><a name="l12130"></a><span class="lineno">12130</span>&#160;  <span class="keywordflow">if</span>(yvar&lt;0.0){</div>
<div class="line"><a name="l12131"></a><span class="lineno">12131</span>&#160;    <span class="comment">//    dualfprintf(fail_file,&quot;Er=%26.20g yvar=%26.20g&lt;0.0 Utildesq=%26.20g Ersq=%26.20g\n&quot;,Er,yvar,Utildesq,Ersq);</span></div>
<div class="line"><a name="l12132"></a><span class="lineno">12132</span>&#160;    yvar=0.0;</div>
<div class="line"><a name="l12133"></a><span class="lineno">12133</span>&#160;    gammasq = 1.0;</div>
<div class="line"><a name="l12134"></a><span class="lineno">12134</span>&#160;    gamma = 1.0;</div>
<div class="line"><a name="l12135"></a><span class="lineno">12135</span>&#160;    didmod=1;</div>
<div class="line"><a name="l12136"></a><span class="lineno">12136</span>&#160;    numyvarneg++;</div>
<div class="line"><a name="l12137"></a><span class="lineno">12137</span>&#160;  }</div>
<div class="line"><a name="l12138"></a><span class="lineno">12138</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(yvar&gt;ylimit){ <span class="comment">// beyond gamma limit, then rescale gamma</span></div>
<div class="line"><a name="l12139"></a><span class="lineno">12139</span>&#160;    yvar=ylimit;</div>
<div class="line"><a name="l12140"></a><span class="lineno">12140</span>&#160;    gammasq = gammamaxsq;</div>
<div class="line"><a name="l12141"></a><span class="lineno">12141</span>&#160;    gamma = gammamax;</div>
<div class="line"><a name="l12142"></a><span class="lineno">12142</span>&#160;    didmod=1; *lpflagrad=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#af1ba8d5f13f64649f7f731147526401d">UTOPRIMRADFAILCASE2A</a>; <span class="comment">// used to detec if modified primitives to not be consistent with inputted uu</span></div>
<div class="line"><a name="l12143"></a><span class="lineno">12143</span>&#160;    numyvarbig++;</div>
<div class="line"><a name="l12144"></a><span class="lineno">12144</span>&#160;    <span class="comment">//    dualfprintf(fail_file,&quot;yvar=%g&gt;%g Ersq=%g gamma=%g\n&quot;,yvar,ylimit,Ersq,gamma);</span></div>
<div class="line"><a name="l12145"></a><span class="lineno">12145</span>&#160;  }</div>
<div class="line"><a name="l12146"></a><span class="lineno">12146</span>&#160;  <span class="keywordflow">else</span>{ <span class="comment">// normal solution</span></div>
<div class="line"><a name="l12147"></a><span class="lineno">12147</span>&#160;    gammasq = (2.0 - yvar + sqrt(4.0-3.0*yvar))/ (4.0*(1.0-yvar));</div>
<div class="line"><a name="l12148"></a><span class="lineno">12148</span>&#160;    gamma=sqrt(gammasq);</div>
<div class="line"><a name="l12149"></a><span class="lineno">12149</span>&#160;    <span class="comment">//    dualfprintf(fail_file,&quot;yvar=%g Ersq=%g gamma=%g\n&quot;,yvar,Ersq,gamma);</span></div>
<div class="line"><a name="l12150"></a><span class="lineno">12150</span>&#160;  }</div>
<div class="line"><a name="l12151"></a><span class="lineno">12151</span>&#160;</div>
<div class="line"><a name="l12152"></a><span class="lineno">12152</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Erf;</div>
<div class="line"><a name="l12153"></a><span class="lineno">12153</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> urfconrel[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>]={0.0};</div>
<div class="line"><a name="l12154"></a><span class="lineno">12154</span>&#160;  <span class="keywordtype">int</span> jj;</div>
<div class="line"><a name="l12155"></a><span class="lineno">12155</span>&#160;  <span class="comment">//  if(1||gammamaxrad&gt;0.9*GAMMAMAXRADIMPLICITSOLVER || Er&gt;=ERADLIMIT){ // then good solution.  Avoid caps during implicit solver to allow progress on solution in smooth way.</span></div>
<div class="line"><a name="l12156"></a><span class="lineno">12156</span>&#160;  <span class="keywordflow">if</span>(Er&gt;=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a5bd9da451f108352614cbc457524c5b0">ERADLIMIT</a>){ <span class="comment">// then good solution.  Avoid caps during implicit solver to allow progress on solution in smooth way.</span></div>
<div class="line"><a name="l12157"></a><span class="lineno">12157</span>&#160;    <span class="comment">// now obtain primitives</span></div>
<div class="line"><a name="l12158"></a><span class="lineno">12158</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> pr = Er/(4.0*gammasq-1.0);</div>
<div class="line"><a name="l12159"></a><span class="lineno">12159</span>&#160;    <span class="comment">// radiation frame energy density</span></div>
<div class="line"><a name="l12160"></a><span class="lineno">12160</span>&#160;    <span class="comment">//    Erf = pr/(4.0/3.0-1.0);</span></div>
<div class="line"><a name="l12161"></a><span class="lineno">12161</span>&#160;    Erf = 3.0*<a class="code" href="../../dc/dd2/newcodediff_8txt.html#ae7ab77d7e616dc02fba121a009b48c27">pr</a>;</div>
<div class="line"><a name="l12162"></a><span class="lineno">12162</span>&#160;    </div>
<div class="line"><a name="l12163"></a><span class="lineno">12163</span>&#160;    <span class="comment">// radiation frame relativity 4-velocity</span></div>
<div class="line"><a name="l12164"></a><span class="lineno">12164</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) urfconrel[jj] = (Utildecon[jj]/(4.0*pr*gamma));</div>
<div class="line"><a name="l12165"></a><span class="lineno">12165</span>&#160;    recomputegamma=1;</div>
<div class="line"><a name="l12166"></a><span class="lineno">12166</span>&#160;  }</div>
<div class="line"><a name="l12167"></a><span class="lineno">12167</span>&#160;  else{</div>
<div class="line"><a name="l12168"></a><span class="lineno">12168</span>&#160;    Erf = <a class="code" href="../../d8/d5b/defs_8general_8h.html#a5bd9da451f108352614cbc457524c5b0">ERADLIMIT</a>;</div>
<div class="line"><a name="l12169"></a><span class="lineno">12169</span>&#160;    gamma=1.0;</div>
<div class="line"><a name="l12170"></a><span class="lineno">12170</span>&#160;    <span class="comment">// radiation frame relativity 4-velocity</span></div>
<div class="line"><a name="l12171"></a><span class="lineno">12171</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) urfconrel[jj] = 0.0;</div>
<div class="line"><a name="l12172"></a><span class="lineno">12172</span>&#160;    recomputegamma=1;</div>
<div class="line"><a name="l12173"></a><span class="lineno">12173</span>&#160;    didmod=1; *lpflagrad=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a38b0585ec02d900ad0413645acb00918">UTOPRIMRADFAILERFNEG</a>; <span class="comment">// used to detect if modified primitives to not be consistent with inputted uu</span></div>
<div class="line"><a name="l12174"></a><span class="lineno">12174</span>&#160;  }</div>
<div class="line"><a name="l12175"></a><span class="lineno">12175</span>&#160;</div>
<div class="line"><a name="l12176"></a><span class="lineno">12176</span>&#160;</div>
<div class="line"><a name="l12178"></a><span class="lineno">12178</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l12179"></a><span class="lineno">12179</span>&#160;  <span class="comment">//new primitives (only uses urfcon[1-3])</span></div>
<div class="line"><a name="l12180"></a><span class="lineno">12180</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l12182"></a><span class="lineno">12182</span>&#160;<span class="comment"></span>  pin[PRAD0]=Erf;</div>
<div class="line"><a name="l12183"></a><span class="lineno">12183</span>&#160;  pin[PRAD1]=urfconrel[1];</div>
<div class="line"><a name="l12184"></a><span class="lineno">12184</span>&#160;  pin[PRAD2]=urfconrel[2];</div>
<div class="line"><a name="l12185"></a><span class="lineno">12185</span>&#160;  pin[PRAD3]=urfconrel[3];</div>
<div class="line"><a name="l12186"></a><span class="lineno">12186</span>&#160;</div>
<div class="line"><a name="l12187"></a><span class="lineno">12187</span>&#160;  <span class="comment">//  dualfprintf(fail_file,&quot;didmod=%d\n&quot;,didmod);</span></div>
<div class="line"><a name="l12188"></a><span class="lineno">12188</span>&#160;</div>
<div class="line"><a name="l12189"></a><span class="lineno">12189</span>&#160;  <span class="comment">// make sure E_r no larger than starting value</span></div>
<div class="line"><a name="l12190"></a><span class="lineno">12190</span>&#160;  if(didmod==1){</div>
<div class="line"><a name="l12191"></a><span class="lineno">12191</span>&#160;    nummod++;</div>
<div class="line"><a name="l12192"></a><span class="lineno">12192</span>&#160;    </div>
<div class="line"><a name="l12193"></a><span class="lineno">12193</span>&#160;</div>
<div class="line"><a name="l12194"></a><span class="lineno">12194</span>&#160;    <span class="comment">// First, ensure \gamma correct</span></div>
<div class="line"><a name="l12195"></a><span class="lineno">12195</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammanew,qsqnew;</div>
<div class="line"><a name="l12196"></a><span class="lineno">12196</span>&#160;    <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#abfae38e47b0bd05a4fc38302ff948a96" title="find gamma-factor wrt normal observer This function and qsq_calc() have about the same cache miss amo...">gamma_calc_fromuconrel</a>(&amp;pin[URAD1-1],ptrgeom,&amp;gammanew,&amp;qsqnew);</div>
<div class="line"><a name="l12197"></a><span class="lineno">12197</span>&#160;    <span class="comment">//    dualfprintf(fail_file,&quot;gamma=%g gammanew=%g\n&quot;,gamma,gammanew);</span></div>
<div class="line"><a name="l12198"></a><span class="lineno">12198</span>&#160;</div>
<div class="line"><a name="l12199"></a><span class="lineno">12199</span>&#160;    <span class="comment">// rescale, assuming want to be gamma</span></div>
<div class="line"><a name="l12200"></a><span class="lineno">12200</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fvar=sqrt((gamma*gamma-1.0)/(gammanew*gammanew-1.0));</div>
<div class="line"><a name="l12201"></a><span class="lineno">12201</span>&#160;    <span class="keywordflow">if</span>(gammanew&gt;1.0){</div>
<div class="line"><a name="l12202"></a><span class="lineno">12202</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) urfconrel[jj] *= fvar;</div>
<div class="line"><a name="l12203"></a><span class="lineno">12203</span>&#160;    }</div>
<div class="line"><a name="l12204"></a><span class="lineno">12204</span>&#160;    else{</div>
<div class="line"><a name="l12205"></a><span class="lineno">12205</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) urfconrel[jj] *= 0.0;</div>
<div class="line"><a name="l12206"></a><span class="lineno">12206</span>&#160;    }</div>
<div class="line"><a name="l12207"></a><span class="lineno">12207</span>&#160;    recomputegamma=1;</div>
<div class="line"><a name="l12208"></a><span class="lineno">12208</span>&#160;</div>
<div class="line"><a name="l12209"></a><span class="lineno">12209</span>&#160;    <span class="comment">//    dualfprintf(fail_file,&quot;urfconrel=%g %g %g\n&quot;,urfconrel[1],urfconrel[2],urfconrel[3]);</span></div>
<div class="line"><a name="l12210"></a><span class="lineno">12210</span>&#160;</div>
<div class="line"><a name="l12211"></a><span class="lineno">12211</span>&#160;    </div>
<div class="line"><a name="l12212"></a><span class="lineno">12212</span>&#160;    <span class="comment">// new prims</span></div>
<div class="line"><a name="l12213"></a><span class="lineno">12213</span>&#160;    pin[PRAD1]=urfconrel[1];</div>
<div class="line"><a name="l12214"></a><span class="lineno">12214</span>&#160;    pin[PRAD2]=urfconrel[2];</div>
<div class="line"><a name="l12215"></a><span class="lineno">12215</span>&#160;    pin[PRAD3]=urfconrel[3];</div>
<div class="line"><a name="l12216"></a><span class="lineno">12216</span>&#160;</div>
<div class="line"><a name="l12217"></a><span class="lineno">12217</span>&#160;    if(0){ <span class="comment">// causes more problems for implicit solver.</span></div>
<div class="line"><a name="l12218"></a><span class="lineno">12218</span>&#160;</div>
<div class="line"><a name="l12219"></a><span class="lineno">12219</span>&#160;      <span class="comment">// Second, ensure not creating energy in ZAMO frame</span></div>
<div class="line"><a name="l12220"></a><span class="lineno">12220</span>&#160;      <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> q;</div>
<div class="line"><a name="l12221"></a><span class="lineno">12221</span>&#160;      <a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#a8a762bf6582e6f7e1199de9c43b98454" title="Get only u^ and u_ assumine b^ and b_ not used.">get_state_uradconuradcovonly</a>(pin, ptrgeom, &amp;q);</div>
<div class="line"><a name="l12222"></a><span class="lineno">12222</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Rtnu[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l12223"></a><span class="lineno">12223</span>&#160;      <a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#a389bf7e41d2fd117af996e3392067cdc" title="compute radiation stres-energy tensor assuming M1 closure">mhd_calc_rad</a>( pin, TT, ptrgeom, &amp;q, Rtnu, NULL );</div>
<div class="line"><a name="l12224"></a><span class="lineno">12224</span>&#160;      <span class="comment">//    dualfprintf(fail_file,&quot;Rtnu=%g %g %g %g\n&quot;,Rtnu[0],Rtnu[1],Rtnu[2],Rtnu[3]);</span></div>
<div class="line"><a name="l12225"></a><span class="lineno">12225</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Ernew,Utildesqnew,Utildeconnew;</div>
<div class="line"><a name="l12226"></a><span class="lineno">12226</span>&#160;      <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a77c546a7fb064266fef5a9e796dc63dc" title="compute ZAMO version of radiation quantities as in paper draft">compute_ZAMORAD</a>(&amp;Rtnu[0-URAD0], ptrgeom, &amp;Ernew, &amp;Utildesqnew, &amp;Utildeconnew); <span class="comment">// out of range warning ok.</span></div>
<div class="line"><a name="l12227"></a><span class="lineno">12227</span>&#160;      Erf = Erf*<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(1.0,Er/Ernew);</div>
<div class="line"><a name="l12228"></a><span class="lineno">12228</span>&#160;    }</div>
<div class="line"><a name="l12229"></a><span class="lineno">12229</span>&#160;</div>
<div class="line"><a name="l12230"></a><span class="lineno">12230</span>&#160;    *lpflagrad=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#af1ba8d5f13f64649f7f731147526401d">UTOPRIMRADFAILCASE2A</a>;</div>
<div class="line"><a name="l12231"></a><span class="lineno">12231</span>&#160;</div>
<div class="line"><a name="l12232"></a><span class="lineno">12232</span>&#160;    <span class="comment">// could continue iterating, or should find closed form expressions for all this.</span></div>
<div class="line"><a name="l12233"></a><span class="lineno">12233</span>&#160;    <span class="comment">//    dualfprintf(fail_file,&quot;Ernew=%g Utildesqnew=%g\n&quot;,Ernew,Utildesqnew);</span></div>
<div class="line"><a name="l12234"></a><span class="lineno">12234</span>&#160;  }</div>
<div class="line"><a name="l12235"></a><span class="lineno">12235</span>&#160;</div>
<div class="line"><a name="l12236"></a><span class="lineno">12236</span>&#160;</div>
<div class="line"><a name="l12238"></a><span class="lineno">12238</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l12239"></a><span class="lineno">12239</span>&#160;  <span class="comment">// really new primitives (only uses urfcon[1-3])</span></div>
<div class="line"><a name="l12240"></a><span class="lineno">12240</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l12242"></a><span class="lineno">12242</span>&#160;<span class="comment"></span>  pin[PRAD0]=Erf;</div>
<div class="line"><a name="l12243"></a><span class="lineno">12243</span>&#160;  pin[PRAD1]=urfconrel[1];</div>
<div class="line"><a name="l12244"></a><span class="lineno">12244</span>&#160;  pin[PRAD2]=urfconrel[2];</div>
<div class="line"><a name="l12245"></a><span class="lineno">12245</span>&#160;  pin[PRAD3]=urfconrel[3];</div>
<div class="line"><a name="l12246"></a><span class="lineno">12246</span>&#160;</div>
<div class="line"><a name="l12247"></a><span class="lineno">12247</span>&#160;</div>
<div class="line"><a name="l12249"></a><span class="lineno">12249</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l12250"></a><span class="lineno">12250</span>&#160;  <span class="comment">// INVERT to get Number density of photons in radiation frame</span></div>
<div class="line"><a name="l12251"></a><span class="lineno">12251</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l12253"></a><span class="lineno">12253</span>&#160;<span class="comment"></span><span class="preprocessor">#if(EVOLVENRAD&amp;&amp;NRAD&gt;0)</span></div>
<div class="line"><a name="l12254"></a><span class="lineno">12254</span>&#160;<span class="preprocessor"></span>  <span class="keywordflow">if</span>(*lpflagrad==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6435e9609d622c9dbaf78c12658ecf8e">UTOPRIMRADNOFAIL</a>){</div>
<div class="line"><a name="l12255"></a><span class="lineno">12255</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammafinal,qsqfinal;</div>
<div class="line"><a name="l12256"></a><span class="lineno">12256</span>&#160;    <span class="keywordflow">if</span>(recomputegamma) <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#abfae38e47b0bd05a4fc38302ff948a96" title="find gamma-factor wrt normal observer This function and qsq_calc() have about the same cache miss amo...">gamma_calc_fromuconrel</a>(&amp;pin[URAD1-1],ptrgeom,&amp;gammafinal,&amp;qsqfinal);</div>
<div class="line"><a name="l12257"></a><span class="lineno">12257</span>&#160;    <span class="keywordflow">else</span> gammafinal=gamma;</div>
<div class="line"><a name="l12258"></a><span class="lineno">12258</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> uradt=gammafinal/(ptrgeom-&gt;alphalapse); <span class="comment">// u^t = gamma/alphalapse</span></div>
<div class="line"><a name="l12259"></a><span class="lineno">12259</span>&#160;    pin[NRAD] = uu[NRAD]/uradt; <span class="comment">// nradinradframe * urad[TT] / uradt</span></div>
<div class="line"><a name="l12260"></a><span class="lineno">12260</span>&#160;  }</div>
<div class="line"><a name="l12261"></a><span class="lineno">12261</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l12262"></a><span class="lineno">12262</span>&#160;    <span class="comment">// if failed to get solution, can&#39;t trust \gamma, so revert to thermal photons</span></div>
<div class="line"><a name="l12263"></a><span class="lineno">12263</span>&#160;    pin[NRAD] = <a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#a3e47afcfc5c42719999d851395fd032d" title="nrad(E)">calc_LTE_NfromE</a>(Erf);</div>
<div class="line"><a name="l12264"></a><span class="lineno">12264</span>&#160;  }</div>
<div class="line"><a name="l12265"></a><span class="lineno">12265</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l12266"></a><span class="lineno">12266</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l12267"></a><span class="lineno">12267</span>&#160;</div>
<div class="line"><a name="l12268"></a><span class="lineno">12268</span>&#160;</div>
<div class="line"><a name="l12269"></a><span class="lineno">12269</span>&#160;</div>
<div class="line"><a name="l12270"></a><span class="lineno">12270</span>&#160;  <span class="keywordflow">if</span>(debugfail&gt;=2){</div>
<div class="line"><a name="l12271"></a><span class="lineno">12271</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> nstepold=-1;</div>
<div class="line"><a name="l12272"></a><span class="lineno">12272</span>&#160;    <span class="keywordflow">if</span>(nstep!=nstepold &amp;&amp; nstep%100==0 &amp;&amp; ptrgeom-&gt;i==0 &amp;&amp; ptrgeom-&gt;j==0 &amp;&amp; ptrgeom-&gt;k==0 &amp;&amp; steppart==0){</div>
<div class="line"><a name="l12273"></a><span class="lineno">12273</span>&#160;      nstepold=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a1a1088d87617078680f1fd0f0d707384">nstep</a>;</div>
<div class="line"><a name="l12274"></a><span class="lineno">12274</span>&#160;      dualfprintf(fail_file,<span class="stringliteral">&quot;numyvarneg=%lld numyvarbig=%lld numErneg=%lld nummod=%lld : nstep=%ld\n&quot;</span>,numyvarneg,numyvarbig,numErneg,nummod,nstep);</div>
<div class="line"><a name="l12275"></a><span class="lineno">12275</span>&#160;    }</div>
<div class="line"><a name="l12276"></a><span class="lineno">12276</span>&#160;  }</div>
<div class="line"><a name="l12277"></a><span class="lineno">12277</span>&#160;</div>
<div class="line"><a name="l12278"></a><span class="lineno">12278</span>&#160;</div>
<div class="line"><a name="l12279"></a><span class="lineno">12279</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a69aeed93a5b7bf3c0669b44f07148e92" title="whether to fixup inversion failures using harm fixups can lead to issues because diffuses, so across sharp boundary radiation can be given quite &quot;wrong&quot; values that don&#39;t match what solution &quot;wants&quot;">DORADFIXUPS</a>==1 || allowlocalfailurefixandnoreport==0){</div>
<div class="line"><a name="l12280"></a><span class="lineno">12280</span>&#160;    <span class="comment">// KORALTODO: Problem is fixups can average across shock or place where (e.g.) velocity changes alot, and averaging diffuses shock and can leak-out more failures.</span></div>
<div class="line"><a name="l12281"></a><span class="lineno">12281</span>&#160;  }</div>
<div class="line"><a name="l12282"></a><span class="lineno">12282</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l12283"></a><span class="lineno">12283</span>&#160;    <span class="comment">// CASE reductions (so set as no failure so fixups don&#39;t operate -- but might also want to turn off CHECKINVERSIONRAD else that routine won&#39;t know when to ignore bad U-&gt;P-&gt;U cases.)</span></div>
<div class="line"><a name="l12284"></a><span class="lineno">12284</span>&#160;    <span class="keywordflow">if</span>(*lpflagrad==0) *lpflagrad=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6435e9609d622c9dbaf78c12658ecf8e">UTOPRIMRADNOFAIL</a>;</div>
<div class="line"><a name="l12285"></a><span class="lineno">12285</span>&#160;    <span class="keywordflow">else</span> *lpflagrad=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ac2e41dde6ad6ac3afe36f33ff2e1a720">UTOPRIMRADFAILFIXEDUTOPRIMRAD</a>; <span class="comment">//UTOPRIMRADNOFAIL;</span></div>
<div class="line"><a name="l12286"></a><span class="lineno">12286</span>&#160;  }</div>
<div class="line"><a name="l12287"></a><span class="lineno">12287</span>&#160;</div>
<div class="line"><a name="l12288"></a><span class="lineno">12288</span>&#160;  <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l12289"></a><span class="lineno">12289</span>&#160;</div>
<div class="line"><a name="l12290"></a><span class="lineno">12290</span>&#160;</div>
<div class="line"><a name="l12291"></a><span class="lineno">12291</span>&#160;</div>
<div class="line"><a name="l12292"></a><span class="lineno">12292</span>&#160;}</div>
<div class="line"><a name="l12293"></a><span class="lineno">12293</span>&#160;</div>
<div class="line"><a name="l12294"></a><span class="lineno">12294</span>&#160;</div>
<div class="line"><a name="l12300"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a67b370af2fa58283bc590ff4e895fb90">12300</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a67b370af2fa58283bc590ff4e895fb90" title="Like u2p_rad_orig(), but uses Jon&#39;s paper draft ZAMO RAD version.">u2p_rad_new</a>(<span class="keywordtype">int</span> showmessages, <span class="keywordtype">int</span> allowlocalfailurefixandnoreport, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammamaxrad, <span class="keywordtype">int</span> whichcap, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *uu, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pin, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflag, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflagrad)</div>
<div class="line"><a name="l12301"></a><span class="lineno">12301</span>&#160;{</div>
<div class="line"><a name="l12302"></a><span class="lineno">12302</span>&#160;  <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> numyvarneg,numyvarbig,numErneg,nummod;</div>
<div class="line"><a name="l12303"></a><span class="lineno">12303</span>&#160;  <span class="keywordtype">int</span> recomputegamma=0;</div>
<div class="line"><a name="l12304"></a><span class="lineno">12304</span>&#160;</div>
<div class="line"><a name="l12305"></a><span class="lineno">12305</span>&#160;<span class="preprocessor">#if(WHICHVEL!=VELREL4)</span></div>
<div class="line"><a name="l12306"></a><span class="lineno">12306</span>&#160;<span class="preprocessor"></span>  dualfprintf(fail_file,<span class="stringliteral">&quot;u2p_rad() only setup for relative 4-velocity, currently.\n&quot;</span>);</div>
<div class="line"><a name="l12307"></a><span class="lineno">12307</span>&#160;  myexit(137432636);</div>
<div class="line"><a name="l12308"></a><span class="lineno">12308</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l12309"></a><span class="lineno">12309</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l12310"></a><span class="lineno">12310</span>&#160;</div>
<div class="line"><a name="l12311"></a><span class="lineno">12311</span>&#160;  <span class="comment">// copy over pin so pin isn&#39;t modified until end</span></div>
<div class="line"><a name="l12312"></a><span class="lineno">12312</span>&#160;  <span class="keywordtype">int</span> pliter,pl;</div>
<div class="line"><a name="l12313"></a><span class="lineno">12313</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> pp[NPR];</div>
<div class="line"><a name="l12314"></a><span class="lineno">12314</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) pp[pl]=pin[pl];</div>
<div class="line"><a name="l12315"></a><span class="lineno">12315</span>&#160;</div>
<div class="line"><a name="l12317"></a><span class="lineno">12317</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l12318"></a><span class="lineno">12318</span>&#160;  <span class="comment">// Prepare inversion from U-&gt;p for radiation assuming M1 closure</span></div>
<div class="line"><a name="l12319"></a><span class="lineno">12319</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l12321"></a><span class="lineno">12321</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l12322"></a><span class="lineno">12322</span>&#160;  *lpflagrad=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6435e9609d622c9dbaf78c12658ecf8e">UTOPRIMRADNOFAIL</a>;</div>
<div class="line"><a name="l12323"></a><span class="lineno">12323</span>&#160;</div>
<div class="line"><a name="l12324"></a><span class="lineno">12324</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Er,Utildesq,Utildecon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l12325"></a><span class="lineno">12325</span>&#160;  <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a77c546a7fb064266fef5a9e796dc63dc" title="compute ZAMO version of radiation quantities as in paper draft">compute_ZAMORAD</a>(uu, ptrgeom, &amp;Er, &amp;Utildesq, Utildecon);</div>
<div class="line"><a name="l12326"></a><span class="lineno">12326</span>&#160;  </div>
<div class="line"><a name="l12327"></a><span class="lineno">12327</span>&#160;  <span class="comment">// \gamma_{\rm rad}^2 :  only 1 root</span></div>
<div class="line"><a name="l12328"></a><span class="lineno">12328</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammasq,gamma,qsq;</div>
<div class="line"><a name="l12329"></a><span class="lineno">12329</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammamax=gammamaxrad;</div>
<div class="line"><a name="l12330"></a><span class="lineno">12330</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammamaxsq=gammamax*gammamax;</div>
<div class="line"><a name="l12331"></a><span class="lineno">12331</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ylimit = 16.0*gammamaxsq*(gammamaxsq-1.0)/((4.0*gammamaxsq-1.0)*(4.0*gammamaxsq-1.0));</div>
<div class="line"><a name="l12332"></a><span class="lineno">12332</span>&#160;</div>
<div class="line"><a name="l12333"></a><span class="lineno">12333</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> yvar;</div>
<div class="line"><a name="l12334"></a><span class="lineno">12334</span>&#160;  <span class="keywordtype">int</span> didmod=0;</div>
<div class="line"><a name="l12335"></a><span class="lineno">12335</span>&#160;  <span class="keywordtype">int</span> didmodEr=0,didmody=0,gotbigy=0;</div>
<div class="line"><a name="l12336"></a><span class="lineno">12336</span>&#160;</div>
<div class="line"><a name="l12338"></a><span class="lineno">12338</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l12339"></a><span class="lineno">12339</span>&#160;  <span class="comment">// Get y</span></div>
<div class="line"><a name="l12340"></a><span class="lineno">12340</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l12342"></a><span class="lineno">12342</span>&#160;<span class="comment"></span>  <span class="keywordflow">if</span>(Er&gt;<a class="code" href="../../d8/d5b/defs_8general_8h.html#a5bd9da451f108352614cbc457524c5b0">ERADLIMIT</a>){ <span class="comment">// then good solution.  Avoid caps during implicit solver to allow progress on solution in smooth way.</span></div>
<div class="line"><a name="l12343"></a><span class="lineno">12343</span>&#160;    <span class="comment">// E_r^2</span></div>
<div class="line"><a name="l12344"></a><span class="lineno">12344</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Ersq=Er*Er;</div>
<div class="line"><a name="l12345"></a><span class="lineno">12345</span>&#160;    <span class="comment">// y</span></div>
<div class="line"><a name="l12346"></a><span class="lineno">12346</span>&#160;    yvar = Utildesq / (<a class="code" href="../../d8/d5b/defs_8general_8h.html#a5bd9da451f108352614cbc457524c5b0">ERADLIMIT</a>*<a class="code" href="../../d8/d5b/defs_8general_8h.html#a5bd9da451f108352614cbc457524c5b0">ERADLIMIT</a>+Ersq);</div>
<div class="line"><a name="l12347"></a><span class="lineno">12347</span>&#160;  }</div>
<div class="line"><a name="l12348"></a><span class="lineno">12348</span>&#160;  <span class="keywordflow">else</span>{<span class="comment">// then bad solution</span></div>
<div class="line"><a name="l12349"></a><span class="lineno">12349</span>&#160;    <span class="comment">//    dualfprintf(fail_file,&quot;Er=%26.20g&lt;ERADLIMIT=%26.20g yvar=%26.20g Utildesq=%26.20g Ersq=%26.20g\n&quot;,Er,ERADLIMIT,yvar,Utildesq,Ersq);</span></div>
<div class="line"><a name="l12350"></a><span class="lineno">12350</span>&#160;    Er=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a5bd9da451f108352614cbc457524c5b0">ERADLIMIT</a>;</div>
<div class="line"><a name="l12351"></a><span class="lineno">12351</span>&#160;    yvar = ylimit; <span class="comment">// used</span></div>
<div class="line"><a name="l12352"></a><span class="lineno">12352</span>&#160;    didmod=1;</div>
<div class="line"><a name="l12353"></a><span class="lineno">12353</span>&#160;    didmodEr=1;</div>
<div class="line"><a name="l12354"></a><span class="lineno">12354</span>&#160;    numErneg++;</div>
<div class="line"><a name="l12355"></a><span class="lineno">12355</span>&#160;  }</div>
<div class="line"><a name="l12356"></a><span class="lineno">12356</span>&#160;</div>
<div class="line"><a name="l12357"></a><span class="lineno">12357</span>&#160;</div>
<div class="line"><a name="l12359"></a><span class="lineno">12359</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l12360"></a><span class="lineno">12360</span>&#160;  <span class="comment">// Get \gamma and \gamma^2 from y</span></div>
<div class="line"><a name="l12361"></a><span class="lineno">12361</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l12363"></a><span class="lineno">12363</span>&#160;<span class="comment"></span>  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Erf,<a class="code" href="../../dc/dd2/newcodediff_8txt.html#ae7ab77d7e616dc02fba121a009b48c27">pr</a>;</div>
<div class="line"><a name="l12364"></a><span class="lineno">12364</span>&#160;  <span class="keywordflow">if</span>(yvar&lt;0.0){</div>
<div class="line"><a name="l12365"></a><span class="lineno">12365</span>&#160;    <span class="comment">//    dualfprintf(fail_file,&quot;Er=%26.20g yvar=%26.20g&lt;0.0 Utildesq=%26.20g Ersq=%26.20g\n&quot;,Er,yvar,Utildesq,Ersq);</span></div>
<div class="line"><a name="l12366"></a><span class="lineno">12366</span>&#160;    gammasq = 1.0;</div>
<div class="line"><a name="l12367"></a><span class="lineno">12367</span>&#160;    gamma = 1.0;</div>
<div class="line"><a name="l12368"></a><span class="lineno">12368</span>&#160;    <span class="keywordflow">if</span>(didmodEr) didmod=didmody=1;</div>
<div class="line"><a name="l12369"></a><span class="lineno">12369</span>&#160;    <span class="comment">//    didmod=1; // assume when y&lt;0 that don&#39;t need to modify how Erf computed (i.e. Er is ok)</span></div>
<div class="line"><a name="l12370"></a><span class="lineno">12370</span>&#160;    numyvarneg++;</div>
<div class="line"><a name="l12371"></a><span class="lineno">12371</span>&#160;    pr = Er/(4.0*gammasq-1.0);</div>
<div class="line"><a name="l12372"></a><span class="lineno">12372</span>&#160;    <span class="comment">// radiation frame energy density</span></div>
<div class="line"><a name="l12373"></a><span class="lineno">12373</span>&#160;    Erf = pr/(4.0/3.0-1.0);</div>
<div class="line"><a name="l12374"></a><span class="lineno">12374</span>&#160;  }</div>
<div class="line"><a name="l12375"></a><span class="lineno">12375</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(yvar&gt;ylimit){ <span class="comment">// beyond gamma limit, then rescale gamma</span></div>
<div class="line"><a name="l12376"></a><span class="lineno">12376</span>&#160;    gammasq = gammamaxsq;</div>
<div class="line"><a name="l12377"></a><span class="lineno">12377</span>&#160;    gamma = gammamax;</div>
<div class="line"><a name="l12378"></a><span class="lineno">12378</span>&#160;    didmod=1;</div>
<div class="line"><a name="l12379"></a><span class="lineno">12379</span>&#160;    didmody=1;</div>
<div class="line"><a name="l12380"></a><span class="lineno">12380</span>&#160;    gotbigy=1;</div>
<div class="line"><a name="l12381"></a><span class="lineno">12381</span>&#160;    numyvarbig++;</div>
<div class="line"><a name="l12382"></a><span class="lineno">12382</span>&#160;</div>
<div class="line"><a name="l12383"></a><span class="lineno">12383</span>&#160;    pr = Er/(4.0*gammasq-1.0);</div>
<div class="line"><a name="l12384"></a><span class="lineno">12384</span>&#160;    <span class="comment">// radiation frame energy density</span></div>
<div class="line"><a name="l12385"></a><span class="lineno">12385</span>&#160;    Erf = pr/(4.0/3.0-1.0);</div>
<div class="line"><a name="l12386"></a><span class="lineno">12386</span>&#160;    <span class="comment">//    dualfprintf(fail_file,&quot;yvar=%g&gt;%g Ersq=%g gamma=%g\n&quot;,yvar,ylimit,Ersq,gamma);</span></div>
<div class="line"><a name="l12387"></a><span class="lineno">12387</span>&#160;  }</div>
<div class="line"><a name="l12388"></a><span class="lineno">12388</span>&#160;  <span class="keywordflow">else</span>{ <span class="comment">// normal solution</span></div>
<div class="line"><a name="l12389"></a><span class="lineno">12389</span>&#160;    gammasq = (2.0 - yvar + sqrt(4.0-3.0*yvar))/ (4.0*(1.0-yvar));</div>
<div class="line"><a name="l12390"></a><span class="lineno">12390</span>&#160;    gamma=sqrt(gammasq);</div>
<div class="line"><a name="l12391"></a><span class="lineno">12391</span>&#160;</div>
<div class="line"><a name="l12392"></a><span class="lineno">12392</span>&#160;    pr = Er/(4.0*gammasq-1.0);</div>
<div class="line"><a name="l12393"></a><span class="lineno">12393</span>&#160;    <span class="comment">// radiation frame energy density</span></div>
<div class="line"><a name="l12394"></a><span class="lineno">12394</span>&#160;    Erf = pr/(4.0/3.0-1.0);</div>
<div class="line"><a name="l12395"></a><span class="lineno">12395</span>&#160;  }</div>
<div class="line"><a name="l12396"></a><span class="lineno">12396</span>&#160;</div>
<div class="line"><a name="l12397"></a><span class="lineno">12397</span>&#160;</div>
<div class="line"><a name="l12398"></a><span class="lineno">12398</span>&#160;</div>
<div class="line"><a name="l12400"></a><span class="lineno">12400</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l12401"></a><span class="lineno">12401</span>&#160;  <span class="comment">// Get uconrel and Erf from gamma,gammasq, and Utildecon</span></div>
<div class="line"><a name="l12402"></a><span class="lineno">12402</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l12404"></a><span class="lineno">12404</span>&#160;<span class="comment"></span>  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> urfconrel[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>]={0.0};</div>
<div class="line"><a name="l12405"></a><span class="lineno">12405</span>&#160;  <span class="keywordtype">int</span> jj;</div>
<div class="line"><a name="l12406"></a><span class="lineno">12406</span>&#160;  <span class="comment">//  if(1||gammamaxrad&gt;0.9*GAMMAMAXRADIMPLICITSOLVER || Er&gt;=ERADLIMIT){ // then good solution.  Avoid caps during implicit solver to allow progress on solution in smooth way.</span></div>
<div class="line"><a name="l12407"></a><span class="lineno">12407</span>&#160;  <span class="keywordflow">if</span>(didmody==0 &amp;&amp; didmodEr==0){ <span class="comment">// then good solution</span></div>
<div class="line"><a name="l12408"></a><span class="lineno">12408</span>&#160;   </div>
<div class="line"><a name="l12409"></a><span class="lineno">12409</span>&#160;    <span class="comment">// radiation frame relativity 4-velocity</span></div>
<div class="line"><a name="l12410"></a><span class="lineno">12410</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) urfconrel[jj] = gamma*(Utildecon[jj]/(4.0*pr*gammasq));</div>
<div class="line"><a name="l12411"></a><span class="lineno">12411</span>&#160;</div>
<div class="line"><a name="l12412"></a><span class="lineno">12412</span>&#160;    <span class="comment">//if(startpos[1]+ptrgeom-&gt;i==131 &amp;&amp; startpos[2]+ptrgeom-&gt;j==19) dualfprintf(fail_file,&quot;0didmod=%d : urfconrel=%g %g %g : %g : pr=%g Er=%g Ersq=%g yvar=%g Utildesq=%g\n&quot;,didmod,urfconrel[1],urfconrel[2],urfconrel[3],gamma,pr,Er,Er*Er,yvar,Utildesq);</span></div>
<div class="line"><a name="l12413"></a><span class="lineno">12413</span>&#160;  }</div>
<div class="line"><a name="l12414"></a><span class="lineno">12414</span>&#160;  <span class="keywordflow">else</span>{ <span class="comment">// fixes in case when Er&lt;ERADLIMIT (whether or not y is modified)</span></div>
<div class="line"><a name="l12415"></a><span class="lineno">12415</span>&#160;    <span class="keywordflow">if</span>(whichcap==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0c47e9dd13520b0ea1389acd3dc22f1f">CAPTYPEFIX1</a> || whichcap==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#af4a8ea9a61541490ee05c096ae984f20">CAPTYPEFIX2</a>){</div>
<div class="line"><a name="l12416"></a><span class="lineno">12416</span>&#160;</div>
<div class="line"><a name="l12417"></a><span class="lineno">12417</span>&#160;      <span class="comment">// override if Er&lt;0 originally since otherwise out of control rise in Erf</span></div>
<div class="line"><a name="l12418"></a><span class="lineno">12418</span>&#160;      <span class="comment">//      if(didmodEr || yvar&lt;-NUMEPSILON || yvar&gt;=2.0){</span></div>
<div class="line"><a name="l12419"></a><span class="lineno">12419</span>&#160;      <span class="keywordflow">if</span>(didmodEr &amp;&amp; whichcap==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0c47e9dd13520b0ea1389acd3dc22f1f">CAPTYPEFIX1</a>){</div>
<div class="line"><a name="l12420"></a><span class="lineno">12420</span>&#160;        Er = <a class="code" href="../../d8/d5b/defs_8general_8h.html#a5bd9da451f108352614cbc457524c5b0">ERADLIMIT</a>;</div>
<div class="line"><a name="l12421"></a><span class="lineno">12421</span>&#160;        Erf = <a class="code" href="../../d8/d5b/defs_8general_8h.html#a5bd9da451f108352614cbc457524c5b0">ERADLIMIT</a>;</div>
<div class="line"><a name="l12422"></a><span class="lineno">12422</span>&#160;        gamma=1.0;</div>
<div class="line"><a name="l12423"></a><span class="lineno">12423</span>&#160;        <span class="comment">// radiation frame relativity 4-velocity</span></div>
<div class="line"><a name="l12424"></a><span class="lineno">12424</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) urfconrel[jj] = 0.0;</div>
<div class="line"><a name="l12425"></a><span class="lineno">12425</span>&#160;        <span class="comment">// If E_r&lt;0, then can&#39;t trust E_r and Erf is arbitrary.  Choose instead first urfconrel to be maximum gamma as pointed in same 4-velocity direction as from Utildecon over previous Erf or u_g just to set scale</span></div>
<div class="line"><a name="l12426"></a><span class="lineno">12426</span>&#160;        <span class="comment">// But better to not trust to avoid run-away energy creation</span></div>
<div class="line"><a name="l12427"></a><span class="lineno">12427</span>&#160;      }</div>
<div class="line"><a name="l12428"></a><span class="lineno">12428</span>&#160;      <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l12429"></a><span class="lineno">12429</span>&#160;        <span class="comment">//        if(yvar&lt;1.0&amp;&amp;0||1){</span></div>
<div class="line"><a name="l12430"></a><span class="lineno">12430</span>&#160;        <span class="keywordflow">if</span>(yvar&lt;1.0&amp;&amp;0){</div>
<div class="line"><a name="l12431"></a><span class="lineno">12431</span>&#160;          <span class="comment">// below sticks to what would end up like normal velocity scale.</span></div>
<div class="line"><a name="l12432"></a><span class="lineno">12432</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) urfconrel[jj] = gamma*(Utildecon[jj]/(4.0*pr*gammasq));</div>
<div class="line"><a name="l12433"></a><span class="lineno">12433</span>&#160;          <span class="keywordflow">if</span>(yvar&gt;=1.0) <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) urfconrel[jj]*=gamma; <span class="comment">// fake to pretend very high gamma that we are coming from.          </span></div>
<div class="line"><a name="l12434"></a><span class="lineno">12434</span>&#160;        }</div>
<div class="line"><a name="l12435"></a><span class="lineno">12435</span>&#160;        <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l12436"></a><span class="lineno">12436</span>&#160;          <span class="comment">// if yvar&gt;=1.0, then can&#39;t trust that gamma will rescale urfconrel into proper gamma&gt;&gt;1 range, so force.</span></div>
<div class="line"><a name="l12437"></a><span class="lineno">12437</span>&#160;          <span class="comment">// Get urfconrel in same direction as Utildecon</span></div>
<div class="line"><a name="l12438"></a><span class="lineno">12438</span>&#160;          <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Utildeabs=0.5*(sqrt(fabs(Utildesq))+fabs(Er)+<a class="code" href="../../d8/d5b/defs_8general_8h.html#a5bd9da451f108352614cbc457524c5b0">ERADLIMIT</a>);</div>
<div class="line"><a name="l12439"></a><span class="lineno">12439</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) urfconrel[jj] = gamma*Utildecon[jj]/Utildeabs; <span class="comment">// gives something that gives back ~gamma when using gamma_calc_fromuconrel()</span></div>
<div class="line"><a name="l12440"></a><span class="lineno">12440</span>&#160;        }</div>
<div class="line"><a name="l12441"></a><span class="lineno">12441</span>&#160;</div>
<div class="line"><a name="l12442"></a><span class="lineno">12442</span>&#160;        <span class="comment">// now get gamma for this fake urfconrel that is so-far only very roughly expected to be correct.</span></div>
<div class="line"><a name="l12443"></a><span class="lineno">12443</span>&#160;        <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammanew,qsqnew;</div>
<div class="line"><a name="l12444"></a><span class="lineno">12444</span>&#160;        <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#abfae38e47b0bd05a4fc38302ff948a96" title="find gamma-factor wrt normal observer This function and qsq_calc() have about the same cache miss amo...">gamma_calc_fromuconrel</a>(urfconrel,ptrgeom,&amp;gammanew,&amp;qsqnew);</div>
<div class="line"><a name="l12445"></a><span class="lineno">12445</span>&#160;        <span class="comment">//        if(gammanew&lt;gammamax || gammanew&lt;10.0){</span></div>
<div class="line"><a name="l12446"></a><span class="lineno">12446</span>&#160;        <span class="comment">//        if(gammanew&lt;10.0 || gammanew&gt;1000.0){</span></div>
<div class="line"><a name="l12447"></a><span class="lineno">12447</span>&#160;        <span class="comment">//          dualfprintf(fail_file,&quot;gamma=%g gammanew=%g %g %g %g\n&quot;,gamma,gammanew,Utildecon[1],Utildecon[2],Utildecon[3]);</span></div>
<div class="line"><a name="l12448"></a><span class="lineno">12448</span>&#160;        <span class="comment">//        }</span></div>
<div class="line"><a name="l12449"></a><span class="lineno">12449</span>&#160;</div>
<div class="line"><a name="l12450"></a><span class="lineno">12450</span>&#160;        <span class="comment">// rescale, assuming want to be gammamax</span></div>
<div class="line"><a name="l12451"></a><span class="lineno">12451</span>&#160;        <span class="keywordflow">if</span>(gammanew&gt;1.0){</div>
<div class="line"><a name="l12452"></a><span class="lineno">12452</span>&#160;          <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fvar=sqrt((gammamax*gammamax-1.0)/(gammanew*gammanew-1.0));</div>
<div class="line"><a name="l12453"></a><span class="lineno">12453</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) urfconrel[jj] *= fvar;</div>
<div class="line"><a name="l12454"></a><span class="lineno">12454</span>&#160;          <span class="comment">// verify</span></div>
<div class="line"><a name="l12455"></a><span class="lineno">12455</span>&#160;          <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammaneworig=gammanew;</div>
<div class="line"><a name="l12456"></a><span class="lineno">12456</span>&#160;          <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#abfae38e47b0bd05a4fc38302ff948a96" title="find gamma-factor wrt normal observer This function and qsq_calc() have about the same cache miss amo...">gamma_calc_fromuconrel</a>(urfconrel,ptrgeom,&amp;gammanew,&amp;qsqnew);</div>
<div class="line"><a name="l12457"></a><span class="lineno">12457</span>&#160;          <span class="comment">//          dualfprintf(fail_file,&quot;VERIFY: gamma=%g gammanew=%g-&gt;%g fvar=%g\n&quot;,gamma,gammaneworig,gammanew,fvar);</span></div>
<div class="line"><a name="l12458"></a><span class="lineno">12458</span>&#160;          gamma=gammanew;</div>
<div class="line"><a name="l12459"></a><span class="lineno">12459</span>&#160;          gammasq=gammanew*gammanew;</div>
<div class="line"><a name="l12460"></a><span class="lineno">12460</span>&#160;          qsq=qsqnew;</div>
<div class="line"><a name="l12461"></a><span class="lineno">12461</span>&#160;        }</div>
<div class="line"><a name="l12462"></a><span class="lineno">12462</span>&#160;        <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l12463"></a><span class="lineno">12463</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) urfconrel[jj] *= 0.0;</div>
<div class="line"><a name="l12464"></a><span class="lineno">12464</span>&#160;          gamma=1.0;</div>
<div class="line"><a name="l12465"></a><span class="lineno">12465</span>&#160;          gammasq=1.0;</div>
<div class="line"><a name="l12466"></a><span class="lineno">12466</span>&#160;          qsq=0.0;</div>
<div class="line"><a name="l12467"></a><span class="lineno">12467</span>&#160;        }</div>
<div class="line"><a name="l12468"></a><span class="lineno">12468</span>&#160;</div>
<div class="line"><a name="l12469"></a><span class="lineno">12469</span>&#160;</div>
<div class="line"><a name="l12470"></a><span class="lineno">12470</span>&#160;        <span class="comment">// Get Er independent of R^t_t when hit limits when wanting Jacobian, so Jacobian doesn&#39;t NAN-out when taking differences and drop-outs in Erf lead to err function dominated by uu0 (and less often, G) and unaffected by the uu we are changing.</span></div>
<div class="line"><a name="l12471"></a><span class="lineno">12471</span>&#160;        <span class="keywordflow">if</span>(whichcap==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#af4a8ea9a61541490ee05c096ae984f20">CAPTYPEFIX2</a> || yvar&gt;=1.0-100.0*<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a8913cb5d64cfec23ae1a3052930ec468">NUMEPSILON</a>){ <span class="comment">// don&#39;t use, just trust Er&gt;0.  Kinda works to set to if(1), but leads to some artifacts near where suddenly R^t_t would give different result for Er.</span></div>
<div class="line"><a name="l12472"></a><span class="lineno">12472</span>&#160;          <span class="comment">//FTYPE utildesq=1.0+qsq;</span></div>
<div class="line"><a name="l12473"></a><span class="lineno">12473</span>&#160;          <span class="comment">//pr=gamma*Utildesq/(4.0*gammasq) / (utildesq);</span></div>
<div class="line"><a name="l12474"></a><span class="lineno">12474</span>&#160;          </div>
<div class="line"><a name="l12475"></a><span class="lineno">12475</span>&#160;          <span class="comment">// This determination of Er and pr connects continuously with y&lt;=ylimit case no matter what original Er was.</span></div>
<div class="line"><a name="l12476"></a><span class="lineno">12476</span>&#160;          Er = <a class="code" href="../../d8/d5b/defs_8general_8h.html#a5bd9da451f108352614cbc457524c5b0">ERADLIMIT</a> + sqrt(fabs(Utildesq)/ylimit);</div>
<div class="line"><a name="l12477"></a><span class="lineno">12477</span>&#160;          pr=Er/(4.0*gammasq-1.0);</div>
<div class="line"><a name="l12478"></a><span class="lineno">12478</span>&#160;          <span class="comment">// Get Erf</span></div>
<div class="line"><a name="l12479"></a><span class="lineno">12479</span>&#160;          <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Erforig=Erf;</div>
<div class="line"><a name="l12480"></a><span class="lineno">12480</span>&#160;          Erf = pr/(4.0/3.0-1.0);</div>
<div class="line"><a name="l12481"></a><span class="lineno">12481</span>&#160;</div>
<div class="line"><a name="l12482"></a><span class="lineno">12482</span>&#160;          <span class="comment">// only modify Erf if really used as solution, not just Jacobian</span></div>
<div class="line"><a name="l12483"></a><span class="lineno">12483</span>&#160;          <span class="keywordflow">if</span>(Erforig&lt;Erf &amp;&amp; whichcap==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0c47e9dd13520b0ea1389acd3dc22f1f">CAPTYPEFIX1</a>) Erf=Erforig;</div>
<div class="line"><a name="l12484"></a><span class="lineno">12484</span>&#160;        }</div>
<div class="line"><a name="l12485"></a><span class="lineno">12485</span>&#160;      }</div>
<div class="line"><a name="l12486"></a><span class="lineno">12486</span>&#160;</div>
<div class="line"><a name="l12487"></a><span class="lineno">12487</span>&#160;    }<span class="comment">// endif capfixtype1</span></div>
<div class="line"><a name="l12488"></a><span class="lineno">12488</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(whichcap==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a4b6c6060c025e15f1d92aae3dcb9365b" title="which cap type to place in rad inversion">CAPTYPEBASIC</a>){</div>
<div class="line"><a name="l12489"></a><span class="lineno">12489</span>&#160;</div>
<div class="line"><a name="l12490"></a><span class="lineno">12490</span>&#160;</div>
<div class="line"><a name="l12491"></a><span class="lineno">12491</span>&#160;      <span class="keywordflow">if</span>(didmodEr){</div>
<div class="line"><a name="l12492"></a><span class="lineno">12492</span>&#160;        <span class="comment">// This just rejects entire radiative solution and makes it up.  Bit extreme, but works.  But leaves Erf having lowest values in spots where radiation just slightly went beyond speed of light.</span></div>
<div class="line"><a name="l12493"></a><span class="lineno">12493</span>&#160;        <span class="comment">// However, this is most reasonable since if E_r&lt;0, that means radiative energy is in another cell.  If fill this cell with gammamax version of Erf using Utildesq, then adding energy, and situation can blow-up fast.</span></div>
<div class="line"><a name="l12494"></a><span class="lineno">12494</span>&#160;        Erf = <a class="code" href="../../d8/d5b/defs_8general_8h.html#a5bd9da451f108352614cbc457524c5b0">ERADLIMIT</a>;</div>
<div class="line"><a name="l12495"></a><span class="lineno">12495</span>&#160;        gamma=1.0;</div>
<div class="line"><a name="l12496"></a><span class="lineno">12496</span>&#160;        <span class="comment">// radiation frame relativity 4-velocity</span></div>
<div class="line"><a name="l12497"></a><span class="lineno">12497</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) urfconrel[jj] = 0.0;</div>
<div class="line"><a name="l12498"></a><span class="lineno">12498</span>&#160;      }</div>
<div class="line"><a name="l12499"></a><span class="lineno">12499</span>&#160;      <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l12500"></a><span class="lineno">12500</span>&#160;        <span class="comment">// radiation frame relativity 4-velocity (using pr&gt;0 and chosen gamma,gammasq)</span></div>
<div class="line"><a name="l12501"></a><span class="lineno">12501</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) urfconrel[jj] = gamma*(Utildecon[jj]/(4.0*pr*gammasq));</div>
<div class="line"><a name="l12502"></a><span class="lineno">12502</span>&#160;</div>
<div class="line"><a name="l12503"></a><span class="lineno">12503</span>&#160;        <span class="comment">// Get resulting gamma and fix \tilde{u}^i, but don&#39;t modify Erf.</span></div>
<div class="line"><a name="l12504"></a><span class="lineno">12504</span>&#160;        <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammanew,qsqnew;</div>
<div class="line"><a name="l12505"></a><span class="lineno">12505</span>&#160;        <span class="comment">//        gamma_calc_fromuconrel(&amp;pin[URAD1-1],ptrgeom,&amp;gammanew,&amp;qsqnew);</span></div>
<div class="line"><a name="l12506"></a><span class="lineno">12506</span>&#160;        <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#abfae38e47b0bd05a4fc38302ff948a96" title="find gamma-factor wrt normal observer This function and qsq_calc() have about the same cache miss amo...">gamma_calc_fromuconrel</a>(urfconrel,ptrgeom,&amp;gammanew,&amp;qsqnew);</div>
<div class="line"><a name="l12507"></a><span class="lineno">12507</span>&#160;        <span class="comment">//    dualfprintf(fail_file,&quot;didmod: gamma=%g gammanew=%g\n&quot;,gamma,gammanew);</span></div>
<div class="line"><a name="l12508"></a><span class="lineno">12508</span>&#160;        </div>
<div class="line"><a name="l12509"></a><span class="lineno">12509</span>&#160;        <span class="comment">// rescale, assuming want to be gamma that chose in previous section</span></div>
<div class="line"><a name="l12510"></a><span class="lineno">12510</span>&#160;        <span class="keywordflow">if</span>(gammanew&gt;1.0){</div>
<div class="line"><a name="l12511"></a><span class="lineno">12511</span>&#160;          <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fvar=sqrt((gammasq-1.0)/(gammanew*gammanew-1.0));</div>
<div class="line"><a name="l12512"></a><span class="lineno">12512</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) urfconrel[jj] *= fvar;</div>
<div class="line"><a name="l12513"></a><span class="lineno">12513</span>&#160;        }</div>
<div class="line"><a name="l12514"></a><span class="lineno">12514</span>&#160;        <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l12515"></a><span class="lineno">12515</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) urfconrel[jj] *= 0.0;</div>
<div class="line"><a name="l12516"></a><span class="lineno">12516</span>&#160;        }</div>
<div class="line"><a name="l12517"></a><span class="lineno">12517</span>&#160;</div>
<div class="line"><a name="l12518"></a><span class="lineno">12518</span>&#160;        <span class="comment">// don&#39;t modify Erf if E_r was positive so that only had to rescale y (even if rescaled down from y&gt;1 or gamma^2&lt;0)</span></div>
<div class="line"><a name="l12519"></a><span class="lineno">12519</span>&#160;        <span class="comment">//        pr = Er/(4.0*gammanew*gammanew-1.0);</span></div>
<div class="line"><a name="l12520"></a><span class="lineno">12520</span>&#160;        <span class="comment">//        // radiation frame energy density</span></div>
<div class="line"><a name="l12521"></a><span class="lineno">12521</span>&#160;        <span class="comment">//        Erf = pr/(4.0/3.0-1.0);</span></div>
<div class="line"><a name="l12522"></a><span class="lineno">12522</span>&#160;</div>
<div class="line"><a name="l12523"></a><span class="lineno">12523</span>&#160;</div>
<div class="line"><a name="l12524"></a><span class="lineno">12524</span>&#160;        <span class="comment">//    if(startpos[1]+ptrgeom-&gt;i==131 &amp;&amp; startpos[2]+ptrgeom-&gt;j==19) dualfprintf(fail_file,&quot;didmod=%d : urfconrel=%g %g %g : %g %g\n&quot;,didmod,urfconrel[1],urfconrel[2],urfconrel[3],gamma,gammanew);</span></div>
<div class="line"><a name="l12525"></a><span class="lineno">12525</span>&#160;      }</div>
<div class="line"><a name="l12526"></a><span class="lineno">12526</span>&#160;    }</div>
<div class="line"><a name="l12527"></a><span class="lineno">12527</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l12528"></a><span class="lineno">12528</span>&#160;<span class="preprocessor">#if(PRODUCTION==0)</span></div>
<div class="line"><a name="l12529"></a><span class="lineno">12529</span>&#160;<span class="preprocessor"></span>      dualfprintf(fail_file,<span class="stringliteral">&quot;No such whichcap=%d\n&quot;</span>,whichcap);</div>
<div class="line"><a name="l12530"></a><span class="lineno">12530</span>&#160;      myexit(234534634);</div>
<div class="line"><a name="l12531"></a><span class="lineno">12531</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l12532"></a><span class="lineno">12532</span>&#160;<span class="preprocessor"></span>    }</div>
<div class="line"><a name="l12533"></a><span class="lineno">12533</span>&#160;  }</div>
<div class="line"><a name="l12534"></a><span class="lineno">12534</span>&#160;</div>
<div class="line"><a name="l12535"></a><span class="lineno">12535</span>&#160;  <span class="comment">//  if(startpos[1]+ptrgeom-&gt;i==131 &amp;&amp; startpos[2]+ptrgeom-&gt;j==19){</span></div>
<div class="line"><a name="l12536"></a><span class="lineno">12536</span>&#160;  <span class="comment">//    dualfprintf(fail_file,&quot;AFTER urfconrel=%g %g %g : %g\n&quot;,urfconrel[1],urfconrel[2],urfconrel[3],gamma);</span></div>
<div class="line"><a name="l12537"></a><span class="lineno">12537</span>&#160;  <span class="comment">//  dualfprintf(fail_file,&quot;AFTER2 urfconrel2=%g %g %g : %g\n&quot;,urfconrel[1]*sqrt(fabs(ptrgeom-&gt;gcov[GIND(1,1)])),urfconrel[2]*sqrt(fabs(ptrgeom-&gt;gcov[GIND(2,2)])),urfconrel[3]*sqrt(fabs(ptrgeom-&gt;gcov[GIND(3,3)])),gamma);</span></div>
<div class="line"><a name="l12538"></a><span class="lineno">12538</span>&#160;  <span class="comment">// }</span></div>
<div class="line"><a name="l12539"></a><span class="lineno">12539</span>&#160;</div>
<div class="line"><a name="l12540"></a><span class="lineno">12540</span>&#160;</div>
<div class="line"><a name="l12542"></a><span class="lineno">12542</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l12543"></a><span class="lineno">12543</span>&#160;  <span class="comment">//new primitives (only uses urfcon[1-3])</span></div>
<div class="line"><a name="l12544"></a><span class="lineno">12544</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l12546"></a><span class="lineno">12546</span>&#160;<span class="comment"></span>  pin[PRAD0]=Erf;</div>
<div class="line"><a name="l12547"></a><span class="lineno">12547</span>&#160;  pin[PRAD1]=urfconrel[1];</div>
<div class="line"><a name="l12548"></a><span class="lineno">12548</span>&#160;  pin[PRAD2]=urfconrel[2];</div>
<div class="line"><a name="l12549"></a><span class="lineno">12549</span>&#160;  pin[PRAD3]=urfconrel[3];</div>
<div class="line"><a name="l12550"></a><span class="lineno">12550</span>&#160;</div>
<div class="line"><a name="l12551"></a><span class="lineno">12551</span>&#160;</div>
<div class="line"><a name="l12552"></a><span class="lineno">12552</span>&#160;</div>
<div class="line"><a name="l12554"></a><span class="lineno">12554</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l12555"></a><span class="lineno">12555</span>&#160;  <span class="comment">// INVERT to get Number density of photons in radiation frame</span></div>
<div class="line"><a name="l12556"></a><span class="lineno">12556</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l12558"></a><span class="lineno">12558</span>&#160;<span class="comment"></span><span class="preprocessor">#if(EVOLVENRAD&amp;&amp;NRAD&gt;0)</span></div>
<div class="line"><a name="l12559"></a><span class="lineno">12559</span>&#160;<span class="preprocessor"></span>  <span class="keywordflow">if</span>(*lpflagrad==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6435e9609d622c9dbaf78c12658ecf8e">UTOPRIMRADNOFAIL</a>){</div>
<div class="line"><a name="l12560"></a><span class="lineno">12560</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammafinal,qsqfinal;</div>
<div class="line"><a name="l12561"></a><span class="lineno">12561</span>&#160;    <span class="keywordflow">if</span>(recomputegamma) <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#abfae38e47b0bd05a4fc38302ff948a96" title="find gamma-factor wrt normal observer This function and qsq_calc() have about the same cache miss amo...">gamma_calc_fromuconrel</a>(&amp;pin[URAD1-1],ptrgeom,&amp;gammafinal,&amp;qsqfinal);</div>
<div class="line"><a name="l12562"></a><span class="lineno">12562</span>&#160;    <span class="keywordflow">else</span> gammafinal=gamma;</div>
<div class="line"><a name="l12563"></a><span class="lineno">12563</span>&#160;    recomputegamma=0; <span class="comment">// already recomputed, so can avoid another recomputation</span></div>
<div class="line"><a name="l12564"></a><span class="lineno">12564</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> uradt=gammafinal/(ptrgeom-&gt;alphalapse); <span class="comment">// u^t = gamma/alphalapse</span></div>
<div class="line"><a name="l12565"></a><span class="lineno">12565</span>&#160;    pin[NRAD] = uu[NRAD]/uradt; <span class="comment">// nradinradframe * urad[TT] / uradt</span></div>
<div class="line"><a name="l12566"></a><span class="lineno">12566</span>&#160;  }</div>
<div class="line"><a name="l12567"></a><span class="lineno">12567</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l12568"></a><span class="lineno">12568</span>&#160;    <span class="comment">// if failed to get solution, can&#39;t trust \gamma, so revert to thermal photons</span></div>
<div class="line"><a name="l12569"></a><span class="lineno">12569</span>&#160;    pin[NRAD] = <a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#a3e47afcfc5c42719999d851395fd032d" title="nrad(E)">calc_LTE_NfromE</a>(Erf);</div>
<div class="line"><a name="l12570"></a><span class="lineno">12570</span>&#160;  }</div>
<div class="line"><a name="l12571"></a><span class="lineno">12571</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l12572"></a><span class="lineno">12572</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l12573"></a><span class="lineno">12573</span>&#160;</div>
<div class="line"><a name="l12574"></a><span class="lineno">12574</span>&#160;</div>
<div class="line"><a name="l12576"></a><span class="lineno">12576</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l12577"></a><span class="lineno">12577</span>&#160;  <span class="comment">// INVERT floor advectors</span></div>
<div class="line"><a name="l12578"></a><span class="lineno">12578</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l12580"></a><span class="lineno">12580</span>&#160;<span class="comment"></span><span class="preprocessor">#if(DOYFL==2 &amp;&amp; (YFL4&gt;=0 || YFL5&gt;=0))</span></div>
<div class="line"><a name="l12581"></a><span class="lineno">12581</span>&#160;<span class="preprocessor"></span>  <span class="comment">// if failed to get solution, can&#39;t trust \gamma, so evolution of floor wil be itself bad, but assume CASE reductions reasonable</span></div>
<div class="line"><a name="l12582"></a><span class="lineno">12582</span>&#160;  <span class="comment">// But, for scalars, this primitive is ultimately multiplied by uradt itself, so whatever uradt is, the conserved quantity is evolved/fluxed correctly/conservatively</span></div>
<div class="line"><a name="l12583"></a><span class="lineno">12583</span>&#160;  <span class="keywordflow">if</span>(1){</div>
<div class="line"><a name="l12584"></a><span class="lineno">12584</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammafinal,qsqfinal;</div>
<div class="line"><a name="l12585"></a><span class="lineno">12585</span>&#160;    <span class="keywordflow">if</span>(recomputegamma) <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#abfae38e47b0bd05a4fc38302ff948a96" title="find gamma-factor wrt normal observer This function and qsq_calc() have about the same cache miss amo...">gamma_calc_fromuconrel</a>(&amp;pin[URAD1-1],ptrgeom,&amp;gammafinal,&amp;qsqfinal);</div>
<div class="line"><a name="l12586"></a><span class="lineno">12586</span>&#160;    <span class="keywordflow">else</span> gammafinal=gamma;</div>
<div class="line"><a name="l12587"></a><span class="lineno">12587</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> uradt=gammafinal/(ptrgeom-&gt;alphalapse); <span class="comment">// u^t = gamma/alphalapse</span></div>
<div class="line"><a name="l12588"></a><span class="lineno">12588</span>&#160;    <span class="keywordflow">if</span>(YFL4&gt;=0){</div>
<div class="line"><a name="l12589"></a><span class="lineno">12589</span>&#160;      pin[YFL4] = -uu[YFL4]/uradt; <span class="comment">// -uu[YFLx]/u^t  // NOTEMARK: Same sign as in other places like utoprimgen.c and fixup.c</span></div>
<div class="line"><a name="l12590"></a><span class="lineno">12590</span>&#160;      <span class="keywordflow">if</span>(pin[YFL4]&lt;<a class="code" href="../../d8/d5b/defs_8general_8h.html#a5bd9da451f108352614cbc457524c5b0">ERADLIMIT</a>) pin[YFL4]=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a5bd9da451f108352614cbc457524c5b0">ERADLIMIT</a>; <span class="comment">// floor on floor to avoid large gradients in flux that lead to crazy large values.</span></div>
<div class="line"><a name="l12591"></a><span class="lineno">12591</span>&#160;    }</div>
<div class="line"><a name="l12592"></a><span class="lineno">12592</span>&#160;    <span class="keywordflow">if</span>(YFL5&gt;=0) pin[YFL5] = uu[YFL5]/uradt; <span class="comment">// uu[YFLx]/u^t</span></div>
<div class="line"><a name="l12593"></a><span class="lineno">12593</span>&#160;  }</div>
<div class="line"><a name="l12594"></a><span class="lineno">12594</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l12595"></a><span class="lineno">12595</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l12596"></a><span class="lineno">12596</span>&#160;</div>
<div class="line"><a name="l12597"></a><span class="lineno">12597</span>&#160;</div>
<div class="line"><a name="l12598"></a><span class="lineno">12598</span>&#160;</div>
<div class="line"><a name="l12599"></a><span class="lineno">12599</span>&#160;</div>
<div class="line"><a name="l12600"></a><span class="lineno">12600</span>&#160;</div>
<div class="line"><a name="l12601"></a><span class="lineno">12601</span>&#160;</div>
<div class="line"><a name="l12602"></a><span class="lineno">12602</span>&#160;</div>
<div class="line"><a name="l12603"></a><span class="lineno">12603</span>&#160;</div>
<div class="line"><a name="l12604"></a><span class="lineno">12604</span>&#160;  <span class="comment">//  dualfprintf(fail_file,&quot;didmod=%d\n&quot;,didmod);</span></div>
<div class="line"><a name="l12605"></a><span class="lineno">12605</span>&#160;</div>
<div class="line"><a name="l12606"></a><span class="lineno">12606</span>&#160;  <span class="comment">// make sure E_r no larger than starting value</span></div>
<div class="line"><a name="l12607"></a><span class="lineno">12607</span>&#160;  <span class="keywordflow">if</span>(didmod==1){</div>
<div class="line"><a name="l12608"></a><span class="lineno">12608</span>&#160;    nummod++;</div>
<div class="line"><a name="l12609"></a><span class="lineno">12609</span>&#160;    <span class="keywordflow">if</span>(didmodEr){</div>
<div class="line"><a name="l12610"></a><span class="lineno">12610</span>&#160;      *lpflagrad=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a38b0585ec02d900ad0413645acb00918">UTOPRIMRADFAILERFNEG</a>;</div>
<div class="line"><a name="l12611"></a><span class="lineno">12611</span>&#160;    }</div>
<div class="line"><a name="l12612"></a><span class="lineno">12612</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l12613"></a><span class="lineno">12613</span>&#160;      <span class="keywordflow">if</span>(gotbigy) *lpflagrad=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a36f23f21f8e90ce3e39940621c912714">UTOPRIMRADFAILGAMMAHIGH</a>;</div>
<div class="line"><a name="l12614"></a><span class="lineno">12614</span>&#160;      <span class="keywordflow">else</span> *lpflagrad=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#af1ba8d5f13f64649f7f731147526401d">UTOPRIMRADFAILCASE2A</a>; <span class="comment">// used to detect if modified primitives to not be consistent with inputted uu</span></div>
<div class="line"><a name="l12615"></a><span class="lineno">12615</span>&#160;    }</div>
<div class="line"><a name="l12616"></a><span class="lineno">12616</span>&#160;  }</div>
<div class="line"><a name="l12617"></a><span class="lineno">12617</span>&#160;</div>
<div class="line"><a name="l12618"></a><span class="lineno">12618</span>&#160;</div>
<div class="line"><a name="l12619"></a><span class="lineno">12619</span>&#160;</div>
<div class="line"><a name="l12620"></a><span class="lineno">12620</span>&#160;<span class="preprocessor">#if(PRODUCTION==0)</span></div>
<div class="line"><a name="l12621"></a><span class="lineno">12621</span>&#160;<span class="preprocessor"></span>  <span class="keywordflow">if</span>(debugfail&gt;=2){</div>
<div class="line"><a name="l12622"></a><span class="lineno">12622</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> nstepold=-1;</div>
<div class="line"><a name="l12623"></a><span class="lineno">12623</span>&#160;    <span class="keywordflow">if</span>(nstep!=nstepold &amp;&amp; nstep%100==0 &amp;&amp; ptrgeom-&gt;i==0 &amp;&amp; ptrgeom-&gt;j==0 &amp;&amp; ptrgeom-&gt;k==0 &amp;&amp; steppart==0){</div>
<div class="line"><a name="l12624"></a><span class="lineno">12624</span>&#160;      nstepold=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a1a1088d87617078680f1fd0f0d707384">nstep</a>;</div>
<div class="line"><a name="l12625"></a><span class="lineno">12625</span>&#160;      dualfprintf(fail_file,<span class="stringliteral">&quot;numyvarneg=%lld numyvarbig=%lld numErneg=%lld nummod=%lld : nstep=%ld\n&quot;</span>,numyvarneg,numyvarbig,numErneg,nummod,nstep);</div>
<div class="line"><a name="l12626"></a><span class="lineno">12626</span>&#160;    }</div>
<div class="line"><a name="l12627"></a><span class="lineno">12627</span>&#160;  }</div>
<div class="line"><a name="l12628"></a><span class="lineno">12628</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l12629"></a><span class="lineno">12629</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l12630"></a><span class="lineno">12630</span>&#160;  <span class="comment">// interpret certain failure modes (below, these are treated as soft failures only processed by fixup_utoprim()</span></div>
<div class="line"><a name="l12631"></a><span class="lineno">12631</span>&#160;  <span class="keywordflow">if</span>(gotbigy) *lpflagrad=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a36f23f21f8e90ce3e39940621c912714">UTOPRIMRADFAILGAMMAHIGH</a>; <span class="comment">// softish failure where we will fixup_utoprim() urad^t but not Erf</span></div>
<div class="line"><a name="l12632"></a><span class="lineno">12632</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(didmodEr) *lpflagrad=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a38b0585ec02d900ad0413645acb00918">UTOPRIMRADFAILERFNEG</a>; <span class="comment">// softish failure, passes through until fixup_utoprim() where adjusted</span></div>
<div class="line"><a name="l12633"></a><span class="lineno">12633</span>&#160;</div>
<div class="line"><a name="l12634"></a><span class="lineno">12634</span>&#160;</div>
<div class="line"><a name="l12635"></a><span class="lineno">12635</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a69aeed93a5b7bf3c0669b44f07148e92" title="whether to fixup inversion failures using harm fixups can lead to issues because diffuses, so across sharp boundary radiation can be given quite &quot;wrong&quot; values that don&#39;t match what solution &quot;wants&quot;">DORADFIXUPS</a>==1 || allowlocalfailurefixandnoreport==0){</div>
<div class="line"><a name="l12636"></a><span class="lineno">12636</span>&#160;    <span class="comment">// KORALTODO: Problem is fixups can average across shock or place where (e.g.) velocity changes alot, and averaging diffuses shock and can leak-out more failures.</span></div>
<div class="line"><a name="l12637"></a><span class="lineno">12637</span>&#160;  }</div>
<div class="line"><a name="l12638"></a><span class="lineno">12638</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l12639"></a><span class="lineno">12639</span>&#160;    <span class="comment">// CASE reductions (so set as no failure so fixups don&#39;t operate -- but might also want to turn off CHECKINVERSIONRAD else that routine won&#39;t know when to ignore bad U-&gt;P-&gt;U cases.)</span></div>
<div class="line"><a name="l12640"></a><span class="lineno">12640</span>&#160;    <span class="keywordflow">if</span>(*lpflagrad==0) *lpflagrad=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6435e9609d622c9dbaf78c12658ecf8e">UTOPRIMRADNOFAIL</a>;</div>
<div class="line"><a name="l12641"></a><span class="lineno">12641</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(gotbigy) *lpflagrad=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a36f23f21f8e90ce3e39940621c912714">UTOPRIMRADFAILGAMMAHIGH</a>; <span class="comment">// softish failure where we will fixup_utoprim() urad^t but not Erf</span></div>
<div class="line"><a name="l12642"></a><span class="lineno">12642</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(didmodEr) *lpflagrad=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a38b0585ec02d900ad0413645acb00918">UTOPRIMRADFAILERFNEG</a>; <span class="comment">// softish failure, passes through until fixup_utoprim() where adjusted</span></div>
<div class="line"><a name="l12643"></a><span class="lineno">12643</span>&#160;    <span class="keywordflow">else</span> *lpflagrad=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ac2e41dde6ad6ac3afe36f33ff2e1a720">UTOPRIMRADFAILFIXEDUTOPRIMRAD</a>; <span class="comment">//UTOPRIMRADNOFAIL;</span></div>
<div class="line"><a name="l12644"></a><span class="lineno">12644</span>&#160;  }</div>
<div class="line"><a name="l12645"></a><span class="lineno">12645</span>&#160;</div>
<div class="line"><a name="l12646"></a><span class="lineno">12646</span>&#160;  <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l12647"></a><span class="lineno">12647</span>&#160;</div>
<div class="line"><a name="l12648"></a><span class="lineno">12648</span>&#160;</div>
<div class="line"><a name="l12649"></a><span class="lineno">12649</span>&#160;</div>
<div class="line"><a name="l12650"></a><span class="lineno">12650</span>&#160;}</div>
<div class="line"><a name="l12651"></a><span class="lineno">12651</span>&#160;</div>
<div class="line"><a name="l12653"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a77c546a7fb064266fef5a9e796dc63dc">12653</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a77c546a7fb064266fef5a9e796dc63dc" title="compute ZAMO version of radiation quantities as in paper draft">compute_ZAMORAD</a>(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *uu, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Er, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Utildesq, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Utildecon)</div>
<div class="line"><a name="l12654"></a><span class="lineno">12654</span>&#160;{</div>
<div class="line"><a name="l12655"></a><span class="lineno">12655</span>&#160;  <span class="keywordtype">int</span> jj,kk;</div>
<div class="line"><a name="l12656"></a><span class="lineno">12656</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> etacov[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>],etacon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l12657"></a><span class="lineno">12657</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Ucon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>],Ucov[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>],Utildecov[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l12658"></a><span class="lineno">12658</span>&#160;</div>
<div class="line"><a name="l12659"></a><span class="lineno">12659</span>&#160;  <span class="comment">//  dualfprintf(fail_file,&quot;uu=%g %g %g %g\n&quot;,uu[URAD0],uu[URAD1],uu[URAD2],uu[URAD3]);</span></div>
<div class="line"><a name="l12660"></a><span class="lineno">12660</span>&#160;</div>
<div class="line"><a name="l12661"></a><span class="lineno">12661</span>&#160;  <span class="comment">// \eta_\mu</span></div>
<div class="line"><a name="l12662"></a><span class="lineno">12662</span>&#160;  etacov[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>] = -ptrgeom-&gt;alphalapse;</div>
<div class="line"><a name="l12663"></a><span class="lineno">12663</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) etacov[jj]=0.0;</div>
<div class="line"><a name="l12664"></a><span class="lineno">12664</span>&#160;  <span class="comment">// \eta^\mu</span></div>
<div class="line"><a name="l12665"></a><span class="lineno">12665</span>&#160;  raise_vec(etacov,ptrgeom,etacon); <span class="comment">// could use ptrgeom-&gt;beta</span></div>
<div class="line"><a name="l12666"></a><span class="lineno">12666</span>&#160;</div>
<div class="line"><a name="l12667"></a><span class="lineno">12667</span>&#160;  <span class="comment">// U_\mu = -R^\nu_\mu \eta_\nu = \alpha R^t_\mu</span></div>
<div class="line"><a name="l12668"></a><span class="lineno">12668</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) Ucov[jj] = ptrgeom-&gt;alphalapse*uu[URAD0+jj];</div>
<div class="line"><a name="l12669"></a><span class="lineno">12669</span>&#160;  <span class="comment">// U^\mu</span></div>
<div class="line"><a name="l12670"></a><span class="lineno">12670</span>&#160;  raise_vec(Ucov,ptrgeom,Ucon);</div>
<div class="line"><a name="l12671"></a><span class="lineno">12671</span>&#160;</div>
<div class="line"><a name="l12672"></a><span class="lineno">12672</span>&#160;  <span class="comment">// \tilde{U}^\mu = j^\mu_\nu U^\nu = (\delta^\mu_\nu + \eta^\mu \eta_\nu) U^\nu : ZAMO frame momentum</span></div>
<div class="line"><a name="l12673"></a><span class="lineno">12673</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) Utildecon[jj]=0.0;</div>
<div class="line"><a name="l12674"></a><span class="lineno">12674</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a59b7ef1517ff22fd4dfce4cf6d380c55" title="loop over all Dimensions; second rank loop">DLOOP</a>(jj,kk) Utildecon[jj] += (<a class="code" href="../../d9/d43/global_8variousmacros_8h.html#aa5ebb2763dd5546bc40222826cea731f">delta</a>(jj,kk) + etacon[jj]*etacov[kk])*Ucon[kk];</div>
<div class="line"><a name="l12675"></a><span class="lineno">12675</span>&#160;  <span class="comment">// \tilde{U}_\mu</span></div>
<div class="line"><a name="l12676"></a><span class="lineno">12676</span>&#160;  lower_vec(Utildecon,ptrgeom,Utildecov);</div>
<div class="line"><a name="l12677"></a><span class="lineno">12677</span>&#160;  </div>
<div class="line"><a name="l12678"></a><span class="lineno">12678</span>&#160;  <span class="comment">// \tilde{U}^2 = \tilde{U}^\mu \tilde{U}_\mu</span></div>
<div class="line"><a name="l12679"></a><span class="lineno">12679</span>&#160;  *Utildesq=0.0;</div>
<div class="line"><a name="l12680"></a><span class="lineno">12680</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) *Utildesq += Utildecon[jj]*Utildecov[jj];</div>
<div class="line"><a name="l12681"></a><span class="lineno">12681</span>&#160;</div>
<div class="line"><a name="l12682"></a><span class="lineno">12682</span>&#160;  <span class="comment">// -Er = -R^\nu_\mu \eta_\nu \eta^\mu = U_\mu \eta^\mu = alpha R^t_\mu \eta^\mu : ZAMO frame energy</span></div>
<div class="line"><a name="l12683"></a><span class="lineno">12683</span>&#160;  *Er=0.0;</div>
<div class="line"><a name="l12684"></a><span class="lineno">12684</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) *Er += -Ucov[jj]*etacon[jj];</div>
<div class="line"><a name="l12685"></a><span class="lineno">12685</span>&#160;</div>
<div class="line"><a name="l12686"></a><span class="lineno">12686</span>&#160;</div>
<div class="line"><a name="l12687"></a><span class="lineno">12687</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l12688"></a><span class="lineno">12688</span>&#160;}</div>
<div class="line"><a name="l12689"></a><span class="lineno">12689</span>&#160;</div>
<div class="line"><a name="l12690"></a><span class="lineno">12690</span>&#160;</div>
<div class="line"><a name="l12691"></a><span class="lineno">12691</span>&#160;<span class="comment">// 0 or 1</span></div>
<div class="line"><a name="l12692"></a><span class="lineno">12692</span>&#160;<span class="comment">// generally, should have TRYCOLD=1 as most general way to deal with failure</span></div>
<div class="line"><a name="l12693"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5f25064797a21c72c367a274bd97abb1">12693</a></span>&#160;<span class="preprocessor">#define TRYCOLD 1</span></div>
<div class="line"><a name="l12694"></a><span class="lineno">12694</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l12695"></a><span class="lineno">12695</span>&#160;<span class="comment">// for debugging</span></div>
<div class="line"><a name="l12696"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab28ea67879ee5fe899121cdadb3670b4">12696</a></span>&#160;<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ab28ea67879ee5fe899121cdadb3670b4">globaluu</a>[NPR];</div>
<div class="line"><a name="l12697"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5bc9d410c6394e039141ee8c05b5e025">12697</a></span>&#160;<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5bc9d410c6394e039141ee8c05b5e025">globalpin</a>[NPR];</div>
<div class="line"><a name="l12698"></a><span class="lineno">12698</span>&#160;</div>
<div class="line"><a name="l12729"></a><span class="lineno">12729</span>&#160;<span class="keywordtype">int</span> u2p_rad_orig(<span class="keywordtype">int</span> showmessages, <span class="keywordtype">int</span> allowlocalfailurefixandnoreport, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammamaxrad, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *uu, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pin, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflag, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflagrad)</div>
<div class="line"><a name="l12730"></a><span class="lineno">12730</span>&#160;{</div>
<div class="line"><a name="l12731"></a><span class="lineno">12731</span>&#160;  <span class="keywordtype">int</span> jj,kk;</div>
<div class="line"><a name="l12732"></a><span class="lineno">12732</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> pp[NPR];</div>
<div class="line"><a name="l12733"></a><span class="lineno">12733</span>&#160;  <span class="keywordtype">int</span> pliter,pl;</div>
<div class="line"><a name="l12734"></a><span class="lineno">12734</span>&#160;</div>
<div class="line"><a name="l12735"></a><span class="lineno">12735</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) globaluu[pl]=uu[pl];</div>
<div class="line"><a name="l12736"></a><span class="lineno">12736</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) globalpin[pl]=pin[pl];</div>
<div class="line"><a name="l12737"></a><span class="lineno">12737</span>&#160;</div>
<div class="line"><a name="l12738"></a><span class="lineno">12738</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#a3d14480f30d39eff4e51ae8bc93df56f" title="whether we use ultimately precise inversion or &quot;workable&quot; inversion precision (see utoprim&#39;s for ho...">WHICHVEL</a>!=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7d5588994345227982f0ed709b28e1f1">VELREL4</a>){</div>
<div class="line"><a name="l12739"></a><span class="lineno">12739</span>&#160;    dualfprintf(fail_file,<span class="stringliteral">&quot;u2p_rad() only setup for relative 4-velocity, currently.\n&quot;</span>);</div>
<div class="line"><a name="l12740"></a><span class="lineno">12740</span>&#160;    myexit(137432636);</div>
<div class="line"><a name="l12741"></a><span class="lineno">12741</span>&#160;  }</div>
<div class="line"><a name="l12742"></a><span class="lineno">12742</span>&#160;</div>
<div class="line"><a name="l12743"></a><span class="lineno">12743</span>&#160;</div>
<div class="line"><a name="l12744"></a><span class="lineno">12744</span>&#160;  <span class="comment">// copy over pin so pin isn&#39;t modified until end</span></div>
<div class="line"><a name="l12745"></a><span class="lineno">12745</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) pp[pl]=pin[pl];</div>
<div class="line"><a name="l12746"></a><span class="lineno">12746</span>&#160;</div>
<div class="line"><a name="l12748"></a><span class="lineno">12748</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l12749"></a><span class="lineno">12749</span>&#160;  <span class="comment">// Prepare inversion from U-&gt;p for radiation assuming M1 closure</span></div>
<div class="line"><a name="l12750"></a><span class="lineno">12750</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l12752"></a><span class="lineno">12752</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l12753"></a><span class="lineno">12753</span>&#160;  *lpflagrad=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6435e9609d622c9dbaf78c12658ecf8e">UTOPRIMRADNOFAIL</a>;</div>
<div class="line"><a name="l12754"></a><span class="lineno">12754</span>&#160;</div>
<div class="line"><a name="l12755"></a><span class="lineno">12755</span>&#160;</div>
<div class="line"><a name="l12756"></a><span class="lineno">12756</span>&#160;  <span class="comment">//conserved - R^t_mu</span></div>
<div class="line"><a name="l12757"></a><span class="lineno">12757</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Avcov[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>]={uu[URAD0],uu[URAD1],uu[URAD2],uu[URAD3]};</div>
<div class="line"><a name="l12758"></a><span class="lineno">12758</span>&#160;  <span class="comment">//indices up - R^tmu</span></div>
<div class="line"><a name="l12759"></a><span class="lineno">12759</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Avcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l12760"></a><span class="lineno">12760</span>&#160;  indices_12(Avcov,Avcon,ptrgeom);</div>
<div class="line"><a name="l12761"></a><span class="lineno">12761</span>&#160;</div>
<div class="line"><a name="l12762"></a><span class="lineno">12762</span>&#160;</div>
<div class="line"><a name="l12763"></a><span class="lineno">12763</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammarel2,<a class="code" href="../../d9/d43/global_8variousmacros_8h.html#aa5ebb2763dd5546bc40222826cea731f">delta</a>,numerator,divisor;</div>
<div class="line"><a name="l12764"></a><span class="lineno">12764</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Erf;</div>
<div class="line"><a name="l12765"></a><span class="lineno">12765</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> urfconrel[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l12766"></a><span class="lineno">12766</span>&#160;</div>
<div class="line"><a name="l12767"></a><span class="lineno">12767</span>&#160;</div>
<div class="line"><a name="l12768"></a><span class="lineno">12768</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#a99ba7daf58b283bc831b8f507f5873a4" title="#define EOMTYPE EOMCOLDGRMHD">EOMRADTYPE</a>==<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#aeecbb1829400fae0bc7971d41ca4222d">EOMRADEDD</a>){</div>
<div class="line"><a name="l12769"></a><span class="lineno">12769</span>&#160;    <span class="comment">// NOTEMARK: Can&#39;t use normal inversion that assumes R^t_i are independently evolved because they will generally lead to different velocity than fluid.</span></div>
<div class="line"><a name="l12770"></a><span class="lineno">12770</span>&#160;</div>
<div class="line"><a name="l12771"></a><span class="lineno">12771</span>&#160;    <span class="comment">// radiation is same as fluid gamma (assume fluid has already been inverted)</span></div>
<div class="line"><a name="l12772"></a><span class="lineno">12772</span>&#160;    urfconrel[1]=pp[PRAD1]=pp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>];</div>
<div class="line"><a name="l12773"></a><span class="lineno">12773</span>&#160;    urfconrel[2]=pp[PRAD2]=pp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae907e773ef038f3fc0c2ad5de0cb0f07">U2</a>];</div>
<div class="line"><a name="l12774"></a><span class="lineno">12774</span>&#160;    urfconrel[3]=pp[PRAD3]=pp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8de9104f1fffa59f057b214d74c5cfea">U3</a>];</div>
<div class="line"><a name="l12775"></a><span class="lineno">12775</span>&#160; </div>
<div class="line"><a name="l12776"></a><span class="lineno">12776</span>&#160;    <span class="comment">// get gammarel2</span></div>
<div class="line"><a name="l12777"></a><span class="lineno">12777</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammarel,qsq;</div>
<div class="line"><a name="l12778"></a><span class="lineno">12778</span>&#160;    <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#abfae38e47b0bd05a4fc38302ff948a96" title="find gamma-factor wrt normal observer This function and qsq_calc() have about the same cache miss amo...">gamma_calc_fromuconrel</a>(urfconrel,ptrgeom,&amp;gammarel,&amp;qsq);</div>
<div class="line"><a name="l12779"></a><span class="lineno">12779</span>&#160;    gammarel2=gammarel*gammarel;</div>
<div class="line"><a name="l12780"></a><span class="lineno">12780</span>&#160; </div>
<div class="line"><a name="l12781"></a><span class="lineno">12781</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> alpha=ptrgeom-&gt;alphalapse; <span class="comment">//sqrt(-1./ptrgeom-&gt;gcon[GIND(0,0)]);</span></div>
<div class="line"><a name="l12782"></a><span class="lineno">12782</span>&#160;    <span class="comment">// get energy density in fluid frame from lab-frame</span></div>
<div class="line"><a name="l12783"></a><span class="lineno">12783</span>&#160;    Erf=3.*Avcon[0]*alpha*alpha/(4.*gammarel2-1.0);  <span class="comment">// JCM</span></div>
<div class="line"><a name="l12784"></a><span class="lineno">12784</span>&#160;</div>
<div class="line"><a name="l12785"></a><span class="lineno">12785</span>&#160;  }</div>
<div class="line"><a name="l12786"></a><span class="lineno">12786</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#a99ba7daf58b283bc831b8f507f5873a4" title="#define EOMTYPE EOMCOLDGRMHD">EOMRADTYPE</a>==<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#aef9536ef5213153f07b830f3fd1f70aa">EOMRADM1CLOSURE</a>){</div>
<div class="line"><a name="l12787"></a><span class="lineno">12787</span>&#160;</div>
<div class="line"><a name="l12788"></a><span class="lineno">12788</span>&#160;    <span class="comment">// get \gamma^2 for relative 4-velocity</span></div>
<div class="line"><a name="l12789"></a><span class="lineno">12789</span>&#160;    <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ac65d2f7675d8e61488e8152455f7a9df" title="get&#39;s gamma^2 for lab-frame gamma using Rd and gcon">get_m1closure_gammarel2</a>(showmessages,ptrgeom,Avcon,Avcov,&amp;gammarel2,&amp;delta,&amp;numerator,&amp;divisor);</div>
<div class="line"><a name="l12790"></a><span class="lineno">12790</span>&#160;</div>
<div class="line"><a name="l12791"></a><span class="lineno">12791</span>&#160;    <span class="keywordflow">if</span>(0){</div>
<div class="line"><a name="l12792"></a><span class="lineno">12792</span>&#160;      <span class="comment">// testing</span></div>
<div class="line"><a name="l12793"></a><span class="lineno">12793</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Avconnew[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>]={Avcon[0],Avcon[1],Avcon[2],Avcon[3]};</div>
<div class="line"><a name="l12794"></a><span class="lineno">12794</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> urfconrelnew[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l12795"></a><span class="lineno">12795</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammarel2new,deltanew,numeratornew,divisornew,Erfnew;</div>
<div class="line"><a name="l12796"></a><span class="lineno">12796</span>&#160;      <span class="comment">//      get_m1closure_gammarel2_cold(showmessages,ptrgeom,Avconnew,&amp;gammarel2new,&amp;deltanew,&amp;numeratornew,&amp;divisornew,&amp;Erfnew,urfconrelnew);</span></div>
<div class="line"><a name="l12797"></a><span class="lineno">12797</span>&#160;      <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ac417e724b77704df1dc35e32071df2f2" title="get&#39;s gamma assuming fixed E rather than using original R^t_t that we assume is flawed near floor reg...">get_m1closure_gammarel2_cold</a>(showmessages,ptrgeom,Avconnew,Avcov,NULL,&amp;deltanew,&amp;numeratornew,&amp;divisornew,&amp;Erfnew,urfconrelnew);</div>
<div class="line"><a name="l12798"></a><span class="lineno">12798</span>&#160;    }</div>
<div class="line"><a name="l12799"></a><span class="lineno">12799</span>&#160;</div>
<div class="line"><a name="l12800"></a><span class="lineno">12800</span>&#160;</div>
<div class="line"><a name="l12801"></a><span class="lineno">12801</span>&#160;</div>
<div class="line"><a name="l12802"></a><span class="lineno">12802</span>&#160;    <span class="comment">// get E in radiation frame</span></div>
<div class="line"><a name="l12803"></a><span class="lineno">12803</span>&#160;    <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a4f76ac5680b95db932b2cf3ee309fb07" title="get Erf">get_m1closure_Erf</a>(ptrgeom,Avcon,gammarel2,&amp;Erf);</div>
<div class="line"><a name="l12804"></a><span class="lineno">12804</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Erforig=Erf;</div>
<div class="line"><a name="l12805"></a><span class="lineno">12805</span>&#160;</div>
<div class="line"><a name="l12806"></a><span class="lineno">12806</span>&#160;    <span class="comment">// get relative 4-velocity</span></div>
<div class="line"><a name="l12807"></a><span class="lineno">12807</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a68cc613160b89aef5563b45f20a303f5">CASECHOICE</a>==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a2035388bf43781f4e128080c78286d02" title="whether to choose Jon or Olek way of handling u2p_rad inversion failures">JONCHOICE</a>) <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a69289f92f5afd222ade67c4e9c60285a" title="get contravariant relative 4-velocity in lab frame">get_m1closure_urfconrel</a>(showmessages,allowlocalfailurefixandnoreport,ptrgeom,pp,Avcon,Avcov,gammarel2,delta,numerator,divisor,&amp;Erf,urfconrel,lpflag,lpflagrad);</div>
<div class="line"><a name="l12808"></a><span class="lineno">12808</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a68cc613160b89aef5563b45f20a303f5">CASECHOICE</a>==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#acb04a5077aeea127dfd3303bd8c62041">OLEKCHOICE</a>) <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a56eedd5db3838b564acfd63644b07c2a" title="get contravariant relative 4-velocity in lab frame using Olek&#39;s koral choices">get_m1closure_urfconrel_olek</a>(showmessages,allowlocalfailurefixandnoreport,ptrgeom,pp,Avcon,Avcov,gammarel2,delta,&amp;Erf,urfconrel,lpflag,lpflagrad);</div>
<div class="line"><a name="l12809"></a><span class="lineno">12809</span>&#160;</div>
<div class="line"><a name="l12810"></a><span class="lineno">12810</span>&#160;<span class="preprocessor">#if(0)</span></div>
<div class="line"><a name="l12811"></a><span class="lineno">12811</span>&#160;<span class="preprocessor"></span>    <span class="comment">// TESTING:</span></div>
<div class="line"><a name="l12812"></a><span class="lineno">12812</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Erf2=Erforig,urfconrel2[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l12813"></a><span class="lineno">12813</span>&#160;    <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a56eedd5db3838b564acfd63644b07c2a" title="get contravariant relative 4-velocity in lab frame using Olek&#39;s koral choices">get_m1closure_urfconrel_olek</a>(showmessages,allowlocalfailurefixandnoreport,ptrgeom,pp,Avcon,Avcov,gammarel2,delta,&amp;Erf2,urfconrel2,lpflag,lpflagrad);</div>
<div class="line"><a name="l12814"></a><span class="lineno">12814</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ERRORCHECK;</div>
<div class="line"><a name="l12815"></a><span class="lineno">12815</span>&#160;    ERRORCHECK=1<a class="code" href="../../d8/d60/init_8c.html#a07484107e6d9fdf38b53edf631d6511d">E</a>-1;</div>
<div class="line"><a name="l12816"></a><span class="lineno">12816</span>&#160;    <span class="keywordflow">if</span>( fabs(Erf2-Erf)/(fabs(Erf2)+fabs(Erf))&gt;ERRORCHECK || fabs(urfconrel2[1]-urfconrel[1])/(fabs(urfconrel2[1])+fabs(urfconrel[1]))&gt;ERRORCHECK || fabs(urfconrel2[2]-urfconrel[2])/(fabs(urfconrel2[2])+fabs(urfconrel[2]))&gt;ERRORCHECK || fabs(urfconrel2[3]-urfconrel[3])/(fabs(urfconrel2[3])+fabs(urfconrel[3]))&gt;ERRORCHECK){</div>
<div class="line"><a name="l12817"></a><span class="lineno">12817</span>&#160;      dualfprintf(fail_file,<span class="stringliteral">&quot;JONVSOLEK: ijk=%d %d %d : nstep=%ld steppart=%d : %g %g %g %g : %g %g %g %g\n&quot;</span>,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,nstep,steppart,Erf,urfconrel[1],urfconrel[2],urfconrel[3],Erf2,urfconrel2[1],urfconrel2[2],urfconrel2[3]);</div>
<div class="line"><a name="l12818"></a><span class="lineno">12818</span>&#160;    }</div>
<div class="line"><a name="l12819"></a><span class="lineno">12819</span>&#160;    ERRORCHECK=0.4;</div>
<div class="line"><a name="l12820"></a><span class="lineno">12820</span>&#160;    <span class="keywordflow">if</span>( fabs(Erf2-Erf)/(fabs(Erf2)+fabs(Erf))&gt;ERRORCHECK || fabs(urfconrel2[1]-urfconrel[1])/(fabs(urfconrel2[1])+fabs(urfconrel[1]))&gt;ERRORCHECK || fabs(urfconrel2[2]-urfconrel[2])/(fabs(urfconrel2[2])+fabs(urfconrel[2]))&gt;ERRORCHECK || fabs(urfconrel2[3]-urfconrel[3])/(fabs(urfconrel2[3])+fabs(urfconrel[3]))&gt;ERRORCHECK){</div>
<div class="line"><a name="l12821"></a><span class="lineno">12821</span>&#160;      dualfprintf(fail_file,<span class="stringliteral">&quot;JONVSOLEK: ijk=%d %d %d : nstep=%ld steppart=%d : %g %g %g %g : %g %g %g %g\n&quot;</span>,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,nstep,steppart,Erf,urfconrel[1],urfconrel[2],urfconrel[3],Erf2,urfconrel2[1],urfconrel2[2],urfconrel2[3]);</div>
<div class="line"><a name="l12822"></a><span class="lineno">12822</span>&#160;    }</div>
<div class="line"><a name="l12823"></a><span class="lineno">12823</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l12824"></a><span class="lineno">12824</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l12825"></a><span class="lineno">12825</span>&#160;  }<span class="comment">// end if M1</span></div>
<div class="line"><a name="l12826"></a><span class="lineno">12826</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l12827"></a><span class="lineno">12827</span>&#160;    dualfprintf(fail_file,<span class="stringliteral">&quot;No such EOMRADTYPE=%d in u2p_rad()\n&quot;</span>,<a class="code" href="../../da/d3e/definit_8h.html#a99ba7daf58b283bc831b8f507f5873a4" title="#define EOMTYPE EOMCOLDGRMHD">EOMRADTYPE</a>);</div>
<div class="line"><a name="l12828"></a><span class="lineno">12828</span>&#160;    myexit(368322162);</div>
<div class="line"><a name="l12829"></a><span class="lineno">12829</span>&#160;  }</div>
<div class="line"><a name="l12830"></a><span class="lineno">12830</span>&#160;</div>
<div class="line"><a name="l12831"></a><span class="lineno">12831</span>&#160;</div>
<div class="line"><a name="l12832"></a><span class="lineno">12832</span>&#160;  <span class="comment">//new primitives (only uses urfcon[1-3])</span></div>
<div class="line"><a name="l12833"></a><span class="lineno">12833</span>&#160;  pin[PRAD0]=Erf;</div>
<div class="line"><a name="l12834"></a><span class="lineno">12834</span>&#160;  pin[PRAD1]=urfconrel[1];</div>
<div class="line"><a name="l12835"></a><span class="lineno">12835</span>&#160;  pin[PRAD2]=urfconrel[2];</div>
<div class="line"><a name="l12836"></a><span class="lineno">12836</span>&#160;  pin[PRAD3]=urfconrel[3];</div>
<div class="line"><a name="l12837"></a><span class="lineno">12837</span>&#160;</div>
<div class="line"><a name="l12839"></a><span class="lineno">12839</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l12840"></a><span class="lineno">12840</span>&#160;  <span class="comment">// INVERT to get Number density of photons in radiation frame</span></div>
<div class="line"><a name="l12841"></a><span class="lineno">12841</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l12843"></a><span class="lineno">12843</span>&#160;<span class="comment"></span><span class="preprocessor">#if(EVOLVENRAD&amp;&amp;NRAD&gt;0)</span></div>
<div class="line"><a name="l12844"></a><span class="lineno">12844</span>&#160;<span class="preprocessor"></span>  <span class="keywordflow">if</span>(*lpflagrad==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6435e9609d622c9dbaf78c12658ecf8e">UTOPRIMRADNOFAIL</a>){</div>
<div class="line"><a name="l12845"></a><span class="lineno">12845</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammafinal,qsqfinal;</div>
<div class="line"><a name="l12846"></a><span class="lineno">12846</span>&#160;    <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#abfae38e47b0bd05a4fc38302ff948a96" title="find gamma-factor wrt normal observer This function and qsq_calc() have about the same cache miss amo...">gamma_calc_fromuconrel</a>(&amp;pin[URAD1-1],ptrgeom,&amp;gammafinal,&amp;qsqfinal);</div>
<div class="line"><a name="l12847"></a><span class="lineno">12847</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> uradt=gammafinal/(ptrgeom-&gt;alphalapse); <span class="comment">// u^t = gamma/alphalapse</span></div>
<div class="line"><a name="l12848"></a><span class="lineno">12848</span>&#160;    pin[NRAD] = uu[NRAD]/uradt; <span class="comment">// nradinradframe * urad[TT] / uradt</span></div>
<div class="line"><a name="l12849"></a><span class="lineno">12849</span>&#160;  }</div>
<div class="line"><a name="l12850"></a><span class="lineno">12850</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l12851"></a><span class="lineno">12851</span>&#160;    <span class="comment">// if failed to get solution, can&#39;t trust \gamma, so revert to thermal photons</span></div>
<div class="line"><a name="l12852"></a><span class="lineno">12852</span>&#160;    pin[NRAD] = <a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#a3e47afcfc5c42719999d851395fd032d" title="nrad(E)">calc_LTE_NfromE</a>(Erf);</div>
<div class="line"><a name="l12853"></a><span class="lineno">12853</span>&#160;  }</div>
<div class="line"><a name="l12854"></a><span class="lineno">12854</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l12855"></a><span class="lineno">12855</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l12856"></a><span class="lineno">12856</span>&#160;</div>
<div class="line"><a name="l12857"></a><span class="lineno">12857</span>&#160;</div>
<div class="line"><a name="l12859"></a><span class="lineno">12859</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l12860"></a><span class="lineno">12860</span>&#160;  <span class="comment">// INVERT floor advectors</span></div>
<div class="line"><a name="l12861"></a><span class="lineno">12861</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l12863"></a><span class="lineno">12863</span>&#160;<span class="comment"></span><span class="preprocessor">#if(DOYFL==2 &amp;&amp; (YFL4&gt;=0 || YFL5&gt;=0))</span></div>
<div class="line"><a name="l12864"></a><span class="lineno">12864</span>&#160;<span class="preprocessor"></span>  <span class="comment">// if failed to get solution, can&#39;t trust \gamma, so evolution of floor wil be itself bad, but assume CASE reductions reasonable</span></div>
<div class="line"><a name="l12865"></a><span class="lineno">12865</span>&#160;  <span class="comment">// But, for scalars, this primitive is ultimately multiplied by uradt itself, so whatever uradt is, the conserved quantity is evolved/fluxed correctly/conservatively</span></div>
<div class="line"><a name="l12866"></a><span class="lineno">12866</span>&#160;  <span class="keywordflow">if</span>(1){</div>
<div class="line"><a name="l12867"></a><span class="lineno">12867</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammafinal,qsqfinal;</div>
<div class="line"><a name="l12868"></a><span class="lineno">12868</span>&#160;    <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#abfae38e47b0bd05a4fc38302ff948a96" title="find gamma-factor wrt normal observer This function and qsq_calc() have about the same cache miss amo...">gamma_calc_fromuconrel</a>(&amp;pin[URAD1-1],ptrgeom,&amp;gammafinal,&amp;qsqfinal);</div>
<div class="line"><a name="l12869"></a><span class="lineno">12869</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> uradt=gammafinal/(ptrgeom-&gt;alphalapse); <span class="comment">// u^t = gamma/alphalapse</span></div>
<div class="line"><a name="l12870"></a><span class="lineno">12870</span>&#160;    <span class="keywordflow">if</span>(YFL4&gt;=0){</div>
<div class="line"><a name="l12871"></a><span class="lineno">12871</span>&#160;      pin[YFL4] = -uu[YFL4]/uradt; <span class="comment">// -uu[YFLx]/u^t // NOTEMARK: Same sign as in other places like utoprimgen.c and fixup.c</span></div>
<div class="line"><a name="l12872"></a><span class="lineno">12872</span>&#160;      <span class="keywordflow">if</span>(pin[YFL4]&lt;<a class="code" href="../../d8/d5b/defs_8general_8h.html#a5bd9da451f108352614cbc457524c5b0">ERADLIMIT</a>) pin[YFL4]=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a5bd9da451f108352614cbc457524c5b0">ERADLIMIT</a>; <span class="comment">// floor on floor to avoid large gradients in flux that lead to crazy large values.</span></div>
<div class="line"><a name="l12873"></a><span class="lineno">12873</span>&#160;    }</div>
<div class="line"><a name="l12874"></a><span class="lineno">12874</span>&#160;    <span class="keywordflow">if</span>(YFL5&gt;=0) pin[YFL5] = uu[YFL5]/uradt; <span class="comment">// uu[YFLx]/u^t</span></div>
<div class="line"><a name="l12875"></a><span class="lineno">12875</span>&#160;  }</div>
<div class="line"><a name="l12876"></a><span class="lineno">12876</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l12877"></a><span class="lineno">12877</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l12878"></a><span class="lineno">12878</span>&#160;  <span class="comment">//  DLOOPA(jj){</span></div>
<div class="line"><a name="l12879"></a><span class="lineno">12879</span>&#160;  <span class="comment">//    if(!isfinite(pin[PRAD0+jj])){</span></div>
<div class="line"><a name="l12880"></a><span class="lineno">12880</span>&#160;  <span class="comment">//      dualfprintf(fail_file,&quot;caughtnan: jj=%d : ijk=%d %d %d\n&quot;,jj,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k);</span></div>
<div class="line"><a name="l12881"></a><span class="lineno">12881</span>&#160;  <span class="comment">//    }</span></div>
<div class="line"><a name="l12882"></a><span class="lineno">12882</span>&#160;  <span class="comment">//  }</span></div>
<div class="line"><a name="l12883"></a><span class="lineno">12883</span>&#160;</div>
<div class="line"><a name="l12884"></a><span class="lineno">12884</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a69aeed93a5b7bf3c0669b44f07148e92" title="whether to fixup inversion failures using harm fixups can lead to issues because diffuses, so across sharp boundary radiation can be given quite &quot;wrong&quot; values that don&#39;t match what solution &quot;wants&quot;">DORADFIXUPS</a>==1 || allowlocalfailurefixandnoreport==0){</div>
<div class="line"><a name="l12885"></a><span class="lineno">12885</span>&#160;    <span class="comment">// KORALTODO: Problem is fixups can average across shock or place where (e.g.) velocity changes alot, and averaging diffuses shock and can leak-out more failures.</span></div>
<div class="line"><a name="l12886"></a><span class="lineno">12886</span>&#160;  }</div>
<div class="line"><a name="l12887"></a><span class="lineno">12887</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l12888"></a><span class="lineno">12888</span>&#160;    <span class="comment">// CASE reductions (so set as no failure so fixups don&#39;t operate -- but might also want to turn off CHECKINVERSIONRAD else that routine won&#39;t know when to ignore bad U-&gt;P-&gt;U cases.)</span></div>
<div class="line"><a name="l12889"></a><span class="lineno">12889</span>&#160;    <span class="keywordflow">if</span>(*lpflagrad==0) *lpflagrad=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6435e9609d622c9dbaf78c12658ecf8e">UTOPRIMRADNOFAIL</a>;</div>
<div class="line"><a name="l12890"></a><span class="lineno">12890</span>&#160;    <span class="keywordflow">else</span> *lpflagrad=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ac2e41dde6ad6ac3afe36f33ff2e1a720">UTOPRIMRADFAILFIXEDUTOPRIMRAD</a>; <span class="comment">//UTOPRIMRADNOFAIL;</span></div>
<div class="line"><a name="l12891"></a><span class="lineno">12891</span>&#160;  }</div>
<div class="line"><a name="l12892"></a><span class="lineno">12892</span>&#160;</div>
<div class="line"><a name="l12893"></a><span class="lineno">12893</span>&#160;  <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l12894"></a><span class="lineno">12894</span>&#160;}</div>
<div class="line"><a name="l12895"></a><span class="lineno">12895</span>&#160;</div>
<div class="line"><a name="l12896"></a><span class="lineno">12896</span>&#160;</div>
<div class="line"><a name="l12897"></a><span class="lineno">12897</span>&#160;</div>
<div class="line"><a name="l12898"></a><span class="lineno">12898</span>&#160;</div>
<div class="line"><a name="l12899"></a><span class="lineno">12899</span>&#160;</div>
<div class="line"><a name="l12901"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a4c389f16ba2ced5143cb408ea6a39459">12901</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a4c389f16ba2ced5143cb408ea6a39459" title="interpolate between optically thick and thin limits when no u2p_rad() inversion solution">opacity_interpolated_urfconrel</a>(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> tautotmax, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pp,<span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom,<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Avcon, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Erf,<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammarel2,  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Erfnew, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *urfconrel)</div>
<div class="line"><a name="l12902"></a><span class="lineno">12902</span>&#160;{</div>
<div class="line"><a name="l12903"></a><span class="lineno">12903</span>&#160;  <span class="keywordtype">int</span> jj;</div>
<div class="line"><a name="l12904"></a><span class="lineno">12904</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> alpha=ptrgeom-&gt;alphalapse; <span class="comment">//sqrt(-1./ptrgeom-&gt;gcon[GIND(0,0)]);</span></div>
<div class="line"><a name="l12905"></a><span class="lineno">12905</span>&#160;</div>
<div class="line"><a name="l12906"></a><span class="lineno">12906</span>&#160;  <span class="comment">//  dualfprintf(fail_file,&quot;Erf=%g gammarel2=%g\n&quot;,Erf,gammarel2);</span></div>
<div class="line"><a name="l12907"></a><span class="lineno">12907</span>&#160;</div>
<div class="line"><a name="l12908"></a><span class="lineno">12908</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammafluid,gammarel2fluid,qsqfluid,Erffluid;</div>
<div class="line"><a name="l12909"></a><span class="lineno">12909</span>&#160;  <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#abfae38e47b0bd05a4fc38302ff948a96" title="find gamma-factor wrt normal observer This function and qsq_calc() have about the same cache miss amo...">gamma_calc_fromuconrel</a>(&amp;pp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>-1],ptrgeom,&amp;gammafluid,&amp;qsqfluid);</div>
<div class="line"><a name="l12910"></a><span class="lineno">12910</span>&#160;  gammarel2fluid=gammafluid*gammafluid;</div>
<div class="line"><a name="l12911"></a><span class="lineno">12911</span>&#160;  <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a4f76ac5680b95db932b2cf3ee309fb07" title="get Erf">get_m1closure_Erf</a>(ptrgeom, Avcon, gammarel2fluid, &amp;Erffluid);</div>
<div class="line"><a name="l12912"></a><span class="lineno">12912</span>&#160;  <span class="keywordflow">if</span>(Erffluid&lt;<a class="code" href="../../d8/d5b/defs_8general_8h.html#a5bd9da451f108352614cbc457524c5b0">ERADLIMIT</a>) Erffluid=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a5bd9da451f108352614cbc457524c5b0">ERADLIMIT</a>;</div>
<div class="line"><a name="l12913"></a><span class="lineno">12913</span>&#160;</div>
<div class="line"><a name="l12914"></a><span class="lineno">12914</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammarad,gammarel2rad,qsqrad,Erfrad;</div>
<div class="line"><a name="l12915"></a><span class="lineno">12915</span>&#160;  <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#abfae38e47b0bd05a4fc38302ff948a96" title="find gamma-factor wrt normal observer This function and qsq_calc() have about the same cache miss amo...">gamma_calc_fromuconrel</a>(&amp;pp[URAD1-1],ptrgeom,&amp;gammarad,&amp;qsqrad);</div>
<div class="line"><a name="l12916"></a><span class="lineno">12916</span>&#160;  gammarel2rad=gammarad*gammarad;</div>
<div class="line"><a name="l12917"></a><span class="lineno">12917</span>&#160;  <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a4f76ac5680b95db932b2cf3ee309fb07" title="get Erf">get_m1closure_Erf</a>(ptrgeom, Avcon, gammarel2rad, &amp;Erfrad);</div>
<div class="line"><a name="l12918"></a><span class="lineno">12918</span>&#160;  <span class="keywordflow">if</span>(Erfrad&lt;<a class="code" href="../../d8/d5b/defs_8general_8h.html#a5bd9da451f108352614cbc457524c5b0">ERADLIMIT</a>) Erfrad=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a5bd9da451f108352614cbc457524c5b0">ERADLIMIT</a>;</div>
<div class="line"><a name="l12919"></a><span class="lineno">12919</span>&#160;</div>
<div class="line"><a name="l12920"></a><span class="lineno">12920</span>&#160;  <span class="comment">// now set urfconrel.  Choose fluid if tautotmax&gt;=2/3 (updated fluid value), while choose previous radiation value (i.e. static!)</span></div>
<div class="line"><a name="l12921"></a><span class="lineno">12921</span>&#160;  <span class="comment">// limit for interpolation below</span></div>
<div class="line"><a name="l12922"></a><span class="lineno">12922</span>&#160;  <span class="comment">// below makes no sense because even for tau&lt;&lt;1 Erf and uradcon^i can be very different, so can end-up using too much of fluid version</span></div>
<div class="line"><a name="l12923"></a><span class="lineno">12923</span>&#160;  <span class="comment">//  FTYPE tautotmaxlim=MIN(fabs(tautotmax),1.0);</span></div>
<div class="line"><a name="l12924"></a><span class="lineno">12924</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> tautotmaxlim=(1.0 - 1.0/(1.0+fabs(tautotmax)));</div>
<div class="line"><a name="l12925"></a><span class="lineno">12925</span>&#160;  <span class="comment">// done with Erf, so get Erfnew (Erf and *Erfnew might be same variable, but Erf passed by value so changing *Erfnew won&#39;t change Erf anyways)</span></div>
<div class="line"><a name="l12926"></a><span class="lineno">12926</span>&#160;  *Erfnew = (1.0-tautotmaxlim)*Erfrad + tautotmaxlim*Erffluid;</div>
<div class="line"><a name="l12927"></a><span class="lineno">12927</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) urfconrel[jj] = (1.0-tautotmaxlim)*pp[URAD1+jj-1] + tautotmaxlim*pp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>+jj-1];</div>
<div class="line"><a name="l12928"></a><span class="lineno">12928</span>&#160;</div>
<div class="line"><a name="l12929"></a><span class="lineno">12929</span>&#160;  dualfprintf(fail_file,<span class="stringliteral">&quot;i=%d tautotmax=%g tautotmaxlim=%g\n&quot;</span>,ptrgeom-&gt;i,tautotmax,tautotmaxlim);</div>
<div class="line"><a name="l12930"></a><span class="lineno">12930</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) dualfprintf(fail_file,<span class="stringliteral">&quot;jj=%d Erfrad=%g Erffluid=%g gammarad=%g gammafluid=%g Erfnew=%g urfconrel=%g\n&quot;</span>,jj,Erfrad,Erffluid,gammarad,gammafluid,*Erfnew,urfconrel[jj]);</div>
<div class="line"><a name="l12931"></a><span class="lineno">12931</span>&#160;</div>
<div class="line"><a name="l12932"></a><span class="lineno">12932</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l12933"></a><span class="lineno">12933</span>&#160;}</div>
<div class="line"><a name="l12934"></a><span class="lineno">12934</span>&#160;</div>
<div class="line"><a name="l12935"></a><span class="lineno">12935</span>&#160;</div>
<div class="line"><a name="l12936"></a><span class="lineno">12936</span>&#160;</div>
<div class="line"><a name="l12938"></a><span class="lineno">12938</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> get_m1closure_gammarel2_old(<span class="keywordtype">int</span> showmessages, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Avcon, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Avcov, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *gammarel2return, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *deltareturn, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *numeratorreturn, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *divisorreturn)</div>
<div class="line"><a name="l12939"></a><span class="lineno">12939</span>&#160;{</div>
<div class="line"><a name="l12940"></a><span class="lineno">12940</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gamma2,gammarel2,<a class="code" href="../../d9/d43/global_8variousmacros_8h.html#aa5ebb2763dd5546bc40222826cea731f">delta</a>,numerator,divisor;</div>
<div class="line"><a name="l12941"></a><span class="lineno">12941</span>&#160;</div>
<div class="line"><a name="l12942"></a><span class="lineno">12942</span>&#160;  <span class="keywordflow">if</span>(0){</div>
<div class="line"><a name="l12943"></a><span class="lineno">12943</span>&#160;    <span class="comment">// has some catastrophic cancellation issue for non-moving velocity at very low E\sim 1E-92 (as in RADPULSE test if no temperature conversion)</span></div>
<div class="line"><a name="l12944"></a><span class="lineno">12944</span>&#160;</div>
<div class="line"><a name="l12945"></a><span class="lineno">12945</span>&#160;    <span class="comment">//g_munu R^tmu R^tnu</span></div>
<div class="line"><a name="l12946"></a><span class="lineno">12946</span>&#160;    <span class="keywordtype">int</span> jj,kk;</div>
<div class="line"><a name="l12947"></a><span class="lineno">12947</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gRR=0.0;</div>
<div class="line"><a name="l12948"></a><span class="lineno">12948</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a59b7ef1517ff22fd4dfce4cf6d380c55" title="loop over all Dimensions; second rank loop">DLOOP</a>(jj,kk) gRR += ptrgeom-&gt;<a class="code" href="../../dc/dd2/newcodediff_8txt.html#a93300df7bd864b90cc8ed9f3d96515ad">gcov</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(jj,kk)]*Avcon[jj]*Avcon[kk];</div>
<div class="line"><a name="l12949"></a><span class="lineno">12949</span>&#160;</div>
<div class="line"><a name="l12950"></a><span class="lineno">12950</span>&#160;    <span class="comment">//the quadratic equation for u^t of the radiation rest frame (urf[0])</span></div>
<div class="line"><a name="l12951"></a><span class="lineno">12951</span>&#160;    <span class="comment">// Formed as solution for solving two equations (R^{t\nu} R^t_\nu(E,ut) and R^{tt}(E,ut)) for ut</span></div>
<div class="line"><a name="l12952"></a><span class="lineno">12952</span>&#160;    <span class="comment">//supposed to provide two roots for (u^t)^2 of opposite signs</span></div>
<div class="line"><a name="l12953"></a><span class="lineno">12953</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> aa,b,c;</div>
<div class="line"><a name="l12954"></a><span class="lineno">12954</span>&#160;    aa=16.*gRR;</div>
<div class="line"><a name="l12955"></a><span class="lineno">12955</span>&#160;    b=8.*(gRR*ptrgeom-&gt;<a class="code" href="../../dc/dd2/newcodediff_8txt.html#a98399a5a291e3844900ecfbacdcb2da0">gcon</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(0,0)]+Avcon[0]*Avcon[0]);</div>
<div class="line"><a name="l12956"></a><span class="lineno">12956</span>&#160;    c=ptrgeom-&gt;<a class="code" href="../../dc/dd2/newcodediff_8txt.html#a98399a5a291e3844900ecfbacdcb2da0">gcon</a>[GIND(0,0)]*(gRR*ptrgeom-&gt;<a class="code" href="../../dc/dd2/newcodediff_8txt.html#a98399a5a291e3844900ecfbacdcb2da0">gcon</a>[GIND(0,0)]-Avcon[0]*Avcon[0]);</div>
<div class="line"><a name="l12957"></a><span class="lineno">12957</span>&#160;    delta=b*b-4.*aa*c;</div>
<div class="line"><a name="l12958"></a><span class="lineno">12958</span>&#160;</div>
<div class="line"><a name="l12959"></a><span class="lineno">12959</span>&#160;    numerator=0.5*(-b-sqrt(delta));</div>
<div class="line"><a name="l12960"></a><span class="lineno">12960</span>&#160;    divisor=aa;</div>
<div class="line"><a name="l12961"></a><span class="lineno">12961</span>&#160;</div>
<div class="line"><a name="l12962"></a><span class="lineno">12962</span>&#160;    gamma2=numerator/divisor; <span class="comment">// lab-frame gamma^2</span></div>
<div class="line"><a name="l12963"></a><span class="lineno">12963</span>&#160;    <span class="comment">//if unphysical try the other root</span></div>
<div class="line"><a name="l12964"></a><span class="lineno">12964</span>&#160;    if(gamma2&lt;=0.){</div>
<div class="line"><a name="l12965"></a><span class="lineno">12965</span>&#160;      numerator=0.5*(-b+sqrt(delta));</div>
<div class="line"><a name="l12966"></a><span class="lineno">12966</span>&#160;      divisor=aa;</div>
<div class="line"><a name="l12967"></a><span class="lineno">12967</span>&#160;      gamma2=  numerator/divisor; </div>
<div class="line"><a name="l12968"></a><span class="lineno">12968</span>&#160;    }</div>
<div class="line"><a name="l12969"></a><span class="lineno">12969</span>&#160;    </div>
<div class="line"><a name="l12970"></a><span class="lineno">12970</span>&#160;    *numeratorreturn=numerator;</div>
<div class="line"><a name="l12971"></a><span class="lineno">12971</span>&#160;    *divisorreturn=divisor;</div>
<div class="line"><a name="l12972"></a><span class="lineno">12972</span>&#160;  }</div>
<div class="line"><a name="l12973"></a><span class="lineno">12973</span>&#160;  <span class="comment">//    dualfprintf(fail_file,&quot;GAMMA2CHECK: ijk=%d %d %d : %g %g : aa=%g b=%g c=%g : delta=%g gRR=%g Avcon0123=%g %g %g %g : gamma2=%g\n&quot;,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,0.5*(-b-sqrt(delta))/aa,0.5*(-b+sqrt(delta))/aa,aa,b,c,delta,gRR,Avcon[0],Avcon[1],Avcon[2],Avcon[3],gamma2);</span></div>
<div class="line"><a name="l12974"></a><span class="lineno">12974</span>&#160;</div>
<div class="line"><a name="l12975"></a><span class="lineno">12975</span>&#160;</div>
<div class="line"><a name="l12976"></a><span class="lineno">12976</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l12977"></a><span class="lineno">12977</span>&#160;    <span class="comment">// mathematica solution that avoids catastrophic cancellation when Rtt very small (otherwise above gives gamma2=1/2 oddly when gamma2=1) -- otherwise same as above</span></div>
<div class="line"><a name="l12978"></a><span class="lineno">12978</span>&#160;    <span class="comment">// well, then had problems for R~1E-14 for some reason when near BH.  Couldn&#39;t quickly figure out, so use no replacement of gv11.</span></div>
<div class="line"><a name="l12979"></a><span class="lineno">12979</span>&#160;    <span class="comment">// see u2p_inversion.nb</span></div>
<div class="line"><a name="l12980"></a><span class="lineno">12980</span>&#160;    <span class="keyword">static</span> <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gctt, gv11, gv12,  gv13,  gv14,  gv22,  gv23,  gv24,  gv33,  gv34,  gv44,  Rtt,  Rtx,  Rty,  Rtz;</div>
<div class="line"><a name="l12981"></a><span class="lineno">12981</span>&#160;    gv11=ptrgeom-&gt;gcov[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(0,0)];</div>
<div class="line"><a name="l12982"></a><span class="lineno">12982</span>&#160;    gv12=ptrgeom-&gt;gcov[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(0,1)];</div>
<div class="line"><a name="l12983"></a><span class="lineno">12983</span>&#160;    gv13=ptrgeom-&gt;gcov[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(0,2)];</div>
<div class="line"><a name="l12984"></a><span class="lineno">12984</span>&#160;    gv14=ptrgeom-&gt;gcov[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(0,3)];</div>
<div class="line"><a name="l12985"></a><span class="lineno">12985</span>&#160;    gv22=ptrgeom-&gt;gcov[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(1,1)];</div>
<div class="line"><a name="l12986"></a><span class="lineno">12986</span>&#160;    gv23=ptrgeom-&gt;gcov[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(1,2)];</div>
<div class="line"><a name="l12987"></a><span class="lineno">12987</span>&#160;    gv24=ptrgeom-&gt;gcov[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(1,3)];</div>
<div class="line"><a name="l12988"></a><span class="lineno">12988</span>&#160;    gv33=ptrgeom-&gt;gcov[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(2,2)];</div>
<div class="line"><a name="l12989"></a><span class="lineno">12989</span>&#160;    gv34=ptrgeom-&gt;gcov[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(2,3)];</div>
<div class="line"><a name="l12990"></a><span class="lineno">12990</span>&#160;    gv44=ptrgeom-&gt;gcov[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(3,3)];</div>
<div class="line"><a name="l12991"></a><span class="lineno">12991</span>&#160;    Rtt=Avcon[0];</div>
<div class="line"><a name="l12992"></a><span class="lineno">12992</span>&#160;    Rtx=Avcon[1];</div>
<div class="line"><a name="l12993"></a><span class="lineno">12993</span>&#160;    Rty=Avcon[2];</div>
<div class="line"><a name="l12994"></a><span class="lineno">12994</span>&#160;    Rtz=Avcon[3];</div>
<div class="line"><a name="l12995"></a><span class="lineno">12995</span>&#160;    gctt=ptrgeom-&gt;gcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(0,0)];</div>
<div class="line"><a name="l12996"></a><span class="lineno">12996</span>&#160;</div>
<div class="line"><a name="l12997"></a><span class="lineno">12997</span>&#160;    delta = (1. + 3.*gctt*gv11)*((Rtt)*(Rtt)) + </div>
<div class="line"><a name="l12998"></a><span class="lineno">12998</span>&#160;      6.*gctt*Rtt*(gv12*Rtx + gv13*Rty + gv14*Rtz) + </div>
<div class="line"><a name="l12999"></a><span class="lineno">12999</span>&#160;      3.*gctt*(gv22*((Rtx)*(Rtx)) + 2.*gv23*Rtx*Rty + gv33*((Rty)*(Rty)) + </div>
<div class="line"><a name="l13000"></a><span class="lineno">13000</span>&#160;               2.*gv24*Rtx*Rtz + 2.*gv34*Rty*Rtz + gv44*((Rtz)*(Rtz)));</div>
<div class="line"><a name="l13001"></a><span class="lineno">13001</span>&#160;</div>
<div class="line"><a name="l13002"></a><span class="lineno">13002</span>&#160;    divisor=(gv11*((Rtt)*(Rtt)) + 2.*gv12*Rtt*Rtx + gv22*((Rtx)*(Rtx)) + 2.*gv13*Rtt*Rty + </div>
<div class="line"><a name="l13003"></a><span class="lineno">13003</span>&#160;             2.*gv23*Rtx*Rty + gv33*((Rty)*(Rty)) + 2.*(gv14*Rtt + gv24*Rtx + gv34*Rty)*Rtz + </div>
<div class="line"><a name="l13004"></a><span class="lineno">13004</span>&#160;             gv44*((Rtz)*(Rtz)));</div>
<div class="line"><a name="l13005"></a><span class="lineno">13005</span>&#160;</div>
<div class="line"><a name="l13006"></a><span class="lineno">13006</span>&#160;    numerator=(-0.25*((1. + gctt*gv11)*((Rtt)*(Rtt)) + </div>
<div class="line"><a name="l13007"></a><span class="lineno">13007</span>&#160;                      gctt*(gv22*((Rtx)*(Rtx)) + 2.*gv23*Rtx*Rty + gv33*((Rty)*(Rty)) + </div>
<div class="line"><a name="l13008"></a><span class="lineno">13008</span>&#160;                            2.*gv24*Rtx*Rtz + 2.*gv34*Rty*Rtz + gv44*((Rtz)*(Rtz))) + </div>
<div class="line"><a name="l13009"></a><span class="lineno">13009</span>&#160;                      Rtt*(2.*gctt*(gv12*Rtx + gv13*Rty + gv14*Rtz) + </div>
<div class="line"><a name="l13010"></a><span class="lineno">13010</span>&#160;                           <a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a8666c1425b2e68a40939ca9e5fd719e5">Sqrt</a>(delta))));</div>
<div class="line"><a name="l13011"></a><span class="lineno">13011</span>&#160;</div>
<div class="line"><a name="l13012"></a><span class="lineno">13012</span>&#160;    gamma2 = numerator/divisor;</div>
<div class="line"><a name="l13013"></a><span class="lineno">13013</span>&#160;  }</div>
<div class="line"><a name="l13014"></a><span class="lineno">13014</span>&#160;</div>
<div class="line"><a name="l13015"></a><span class="lineno">13015</span>&#160;</div>
<div class="line"><a name="l13017"></a><span class="lineno">13017</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l13018"></a><span class="lineno">13018</span>&#160;  <span class="comment">//cap on u^t</span></div>
<div class="line"><a name="l13019"></a><span class="lineno">13019</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l13021"></a><span class="lineno">13021</span>&#160;<span class="comment"></span>  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> alpha=ptrgeom-&gt;alphalapse;</div>
<div class="line"><a name="l13022"></a><span class="lineno">13022</span>&#160;</div>
<div class="line"><a name="l13023"></a><span class="lineno">13023</span>&#160;</div>
<div class="line"><a name="l13024"></a><span class="lineno">13024</span>&#160;  <span class="comment">// get relative 4-velocity, that is always &gt;=1 even in GR</span></div>
<div class="line"><a name="l13025"></a><span class="lineno">13025</span>&#160;  gammarel2 = gamma2*alpha*alpha;</div>
<div class="line"><a name="l13026"></a><span class="lineno">13026</span>&#160;</div>
<div class="line"><a name="l13027"></a><span class="lineno">13027</span>&#160;  <span class="comment">// check for machine error away from 1.0 that happens sometimes</span></div>
<div class="line"><a name="l13028"></a><span class="lineno">13028</span>&#160;  <span class="keywordflow">if</span>(gammarel2&gt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ae7c14c1dcfc1528ee3bca6c96c033a7c">GAMMASMALLLIMIT</a> &amp;&amp; gammarel2&lt;1.0){</div>
<div class="line"><a name="l13029"></a><span class="lineno">13029</span>&#160;    <span class="comment">// if(debugfail&gt;=2) dualfprintf(fail_file,&quot;Hit machine error of gammarel2=%27.20g fixed to be 1.0\n&quot;,gammarel2);</span></div>
<div class="line"><a name="l13030"></a><span class="lineno">13030</span>&#160;    gammarel2=1.0;</div>
<div class="line"><a name="l13031"></a><span class="lineno">13031</span>&#160;  }</div>
<div class="line"><a name="l13032"></a><span class="lineno">13032</span>&#160;</div>
<div class="line"><a name="l13033"></a><span class="lineno">13033</span>&#160;  <span class="comment">//  dualfprintf(fail_file,&quot;gammarel2=%g gamma2=%g delta=%21.15g\n&quot;,gammarel2,gamma2,delta);</span></div>
<div class="line"><a name="l13034"></a><span class="lineno">13034</span>&#160;</div>
<div class="line"><a name="l13035"></a><span class="lineno">13035</span>&#160;  *gammarel2return=gammarel2;</div>
<div class="line"><a name="l13036"></a><span class="lineno">13036</span>&#160;  *deltareturn=<a class="code" href="../../d9/d43/global_8variousmacros_8h.html#aa5ebb2763dd5546bc40222826cea731f">delta</a>;</div>
<div class="line"><a name="l13037"></a><span class="lineno">13037</span>&#160;  *numeratorreturn=numerator;</div>
<div class="line"><a name="l13038"></a><span class="lineno">13038</span>&#160;  *divisorreturn=divisor;</div>
<div class="line"><a name="l13039"></a><span class="lineno">13039</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l13040"></a><span class="lineno">13040</span>&#160;</div>
<div class="line"><a name="l13041"></a><span class="lineno">13041</span>&#160;}</div>
<div class="line"><a name="l13042"></a><span class="lineno">13042</span>&#160;</div>
<div class="line"><a name="l13043"></a><span class="lineno">13043</span>&#160;</div>
<div class="line"><a name="l13044"></a><span class="lineno">13044</span>&#160;</div>
<div class="line"><a name="l13045"></a><span class="lineno">13045</span>&#160;</div>
<div class="line"><a name="l13046"></a><span class="lineno">13046</span>&#160;</div>
<div class="line"><a name="l13047"></a><span class="lineno">13047</span>&#160;</div>
<div class="line"><a name="l13048"></a><span class="lineno">13048</span>&#160;</div>
<div class="line"><a name="l13049"></a><span class="lineno">13049</span>&#160;</div>
<div class="line"><a name="l13050"></a><span class="lineno">13050</span>&#160;</div>
<div class="line"><a name="l13051"></a><span class="lineno">13051</span>&#160;</div>
<div class="line"><a name="l13052"></a><span class="lineno">13052</span>&#160;</div>
<div class="line"><a name="l13053"></a><span class="lineno">13053</span>&#160;</div>
<div class="line"><a name="l13055"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ac65d2f7675d8e61488e8152455f7a9df">13055</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ac65d2f7675d8e61488e8152455f7a9df" title="get&#39;s gamma^2 for lab-frame gamma using Rd and gcon">get_m1closure_gammarel2</a>(<span class="keywordtype">int</span> showmessages, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Avcon, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Avcov, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *gammarel2return, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *deltareturn, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *numeratorreturn, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *divisorreturn)</div>
<div class="line"><a name="l13056"></a><span class="lineno">13056</span>&#160;{</div>
<div class="line"><a name="l13057"></a><span class="lineno">13057</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gamma2,gammarel2,<a class="code" href="../../d9/d43/global_8variousmacros_8h.html#aa5ebb2763dd5546bc40222826cea731f">delta</a>,numerator,divisor;</div>
<div class="line"><a name="l13058"></a><span class="lineno">13058</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gamma2a,gamma2b;</div>
<div class="line"><a name="l13059"></a><span class="lineno">13059</span>&#160;</div>
<div class="line"><a name="l13060"></a><span class="lineno">13060</span>&#160;  <span class="comment">// mathematica solution that avoids catastrophic cancellation when Rtt very small (otherwise above gives gamma2=1/2 oddly when gamma2=1) -- otherwise same as above</span></div>
<div class="line"><a name="l13061"></a><span class="lineno">13061</span>&#160;  <span class="comment">// well, then had problems for R~1E-14L for some reason when near BH.  Couldn&#39;t quickly figure out, so use no replacement of gv11.</span></div>
<div class="line"><a name="l13062"></a><span class="lineno">13062</span>&#160;  <span class="comment">// see u2p_inversion.nb</span></div>
<div class="line"><a name="l13063"></a><span class="lineno">13063</span>&#160;  <span class="keyword">static</span> <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gctt, gn11, gn12,  gn13,  gn14,  gn22,  gn23,  gn24,  gn33,  gn34,  gn44,  Rtt,  Rtx,  Rty,  Rtz,  Rdtt,  Rdtx,  Rdty,  Rdtz;</div>
<div class="line"><a name="l13064"></a><span class="lineno">13064</span>&#160;  gn11=ptrgeom-&gt;gcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(0,0)];</div>
<div class="line"><a name="l13065"></a><span class="lineno">13065</span>&#160;  gn12=ptrgeom-&gt;gcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(0,1)];</div>
<div class="line"><a name="l13066"></a><span class="lineno">13066</span>&#160;  gn13=ptrgeom-&gt;gcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(0,2)];</div>
<div class="line"><a name="l13067"></a><span class="lineno">13067</span>&#160;  gn14=ptrgeom-&gt;gcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(0,3)];</div>
<div class="line"><a name="l13068"></a><span class="lineno">13068</span>&#160;  gn22=ptrgeom-&gt;gcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(1,1)];</div>
<div class="line"><a name="l13069"></a><span class="lineno">13069</span>&#160;  gn23=ptrgeom-&gt;gcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(1,2)];</div>
<div class="line"><a name="l13070"></a><span class="lineno">13070</span>&#160;  gn24=ptrgeom-&gt;gcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(1,3)];</div>
<div class="line"><a name="l13071"></a><span class="lineno">13071</span>&#160;  gn33=ptrgeom-&gt;gcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(2,2)];</div>
<div class="line"><a name="l13072"></a><span class="lineno">13072</span>&#160;  gn34=ptrgeom-&gt;gcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(2,3)];</div>
<div class="line"><a name="l13073"></a><span class="lineno">13073</span>&#160;  gn44=ptrgeom-&gt;gcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(3,3)];</div>
<div class="line"><a name="l13074"></a><span class="lineno">13074</span>&#160;</div>
<div class="line"><a name="l13075"></a><span class="lineno">13075</span>&#160;  Rtt=Avcon[0];</div>
<div class="line"><a name="l13076"></a><span class="lineno">13076</span>&#160;  Rtx=Avcon[1];</div>
<div class="line"><a name="l13077"></a><span class="lineno">13077</span>&#160;  Rty=Avcon[2];</div>
<div class="line"><a name="l13078"></a><span class="lineno">13078</span>&#160;  Rtz=Avcon[3];</div>
<div class="line"><a name="l13079"></a><span class="lineno">13079</span>&#160;</div>
<div class="line"><a name="l13080"></a><span class="lineno">13080</span>&#160;  Rdtt=Avcov[0];</div>
<div class="line"><a name="l13081"></a><span class="lineno">13081</span>&#160;  Rdtx=Avcov[1];</div>
<div class="line"><a name="l13082"></a><span class="lineno">13082</span>&#160;  Rdty=Avcov[2];</div>
<div class="line"><a name="l13083"></a><span class="lineno">13083</span>&#160;  Rdtz=Avcov[3];</div>
<div class="line"><a name="l13084"></a><span class="lineno">13084</span>&#160;</div>
<div class="line"><a name="l13085"></a><span class="lineno">13085</span>&#160;  gamma2a=(-0.25*(2.*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gn11,2)*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rdtt,2) + (gn12*Rdtx + gn13*Rdty + gn14*Rdtz)*</div>
<div class="line"><a name="l13086"></a><span class="lineno">13086</span>&#160;        (gn12*Rdtx + gn13*Rdty + gn14*Rdtz + <a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a8666c1425b2e68a40939ca9e5fd719e5">Sqrt</a>(4.*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gn11,2)*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rdtt,2) + <a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gn12*Rdtx + gn13*Rdty + gn14*Rdtz,2) + </div>
<div class="line"><a name="l13087"></a><span class="lineno">13087</span>&#160;            gn11*(8.*gn12*Rdtt*Rdtx + 3.*gn22*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rdtx,2) + 8.*gn13*Rdtt*Rdty + 6.*gn23*Rdtx*Rdty + 3.*gn33*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rdty,2) + </div>
<div class="line"><a name="l13088"></a><span class="lineno">13088</span>&#160;               8.*gn14*Rdtt*Rdtz + 6.*gn24*Rdtx*Rdtz + 6.*gn34*Rdty*Rdtz + 3.*gn44*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rdtz,2)))) + </div>
<div class="line"><a name="l13089"></a><span class="lineno">13089</span>&#160;       gn11*(4.*gn12*Rdtt*Rdtx + gn22*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rdtx,2) + 2.*gn23*Rdtx*Rdty + gn33*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rdty,2) + 2.*gn24*Rdtx*Rdtz + </div>
<div class="line"><a name="l13090"></a><span class="lineno">13090</span>&#160;          2.*gn34*Rdty*Rdtz + gn44*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rdtz,2) + Rdtt*</div>
<div class="line"><a name="l13091"></a><span class="lineno">13091</span>&#160;           (4.*gn13*Rdty + 4.*gn14*Rdtz + <a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a8666c1425b2e68a40939ca9e5fd719e5">Sqrt</a>(4.*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gn11,2)*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rdtt,2) + <a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gn12*Rdtx + gn13*Rdty + gn14*Rdtz,2) + </div>
<div class="line"><a name="l13092"></a><span class="lineno">13092</span>&#160;               gn11*(8.*gn12*Rdtt*Rdtx + 3.*gn22*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rdtx,2) + 8.*gn13*Rdtt*Rdty + 6.*gn23*Rdtx*Rdty + 3.*gn33*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rdty,2) + </div>
<div class="line"><a name="l13093"></a><span class="lineno">13093</span>&#160;                  8.*gn14*Rdtt*Rdtz + 6.*gn24*Rdtx*Rdtz + 6.*gn34*Rdty*Rdtz + 3.*gn44*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rdtz,2)))))))/</div>
<div class="line"><a name="l13094"></a><span class="lineno">13094</span>&#160;   (gn11*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rdtt,2) + 2.*gn12*Rdtt*Rdtx + gn22*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rdtx,2) + 2.*gn13*Rdtt*Rdty + 2.*gn23*Rdtx*Rdty + gn33*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rdty,2) + </div>
<div class="line"><a name="l13095"></a><span class="lineno">13095</span>&#160;    2.*(gn14*Rdtt + gn24*Rdtx + gn34*Rdty)*Rdtz + gn44*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rdtz,2));</div>
<div class="line"><a name="l13096"></a><span class="lineno">13096</span>&#160;</div>
<div class="line"><a name="l13097"></a><span class="lineno">13097</span>&#160;</div>
<div class="line"><a name="l13098"></a><span class="lineno">13098</span>&#160;  <span class="keywordflow">if</span>( gamma2a&lt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ae7c14c1dcfc1528ee3bca6c96c033a7c">GAMMASMALLLIMIT</a> || !<a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(gamma2a) ){</div>
<div class="line"><a name="l13099"></a><span class="lineno">13099</span>&#160;    gamma2b=(0.25*(-2.*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gn11,2)*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rdtt,2) - 1.*gn11*(4.*gn12*Rdtt*Rdtx + gn22*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rdtx,2) + </div>
<div class="line"><a name="l13100"></a><span class="lineno">13100</span>&#160;                                                              Rdty*(4.*gn13*Rdtt + 2.*gn23*Rdtx + gn33*Rdty) + 2.*(2.*gn14*Rdtt + gn24*Rdtx + gn34*Rdty)*Rdtz + gn44*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rdtz,2)) + </div>
<div class="line"><a name="l13101"></a><span class="lineno">13101</span>&#160;                   gn11*Rdtt*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a8666c1425b2e68a40939ca9e5fd719e5">Sqrt</a>(4.*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gn11,2)*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rdtt,2) + <a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gn12*Rdtx + gn13*Rdty + gn14*Rdtz,2) + </div>
<div class="line"><a name="l13102"></a><span class="lineno">13102</span>&#160;                                  gn11*(8.*gn12*Rdtt*Rdtx + 3.*gn22*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rdtx,2) + 8.*gn13*Rdtt*Rdty + 6.*gn23*Rdtx*Rdty + 3.*gn33*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rdty,2) + </div>
<div class="line"><a name="l13103"></a><span class="lineno">13103</span>&#160;                                        8.*gn14*Rdtt*Rdtz + 6.*gn24*Rdtx*Rdtz + 6.*gn34*Rdty*Rdtz + 3.*gn44*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rdtz,2))) + </div>
<div class="line"><a name="l13104"></a><span class="lineno">13104</span>&#160;                   (gn12*Rdtx + gn13*Rdty + gn14*Rdtz)*(-1.*gn12*Rdtx - 1.*gn13*Rdty - 1.*gn14*Rdtz + </div>
<div class="line"><a name="l13105"></a><span class="lineno">13105</span>&#160;                                                        <a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a8666c1425b2e68a40939ca9e5fd719e5">Sqrt</a>(4.*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gn11,2)*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rdtt,2) + <a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gn12*Rdtx + gn13*Rdty + gn14*Rdtz,2) + </div>
<div class="line"><a name="l13106"></a><span class="lineno">13106</span>&#160;                                                             gn11*(8.*gn12*Rdtt*Rdtx + 3.*gn22*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rdtx,2) + 8.*gn13*Rdtt*Rdty + 6.*gn23*Rdtx*Rdty + 3.*gn33*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rdty,2) + </div>
<div class="line"><a name="l13107"></a><span class="lineno">13107</span>&#160;                                                                   8.*gn14*Rdtt*Rdtz + 6.*gn24*Rdtx*Rdtz + 6.*gn34*Rdty*Rdtz + 3.*gn44*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rdtz,2))))))/</div>
<div class="line"><a name="l13108"></a><span class="lineno">13108</span>&#160;      (gn11*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rdtt,2) + 2.*gn12*Rdtt*Rdtx + gn22*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rdtx,2) + 2.*gn13*Rdtt*Rdty + 2.*gn23*Rdtx*Rdty + gn33*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rdty,2) + </div>
<div class="line"><a name="l13109"></a><span class="lineno">13109</span>&#160;       2.*(gn14*Rdtt + gn24*Rdtx + gn34*Rdty)*Rdtz + gn44*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rdtz,2));</div>
<div class="line"><a name="l13110"></a><span class="lineno">13110</span>&#160;    gamma2=gamma2b;</div>
<div class="line"><a name="l13111"></a><span class="lineno">13111</span>&#160;  }</div>
<div class="line"><a name="l13112"></a><span class="lineno">13112</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l13113"></a><span class="lineno">13113</span>&#160;    <span class="comment">// choose</span></div>
<div class="line"><a name="l13114"></a><span class="lineno">13114</span>&#160;    gamma2=gamma2a;</div>
<div class="line"><a name="l13115"></a><span class="lineno">13115</span>&#160;  }</div>
<div class="line"><a name="l13116"></a><span class="lineno">13116</span>&#160;</div>
<div class="line"><a name="l13118"></a><span class="lineno">13118</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l13119"></a><span class="lineno">13119</span>&#160;  <span class="comment">//cap on u^t</span></div>
<div class="line"><a name="l13120"></a><span class="lineno">13120</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l13122"></a><span class="lineno">13122</span>&#160;<span class="comment"></span>  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> alpha=ptrgeom-&gt;alphalapse;</div>
<div class="line"><a name="l13123"></a><span class="lineno">13123</span>&#160;</div>
<div class="line"><a name="l13124"></a><span class="lineno">13124</span>&#160;</div>
<div class="line"><a name="l13125"></a><span class="lineno">13125</span>&#160;  <span class="comment">// get relative 4-velocity, that is always &gt;=1 even in GR</span></div>
<div class="line"><a name="l13126"></a><span class="lineno">13126</span>&#160;  gammarel2 = gamma2*alpha*alpha;</div>
<div class="line"><a name="l13127"></a><span class="lineno">13127</span>&#160;</div>
<div class="line"><a name="l13128"></a><span class="lineno">13128</span>&#160;  <span class="comment">// check for machine error away from 1.0 that happens sometimes</span></div>
<div class="line"><a name="l13129"></a><span class="lineno">13129</span>&#160;  <span class="keywordflow">if</span>(gammarel2&gt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ae7c14c1dcfc1528ee3bca6c96c033a7c">GAMMASMALLLIMIT</a> &amp;&amp; gammarel2&lt;1.0){</div>
<div class="line"><a name="l13130"></a><span class="lineno">13130</span>&#160;    <span class="comment">// if(debugfail&gt;=2) dualfprintf(fail_file,&quot;Hit machine error of gammarel2=%27.20g fixed to be 1.0\n&quot;,gammarel2);</span></div>
<div class="line"><a name="l13131"></a><span class="lineno">13131</span>&#160;    gammarel2=1.0;</div>
<div class="line"><a name="l13132"></a><span class="lineno">13132</span>&#160;  }</div>
<div class="line"><a name="l13133"></a><span class="lineno">13133</span>&#160;</div>
<div class="line"><a name="l13134"></a><span class="lineno">13134</span>&#160;  <span class="comment">//  dualfprintf(fail_file,&quot;gammarel2=%g gamma2=%g delta=%21.15g\n&quot;,gammarel2,gamma2,delta);</span></div>
<div class="line"><a name="l13135"></a><span class="lineno">13135</span>&#160;</div>
<div class="line"><a name="l13136"></a><span class="lineno">13136</span>&#160;  *gammarel2return=gammarel2;</div>
<div class="line"><a name="l13137"></a><span class="lineno">13137</span>&#160;  *deltareturn=delta=0;</div>
<div class="line"><a name="l13138"></a><span class="lineno">13138</span>&#160;  *numeratorreturn=numerator=0;</div>
<div class="line"><a name="l13139"></a><span class="lineno">13139</span>&#160;  *divisorreturn=divisor=0;</div>
<div class="line"><a name="l13140"></a><span class="lineno">13140</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l13141"></a><span class="lineno">13141</span>&#160;</div>
<div class="line"><a name="l13142"></a><span class="lineno">13142</span>&#160;}</div>
<div class="line"><a name="l13143"></a><span class="lineno">13143</span>&#160;</div>
<div class="line"><a name="l13144"></a><span class="lineno">13144</span>&#160;</div>
<div class="line"><a name="l13145"></a><span class="lineno">13145</span>&#160;</div>
<div class="line"><a name="l13146"></a><span class="lineno">13146</span>&#160;</div>
<div class="line"><a name="l13147"></a><span class="lineno">13147</span>&#160;</div>
<div class="line"><a name="l13148"></a><span class="lineno">13148</span>&#160;</div>
<div class="line"><a name="l13149"></a><span class="lineno">13149</span>&#160;</div>
<div class="line"><a name="l13151"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a4f76ac5680b95db932b2cf3ee309fb07">13151</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a4f76ac5680b95db932b2cf3ee309fb07" title="get Erf">get_m1closure_Erf</a>(<span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Avcon, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammarel2, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Erfreturn)</div>
<div class="line"><a name="l13152"></a><span class="lineno">13152</span>&#160;{</div>
<div class="line"><a name="l13153"></a><span class="lineno">13153</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> alpha=ptrgeom-&gt;alphalapse;</div>
<div class="line"><a name="l13154"></a><span class="lineno">13154</span>&#160;</div>
<div class="line"><a name="l13156"></a><span class="lineno">13156</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l13157"></a><span class="lineno">13157</span>&#160;  <span class="comment">// get initial attempt for Erf</span></div>
<div class="line"><a name="l13158"></a><span class="lineno">13158</span>&#160;  <span class="comment">// If delta&lt;0, then gammarel2=nan and Erf&lt;RADLIMIT check below will fail as good.</span></div>
<div class="line"><a name="l13159"></a><span class="lineno">13159</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l13161"></a><span class="lineno">13161</span>&#160;<span class="comment"></span>  *Erfreturn = 3.*Avcon[0]*alpha*alpha/(4.*gammarel2-1.0);  <span class="comment">// JCM</span></div>
<div class="line"><a name="l13162"></a><span class="lineno">13162</span>&#160;</div>
<div class="line"><a name="l13163"></a><span class="lineno">13163</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l13164"></a><span class="lineno">13164</span>&#160;}</div>
<div class="line"><a name="l13165"></a><span class="lineno">13165</span>&#160;</div>
<div class="line"><a name="l13166"></a><span class="lineno">13166</span>&#160;</div>
<div class="line"><a name="l13167"></a><span class="lineno">13167</span>&#160;</div>
<div class="line"><a name="l13169"></a><span class="lineno">13169</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> get_m1closure_urfconrel_old(<span class="keywordtype">int</span> showmessages, <span class="keywordtype">int</span> allowlocalfailurefixandnoreport, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pp, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Avcon, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Avcov, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammarel2, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> delta, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> numerator, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> divisor, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Erfreturn, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *urfconrel, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflag, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflagrad)</div>
<div class="line"><a name="l13170"></a><span class="lineno">13170</span>&#160;{</div>
<div class="line"><a name="l13171"></a><span class="lineno">13171</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Erf=*Erfreturn; <span class="comment">// get initial Erf</span></div>
<div class="line"><a name="l13172"></a><span class="lineno">13172</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammamax=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a51ef12e4cafc4a8fe70374c37f57d565">GAMMAMAXRAD</a>;</div>
<div class="line"><a name="l13173"></a><span class="lineno">13173</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammamaxfail=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a6be2b06c26c5422c755647ef87bdb924">GAMMAMAXRADFAIL</a>;</div>
<div class="line"><a name="l13174"></a><span class="lineno">13174</span>&#160;  <span class="keywordtype">int</span> jj,kk;</div>
<div class="line"><a name="l13175"></a><span class="lineno">13175</span>&#160;</div>
<div class="line"><a name="l13176"></a><span class="lineno">13176</span>&#160;</div>
<div class="line"><a name="l13178"></a><span class="lineno">13178</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l13179"></a><span class="lineno">13179</span>&#160;  <span class="comment">// Fix-up inversion if problem with gamma (i.e. velocity) or energy density in radiation rest-frame (i.e. Erf)</span></div>
<div class="line"><a name="l13180"></a><span class="lineno">13180</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l13182"></a><span class="lineno">13182</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l13184"></a><span class="lineno">13184</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l13185"></a><span class="lineno">13185</span>&#160;  <span class="comment">// First case is if gammarel&gt;gammamax, then set gammarel=gammamax unless Erf&lt;ERADLIMIT (~0) in which case set Erf=ERADLIMIT and gammarel=1.</span></div>
<div class="line"><a name="l13186"></a><span class="lineno">13186</span>&#160;  <span class="comment">// Note, can&#39;t set urfcon[0]=gammamax in case gammamax still remains space-like, e.g. inside horizon if gammamax isn&#39;t big enough.</span></div>
<div class="line"><a name="l13187"></a><span class="lineno">13187</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l13189"></a><span class="lineno">13189</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l13190"></a><span class="lineno">13190</span>&#160;  <span class="comment">// NOTE: gammarel2 just below 1.0 already fixed to be =1.0</span></div>
<div class="line"><a name="l13191"></a><span class="lineno">13191</span>&#160;  <span class="keywordtype">int</span> nonfailure=gammarel2&gt;=1.0 &amp;&amp; Erf&gt;<a class="code" href="../../d8/d5b/defs_8general_8h.html#a5bd9da451f108352614cbc457524c5b0">ERADLIMIT</a> &amp;&amp; gammarel2&lt;=gammamax*gammamax/<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ae7c14c1dcfc1528ee3bca6c96c033a7c">GAMMASMALLLIMIT</a>/<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ae7c14c1dcfc1528ee3bca6c96c033a7c">GAMMASMALLLIMIT</a>;</div>
<div class="line"><a name="l13192"></a><span class="lineno">13192</span>&#160;  <span class="comment">// falilure1 : gammarel2 normal, but already Erf&lt;ERADLIMIT (note for M1 that gammarel2&gt;=1/4 for any reasonable chance for correct non-zero Erf</span></div>
<div class="line"><a name="l13193"></a><span class="lineno">13193</span>&#160;  <span class="keywordtype">int</span> failure1=Avcon[0]&lt;0.0 || (gammarel2&gt;0.0 &amp;&amp; gammarel2&lt;=0.25L &amp;&amp; delta&gt;=0.0 &amp;&amp; divisor!=0.0) || numerator==0.0 || gammarel2&gt;=1.0 &amp;&amp; delta&gt;=0.0 &amp;&amp; divisor!=0.0 &amp;&amp; Erf&lt;<a class="code" href="../../d8/d5b/defs_8general_8h.html#a5bd9da451f108352614cbc457524c5b0">ERADLIMIT</a>;</div>
<div class="line"><a name="l13194"></a><span class="lineno">13194</span>&#160;  <span class="comment">// gamma probably around 1</span></div>
<div class="line"><a name="l13195"></a><span class="lineno">13195</span>&#160;  <span class="keywordtype">int</span> failure2=gammarel2&lt;1.0 &amp;&amp; gammarel2&gt;0.0 &amp;&amp; delta&gt;=0.0;</div>
<div class="line"><a name="l13196"></a><span class="lineno">13196</span>&#160;  <span class="comment">// i.e. all else, so not really used below.</span></div>
<div class="line"><a name="l13197"></a><span class="lineno">13197</span>&#160;  <span class="keywordtype">int</span> failure3=gammarel2&gt;gammamax*gammamax &amp;&amp; Erf&gt;=ERADLIMIT || gammarel2&lt;0.0 || delta&lt;0.  || divisor==0.0 &amp;&amp; numerator==0.0 || divisor==0.0 &amp;&amp; numerator!=0.0;</div>
<div class="line"><a name="l13198"></a><span class="lineno">13198</span>&#160;</div>
<div class="line"><a name="l13199"></a><span class="lineno">13199</span>&#160;</div>
<div class="line"><a name="l13200"></a><span class="lineno">13200</span>&#160;</div>
<div class="line"><a name="l13201"></a><span class="lineno">13201</span>&#160;  <span class="keywordflow">if</span>(nonfailure){</div>
<div class="line"><a name="l13202"></a><span class="lineno">13202</span>&#160;    <span class="comment">// get good relative velocity</span></div>
<div class="line"><a name="l13203"></a><span class="lineno">13203</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammarel=sqrt(gammarel2);</div>
<div class="line"><a name="l13204"></a><span class="lineno">13204</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> alpha=ptrgeom-&gt;alphalapse;</div>
<div class="line"><a name="l13205"></a><span class="lineno">13205</span>&#160;</div>
<div class="line"><a name="l13206"></a><span class="lineno">13206</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) urfconrel[jj] = alpha * (Avcon[jj] + 1./3.*Erf*ptrgeom-&gt;<a class="code" href="../../dc/dd2/newcodediff_8txt.html#a98399a5a291e3844900ecfbacdcb2da0">gcon</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(0,jj)]*(4.0*gammarel2-1.0) )/(4./3.*Erf*gammarel);</div>
<div class="line"><a name="l13207"></a><span class="lineno">13207</span>&#160;</div>
<div class="line"><a name="l13208"></a><span class="lineno">13208</span>&#160;    *Erfreturn=Erf; <span class="comment">// pass back new Erf to pointer</span></div>
<div class="line"><a name="l13209"></a><span class="lineno">13209</span>&#160;    return(0);</div>
<div class="line"><a name="l13210"></a><span class="lineno">13210</span>&#160;</div>
<div class="line"><a name="l13211"></a><span class="lineno">13211</span>&#160;    <span class="comment">//        dualfprintf(fail_file,&quot;NO failure: %g %g ijk=%d %d %d\n&quot;,Erf,gammarel2,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k);</span></div>
<div class="line"><a name="l13212"></a><span class="lineno">13212</span>&#160;  }</div>
<div class="line"><a name="l13213"></a><span class="lineno">13213</span>&#160;  else if(failure1){</div>
<div class="line"><a name="l13214"></a><span class="lineno">13214</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5f25064797a21c72c367a274bd97abb1">TRYCOLD</a>){</div>
<div class="line"><a name="l13215"></a><span class="lineno">13215</span>&#160;      gammarel2=pow(1.0+10.0*<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a8913cb5d64cfec23ae1a3052930ec468">NUMEPSILON</a>,2.0);</div>
<div class="line"><a name="l13216"></a><span class="lineno">13216</span>&#160;      <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ac417e724b77704df1dc35e32071df2f2" title="get&#39;s gamma assuming fixed E rather than using original R^t_t that we assume is flawed near floor reg...">get_m1closure_gammarel2_cold</a>(showmessages,ptrgeom,Avcon,Avcov,&amp;gammarel2,&amp;delta,&amp;numerator,&amp;divisor,&amp;Erf,urfconrel);</div>
<div class="line"><a name="l13217"></a><span class="lineno">13217</span>&#160;    }</div>
<div class="line"><a name="l13218"></a><span class="lineno">13218</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l13219"></a><span class="lineno">13219</span>&#160;      <span class="comment">// Can&#39;t have Erf&lt;0.  Like floor on internal energy density.  If leave Erf&lt;0, then will drive code crazy with free energy.</span></div>
<div class="line"><a name="l13220"></a><span class="lineno">13220</span>&#160;      Erf=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a5bd9da451f108352614cbc457524c5b0">ERADLIMIT</a>;</div>
<div class="line"><a name="l13221"></a><span class="lineno">13221</span>&#160;     </div>
<div class="line"><a name="l13222"></a><span class="lineno">13222</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) urfconrel[jj] = 0.0; <span class="comment">// consistent with gammarel2=1</span></div>
<div class="line"><a name="l13223"></a><span class="lineno">13223</span>&#160;    }</div>
<div class="line"><a name="l13224"></a><span class="lineno">13224</span>&#160;    if(1 || allowlocalfailurefixandnoreport==0) *lpflagrad=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#af579ffe7cc5645924d03173aa13af579">UTOPRIMRADFAILCASE3A</a>;</div>
<div class="line"><a name="l13225"></a><span class="lineno">13225</span>&#160;    if(showmessages &amp;&amp; debugfail&gt;=2) dualfprintf(fail_file,&quot;CASE3A: normal gamma, but Erf&lt;ERADLIMIT. ijk=%d %d %d : %ld %d %g\n&quot;,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,nstep,steppart,<a class="code" href="../../d8/d5b/defs_8general_8h.html#ae1ee1e1c83c3f70e2e1afed4f4f5b41e">t</a>);</div>
<div class="line"><a name="l13226"></a><span class="lineno">13226</span>&#160;</div>
<div class="line"><a name="l13227"></a><span class="lineno">13227</span>&#160;  }    </div>
<div class="line"><a name="l13228"></a><span class="lineno">13228</span>&#160;  else if(failure2){</div>
<div class="line"><a name="l13229"></a><span class="lineno">13229</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5f25064797a21c72c367a274bd97abb1">TRYCOLD</a>){</div>
<div class="line"><a name="l13230"></a><span class="lineno">13230</span>&#160;      gammarel2=pow(1.0+10.0*<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a8913cb5d64cfec23ae1a3052930ec468">NUMEPSILON</a>,2.0);</div>
<div class="line"><a name="l13231"></a><span class="lineno">13231</span>&#160;      <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ac417e724b77704df1dc35e32071df2f2" title="get&#39;s gamma assuming fixed E rather than using original R^t_t that we assume is flawed near floor reg...">get_m1closure_gammarel2_cold</a>(showmessages,ptrgeom,Avcon,Avcov,&amp;gammarel2,&amp;delta,&amp;numerator,&amp;divisor,&amp;Erf,urfconrel);</div>
<div class="line"><a name="l13232"></a><span class="lineno">13232</span>&#160;    }</div>
<div class="line"><a name="l13233"></a><span class="lineno">13233</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l13234"></a><span class="lineno">13234</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammarel2orig=gammarel2;</div>
<div class="line"><a name="l13235"></a><span class="lineno">13235</span>&#160;      <span class="comment">// override</span></div>
<div class="line"><a name="l13236"></a><span class="lineno">13236</span>&#160;      gammarel2=1.0;</div>
<div class="line"><a name="l13237"></a><span class="lineno">13237</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammarel=1.0;  <span class="comment">// use this below</span></div>
<div class="line"><a name="l13238"></a><span class="lineno">13238</span>&#160;</div>
<div class="line"><a name="l13239"></a><span class="lineno">13239</span>&#160;      <span class="comment">// get new Erf(gammarel)</span></div>
<div class="line"><a name="l13240"></a><span class="lineno">13240</span>&#160;      <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a4f76ac5680b95db932b2cf3ee309fb07" title="get Erf">get_m1closure_Erf</a>(ptrgeom, Avcon, gammarel2, &amp;Erf);</div>
<div class="line"><a name="l13241"></a><span class="lineno">13241</span>&#160;      <span class="keywordflow">if</span>(Erf&lt;ERADLIMIT)  Erf=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a5bd9da451f108352614cbc457524c5b0">ERADLIMIT</a>;</div>
<div class="line"><a name="l13242"></a><span class="lineno">13242</span>&#160;    </div>
<div class="line"><a name="l13243"></a><span class="lineno">13243</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) urfconrel[jj] = 0.0;</div>
<div class="line"><a name="l13244"></a><span class="lineno">13244</span>&#160;</div>
<div class="line"><a name="l13245"></a><span class="lineno">13245</span>&#160;    }</div>
<div class="line"><a name="l13246"></a><span class="lineno">13246</span>&#160;    if(1 || allowlocalfailurefixandnoreport==0) *lpflagrad=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#af1ba8d5f13f64649f7f731147526401d">UTOPRIMRADFAILCASE2A</a>;</div>
<div class="line"><a name="l13247"></a><span class="lineno">13247</span>&#160;    if(showmessages &amp;&amp; debugfail&gt;=2) dualfprintf(fail_file,&quot;CASE2A: normal gamma, but Erf&lt;ERADLIMIT. ijk=%d %d %d : %ld %d %g\n&quot;,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,nstep,steppart,t);</div>
<div class="line"><a name="l13248"></a><span class="lineno">13248</span>&#160;  }</div>
<div class="line"><a name="l13249"></a><span class="lineno">13249</span>&#160;  else{</div>
<div class="line"><a name="l13250"></a><span class="lineno">13250</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5f25064797a21c72c367a274bd97abb1">TRYCOLD</a>){</div>
<div class="line"><a name="l13251"></a><span class="lineno">13251</span>&#160;      gammarel2=gammamax*gammamax;</div>
<div class="line"><a name="l13252"></a><span class="lineno">13252</span>&#160;      <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ac417e724b77704df1dc35e32071df2f2" title="get&#39;s gamma assuming fixed E rather than using original R^t_t that we assume is flawed near floor reg...">get_m1closure_gammarel2_cold</a>(showmessages,ptrgeom,Avcon,Avcov,&amp;gammarel2,&amp;delta,&amp;numerator,&amp;divisor,&amp;Erf,urfconrel);</div>
<div class="line"><a name="l13253"></a><span class="lineno">13253</span>&#160;      <span class="keywordflow">if</span>(allowlocalfailurefixandnoreport==0) *lpflagrad=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a9e4e88357dad17ae401b91f65e4fd3f9">UTOPRIMRADFAILCASE1B</a>;</div>
<div class="line"><a name="l13254"></a><span class="lineno">13254</span>&#160;      <span class="keywordflow">if</span>(showmessages &amp;&amp; debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;CASE1A: gammarel&gt;gammamax (cold): gammarel2=%g Erf=%g : i=%d j=%d k=%d : %ld %d %g\n&quot;</span>,gammarel2,Erf,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,nstep,steppart,t);</div>
<div class="line"><a name="l13255"></a><span class="lineno">13255</span>&#160;    }</div>
<div class="line"><a name="l13256"></a><span class="lineno">13256</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l13257"></a><span class="lineno">13257</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammarel2orig=gammarel2;</div>
<div class="line"><a name="l13258"></a><span class="lineno">13258</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammarel=gammamax;</div>
<div class="line"><a name="l13259"></a><span class="lineno">13259</span>&#160;      gammarel2=gammamax*gammamax;</div>
<div class="line"><a name="l13260"></a><span class="lineno">13260</span>&#160;</div>
<div class="line"><a name="l13261"></a><span class="lineno">13261</span>&#160;      <span class="comment">// get new Erf(gammarel)</span></div>
<div class="line"><a name="l13262"></a><span class="lineno">13262</span>&#160;      <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a4f76ac5680b95db932b2cf3ee309fb07" title="get Erf">get_m1closure_Erf</a>(ptrgeom, Avcon, gammarel2, &amp;Erf);</div>
<div class="line"><a name="l13263"></a><span class="lineno">13263</span>&#160;</div>
<div class="line"><a name="l13264"></a><span class="lineno">13264</span>&#160;</div>
<div class="line"><a name="l13265"></a><span class="lineno">13265</span>&#160;      <span class="comment">// Check if Erf is too small with gamma-&gt;gammamax</span></div>
<div class="line"><a name="l13266"></a><span class="lineno">13266</span>&#160;      <span class="keywordflow">if</span>(Erf&lt;ERADLIMIT){</div>
<div class="line"><a name="l13267"></a><span class="lineno">13267</span>&#160;        <span class="keywordflow">if</span>(1 || allowlocalfailurefixandnoreport==0) *lpflagrad=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aba9c5f566b4227c5e5d8faef0f62e4e6" title="locally fixed inversion problems (as possible sometimes with radiation): see phys.tools.rad.c:u2p_rad()">UTOPRIMRADFAILCASE1A</a>;</div>
<div class="line"><a name="l13268"></a><span class="lineno">13268</span>&#160;        <span class="comment">// Can&#39;t have Erf&lt;0.  Like floor on internal energy density.  If leave Erf&lt;0, then will drive code crazy with free energy.</span></div>
<div class="line"><a name="l13269"></a><span class="lineno">13269</span>&#160;        Erf=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a5bd9da451f108352614cbc457524c5b0">ERADLIMIT</a>;</div>
<div class="line"><a name="l13270"></a><span class="lineno">13270</span>&#160;</div>
<div class="line"><a name="l13271"></a><span class="lineno">13271</span>&#160;        <span class="comment">// can&#39;t use normal velocity with small Erf -- fails with inf or nan</span></div>
<div class="line"><a name="l13272"></a><span class="lineno">13272</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) urfconrel[jj] = 0.0;</div>
<div class="line"><a name="l13273"></a><span class="lineno">13273</span>&#160;</div>
<div class="line"><a name="l13274"></a><span class="lineno">13274</span>&#160;        if(showmessages &amp;&amp; debugfail&gt;=2) dualfprintf(fail_file,&quot;CASE1A: gammarel&gt;gammamax and Erf&lt;ERADLIMIT: gammarel2=%g : i=%d j=%d k=%d : %ld %d %g\n&quot;,gammarel2,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,nstep,steppart,t);</div>
<div class="line"><a name="l13275"></a><span class="lineno">13275</span>&#160;      }</div>
<div class="line"><a name="l13276"></a><span class="lineno">13276</span>&#160;      else{</div>
<div class="line"><a name="l13277"></a><span class="lineno">13277</span>&#160;        <span class="comment">// if Erf normal, assume ok to have gammamax for radiation.  This avoids fixups, which can generate more oscillations.</span></div>
<div class="line"><a name="l13278"></a><span class="lineno">13278</span>&#160;        <span class="comment">// KORALTODO: But note that then check_on_inversion() won&#39;t know that failure and will check and report issue.</span></div>
<div class="line"><a name="l13279"></a><span class="lineno">13279</span>&#160;        <span class="keywordflow">if</span>(allowlocalfailurefixandnoreport==0) *lpflagrad=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a9e4e88357dad17ae401b91f65e4fd3f9">UTOPRIMRADFAILCASE1B</a>;</div>
<div class="line"><a name="l13280"></a><span class="lineno">13280</span>&#160;        <span class="keywordflow">if</span>(showmessages &amp;&amp; debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;CASE1B: gammarel&gt;gammamax and Erf normal: gammarel2=%g : i=%d j=%d k=%d : %ld %d %g\n&quot;</span>,gammarel2,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,nstep,steppart,t);</div>
<div class="line"><a name="l13281"></a><span class="lineno">13281</span>&#160;</div>
<div class="line"><a name="l13282"></a><span class="lineno">13282</span>&#160;        <span class="comment">// regardless of Erf value, now that have some Erf, ensure gamma=gammamax</span></div>
<div class="line"><a name="l13283"></a><span class="lineno">13283</span>&#160;        <span class="comment">// lab-frame radiation relative 4-velocity</span></div>
<div class="line"><a name="l13284"></a><span class="lineno">13284</span>&#160;        <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> alpha=ptrgeom-&gt;alphalapse;</div>
<div class="line"><a name="l13285"></a><span class="lineno">13285</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) urfconrel[jj] = alpha * (Avcon[jj] + 1./3.*Erf*ptrgeom-&gt;<a class="code" href="../../dc/dd2/newcodediff_8txt.html#a98399a5a291e3844900ecfbacdcb2da0">gcon</a>[GIND(0,jj)]*(4.0*gammarel2-1.0) )/(4./3.*Erf*gammarel);</div>
<div class="line"><a name="l13286"></a><span class="lineno">13286</span>&#160;        </div>
<div class="line"><a name="l13287"></a><span class="lineno">13287</span>&#160;        <span class="comment">// compute \gammarel using this (gammatemp can be inf if Erf=ERADLIMIT, and then rescaling below will give urfconrel=0 and gammarel=1</span></div>
<div class="line"><a name="l13288"></a><span class="lineno">13288</span>&#160;        <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammatemp,qsqtemp;</div>
<div class="line"><a name="l13289"></a><span class="lineno">13289</span>&#160;        <span class="keywordtype">int</span> <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#abfae38e47b0bd05a4fc38302ff948a96" title="find gamma-factor wrt normal observer This function and qsq_calc() have about the same cache miss amo...">gamma_calc_fromuconrel</a>(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a5910aabe5e76183d341ef5b830b01bab" title="find {u}^ from u^ only fill spatial parts so can feed in 3-vector">uconrel</a>, struct <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *geom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a>*gamma, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *qsq);</div>
<div class="line"><a name="l13290"></a><span class="lineno">13290</span>&#160;        <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#abfae38e47b0bd05a4fc38302ff948a96" title="find gamma-factor wrt normal observer This function and qsq_calc() have about the same cache miss amo...">gamma_calc_fromuconrel</a>(urfconrel,ptrgeom,&amp;gammatemp,&amp;qsqtemp),&quot;<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a20be479a3f03f3de780359d6e9290fe3" title="find u^ from {u}^ fill full 4-vector OPTMARK: Before storing , this was the most expensive function o...">ucon_calc_rel4vel_fromuconrel</a>: <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#abfae38e47b0bd05a4fc38302ff948a96" title="find gamma-factor wrt normal observer This function and qsq_calc() have about the same cache miss amo...">gamma_calc_fromuconrel</a> <a class="code" href="../../d8/d5b/defs_8general_8h.html#ad4ec5aab9b62fbbe9b8fc2d8ac0a5989">failed</a>\n&quot;,&quot;phys.tools.rad.c&quot;,1);</div>
<div class="line"><a name="l13291"></a><span class="lineno">13291</span>&#160;</div>
<div class="line"><a name="l13292"></a><span class="lineno">13292</span>&#160;        if(!<a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(gammatemp)){</div>
<div class="line"><a name="l13293"></a><span class="lineno">13293</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) urfconrel[jj] =0.0;</div>
<div class="line"><a name="l13294"></a><span class="lineno">13294</span>&#160;        }</div>
<div class="line"><a name="l13295"></a><span class="lineno">13295</span>&#160;        else if(0&amp;&amp;gammatemp&lt;=gammamax){</div>
<div class="line"><a name="l13296"></a><span class="lineno">13296</span>&#160;          <span class="comment">// do nothing, don&#39;t make gamma larger just to get consistency</span></div>
<div class="line"><a name="l13297"></a><span class="lineno">13297</span>&#160;        }</div>
<div class="line"><a name="l13298"></a><span class="lineno">13298</span>&#160;        <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l13299"></a><span class="lineno">13299</span>&#160;          <span class="comment">// now rescale urfconrel[i] so will give desired \gammamax</span></div>
<div class="line"><a name="l13300"></a><span class="lineno">13300</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) urfconrel[jj] *= (gammamax/gammatemp);</div>
<div class="line"><a name="l13301"></a><span class="lineno">13301</span>&#160;        }</div>
<div class="line"><a name="l13302"></a><span class="lineno">13302</span>&#160; </div>
<div class="line"><a name="l13303"></a><span class="lineno">13303</span>&#160;<span class="preprocessor">#if(PRODUCTION==0)</span></div>
<div class="line"><a name="l13304"></a><span class="lineno">13304</span>&#160;<span class="preprocessor"></span>        <span class="comment">// check that gamma really correctly gammamax</span></div>
<div class="line"><a name="l13305"></a><span class="lineno">13305</span>&#160;        <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammatemp2,qsqtemp2;</div>
<div class="line"><a name="l13306"></a><span class="lineno">13306</span>&#160;        <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#abfae38e47b0bd05a4fc38302ff948a96" title="find gamma-factor wrt normal observer This function and qsq_calc() have about the same cache miss amo...">gamma_calc_fromuconrel</a>(urfconrel,ptrgeom,&amp;gammatemp2,&amp;qsqtemp2),<span class="stringliteral">&quot;ucon_calc_rel4vel_fromuconrel: gamma_calc_fromuconrel failed\n&quot;</span>,<span class="stringliteral">&quot;phys.tools.rad.c&quot;</span>,1);</div>
<div class="line"><a name="l13307"></a><span class="lineno">13307</span>&#160;        <span class="keywordflow">if</span>(showmessages) dualfprintf(fail_file,<span class="stringliteral">&quot;CASE1B: gammarel&gt;gammamax and Erf normal: gammarel2orig=%g gammamax=%g gammatemp=%g gammatemp2=%g ijk=%d %d %d : %ld %d %g\n&quot;</span>,gammarel2orig,gammamax,gammatemp,gammatemp2,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,nstep,steppart,t);</div>
<div class="line"><a name="l13308"></a><span class="lineno">13308</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l13309"></a><span class="lineno">13309</span>&#160;<span class="preprocessor"></span>      }</div>
<div class="line"><a name="l13310"></a><span class="lineno">13310</span>&#160;      <span class="comment">//    if(showmessages &amp;&amp; debugfail&gt;=2) DLOOPA(jj) dualfprintf(fail_file,&quot;CASE1B: urfconrel[%d]=%g uu[%d]=%g\n&quot;,jj,urfconrel[jj],jj,uu[URAD0+jj]);</span></div>
<div class="line"><a name="l13311"></a><span class="lineno">13311</span>&#160;</div>
<div class="line"><a name="l13312"></a><span class="lineno">13312</span>&#160;      <span class="comment">//    SLOOPA(jj) urfconrel[jj] = 0.0; // consistent with gammarel2=1</span></div>
<div class="line"><a name="l13313"></a><span class="lineno">13313</span>&#160;    }</div>
<div class="line"><a name="l13314"></a><span class="lineno">13314</span>&#160;  }</div>
<div class="line"><a name="l13315"></a><span class="lineno">13315</span>&#160;</div>
<div class="line"><a name="l13316"></a><span class="lineno">13316</span>&#160;</div>
<div class="line"><a name="l13317"></a><span class="lineno">13317</span>&#160;  <span class="comment">// if here, then one failure mode.  See if optically thick or thin and reduce to (e.g.) fluid frame if thick</span></div>
<div class="line"><a name="l13318"></a><span class="lineno">13318</span>&#160;</div>
<div class="line"><a name="l13319"></a><span class="lineno">13319</span>&#160;  <span class="comment">// can&#39;t use normal velocity with small Erf -- fails with inf or nan</span></div>
<div class="line"><a name="l13320"></a><span class="lineno">13320</span>&#160;  <span class="comment">// setup &quot;old&quot; pp in case used</span></div>
<div class="line"><a name="l13321"></a><span class="lineno">13321</span>&#160;  pp[PRAD0] = Erf;</div>
<div class="line"><a name="l13322"></a><span class="lineno">13322</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) pp[PRAD1+jj-1] = urfconrel[jj];</div>
<div class="line"><a name="l13323"></a><span class="lineno">13323</span>&#160;</div>
<div class="line"><a name="l13324"></a><span class="lineno">13324</span>&#160;</div>
<div class="line"><a name="l13325"></a><span class="lineno">13325</span>&#160;<span class="preprocessor">#if(0)</span></div>
<div class="line"><a name="l13326"></a><span class="lineno">13326</span>&#160;<span class="preprocessor"></span>  <span class="comment">// KORALTODO: Problems when tau&lt;&lt;1 and gamma-&gt;gammamax</span></div>
<div class="line"><a name="l13327"></a><span class="lineno">13327</span>&#160;  <span class="comment">// KORALTODO: DUH, also should only do if failure, not if no failure.</span></div>
<div class="line"><a name="l13328"></a><span class="lineno">13328</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> tautot[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>],tautotmax;</div>
<div class="line"><a name="l13329"></a><span class="lineno">13329</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a2942d768c739b8f4c99b51a814cf7818">M1REDUCE</a>==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa38f2cd6d2f5874dd2d3449d9835b9db">TOOPACITYDEPENDENTFRAME</a>){</div>
<div class="line"><a name="l13330"></a><span class="lineno">13330</span>&#160;    <span class="comment">// then will possibly need tautotmax</span></div>
<div class="line"><a name="l13331"></a><span class="lineno">13331</span>&#160;    <span class="comment">// get tautot based upon previous pp in order to determine what to do in case of failure</span></div>
<div class="line"><a name="l13332"></a><span class="lineno">13332</span>&#160;    <a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#ad6748b88a3ad397cb35b4d60c108508d">calcfull_tautot</a>(pp, ptrgeom, tautot, &amp;tautotmax);</div>
<div class="line"><a name="l13333"></a><span class="lineno">13333</span>&#160;  }</div>
<div class="line"><a name="l13334"></a><span class="lineno">13334</span>&#160;</div>
<div class="line"><a name="l13335"></a><span class="lineno">13335</span>&#160;  </div>
<div class="line"><a name="l13336"></a><span class="lineno">13336</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a2942d768c739b8f4c99b51a814cf7818">M1REDUCE</a>==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a78f7054568cf937f1331f008edcc1fe9">TOFLUIDFRAME</a> &amp;&amp; *lpflag&lt;=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#abdf9e55b7b15ec0bcd386055f1787f47">UTOPRIMNOFAIL</a>) <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) urfconrel[jj]=pp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>+jj-1];</div>
<div class="line"><a name="l13337"></a><span class="lineno">13337</span>&#160;  else if(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a2942d768c739b8f4c99b51a814cf7818">M1REDUCE</a>==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#af53a01c283ca4e72c161241264608ad4">TOZAMOFRAME</a>) <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) urfconrel[jj]=0.0;</div>
<div class="line"><a name="l13338"></a><span class="lineno">13338</span>&#160;  else if(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a2942d768c739b8f4c99b51a814cf7818">M1REDUCE</a>==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa38f2cd6d2f5874dd2d3449d9835b9db">TOOPACITYDEPENDENTFRAME</a>) <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a4c389f16ba2ced5143cb408ea6a39459" title="interpolate between optically thick and thin limits when no u2p_rad() inversion solution">opacity_interpolated_urfconrel</a>(tautotmax,pp,ptrgeom,Avcon,Erf,gammarel2,&amp;Erf,urfconrel);</div>
<div class="line"><a name="l13339"></a><span class="lineno">13339</span>&#160;<span class="preprocessor">#endif     </span></div>
<div class="line"><a name="l13340"></a><span class="lineno">13340</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l13341"></a><span class="lineno">13341</span>&#160;  *Erfreturn=Erf; <span class="comment">// pass back new Erf to pointer</span></div>
<div class="line"><a name="l13342"></a><span class="lineno">13342</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l13343"></a><span class="lineno">13343</span>&#160;}</div>
<div class="line"><a name="l13344"></a><span class="lineno">13344</span>&#160;</div>
<div class="line"><a name="l13345"></a><span class="lineno">13345</span>&#160;</div>
<div class="line"><a name="l13346"></a><span class="lineno">13346</span>&#160;</div>
<div class="line"><a name="l13347"></a><span class="lineno">13347</span>&#160;</div>
<div class="line"><a name="l13349"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a69289f92f5afd222ade67c4e9c60285a">13349</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a69289f92f5afd222ade67c4e9c60285a" title="get contravariant relative 4-velocity in lab frame">get_m1closure_urfconrel</a>(<span class="keywordtype">int</span> showmessages, <span class="keywordtype">int</span> allowlocalfailurefixandnoreport, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pp, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Avcon, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Avcov, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammarel2, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> delta, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> numerator, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> divisor, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Erfreturn, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *urfconrel, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflag, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflagrad)</div>
<div class="line"><a name="l13350"></a><span class="lineno">13350</span>&#160;{</div>
<div class="line"><a name="l13351"></a><span class="lineno">13351</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Erf=*Erfreturn; <span class="comment">// get initial Erf</span></div>
<div class="line"><a name="l13352"></a><span class="lineno">13352</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammamax=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a51ef12e4cafc4a8fe70374c37f57d565">GAMMAMAXRAD</a>;</div>
<div class="line"><a name="l13353"></a><span class="lineno">13353</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammamaxfail=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a6be2b06c26c5422c755647ef87bdb924">GAMMAMAXRADFAIL</a>;</div>
<div class="line"><a name="l13354"></a><span class="lineno">13354</span>&#160;  <span class="keywordtype">int</span> jj,kk;</div>
<div class="line"><a name="l13355"></a><span class="lineno">13355</span>&#160;</div>
<div class="line"><a name="l13356"></a><span class="lineno">13356</span>&#160;</div>
<div class="line"><a name="l13358"></a><span class="lineno">13358</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l13359"></a><span class="lineno">13359</span>&#160;  <span class="comment">// Fix-up inversion if problem with gamma (i.e. velocity) or energy density in radiation rest-frame (i.e. Erf)</span></div>
<div class="line"><a name="l13360"></a><span class="lineno">13360</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l13362"></a><span class="lineno">13362</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l13363"></a><span class="lineno">13363</span>&#160;  <span class="comment">// NOTE: gammarel2 just below 1.0 already fixed to be =1.0</span></div>
<div class="line"><a name="l13364"></a><span class="lineno">13364</span>&#160;  <span class="comment">//  int nonfailure=gammarel2&gt;=1.0 &amp;&amp; gammarel2&lt;=gammamax*gammamax/GAMMASMALLLIMIT/GAMMASMALLLIMIT;</span></div>
<div class="line"><a name="l13365"></a><span class="lineno">13365</span>&#160;  <span class="keywordtype">int</span> nonfailure=gammarel2&gt;=1.0L &amp;&amp; Erf&gt;ERADLIMIT &amp;&amp; gammarel2&lt;=gammamax*gammamax/<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ae7c14c1dcfc1528ee3bca6c96c033a7c">GAMMASMALLLIMIT</a>/<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ae7c14c1dcfc1528ee3bca6c96c033a7c">GAMMASMALLLIMIT</a>;</div>
<div class="line"><a name="l13366"></a><span class="lineno">13366</span>&#160;  <span class="comment">// falilure1 : gammarel2 normal, but already Erf&lt;ERADLIMIT (note for M1 that gammarel2&gt;=1/4 for any reasonable chance for correct non-zero Erf</span></div>
<div class="line"><a name="l13367"></a><span class="lineno">13367</span>&#160;  <span class="keywordtype">int</span> failure1=Avcon[0]&lt;0.0 || (gammarel2&gt;0.0 &amp;&amp; gammarel2&lt;=0.25L &amp;&amp; delta&gt;=0.0 &amp;&amp; divisor!=0.0) || numerator==0.0 || gammarel2&gt;=1.0 &amp;&amp; delta&gt;=0.0 &amp;&amp; divisor!=0.0 &amp;&amp; Erf&lt;<a class="code" href="../../d8/d5b/defs_8general_8h.html#a5bd9da451f108352614cbc457524c5b0">ERADLIMIT</a>;</div>
<div class="line"><a name="l13368"></a><span class="lineno">13368</span>&#160;  <span class="comment">// gamma probably around 1</span></div>
<div class="line"><a name="l13369"></a><span class="lineno">13369</span>&#160;  <span class="keywordtype">int</span> failure2=gammarel2&lt;1.0 &amp;&amp; gammarel2&gt;0.0 &amp;&amp; delta&gt;=0.0;</div>
<div class="line"><a name="l13370"></a><span class="lineno">13370</span>&#160;  <span class="comment">// i.e. all else, so not really used below.</span></div>
<div class="line"><a name="l13371"></a><span class="lineno">13371</span>&#160;  <span class="keywordtype">int</span> failure3=gammarel2&gt;gammamax*gammamax &amp;&amp; Erf&gt;=ERADLIMIT || gammarel2&lt;0.0 || delta&lt;0.  || divisor==0.0 &amp;&amp; numerator==0.0 || divisor==0.0 &amp;&amp; numerator!=0.0;</div>
<div class="line"><a name="l13372"></a><span class="lineno">13372</span>&#160;</div>
<div class="line"><a name="l13373"></a><span class="lineno">13373</span>&#160;  <span class="comment">// any failure</span></div>
<div class="line"><a name="l13374"></a><span class="lineno">13374</span>&#160;  <span class="keywordtype">int</span> failure=!nonfailure || !<a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(gammarel2) || !<a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(Erf);</div>
<div class="line"><a name="l13375"></a><span class="lineno">13375</span>&#160;</div>
<div class="line"><a name="l13376"></a><span class="lineno">13376</span>&#160;  <span class="keywordflow">if</span>(failure &amp;&amp; (failure1==0 &amp;&amp; failure2==0 &amp;&amp; failure3==0)){</div>
<div class="line"><a name="l13377"></a><span class="lineno">13377</span>&#160;    <span class="keywordflow">if</span>(debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;Undetected failure, now considered\n&quot;</span>);</div>
<div class="line"><a name="l13378"></a><span class="lineno">13378</span>&#160;  }</div>
<div class="line"><a name="l13379"></a><span class="lineno">13379</span>&#160;</div>
<div class="line"><a name="l13380"></a><span class="lineno">13380</span>&#160;</div>
<div class="line"><a name="l13381"></a><span class="lineno">13381</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Erf0=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a8913cb5d64cfec23ae1a3052930ec468">NUMEPSILON</a>*fabs(Avcon[TT])/gammamax/gammamax,ERADLIMIT);</div>
<div class="line"><a name="l13382"></a><span class="lineno">13382</span>&#160;  <span class="keywordflow">if</span>(nonfailure){</div>
<div class="line"><a name="l13383"></a><span class="lineno">13383</span>&#160;    <span class="comment">// get good relative velocity</span></div>
<div class="line"><a name="l13384"></a><span class="lineno">13384</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammarel=sqrt(gammarel2);</div>
<div class="line"><a name="l13385"></a><span class="lineno">13385</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> alpha=ptrgeom-&gt;alphalapse;</div>
<div class="line"><a name="l13386"></a><span class="lineno">13386</span>&#160;</div>
<div class="line"><a name="l13387"></a><span class="lineno">13387</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) urfconrel[jj] = alpha * (Avcon[jj] + 1./3.*Erf*ptrgeom-&gt;gcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(0,jj)]*(4.0*gammarel2-1.0) )/(4./3.*Erf*gammarel);</div>
<div class="line"><a name="l13388"></a><span class="lineno">13388</span>&#160;</div>
<div class="line"><a name="l13389"></a><span class="lineno">13389</span>&#160;<span class="preprocessor">#if(0)</span></div>
<div class="line"><a name="l13390"></a><span class="lineno">13390</span>&#160;<span class="preprocessor"></span>    <span class="comment">//    if(Erf&lt;ERADLIMIT) Erf=ERADLIMIT; // case when velocity fine and probably just Erf slightly negative</span></div>
<div class="line"><a name="l13391"></a><span class="lineno">13391</span>&#160;    <span class="comment">//    if(Erf&lt;ERADLIMIT) Erf=MAX(NUMEPSILON*fabs(Erf),ERADLIMIT); // case when velocity fine and probably just Erf slightly negative</span></div>
<div class="line"><a name="l13392"></a><span class="lineno">13392</span>&#160;    <span class="keywordflow">if</span>(Erf&lt;ERADLIMIT) Erf=Erf0; <span class="comment">// case when velocity fine and probably just Erf slightly negative</span></div>
<div class="line"><a name="l13393"></a><span class="lineno">13393</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l13394"></a><span class="lineno">13394</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l13395"></a><span class="lineno">13395</span>&#160;    *Erfreturn=Erf; <span class="comment">// pass back new Erf to pointer</span></div>
<div class="line"><a name="l13396"></a><span class="lineno">13396</span>&#160;    <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l13397"></a><span class="lineno">13397</span>&#160;</div>
<div class="line"><a name="l13398"></a><span class="lineno">13398</span>&#160;    <span class="comment">//        dualfprintf(fail_file,&quot;NO failure: %g %g ijk=%d %d %d\n&quot;,Erf,gammarel2,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k);</span></div>
<div class="line"><a name="l13399"></a><span class="lineno">13399</span>&#160;  }</div>
<div class="line"><a name="l13400"></a><span class="lineno">13400</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l13401"></a><span class="lineno">13401</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Avconorig[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>],Avcovorig[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l13402"></a><span class="lineno">13402</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj){</div>
<div class="line"><a name="l13403"></a><span class="lineno">13403</span>&#160;      Avconorig[jj]=Avcon[jj];</div>
<div class="line"><a name="l13404"></a><span class="lineno">13404</span>&#160;      Avcovorig[jj]=Avcov[jj];</div>
<div class="line"><a name="l13405"></a><span class="lineno">13405</span>&#160;    }</div>
<div class="line"><a name="l13406"></a><span class="lineno">13406</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammarel2orig;</div>
<div class="line"><a name="l13407"></a><span class="lineno">13407</span>&#160;    gammarel2orig=gammarel2;</div>
<div class="line"><a name="l13408"></a><span class="lineno">13408</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Erforig;</div>
<div class="line"><a name="l13409"></a><span class="lineno">13409</span>&#160;    Erforig=Erf;</div>
<div class="line"><a name="l13410"></a><span class="lineno">13410</span>&#160;</div>
<div class="line"><a name="l13411"></a><span class="lineno">13411</span>&#160;    <span class="comment">// get \gammarel=1 case</span></div>
<div class="line"><a name="l13412"></a><span class="lineno">13412</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammarel2slow=pow(1.0+10.0*<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a8913cb5d64cfec23ae1a3052930ec468">NUMEPSILON</a>,2.0);</div>
<div class="line"><a name="l13413"></a><span class="lineno">13413</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Avconslow[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>],Avcovslow[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>],Erfslow,urfconrelslow[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l13414"></a><span class="lineno">13414</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj){</div>
<div class="line"><a name="l13415"></a><span class="lineno">13415</span>&#160;      Avconslow[jj]=Avcon[jj];</div>
<div class="line"><a name="l13416"></a><span class="lineno">13416</span>&#160;      Avcovslow[jj]=Avcov[jj];</div>
<div class="line"><a name="l13417"></a><span class="lineno">13417</span>&#160;    }</div>
<div class="line"><a name="l13418"></a><span class="lineno">13418</span>&#160;    Erfslow=Erf;</div>
<div class="line"><a name="l13419"></a><span class="lineno">13419</span>&#160;    <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ac417e724b77704df1dc35e32071df2f2" title="get&#39;s gamma assuming fixed E rather than using original R^t_t that we assume is flawed near floor reg...">get_m1closure_gammarel2_cold</a>(showmessages,ptrgeom,Avconslow,Avcovslow,&amp;gammarel2slow,&amp;delta,&amp;numerator,&amp;divisor,&amp;Erfslow,urfconrelslow);</div>
<div class="line"><a name="l13420"></a><span class="lineno">13420</span>&#160;</div>
<div class="line"><a name="l13421"></a><span class="lineno">13421</span>&#160;    <span class="comment">// get \gammarel=gammamax case</span></div>
<div class="line"><a name="l13422"></a><span class="lineno">13422</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammarel2fast=gammamax*gammamax;</div>
<div class="line"><a name="l13423"></a><span class="lineno">13423</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Avconfast[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>],Avcovfast[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>],Erffast,urfconrelfast[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l13424"></a><span class="lineno">13424</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj){</div>
<div class="line"><a name="l13425"></a><span class="lineno">13425</span>&#160;      Avconfast[jj]=Avcon[jj];</div>
<div class="line"><a name="l13426"></a><span class="lineno">13426</span>&#160;      Avcovfast[jj]=Avcov[jj];</div>
<div class="line"><a name="l13427"></a><span class="lineno">13427</span>&#160;    }</div>
<div class="line"><a name="l13428"></a><span class="lineno">13428</span>&#160;    Erffast=Erf;</div>
<div class="line"><a name="l13429"></a><span class="lineno">13429</span>&#160;    <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ac417e724b77704df1dc35e32071df2f2" title="get&#39;s gamma assuming fixed E rather than using original R^t_t that we assume is flawed near floor reg...">get_m1closure_gammarel2_cold</a>(showmessages,ptrgeom,Avconfast,Avcovfast,&amp;gammarel2fast,&amp;delta,&amp;numerator,&amp;divisor,&amp;Erffast,urfconrelfast);</div>
<div class="line"><a name="l13430"></a><span class="lineno">13430</span>&#160;</div>
<div class="line"><a name="l13431"></a><span class="lineno">13431</span>&#160;    <span class="comment">//    dualfprintf(fail_file,&quot;JONVSOLEK: Avconorig: %g %g %g %g\n&quot;,Avcon[0],Avcon[1],Avcon[2],Avcon[3]);</span></div>
<div class="line"><a name="l13432"></a><span class="lineno">13432</span>&#160;</div>
<div class="line"><a name="l13433"></a><span class="lineno">13433</span>&#160;    <span class="keywordtype">int</span> usingfast=1;</div>
<div class="line"><a name="l13434"></a><span class="lineno">13434</span>&#160;    <span class="comment">// choose by which Avcov[0] is closest to original</span></div>
<div class="line"><a name="l13435"></a><span class="lineno">13435</span>&#160;    <span class="keywordflow">if</span>( fabs(Avconslow[0]-Avcon[0])&gt;fabs(Avconfast[0]-Avcon[0]) ){ <span class="comment">// compare Avcon that has positive sign always</span></div>
<div class="line"><a name="l13436"></a><span class="lineno">13436</span>&#160;      usingfast=1;</div>
<div class="line"><a name="l13437"></a><span class="lineno">13437</span>&#160;      Erf=Erffast;</div>
<div class="line"><a name="l13438"></a><span class="lineno">13438</span>&#160;      gammarel2=gammarel2fast;</div>
<div class="line"><a name="l13439"></a><span class="lineno">13439</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj){</div>
<div class="line"><a name="l13440"></a><span class="lineno">13440</span>&#160;        Avcon[jj]=Avconfast[jj];</div>
<div class="line"><a name="l13441"></a><span class="lineno">13441</span>&#160;        Avcov[jj]=Avcovfast[jj];</div>
<div class="line"><a name="l13442"></a><span class="lineno">13442</span>&#160;        urfconrel[jj]=urfconrelfast[jj];</div>
<div class="line"><a name="l13443"></a><span class="lineno">13443</span>&#160;      }</div>
<div class="line"><a name="l13444"></a><span class="lineno">13444</span>&#160;    }</div>
<div class="line"><a name="l13445"></a><span class="lineno">13445</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l13446"></a><span class="lineno">13446</span>&#160;      usingfast=0;</div>
<div class="line"><a name="l13447"></a><span class="lineno">13447</span>&#160;      Erf=Erfslow;</div>
<div class="line"><a name="l13448"></a><span class="lineno">13448</span>&#160;      gammarel2=gammarel2slow;</div>
<div class="line"><a name="l13449"></a><span class="lineno">13449</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj){</div>
<div class="line"><a name="l13450"></a><span class="lineno">13450</span>&#160;        Avcon[jj]=Avconslow[jj];</div>
<div class="line"><a name="l13451"></a><span class="lineno">13451</span>&#160;        Avcov[jj]=Avcovslow[jj];</div>
<div class="line"><a name="l13452"></a><span class="lineno">13452</span>&#160;        urfconrel[jj]=urfconrelslow[jj];</div>
<div class="line"><a name="l13453"></a><span class="lineno">13453</span>&#160;      }</div>
<div class="line"><a name="l13454"></a><span class="lineno">13454</span>&#160;    }</div>
<div class="line"><a name="l13455"></a><span class="lineno">13455</span>&#160;</div>
<div class="line"><a name="l13456"></a><span class="lineno">13456</span>&#160;    <span class="comment">// catch bad issue for when using fast or slow will be bad because probably momentum is bad if inverted energy</span></div>
<div class="line"><a name="l13457"></a><span class="lineno">13457</span>&#160;    <span class="keywordflow">if</span>(Avcovorig[TT]&gt;0.0){</div>
<div class="line"><a name="l13458"></a><span class="lineno">13458</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) urfconrel[jj]=0.0;</div>
<div class="line"><a name="l13459"></a><span class="lineno">13459</span>&#160;      <span class="comment">//dualfprintf(fail_file,&quot;THIS ONE1\n&quot;);</span></div>
<div class="line"><a name="l13460"></a><span class="lineno">13460</span>&#160;    }</div>
<div class="line"><a name="l13461"></a><span class="lineno">13461</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(Avcov[TT]&gt;0.0){</div>
<div class="line"><a name="l13462"></a><span class="lineno">13462</span>&#160;      <span class="comment">//      Erf=ERADLIMIT;</span></div>
<div class="line"><a name="l13463"></a><span class="lineno">13463</span>&#160;      Erf=Erf0;</div>
<div class="line"><a name="l13464"></a><span class="lineno">13464</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) urfconrel[jj]=0.0;</div>
<div class="line"><a name="l13465"></a><span class="lineno">13465</span>&#160;      <span class="comment">//dualfprintf(fail_file,&quot;THIS ONE2\n&quot;);</span></div>
<div class="line"><a name="l13466"></a><span class="lineno">13466</span>&#160;    }</div>
<div class="line"><a name="l13467"></a><span class="lineno">13467</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l13468"></a><span class="lineno">13468</span>&#160;      <span class="comment">//    Erf=ERADLIMIT;</span></div>
<div class="line"><a name="l13469"></a><span class="lineno">13469</span>&#160;      <span class="comment">//    Erf=MAX(MIN(Erf,Erforig),ERADLIMIT);</span></div>
<div class="line"><a name="l13470"></a><span class="lineno">13470</span>&#160;      <span class="keywordflow">if</span>(gammarel2orig&gt;=1.0 &amp;&amp; <a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(gammarel2orig) &amp;&amp; <a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(Erforig)){</div>
<div class="line"><a name="l13471"></a><span class="lineno">13471</span>&#160;        Erf=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(Erf,Erforig),Erf0);</div>
<div class="line"><a name="l13472"></a><span class="lineno">13472</span>&#160;        <span class="comment">//        Erf=ERADLIMIT;</span></div>
<div class="line"><a name="l13473"></a><span class="lineno">13473</span>&#160;        <span class="comment">//        dualfprintf(fail_file,&quot;THIS ONE3\n&quot;);</span></div>
<div class="line"><a name="l13474"></a><span class="lineno">13474</span>&#160;      }</div>
<div class="line"><a name="l13475"></a><span class="lineno">13475</span>&#160;<span class="preprocessor">#define AVCOVRELDIFFALLOWED 1E-2 // KORALTODO: only use new &quot;cold&quot; solution if relatively close Avcov.</span></div>
<div class="line"><a name="l13476"></a><span class="lineno">13476</span>&#160;<span class="preprocessor"></span>      <span class="keywordflow">else</span> <span class="keywordflow">if</span>(fabs(Avcovorig[TT]-Avcov[TT])/fabs(fabs(Avcovorig[TT])+fabs(Avcov[TT]))&lt;<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a753947d37331644efcd713d11f849366">AVCOVRELDIFFALLOWED</a> ){</div>
<div class="line"><a name="l13477"></a><span class="lineno">13477</span>&#160;        <span class="comment">//dualfprintf(fail_file,&quot;THIS ONE4\n&quot;);</span></div>
<div class="line"><a name="l13478"></a><span class="lineno">13478</span>&#160;        Erf=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(Erf,Erf*(-Avcovorig[TT])/(ERADLIMIT+fabs(-Avcov[TT]))),Erf0);</div>
<div class="line"><a name="l13479"></a><span class="lineno">13479</span>&#160;        Erf=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(Erf,Erf*(-Avcov[TT])/(ERADLIMIT+fabs(-Avcovorig[TT]))),Erf0);</div>
<div class="line"><a name="l13480"></a><span class="lineno">13480</span>&#160;        <span class="comment">//dualfprintf(fail_file,&quot;nstep=%ld steppart=%d ijk=%d %d %d : Erforig=%g Erf=%g urfconrel=%g %g %g : Avcovorig=%g Avcov=%g\n&quot;,nstep,steppart,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,Erforig,Erf,urfconrel[1],urfconrel[2],urfconrel[3],Avcovorig[0],Avcov[0]);</span></div>
<div class="line"><a name="l13481"></a><span class="lineno">13481</span>&#160;        <span class="comment">//        Erf=6E-15;</span></div>
<div class="line"><a name="l13482"></a><span class="lineno">13482</span>&#160;      }</div>
<div class="line"><a name="l13483"></a><span class="lineno">13483</span>&#160;      <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l13484"></a><span class="lineno">13484</span>&#160;        <span class="comment">//dualfprintf(fail_file,&quot;THIS ONE5\n&quot;);</span></div>
<div class="line"><a name="l13485"></a><span class="lineno">13485</span>&#160;        Erf=Erf0;</div>
<div class="line"><a name="l13486"></a><span class="lineno">13486</span>&#160;      }</div>
<div class="line"><a name="l13487"></a><span class="lineno">13487</span>&#160;<span class="preprocessor">#if(0)</span></div>
<div class="line"><a name="l13488"></a><span class="lineno">13488</span>&#160;<span class="preprocessor"></span>      <span class="comment">// for RADBEAM2DKSVERT, very tricky and very sensitive (i.e. whether really fails) at coordinate singularity.</span></div>
<div class="line"><a name="l13489"></a><span class="lineno">13489</span>&#160;      <span class="comment">//      if(gammarel2orig&lt;1.0){</span></div>
<div class="line"><a name="l13490"></a><span class="lineno">13490</span>&#160;      <span class="comment">//      if(gammarel2orig&lt;0.5){</span></div>
<div class="line"><a name="l13491"></a><span class="lineno">13491</span>&#160;      <span class="keywordflow">if</span>(gammarel2orig&lt;=0.0){</div>
<div class="line"><a name="l13492"></a><span class="lineno">13492</span>&#160;        dualfprintf(fail_file,<span class="stringliteral">&quot;THIS ONE6\n&quot;</span>);</div>
<div class="line"><a name="l13493"></a><span class="lineno">13493</span>&#160;        Erf=Erf0;</div>
<div class="line"><a name="l13494"></a><span class="lineno">13494</span>&#160;        <span class="comment">//        Erf=ERADLIMIT;</span></div>
<div class="line"><a name="l13495"></a><span class="lineno">13495</span>&#160;      }</div>
<div class="line"><a name="l13496"></a><span class="lineno">13496</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l13497"></a><span class="lineno">13497</span>&#160;<span class="preprocessor"></span>    }</div>
<div class="line"><a name="l13498"></a><span class="lineno">13498</span>&#160;    </div>
<div class="line"><a name="l13499"></a><span class="lineno">13499</span>&#160;    <span class="comment">//    dualfprintf(fail_file,&quot;JONVSOLEK: usingfast=%d Avconfast: %g %g %g %g : Avconslow: %g %g %g %g : Erffast=%g Erfslow=%g urfconfast=%g %g %g urfconslow=%g %g %g\n&quot;,usingfast,Avconfast[0],Avconfast[1],Avconfast[2],Avconfast[3],Avconslow[0],Avconslow[1],Avconslow[2],Avconslow[3],Erffast,Erfslow,urfconrelfast[1],urfconrelfast[2],urfconrelfast[3],urfconrelslow[1],urfconrelslow[2],urfconrelslow[3]);</span></div>
<div class="line"><a name="l13500"></a><span class="lineno">13500</span>&#160;    </div>
<div class="line"><a name="l13501"></a><span class="lineno">13501</span>&#160;</div>
<div class="line"><a name="l13502"></a><span class="lineno">13502</span>&#160;    <span class="comment">// report</span></div>
<div class="line"><a name="l13503"></a><span class="lineno">13503</span>&#160;    <span class="keywordflow">if</span>(1||allowlocalfailurefixandnoreport==0) *lpflagrad=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aba9c5f566b4227c5e5d8faef0f62e4e6" title="locally fixed inversion problems (as possible sometimes with radiation): see phys.tools.rad.c:u2p_rad()">UTOPRIMRADFAILCASE1A</a>;</div>
<div class="line"><a name="l13504"></a><span class="lineno">13504</span>&#160;    <span class="keywordflow">if</span>(showmessages &amp;&amp; debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;CASEGEN: gammarel&gt;gammamax (cold, usingfast=%d): gammarel2=%g Erf=%g : i=%d j=%d k=%d : %ld %d %g\n&quot;</span>,usingfast,gammarel2,Erf,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,nstep,steppart,t);</div>
<div class="line"><a name="l13505"></a><span class="lineno">13505</span>&#160;  }</div>
<div class="line"><a name="l13506"></a><span class="lineno">13506</span>&#160;</div>
<div class="line"><a name="l13507"></a><span class="lineno">13507</span>&#160;</div>
<div class="line"><a name="l13508"></a><span class="lineno">13508</span>&#160;  <span class="comment">// if here, then one failure mode.  See if optically thick or thin and reduce to (e.g.) fluid frame if thick</span></div>
<div class="line"><a name="l13509"></a><span class="lineno">13509</span>&#160;</div>
<div class="line"><a name="l13510"></a><span class="lineno">13510</span>&#160;  <span class="comment">// can&#39;t use normal velocity with small Erf -- fails with inf or nan</span></div>
<div class="line"><a name="l13511"></a><span class="lineno">13511</span>&#160;  <span class="comment">// setup &quot;old&quot; pp in case used</span></div>
<div class="line"><a name="l13512"></a><span class="lineno">13512</span>&#160;  pp[PRAD0] = Erf;</div>
<div class="line"><a name="l13513"></a><span class="lineno">13513</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) pp[PRAD1+jj-1] = urfconrel[jj];</div>
<div class="line"><a name="l13514"></a><span class="lineno">13514</span>&#160;</div>
<div class="line"><a name="l13515"></a><span class="lineno">13515</span>&#160;</div>
<div class="line"><a name="l13516"></a><span class="lineno">13516</span>&#160;<span class="preprocessor">#if(0)</span></div>
<div class="line"><a name="l13517"></a><span class="lineno">13517</span>&#160;<span class="preprocessor"></span>  <span class="comment">// normally don&#39;t ever do this unless really debugging inversion.</span></div>
<div class="line"><a name="l13518"></a><span class="lineno">13518</span>&#160;  <span class="comment">//  if((ptrgeom-&gt;j==14 || ptrgeom-&gt;j==13 || ptrgeom-&gt;j==15) &amp;&amp;nstep&gt;=195){// || *lpflagrad!=0 &amp;&amp; debugfail&gt;=2){</span></div>
<div class="line"><a name="l13519"></a><span class="lineno">13519</span>&#160;  <span class="keywordflow">if</span>(nstep&gt;=223){</div>
<div class="line"><a name="l13520"></a><span class="lineno">13520</span>&#160;  <span class="comment">//  if(0&amp;&amp;nstep&gt;=223){// || *lpflagrad!=0 &amp;&amp; debugfail&gt;=2){</span></div>
<div class="line"><a name="l13521"></a><span class="lineno">13521</span>&#160;    <span class="comment">// first report info so can check on inversion</span></div>
<div class="line"><a name="l13522"></a><span class="lineno">13522</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> failnum=0;</div>
<div class="line"><a name="l13523"></a><span class="lineno">13523</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fakedt=0.0; <span class="comment">// since no 4-force</span></div>
<div class="line"><a name="l13524"></a><span class="lineno">13524</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fakeCUf[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab17e7e66eb2bc86b9d61d6bb61a0a4a3" title="NUMDTCUFS also includes what&#39;s necessary for IMEX.">NUMDTCUFS</a>]={0}; <span class="comment">// fake</span></div>
<div class="line"><a name="l13525"></a><span class="lineno">13525</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fakeCUimp[1]={0}; <span class="comment">// fake</span></div>
<div class="line"><a name="l13526"></a><span class="lineno">13526</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dUother[NPR]={0};<span class="comment">// fake</span></div>
<div class="line"><a name="l13527"></a><span class="lineno">13527</span>&#160;    <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *qptr=NULL; <span class="comment">// fake</span></div>
<div class="line"><a name="l13528"></a><span class="lineno">13528</span>&#160;    failnum++;</div>
<div class="line"><a name="l13529"></a><span class="lineno">13529</span>&#160;    globalpin[ENTROPY]=0.0;</div>
<div class="line"><a name="l13530"></a><span class="lineno">13530</span>&#160;    globaluu[ENTROPY]=0.0;</div>
<div class="line"><a name="l13531"></a><span class="lineno">13531</span>&#160;    pp[ENTROPY]=0.0;</div>
<div class="line"><a name="l13532"></a><span class="lineno">13532</span>&#160;</div>
<div class="line"><a name="l13533"></a><span class="lineno">13533</span>&#160;    globalpin[PRAD0] = Erf;</div>
<div class="line"><a name="l13534"></a><span class="lineno">13534</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) globalpin[PRAD1+jj-1] = urfconrel[jj];</div>
<div class="line"><a name="l13535"></a><span class="lineno">13535</span>&#160;</div>
<div class="line"><a name="l13536"></a><span class="lineno">13536</span>&#160;    <span class="comment">// ppfirst is faked as pp</span></div>
<div class="line"><a name="l13537"></a><span class="lineno">13537</span>&#160;    mathematica_report_check(0, 3, failnum, *lpflagrad, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>, -1, -1, fakedt, ptrgeom, pp, pp, pp, globalpin, globalpin, globalpin, globaluu, globaluu, globaluu, globaluu, fakeCUf, fakeCUimp, qptr, dUother);</div>
<div class="line"><a name="l13538"></a><span class="lineno">13538</span>&#160;  }</div>
<div class="line"><a name="l13539"></a><span class="lineno">13539</span>&#160;  <span class="comment">//  if(nstep==224) exit(0);</span></div>
<div class="line"><a name="l13540"></a><span class="lineno">13540</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l13541"></a><span class="lineno">13541</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l13542"></a><span class="lineno">13542</span>&#160;<span class="preprocessor">#if(0)</span></div>
<div class="line"><a name="l13543"></a><span class="lineno">13543</span>&#160;<span class="preprocessor"></span>  <span class="comment">// KORALTODO: Problems when tau&lt;&lt;1 and gamma-&gt;gammamax</span></div>
<div class="line"><a name="l13544"></a><span class="lineno">13544</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> tautot[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>],tautotmax;</div>
<div class="line"><a name="l13545"></a><span class="lineno">13545</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a2942d768c739b8f4c99b51a814cf7818">M1REDUCE</a>==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa38f2cd6d2f5874dd2d3449d9835b9db">TOOPACITYDEPENDENTFRAME</a>){</div>
<div class="line"><a name="l13546"></a><span class="lineno">13546</span>&#160;    <span class="comment">// then will possibly need tautotmax</span></div>
<div class="line"><a name="l13547"></a><span class="lineno">13547</span>&#160;    <span class="comment">// get tautot based upon previous pp in order to determine what to do in case of failure</span></div>
<div class="line"><a name="l13548"></a><span class="lineno">13548</span>&#160;    <a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#ad6748b88a3ad397cb35b4d60c108508d">calcfull_tautot</a>(pp, ptrgeom, tautot, &amp;tautotmax);</div>
<div class="line"><a name="l13549"></a><span class="lineno">13549</span>&#160;  }</div>
<div class="line"><a name="l13550"></a><span class="lineno">13550</span>&#160;</div>
<div class="line"><a name="l13551"></a><span class="lineno">13551</span>&#160;  </div>
<div class="line"><a name="l13552"></a><span class="lineno">13552</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a2942d768c739b8f4c99b51a814cf7818">M1REDUCE</a>==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a78f7054568cf937f1331f008edcc1fe9">TOFLUIDFRAME</a> &amp;&amp; *lpflag&lt;=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#abdf9e55b7b15ec0bcd386055f1787f47">UTOPRIMNOFAIL</a>) <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) urfconrel[jj]=pp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>+jj-1];</div>
<div class="line"><a name="l13553"></a><span class="lineno">13553</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a2942d768c739b8f4c99b51a814cf7818">M1REDUCE</a>==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#af53a01c283ca4e72c161241264608ad4">TOZAMOFRAME</a>) <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) urfconrel[jj]=0.0;</div>
<div class="line"><a name="l13554"></a><span class="lineno">13554</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a2942d768c739b8f4c99b51a814cf7818">M1REDUCE</a>==<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa38f2cd6d2f5874dd2d3449d9835b9db">TOOPACITYDEPENDENTFRAME</a>) <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a4c389f16ba2ced5143cb408ea6a39459" title="interpolate between optically thick and thin limits when no u2p_rad() inversion solution">opacity_interpolated_urfconrel</a>(tautotmax,pp,ptrgeom,Avcon,Erf,gammarel2,&amp;Erf,urfconrel);</div>
<div class="line"><a name="l13555"></a><span class="lineno">13555</span>&#160;<span class="preprocessor">#endif     </span></div>
<div class="line"><a name="l13556"></a><span class="lineno">13556</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l13557"></a><span class="lineno">13557</span>&#160;  *Erfreturn=Erf; <span class="comment">// pass back new Erf to pointer</span></div>
<div class="line"><a name="l13558"></a><span class="lineno">13558</span>&#160;</div>
<div class="line"><a name="l13559"></a><span class="lineno">13559</span>&#160;</div>
<div class="line"><a name="l13560"></a><span class="lineno">13560</span>&#160;  <span class="comment">// catch any nan/inf&#39;s:</span></div>
<div class="line"><a name="l13561"></a><span class="lineno">13561</span>&#160;  <span class="keywordtype">int</span> notfinite=(!<a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(Erf) || !<a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(urfconrel[1])|| !<a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(urfconrel[2])|| !<a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(urfconrel[3]));</div>
<div class="line"><a name="l13562"></a><span class="lineno">13562</span>&#160;  <span class="keywordflow">if</span>(notfinite){</div>
<div class="line"><a name="l13563"></a><span class="lineno">13563</span>&#160;    <span class="comment">// nothing else to do unless want to use nan/inf as indicator that should abort something</span></div>
<div class="line"><a name="l13564"></a><span class="lineno">13564</span>&#160;    <span class="comment">// using such a small Erf can lead itself to problems due to precision issues, so assume will fixup this</span></div>
<div class="line"><a name="l13565"></a><span class="lineno">13565</span>&#160;    Erf=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a5bd9da451f108352614cbc457524c5b0">ERADLIMIT</a>;</div>
<div class="line"><a name="l13566"></a><span class="lineno">13566</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) urfconrel[jj]=0.0; <span class="comment">// ZAMO</span></div>
<div class="line"><a name="l13567"></a><span class="lineno">13567</span>&#160;    <span class="keywordflow">if</span>(1||allowlocalfailurefixandnoreport==0) *lpflagrad=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a9e4e88357dad17ae401b91f65e4fd3f9">UTOPRIMRADFAILCASE1B</a>;</div>
<div class="line"><a name="l13568"></a><span class="lineno">13568</span>&#160;  }</div>
<div class="line"><a name="l13569"></a><span class="lineno">13569</span>&#160;</div>
<div class="line"><a name="l13570"></a><span class="lineno">13570</span>&#160;</div>
<div class="line"><a name="l13571"></a><span class="lineno">13571</span>&#160;</div>
<div class="line"><a name="l13572"></a><span class="lineno">13572</span>&#160;  <span class="comment">// DEBUG:</span></div>
<div class="line"><a name="l13573"></a><span class="lineno">13573</span>&#160;  <span class="keywordflow">if</span>(debugfail&gt;=2){</div>
<div class="line"><a name="l13574"></a><span class="lineno">13574</span>&#160;    <span class="keywordflow">if</span>(notfinite){</div>
<div class="line"><a name="l13575"></a><span class="lineno">13575</span>&#160;      dualfprintf(fail_file,<span class="stringliteral">&quot;JONNAN: ijk=%d %d %d :  %g %g : %g %g %g : %d %d %d %d : %g %g %g %g\n&quot;</span>,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,Erf,gammarel2,urfconrel[1],urfconrel[2],urfconrel[3],failure1,failure2,failure3,failure,Avcon[0],Avcon[1],Avcon[2],Avcon[3]);</div>
<div class="line"><a name="l13576"></a><span class="lineno">13576</span>&#160;    }</div>
<div class="line"><a name="l13577"></a><span class="lineno">13577</span>&#160;  }</div>
<div class="line"><a name="l13578"></a><span class="lineno">13578</span>&#160;</div>
<div class="line"><a name="l13579"></a><span class="lineno">13579</span>&#160;</div>
<div class="line"><a name="l13580"></a><span class="lineno">13580</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l13581"></a><span class="lineno">13581</span>&#160;}</div>
<div class="line"><a name="l13582"></a><span class="lineno">13582</span>&#160;</div>
<div class="line"><a name="l13583"></a><span class="lineno">13583</span>&#160;</div>
<div class="line"><a name="l13584"></a><span class="lineno">13584</span>&#160;</div>
<div class="line"><a name="l13585"></a><span class="lineno">13585</span>&#160;</div>
<div class="line"><a name="l13587"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a56eedd5db3838b564acfd63644b07c2a">13587</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a56eedd5db3838b564acfd63644b07c2a" title="get contravariant relative 4-velocity in lab frame using Olek&#39;s koral choices">get_m1closure_urfconrel_olek</a>(<span class="keywordtype">int</span> showmessages, <span class="keywordtype">int</span> allowlocalfailurefixandnoreport, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pp, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Avcon, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Avcov, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammarel2, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> delta, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Erfreturn, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *urfconrel, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflag, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflagrad)</div>
<div class="line"><a name="l13588"></a><span class="lineno">13588</span>&#160;{</div>
<div class="line"><a name="l13589"></a><span class="lineno">13589</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Erf=*Erfreturn; <span class="comment">// get initial Erf</span></div>
<div class="line"><a name="l13590"></a><span class="lineno">13590</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammamax=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a51ef12e4cafc4a8fe70374c37f57d565">GAMMAMAXRAD</a>;</div>
<div class="line"><a name="l13591"></a><span class="lineno">13591</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammamaxfail=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a6be2b06c26c5422c755647ef87bdb924">GAMMAMAXRADFAIL</a>;</div>
<div class="line"><a name="l13592"></a><span class="lineno">13592</span>&#160;  <span class="keywordtype">int</span> jj,kk;</div>
<div class="line"><a name="l13593"></a><span class="lineno">13593</span>&#160;</div>
<div class="line"><a name="l13594"></a><span class="lineno">13594</span>&#160;</div>
<div class="line"><a name="l13596"></a><span class="lineno">13596</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l13597"></a><span class="lineno">13597</span>&#160;  <span class="comment">// Fix-up inversion if problem with gamma (i.e. velocity) or energy density in radiation rest-frame (i.e. Erf)</span></div>
<div class="line"><a name="l13598"></a><span class="lineno">13598</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l13600"></a><span class="lineno">13600</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l13601"></a><span class="lineno">13601</span>&#160;  <span class="keywordtype">int</span> failure1=gammarel2&gt;1.01*gammamax*gammamax || gammarel2&lt;0. || delta&lt;0.;</div>
<div class="line"><a name="l13602"></a><span class="lineno">13602</span>&#160;  <span class="keywordtype">int</span> failure2=gammarel2&lt;1. || delta&lt;0. || !<a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(gammarel2); <span class="comment">// NOTE: first failure1 already catches delta&lt;0.</span></div>
<div class="line"><a name="l13603"></a><span class="lineno">13603</span>&#160;</div>
<div class="line"><a name="l13604"></a><span class="lineno">13604</span>&#160;</div>
<div class="line"><a name="l13605"></a><span class="lineno">13605</span>&#160;</div>
<div class="line"><a name="l13606"></a><span class="lineno">13606</span>&#160;  <span class="keywordflow">if</span>(failure1){</div>
<div class="line"><a name="l13607"></a><span class="lineno">13607</span>&#160;    <span class="comment">//    if(failure1 &amp;&amp; tautotmax&lt;TAUFAILLIMIT){ // works for DBLSHADOW</span></div>
<div class="line"><a name="l13608"></a><span class="lineno">13608</span>&#160;</div>
<div class="line"><a name="l13609"></a><span class="lineno">13609</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammarel=gammamax;</div>
<div class="line"><a name="l13610"></a><span class="lineno">13610</span>&#160;    gammarel2=gammamax*gammamax;</div>
<div class="line"><a name="l13611"></a><span class="lineno">13611</span>&#160;</div>
<div class="line"><a name="l13612"></a><span class="lineno">13612</span>&#160;    <span class="comment">// get new Erf(gammarel)</span></div>
<div class="line"><a name="l13613"></a><span class="lineno">13613</span>&#160;    <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a4f76ac5680b95db932b2cf3ee309fb07" title="get Erf">get_m1closure_Erf</a>(ptrgeom, Avcon, gammarel2, &amp;Erf);</div>
<div class="line"><a name="l13614"></a><span class="lineno">13614</span>&#160;</div>
<div class="line"><a name="l13615"></a><span class="lineno">13615</span>&#160;</div>
<div class="line"><a name="l13616"></a><span class="lineno">13616</span>&#160;    <span class="comment">// Check if Erf is too small with gamma-&gt;gammamax</span></div>
<div class="line"><a name="l13617"></a><span class="lineno">13617</span>&#160;    <span class="keywordflow">if</span>(Erf&lt;ERADLIMIT || !<a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(Erf)){</div>
<div class="line"><a name="l13618"></a><span class="lineno">13618</span>&#160;      <span class="keywordflow">if</span>(1 || allowlocalfailurefixandnoreport==0) *lpflagrad=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aba9c5f566b4227c5e5d8faef0f62e4e6" title="locally fixed inversion problems (as possible sometimes with radiation): see phys.tools.rad.c:u2p_rad()">UTOPRIMRADFAILCASE1A</a>;</div>
<div class="line"><a name="l13619"></a><span class="lineno">13619</span>&#160;      <span class="comment">// Can&#39;t have Erf&lt;0.  Like floor on internal energy density.  If leave Erf&lt;0, then will drive code crazy with free energy.</span></div>
<div class="line"><a name="l13620"></a><span class="lineno">13620</span>&#160;      Erf=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a5bd9da451f108352614cbc457524c5b0">ERADLIMIT</a>;</div>
<div class="line"><a name="l13621"></a><span class="lineno">13621</span>&#160;</div>
<div class="line"><a name="l13622"></a><span class="lineno">13622</span>&#160;      <span class="comment">// can&#39;t use normal velocity with small Erf -- fails with inf or nan</span></div>
<div class="line"><a name="l13623"></a><span class="lineno">13623</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) urfconrel[jj] = 0.0;</div>
<div class="line"><a name="l13624"></a><span class="lineno">13624</span>&#160;</div>
<div class="line"><a name="l13625"></a><span class="lineno">13625</span>&#160;      <span class="keywordflow">if</span>(showmessages &amp;&amp; debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;CASE1A: gammarel&gt;gammamax and Erf&lt;ERADLIMIT: gammarel2=%g : i=%d j=%d k=%d\n&quot;</span>,gammarel2,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k);</div>
<div class="line"><a name="l13626"></a><span class="lineno">13626</span>&#160;    }</div>
<div class="line"><a name="l13627"></a><span class="lineno">13627</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l13628"></a><span class="lineno">13628</span>&#160;      <span class="comment">// if Erf normal, assume ok to have gammamax for radiation.  This avoids fixups, which can generate more oscillations.</span></div>
<div class="line"><a name="l13629"></a><span class="lineno">13629</span>&#160;      <span class="keywordflow">if</span>(allowlocalfailurefixandnoreport==0) *lpflagrad=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a9e4e88357dad17ae401b91f65e4fd3f9">UTOPRIMRADFAILCASE1B</a>;</div>
<div class="line"><a name="l13630"></a><span class="lineno">13630</span>&#160;      <span class="keywordflow">if</span>(showmessages &amp;&amp; debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;CASE1B: gammarel&gt;gammamax and Erf normal: gammarel2=%g : i=%d j=%d k=%d\n&quot;</span>,gammarel2,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k);</div>
<div class="line"><a name="l13631"></a><span class="lineno">13631</span>&#160;</div>
<div class="line"><a name="l13632"></a><span class="lineno">13632</span>&#160;      <span class="comment">// regardless of Erf value, now that have some Erf, ensure gamma=gammamax</span></div>
<div class="line"><a name="l13633"></a><span class="lineno">13633</span>&#160;      <span class="comment">// lab-frame radiation relative 4-velocity</span></div>
<div class="line"><a name="l13634"></a><span class="lineno">13634</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> alpha=ptrgeom-&gt;alphalapse;</div>
<div class="line"><a name="l13635"></a><span class="lineno">13635</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) urfconrel[jj] = alpha * (Avcon[jj] + 1./3.*Erf*ptrgeom-&gt;gcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(0,jj)]*(4.0*gammarel2-1.0) )/(4./3.*Erf*gammarel);</div>
<div class="line"><a name="l13636"></a><span class="lineno">13636</span>&#160;        </div>
<div class="line"><a name="l13637"></a><span class="lineno">13637</span>&#160;      <span class="comment">// compute \gammarel using this (gammatemp can be inf if Erf=ERADLIMIT, and then rescaling below will give urfconrel=0 and gammarel=1</span></div>
<div class="line"><a name="l13638"></a><span class="lineno">13638</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammatemp,qsqtemp;</div>
<div class="line"><a name="l13639"></a><span class="lineno">13639</span>&#160;      <span class="keywordtype">int</span> <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#abfae38e47b0bd05a4fc38302ff948a96" title="find gamma-factor wrt normal observer This function and qsq_calc() have about the same cache miss amo...">gamma_calc_fromuconrel</a>(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *uconrel, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *geom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a>*gamma, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *qsq);</div>
<div class="line"><a name="l13640"></a><span class="lineno">13640</span>&#160;      <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#abfae38e47b0bd05a4fc38302ff948a96" title="find gamma-factor wrt normal observer This function and qsq_calc() have about the same cache miss amo...">gamma_calc_fromuconrel</a>(urfconrel,ptrgeom,&amp;gammatemp,&amp;qsqtemp),<span class="stringliteral">&quot;ucon_calc_rel4vel_fromuconrel: gamma_calc_fromuconrel failed\n&quot;</span>,<span class="stringliteral">&quot;phys.tools.rad.c&quot;</span>,1);</div>
<div class="line"><a name="l13641"></a><span class="lineno">13641</span>&#160;        </div>
<div class="line"><a name="l13642"></a><span class="lineno">13642</span>&#160;      <span class="comment">// now rescale urfconrel[i] so will give desired \gammamax</span></div>
<div class="line"><a name="l13643"></a><span class="lineno">13643</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) urfconrel[jj] *= (gammamax/gammatemp);</div>
<div class="line"><a name="l13644"></a><span class="lineno">13644</span>&#160; </div>
<div class="line"><a name="l13645"></a><span class="lineno">13645</span>&#160;<span class="preprocessor">#if(PRODUCTION==0)</span></div>
<div class="line"><a name="l13646"></a><span class="lineno">13646</span>&#160;<span class="preprocessor"></span>      <span class="comment">// check that gamma really correctly gammamax</span></div>
<div class="line"><a name="l13647"></a><span class="lineno">13647</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammatemp2,qsqtemp2;</div>
<div class="line"><a name="l13648"></a><span class="lineno">13648</span>&#160;      <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#abfae38e47b0bd05a4fc38302ff948a96" title="find gamma-factor wrt normal observer This function and qsq_calc() have about the same cache miss amo...">gamma_calc_fromuconrel</a>(urfconrel,ptrgeom,&amp;gammatemp2,&amp;qsqtemp2),<span class="stringliteral">&quot;ucon_calc_rel4vel_fromuconrel: gamma_calc_fromuconrel failed\n&quot;</span>,<span class="stringliteral">&quot;phys.tools.rad.c&quot;</span>,1);</div>
<div class="line"><a name="l13649"></a><span class="lineno">13649</span>&#160;      <span class="keywordflow">if</span>(showmessages) dualfprintf(fail_file,<span class="stringliteral">&quot;CASE1B: gammarel&gt;gammamax and Erf normal: gammamax=%g gammatemp=%g gammatemp2=%g ijk=%d %d %d\n&quot;</span>,gammamax,gammatemp,gammatemp2,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k);</div>
<div class="line"><a name="l13650"></a><span class="lineno">13650</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l13651"></a><span class="lineno">13651</span>&#160;<span class="preprocessor"></span>    }</div>
<div class="line"><a name="l13652"></a><span class="lineno">13652</span>&#160;</div>
<div class="line"><a name="l13653"></a><span class="lineno">13653</span>&#160;  }</div>
<div class="line"><a name="l13655"></a><span class="lineno">13655</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l13656"></a><span class="lineno">13656</span>&#160;  <span class="comment">// Second case is if gammarel&lt;1 or delta&lt;0, then set gammarel=1.  If Erf&lt;ERADLIMIT (~0), then set Erf=ERADLIMIT and gammarel=1.</span></div>
<div class="line"><a name="l13657"></a><span class="lineno">13657</span>&#160;  <span class="comment">// Can&#39;t assume this condition is equivalent to large gamma, because if not, then leads to crazy boost of energy.</span></div>
<div class="line"><a name="l13658"></a><span class="lineno">13658</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l13660"></a><span class="lineno">13660</span>&#160;<span class="comment"></span>  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(failure2){</div>
<div class="line"><a name="l13661"></a><span class="lineno">13661</span>&#160;</div>
<div class="line"><a name="l13662"></a><span class="lineno">13662</span>&#160;</div>
<div class="line"><a name="l13663"></a><span class="lineno">13663</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammarel2orig=gammarel2;</div>
<div class="line"><a name="l13664"></a><span class="lineno">13664</span>&#160;    <span class="comment">// override</span></div>
<div class="line"><a name="l13665"></a><span class="lineno">13665</span>&#160;    gammarel2=1.0;</div>
<div class="line"><a name="l13666"></a><span class="lineno">13666</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammarel=1.0;  <span class="comment">// use this below</span></div>
<div class="line"><a name="l13667"></a><span class="lineno">13667</span>&#160;</div>
<div class="line"><a name="l13668"></a><span class="lineno">13668</span>&#160;    <span class="comment">// get new Erf(gammarel)</span></div>
<div class="line"><a name="l13669"></a><span class="lineno">13669</span>&#160;    <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a4f76ac5680b95db932b2cf3ee309fb07" title="get Erf">get_m1closure_Erf</a>(ptrgeom, Avcon, gammarel2, &amp;Erf);</div>
<div class="line"><a name="l13670"></a><span class="lineno">13670</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) urfconrel[jj] = 0.0;</div>
<div class="line"><a name="l13671"></a><span class="lineno">13671</span>&#160;</div>
<div class="line"><a name="l13672"></a><span class="lineno">13672</span>&#160;</div>
<div class="line"><a name="l13673"></a><span class="lineno">13673</span>&#160;    <span class="keywordflow">if</span>(Erf&lt;ERADLIMIT || !<a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(Erf)){ <span class="comment">// JCM</span></div>
<div class="line"><a name="l13674"></a><span class="lineno">13674</span>&#160;      <span class="comment">// Can&#39;t have Erf&lt;0.  Like floor on internal energy density.  If leave Erf&lt;0, then will drive code crazy with free energy.</span></div>
<div class="line"><a name="l13675"></a><span class="lineno">13675</span>&#160;      Erf=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a5bd9da451f108352614cbc457524c5b0">ERADLIMIT</a>;</div>
<div class="line"><a name="l13676"></a><span class="lineno">13676</span>&#160;      <span class="keywordflow">if</span>(1 || allowlocalfailurefixandnoreport==0) *lpflagrad=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#af1ba8d5f13f64649f7f731147526401d">UTOPRIMRADFAILCASE2A</a>;</div>
<div class="line"><a name="l13677"></a><span class="lineno">13677</span>&#160;      <span class="keywordflow">if</span>(showmessages &amp;&amp; debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;CASE2A: gamma&lt;1 or delta&lt;0 and Erf&lt;ERADLIMIT : gammarel2=%g : i=%d j=%d k=%d\n&quot;</span>,gammarel2,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k);</div>
<div class="line"><a name="l13678"></a><span class="lineno">13678</span>&#160;    }</div>
<div class="line"><a name="l13679"></a><span class="lineno">13679</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l13680"></a><span class="lineno">13680</span>&#160;      <span class="comment">// normal Erf</span></div>
<div class="line"><a name="l13681"></a><span class="lineno">13681</span>&#160;      <span class="keywordflow">if</span>(1 || allowlocalfailurefixandnoreport==0) *lpflagrad=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7f3a2041359f47002ef7d3dc5a950833">UTOPRIMRADFAILCASE2B</a>;</div>
<div class="line"><a name="l13682"></a><span class="lineno">13682</span>&#160;      <span class="keywordflow">if</span>(showmessages &amp;&amp; debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;CASE2B: gamma&lt;1 or delta&lt;0 and Erf normal : gammamax=%g gammarel2orig=%21.15g gammarel2=%21.15g delta=%g : i=%d j=%d k=%d\n&quot;</span>,gammamax,gammarel2orig,gammarel2,delta,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k);</div>
<div class="line"><a name="l13683"></a><span class="lineno">13683</span>&#160;    }</div>
<div class="line"><a name="l13684"></a><span class="lineno">13684</span>&#160;</div>
<div class="line"><a name="l13685"></a><span class="lineno">13685</span>&#160;</div>
<div class="line"><a name="l13686"></a><span class="lineno">13686</span>&#160;      </div>
<div class="line"><a name="l13687"></a><span class="lineno">13687</span>&#160;  }</div>
<div class="line"><a name="l13689"></a><span class="lineno">13689</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l13690"></a><span class="lineno">13690</span>&#160;  <span class="comment">// Third case is if no bad conditions, then try regular calculation.  If Erf&lt;ERADLIMIT, then already caught with first condition</span></div>
<div class="line"><a name="l13691"></a><span class="lineno">13691</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l13693"></a><span class="lineno">13693</span>&#160;<span class="comment"></span>  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l13694"></a><span class="lineno">13694</span>&#160;</div>
<div class="line"><a name="l13695"></a><span class="lineno">13695</span>&#160;    <span class="keywordflow">if</span>(Erf&lt;ERADLIMIT || !<a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(Erf)){</div>
<div class="line"><a name="l13696"></a><span class="lineno">13696</span>&#160;      Erf=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a5bd9da451f108352614cbc457524c5b0">ERADLIMIT</a>;</div>
<div class="line"><a name="l13697"></a><span class="lineno">13697</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) urfconrel[jj] = 0.0;</div>
<div class="line"><a name="l13698"></a><span class="lineno">13698</span>&#160;      <span class="comment">// must use above because if use ERADLIMIT in normal urfconrel, then urfconrel will be HUGE and probably give inf or nan due to Avcon/(Erf*gammarel) term.</span></div>
<div class="line"><a name="l13699"></a><span class="lineno">13699</span>&#160;    }</div>
<div class="line"><a name="l13700"></a><span class="lineno">13700</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l13701"></a><span class="lineno">13701</span>&#160;      <span class="comment">// get good relative velocity</span></div>
<div class="line"><a name="l13702"></a><span class="lineno">13702</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammarel=sqrt(gammarel2);</div>
<div class="line"><a name="l13703"></a><span class="lineno">13703</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> alpha=ptrgeom-&gt;alphalapse;</div>
<div class="line"><a name="l13704"></a><span class="lineno">13704</span>&#160;      </div>
<div class="line"><a name="l13705"></a><span class="lineno">13705</span>&#160;      <span class="comment">// NOTEMARK: This overwrites choice above for urfconrel when Erf&lt;ERADLIMIT.</span></div>
<div class="line"><a name="l13706"></a><span class="lineno">13706</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) urfconrel[jj] = alpha * (Avcon[jj] + 1./3.*Erf*ptrgeom-&gt;gcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(0,jj)]*(4.0*gammarel2-1.0) )/(4./3.*Erf*gammarel);</div>
<div class="line"><a name="l13707"></a><span class="lineno">13707</span>&#160;    }</div>
<div class="line"><a name="l13708"></a><span class="lineno">13708</span>&#160;</div>
<div class="line"><a name="l13709"></a><span class="lineno">13709</span>&#160;</div>
<div class="line"><a name="l13710"></a><span class="lineno">13710</span>&#160;    <span class="comment">//        dualfprintf(fail_file,&quot;NO failure: %g %g ijk=%d %d %d\n&quot;,Erf,gammarel2,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k);</span></div>
<div class="line"><a name="l13711"></a><span class="lineno">13711</span>&#160;  }</div>
<div class="line"><a name="l13712"></a><span class="lineno">13712</span>&#160;</div>
<div class="line"><a name="l13713"></a><span class="lineno">13713</span>&#160;</div>
<div class="line"><a name="l13714"></a><span class="lineno">13714</span>&#160;  <span class="keywordflow">if</span>(debugfail&gt;=2){</div>
<div class="line"><a name="l13715"></a><span class="lineno">13715</span>&#160;    <span class="keywordflow">if</span>(!<a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(Erf) || !<a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(gammarel2) || !<a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(urfconrel[0])|| !<a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(urfconrel[1])|| !<a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(urfconrel[2])|| !<a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(urfconrel[3]) ){</div>
<div class="line"><a name="l13716"></a><span class="lineno">13716</span>&#160;      dualfprintf(fail_file,<span class="stringliteral">&quot;OLEKNAN: ijk=%d %d %d :  %g %g : %g %g %g : %d %d : %g %g %g %g\n&quot;</span>,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,Erf,gammarel2,urfconrel[1],urfconrel[2],urfconrel[3],failure1,failure2,Avcon[0],Avcon[1],Avcon[2],Avcon[3]);</div>
<div class="line"><a name="l13717"></a><span class="lineno">13717</span>&#160;    }</div>
<div class="line"><a name="l13718"></a><span class="lineno">13718</span>&#160;  }</div>
<div class="line"><a name="l13719"></a><span class="lineno">13719</span>&#160;      </div>
<div class="line"><a name="l13720"></a><span class="lineno">13720</span>&#160;  *Erfreturn=Erf; <span class="comment">// pass back new Erf to pointer</span></div>
<div class="line"><a name="l13721"></a><span class="lineno">13721</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l13722"></a><span class="lineno">13722</span>&#160;}</div>
<div class="line"><a name="l13723"></a><span class="lineno">13723</span>&#160;</div>
<div class="line"><a name="l13724"></a><span class="lineno">13724</span>&#160;</div>
<div class="line"><a name="l13725"></a><span class="lineno">13725</span>&#160;</div>
<div class="line"><a name="l13726"></a><span class="lineno">13726</span>&#160;</div>
<div class="line"><a name="l13727"></a><span class="lineno">13727</span>&#160;</div>
<div class="line"><a name="l13728"></a><span class="lineno">13728</span>&#160;</div>
<div class="line"><a name="l13729"></a><span class="lineno">13729</span>&#160;</div>
<div class="line"><a name="l13730"></a><span class="lineno">13730</span>&#160;</div>
<div class="line"><a name="l13732"></a><span class="lineno">13732</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> get_m1closure_gammarel2_cold_old(<span class="keywordtype">int</span> showmessages, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Avcon, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Avcov, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *gammarel2return, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *deltareturn, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *numeratorreturn, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *divisorreturn, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Erfreturn, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *urfconrel)</div>
<div class="line"><a name="l13733"></a><span class="lineno">13733</span>&#160;{</div>
<div class="line"><a name="l13734"></a><span class="lineno">13734</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gamma2,gammarel2,<a class="code" href="../../d9/d43/global_8variousmacros_8h.html#aa5ebb2763dd5546bc40222826cea731f">delta</a>;</div>
<div class="line"><a name="l13735"></a><span class="lineno">13735</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Erf;</div>
<div class="line"><a name="l13736"></a><span class="lineno">13736</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> alpha=ptrgeom-&gt;alphalapse;</div>
<div class="line"><a name="l13737"></a><span class="lineno">13737</span>&#160;  <span class="keywordtype">int</span> jj;</div>
<div class="line"><a name="l13738"></a><span class="lineno">13738</span>&#160;</div>
<div class="line"><a name="l13739"></a><span class="lineno">13739</span>&#160;  <span class="keyword">static</span> <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gctt, gv11, gv12,  gv13,  gv14,  gv22,  gv23,  gv24,  gv33,  gv34,  gv44,  Rtt,  Rtx,  Rty,  Rtz;</div>
<div class="line"><a name="l13740"></a><span class="lineno">13740</span>&#160;  gv11=ptrgeom-&gt;gcov[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(0,0)];</div>
<div class="line"><a name="l13741"></a><span class="lineno">13741</span>&#160;  gv12=ptrgeom-&gt;gcov[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(0,1)];</div>
<div class="line"><a name="l13742"></a><span class="lineno">13742</span>&#160;  gv13=ptrgeom-&gt;gcov[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(0,2)];</div>
<div class="line"><a name="l13743"></a><span class="lineno">13743</span>&#160;  gv14=ptrgeom-&gt;gcov[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(0,3)];</div>
<div class="line"><a name="l13744"></a><span class="lineno">13744</span>&#160;  gv22=ptrgeom-&gt;gcov[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(1,1)];</div>
<div class="line"><a name="l13745"></a><span class="lineno">13745</span>&#160;  gv23=ptrgeom-&gt;gcov[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(1,2)];</div>
<div class="line"><a name="l13746"></a><span class="lineno">13746</span>&#160;  gv24=ptrgeom-&gt;gcov[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(1,3)];</div>
<div class="line"><a name="l13747"></a><span class="lineno">13747</span>&#160;  gv33=ptrgeom-&gt;gcov[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(2,2)];</div>
<div class="line"><a name="l13748"></a><span class="lineno">13748</span>&#160;  gv34=ptrgeom-&gt;gcov[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(2,3)];</div>
<div class="line"><a name="l13749"></a><span class="lineno">13749</span>&#160;  gv44=ptrgeom-&gt;gcov[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(3,3)];</div>
<div class="line"><a name="l13750"></a><span class="lineno">13750</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Rttold=Avcon[0];</div>
<div class="line"><a name="l13751"></a><span class="lineno">13751</span>&#160;  Rtx=Avcon[1];</div>
<div class="line"><a name="l13752"></a><span class="lineno">13752</span>&#160;  Rty=Avcon[2];</div>
<div class="line"><a name="l13753"></a><span class="lineno">13753</span>&#160;  Rtz=Avcon[3];</div>
<div class="line"><a name="l13754"></a><span class="lineno">13754</span>&#160;  gctt=ptrgeom-&gt;gcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(0,0)];</div>
<div class="line"><a name="l13755"></a><span class="lineno">13755</span>&#160;</div>
<div class="line"><a name="l13756"></a><span class="lineno">13756</span>&#160;</div>
<div class="line"><a name="l13757"></a><span class="lineno">13757</span>&#160;  <span class="comment">// choose gamma</span></div>
<div class="line"><a name="l13758"></a><span class="lineno">13758</span>&#160;  <span class="keywordflow">if</span>(gammarel2return==NULL){</div>
<div class="line"><a name="l13759"></a><span class="lineno">13759</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammamaxfail=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a6be2b06c26c5422c755647ef87bdb924">GAMMAMAXRADFAIL</a>;</div>
<div class="line"><a name="l13760"></a><span class="lineno">13760</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammamax=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a51ef12e4cafc4a8fe70374c37f57d565">GAMMAMAXRAD</a>;</div>
<div class="line"><a name="l13761"></a><span class="lineno">13761</span>&#160;    gammarel2=gammamax*gammamax;</div>
<div class="line"><a name="l13762"></a><span class="lineno">13762</span>&#160;  }</div>
<div class="line"><a name="l13763"></a><span class="lineno">13763</span>&#160;  <span class="keywordflow">else</span> gammarel2=*gammarel2return; <span class="comment">// feed in desired gammarel2</span></div>
<div class="line"><a name="l13764"></a><span class="lineno">13764</span>&#160;</div>
<div class="line"><a name="l13765"></a><span class="lineno">13765</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> utsq=gammarel2/(alpha*alpha);</div>
<div class="line"><a name="l13766"></a><span class="lineno">13766</span>&#160;</div>
<div class="line"><a name="l13767"></a><span class="lineno">13767</span>&#160;</div>
<div class="line"><a name="l13768"></a><span class="lineno">13768</span>&#160;</div>
<div class="line"><a name="l13769"></a><span class="lineno">13769</span>&#160;  <span class="comment">// but check if utsq is too small</span></div>
<div class="line"><a name="l13770"></a><span class="lineno">13770</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> utsqmina=(0.5*(-8.*gctt*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gv12,2)*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rtx,2) + 8.*gv22*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rtx,2) + </div>
<div class="line"><a name="l13771"></a><span class="lineno">13771</span>&#160;                       8.*gctt*gv11*gv22*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rtx,2) - 16.*gctt*gv12*gv13*Rtx*Rty + </div>
<div class="line"><a name="l13772"></a><span class="lineno">13772</span>&#160;                       16.*gv23*Rtx*Rty + 16.*gctt*gv11*gv23*Rtx*Rty - </div>
<div class="line"><a name="l13773"></a><span class="lineno">13773</span>&#160;                       8.*gctt*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gv13,2)*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rty,2) + 8.*gv33*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rty,2) + </div>
<div class="line"><a name="l13774"></a><span class="lineno">13774</span>&#160;                       8.*gctt*gv11*gv33*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rty,2) - 16.*gctt*gv12*gv14*Rtx*Rtz + </div>
<div class="line"><a name="l13775"></a><span class="lineno">13775</span>&#160;                       16.*gv24*Rtx*Rtz + 16.*gctt*gv11*gv24*Rtx*Rtz - </div>
<div class="line"><a name="l13776"></a><span class="lineno">13776</span>&#160;                       16.*gctt*gv13*gv14*Rty*Rtz + 16.*gv34*Rty*Rtz + </div>
<div class="line"><a name="l13777"></a><span class="lineno">13777</span>&#160;                       16.*gctt*gv11*gv34*Rty*Rtz - 8.*gctt*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gv14,2)*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rtz,2) + </div>
<div class="line"><a name="l13778"></a><span class="lineno">13778</span>&#160;                       8.*gv44*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rtz,2) + 8.*gctt*gv11*gv44*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rtz,2) - </div>
<div class="line"><a name="l13779"></a><span class="lineno">13779</span>&#160;                       1.*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a8666c1425b2e68a40939ca9e5fd719e5">Sqrt</a>(<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(8.*gctt*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gv12,2)*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rtx,2) - 8.*gv22*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rtx,2) - </div>
<div class="line"><a name="l13780"></a><span class="lineno">13780</span>&#160;                                     8.*gctt*gv11*gv22*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rtx,2) + 16.*gctt*gv12*gv13*Rtx*Rty - </div>
<div class="line"><a name="l13781"></a><span class="lineno">13781</span>&#160;                                     16.*gv23*Rtx*Rty - 16.*gctt*gv11*gv23*Rtx*Rty + </div>
<div class="line"><a name="l13782"></a><span class="lineno">13782</span>&#160;                                     8.*gctt*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gv13,2)*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rty,2) - 8.*gv33*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rty,2) - </div>
<div class="line"><a name="l13783"></a><span class="lineno">13783</span>&#160;                                     8.*gctt*gv11*gv33*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rty,2) + 16.*gctt*gv12*gv14*Rtx*Rtz - </div>
<div class="line"><a name="l13784"></a><span class="lineno">13784</span>&#160;                                     16.*gv24*Rtx*Rtz - 16.*gctt*gv11*gv24*Rtx*Rtz + </div>
<div class="line"><a name="l13785"></a><span class="lineno">13785</span>&#160;                                     16.*gctt*gv13*gv14*Rty*Rtz - 16.*gv34*Rty*Rtz - </div>
<div class="line"><a name="l13786"></a><span class="lineno">13786</span>&#160;                                     16.*gctt*gv11*gv34*Rty*Rtz + 8.*gctt*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gv14,2)*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rtz,2) - </div>
<div class="line"><a name="l13787"></a><span class="lineno">13787</span>&#160;                                     8.*gv44*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rtz,2) - 8.*gctt*gv11*gv44*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rtz,2),2) - </div>
<div class="line"><a name="l13788"></a><span class="lineno">13788</span>&#160;                               4.*(16.*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gv12,2)*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rtx,2) - 16.*gv11*gv22*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rtx,2) + </div>
<div class="line"><a name="l13789"></a><span class="lineno">13789</span>&#160;                                   32.*gv12*gv13*Rtx*Rty - 32.*gv11*gv23*Rtx*Rty + </div>
<div class="line"><a name="l13790"></a><span class="lineno">13790</span>&#160;                                   16.*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gv13,2)*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rty,2) - 16.*gv11*gv33*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rty,2) + </div>
<div class="line"><a name="l13791"></a><span class="lineno">13791</span>&#160;                                   32.*gv12*gv14*Rtx*Rtz - 32.*gv11*gv24*Rtx*Rtz + </div>
<div class="line"><a name="l13792"></a><span class="lineno">13792</span>&#160;                                   32.*gv13*gv14*Rty*Rtz - 32.*gv11*gv34*Rty*Rtz + </div>
<div class="line"><a name="l13793"></a><span class="lineno">13793</span>&#160;                                   16.*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gv14,2)*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rtz,2) - 16.*gv11*gv44*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rtz,2))*</div>
<div class="line"><a name="l13794"></a><span class="lineno">13794</span>&#160;                               (<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gctt,2)*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gv12,2)*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rtx,2) + gctt*gv22*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rtx,2) - </div>
<div class="line"><a name="l13795"></a><span class="lineno">13795</span>&#160;                                1.*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gctt,2)*gv11*gv22*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rtx,2) + </div>
<div class="line"><a name="l13796"></a><span class="lineno">13796</span>&#160;                                2.*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gctt,2)*gv12*gv13*Rtx*Rty + 2.*gctt*gv23*Rtx*Rty - </div>
<div class="line"><a name="l13797"></a><span class="lineno">13797</span>&#160;                                2.*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gctt,2)*gv11*gv23*Rtx*Rty + </div>
<div class="line"><a name="l13798"></a><span class="lineno">13798</span>&#160;                                <a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gctt,2)*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gv13,2)*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rty,2) + gctt*gv33*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rty,2) - </div>
<div class="line"><a name="l13799"></a><span class="lineno">13799</span>&#160;                                1.*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gctt,2)*gv11*gv33*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rty,2) + </div>
<div class="line"><a name="l13800"></a><span class="lineno">13800</span>&#160;                                2.*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gctt,2)*gv12*gv14*Rtx*Rtz + 2.*gctt*gv24*Rtx*Rtz - </div>
<div class="line"><a name="l13801"></a><span class="lineno">13801</span>&#160;                                2.*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gctt,2)*gv11*gv24*Rtx*Rtz + </div>
<div class="line"><a name="l13802"></a><span class="lineno">13802</span>&#160;                                2.*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gctt,2)*gv13*gv14*Rty*Rtz + 2.*gctt*gv34*Rty*Rtz - </div>
<div class="line"><a name="l13803"></a><span class="lineno">13803</span>&#160;                                2.*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gctt,2)*gv11*gv34*Rty*Rtz + </div>
<div class="line"><a name="l13804"></a><span class="lineno">13804</span>&#160;                                <a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gctt,2)*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gv14,2)*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rtz,2) + gctt*gv44*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rtz,2) - </div>
<div class="line"><a name="l13805"></a><span class="lineno">13805</span>&#160;                                1.*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gctt,2)*gv11*gv44*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rtz,2)))))/</div>
<div class="line"><a name="l13806"></a><span class="lineno">13806</span>&#160;    (16.*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gv12,2)*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rtx,2) - 16.*gv11*gv22*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rtx,2) + </div>
<div class="line"><a name="l13807"></a><span class="lineno">13807</span>&#160;     32.*gv12*gv13*Rtx*Rty - 32.*gv11*gv23*Rtx*Rty + </div>
<div class="line"><a name="l13808"></a><span class="lineno">13808</span>&#160;     16.*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gv13,2)*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rty,2) - 16.*gv11*gv33*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rty,2) + </div>
<div class="line"><a name="l13809"></a><span class="lineno">13809</span>&#160;     32.*gv12*gv14*Rtx*Rtz - 32.*gv11*gv24*Rtx*Rtz + 32.*gv13*gv14*Rty*Rtz - </div>
<div class="line"><a name="l13810"></a><span class="lineno">13810</span>&#160;     32.*gv11*gv34*Rty*Rtz + 16.*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gv14,2)*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rtz,2) - </div>
<div class="line"><a name="l13811"></a><span class="lineno">13811</span>&#160;     16.*gv11*gv44*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rtz,2));</div>
<div class="line"><a name="l13812"></a><span class="lineno">13812</span>&#160;</div>
<div class="line"><a name="l13813"></a><span class="lineno">13813</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> utsqminb=(0.5*(-8.*gctt*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gv12,2)*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rtx,2) + 8.*gv22*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rtx,2) + </div>
<div class="line"><a name="l13814"></a><span class="lineno">13814</span>&#160;                       8.*gctt*gv11*gv22*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rtx,2) - 16.*gctt*gv12*gv13*Rtx*Rty + </div>
<div class="line"><a name="l13815"></a><span class="lineno">13815</span>&#160;                       16.*gv23*Rtx*Rty + 16.*gctt*gv11*gv23*Rtx*Rty - </div>
<div class="line"><a name="l13816"></a><span class="lineno">13816</span>&#160;                       8.*gctt*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gv13,2)*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rty,2) + 8.*gv33*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rty,2) + </div>
<div class="line"><a name="l13817"></a><span class="lineno">13817</span>&#160;                       8.*gctt*gv11*gv33*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rty,2) - 16.*gctt*gv12*gv14*Rtx*Rtz + </div>
<div class="line"><a name="l13818"></a><span class="lineno">13818</span>&#160;                       16.*gv24*Rtx*Rtz + 16.*gctt*gv11*gv24*Rtx*Rtz - </div>
<div class="line"><a name="l13819"></a><span class="lineno">13819</span>&#160;                       16.*gctt*gv13*gv14*Rty*Rtz + 16.*gv34*Rty*Rtz + </div>
<div class="line"><a name="l13820"></a><span class="lineno">13820</span>&#160;                       16.*gctt*gv11*gv34*Rty*Rtz - 8.*gctt*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gv14,2)*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rtz,2) + </div>
<div class="line"><a name="l13821"></a><span class="lineno">13821</span>&#160;                       8.*gv44*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rtz,2) + 8.*gctt*gv11*gv44*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rtz,2) + </div>
<div class="line"><a name="l13822"></a><span class="lineno">13822</span>&#160;                       <a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a8666c1425b2e68a40939ca9e5fd719e5">Sqrt</a>(<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(8.*gctt*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gv12,2)*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rtx,2) - 8.*gv22*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rtx,2) - </div>
<div class="line"><a name="l13823"></a><span class="lineno">13823</span>&#160;                                  8.*gctt*gv11*gv22*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rtx,2) + 16.*gctt*gv12*gv13*Rtx*Rty - </div>
<div class="line"><a name="l13824"></a><span class="lineno">13824</span>&#160;                                  16.*gv23*Rtx*Rty - 16.*gctt*gv11*gv23*Rtx*Rty + </div>
<div class="line"><a name="l13825"></a><span class="lineno">13825</span>&#160;                                  8.*gctt*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gv13,2)*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rty,2) - 8.*gv33*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rty,2) - </div>
<div class="line"><a name="l13826"></a><span class="lineno">13826</span>&#160;                                  8.*gctt*gv11*gv33*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rty,2) + 16.*gctt*gv12*gv14*Rtx*Rtz - </div>
<div class="line"><a name="l13827"></a><span class="lineno">13827</span>&#160;                                  16.*gv24*Rtx*Rtz - 16.*gctt*gv11*gv24*Rtx*Rtz + </div>
<div class="line"><a name="l13828"></a><span class="lineno">13828</span>&#160;                                  16.*gctt*gv13*gv14*Rty*Rtz - 16.*gv34*Rty*Rtz - </div>
<div class="line"><a name="l13829"></a><span class="lineno">13829</span>&#160;                                  16.*gctt*gv11*gv34*Rty*Rtz + 8.*gctt*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gv14,2)*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rtz,2) - </div>
<div class="line"><a name="l13830"></a><span class="lineno">13830</span>&#160;                                  8.*gv44*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rtz,2) - 8.*gctt*gv11*gv44*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rtz,2),2) - </div>
<div class="line"><a name="l13831"></a><span class="lineno">13831</span>&#160;                            4.*(16.*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gv12,2)*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rtx,2) - 16.*gv11*gv22*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rtx,2) + </div>
<div class="line"><a name="l13832"></a><span class="lineno">13832</span>&#160;                                32.*gv12*gv13*Rtx*Rty - 32.*gv11*gv23*Rtx*Rty + </div>
<div class="line"><a name="l13833"></a><span class="lineno">13833</span>&#160;                                16.*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gv13,2)*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rty,2) - 16.*gv11*gv33*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rty,2) + </div>
<div class="line"><a name="l13834"></a><span class="lineno">13834</span>&#160;                                32.*gv12*gv14*Rtx*Rtz - 32.*gv11*gv24*Rtx*Rtz + </div>
<div class="line"><a name="l13835"></a><span class="lineno">13835</span>&#160;                                32.*gv13*gv14*Rty*Rtz - 32.*gv11*gv34*Rty*Rtz + </div>
<div class="line"><a name="l13836"></a><span class="lineno">13836</span>&#160;                                16.*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gv14,2)*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rtz,2) - 16.*gv11*gv44*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rtz,2))*</div>
<div class="line"><a name="l13837"></a><span class="lineno">13837</span>&#160;                            (<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gctt,2)*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gv12,2)*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rtx,2) + gctt*gv22*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rtx,2) - </div>
<div class="line"><a name="l13838"></a><span class="lineno">13838</span>&#160;                             1.*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gctt,2)*gv11*gv22*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rtx,2) + </div>
<div class="line"><a name="l13839"></a><span class="lineno">13839</span>&#160;                             2.*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gctt,2)*gv12*gv13*Rtx*Rty + 2.*gctt*gv23*Rtx*Rty - </div>
<div class="line"><a name="l13840"></a><span class="lineno">13840</span>&#160;                             2.*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gctt,2)*gv11*gv23*Rtx*Rty + </div>
<div class="line"><a name="l13841"></a><span class="lineno">13841</span>&#160;                             <a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gctt,2)*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gv13,2)*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rty,2) + gctt*gv33*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rty,2) - </div>
<div class="line"><a name="l13842"></a><span class="lineno">13842</span>&#160;                             1.*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gctt,2)*gv11*gv33*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rty,2) + </div>
<div class="line"><a name="l13843"></a><span class="lineno">13843</span>&#160;                             2.*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gctt,2)*gv12*gv14*Rtx*Rtz + 2.*gctt*gv24*Rtx*Rtz - </div>
<div class="line"><a name="l13844"></a><span class="lineno">13844</span>&#160;                             2.*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gctt,2)*gv11*gv24*Rtx*Rtz + </div>
<div class="line"><a name="l13845"></a><span class="lineno">13845</span>&#160;                             2.*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gctt,2)*gv13*gv14*Rty*Rtz + 2.*gctt*gv34*Rty*Rtz - </div>
<div class="line"><a name="l13846"></a><span class="lineno">13846</span>&#160;                             2.*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gctt,2)*gv11*gv34*Rty*Rtz + </div>
<div class="line"><a name="l13847"></a><span class="lineno">13847</span>&#160;                             <a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gctt,2)*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gv14,2)*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rtz,2) + gctt*gv44*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rtz,2) - </div>
<div class="line"><a name="l13848"></a><span class="lineno">13848</span>&#160;                             1.*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gctt,2)*gv11*gv44*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rtz,2)))))/</div>
<div class="line"><a name="l13849"></a><span class="lineno">13849</span>&#160;    (16.*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gv12,2)*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rtx,2) - 16.*gv11*gv22*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rtx,2) + </div>
<div class="line"><a name="l13850"></a><span class="lineno">13850</span>&#160;     32.*gv12*gv13*Rtx*Rty - 32.*gv11*gv23*Rtx*Rty + </div>
<div class="line"><a name="l13851"></a><span class="lineno">13851</span>&#160;     16.*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gv13,2)*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rty,2) - 16.*gv11*gv33*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rty,2) + </div>
<div class="line"><a name="l13852"></a><span class="lineno">13852</span>&#160;     32.*gv12*gv14*Rtx*Rtz - 32.*gv11*gv24*Rtx*Rtz + 32.*gv13*gv14*Rty*Rtz - </div>
<div class="line"><a name="l13853"></a><span class="lineno">13853</span>&#160;     32.*gv11*gv34*Rty*Rtz + 16.*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gv14,2)*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rtz,2) - </div>
<div class="line"><a name="l13854"></a><span class="lineno">13854</span>&#160;     16.*gv11*gv44*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rtz,2));</div>
<div class="line"><a name="l13855"></a><span class="lineno">13855</span>&#160;</div>
<div class="line"><a name="l13856"></a><span class="lineno">13856</span>&#160;  dualfprintf(fail_file,<span class="stringliteral">&quot;utsq=%g utsqmina=%g utsqminb=%g\n&quot;</span>,utsq,utsqmina,utsqminb);</div>
<div class="line"><a name="l13857"></a><span class="lineno">13857</span>&#160;  <span class="comment">// KORALTODO: override (only applicable for first root)  Unsure if 2nd root used for GR in ergosphere.  e.g. gv11 switches sign!</span></div>
<div class="line"><a name="l13858"></a><span class="lineno">13858</span>&#160;  <span class="keywordflow">if</span>(utsq&lt;utsqmina &amp;&amp; utsqmina&gt;utsqminb) utsq=utsqmina;</div>
<div class="line"><a name="l13859"></a><span class="lineno">13859</span>&#160;  <span class="keywordflow">if</span>(utsq&lt;utsqminb &amp;&amp; utsqminb&gt;utsqmina) utsq=utsqminb;</div>
<div class="line"><a name="l13860"></a><span class="lineno">13860</span>&#160;</div>
<div class="line"><a name="l13861"></a><span class="lineno">13861</span>&#160;</div>
<div class="line"><a name="l13862"></a><span class="lineno">13862</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Avcovorig[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l13863"></a><span class="lineno">13863</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) Avcovorig[jj]=Avcov[jj];</div>
<div class="line"><a name="l13864"></a><span class="lineno">13864</span>&#160;  </div>
<div class="line"><a name="l13865"></a><span class="lineno">13865</span>&#160;</div>
<div class="line"><a name="l13866"></a><span class="lineno">13866</span>&#160;  <span class="comment">// get new Avcon[0]=R^{tt}</span></div>
<div class="line"><a name="l13867"></a><span class="lineno">13867</span>&#160;  </div>
<div class="line"><a name="l13868"></a><span class="lineno">13868</span>&#160;  Avcon[0]=(-1.*(gctt + 4.*utsq)*(gctt*(gv12*Rtx + gv13*Rty + gv14*Rtz) + 4.*(gv12*Rtx + gv13*Rty + gv14*Rtz)*utsq + </div>
<div class="line"><a name="l13869"></a><span class="lineno">13869</span>&#160;                               0.16666666666666666*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a8666c1425b2e68a40939ca9e5fd719e5">Sqrt</a>(36.*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gv12*Rtx + gv13*Rty + gv14*Rtz,2)*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gctt + 4.*utsq,2) - </div>
<div class="line"><a name="l13870"></a><span class="lineno">13870</span>&#160;                                                        36.*(gv22*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rtx,2) + 2.*gv23*Rtx*Rty + gv33*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rty,2) + 2.*gv24*Rtx*Rtz + 2.*gv34*Rty*Rtz + gv44*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rtz,2))*</div>
<div class="line"><a name="l13871"></a><span class="lineno">13871</span>&#160;                                                        (<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gctt,2)*gv11 + 8.*utsq*(1. + 2.*gv11*utsq) + gctt*(-1. + 8.*gv11*utsq)))))/</div>
<div class="line"><a name="l13872"></a><span class="lineno">13872</span>&#160;    (<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gctt,2)*gv11 + 8.*utsq*(1. + 2.*gv11*utsq) + gctt*(-1. + 8.*gv11*utsq));</div>
<div class="line"><a name="l13873"></a><span class="lineno">13873</span>&#160;</div>
<div class="line"><a name="l13874"></a><span class="lineno">13874</span>&#160;  Erf=(-3.*(gctt*(gv12*Rtx + gv13*Rty + gv14*Rtz) + 4.*(gv12*Rtx + gv13*Rty + gv14*Rtz)*utsq + </div>
<div class="line"><a name="l13875"></a><span class="lineno">13875</span>&#160;            0.16666666666666666*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a8666c1425b2e68a40939ca9e5fd719e5">Sqrt</a>(36.*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gv12*Rtx + gv13*Rty + gv14*Rtz,2)*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gctt + 4.*utsq,2) - </div>
<div class="line"><a name="l13876"></a><span class="lineno">13876</span>&#160;                                     36.*(gv22*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rtx,2) + 2.*gv23*Rtx*Rty + gv33*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rty,2) + 2.*gv24*Rtx*Rtz + 2.*gv34*Rty*Rtz + gv44*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rtz,2))*</div>
<div class="line"><a name="l13877"></a><span class="lineno">13877</span>&#160;                                     (<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gctt,2)*gv11 + 8.*utsq*(1. + 2.*gv11*utsq) + gctt*(-1. + 8.*gv11*utsq)))))/</div>
<div class="line"><a name="l13878"></a><span class="lineno">13878</span>&#160;    (<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gctt,2)*gv11 + 8.*utsq*(1. + 2.*gv11*utsq) + gctt*(-1. + 8.*gv11*utsq));</div>
<div class="line"><a name="l13879"></a><span class="lineno">13879</span>&#160;</div>
<div class="line"><a name="l13880"></a><span class="lineno">13880</span>&#160;</div>
<div class="line"><a name="l13881"></a><span class="lineno">13881</span>&#160;  dualfprintf(fail_file,&quot;NOR SOL: Avcon0new=%g Avcon0old=%g Erf=%g :: %g %g %g\n&quot;,Avcon[0],Rttold,Erf,Rtx,Rty,Rtz);</div>
<div class="line"><a name="l13882"></a><span class="lineno">13882</span>&#160; </div>
<div class="line"><a name="l13883"></a><span class="lineno">13883</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Avcovnew[NDIM];</div>
<div class="line"><a name="l13884"></a><span class="lineno">13884</span>&#160;  indices_21(Avcon,Avcovnew,ptrgeom);</div>
<div class="line"><a name="l13885"></a><span class="lineno">13885</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) dualfprintf(fail_file,&quot;jj=%d Avcovorig=%g Avcovnew=%g\n&quot;,jj,Avcovorig[jj],Avcovnew[jj]);</div>
<div class="line"><a name="l13886"></a><span class="lineno">13886</span>&#160;</div>
<div class="line"><a name="l13887"></a><span class="lineno">13887</span>&#160; </div>
<div class="line"><a name="l13888"></a><span class="lineno">13888</span>&#160;  delta=0; <span class="comment">// not yet</span></div>
<div class="line"><a name="l13889"></a><span class="lineno">13889</span>&#160;</div>
<div class="line"><a name="l13890"></a><span class="lineno">13890</span>&#160;  if(1){</div>
<div class="line"><a name="l13891"></a><span class="lineno">13891</span>&#160;    <span class="comment">// alt solution</span></div>
<div class="line"><a name="l13892"></a><span class="lineno">13892</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Avalt=(-1.*(gctt + 4.*utsq)*(gctt*(gv12*Rtx + gv13*Rty + gv14*Rtz) + 4.*(gv12*Rtx + gv13*Rty + gv14*Rtz)*utsq - </div>
<div class="line"><a name="l13893"></a><span class="lineno">13893</span>&#160;                                       0.16666666666666666*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a8666c1425b2e68a40939ca9e5fd719e5">Sqrt</a>(36.*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gv12*Rtx + gv13*Rty + gv14*Rtz,2)*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gctt + 4.*utsq,2) - </div>
<div class="line"><a name="l13894"></a><span class="lineno">13894</span>&#160;                                                                36.*(gv22*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rtx,2) + 2.*gv23*Rtx*Rty + gv33*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rty,2) + 2.*gv24*Rtx*Rtz + 2.*gv34*Rty*Rtz + gv44*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rtz,2))*</div>
<div class="line"><a name="l13895"></a><span class="lineno">13895</span>&#160;                                                                (<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gctt,2)*gv11 + 8.*utsq*(1. + 2.*gv11*utsq) + gctt*(-1. + 8.*gv11*utsq)))))/</div>
<div class="line"><a name="l13896"></a><span class="lineno">13896</span>&#160;      (<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gctt,2)*gv11 + 8.*utsq*(1. + 2.*gv11*utsq) + gctt*(-1. + 8.*gv11*utsq));</div>
<div class="line"><a name="l13897"></a><span class="lineno">13897</span>&#160;</div>
<div class="line"><a name="l13898"></a><span class="lineno">13898</span>&#160;</div>
<div class="line"><a name="l13899"></a><span class="lineno">13899</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Erfalt=(-3.*gctt*(gv12*Rtx + gv13*Rty + gv14*Rtz) - 12.*(gv12*Rtx + gv13*Rty + gv14*Rtz)*utsq + </div>
<div class="line"><a name="l13900"></a><span class="lineno">13900</span>&#160;                  0.5*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a8666c1425b2e68a40939ca9e5fd719e5">Sqrt</a>(36.*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gv12*Rtx + gv13*Rty + gv14*Rtz,2)*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gctt + 4.*utsq,2) - </div>
<div class="line"><a name="l13901"></a><span class="lineno">13901</span>&#160;                           36.*(gv22*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rtx,2) + 2.*gv23*Rtx*Rty + gv33*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rty,2) + 2.*gv24*Rtx*Rtz + 2.*gv34*Rty*Rtz + gv44*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rtz,2))*</div>
<div class="line"><a name="l13902"></a><span class="lineno">13902</span>&#160;                           (<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gctt,2)*gv11 + 8.*utsq*(1. + 2.*gv11*utsq) + gctt*(-1. + 8.*gv11*utsq))))/</div>
<div class="line"><a name="l13903"></a><span class="lineno">13903</span>&#160;      (<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gctt,2)*gv11 + 8.*utsq*(1. + 2.*gv11*utsq) + gctt*(-1. + 8.*gv11*utsq));</div>
<div class="line"><a name="l13904"></a><span class="lineno">13904</span>&#160;</div>
<div class="line"><a name="l13905"></a><span class="lineno">13905</span>&#160;    dualfprintf(fail_file,<span class="stringliteral">&quot;ALT SOL: Avalt=%g Av0old=%g Erfalt=%g : %g %g %g\n&quot;</span>,Avalt,Rttold,Erfalt,Rtx,Rty,Rtz);</div>
<div class="line"><a name="l13906"></a><span class="lineno">13906</span>&#160;  }</div>
<div class="line"><a name="l13907"></a><span class="lineno">13907</span>&#160;</div>
<div class="line"><a name="l13908"></a><span class="lineno">13908</span>&#160;</div>
<div class="line"><a name="l13909"></a><span class="lineno">13909</span>&#160;  *gammarel2return=gammarel2;</div>
<div class="line"><a name="l13910"></a><span class="lineno">13910</span>&#160;  *deltareturn=<a class="code" href="../../d9/d43/global_8variousmacros_8h.html#aa5ebb2763dd5546bc40222826cea731f">delta</a>;</div>
<div class="line"><a name="l13911"></a><span class="lineno">13911</span>&#160;</div>
<div class="line"><a name="l13912"></a><span class="lineno">13912</span>&#160;  <span class="comment">// get good relative velocity</span></div>
<div class="line"><a name="l13913"></a><span class="lineno">13913</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammarel=sqrt(gammarel2);</div>
<div class="line"><a name="l13914"></a><span class="lineno">13914</span>&#160;</div>
<div class="line"><a name="l13915"></a><span class="lineno">13915</span>&#160;  <span class="comment">// get relative 4-velocity</span></div>
<div class="line"><a name="l13916"></a><span class="lineno">13916</span>&#160;  <span class="keywordflow">if</span>(Erf&gt;0.0) <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) urfconrel[jj] = alpha * (Avcon[jj] + 1./3.*Erf*ptrgeom-&gt;<a class="code" href="../../dc/dd2/newcodediff_8txt.html#a98399a5a291e3844900ecfbacdcb2da0">gcon</a>[GIND(0,jj)]*(4.0*gammarel2-1.0) )/(4./3.*Erf*gammarel);</div>
<div class="line"><a name="l13917"></a><span class="lineno">13917</span>&#160;  else <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) urfconrel[jj] = 0.0;</div>
<div class="line"><a name="l13918"></a><span class="lineno">13918</span>&#160;</div>
<div class="line"><a name="l13919"></a><span class="lineno">13919</span>&#160;  dualfprintf(fail_file,&quot;NORM ROOT 4-vel: %g %g %g : %g\n&quot;,urfconrel[1],urfconrel[2],urfconrel[3],ptrgeom-&gt;gdet);</div>
<div class="line"><a name="l13920"></a><span class="lineno">13920</span>&#160;</div>
<div class="line"><a name="l13921"></a><span class="lineno">13921</span>&#160;  </div>
<div class="line"><a name="l13922"></a><span class="lineno">13922</span>&#160;  *Erfreturn=Erf; <span class="comment">// pass back new Erf to pointer</span></div>
<div class="line"><a name="l13923"></a><span class="lineno">13923</span>&#160;</div>
<div class="line"><a name="l13924"></a><span class="lineno">13924</span>&#160;</div>
<div class="line"><a name="l13925"></a><span class="lineno">13925</span>&#160;  return(0);</div>
<div class="line"><a name="l13926"></a><span class="lineno">13926</span>&#160;}</div>
<div class="line"><a name="l13927"></a><span class="lineno">13927</span>&#160;</div>
<div class="line"><a name="l13928"></a><span class="lineno">13928</span>&#160;</div>
<div class="line"><a name="l13929"></a><span class="lineno">13929</span>&#160;</div>
<div class="line"><a name="l13930"></a><span class="lineno">13930</span>&#160;</div>
<div class="line"><a name="l13931"></a><span class="lineno">13931</span>&#160;</div>
<div class="line"><a name="l13932"></a><span class="lineno">13932</span>&#160;</div>
<div class="line"><a name="l13933"></a><span class="lineno">13933</span>&#160;</div>
<div class="line"><a name="l13934"></a><span class="lineno">13934</span>&#160;</div>
<div class="line"><a name="l13935"></a><span class="lineno">13935</span>&#160;</div>
<div class="line"><a name="l13936"></a><span class="lineno">13936</span>&#160;</div>
<div class="line"><a name="l13937"></a><span class="lineno">13937</span>&#160;</div>
<div class="line"><a name="l13939"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ac417e724b77704df1dc35e32071df2f2">13939</a></span>&#160;static <span class="keywordtype">int</span> <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ac417e724b77704df1dc35e32071df2f2" title="get&#39;s gamma assuming fixed E rather than using original R^t_t that we assume is flawed near floor reg...">get_m1closure_gammarel2_cold</a>(<span class="keywordtype">int</span> showmessages, struct <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Avcon, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Avcov, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *gammarel2return, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *deltareturn, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *numeratorreturn, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *divisorreturn, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Erfreturn, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *urfconrel)</div>
<div class="line"><a name="l13940"></a><span class="lineno">13940</span>&#160;{</div>
<div class="line"><a name="l13941"></a><span class="lineno">13941</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gamma2,gammarel2,<a class="code" href="../../d9/d43/global_8variousmacros_8h.html#aa5ebb2763dd5546bc40222826cea731f">delta</a>;</div>
<div class="line"><a name="l13942"></a><span class="lineno">13942</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Erf;</div>
<div class="line"><a name="l13943"></a><span class="lineno">13943</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> alpha=ptrgeom-&gt;alphalapse;</div>
<div class="line"><a name="l13944"></a><span class="lineno">13944</span>&#160;  <span class="keywordtype">int</span> jj;</div>
<div class="line"><a name="l13945"></a><span class="lineno">13945</span>&#160;</div>
<div class="line"><a name="l13946"></a><span class="lineno">13946</span>&#160;  <span class="keyword">static</span> <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gctt, gn11, gn12,  gn13,  gn14,  gn22,  gn23,  gn24,  gn33,  gn34,  gn44,  Rtt,  Rtx,  Rty,  Rtz,  Rdtt,  Rdtx,  Rdty,  Rdtz;</div>
<div class="line"><a name="l13947"></a><span class="lineno">13947</span>&#160;  gn11=ptrgeom-&gt;gcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(0,0)];</div>
<div class="line"><a name="l13948"></a><span class="lineno">13948</span>&#160;  gn12=ptrgeom-&gt;gcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(0,1)];</div>
<div class="line"><a name="l13949"></a><span class="lineno">13949</span>&#160;  gn13=ptrgeom-&gt;gcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(0,2)];</div>
<div class="line"><a name="l13950"></a><span class="lineno">13950</span>&#160;  gn14=ptrgeom-&gt;gcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(0,3)];</div>
<div class="line"><a name="l13951"></a><span class="lineno">13951</span>&#160;  gn22=ptrgeom-&gt;gcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(1,1)];</div>
<div class="line"><a name="l13952"></a><span class="lineno">13952</span>&#160;  gn23=ptrgeom-&gt;gcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(1,2)];</div>
<div class="line"><a name="l13953"></a><span class="lineno">13953</span>&#160;  gn24=ptrgeom-&gt;gcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(1,3)];</div>
<div class="line"><a name="l13954"></a><span class="lineno">13954</span>&#160;  gn33=ptrgeom-&gt;gcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(2,2)];</div>
<div class="line"><a name="l13955"></a><span class="lineno">13955</span>&#160;  gn34=ptrgeom-&gt;gcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(2,3)];</div>
<div class="line"><a name="l13956"></a><span class="lineno">13956</span>&#160;  gn44=ptrgeom-&gt;gcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(3,3)];</div>
<div class="line"><a name="l13957"></a><span class="lineno">13957</span>&#160;</div>
<div class="line"><a name="l13958"></a><span class="lineno">13958</span>&#160;  Rtt=Avcon[0];</div>
<div class="line"><a name="l13959"></a><span class="lineno">13959</span>&#160;  Rtx=Avcon[1];</div>
<div class="line"><a name="l13960"></a><span class="lineno">13960</span>&#160;  Rty=Avcon[2];</div>
<div class="line"><a name="l13961"></a><span class="lineno">13961</span>&#160;  Rtz=Avcon[3];</div>
<div class="line"><a name="l13962"></a><span class="lineno">13962</span>&#160;</div>
<div class="line"><a name="l13963"></a><span class="lineno">13963</span>&#160;  Rdtt=Avcov[0];</div>
<div class="line"><a name="l13964"></a><span class="lineno">13964</span>&#160;  Rdtx=Avcov[1];</div>
<div class="line"><a name="l13965"></a><span class="lineno">13965</span>&#160;  Rdty=Avcov[2];</div>
<div class="line"><a name="l13966"></a><span class="lineno">13966</span>&#160;  Rdtz=Avcov[3];</div>
<div class="line"><a name="l13967"></a><span class="lineno">13967</span>&#160;</div>
<div class="line"><a name="l13968"></a><span class="lineno">13968</span>&#160;</div>
<div class="line"><a name="l13969"></a><span class="lineno">13969</span>&#160;  <span class="comment">// choose gamma</span></div>
<div class="line"><a name="l13970"></a><span class="lineno">13970</span>&#160;  <span class="keywordflow">if</span>(gammarel2return==NULL){</div>
<div class="line"><a name="l13971"></a><span class="lineno">13971</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammamax=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a51ef12e4cafc4a8fe70374c37f57d565">GAMMAMAXRAD</a>;</div>
<div class="line"><a name="l13972"></a><span class="lineno">13972</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammamaxfail=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a6be2b06c26c5422c755647ef87bdb924">GAMMAMAXRADFAIL</a>;</div>
<div class="line"><a name="l13973"></a><span class="lineno">13973</span>&#160;    gammarel2=gammamax*gammamax;</div>
<div class="line"><a name="l13974"></a><span class="lineno">13974</span>&#160;  }</div>
<div class="line"><a name="l13975"></a><span class="lineno">13975</span>&#160;  <span class="keywordflow">else</span> gammarel2=*gammarel2return; <span class="comment">// feed in desired gammarel2</span></div>
<div class="line"><a name="l13976"></a><span class="lineno">13976</span>&#160;</div>
<div class="line"><a name="l13977"></a><span class="lineno">13977</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> utsq=gammarel2/(alpha*alpha);</div>
<div class="line"><a name="l13978"></a><span class="lineno">13978</span>&#160;</div>
<div class="line"><a name="l13979"></a><span class="lineno">13979</span>&#160;</div>
<div class="line"><a name="l13980"></a><span class="lineno">13980</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Avcovorig[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>],Avconorig[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l13981"></a><span class="lineno">13981</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) Avcovorig[jj]=Avcov[jj];</div>
<div class="line"><a name="l13982"></a><span class="lineno">13982</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) Avconorig[jj]=Avcon[jj];</div>
<div class="line"><a name="l13983"></a><span class="lineno">13983</span>&#160;</div>
<div class="line"><a name="l13984"></a><span class="lineno">13984</span>&#160;  <span class="comment">// get new Avcov[0]=R^t_t</span></div>
<div class="line"><a name="l13985"></a><span class="lineno">13985</span>&#160;</div>
<div class="line"><a name="l13986"></a><span class="lineno">13986</span>&#160;  <span class="comment">// NOTEMARK: Note that Sqrt() is only ever negative when gammarel2&lt;0, so never has to be concern.</span></div>
<div class="line"><a name="l13987"></a><span class="lineno">13987</span>&#160;  Avcov[0]=(0.25*(-4.*(gn12*Rdtx + gn13*Rdty + gn14*Rdtz)*utsq*(gn11 + utsq) + </div>
<div class="line"><a name="l13988"></a><span class="lineno">13988</span>&#160;                        <a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a8666c1425b2e68a40939ca9e5fd719e5">Sqrt</a>((<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gn12,2)*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rdtx,2) + 2.*gn12*Rdtx*(gn13*Rdty + gn14*Rdtz) + <a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gn13*Rdty + gn14*Rdtz,2) - </div>
<div class="line"><a name="l13989"></a><span class="lineno">13989</span>&#160;                              1.*gn11*(gn22*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rdtx,2) + 2.*gn23*Rdtx*Rdty + gn33*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rdty,2) + 2.*gn24*Rdtx*Rdtz + 2.*gn34*Rdty*Rdtz + </div>
<div class="line"><a name="l13990"></a><span class="lineno">13990</span>&#160;                                       gn44*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rdtz,2)))*utsq*(gn11 + utsq)*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gn11 + 4.*utsq,2))))/(gn11*utsq*(gn11 + utsq));</div>
<div class="line"><a name="l13991"></a><span class="lineno">13991</span>&#160;</div>
<div class="line"><a name="l13992"></a><span class="lineno">13992</span>&#160;  Erf=(0.75*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a8666c1425b2e68a40939ca9e5fd719e5">Sqrt</a>((<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gn12,2)*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rdtx,2) + 2.*gn12*Rdtx*(gn13*Rdty + gn14*Rdtz) + <a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gn13*Rdty + gn14*Rdtz,2) - </div>
<div class="line"><a name="l13993"></a><span class="lineno">13993</span>&#160;                           1.*gn11*(gn22*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rdtx,2) + 2.*gn23*Rdtx*Rdty + gn33*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rdty,2) + 2.*gn24*Rdtx*Rdtz + 2.*gn34*Rdty*Rdtz + </div>
<div class="line"><a name="l13994"></a><span class="lineno">13994</span>&#160;                                    gn44*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rdtz,2)))*utsq*(gn11 + utsq)*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gn11 + 4.*utsq,2)))/(utsq*(gn11 + utsq)*(gn11 + 4.*utsq));</div>
<div class="line"><a name="l13995"></a><span class="lineno">13995</span>&#160;</div>
<div class="line"><a name="l13996"></a><span class="lineno">13996</span>&#160;  <span class="keywordflow">if</span>(0&amp;&amp;showmessages &amp;&amp; debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;NOR SOL: Avcov0new=%g Avcov0old=%g Erf=%g :: %g %g %g\n&quot;</span>,Avcov[0],Avcovorig[0],Erf,Rtx,Rty,Rtz);</div>
<div class="line"><a name="l13997"></a><span class="lineno">13997</span>&#160;</div>
<div class="line"><a name="l13998"></a><span class="lineno">13998</span>&#160;  <span class="comment">//modify Avcon</span></div>
<div class="line"><a name="l13999"></a><span class="lineno">13999</span>&#160;  indices_12(Avcov,Avcon,ptrgeom);</div>
<div class="line"><a name="l14000"></a><span class="lineno">14000</span>&#160;  <span class="keywordflow">if</span>(0&amp;&amp;showmessages &amp;&amp; debugfail&gt;=2) <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) dualfprintf(fail_file,<span class="stringliteral">&quot;jj=%d Avconorig=%g Avconnew=%g\n&quot;</span>,jj,Avconorig[jj],Avcon[jj]);</div>
<div class="line"><a name="l14001"></a><span class="lineno">14001</span>&#160;</div>
<div class="line"><a name="l14002"></a><span class="lineno">14002</span>&#160; </div>
<div class="line"><a name="l14003"></a><span class="lineno">14003</span>&#160;  delta=0; <span class="comment">// not yet</span></div>
<div class="line"><a name="l14004"></a><span class="lineno">14004</span>&#160;</div>
<div class="line"><a name="l14005"></a><span class="lineno">14005</span>&#160;  <span class="keywordflow">if</span>(0&amp;&amp;showmessages &amp;&amp; debugfail&gt;=2){</div>
<div class="line"><a name="l14006"></a><span class="lineno">14006</span>&#160;    <span class="comment">// alt solution</span></div>
<div class="line"><a name="l14007"></a><span class="lineno">14007</span>&#160;</div>
<div class="line"><a name="l14008"></a><span class="lineno">14008</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Avcovalt = (-0.25*(4.*(gn12*Rdtx + gn13*Rdty + gn14*Rdtz)*utsq*(gn11 + utsq) + </div>
<div class="line"><a name="l14009"></a><span class="lineno">14009</span>&#160;       <a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a8666c1425b2e68a40939ca9e5fd719e5">Sqrt</a>((<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gn12,2)*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rdtx,2) + 2.*gn12*Rdtx*(gn13*Rdty + gn14*Rdtz) + <a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gn13*Rdty + gn14*Rdtz,2) - </div>
<div class="line"><a name="l14010"></a><span class="lineno">14010</span>&#160;           1.*gn11*(gn22*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rdtx,2) + 2.*gn23*Rdtx*Rdty + gn33*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rdty,2) + 2.*gn24*Rdtx*Rdtz + 2.*gn34*Rdty*Rdtz + </div>
<div class="line"><a name="l14011"></a><span class="lineno">14011</span>&#160;                    gn44*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rdtz,2)))*utsq*(gn11 + utsq)*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gn11 + 4.*utsq,2))))/(gn11*utsq*(gn11 + utsq));</div>
<div class="line"><a name="l14012"></a><span class="lineno">14012</span>&#160;    </div>
<div class="line"><a name="l14013"></a><span class="lineno">14013</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Erfalt=(-0.75*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a8666c1425b2e68a40939ca9e5fd719e5">Sqrt</a>((<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gn12,2)*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rdtx,2) + 2.*gn12*Rdtx*(gn13*Rdty + gn14*Rdtz) + <a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gn13*Rdty + gn14*Rdtz,2) - </div>
<div class="line"><a name="l14014"></a><span class="lineno">14014</span>&#160;                        1.*gn11*(gn22*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rdtx,2) + 2.*gn23*Rdtx*Rdty + gn33*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rdty,2) + 2.*gn24*Rdtx*Rdtz + 2.*gn34*Rdty*Rdtz + </div>
<div class="line"><a name="l14015"></a><span class="lineno">14015</span>&#160;                  gn44*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(Rdtz,2)))*utsq*(gn11 + utsq)*<a class="code" href="../../df/d8d/koral_8mdefs_8h.html#a4846748f031c2918198ae7ed187138f5">Power</a>(gn11 + 4.*utsq,2)))/(utsq*(gn11 + utsq)*(gn11 + 4.*utsq));</div>
<div class="line"><a name="l14016"></a><span class="lineno">14016</span>&#160;</div>
<div class="line"><a name="l14017"></a><span class="lineno">14017</span>&#160;    <span class="keywordflow">if</span>(showmessages &amp;&amp; debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;ALT SOL: Avcovalt=%g Avcov0old=%g Erfalt=%g : %g %g %g\n&quot;</span>,Avcovalt,Avcovorig[0],Erfalt,Rdtx,Rdty,Rdtz);</div>
<div class="line"><a name="l14018"></a><span class="lineno">14018</span>&#160;  }</div>
<div class="line"><a name="l14019"></a><span class="lineno">14019</span>&#160;</div>
<div class="line"><a name="l14020"></a><span class="lineno">14020</span>&#160;</div>
<div class="line"><a name="l14021"></a><span class="lineno">14021</span>&#160;  *gammarel2return=gammarel2;</div>
<div class="line"><a name="l14022"></a><span class="lineno">14022</span>&#160;  *deltareturn=<a class="code" href="../../d9/d43/global_8variousmacros_8h.html#aa5ebb2763dd5546bc40222826cea731f">delta</a>;</div>
<div class="line"><a name="l14023"></a><span class="lineno">14023</span>&#160;</div>
<div class="line"><a name="l14024"></a><span class="lineno">14024</span>&#160;  <span class="comment">// get good relative velocity</span></div>
<div class="line"><a name="l14025"></a><span class="lineno">14025</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammarel=sqrt(gammarel2);</div>
<div class="line"><a name="l14026"></a><span class="lineno">14026</span>&#160;</div>
<div class="line"><a name="l14027"></a><span class="lineno">14027</span>&#160;  <span class="comment">// get relative 4-velocity</span></div>
<div class="line"><a name="l14028"></a><span class="lineno">14028</span>&#160;  <span class="keywordflow">if</span>(Erf&gt;0.0) <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) urfconrel[jj] = alpha * (Avcon[jj] + 1./3.*Erf*ptrgeom-&gt;gcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(0,jj)]*(4.0*gammarel2-1.0) )/(4./3.*Erf*gammarel);</div>
<div class="line"><a name="l14029"></a><span class="lineno">14029</span>&#160;  <span class="keywordflow">else</span> <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) urfconrel[jj] = 0.0;</div>
<div class="line"><a name="l14030"></a><span class="lineno">14030</span>&#160;</div>
<div class="line"><a name="l14031"></a><span class="lineno">14031</span>&#160;  <span class="keywordflow">if</span>(0&amp;&amp;showmessages &amp;&amp; debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;NORM ROOT 4-vel: %g %g %g : %g\n&quot;</span>,urfconrel[1],urfconrel[2],urfconrel[3],ptrgeom-&gt;gdet);</div>
<div class="line"><a name="l14032"></a><span class="lineno">14032</span>&#160;</div>
<div class="line"><a name="l14033"></a><span class="lineno">14033</span>&#160;  </div>
<div class="line"><a name="l14034"></a><span class="lineno">14034</span>&#160;  *Erfreturn=Erf; <span class="comment">// pass back new Erf to pointer</span></div>
<div class="line"><a name="l14035"></a><span class="lineno">14035</span>&#160;</div>
<div class="line"><a name="l14036"></a><span class="lineno">14036</span>&#160;</div>
<div class="line"><a name="l14037"></a><span class="lineno">14037</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l14038"></a><span class="lineno">14038</span>&#160;}</div>
<div class="line"><a name="l14039"></a><span class="lineno">14039</span>&#160;</div>
<div class="line"><a name="l14040"></a><span class="lineno">14040</span>&#160;</div>
<div class="line"><a name="l14041"></a><span class="lineno">14041</span>&#160;</div>
<div class="line"><a name="l14042"></a><span class="lineno">14042</span>&#160;</div>
<div class="line"><a name="l14043"></a><span class="lineno">14043</span>&#160;</div>
<div class="line"><a name="l14044"></a><span class="lineno">14044</span>&#160;</div>
<div class="line"><a name="l14045"></a><span class="lineno">14045</span>&#160;</div>
<div class="line"><a name="l14046"></a><span class="lineno">14046</span>&#160;</div>
<div class="line"><a name="l14047"></a><span class="lineno">14047</span>&#160;</div>
<div class="line"><a name="l14048"></a><span class="lineno">14048</span>&#160;</div>
<div class="line"><a name="l14049"></a><span class="lineno">14049</span>&#160;</div>
<div class="line"><a name="l14050"></a><span class="lineno">14050</span>&#160;</div>
<div class="line"><a name="l14051"></a><span class="lineno">14051</span>&#160;</div>
<div class="line"><a name="l14052"></a><span class="lineno">14052</span>&#160;</div>
<div class="line"><a name="l14053"></a><span class="lineno">14053</span>&#160;</div>
<div class="line"><a name="l14054"></a><span class="lineno">14054</span>&#160;</div>
<div class="line"><a name="l14055"></a><span class="lineno">14055</span>&#160;</div>
<div class="line"><a name="l14056"></a><span class="lineno">14056</span>&#160;</div>
<div class="line"><a name="l14057"></a><span class="lineno">14057</span>&#160;</div>
<div class="line"><a name="l14058"></a><span class="lineno">14058</span>&#160;</div>
<div class="line"><a name="l14059"></a><span class="lineno">14059</span>&#160;</div>
<div class="line"><a name="l14060"></a><span class="lineno">14060</span>&#160;</div>
<div class="line"><a name="l14061"></a><span class="lineno">14061</span>&#160;</div>
<div class="line"><a name="l14062"></a><span class="lineno">14062</span>&#160;</div>
<div class="line"><a name="l14063"></a><span class="lineno">14063</span>&#160;</div>
<div class="line"><a name="l14064"></a><span class="lineno">14064</span>&#160;</div>
<div class="line"><a name="l14065"></a><span class="lineno">14065</span>&#160;</div>
<div class="line"><a name="l14066"></a><span class="lineno">14066</span>&#160;</div>
<div class="line"><a name="l14067"></a><span class="lineno">14067</span>&#160;</div>
<div class="line"><a name="l14068"></a><span class="lineno">14068</span>&#160;</div>
<div class="line"><a name="l14069"></a><span class="lineno">14069</span>&#160;</div>
<div class="line"><a name="l14070"></a><span class="lineno">14070</span>&#160;</div>
<div class="line"><a name="l14071"></a><span class="lineno">14071</span>&#160;</div>
<div class="line"><a name="l14072"></a><span class="lineno">14072</span>&#160;</div>
<div class="line"><a name="l14073"></a><span class="lineno">14073</span>&#160;</div>
<div class="line"><a name="l14074"></a><span class="lineno">14074</span>&#160;</div>
<div class="line"><a name="l14076"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a795959353203e99366b456b16d0d0bab">14076</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a795959353203e99366b456b16d0d0bab" title="calculates total opacity over dx[] for given chi or chieff">calc_tautot_chieff</a>(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pp, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> chi, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *q, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *tautot, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *tautotmax)</div>
<div class="line"><a name="l14077"></a><span class="lineno">14077</span>&#160;{</div>
<div class="line"><a name="l14078"></a><span class="lineno">14078</span>&#160;  <span class="comment">//xx[0] holds time</span></div>
<div class="line"><a name="l14079"></a><span class="lineno">14079</span>&#160;  <span class="keywordtype">int</span> NxNOT1[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>]={0,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a51b48b29d7903bb94a3d7879c3ff8eb9">N1NOT1</a>,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9d8b7e3d088c68f51e7b29b95326a4ac">N2NOT1</a>,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#aabbd6bada71f73d78d57d14e9adc0c29">N3NOT1</a>}; <span class="comment">// want to ignore non-used dimensions</span></div>
<div class="line"><a name="l14080"></a><span class="lineno">14080</span>&#160; </div>
<div class="line"><a name="l14081"></a><span class="lineno">14081</span>&#160;</div>
<div class="line"><a name="l14082"></a><span class="lineno">14082</span>&#160;  <span class="comment">// see averyboost.nb</span></div>
<div class="line"><a name="l14083"></a><span class="lineno">14083</span>&#160;  <span class="comment">// dtau^jj = chi dxff^jj = chi dxlab^jj (1+\gamma - \gamma vjj^2)/(1+\gamma+vjj+\gamma vjj)</span></div>
<div class="line"><a name="l14084"></a><span class="lineno">14084</span>&#160;  <span class="comment">// = chi dxlab^jj (\gamma + \gamma^2 - ux^2)/( (1+\gamma)*(\gamma+ux) )</span></div>
<div class="line"><a name="l14085"></a><span class="lineno">14085</span>&#160;  <span class="keywordtype">int</span> jj;</div>
<div class="line"><a name="l14086"></a><span class="lineno">14086</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dxorthoff[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l14087"></a><span class="lineno">14087</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> orthofactor[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l14088"></a><span class="lineno">14088</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ujj,gamma;</div>
<div class="line"><a name="l14089"></a><span class="lineno">14089</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ujjsq,gammasq;</div>
<div class="line"><a name="l14090"></a><span class="lineno">14090</span>&#160;  *tautotmax=0.0;</div>
<div class="line"><a name="l14091"></a><span class="lineno">14091</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> top,bottom;</div>
<div class="line"><a name="l14092"></a><span class="lineno">14092</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj){</div>
<div class="line"><a name="l14093"></a><span class="lineno">14093</span>&#160;    </div>
<div class="line"><a name="l14094"></a><span class="lineno">14094</span>&#160;    <span class="comment">//    orthofactor[jj] = 1.0/sqrt(fabs(ptrgeom-&gt;gcon[GIND(jj,jj)]));</span></div>
<div class="line"><a name="l14095"></a><span class="lineno">14095</span>&#160; </div>
<div class="line"><a name="l14096"></a><span class="lineno">14096</span>&#160;    <span class="comment">// NOTEMARK: only approximate near a rotating BH</span></div>
<div class="line"><a name="l14097"></a><span class="lineno">14097</span>&#160;    <span class="comment">//    ujj = q-&gt;ucon[jj]*orthofactor[jj];</span></div>
<div class="line"><a name="l14098"></a><span class="lineno">14098</span>&#160;    <span class="comment">// NOTEMARK: only approximate near a rotating BH</span></div>
<div class="line"><a name="l14099"></a><span class="lineno">14099</span>&#160;    <span class="comment">//    gamma = q-&gt;ucon[TT]*orthofactor[jj]; // as if *ptrgeom-&gt;alphalapse</span></div>
<div class="line"><a name="l14100"></a><span class="lineno">14100</span>&#160;    <span class="comment">// need gamma&gt;|ujj| always, but if mixing ZAMO and lab, won&#39;t be true necessarily.</span></div>
<div class="line"><a name="l14101"></a><span class="lineno">14101</span>&#160;    <span class="comment">// need ujj-&gt;0 to imply gamma-&gt;1 if other directions have u_{perp jj}=0, so should really use ujj as utilde^jj, but then not really correct ff-&gt;lab conversion if using gamma for relative to ZAMO</span></div>
<div class="line"><a name="l14102"></a><span class="lineno">14102</span>&#160;</div>
<div class="line"><a name="l14103"></a><span class="lineno">14103</span>&#160;    <span class="keywordflow">if</span>(q!=NULL){</div>
<div class="line"><a name="l14104"></a><span class="lineno">14104</span>&#160;      ujjsq = fabs(q-&gt;<a class="code" href="../../d1/d83/structof__state.html#aab723d3c7c2c48b7246cc7d7d5379eed">ucon</a>[jj]*q-&gt;<a class="code" href="../../d1/d83/structof__state.html#a09881c3d05809ef27f8115d02a835e11">ucov</a>[jj]); <span class="comment">// because true -1 = u^t u_t + u^r u_r + u^h u_h + u^p u_p</span></div>
<div class="line"><a name="l14105"></a><span class="lineno">14105</span>&#160;      ujj = sqrt(ujjsq); <span class="comment">//sign(q-&gt;ucon[jj])*</span></div>
<div class="line"><a name="l14106"></a><span class="lineno">14106</span>&#160;</div>
<div class="line"><a name="l14107"></a><span class="lineno">14107</span>&#160;      gammasq = fabs(-q-&gt;<a class="code" href="../../d1/d83/structof__state.html#aab723d3c7c2c48b7246cc7d7d5379eed">ucon</a>[TT]*q-&gt;<a class="code" href="../../d1/d83/structof__state.html#a09881c3d05809ef27f8115d02a835e11">ucov</a>[TT]);</div>
<div class="line"><a name="l14108"></a><span class="lineno">14108</span>&#160;      gammasq = <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(1.0,gammasq); <span class="comment">// for near the rotating BH since not doing true orthonormal fluid frame.</span></div>
<div class="line"><a name="l14109"></a><span class="lineno">14109</span>&#160;      gamma = sqrt(gammasq);</div>
<div class="line"><a name="l14110"></a><span class="lineno">14110</span>&#160;</div>
<div class="line"><a name="l14111"></a><span class="lineno">14111</span>&#160;</div>
<div class="line"><a name="l14112"></a><span class="lineno">14112</span>&#160;      top=gamma + <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(1.0,gammasq - ujjsq);</div>
<div class="line"><a name="l14113"></a><span class="lineno">14113</span>&#160;      top=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(top,2.0); <span class="comment">// numerator can be no smaller than 2</span></div>
<div class="line"><a name="l14114"></a><span class="lineno">14114</span>&#160;</div>
<div class="line"><a name="l14115"></a><span class="lineno">14115</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> vjj = ujj/gamma;</div>
<div class="line"><a name="l14116"></a><span class="lineno">14116</span>&#160;      vjj = <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(1.0,vjj);</div>
<div class="line"><a name="l14117"></a><span class="lineno">14117</span>&#160;      bottom = (1.0+gamma)*gamma*(1.0+vjj); <span class="comment">// ranges from 2 through infinity.  vjj cannot be negative, as that would be a different Lorentz boost the wrong way.</span></div>
<div class="line"><a name="l14118"></a><span class="lineno">14118</span>&#160;      bottom = <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(2.0,bottom);</div>
<div class="line"><a name="l14119"></a><span class="lineno">14119</span>&#160;</div>
<div class="line"><a name="l14120"></a><span class="lineno">14120</span>&#160;    }</div>
<div class="line"><a name="l14121"></a><span class="lineno">14121</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l14122"></a><span class="lineno">14122</span>&#160;      <span class="comment">// assume for cases when high accuracy not required, like shock detector</span></div>
<div class="line"><a name="l14123"></a><span class="lineno">14123</span>&#160;      top=1.0;</div>
<div class="line"><a name="l14124"></a><span class="lineno">14124</span>&#160;      bottom=top;</div>
<div class="line"><a name="l14125"></a><span class="lineno">14125</span>&#160;    }</div>
<div class="line"><a name="l14126"></a><span class="lineno">14126</span>&#160;</div>
<div class="line"><a name="l14127"></a><span class="lineno">14127</span>&#160;    dxorthoff[jj] = (<a class="code" href="../../d8/d5b/defs_8general_8h.html#a99b91d8e229e5df70958f2aed7fd15bf">dx</a>[jj]*orthofactor[jj]) * (top/bottom);</div>
<div class="line"><a name="l14128"></a><span class="lineno">14128</span>&#160;    tautot[jj]=chi * dxorthoff[jj];</div>
<div class="line"><a name="l14129"></a><span class="lineno">14129</span>&#160;</div>
<div class="line"><a name="l14130"></a><span class="lineno">14130</span>&#160;    *tautotmax=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(*tautotmax,tautot[jj]*NxNOT1[jj]);</div>
<div class="line"><a name="l14131"></a><span class="lineno">14131</span>&#160;  }</div>
<div class="line"><a name="l14132"></a><span class="lineno">14132</span>&#160;</div>
<div class="line"><a name="l14133"></a><span class="lineno">14133</span>&#160;  <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l14134"></a><span class="lineno">14134</span>&#160;}</div>
<div class="line"><a name="l14135"></a><span class="lineno">14135</span>&#160;</div>
<div class="line"><a name="l14136"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ad6748b88a3ad397cb35b4d60c108508d">14136</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#ad6748b88a3ad397cb35b4d60c108508d">calcfull_tautot</a>(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pp, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *tautot, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *tautotmax)</div>
<div class="line"><a name="l14137"></a><span class="lineno">14137</span>&#160;{</div>
<div class="line"><a name="l14138"></a><span class="lineno">14138</span>&#160;</div>
<div class="line"><a name="l14139"></a><span class="lineno">14139</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> q;</div>
<div class="line"><a name="l14140"></a><span class="lineno">14140</span>&#160;  <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a11e17cd8b0594d1ad52e3594aa9f477e" title="find ucon, ucov, bcon, bcov from primitive variables when calling get_state, users of this function e...">get_state</a>(pp, ptrgeom, &amp;q);</div>
<div class="line"><a name="l14141"></a><span class="lineno">14141</span>&#160;  <a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#a5943065ab3d5b4e9f4f691db499b588f" title="calculates total opacity over dx[]">calc_tautot</a>(pp, ptrgeom, &amp;q, tautot, tautotmax);</div>
<div class="line"><a name="l14142"></a><span class="lineno">14142</span>&#160;</div>
<div class="line"><a name="l14143"></a><span class="lineno">14143</span>&#160;  <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l14144"></a><span class="lineno">14144</span>&#160;</div>
<div class="line"><a name="l14145"></a><span class="lineno">14145</span>&#160;}</div>
<div class="line"><a name="l14147"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a5943065ab3d5b4e9f4f691db499b588f">14147</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#a5943065ab3d5b4e9f4f691db499b588f" title="calculates total opacity over dx[]">calc_tautot</a>(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pp, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *q, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *tautot, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *tautotmax)</div>
<div class="line"><a name="l14148"></a><span class="lineno">14148</span>&#160;{</div>
<div class="line"><a name="l14149"></a><span class="lineno">14149</span>&#160;  <span class="comment">//xx[0] holds time</span></div>
<div class="line"><a name="l14150"></a><span class="lineno">14150</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> kappa,kappaes,chi;</div>
<div class="line"><a name="l14151"></a><span class="lineno">14151</span>&#160;  calc_kappa(pp,ptrgeom,q,&amp;kappa);</div>
<div class="line"><a name="l14152"></a><span class="lineno">14152</span>&#160;  calc_kappaes(pp,ptrgeom,&amp;kappaes);</div>
<div class="line"><a name="l14153"></a><span class="lineno">14153</span>&#160;  chi=kappa+kappaes;</div>
<div class="line"><a name="l14154"></a><span class="lineno">14154</span>&#160;</div>
<div class="line"><a name="l14155"></a><span class="lineno">14155</span>&#160;  <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a795959353203e99366b456b16d0d0bab" title="calculates total opacity over dx[] for given chi or chieff">calc_tautot_chieff</a>(pp,chi,ptrgeom,q,tautot,tautotmax);</div>
<div class="line"><a name="l14156"></a><span class="lineno">14156</span>&#160;</div>
<div class="line"><a name="l14157"></a><span class="lineno">14157</span>&#160;  <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l14158"></a><span class="lineno">14158</span>&#160;}</div>
<div class="line"><a name="l14159"></a><span class="lineno">14159</span>&#160;</div>
<div class="line"><a name="l14160"></a><span class="lineno">14160</span>&#160;</div>
<div class="line"><a name="l14161"></a><span class="lineno">14161</span>&#160;</div>
<div class="line"><a name="l14162"></a><span class="lineno">14162</span>&#160;</div>
<div class="line"><a name="l14163"></a><span class="lineno">14163</span>&#160;</div>
<div class="line"><a name="l14164"></a><span class="lineno">14164</span>&#160;</div>
<div class="line"><a name="l14166"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#ac4180f48800f1cd9af2db1ae9b602cde">14166</a></span>&#160;<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> <a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#a1c7052b05f1c8206988b52c760b2e4af" title="suplementary routines for conversions">calc_PEQ_ufromTrho</a>(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> T,<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> rho)</div>
<div class="line"><a name="l14167"></a><span class="lineno">14167</span>&#160;{</div>
<div class="line"><a name="l14168"></a><span class="lineno">14168</span>&#160;  <span class="comment">// if use local function function instead of below directly,</span></div>
<div class="line"><a name="l14169"></a><span class="lineno">14169</span>&#160;  <span class="comment">// then assume user doesn&#39;t care about position for EOS.</span></div>
<div class="line"><a name="l14170"></a><span class="lineno">14170</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> u=u_rho0_T_simple(0, 0, 0, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8936711f57f82d1fc75c21fa2894e1c6">CENT</a>, rho, T);</div>
<div class="line"><a name="l14171"></a><span class="lineno">14171</span>&#160;  <span class="keywordflow">return</span> u;</div>
<div class="line"><a name="l14172"></a><span class="lineno">14172</span>&#160;}</div>
<div class="line"><a name="l14173"></a><span class="lineno">14173</span>&#160;</div>
<div class="line"><a name="l14174"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa33dde696e2b53f39a13b5137633aca4">14174</a></span>&#160;<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> <a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#ae2fe1c6debba576d29c23100d4e30704">calc_PEQ_Tfromurho</a>(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> u,<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> rho)</div>
<div class="line"><a name="l14175"></a><span class="lineno">14175</span>&#160;{</div>
<div class="line"><a name="l14176"></a><span class="lineno">14176</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> T=compute_temp_simple(0, 0, 0, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8936711f57f82d1fc75c21fa2894e1c6">CENT</a>, rho, u);</div>
<div class="line"><a name="l14177"></a><span class="lineno">14177</span>&#160;  <span class="keywordflow">return</span> T;</div>
<div class="line"><a name="l14178"></a><span class="lineno">14178</span>&#160;}</div>
<div class="line"><a name="l14179"></a><span class="lineno">14179</span>&#160;</div>
<div class="line"><a name="l14181"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a80530d8064fc77f8dc0edae620c078ec">14181</a></span>&#160;<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> <a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#a0fb687f68b97453843fc3c085f05f1b4" title="E=urad=arad T^4 (this is LTE only if put in T was gas T)">calc_LTE_EfromT</a>(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> T)</div>
<div class="line"><a name="l14182"></a><span class="lineno">14182</span>&#160;{</div>
<div class="line"><a name="l14183"></a><span class="lineno">14183</span>&#160;  <span class="comment">//  return 4.*SIGMA_RAD*T*T*T*T;</span></div>
<div class="line"><a name="l14184"></a><span class="lineno">14184</span>&#160;  <span class="keywordflow">return</span> (<a class="code" href="../../d8/d5b/defs_8general_8h.html#a591d275f967baa00b6382aff77362636">ARAD_CODE</a>*T*T*T*T);</div>
<div class="line"><a name="l14185"></a><span class="lineno">14185</span>&#160;}</div>
<div class="line"><a name="l14186"></a><span class="lineno">14186</span>&#160;</div>
<div class="line"><a name="l14188"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a7dc2e853cec9b6f9a5e83ce23c468d03">14188</a></span>&#160;<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> <a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#a7dc2e853cec9b6f9a5e83ce23c468d03" title="nrad(T) = nrad=arad T^3/2.70118 (this is LTE only if put in T was gas T)">calc_LTE_NfromT</a>(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> T)</div>
<div class="line"><a name="l14189"></a><span class="lineno">14189</span>&#160;{</div>
<div class="line"><a name="l14190"></a><span class="lineno">14190</span>&#160;  <span class="keywordflow">return</span> (<a class="code" href="../../d8/d5b/defs_8general_8h.html#a591d275f967baa00b6382aff77362636">ARAD_CODE</a>*T*T*T/<a class="code" href="../../da/d04/global_8depmnemonics_8rad_8h.html#a0f38d83a4a498cf6f9c2897f3eb6f1e8">EBAR0</a>); <span class="comment">// i.e. average energy per photon is 2.7k_b T</span></div>
<div class="line"><a name="l14191"></a><span class="lineno">14191</span>&#160;}</div>
<div class="line"><a name="l14192"></a><span class="lineno">14192</span>&#160;</div>
<div class="line"><a name="l14194"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a3e47afcfc5c42719999d851395fd032d">14194</a></span>&#160;<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> <a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#a3e47afcfc5c42719999d851395fd032d" title="nrad(E)">calc_LTE_NfromE</a>(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> <a class="code" href="../../d8/d60/init_8c.html#a07484107e6d9fdf38b53edf631d6511d">E</a>)</div>
<div class="line"><a name="l14195"></a><span class="lineno">14195</span>&#160;{</div>
<div class="line"><a name="l14196"></a><span class="lineno">14196</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> T=<a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#af07558357c906b4dfa61cd34656d9f02" title="E=urad=arad T^4 and just solve for T (this is LTE only if assume resulting T is gas T)...">calc_LTE_TfromE</a>(E);</div>
<div class="line"><a name="l14197"></a><span class="lineno">14197</span>&#160;  <span class="keywordflow">return</span>(<a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#a7dc2e853cec9b6f9a5e83ce23c468d03" title="nrad(T) = nrad=arad T^3/2.70118 (this is LTE only if put in T was gas T)">calc_LTE_NfromT</a>(T));</div>
<div class="line"><a name="l14198"></a><span class="lineno">14198</span>&#160;}</div>
<div class="line"><a name="l14199"></a><span class="lineno">14199</span>&#160;</div>
<div class="line"><a name="l14201"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a3ac7ce6f20b85202b3a9f23e26ce64ae">14201</a></span>&#160;<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> <a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#af07558357c906b4dfa61cd34656d9f02" title="E=urad=arad T^4 and just solve for T (this is LTE only if assume resulting T is gas T)...">calc_LTE_TfromE</a>(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> <a class="code" href="../../d8/d60/init_8c.html#a07484107e6d9fdf38b53edf631d6511d">E</a> )</div>
<div class="line"><a name="l14202"></a><span class="lineno">14202</span>&#160;{</div>
<div class="line"><a name="l14203"></a><span class="lineno">14203</span>&#160;  <span class="comment">//  return sqrt(sqrt((E/4./SIGMA_RAD)));</span></div>
<div class="line"><a name="l14204"></a><span class="lineno">14204</span>&#160;  <span class="keywordflow">return</span> (sqrt(sqrt((E/(SMALL+<a class="code" href="../../d8/d5b/defs_8general_8h.html#a591d275f967baa00b6382aff77362636">ARAD_CODE</a>)))));</div>
<div class="line"><a name="l14205"></a><span class="lineno">14205</span>&#160;}</div>
<div class="line"><a name="l14206"></a><span class="lineno">14206</span>&#160;</div>
<div class="line"><a name="l14208"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a16de7a292f454ba565392841710ace58">14208</a></span>&#160;<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> <a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#a922d3fe2d1de331e41f5c2e561976d39" title="This will really give back only LTE E.">calc_LTE_Efromurho</a>(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> u,<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> rho)</div>
<div class="line"><a name="l14209"></a><span class="lineno">14209</span>&#160;{</div>
<div class="line"><a name="l14210"></a><span class="lineno">14210</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> T=compute_temp_simple(0, 0, 0, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8936711f57f82d1fc75c21fa2894e1c6">CENT</a>, rho, u);</div>
<div class="line"><a name="l14211"></a><span class="lineno">14211</span>&#160;  <span class="keywordflow">return</span> (<a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#a0fb687f68b97453843fc3c085f05f1b4" title="E=urad=arad T^4 (this is LTE only if put in T was gas T)">calc_LTE_EfromT</a>(T));</div>
<div class="line"><a name="l14212"></a><span class="lineno">14212</span>&#160;}</div>
<div class="line"><a name="l14213"></a><span class="lineno">14213</span>&#160;</div>
<div class="line"><a name="l14214"></a><span class="lineno">14214</span>&#160;</div>
<div class="line"><a name="l14215"></a><span class="lineno">14215</span>&#160;</div>
<div class="line"><a name="l14217"></a><span class="lineno"><a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#aa8edd5fc0afc1713ad401c2db92c71e0">14217</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#aa8edd5fc0afc1713ad401c2db92c71e0" title="set velocity based upon ncon and gammamax and return in whichvel format for the ptrgeom geometry/coor...">set_ncon_velocity</a>(<span class="keywordtype">int</span> whichvel, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammamax, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *ncon, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *uconwhichvel)</div>
<div class="line"><a name="l14218"></a><span class="lineno">14218</span>&#160;{</div>
<div class="line"><a name="l14219"></a><span class="lineno">14219</span>&#160;  <span class="keywordtype">int</span> ii,jj;</div>
<div class="line"><a name="l14220"></a><span class="lineno">14220</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ncondefault[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>]={0.0,-1.0, 0.0, 0.0}; <span class="comment">//for radially flowing photons</span></div>
<div class="line"><a name="l14221"></a><span class="lineno">14221</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *nconuse;</div>
<div class="line"><a name="l14222"></a><span class="lineno">14222</span>&#160;</div>
<div class="line"><a name="l14223"></a><span class="lineno">14223</span>&#160;  <span class="comment">// default is radial motion in zamo frame</span></div>
<div class="line"><a name="l14224"></a><span class="lineno">14224</span>&#160;  <span class="keywordflow">if</span>(ncon==NULL) nconuse=ncondefault;</div>
<div class="line"><a name="l14225"></a><span class="lineno">14225</span>&#160;  <span class="keywordflow">else</span> nconuse=ncon;</div>
<div class="line"><a name="l14226"></a><span class="lineno">14226</span>&#160;</div>
<div class="line"><a name="l14227"></a><span class="lineno">14227</span>&#160;  <span class="comment">// compute \gammarel using nconuse</span></div>
<div class="line"><a name="l14228"></a><span class="lineno">14228</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammatemp,qsq;</div>
<div class="line"><a name="l14229"></a><span class="lineno">14229</span>&#160;  <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#abfae38e47b0bd05a4fc38302ff948a96" title="find gamma-factor wrt normal observer This function and qsq_calc() have about the same cache miss amo...">gamma_calc_fromuconrel</a>(nconuse,ptrgeom,&amp;gammatemp,&amp;qsq);</div>
<div class="line"><a name="l14230"></a><span class="lineno">14230</span>&#160;</div>
<div class="line"><a name="l14231"></a><span class="lineno">14231</span>&#160;  <span class="comment">// now rescale nconuse[i] so will give desired \gammamax</span></div>
<div class="line"><a name="l14232"></a><span class="lineno">14232</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> prtemp[NPR];</div>
<div class="line"><a name="l14233"></a><span class="lineno">14233</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(ii) prtemp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>+ii-1] = nconuse[ii]*(gammamax/gammatemp);</div>
<div class="line"><a name="l14234"></a><span class="lineno">14234</span>&#160;</div>
<div class="line"><a name="l14235"></a><span class="lineno">14235</span>&#160;  <span class="comment">// now get u^\mu[lab]</span></div>
<div class="line"><a name="l14236"></a><span class="lineno">14236</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> uconlab[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l14237"></a><span class="lineno">14237</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> <a class="code" href="../../d1/d83/structof__state.html#aad8be02577d0aa545b36e596e8b50ee9">others</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a266c1c3ab2959dbfc603c7d3f12783fb" title="strict limit (doesn&#39;t work in general)">NUMOTHERSTATERESULTS</a>];</div>
<div class="line"><a name="l14238"></a><span class="lineno">14238</span>&#160;  <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a35c4399eb86e3fa77e2221000e077572">ucon_calc_whichvel</a>(<a class="code" href="../../da/d3e/definit_8h.html#a3d14480f30d39eff4e51ae8bc93df56f" title="whether we use ultimately precise inversion or &quot;workable&quot; inversion precision (see utoprim&#39;s for ho...">WHICHVEL</a>,prtemp,ptrgeom,uconlab,others);</div>
<div class="line"><a name="l14239"></a><span class="lineno">14239</span>&#160;</div>
<div class="line"><a name="l14240"></a><span class="lineno">14240</span>&#160;  <span class="comment">// now get other whichvel type</span></div>
<div class="line"><a name="l14241"></a><span class="lineno">14241</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> prtemp2[NPR];</div>
<div class="line"><a name="l14242"></a><span class="lineno">14242</span>&#160;  ucon2pr(whichvel,uconlab,ptrgeom,prtemp2);</div>
<div class="line"><a name="l14243"></a><span class="lineno">14243</span>&#160;</div>
<div class="line"><a name="l14244"></a><span class="lineno">14244</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) uconwhichvel[jj] = prtemp2[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>+jj-1];</div>
<div class="line"><a name="l14245"></a><span class="lineno">14245</span>&#160;</div>
<div class="line"><a name="l14246"></a><span class="lineno">14246</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l14247"></a><span class="lineno">14247</span>&#160;</div>
<div class="line"><a name="l14248"></a><span class="lineno">14248</span>&#160;}</div>
<div class="line"><a name="l14249"></a><span class="lineno">14249</span>&#160;</div>
<div class="line"><a name="l14250"></a><span class="lineno">14250</span>&#160;</div>
<div class="line"><a name="l14251"></a><span class="lineno">14251</span>&#160;</div>
<div class="line"><a name="l14252"></a><span class="lineno">14252</span>&#160;<span class="comment">//#include &quot;phys.tools.rad.notused.c&quot;</span></div>
<div class="line"><a name="l14253"></a><span class="lineno">14253</span>&#160;</div>
</div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Fri May 20 2016 15:52:35 for HARM by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.8.3.1
</small></address>
</body>
</html>
