<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.3.1"/>
<title>HARM: fluxct.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">HARM
   </div>
   <div id="projectbrief">harm and utilities</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.3.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="../../search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">fluxct.c</div>  </div>
</div><!--header-->
<div class="contents">
<a href="../../d9/db3/fluxct_8c.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="preprocessor">#include &quot;decs.h&quot;</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;</div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;</div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;</div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;</div>
<div class="line"><a name="l00038"></a><span class="lineno"><a class="code" href="../../d0/de6/fluxvpot_8funcdeclare_8h.html#aa7d2d6945808f75a00dac1018ad68eab">   38</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="../../d9/db3/fluxct_8c.html#aa7d2d6945808f75a00dac1018ad68eab" title="compute field at CENT from vector potential A at CORN1,2,3 assumes normal field p">vpot2field_centeredfield</a>(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*A)[<a class="code" href="../../df/d1c/global_8storage_8h.html#a917a6677d5e3b38aa54aa577978bf823" title="123">NSTORE1</a>+<a class="code" href="../../df/d1c/global_8storage_8h.html#a1c452bce7a227fd9f2c8f937a3c7841c">SHIFTSTORE1</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>+<a class="code" href="../../df/d1c/global_8storage_8h.html#adfe8c351b7f60e189dbd9bfca47af5c5">SHIFTSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>+<a class="code" href="../../df/d1c/global_8storage_8h.html#a6dc540b0373d80d3ea2db53d03a9fa72">SHIFTSTORE3</a>],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pfield)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*ufield)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR])</div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;{</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;  <span class="keywordtype">int</span> Nvec[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;</div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;  Nvec[0]=0;</div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;  Nvec[1]=<a class="code" href="../../da/d3e/definit_8h.html#abd7b39be02bc15d79b73e5cf2b531299" title="#define CORNGDETVERSION 0">N1</a>;</div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;  Nvec[2]=<a class="code" href="../../da/d3e/definit_8h.html#acd864640121c7df2c19f61f7baa507e4">N2</a>;</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;  Nvec[3]=<a class="code" href="../../da/d3e/definit_8h.html#ad66109fbdc4d3adc9c3d6ff917038aef">N3</a>;</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;  <span class="comment">/* flux-ct */</span></div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;  <span class="comment">// A[1] located at CORN1</span></div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;  <span class="comment">// A[2] located at CORN2</span></div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;  <span class="comment">// A[3] located at CORN3</span></div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;</div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;  <span class="comment">// F_{\mu\nu} \equiv A_{\nu,\mu} - A_{\mu,\nu}</span></div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;  <span class="comment">// B^i \equiv \dF^{it}</span></div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;  <span class="comment">// F_{ij} = \detg B^k [ijk]</span></div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;  <span class="comment">// F_{\theta\phi} = \detg B^r</span></div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;  <span class="comment">// F_{\phi r} = \detg B^\theta</span></div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;  <span class="comment">// F_{r\theta} = \detg B^\phi</span></div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;  <span class="comment">// \detg B^x = A_{z,y} - A_{y,z}</span></div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;  <span class="comment">// \detg B^y = A_{x,z} - A_{z,x}</span></div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;  <span class="comment">// \detg B^z = A_{y,x} - A_{x,y}</span></div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;  <span class="comment">// loop optimized for filling cells rather than for speed</span></div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;      </div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;  <span class="comment">// can do full loop since A[1,2,3] are defined even on their plus parts (redundant but simpler than messing with B&#39;s post-hoc by linear extrapolation or something)</span></div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;  <span class="comment">// puts burden on computing A[1,2,3] (such as having radius or anything at plus part)</span></div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;  <span class="comment">// this burden is easier since coord() and bl_coord() have no limits on the i,j,k they are given.</span></div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;  <span class="comment">// so in principle one can give an analytic expression</span></div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;  <span class="comment">// however, depends on metric and such things if converting expression from one basis to another.</span></div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;  <span class="comment">// however, this way is more correct than post-hoc extrapolation.</span></div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;  <span class="comment">// only an issue for fixed boundary conditions, where one could just specify the flux directly.</span></div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;  <span class="comment">// ufield explicitly needed for FV method</span></div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;  <span class="comment">// since nowait&#39;ed above (because each loop sets ufield,pfield for each dir that don&#39;t depend upon eachother), need barrier here at end to stop before continuing (implied in parallel reigon)</span></div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;<span class="preprocessor">#pragma omp parallel </span></div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;<span class="preprocessor"></span>  {</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;    <span class="keywordtype">int</span> <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>,<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>,k;</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;    <span class="keyword">struct </span><a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> geomdontuse;</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;    <span class="keyword">struct </span><a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom=&amp;geomdontuse;</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> igdetgnosing;</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;    <span class="keywordtype">int</span> dir;</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;    <span class="keywordtype">int</span> odir1,odir2;</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;    <a class="code" href="../../d5/d7b/global_8openmploops_8h.html#a1389db2daf5bd9e94918090c253a16c9">OPENMP3DLOOPVARSDEFINE</a>; <a class="code" href="../../d5/d7b/global_8openmploops_8h.html#a7518365209531b952c067f47c80777c2" title="COMPFULLLOOP equivalent for OpenMP.">OPENMP3DLOOPSETUPFULL</a>; <span class="comment">// doesn&#39;t depend upon dir, but blockijk must be private, so put in parallel loop</span></div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;    <span class="comment">// generally ptr&#39;s are different inside parallel block</span></div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;    ptrgeom=&amp;geomdontuse;</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;    <span class="comment">// B^1</span></div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;    dir=1;</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;    get_odirs(dir,&amp;odir1,&amp;odir2);</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;    <span class="keywordflow">if</span>(!(Nvec[odir1]==1 &amp;&amp; Nvec[odir2]==1)){</div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;<span class="preprocessor">#pragma omp for schedule(OPENMPFULLNOVARYSCHEDULE()) nowait // nowait valid because each next loop writes to independent memory regions (or to local temporary variables like igdetgnosing that is overwritten for each iteration and so doesn&#39;t matter).  And also don&#39;t require result of one loop for next loop (this is often not true!)</span></div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;<span class="preprocessor"></span>      <a class="code" href="../../d5/d7b/global_8openmploops_8h.html#a9e48537d3cb58cc3a3765b8a18b43b15" title="Oddly, performance changes by 10% when changing how start and stop blockijk (and fixing how used too ...">OPENMP3DLOOPBLOCK</a>{</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;        <a class="code" href="../../df/d1c/global_8storage_8h.html#a96983b0c56e836f50cb7c1af16f59fb6">OPENMP3DLOOPBLOCK2IJK</a>(i,j,k);</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;        <span class="comment">// ufield doesn&#39;t require geometry</span></div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;        <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(ufield,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>)  = +(<a class="code" href="../../d8/d7d/global_8fieldmacros_8h.html#aff0878821f0ec943270f0caa216e3f9c" title="AVG_x functions that average in x direction typically operates on CORN1,2,3 quantities to get face qu...">AVGCORN_1</a>(A[3],i,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a3e64aa2cd3c5e0933e74fa4e7a925570">jp1mac</a>(j),k)-<a class="code" href="../../d8/d7d/global_8fieldmacros_8h.html#aff0878821f0ec943270f0caa216e3f9c" title="AVG_x functions that average in x direction typically operates on CORN1,2,3 quantities to get face qu...">AVGCORN_1</a>(A[3],i,j,k))/(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a99b91d8e229e5df70958f2aed7fd15bf">dx</a>[2]);</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;        <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(ufield,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>) += -(<a class="code" href="../../d8/d7d/global_8fieldmacros_8h.html#aff0878821f0ec943270f0caa216e3f9c" title="AVG_x functions that average in x direction typically operates on CORN1,2,3 quantities to get face qu...">AVGCORN_1</a>(A[2],i,j,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#aafe7c78a2d0713ddc9a4f1c61764e3b9">kp1mac</a>(k))-<a class="code" href="../../d8/d7d/global_8fieldmacros_8h.html#aff0878821f0ec943270f0caa216e3f9c" title="AVG_x functions that average in x direction typically operates on CORN1,2,3 quantities to get face qu...">AVGCORN_1</a>(A[2],i,j,k))/(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a99b91d8e229e5df70958f2aed7fd15bf">dx</a>[3]);</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;        <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a3059ed7bfcfb692cbe8014d55fd7c1e4">get_geometry</a>(i, j, k, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8936711f57f82d1fc75c21fa2894e1c6">CENT</a>, ptrgeom);</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;        igdetgnosing = <a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a1e471b644e7fd684cd5dbb144e00ee81">sign</a>(ptrgeom-&gt;gdet)/(fabs(ptrgeom-&gt;gdet)+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a09c78d2f8feb311dd9fc969a0bf84979">SMALL</a>); <span class="comment">// avoids 0.0 for any sign of ptrgeom-&gt;gdet</span></div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;        <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pfield,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>-1+dir)  = <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(ufield,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>-1+dir)*igdetgnosing;</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;      }</div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;    }<span class="comment">// end if doing this dir</span></div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;    <span class="comment">// B^2</span></div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;<span class="comment"></span>    </div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;    dir=2;</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;    get_odirs(dir,&amp;odir1,&amp;odir2);</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;    <span class="keywordflow">if</span>(!(Nvec[odir1]==1 &amp;&amp; Nvec[odir2]==1)){</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;<span class="preprocessor">#pragma omp for schedule(OPENMPFULLNOVARYSCHEDULE()) nowait</span></div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;<span class="preprocessor"></span>      <a class="code" href="../../d5/d7b/global_8openmploops_8h.html#a9e48537d3cb58cc3a3765b8a18b43b15" title="Oddly, performance changes by 10% when changing how start and stop blockijk (and fixing how used too ...">OPENMP3DLOOPBLOCK</a>{</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;        <a class="code" href="../../df/d1c/global_8storage_8h.html#a96983b0c56e836f50cb7c1af16f59fb6">OPENMP3DLOOPBLOCK2IJK</a>(i,j,k);</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;        <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(ufield,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>)  = +(<a class="code" href="../../d8/d7d/global_8fieldmacros_8h.html#a534ce68ed67f714519d53ad31e9d9a1e">AVGCORN_2</a>(A[1],i,j,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#aafe7c78a2d0713ddc9a4f1c61764e3b9">kp1mac</a>(k))-<a class="code" href="../../d8/d7d/global_8fieldmacros_8h.html#a534ce68ed67f714519d53ad31e9d9a1e">AVGCORN_2</a>(A[1],i,j,k))/(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a99b91d8e229e5df70958f2aed7fd15bf">dx</a>[3]);</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;        <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(ufield,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>) += -(<a class="code" href="../../d8/d7d/global_8fieldmacros_8h.html#a534ce68ed67f714519d53ad31e9d9a1e">AVGCORN_2</a>(A[3],<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a27e1e0a92af691ffd03d7e9d0a628392">ip1mac</a>(i),j,k)-<a class="code" href="../../d8/d7d/global_8fieldmacros_8h.html#a534ce68ed67f714519d53ad31e9d9a1e">AVGCORN_2</a>(A[3],i,j,k))/(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a99b91d8e229e5df70958f2aed7fd15bf">dx</a>[1]);</div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;        <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a3059ed7bfcfb692cbe8014d55fd7c1e4">get_geometry</a>(i, j, k, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8936711f57f82d1fc75c21fa2894e1c6">CENT</a>, ptrgeom);</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;        igdetgnosing = <a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a1e471b644e7fd684cd5dbb144e00ee81">sign</a>(ptrgeom-&gt;gdet)/(fabs(ptrgeom-&gt;gdet)+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a09c78d2f8feb311dd9fc969a0bf84979">SMALL</a>); <span class="comment">// avoids 0.0 for any sign of ptrgeom-&gt;gdet</span></div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;        <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pfield,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>-1+dir)  = <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(ufield,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>-1+dir)*igdetgnosing;</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;      }</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;    } <span class="comment">// end if dir</span></div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;  </div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;    <span class="comment">// B^3</span></div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;    dir=3;</div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;    get_odirs(dir,&amp;odir1,&amp;odir2);</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;    <span class="keywordflow">if</span>(!(Nvec[odir1]==1 &amp;&amp; Nvec[odir2]==1)){</div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;<span class="preprocessor">#pragma omp for schedule(OPENMPFULLNOVARYSCHEDULE()) nowait</span></div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;<span class="preprocessor"></span>      <a class="code" href="../../d5/d7b/global_8openmploops_8h.html#a9e48537d3cb58cc3a3765b8a18b43b15" title="Oddly, performance changes by 10% when changing how start and stop blockijk (and fixing how used too ...">OPENMP3DLOOPBLOCK</a>{</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;        <a class="code" href="../../df/d1c/global_8storage_8h.html#a96983b0c56e836f50cb7c1af16f59fb6">OPENMP3DLOOPBLOCK2IJK</a>(i,j,k);</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;</div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;        <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(ufield,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>)  = +(<a class="code" href="../../d8/d7d/global_8fieldmacros_8h.html#a5342e1d998887ee0a2ae22f917c3e230">AVGCORN_3</a>(A[2],<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a27e1e0a92af691ffd03d7e9d0a628392">ip1mac</a>(i),j,k)-<a class="code" href="../../d8/d7d/global_8fieldmacros_8h.html#a5342e1d998887ee0a2ae22f917c3e230">AVGCORN_3</a>(A[2],i,j,k))/(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a99b91d8e229e5df70958f2aed7fd15bf">dx</a>[1]);</div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;        <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(ufield,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>) += -(<a class="code" href="../../d8/d7d/global_8fieldmacros_8h.html#a5342e1d998887ee0a2ae22f917c3e230">AVGCORN_3</a>(A[1],i,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a3e64aa2cd3c5e0933e74fa4e7a925570">jp1mac</a>(j),k)-<a class="code" href="../../d8/d7d/global_8fieldmacros_8h.html#a5342e1d998887ee0a2ae22f917c3e230">AVGCORN_3</a>(A[1],i,j,k))/(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a99b91d8e229e5df70958f2aed7fd15bf">dx</a>[2]);</div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;</div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;        <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a3059ed7bfcfb692cbe8014d55fd7c1e4">get_geometry</a>(i, j, k, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8936711f57f82d1fc75c21fa2894e1c6">CENT</a>, ptrgeom);</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;        igdetgnosing = <a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a1e471b644e7fd684cd5dbb144e00ee81">sign</a>(ptrgeom-&gt;gdet)/(fabs(ptrgeom-&gt;gdet)+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a09c78d2f8feb311dd9fc969a0bf84979">SMALL</a>); <span class="comment">// avoids 0.0 for any sign of ptrgeom-&gt;gdet</span></div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;        <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pfield,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>-1+dir)  = <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(ufield,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>-1+dir)*igdetgnosing;</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;      }</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;    }<span class="comment">// end if dir</span></div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;  </div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;  }<span class="comment">// end full parallel region (with implied barrier)</span></div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;</div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;  </div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;}</div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;</div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;<span class="keywordtype">int</span> flux_ct(<span class="keywordtype">int</span> stage,</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;            <span class="keywordtype">int</span> initialstep, <span class="keywordtype">int</span> finalstep,</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;            <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pb)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*emf)[<a class="code" href="../../df/d1c/global_8storage_8h.html#a917a6677d5e3b38aa54aa577978bf823" title="123">NSTORE1</a>+<a class="code" href="../../df/d1c/global_8storage_8h.html#a1c452bce7a227fd9f2c8f937a3c7841c">SHIFTSTORE1</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>+<a class="code" href="../../df/d1c/global_8storage_8h.html#adfe8c351b7f60e189dbd9bfca47af5c5">SHIFTSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>+<a class="code" href="../../df/d1c/global_8storage_8h.html#a6dc540b0373d80d3ea2db53d03a9fa72">SHIFTSTORE3</a>], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*vconemf)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>-1], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*dq1)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*dq2)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*dq3)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*F1)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*F2)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*F3)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*vpot)[<a class="code" href="../../df/d1c/global_8storage_8h.html#a917a6677d5e3b38aa54aa577978bf823" title="123">NSTORE1</a>+<a class="code" href="../../df/d1c/global_8storage_8h.html#a1c452bce7a227fd9f2c8f937a3c7841c">SHIFTSTORE1</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>+<a class="code" href="../../df/d1c/global_8storage_8h.html#adfe8c351b7f60e189dbd9bfca47af5c5">SHIFTSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>+<a class="code" href="../../df/d1c/global_8storage_8h.html#a6dc540b0373d80d3ea2db53d03a9fa72">SHIFTSTORE3</a>], <span class="keywordtype">int</span> *Nvec, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUf, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUnew, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a0263684ebff8e72a2f0de1861393595f">SFTYPE</a> fluxdt, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a0263684ebff8e72a2f0de1861393595f">SFTYPE</a> fluxtime)</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;{</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;  <span class="keywordtype">int</span> flux_ct_computeemf(<span class="keywordtype">int</span> stage, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pb)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*emf)[<a class="code" href="../../df/d1c/global_8storage_8h.html#a917a6677d5e3b38aa54aa577978bf823" title="123">NSTORE1</a>+<a class="code" href="../../df/d1c/global_8storage_8h.html#a1c452bce7a227fd9f2c8f937a3c7841c">SHIFTSTORE1</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>+<a class="code" href="../../df/d1c/global_8storage_8h.html#adfe8c351b7f60e189dbd9bfca47af5c5">SHIFTSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>+<a class="code" href="../../df/d1c/global_8storage_8h.html#a6dc540b0373d80d3ea2db53d03a9fa72">SHIFTSTORE3</a>], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*vconemf)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>-1], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*dq1)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*dq2)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*dq3)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*F1)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*F2)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*F3)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>]);</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;  <span class="keywordtype">int</span> flux_ct_diffusivecorrections(<span class="keywordtype">int</span> stage, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pb)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*emf)[<a class="code" href="../../df/d1c/global_8storage_8h.html#a917a6677d5e3b38aa54aa577978bf823" title="123">NSTORE1</a>+<a class="code" href="../../df/d1c/global_8storage_8h.html#a1c452bce7a227fd9f2c8f937a3c7841c">SHIFTSTORE1</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>+<a class="code" href="../../df/d1c/global_8storage_8h.html#adfe8c351b7f60e189dbd9bfca47af5c5">SHIFTSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>+<a class="code" href="../../df/d1c/global_8storage_8h.html#a6dc540b0373d80d3ea2db53d03a9fa72">SHIFTSTORE3</a>], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*vconemf)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>-1], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*dq1)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*dq2)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*dq3)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*F1)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*F2)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*F3)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>]);</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;  <span class="keywordtype">int</span> flux_ct_emf2flux(<span class="keywordtype">int</span> stage, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pb)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*emf)[<a class="code" href="../../df/d1c/global_8storage_8h.html#a917a6677d5e3b38aa54aa577978bf823" title="123">NSTORE1</a>+<a class="code" href="../../df/d1c/global_8storage_8h.html#a1c452bce7a227fd9f2c8f937a3c7841c">SHIFTSTORE1</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>+<a class="code" href="../../df/d1c/global_8storage_8h.html#adfe8c351b7f60e189dbd9bfca47af5c5">SHIFTSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>+<a class="code" href="../../df/d1c/global_8storage_8h.html#a6dc540b0373d80d3ea2db53d03a9fa72">SHIFTSTORE3</a>], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*vconemf)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>-1], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*dq1)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*dq2)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*dq3)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*F1)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*F2)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*F3)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>]);</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;  <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(flux_ct_computeemf(stage, pb, emf, vconemf, dq1, dq2, dq3, F1, F2, F3),<span class="stringliteral">&quot;step_ch.c:advance()&quot;</span>, <span class="stringliteral">&quot;flux_ct&quot;</span>,1);</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;  <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(flux_ct_diffusivecorrections(stage, pb, emf, vconemf, dq1, dq2, dq3, F1, F2, F3),<span class="stringliteral">&quot;step_ch.c:advance()&quot;</span>, <span class="stringliteral">&quot;flux_ct&quot;</span>,1);</div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;</div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#a10c2a32787a08dc5ca8ee25788232ab5" title="whether to redefine fields from A_i during evolution currently only done after each full timestep to ...">EVOLVEWITHVPOT</a>&gt;0 ||  <a class="code" href="../../da/d3e/definit_8h.html#a3a15a632c4a89c05af66b680733eb82c" title="whether to track and dump A_i the vector potential">TRACKVPOT</a>&gt;0){</div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;    <span class="comment">// Evolve A_i</span></div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;    <span class="comment">// Had to be here where EMFs are at standard CORN1,2,3 positions and before final F assigned</span></div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;    <span class="comment">// TOTH CT method doesn&#39;t cleanly differentiate between point update and average update of A_i, so just stick to TOTH CT EMF itself</span></div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;    evolve_vpotgeneral(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a11c4e99e1493d0c1914ad1ab313ea472">FLUXB</a>, stage, initialstep, finalstep, pb, Nvec, NULL, emf, CUf, CUnew, fluxdt, fluxtime, vpot);</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;  }</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;  <span class="keywordtype">int</span> fluxvpot_modifyemfsuser=0;</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;  fluxvpot_modifyemfsuser=(<a class="code" href="../../da/d3e/definit_8h.html#a10c2a32787a08dc5ca8ee25788232ab5" title="whether to redefine fields from A_i during evolution currently only done after each full timestep to ...">EVOLVEWITHVPOT</a>&gt;0 ||  <a class="code" href="../../da/d3e/definit_8h.html#a3a15a632c4a89c05af66b680733eb82c" title="whether to track and dump A_i the vector potential">TRACKVPOT</a>&gt;0)&amp;&amp;(<a class="code" href="../../da/d3e/definit_8h.html#afa19081fb8e10c244016def1fe8f3ff7" title="more often makes sense to modify A_i and not EMF_i, since want A_i to be smooth so Bstag^i is compute...">MODIFYEMFORVPOT</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a996c6fb8bf888f7814a6109ec1140198" title="for MODIFYEMFORVPOT">MODIFYEMF</a> || <a class="code" href="../../da/d3e/definit_8h.html#afa19081fb8e10c244016def1fe8f3ff7" title="more often makes sense to modify A_i and not EMF_i, since want A_i to be smooth so Bstag^i is compute...">MODIFYEMFORVPOT</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a96c09590fd9cd1bd2355d61dab5325cc">MODIFYVPOT</a>);</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;</div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;  <span class="keywordflow">if</span>(fluxvpot_modifyemfsuser==0){<span class="comment">// if didn&#39;t already call adjust_emfs() in fluxvpot above, have to allow user to be able to still modify emfs calling function directly</span></div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;    <span class="comment">// User &quot;boundary conditions&quot; to modify EMFs before used to get fluxes</span></div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;    adjust_fluxcttoth_emfs(fluxtime,pb,emf);</div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;  }</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;</div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;  <span class="comment">// must come last for FLUXCTTOTH to produce correct fluxes from point corner EMFs</span></div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;<span class="comment"></span>  <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(flux_ct_emf2flux(stage, pb, emf, vconemf, dq1, dq2, dq3, F1, F2, F3),<span class="stringliteral">&quot;step_ch.c:advance()&quot;</span>, <span class="stringliteral">&quot;flux_ct&quot;</span>,1);</div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;</div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;</div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;}</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;</div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;</div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;</div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;</div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;</div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;<span class="keywordtype">int</span> flux_ct_computeemf(<span class="keywordtype">int</span> stage, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pb)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*emf)[<a class="code" href="../../df/d1c/global_8storage_8h.html#a917a6677d5e3b38aa54aa577978bf823" title="123">NSTORE1</a>+<a class="code" href="../../df/d1c/global_8storage_8h.html#a1c452bce7a227fd9f2c8f937a3c7841c">SHIFTSTORE1</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>+<a class="code" href="../../df/d1c/global_8storage_8h.html#adfe8c351b7f60e189dbd9bfca47af5c5">SHIFTSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>+<a class="code" href="../../df/d1c/global_8storage_8h.html#a6dc540b0373d80d3ea2db53d03a9fa72">SHIFTSTORE3</a>], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*vconemf)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>-1], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*dq1)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*dq2)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*dq3)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*F1)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*F2)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*F3)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>])</div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;{</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;  <span class="comment">// full-type geometry below</span></div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> coefemf[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;  <span class="keyword">extern</span> <span class="keywordtype">int</span> choose_limiter(<span class="keywordtype">int</span> dir, <span class="keywordtype">int</span> <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>, <span class="keywordtype">int</span> <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>, <span class="keywordtype">int</span> k, <span class="keywordtype">int</span> pl);</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;</div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;  <span class="comment">// Note that Toth method needs off-direction flux beyond where normal-flux needed.  For example, for dir=1 setting F1(i) needs F23[i-1],F23[i].  So fluxloop needs to define F2/F3 as if cell centered quantity.</span></div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;  <span class="comment">// Also, if modify flux[B1,B2,B3] after set by flux calculation, then that information can propagate from outer boundaries to active region</span></div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;  <span class="comment">// When FLUXCTTOTH method used, must not modify fluxes within ghost region (say setting F1[B2]=-F2[B1]) since info will move to active region</span></div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;  <span class="comment">// e.g. if put NaN in EMF3 at very outer edge, then reaches active domain by this method</span></div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;</div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;</div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;</div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a11c4e99e1493d0c1914ad1ab313ea472">FLUXB</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b819c24fa7530eba7637782a892aa90" title="DIVB constraint method.">FLUXCTHLL</a>){</div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;    dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;Makes no sense to call flux_ct with FLUXB==FLUXCTHLL\n&quot;</span>);</div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;    myexit(9176325);</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;  }</div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;</div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;</div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;</div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;</div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;  <span class="comment">//  COMPUTE PRE-FUNCTIONS used by Athena method</span></div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;<span class="comment"></span>  <span class="keywordflow">if</span>((<a class="code" href="../../d8/d5b/defs_8general_8h.html#a11c4e99e1493d0c1914ad1ab313ea472">FLUXB</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a5c288047377b976b5c630d0eb8856257">ATHENA1</a>)||(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a11c4e99e1493d0c1914ad1ab313ea472">FLUXB</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a203809114fcd4d7fc35a2a22538dd6c1">ATHENA2</a>)){</div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;    <span class="comment">// compute v^i</span></div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;</div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;    <span class="comment">// loop must go over COMPEMFZLOOP&#39;s range minus 1 for i and j and k</span></div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;    <span class="comment">//    COMPPREEMFZLOOP{</span></div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;    <span class="comment">//    COMPFULLLOOP{ // GODMARK: could try to be more constrained</span></div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;    <span class="comment">// use ucon_calc() to get v^i </span></div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;<span class="preprocessor">#pragma omp parallel </span></div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;<span class="preprocessor"></span>    {</div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;      <span class="keywordtype">int</span> <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>, <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>, k, l;</div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;      <span class="keyword">struct </span><a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> geomcfulldontuse;</div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;      <span class="keyword">struct </span><a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeomcfull=&amp;geomcfulldontuse;</div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ucon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> others[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a266c1c3ab2959dbfc603c7d3f12783fb" title="strict limit (doesn&#39;t work in general)">NUMOTHERSTATERESULTS</a>];</div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;</div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;      <a class="code" href="../../d5/d7b/global_8openmploops_8h.html#a1389db2daf5bd9e94918090c253a16c9">OPENMP3DLOOPVARSDEFINE</a>; <a class="code" href="../../d5/d7b/global_8openmploops_8h.html#a7518365209531b952c067f47c80777c2" title="COMPFULLLOOP equivalent for OpenMP.">OPENMP3DLOOPSETUPFULL</a>;</div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;    </div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;</div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;<span class="preprocessor">#pragma omp for schedule(OPENMPFULLNOVARYSCHEDULE())</span></div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;<span class="preprocessor"></span>      <a class="code" href="../../d5/d7b/global_8openmploops_8h.html#a9e48537d3cb58cc3a3765b8a18b43b15" title="Oddly, performance changes by 10% when changing how start and stop blockijk (and fixing how used too ...">OPENMP3DLOOPBLOCK</a>{</div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;        <a class="code" href="../../df/d1c/global_8storage_8h.html#a96983b0c56e836f50cb7c1af16f59fb6">OPENMP3DLOOPBLOCK2IJK</a>(i,j,k);</div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;</div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;</div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;        <span class="comment">// EMF below is based upon averaging of zone-centered quantities, so use CENT here (i.e. not CORN)</span></div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;        <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a3059ed7bfcfb692cbe8014d55fd7c1e4">get_geometry</a>(i, j, k, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8936711f57f82d1fc75c21fa2894e1c6">CENT</a>, ptrgeomcfull);</div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;        <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#afc93fd4a6f7a2b87a9315d5fba5a529c">ucon_calc</a>(<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(pb,i,j,k), ptrgeomcfull, ucon, others),<span class="stringliteral">&quot;fluxct.c:flux_ct()&quot;</span>, <span class="stringliteral">&quot;ucon_calc() dir=0&quot;</span>, 1);</div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;</div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;</div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;        <span class="comment">// ptrgeom-&gt;gdet is \detg for EMF flux (ptrgeom-&gt;e is EOM factor for flux equation)</span></div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;<span class="preprocessor">#if(CORNGDETVERSION)</span></div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;<span class="preprocessor"></span>        <span class="keywordflow">for</span>(l=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>;l&lt;=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8de9104f1fffa59f057b214d74c5cfea">U3</a>;l++) <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(vconemf,i,j,k,l)=(ucon[l-<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>+1]/ucon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>]); <span class="comment">// put in at end</span></div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;<span class="preprocessor"></span>        <span class="keywordflow">for</span>(l=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>;l&lt;=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8de9104f1fffa59f057b214d74c5cfea">U3</a>;l++) <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(vconemf,i,j,k,l)=(ucon[l-<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>+1]/ucon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>])*(ptrgeomcfull-&gt;EOMFUNCMAC(l));</div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;<span class="preprocessor"></span>      }<span class="comment">// end 3D LOOP</span></div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;    }<span class="comment">// end parallel region</span></div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;  }<span class="comment">// end if ATHENA1||ATHENA2</span></div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;</div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;</div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;</div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;</div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;</div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;</div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;</div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;</div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;</div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;</div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;<span class="preprocessor">#if(CORNGDETVERSION)</span></div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;  <span class="keywordflow">if</span>((<a class="code" href="../../d8/d5b/defs_8general_8h.html#a11c4e99e1493d0c1914ad1ab313ea472">FLUXB</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a5c288047377b976b5c630d0eb8856257">ATHENA1</a>)||(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a11c4e99e1493d0c1914ad1ab313ea472">FLUXB</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a203809114fcd4d7fc35a2a22538dd6c1">ATHENA2</a>)||(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a11c4e99e1493d0c1914ad1ab313ea472">FLUXB</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a5014e44c6e710d8827ef79dd18abe6ad">FLUXCTTOTH</a>)||(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a11c4e99e1493d0c1914ad1ab313ea472">FLUXB</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6cf8dd4f55e698316ccf74b8e57e317a">FLUXCD</a>)){</div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;</div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;    <span class="comment">// strip off geometry factor, which is added when computing the EMF</span></div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;<span class="comment"></span>    <span class="comment">//    COMPFULLLOOP{ // GODMARK: could try to be more constrained</span></div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;<span class="preprocessor">#pragma omp parallel </span></div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;<span class="preprocessor"></span>    {</div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;      <span class="keywordtype">int</span> <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>,<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>,k;</div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;      <span class="comment">// gdet-type geometry below</span></div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;      <span class="keyword">struct </span><a class="code" href="../../d6/d39/global_8structs_8h.html#a91ee2a91251b6d836d6cd3505d4d0a68">of_gdetgeom</a> geomf1dontuse,geomf2dontuse,geomf3dontuse;</div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;      <span class="keyword">struct </span><a class="code" href="../../d6/d39/global_8structs_8h.html#a91ee2a91251b6d836d6cd3505d4d0a68">of_gdetgeom</a> *ptrgeomf1=&amp;geomf1dontuse,*ptrgeomf2=&amp;geomf2dontuse,*ptrgeomf3=&amp;geomf3dontuse;</div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;</div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;      <a class="code" href="../../d5/d7b/global_8openmploops_8h.html#a1389db2daf5bd9e94918090c253a16c9">OPENMP3DLOOPVARSDEFINE</a>; <a class="code" href="../../d5/d7b/global_8openmploops_8h.html#a7518365209531b952c067f47c80777c2" title="COMPFULLLOOP equivalent for OpenMP.">OPENMP3DLOOPSETUPFULL</a>;</div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;    </div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;</div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;<span class="preprocessor">#pragma omp for schedule(OPENMPFULLNOVARYSCHEDULE())</span></div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;<span class="preprocessor"></span>      <a class="code" href="../../d5/d7b/global_8openmploops_8h.html#a9e48537d3cb58cc3a3765b8a18b43b15" title="Oddly, performance changes by 10% when changing how start and stop blockijk (and fixing how used too ...">OPENMP3DLOOPBLOCK</a>{</div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;        <a class="code" href="../../df/d1c/global_8storage_8h.html#a96983b0c56e836f50cb7c1af16f59fb6">OPENMP3DLOOPBLOCK2IJK</a>(i,j,k);</div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;</div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;</div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;        <span class="comment">// F1</span></div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;<span class="comment"></span><span class="preprocessor">#if(N1&gt;1)</span></div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;<span class="preprocessor"></span>        <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a9740cb914b7803b1ba73f76a9a37ddc2">get_geometry_gdetmix</a>(i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a1df736ddba855d7b429869f9f09dbd66">FACE1</a>,ptrgeomf1);</div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;        <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F1,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>)*=(ptrgeomf1-&gt;IEOMFUNCNOSINGMAC(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>));</div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;        <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F1,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>)*=(ptrgeomf1-&gt;IEOMFUNCNOSINGMAC(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>));</div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;        <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F1,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>)*=(ptrgeomf1-&gt;IEOMFUNCNOSINGMAC(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>));</div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;        <span class="comment">// F2</span></div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;<span class="comment"></span><span class="preprocessor">#if(N2&gt;1)</span></div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;<span class="preprocessor"></span>        <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a9740cb914b7803b1ba73f76a9a37ddc2">get_geometry_gdetmix</a>(i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a5b4b42f50fd7667c7d22d8001811bc7e">FACE2</a>,ptrgeomf2);</div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;        <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F2,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>)*=(ptrgeomf2-&gt;IEOMFUNCNOSINGMAC(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>));</div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;        <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F2,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>)*=(ptrgeomf2-&gt;IEOMFUNCNOSINGMAC(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>));</div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;        <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F2,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>)*=(ptrgeomf2-&gt;IEOMFUNCNOSINGMAC(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>));</div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;<span class="preprocessor"></span>    </div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;        <span class="comment">// F3</span></div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;<span class="comment"></span><span class="preprocessor">#if(N3&gt;1)</span></div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;<span class="preprocessor"></span>        <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a9740cb914b7803b1ba73f76a9a37ddc2">get_geometry_gdetmix</a>(i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a630fdcefb04bdca66118cfd21476e8fd">FACE3</a>,ptrgeomf3);</div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;        <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F3,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>)*=(ptrgeomf3-&gt;IEOMFUNCNOSINGMAC(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>));</div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;        <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F3,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>)*=(ptrgeomf3-&gt;IEOMFUNCNOSINGMAC(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>));</div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;        <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F3,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>)*=(ptrgeomf3-&gt;IEOMFUNCNOSINGMAC(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>));</div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;<span class="preprocessor"></span>      }<span class="comment">// end 3D loop</span></div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;    }<span class="comment">// end parallel region</span></div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;</div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;    <span class="comment">// don&#39;t need to put back geometry factor since in the end the EMF defines the Flux completely (except for FLUXB==FLUXCTHLL)</span></div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;  }<span class="comment">// end if ATHENA1||ATHENA2||FLUXCTTOTH||FLUXCD</span></div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;<span class="preprocessor">#endif // end if CORNGDETVERSION</span></div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;</div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;</div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;</div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;</div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;</div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;  <span class="comment">// GODMARK: strange one has to do this.  Related to FLUXCT not reducing correctly for plane-parallel grid-aligned flows?</span></div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;  <span class="keywordflow">if</span>((<a class="code" href="../../da/d3e/definit_8h.html#acd864640121c7df2c19f61f7baa507e4">N2</a>&gt;1)&amp;&amp;(<a class="code" href="../../da/d3e/definit_8h.html#ad66109fbdc4d3adc9c3d6ff917038aef">N3</a>&gt;1)) coefemf[1]=0.25;</div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;  <span class="keywordflow">else</span> coefemf[1]=0.5; <span class="comment">// or 0 if neither as controlled by below</span></div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;  <span class="keywordflow">if</span>((<a class="code" href="../../da/d3e/definit_8h.html#abd7b39be02bc15d79b73e5cf2b531299" title="#define CORNGDETVERSION 0">N1</a>&gt;1)&amp;&amp;(<a class="code" href="../../da/d3e/definit_8h.html#ad66109fbdc4d3adc9c3d6ff917038aef">N3</a>&gt;1)) coefemf[2]=0.25;</div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;  <span class="keywordflow">else</span> coefemf[2]=0.5; <span class="comment">// or 0 if neither as controlled by below</span></div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;  <span class="keywordflow">if</span>((<a class="code" href="../../da/d3e/definit_8h.html#abd7b39be02bc15d79b73e5cf2b531299" title="#define CORNGDETVERSION 0">N1</a>&gt;1)&amp;&amp;(<a class="code" href="../../da/d3e/definit_8h.html#acd864640121c7df2c19f61f7baa507e4">N2</a>&gt;1)) coefemf[3]=0.25;</div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;  <span class="keywordflow">else</span> coefemf[3]=0.5; <span class="comment">// or 0 if neither as controlled by below</span></div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;</div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;</div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;</div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;</div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;</div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;  <span class="comment">// COMPUTE EMF</span></div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;  <span class="keywordflow">if</span>((<a class="code" href="../../d8/d5b/defs_8general_8h.html#a11c4e99e1493d0c1914ad1ab313ea472">FLUXB</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a5014e44c6e710d8827ef79dd18abe6ad">FLUXCTTOTH</a>)||(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a11c4e99e1493d0c1914ad1ab313ea472">FLUXB</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a5c288047377b976b5c630d0eb8856257">ATHENA1</a>)||(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a11c4e99e1493d0c1914ad1ab313ea472">FLUXB</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a203809114fcd4d7fc35a2a22538dd6c1">ATHENA2</a>)){</div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;    <span class="comment">/* calculate EMFs */</span></div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;    <span class="comment">/* Toth approach: just average */</span></div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;</div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;</div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;    <span class="comment">// emf_i centered on corner of plane with normal direction i</span></div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;</div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;    <span class="comment">// Note, do need F1[-N1BND] but don&#39;t need F2[-N2BND] or F3[-N3BND] in averaging process, which makes normally need to be complicated.</span></div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;    <span class="comment">// Note: As discussed in superdefs.h, superdefs.pointers.h, and set_arrays_multidimen.c, F1,F2,F3,F1EM,F2EM,F3EM pointers are normal arrays, but their BASE arrays have extra memory at *bottom* so can access F[-NBND-1] without segfaulting.  Resulting data not used, but makes loops simpler.</span></div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;</div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;</div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;<span class="preprocessor">#pragma omp parallel  // globalprivate stuff needed for final CORNGDET setting if doing that method</span></div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;<span class="preprocessor"></span>    {</div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;      <span class="keywordtype">int</span> <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>,<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>,k;</div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;      <span class="comment">// gdet-type geometry below</span></div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;      <span class="keyword">struct </span><a class="code" href="../../d6/d39/global_8structs_8h.html#a91ee2a91251b6d836d6cd3505d4d0a68">of_gdetgeom</a> geomf1dontuse,geomf2dontuse,geomf3dontuse;</div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;      <span class="keyword">struct </span><a class="code" href="../../d6/d39/global_8structs_8h.html#a91ee2a91251b6d836d6cd3505d4d0a68">of_gdetgeom</a> *ptrgeomf1=&amp;geomf1dontuse,*ptrgeomf2=&amp;geomf2dontuse,*ptrgeomf3=&amp;geomf3dontuse;</div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;      <a class="code" href="../../d5/d7b/global_8openmploops_8h.html#a1389db2daf5bd9e94918090c253a16c9">OPENMP3DLOOPVARSDEFINE</a>;</div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;      </div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;</div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;      <span class="comment">//    //    COMPLOOPINFP1dir1full</span></div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;      <span class="comment">//      OPENMP3DLOOPSETUP(-N1BND,N1-1+N1BND,INFULLP12,OUTFULL2,INFULLP13,OUTFULL3);</span></div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;<span class="comment"></span>      <span class="comment">//      OPENMP3DLOOPSETUP(INFULLP11,OUTFULL1,INFULLP12,OUTFULL2,-N3BND,N3-1+N3BND);</span></div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;      </div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;      <a class="code" href="../../d5/d7b/global_8openmploops_8h.html#a7518365209531b952c067f47c80777c2" title="COMPFULLLOOP equivalent for OpenMP.">OPENMP3DLOOPSETUPFULL</a>;</div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;<span class="preprocessor">#pragma omp for schedule(OPENMPFULLNOVARYSCHEDULE()) </span></div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;<span class="preprocessor">      OPENMP3DLOOPBLOCK{</span></div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;<span class="preprocessor"></span>        <a class="code" href="../../df/d1c/global_8storage_8h.html#a96983b0c56e836f50cb7c1af16f59fb6">OPENMP3DLOOPBLOCK2IJK</a>(i,j,k);</div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160; </div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;</div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;        <span class="comment">// EMF1</span></div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;<span class="comment"></span><span class="preprocessor">#if((N2&gt;1)||(N3&gt;1))</span></div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;<span class="preprocessor"></span>        <a class="code" href="../../df/d1c/global_8storage_8h.html#a4589594cbb3d23d258245b68273e6df6">MACP1A0</a>(emf,1,i,j,k) =</div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;          coefemf[1] * (</div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;<span class="preprocessor">#if(N2&gt;1)</span></div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;<span class="preprocessor"></span>                        + <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F2,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>) + <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F2,i,j,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#af08e27a43532afdccfdb21fcdea20871">km1mac</a>(k),<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>)</div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#if(N3&gt;1)</span></div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;<span class="preprocessor"></span>                        - <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F3,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>) - <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F3,i,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>)</div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;<span class="preprocessor"></span>                        );</div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;<span class="preprocessor">#else // end if doing EMF1</span></div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;<span class="preprocessor"></span>        <a class="code" href="../../df/d1c/global_8storage_8h.html#a4589594cbb3d23d258245b68273e6df6">MACP1A0</a>(emf,1,i,j,k)=0.0; <span class="comment">// not really 0, but differences in emf will be 0, and that&#39;s all that matters</span></div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;<span class="preprocessor">#endif // end if not doing EMF1</span></div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;<span class="preprocessor">#if(CORNGDETVERSION)// then tack on geometry</span></div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;<span class="preprocessor"></span>        <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a9740cb914b7803b1ba73f76a9a37ddc2">get_geometry_gdetmix</a>(i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a1068bcf25c9f187a8db0f422e0af64c8">CORN1</a>,ptrgeomf1);</div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;        <span class="comment">// obviously ptrgeom-&gt;EOMFUNCMAC(B2) has to be equal to ptrgeom-&gt;EOMFUNCMAC(B3) for this method</span></div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;        <a class="code" href="../../df/d1c/global_8storage_8h.html#a4589594cbb3d23d258245b68273e6df6">MACP1A0</a>(emf,1,i,j,k) *= (ptrgeomf1-&gt;EOMFUNCMAC(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>));</div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;<span class="preprocessor">#endif // end if CORNGDETVERSION</span></div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;</div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;</div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;        <span class="comment">// EMF2</span></div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;<span class="comment"></span><span class="preprocessor">#if((N1&gt;1)||(N3&gt;1))</span></div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;<span class="preprocessor"></span>        <a class="code" href="../../df/d1c/global_8storage_8h.html#a4589594cbb3d23d258245b68273e6df6">MACP1A0</a>(emf,2,i,j,k) =</div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;          coefemf[2] * (</div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;<span class="preprocessor">#if(N3&gt;1)</span></div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;<span class="preprocessor"></span>                        + <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F3,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>) + <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F3,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>)</div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#if(N1&gt;1)</span></div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;<span class="preprocessor"></span>                        - <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F1,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>) - <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F1,i,j,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#af08e27a43532afdccfdb21fcdea20871">km1mac</a>(k),<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>)</div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;<span class="preprocessor"></span>                        );</div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;<span class="preprocessor">#else // end if doing EMF2</span></div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;<span class="preprocessor"></span>        <a class="code" href="../../df/d1c/global_8storage_8h.html#a4589594cbb3d23d258245b68273e6df6">MACP1A0</a>(emf,2,i,j,k)=0.0; <span class="comment">// not really 0, but differences in emf will be 0, and that&#39;s all that matters</span></div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;<span class="preprocessor">#endif // end if not doing EMF2</span></div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;<span class="preprocessor">#if(CORNGDETVERSION)// then tack on geometry</span></div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;<span class="preprocessor"></span>        <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a9740cb914b7803b1ba73f76a9a37ddc2">get_geometry_gdetmix</a>(i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab10e4ab484f1edd4cecb418ff22a743a">CORN2</a>,ptrgeomf2);</div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;        <span class="comment">// obviously ptrgeom-&gt;EOMFUNCMAC(B1) has to be equal to ptrgeom-&gt;EOMFUNCMAC(B2) for this method</span></div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;        <a class="code" href="../../df/d1c/global_8storage_8h.html#a4589594cbb3d23d258245b68273e6df6">MACP1A0</a>(emf,2,i,j,k) *=(ptrgeomf2-&gt;EOMFUNCMAC(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>));</div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;<span class="preprocessor">#endif // end if CORNGDETVERSION</span></div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;</div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;</div>
<div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;</div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;        <span class="comment">// EMF3</span></div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;<span class="comment"></span><span class="preprocessor">#if((N1&gt;1)||(N2&gt;1))</span></div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;<span class="preprocessor"></span>        <a class="code" href="../../df/d1c/global_8storage_8h.html#a4589594cbb3d23d258245b68273e6df6">MACP1A0</a>(emf,3,i,j,k) =</div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;          coefemf[3] * (</div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;<span class="preprocessor">#if(N1&gt;1)</span></div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;<span class="preprocessor"></span>                        + <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F1,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>) + <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F1,i,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>)</div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#if(N2&gt;1)</span></div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;<span class="preprocessor"></span>                        - <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F2,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>) - <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F2,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>)</div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;<span class="preprocessor"></span>                        );</div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;<span class="preprocessor">#else // end if doing EMF3</span></div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;<span class="preprocessor"></span>        <a class="code" href="../../df/d1c/global_8storage_8h.html#a4589594cbb3d23d258245b68273e6df6">MACP1A0</a>(emf,3,i,j,k)=0.0; <span class="comment">// not really 0, but differences in emf will be 0, and that&#39;s all that matters</span></div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;<span class="preprocessor">#endif // end if not doing EMF3</span></div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;<span class="preprocessor">#if(CORNGDETVERSION)// then tack on geometry</span></div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;<span class="preprocessor"></span>        <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a9740cb914b7803b1ba73f76a9a37ddc2">get_geometry_gdetmix</a>(i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a1a05e117efd4dbc39b7c590141004470">CORN3</a>,ptrgeomf3);</div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;        <span class="comment">// obviously ptrgeom-&gt;EOMFUNCMAC(B1) has to be equal to ptrgeom-&gt;EOMFUNCMAC(B2) for this method</span></div>
<div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;        <a class="code" href="../../df/d1c/global_8storage_8h.html#a4589594cbb3d23d258245b68273e6df6">MACP1A0</a>(emf,3,i,j,k) *=(ptrgeomf3-&gt;EOMFUNCMAC(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>));</div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;<span class="preprocessor">#endif // end if CORNGDETVERSION</span></div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;      }<span class="comment">// end 3D LOOP</span></div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;    }<span class="comment">// end parallel region (and implied barrier)</span></div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;</div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;</div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;</div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;</div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;</div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;</div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;</div>
<div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;</div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;</div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;  }<span class="comment">// end if FLUXCT TOTH</span></div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a11c4e99e1493d0c1914ad1ab313ea472">FLUXB</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6cf8dd4f55e698316ccf74b8e57e317a">FLUXCD</a>){</div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;</div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;</div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;</div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;</div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;    <span class="comment">// Centered Difference (CD)</span></div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;    <span class="comment">// here emf is actually electric field</span></div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;    <span class="comment">// in Toth 2000, the F1=f^x F2=f^y</span></div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;    <span class="comment">// see Toth 2000 equation 28/29</span></div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;    <span class="comment">// 0.125 here takes care of larger differencing used in advance() in advance.c</span></div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;    <span class="comment">// all emf&#39;s end up at CENT</span></div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;    <span class="comment">//    COMPEMFZLOOP{</span></div>
<div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;    <span class="comment">//    COMPLOOPOUTFM1{ // constrain or control better? GODMARK</span></div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;</div>
<div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;</div>
<div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;</div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;    <span class="comment">// GODMARK: Why did Charles change sign in front of F&#39;s (see old code) ?  He changed it as if real sign such that emf[i] = \detg E_i but then later flux was wrong sign since he set flux=emf</span></div>
<div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;</div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;    <span class="comment">// GODMARK: should just compute F with diffusive term at CENT directly instead of averaging flux</span></div>
<div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;</div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;<span class="preprocessor">#pragma omp parallel  // globalprivate stuff needed for final CORNGDET setting if doing that method</span></div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;<span class="preprocessor"></span>    {</div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;      <span class="keywordtype">int</span> <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>,<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>,k;</div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;      <span class="keyword">struct </span><a class="code" href="../../d6/d39/global_8structs_8h.html#a91ee2a91251b6d836d6cd3505d4d0a68">of_gdetgeom</a> geomcdontuse;</div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;      <span class="keyword">struct </span><a class="code" href="../../d6/d39/global_8structs_8h.html#a91ee2a91251b6d836d6cd3505d4d0a68">of_gdetgeom</a> *ptrgeomc=&amp;geomcdontuse;</div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;      <a class="code" href="../../d5/d7b/global_8openmploops_8h.html#a1389db2daf5bd9e94918090c253a16c9">OPENMP3DLOOPVARSDEFINE</a>; </div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;</div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;</div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;      <span class="comment">//OPENMP3DLOOPSETUP(-N1BND,N1-1+N1BND,INFULL2,OUTFULLM12,INFULL3,OUTFULLM13);</span></div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;      <a class="code" href="../../d5/d7b/global_8openmploops_8h.html#a7518365209531b952c067f47c80777c2" title="COMPFULLLOOP equivalent for OpenMP.">OPENMP3DLOOPSETUPFULL</a>;</div>
<div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;<span class="preprocessor">#pragma omp for schedule(OPENMPFULLNOVARYSCHEDULE()) </span></div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;<span class="preprocessor">      OPENMP3DLOOPBLOCK{</span></div>
<div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;<span class="preprocessor"></span>        <a class="code" href="../../df/d1c/global_8storage_8h.html#a96983b0c56e836f50cb7c1af16f59fb6">OPENMP3DLOOPBLOCK2IJK</a>(i,j,k);</div>
<div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;</div>
<div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;</div>
<div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;        <span class="comment">// EMF1</span></div>
<div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;<span class="comment"></span><span class="preprocessor">#if((N2&gt;1)||(N3&gt;1))</span></div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;<span class="preprocessor"></span>        <a class="code" href="../../df/d1c/global_8storage_8h.html#a4589594cbb3d23d258245b68273e6df6">MACP1A0</a>(emf,1,i,j,k) =</div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;          0.125 * (</div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;                   + <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F2,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>) + <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F2,i,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a3e64aa2cd3c5e0933e74fa4e7a925570">jp1mac</a>(j),k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>)</div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;                   - <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F3,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>) - <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F3,i,j,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#aafe7c78a2d0713ddc9a4f1c61764e3b9">kp1mac</a>(k),<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>)</div>
<div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;                   );</div>
<div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;</div>
<div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;<span class="preprocessor">#if(CORNGDETVERSION)// then tack on geometry</span></div>
<div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;<span class="preprocessor"></span>        <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a9740cb914b7803b1ba73f76a9a37ddc2">get_geometry_gdetmix</a>(i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8936711f57f82d1fc75c21fa2894e1c6">CENT</a>,ptrgeomc);</div>
<div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;        <span class="comment">// obviously ptrgeom-&gt;EOMFUNCMAC(B2) has to be equal to ptrgeom-&gt;EOMFUNCMAC(B3) for this method</span></div>
<div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;        <a class="code" href="../../df/d1c/global_8storage_8h.html#a4589594cbb3d23d258245b68273e6df6">MACP1A0</a>(emf,1,i,j,k) *=(ptrgeomc-&gt;EOMFUNCMAC(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>));</div>
<div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;<span class="preprocessor">#endif // end if CORNGDETVERSION</span></div>
<div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;<span class="preprocessor"></span> </div>
<div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;<span class="preprocessor">#endif // end if doing EMF1</span></div>
<div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;</div>
<div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;</div>
<div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;        <span class="comment">// EMF2</span></div>
<div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;<span class="comment"></span><span class="preprocessor">#if((N1&gt;1)||(N3&gt;1))</span></div>
<div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;        <a class="code" href="../../df/d1c/global_8storage_8h.html#a4589594cbb3d23d258245b68273e6df6">MACP1A0</a>(emf,2,i,j,k) =</div>
<div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;          0.125 * (</div>
<div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;                   + <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F3,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>) + <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F3,i,j,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#aafe7c78a2d0713ddc9a4f1c61764e3b9">kp1mac</a>(k),<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>)</div>
<div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;                   - <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F1,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>) - <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F1,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a27e1e0a92af691ffd03d7e9d0a628392">ip1mac</a>(i),j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>)</div>
<div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;                   );</div>
<div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;</div>
<div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;<span class="preprocessor">#if(CORNGDETVERSION)// then tack on geometry</span></div>
<div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;<span class="preprocessor"></span>        <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a9740cb914b7803b1ba73f76a9a37ddc2">get_geometry_gdetmix</a>(i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8936711f57f82d1fc75c21fa2894e1c6">CENT</a>,ptrgeomc);</div>
<div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;        <span class="comment">// obviously ptrgeom-&gt;EOMFUNCMAC(B1) has to be equal to ptrgeom-&gt;EOMFUNCMAC(B2) for this method</span></div>
<div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;        <a class="code" href="../../df/d1c/global_8storage_8h.html#a4589594cbb3d23d258245b68273e6df6">MACP1A0</a>(emf,2,i,j,k) *=(ptrgeomc-&gt;EOMFUNCMAC(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>));</div>
<div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;<span class="preprocessor">#endif // end if CORNGDETVERSION</span></div>
<div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;<span class="preprocessor">#endif // end if doing EMF2</span></div>
<div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;</div>
<div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;</div>
<div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;        <span class="comment">// EMF3</span></div>
<div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;<span class="comment"></span><span class="preprocessor">#if((N1&gt;1)||(N2&gt;1))</span></div>
<div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;<span class="preprocessor"></span>        <a class="code" href="../../df/d1c/global_8storage_8h.html#a4589594cbb3d23d258245b68273e6df6">MACP1A0</a>(emf,3,i,j,k) =</div>
<div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;          0.125 * (</div>
<div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;                   + <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F1,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>) + <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F1,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a27e1e0a92af691ffd03d7e9d0a628392">ip1mac</a>(i),j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>)</div>
<div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;                   - <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F2,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>) - <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F2,i,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a3e64aa2cd3c5e0933e74fa4e7a925570">jp1mac</a>(j),k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>)</div>
<div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;                   );</div>
<div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;</div>
<div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;<span class="preprocessor">#if(CORNGDETVERSION)// then tack on geometry</span></div>
<div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;<span class="preprocessor"></span>        <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a9740cb914b7803b1ba73f76a9a37ddc2">get_geometry_gdetmix</a>(i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8936711f57f82d1fc75c21fa2894e1c6">CENT</a>,ptrgeomc);</div>
<div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;        <span class="comment">// obviously ptrgeom-&gt;EOMFUNCMAC(B1) has to be equal to ptrgeom-&gt;EOMFUNCMAC(B2) for this method</span></div>
<div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;        <a class="code" href="../../df/d1c/global_8storage_8h.html#a4589594cbb3d23d258245b68273e6df6">MACP1A0</a>(emf,3,i,j,k) *=(ptrgeomc-&gt;EOMFUNCMAC(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>));</div>
<div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;<span class="preprocessor">#endif // end if CORNGDETVERSION</span></div>
<div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;<span class="preprocessor">#endif // end if doing EMF3</span></div>
<div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;      }<span class="comment">// end 3D LOOP</span></div>
<div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;</div>
<div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;    }<span class="comment">// end parallel region (and implied barrier)</span></div>
<div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;</div>
<div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;</div>
<div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;</div>
<div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;</div>
<div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;  }<span class="comment">// end if FLUXCD</span></div>
<div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;</div>
<div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;</div>
<div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;</div>
<div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;}</div>
<div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;</div>
<div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;</div>
<div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;</div>
<div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;</div>
<div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;</div>
<div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;</div>
<div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;</div>
<div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;</div>
<div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;</div>
<div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;</div>
<div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;</div>
<div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;</div>
<div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;</div>
<div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;</div>
<div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;</div>
<div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;</div>
<div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;</div>
<div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;<span class="keywordtype">int</span> flux_ct_diffusivecorrections(<span class="keywordtype">int</span> stage, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pb)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*emf)[<a class="code" href="../../df/d1c/global_8storage_8h.html#a917a6677d5e3b38aa54aa577978bf823" title="123">NSTORE1</a>+<a class="code" href="../../df/d1c/global_8storage_8h.html#a1c452bce7a227fd9f2c8f937a3c7841c">SHIFTSTORE1</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>+<a class="code" href="../../df/d1c/global_8storage_8h.html#adfe8c351b7f60e189dbd9bfca47af5c5">SHIFTSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>+<a class="code" href="../../df/d1c/global_8storage_8h.html#a6dc540b0373d80d3ea2db53d03a9fa72">SHIFTSTORE3</a>], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*vconemf)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>-1], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*dq1)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*dq2)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*dq3)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*F1)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*F2)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*F3)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>])</div>
<div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;{</div>
<div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;  <span class="comment">// full-type geometry below</span></div>
<div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> coefemf[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;  <span class="keyword">extern</span> <span class="keywordtype">int</span> choose_limiter(<span class="keywordtype">int</span> dir, <span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k, <span class="keywordtype">int</span> pl);</div>
<div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;</div>
<div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;</div>
<div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;</div>
<div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;</div>
<div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;</div>
<div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;</div>
<div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;</div>
<div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;  <span class="comment">// ADD DIFFUSIVE CORRECTIONS</span></div>
<div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;</div>
<div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;</div>
<div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;</div>
<div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;  <span class="comment">// add diffusive term</span></div>
<div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;  <span class="comment">// must come after FLUXCT</span></div>
<div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;  <span class="keywordflow">if</span>((<a class="code" href="../../d8/d5b/defs_8general_8h.html#a11c4e99e1493d0c1914ad1ab313ea472">FLUXB</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a5c288047377b976b5c630d0eb8856257">ATHENA1</a>)||(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a11c4e99e1493d0c1914ad1ab313ea472">FLUXB</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a203809114fcd4d7fc35a2a22538dd6c1">ATHENA2</a>)){</div>
<div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;</div>
<div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;    <span class="comment">// Stone &amp; Gardiner point out that Toth FLUXCT and FLUXCD not consistent with underlying integration algorithm for plane-parallel, grid-aligned flows.</span></div>
<div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;    <span class="comment">// fix is to change 0.25 to 0.5 and use a diffusive term as in ATHENA1</span></div>
<div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;</div>
<div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;    <span class="comment">/* Stone &amp; Gardiner eq. 39 */</span></div>
<div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;    <span class="comment">// Charles Gammie (8/17/05) says this is simple, but repairs HARM defect that 2D does not reduce to 1D when waves are along coordinate lines</span></div>
<div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;</div>
<div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;</div>
<div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;    <span class="comment">//    COMPEMFZLOOP{</span></div>
<div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;<span class="preprocessor">#pragma omp parallel </span></div>
<div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;<span class="preprocessor"></span>    {</div>
<div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;      <span class="keywordtype">int</span> <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>,<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>,k,l;</div>
<div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;      <span class="comment">// gdet-type geometry below</span></div>
<div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;      <span class="keyword">struct </span><a class="code" href="../../d6/d39/global_8structs_8h.html#a91ee2a91251b6d836d6cd3505d4d0a68">of_gdetgeom</a> geomf1dontuse,geomf2dontuse,geomf3dontuse;</div>
<div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;      <span class="keyword">struct </span><a class="code" href="../../d6/d39/global_8structs_8h.html#a91ee2a91251b6d836d6cd3505d4d0a68">of_gdetgeom</a> *ptrgeomf1=&amp;geomf1dontuse,*ptrgeomf2=&amp;geomf2dontuse,*ptrgeomf3=&amp;geomf3dontuse;</div>
<div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> diffusiveterm[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> emfmm[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>],emfpm[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>],emfmp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>],emfpp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>],alpha[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>] ;</div>
<div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;</div>
<div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;</div>
<div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;      <a class="code" href="../../d5/d7b/global_8openmploops_8h.html#a1389db2daf5bd9e94918090c253a16c9">OPENMP3DLOOPVARSDEFINE</a>; <a class="code" href="../../d5/d7b/global_8openmploops_8h.html#a8de37da93c3462c536ef830f2fbaee61" title="forced to be a computational loop, so start/stop cannot already have shifts in them (which is normal ...">OPENMP3DLOOPSETUP</a>(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#aeda829ce40d3de342ad1db600d73e3f4">INFULLP11</a>,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9c8f32b3fd97dc74d6a8d8dd709ad4f6">OUTFULL1</a>,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#aaab4343916fe960f989cfa812847aff4">INFULLP12</a>,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#aa99c957b2837fd1878ee5c659baf71f2">OUTFULL2</a>,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#aaad67791f2a0ca2cce882e4cf61d4ed6">INFULLP13</a>,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#af9b4b1cbfa52acafbd2b434f78e49392">OUTFULL3</a>);</div>
<div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;</div>
<div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;      <span class="comment">// generally ptr&#39;s are different inside parallel block</span></div>
<div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;      ptrgeomf1=&amp;geomf1dontuse;</div>
<div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;      ptrgeomf2=&amp;geomf2dontuse;</div>
<div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;      ptrgeomf3=&amp;geomf3dontuse;</div>
<div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;</div>
<div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;</div>
<div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;<span class="preprocessor">#pragma omp for schedule(OPENMPFULLNOVARYSCHEDULE())</span></div>
<div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;<span class="preprocessor"></span>      <a class="code" href="../../d5/d7b/global_8openmploops_8h.html#a9e48537d3cb58cc3a3765b8a18b43b15" title="Oddly, performance changes by 10% when changing how start and stop blockijk (and fixing how used too ...">OPENMP3DLOOPBLOCK</a>{</div>
<div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;        <a class="code" href="../../df/d1c/global_8storage_8h.html#a96983b0c56e836f50cb7c1af16f59fb6">OPENMP3DLOOPBLOCK2IJK</a>(i,j,k);</div>
<div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;</div>
<div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;        <span class="comment">// {emf}_i=-\epsilon_{ijk} v^i B^k</span></div>
<div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;</div>
<div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;</div>
<div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;        <span class="comment">// average of the below results in averaged emf located at corner (CORN)</span></div>
<div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;        <span class="comment">// same sign as F&#39;s (B^2 v^1 - B^1 v^2) with gdet built into vconemf</span></div>
<div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;</div>
<div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;        <span class="comment">// could remove gdet from vconemf and F1/F2 and put gdet at CORN for final result!  Avoids axis problems?</span></div>
<div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;        <span class="comment">// applies to above Toth version as well!</span></div>
<div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;        <span class="comment">// GODMARK</span></div>
<div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;</div>
<div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;<span class="preprocessor">#if((N2&gt;1)||(N3&gt;1))</span></div>
<div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;<span class="preprocessor"></span>        <span class="comment">// emf_1</span></div>
<div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;        emfmp[1] = </div>
<div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;          <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,i  ,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),k  ,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>)*<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(vconemf,i  ,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),k  ,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae907e773ef038f3fc0c2ad5de0cb0f07">U2</a>) -</div>
<div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;          <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,i  ,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),k  ,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>)*<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(vconemf,i  ,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),k  ,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8de9104f1fffa59f057b214d74c5cfea">U3</a>) ;</div>
<div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;        emfmm[1] = </div>
<div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;          <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,i  ,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#af08e27a43532afdccfdb21fcdea20871">km1mac</a>(k),<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>)*<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(vconemf,i  ,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#af08e27a43532afdccfdb21fcdea20871">km1mac</a>(k),<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae907e773ef038f3fc0c2ad5de0cb0f07">U2</a>) -</div>
<div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;          <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,i  ,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#af08e27a43532afdccfdb21fcdea20871">km1mac</a>(k),<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>)*<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(vconemf,i  ,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#af08e27a43532afdccfdb21fcdea20871">km1mac</a>(k),<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8de9104f1fffa59f057b214d74c5cfea">U3</a>) ;</div>
<div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;        emfpm[1] = </div>
<div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;          <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,i  ,j  ,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#af08e27a43532afdccfdb21fcdea20871">km1mac</a>(k),<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>)*<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(vconemf,i  ,j  ,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#af08e27a43532afdccfdb21fcdea20871">km1mac</a>(k),<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae907e773ef038f3fc0c2ad5de0cb0f07">U2</a>) -</div>
<div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;          <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,i  ,j  ,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#af08e27a43532afdccfdb21fcdea20871">km1mac</a>(k),<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>)*<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(vconemf,i  ,j  ,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#af08e27a43532afdccfdb21fcdea20871">km1mac</a>(k),<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8de9104f1fffa59f057b214d74c5cfea">U3</a>) ;</div>
<div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;        emfpp[1] = </div>
<div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;          <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,i  ,j  ,k  ,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>)*<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(vconemf,i  ,j  ,k  ,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae907e773ef038f3fc0c2ad5de0cb0f07">U2</a>) -</div>
<div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;          <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,i  ,j  ,k  ,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>)*<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(vconemf,i  ,j  ,k  ,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8de9104f1fffa59f057b214d74c5cfea">U3</a>) ;</div>
<div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;<span class="preprocessor">#if((N1&gt;1)||(N3&gt;1))</span></div>
<div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;<span class="preprocessor"></span>        <span class="comment">// emf_2</span></div>
<div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;        emfmp[2] = </div>
<div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;          <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),j  ,k  ,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>)*<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(vconemf,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),j  ,k  ,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8de9104f1fffa59f057b214d74c5cfea">U3</a>) -</div>
<div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;          <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),j  ,k  ,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>)*<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(vconemf,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),j  ,k  ,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>) ;</div>
<div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;        emfmm[2] = </div>
<div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;          <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),j  ,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#af08e27a43532afdccfdb21fcdea20871">km1mac</a>(k),<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>)*<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(vconemf,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),j  ,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#af08e27a43532afdccfdb21fcdea20871">km1mac</a>(k),<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8de9104f1fffa59f057b214d74c5cfea">U3</a>) -</div>
<div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;          <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),j  ,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#af08e27a43532afdccfdb21fcdea20871">km1mac</a>(k),<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>)*<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(vconemf,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),j  ,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#af08e27a43532afdccfdb21fcdea20871">km1mac</a>(k),<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>) ;</div>
<div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;        emfpm[2] = </div>
<div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;          <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,i  ,j  ,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#af08e27a43532afdccfdb21fcdea20871">km1mac</a>(k),<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>)*<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(vconemf,i  ,j  ,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#af08e27a43532afdccfdb21fcdea20871">km1mac</a>(k),<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8de9104f1fffa59f057b214d74c5cfea">U3</a>) -</div>
<div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;          <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,i  ,j  ,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#af08e27a43532afdccfdb21fcdea20871">km1mac</a>(k),<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>)*<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(vconemf,i  ,j  ,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#af08e27a43532afdccfdb21fcdea20871">km1mac</a>(k),<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>) ;</div>
<div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;        emfpp[2] = </div>
<div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;          <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,i  ,j  ,k  ,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>)*<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(vconemf,i  ,j  ,k  ,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8de9104f1fffa59f057b214d74c5cfea">U3</a>) -</div>
<div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;          <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,i  ,j  ,k  ,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>)*<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(vconemf,i  ,j  ,k  ,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>) ;</div>
<div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;<span class="preprocessor">#if((N1&gt;1)||(N2&gt;1))</span></div>
<div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;<span class="preprocessor"></span>        <span class="comment">// emf_3 (same sign as FLUXCT method as emf[3])</span></div>
<div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;        emfmp[3] = </div>
<div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;          <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),j  ,k  ,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>)*<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(vconemf,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),j  ,k  ,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>) -</div>
<div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;          <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),j  ,k  ,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>)*<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(vconemf,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),j  ,k  ,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae907e773ef038f3fc0c2ad5de0cb0f07">U2</a>) ;</div>
<div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;        emfmm[3] = </div>
<div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;          <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),k  ,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>)*<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(vconemf,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),k  ,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>) -</div>
<div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;          <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),k  ,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>)*<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(vconemf,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),k  ,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae907e773ef038f3fc0c2ad5de0cb0f07">U2</a>) ;</div>
<div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;        emfpm[3] = </div>
<div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;          <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,i  ,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),k  ,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>)*<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(vconemf,i  ,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),k  ,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>) -</div>
<div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;          <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,i  ,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),k  ,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>)*<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(vconemf,i  ,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),k  ,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae907e773ef038f3fc0c2ad5de0cb0f07">U2</a>) ;</div>
<div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;        emfpp[3] = </div>
<div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;          <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,i  ,j  ,k  ,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>)*<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(vconemf,i  ,j  ,k  ,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>) -</div>
<div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;          <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,i  ,j  ,k  ,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>)*<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(vconemf,i  ,j  ,k  ,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae907e773ef038f3fc0c2ad5de0cb0f07">U2</a>) ;</div>
<div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;        <span class="keywordflow">for</span>(l=1;l&lt;=3;l++){</div>
<div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;          diffusiveterm[l]= 0.25*(emfmp[l] + emfmm[l] + emfpm[l] + emfpp[l]);</div>
<div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;        }</div>
<div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;</div>
<div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;<span class="preprocessor">#if(CORNGDETVERSION)// then tack on geometry</span></div>
<div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;<span class="preprocessor"></span>      </div>
<div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;        <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a9740cb914b7803b1ba73f76a9a37ddc2">get_geometry_gdetmix</a>(i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a1068bcf25c9f187a8db0f422e0af64c8">CORN1</a>,ptrgeomf1);</div>
<div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;        <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a9740cb914b7803b1ba73f76a9a37ddc2">get_geometry_gdetmix</a>(i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab10e4ab484f1edd4cecb418ff22a743a">CORN2</a>,ptrgeomf2);</div>
<div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;        <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a9740cb914b7803b1ba73f76a9a37ddc2">get_geometry_gdetmix</a>(i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a1a05e117efd4dbc39b7c590141004470">CORN3</a>,ptrgeomf3);</div>
<div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;      </div>
<div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;        <span class="comment">// obviously ptrgeom-&gt;EOMFUNCMAC(B2) has to be equal to ptrgeom-&gt;EOMFUNCMAC(B3) for this method</span></div>
<div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;        diffusiveterm[1] *=(ptrgeomf1-&gt;EOMFUNCMAC(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>));</div>
<div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;        <span class="comment">// obviously ptrgeom-&gt;EOMFUNCMAC(B1) has to be equal to ptrgeom-&gt;EOMFUNCMAC(B2) for this method</span></div>
<div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;        diffusiveterm[2] *=(ptrgeomf2-&gt;EOMFUNCMAC(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>));</div>
<div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;        <span class="comment">// obviously ptrgeom-&gt;EOMFUNCMAC(B1) has to be equal to ptrgeom-&gt;EOMFUNCMAC(B2) for this method</span></div>
<div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;        diffusiveterm[3] *=(ptrgeomf3-&gt;EOMFUNCMAC(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>));</div>
<div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;        <span class="comment">// now add diffusive term to emf</span></div>
<div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;        <span class="comment">// notice original emf multiplied by 2 to account for diffusive term being subtracted, so result is consistent</span></div>
<div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;        <span class="keywordflow">for</span>(l=1;l&lt;=3;l++){</div>
<div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;          <a class="code" href="../../df/d1c/global_8storage_8h.html#a4589594cbb3d23d258245b68273e6df6">MACP1A0</a>(emf,l,i,j,k) = 2.0*<a class="code" href="../../df/d1c/global_8storage_8h.html#a4589594cbb3d23d258245b68273e6df6">MACP1A0</a>(emf,l,i,j,k) - diffusiveterm[l];</div>
<div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;        }</div>
<div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;</div>
<div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;</div>
<div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;      }<span class="comment">// end COMPEMFZLOOP</span></div>
<div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;    }<span class="comment">// end parallel region</span></div>
<div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;</div>
<div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;  }<span class="comment">// end ATHENA1</span></div>
<div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;      </div>
<div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;</div>
<div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;</div>
<div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;</div>
<div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;</div>
<div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;</div>
<div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;</div>
<div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;</div>
<div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;</div>
<div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;</div>
<div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;  <span class="comment">// add another diffusive flux correction</span></div>
<div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;  <span class="comment">// must come after ATHENA1</span></div>
<div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a11c4e99e1493d0c1914ad1ab313ea472">FLUXB</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a203809114fcd4d7fc35a2a22538dd6c1">ATHENA2</a>){</div>
<div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;</div>
<div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;</div>
<div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;</div>
<div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#ad0b6e48e02378f461462c8f802915a50" title="whether to control the limiter">LIMADJUST</a>&gt;0 || <a class="code" href="../../da/d3e/definit_8h.html#a8a8227c8986e227a98cea80cf813eada" title="whether to have dq&#39;s : only used by second order methods">DODQMEMORY</a>==0 || choose_limiter(1, 0,0,0,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>)&gt;=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a4a9bbfdf5f09030f9a6e13286d150201">PARA</a> || choose_limiter(2, 0,0,0,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>)&gt;=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a4a9bbfdf5f09030f9a6e13286d150201">PARA</a> || choose_limiter(3, 0,0,0,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>)&gt;=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a4a9bbfdf5f09030f9a6e13286d150201">PARA</a>){ <span class="comment">// note only look at one point and one variable here for test</span></div>
<div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;      dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;Cannot use Athena2 with limadjust since dq&#39;s not defined\n&quot;</span>);</div>
<div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;      myexit(11);</div>
<div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;    }</div>
<div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;</div>
<div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;    <span class="comment">// GODMARK</span></div>
<div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;    <span class="comment">// should just use unrescaled p2interp stored, but need one for each direction.</span></div>
<div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;    <span class="comment">// should also use wave speeds from edges?</span></div>
<div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;</div>
<div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;</div>
<div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;</div>
<div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;</div>
<div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;    <span class="comment">/* Stone &amp; Gardiner eq. 48 */</span></div>
<div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;    <span class="comment">// Charles Gammie (8/17/05) says does much better on flux loop advection test than ordinary HARM</span></div>
<div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;    <span class="comment">//    COMPLOOPINFP1{ // constrain or control better? GODMARK</span></div>
<div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;    <span class="comment">//    COMPEMFZLOOP{</span></div>
<div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;<span class="preprocessor">#pragma omp parallel OPENMPGLOBALPRIVATEFORSTATEANDGEOM // requires full copyin()</span></div>
<div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;<span class="preprocessor"></span>    {</div>
<div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;      <span class="comment">// Below stuff is for Athena 1 and Athena 2</span></div>
<div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;      <span class="keywordtype">int</span> dir;</div>
<div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;      <span class="keywordtype">int</span> <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>,<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>,k,l,pl,pliter;</div>
<div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;      <span class="comment">// gdet-type geometry below</span></div>
<div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;      <span class="keyword">struct </span><a class="code" href="../../d6/d39/global_8structs_8h.html#a91ee2a91251b6d836d6cd3505d4d0a68">of_gdetgeom</a> geomf1dontuse,geomf2dontuse,geomf3dontuse;</div>
<div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;      <span class="keyword">struct </span><a class="code" href="../../d6/d39/global_8structs_8h.html#a91ee2a91251b6d836d6cd3505d4d0a68">of_gdetgeom</a> *ptrgeomf1=&amp;geomf1dontuse,*ptrgeomf2=&amp;geomf2dontuse,*ptrgeomf3=&amp;geomf3dontuse;</div>
<div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> diffusiveterm[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> emfmm[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>],emfpm[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>],emfmp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>],emfpp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>],alpha[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>] ;</div>
<div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;      <span class="comment">// Gammie stuff</span></div>
<div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> B1pp,B1pm,B1mp,B1mm;</div>
<div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> B2pp,B2pm,B2mp,B2mm ;</div>
<div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> B3pp,B3pm,B3mp,B3mm ;</div>
<div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> U1pp,U1pm,U1mp,U1mm;</div>
<div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> U2pp,U2pm,U2mp,U2mm ;</div>
<div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> U3pp,U3pm,U3mp,U3mm ;</div>
<div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;      <span class="comment">//  FTYPE cms_func(FTYPE *prim_var) ;</span></div>
<div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> B1d,B1u,B1l,B1r;</div>
<div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> B2d,B2u,B2l,B2r;</div>
<div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> B3d,B3u,B3l,B3r;</div>
<div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> pbavg[NPR];</div>
<div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;      <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> state;</div>
<div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;      <span class="keywordtype">int</span> ignorecourant;</div>
<div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> cmax1,cmin1,cmax2,cmin2,ctop1,ctop2;</div>
<div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;      <span class="keyword">struct </span><a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> geomco1dontuse,geomco2dontuse,geomco3dontuse;</div>
<div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;      <span class="keyword">struct </span><a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeomco1=&amp;geomco1dontuse,*ptrgeomco2=&amp;geomco2dontuse,*ptrgeomco3=&amp;geomco3dontuse;</div>
<div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;</div>
<div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;</div>
<div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;      <a class="code" href="../../d5/d7b/global_8openmploops_8h.html#a1389db2daf5bd9e94918090c253a16c9">OPENMP3DLOOPVARSDEFINE</a>; <a class="code" href="../../d5/d7b/global_8openmploops_8h.html#a8de37da93c3462c536ef830f2fbaee61" title="forced to be a computational loop, so start/stop cannot already have shifts in them (which is normal ...">OPENMP3DLOOPSETUP</a>(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#aeda829ce40d3de342ad1db600d73e3f4">INFULLP11</a>,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9c8f32b3fd97dc74d6a8d8dd709ad4f6">OUTFULL1</a>,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#aaab4343916fe960f989cfa812847aff4">INFULLP12</a>,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#aa99c957b2837fd1878ee5c659baf71f2">OUTFULL2</a>,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#aaad67791f2a0ca2cce882e4cf61d4ed6">INFULLP13</a>,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#af9b4b1cbfa52acafbd2b434f78e49392">OUTFULL3</a>);</div>
<div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;</div>
<div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;</div>
<div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;      <span class="comment">// generally ptr&#39;s are different inside parallel block</span></div>
<div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;      ptrgeomf1=&amp;geomf1dontuse;</div>
<div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;      ptrgeomf2=&amp;geomf2dontuse;</div>
<div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;      ptrgeomf3=&amp;geomf3dontuse;</div>
<div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;      ptrgeomco1=&amp;geomco1dontuse;</div>
<div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;      ptrgeomco2=&amp;geomco2dontuse;</div>
<div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;      ptrgeomco3=&amp;geomco3dontuse;</div>
<div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;</div>
<div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;<span class="preprocessor">#pragma omp for schedule(OPENMPFULLNOVARYSCHEDULE())</span></div>
<div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;<span class="preprocessor"></span>      <a class="code" href="../../d5/d7b/global_8openmploops_8h.html#a9e48537d3cb58cc3a3765b8a18b43b15" title="Oddly, performance changes by 10% when changing how start and stop blockijk (and fixing how used too ...">OPENMP3DLOOPBLOCK</a>{</div>
<div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;        <a class="code" href="../../df/d1c/global_8storage_8h.html#a96983b0c56e836f50cb7c1af16f59fb6">OPENMP3DLOOPBLOCK2IJK</a>(i,j,k);</div>
<div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;</div>
<div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;</div>
<div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;        <span class="comment">// dq1 and dq2 and dq3 are well-defined from fluxcalc() (both directions)</span></div>
<div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;     </div>
<div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;</div>
<div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;        <span class="comment">// simple average of 1-D linear extrapolation here, where could use p2interp data saved from step_ch.c?  still available by this function call?</span></div>
<div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;</div>
<div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;</div>
<div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;<span class="preprocessor">#if((N2&gt;1)||(N3&gt;1))</span></div>
<div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;<span class="preprocessor"></span>        <span class="comment">// for emf_1</span></div>
<div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;</div>
<div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;        <span class="comment">// B2 located at FACE2 @ (k-1)</span></div>
<div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;        B2d = 0.5*(</div>
<div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;                   <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,i,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#af08e27a43532afdccfdb21fcdea20871">km1mac</a>(k),<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>) + 0.5*<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(dq2,i,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#af08e27a43532afdccfdb21fcdea20871">km1mac</a>(k),<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>) +</div>
<div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;                   <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,i,j  ,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#af08e27a43532afdccfdb21fcdea20871">km1mac</a>(k),<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>) - 0.5*<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(dq2,i,j  ,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#af08e27a43532afdccfdb21fcdea20871">km1mac</a>(k),<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>)</div>
<div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;                   ) ;</div>
<div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;</div>
<div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;        <span class="comment">// B2 located at FACE2 @ (k)</span></div>
<div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;        B2u = 0.5*(</div>
<div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;                   <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,i,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>) + 0.5*<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(dq2,i,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>) +</div>
<div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;                   <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,i,j  ,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>) - 0.5*<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(dq2,i,j  ,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>)</div>
<div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;                   ) ;</div>
<div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;</div>
<div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;        <span class="comment">// B3 located at FACE3 @ (j-1)</span></div>
<div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;        B3l = 0.5*(</div>
<div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;                   <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,i,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#af08e27a43532afdccfdb21fcdea20871">km1mac</a>(k),<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>) + 0.5*<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(dq3,i,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#af08e27a43532afdccfdb21fcdea20871">km1mac</a>(k),<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>) +</div>
<div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;                   <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,i,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),k  ,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>) - 0.5*<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(dq3,i,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),k  ,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>)</div>
<div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;                   ) ;</div>
<div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;        <span class="comment">// B3 located at FACE3 @ j</span></div>
<div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;        B3r = 0.5*(</div>
<div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;                   <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,i,j,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#af08e27a43532afdccfdb21fcdea20871">km1mac</a>(k),<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>) + 0.5*<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(dq3,i,j,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#af08e27a43532afdccfdb21fcdea20871">km1mac</a>(k),<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>) +</div>
<div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;                   <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,i,j,k  ,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>) - 0.5*<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(dq3,i,j,k  ,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>)</div>
<div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;                   ) ;</div>
<div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;</div>
<div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;        <span class="comment">// B2 for all centers around CORN1</span></div>
<div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;        <span class="comment">// B2[j - mp][k - mp]</span></div>
<div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;        B2mm = <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,i,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#af08e27a43532afdccfdb21fcdea20871">km1mac</a>(k),<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>) ;</div>
<div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;        B2mp = <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,i,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),k  ,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>) ;</div>
<div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;        B2pm = <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,i,j  ,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#af08e27a43532afdccfdb21fcdea20871">km1mac</a>(k),<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>) ;</div>
<div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;        B2pp = <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,i,j  ,k  ,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>) ;</div>
<div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;</div>
<div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;        <span class="comment">// B3 for all centers around CORN1</span></div>
<div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;        <span class="comment">// B3[j - mp][k - mp]</span></div>
<div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;        B3mm = <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,i,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#af08e27a43532afdccfdb21fcdea20871">km1mac</a>(k),<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>) ;</div>
<div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;        B3mp = <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,i,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),k  ,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>) ;</div>
<div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;        B3pm = <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,i,j  ,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#af08e27a43532afdccfdb21fcdea20871">km1mac</a>(k),<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>) ;</div>
<div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;        B3pp = <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,i,j  ,k  ,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>) ;</div>
<div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;</div>
<div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;        <span class="comment">// compute characteristic velocity -- only for Athena2 method</span></div>
<div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;</div>
<div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;</div>
<div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;        <span class="comment">// average pb to CORN1 for average phase speed there</span></div>
<div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) pbavg[pl]=0.25*(<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,i,j,k,pl)+<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,i,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),k,pl)+<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,i,j,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#af08e27a43532afdccfdb21fcdea20871">km1mac</a>(k),pl)+<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,i,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#af08e27a43532afdccfdb21fcdea20871">km1mac</a>(k),pl));</div>
<div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;        <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a3059ed7bfcfb692cbe8014d55fd7c1e4">get_geometry</a>(i, j, k, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a1068bcf25c9f187a8db0f422e0af64c8">CORN1</a>, ptrgeomco1); <span class="comment">// used here and below emf&#39;s</span></div>
<div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;        <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a11e17cd8b0594d1ad52e3594aa9f477e" title="find ucon, ucov, bcon, bcov from primitive variables when calling get_state, users of this function e...">get_state</a>(pbavg, ptrgeomco1, &amp;state),&quot;<a class="code" href="../../d9/de0/step__ch_8c.html#afe241569412f22a86dea9cd91b516af8" title="take step itself">step_ch</a>.c:flux_ct()&quot;, &quot;<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a11e17cd8b0594d1ad52e3594aa9f477e" title="find ucon, ucov, bcon, bcov from primitive variables when calling get_state, users of this function e...">get_state</a>()&quot;, 1);</div>
<div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;        <span class="comment">// KORALNOTE: Correct because this applies to the diffusive term only for the magnetic field evolution, so needs to stay vchar()</span></div>
<div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;        dir=2; <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(<a class="code" href="../../d8/d20/vchar_8c.html#acdcca98ca82b041999cdb29fdf958a22" title="Charles believed that near polar axis one should set vmax=vmin=0, but not right since makes flux comp...">vchar</a>(pbavg, &amp;state, dir, ptrgeomco1, &amp;cmax1, &amp;cmin1,&amp;ignorecourant),&quot;<a class="code" href="../../d9/de0/step__ch_8c.html#afe241569412f22a86dea9cd91b516af8" title="take step itself">step_ch</a>.c:flux_ct()&quot;, &quot;<a class="code" href="../../d8/d20/vchar_8c.html#acdcca98ca82b041999cdb29fdf958a22" title="Charles believed that near polar axis one should set vmax=vmin=0, but not right since makes flux comp...">vchar</a>() dir=1&quot;, 1);</div>
<div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;        dir=3; <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(<a class="code" href="../../d8/d20/vchar_8c.html#acdcca98ca82b041999cdb29fdf958a22" title="Charles believed that near polar axis one should set vmax=vmin=0, but not right since makes flux comp...">vchar</a>(pbavg, &amp;state, dir, ptrgeomco1, &amp;cmax2, &amp;cmin2,&amp;ignorecourant),&quot;<a class="code" href="../../d9/de0/step__ch_8c.html#afe241569412f22a86dea9cd91b516af8" title="take step itself">step_ch</a>.c:flux_ct()&quot;, &quot;<a class="code" href="../../d8/d20/vchar_8c.html#acdcca98ca82b041999cdb29fdf958a22" title="Charles believed that near polar axis one should set vmax=vmin=0, but not right since makes flux comp...">vchar</a>() dir=2&quot;, 2);</div>
<div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;        ctop1 = <a class="code" href="../../dc/dc2/f2c_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a>(fabs(cmax1), fabs(cmin1));</div>
<div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;        ctop2 = <a class="code" href="../../dc/dc2/f2c_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a>(fabs(cmax2), fabs(cmin2));</div>
<div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;        <span class="comment">//      alpha=0.5*(ctop1+ctop2); // use average?</span></div>
<div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;        <span class="comment">//      alpha=max(ctop1,ctop2); // use maximum?</span></div>
<div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;        <span class="comment">// seems alpha can be arbitrary since 0 is ATHENA1</span></div>
<div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;</div>
<div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;        <span class="comment">//      alpha = dx1/dt ; /* crude approx */</span></div>
<div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;</div>
<div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;</div>
<div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;        <span class="comment">// GODMARK: seems to have left/right and up/down asymmetry due to subtraction</span></div>
<div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;        <span class="comment">// if fabs were around each sutracted term, then would be ok (e.g. fabs(B1d-B1u))</span></div>
<div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;</div>
<div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;        <span class="comment">// notice that ctop1 and ctop2 have different &quot;units&quot;, so cannot use with B2/B3 arbitrarily, must be consistent.</span></div>
<div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;        diffusiveterm[1] =  0.125*(</div>
<div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;                                   +ctop1*(</div>
<div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;                                           + B2d - B2mm - B2u + B2mp</div>
<div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;                                           + B2d - B2pm - B2u + B2pp</div>
<div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;                                           )</div>
<div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;                                   +ctop2*(</div>
<div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;                                           + B3r - B3pm - B3l + B3mm</div>
<div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;                                           + B3r - B3pp - B3l + B3mp</div>
<div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;                                           )</div>
<div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;                                   ) ;</div>
<div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;<span class="preprocessor">#if((N1&gt;1)||(N3&gt;1))</span></div>
<div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;<span class="preprocessor"></span>        <span class="comment">// for emf_2</span></div>
<div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;</div>
<div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;        <span class="comment">// B3 located at FACE3 @ (i-1)</span></div>
<div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;        B3d = 0.5*(</div>
<div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;                   <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),j,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#af08e27a43532afdccfdb21fcdea20871">km1mac</a>(k),<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>) + 0.5*<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(dq3,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),j,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#af08e27a43532afdccfdb21fcdea20871">km1mac</a>(k),<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>) +</div>
<div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;                   <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),j,k  ,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>) - 0.5*<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(dq3,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),j,k  ,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>)</div>
<div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;                   ) ;</div>
<div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;</div>
<div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;        <span class="comment">// B3 located at FACE3 @ (i)</span></div>
<div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;        B3u = 0.5*(</div>
<div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;                   <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,i,j,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#af08e27a43532afdccfdb21fcdea20871">km1mac</a>(k),<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>) + 0.5*<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(dq3,i,j,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#af08e27a43532afdccfdb21fcdea20871">km1mac</a>(k),<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>) +</div>
<div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;                   <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,i,j,k  ,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>) - 0.5*<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(dq3,i,j,k  ,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>)</div>
<div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;                   ) ;</div>
<div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;</div>
<div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;        <span class="comment">// B3 located at FACE1 @ (k-1)</span></div>
<div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;        B1l = 0.5*(</div>
<div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;                   <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),j,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#af08e27a43532afdccfdb21fcdea20871">km1mac</a>(k),<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>) + 0.5*<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(dq1,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),j,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#af08e27a43532afdccfdb21fcdea20871">km1mac</a>(k),<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>) +</div>
<div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;                   <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,i  ,j,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#af08e27a43532afdccfdb21fcdea20871">km1mac</a>(k),<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>) - 0.5*<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(dq1,i  ,j,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#af08e27a43532afdccfdb21fcdea20871">km1mac</a>(k),<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>)</div>
<div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;                   ) ;</div>
<div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;        <span class="comment">// B1 located at FACE1 @ k</span></div>
<div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;        B1r = 0.5*(</div>
<div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;                   <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>) + 0.5*<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(dq1,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>) +</div>
<div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;                   <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,i  ,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>) - 0.5*<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(dq1,i  ,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>)</div>
<div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;                   ) ;</div>
<div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;</div>
<div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;        <span class="comment">// B3 for all centers around CORN1</span></div>
<div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;        <span class="comment">// B3[k - mp][i - mp]</span></div>
<div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;        B3mm = <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),j,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#af08e27a43532afdccfdb21fcdea20871">km1mac</a>(k),<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>) ;</div>
<div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;        B3mp = <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,i  ,j,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#af08e27a43532afdccfdb21fcdea20871">km1mac</a>(k),<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>) ;</div>
<div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;        B3pm = <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),j,k  ,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>) ;</div>
<div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;        B3pp = <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,i  ,j,k  ,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>) ;</div>
<div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;</div>
<div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;        <span class="comment">// B1 for all centers around CORN1</span></div>
<div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;        <span class="comment">// B1[k - mp][i - mp]</span></div>
<div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;        B1mm = <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),j,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#af08e27a43532afdccfdb21fcdea20871">km1mac</a>(k),<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>) ;</div>
<div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;        B1mp = <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,i  ,j,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#af08e27a43532afdccfdb21fcdea20871">km1mac</a>(k),<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>) ;</div>
<div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;        B1pm = <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),j,k  ,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>) ;</div>
<div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;        B1pp = <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,i  ,j,k  ,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>) ;</div>
<div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;</div>
<div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;        <span class="comment">// compute characteristic velocity -- only for Athena2 method</span></div>
<div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;</div>
<div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;</div>
<div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;        <span class="comment">// average pb to CORN1 for average phase speed there</span></div>
<div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) pbavg[pl]=0.25*(<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,i,j,k,pl)+<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),j,k,pl)+<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,i,j,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#af08e27a43532afdccfdb21fcdea20871">km1mac</a>(k),pl)+<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),j,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#af08e27a43532afdccfdb21fcdea20871">km1mac</a>(k),pl));</div>
<div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;        <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a3059ed7bfcfb692cbe8014d55fd7c1e4">get_geometry</a>(i, j, k, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab10e4ab484f1edd4cecb418ff22a743a">CORN2</a>, ptrgeomco2); <span class="comment">// used here and below emf&#39;s</span></div>
<div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;        <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(get_state(pbavg, ptrgeomco2, &amp;state),&quot;<a class="code" href="../../d9/de0/step__ch_8c.html#afe241569412f22a86dea9cd91b516af8" title="take step itself">step_ch</a>.c:flux_ct()&quot;, &quot;get_state()&quot;, 1);</div>
<div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;        dir=3; <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(<a class="code" href="../../d8/d20/vchar_8c.html#acdcca98ca82b041999cdb29fdf958a22" title="Charles believed that near polar axis one should set vmax=vmin=0, but not right since makes flux comp...">vchar</a>(pbavg, &amp;state, dir, ptrgeomco2, &amp;cmax1, &amp;cmin1,&amp;ignorecourant),&quot;<a class="code" href="../../d9/de0/step__ch_8c.html#afe241569412f22a86dea9cd91b516af8" title="take step itself">step_ch</a>.c:flux_ct()&quot;, &quot;<a class="code" href="../../d8/d20/vchar_8c.html#acdcca98ca82b041999cdb29fdf958a22" title="Charles believed that near polar axis one should set vmax=vmin=0, but not right since makes flux comp...">vchar</a>() dir=1&quot;, 1);</div>
<div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;        dir=1; <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(<a class="code" href="../../d8/d20/vchar_8c.html#acdcca98ca82b041999cdb29fdf958a22" title="Charles believed that near polar axis one should set vmax=vmin=0, but not right since makes flux comp...">vchar</a>(pbavg, &amp;state, dir, ptrgeomco2, &amp;cmax2, &amp;cmin2,&amp;ignorecourant),&quot;<a class="code" href="../../d9/de0/step__ch_8c.html#afe241569412f22a86dea9cd91b516af8" title="take step itself">step_ch</a>.c:flux_ct()&quot;, &quot;<a class="code" href="../../d8/d20/vchar_8c.html#acdcca98ca82b041999cdb29fdf958a22" title="Charles believed that near polar axis one should set vmax=vmin=0, but not right since makes flux comp...">vchar</a>() dir=2&quot;, 2);</div>
<div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;        ctop1 = <a class="code" href="../../dc/dc2/f2c_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a>(fabs(cmax1), fabs(cmin1));</div>
<div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;        ctop2 = <a class="code" href="../../dc/dc2/f2c_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a>(fabs(cmax2), fabs(cmin2));</div>
<div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;        <span class="comment">//      alpha=0.5*(ctop1+ctop2); // use average?</span></div>
<div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;        <span class="comment">//     alpha=max(ctop1,ctop2); // use maximum?</span></div>
<div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;        <span class="comment">// seems alpha can be arbitrary since 0 is ATHENA1</span></div>
<div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;</div>
<div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;        <span class="comment">//      alpha = dx1/dt ; /* crude approx */</span></div>
<div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;</div>
<div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;</div>
<div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;        <span class="comment">// GODMARK: seems to have left/right and up/down asymmetry due to subtraction</span></div>
<div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;        <span class="comment">// if fabs were around each sutracted term, then would be ok (e.g. fabs(B3d-B3u))</span></div>
<div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;</div>
<div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;        <span class="comment">// notice that ctop1 and ctop2 have different &quot;units&quot;, so cannot use with B2/B3 arbitrarily, must be consistent.</span></div>
<div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;        diffusiveterm[2] =  0.125*(</div>
<div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;                                   +ctop1*(</div>
<div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;                                           + B3d - B3mm - B3u + B3mp</div>
<div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;                                           + B3d - B3pm - B3u + B3pp</div>
<div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;                                           )</div>
<div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;                                   +ctop2*(</div>
<div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;                                           + B1r - B1pm - B1l + B1mm</div>
<div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;                                           + B1r - B1pp - B1l + B1mp</div>
<div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;                                           )</div>
<div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;                                   ) ;</div>
<div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;<span class="preprocessor">#if((N1&gt;1)||(N2&gt;1))</span></div>
<div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;<span class="preprocessor"></span>        <span class="comment">// for emf_3</span></div>
<div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;</div>
<div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;        <span class="comment">// B1 located at FACE1 @ (j-1)</span></div>
<div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;        B1d = 0.5*(</div>
<div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;                   <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>) + 0.5*<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(dq1,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>) +</div>
<div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;                   <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,i  ,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>) - 0.5*<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(dq1,i  ,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>)</div>
<div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;                   ) ;</div>
<div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;</div>
<div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;        <span class="comment">// B1 located at FACE1 @ j</span></div>
<div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;        B1u = 0.5*(</div>
<div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;                   <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>) + 0.5*<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(dq1,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>) +</div>
<div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;                   <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,i  ,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>) - 0.5*<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(dq1,i  ,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>)</div>
<div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;                   ) ;</div>
<div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;</div>
<div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;        <span class="comment">// B2 located at FACE2 @ (i-1)</span></div>
<div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;        B2l = 0.5*(</div>
<div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;                   <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>) + 0.5*<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(dq2,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>) +</div>
<div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;                   <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),j  ,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>) - 0.5*<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(dq2,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),j  ,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>)</div>
<div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;                   ) ;</div>
<div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;        <span class="comment">// B2 located at FACE2 @ i</span></div>
<div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;        B2r = 0.5*(</div>
<div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;                   <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,i,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>) + 0.5*<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(dq2,i,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>) +</div>
<div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;                   <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,i,j  ,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>) - 0.5*<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(dq2,i,j  ,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>)</div>
<div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;                   ) ;</div>
<div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;</div>
<div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;        <span class="comment">// B1 for all centers around CORN3</span></div>
<div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;        <span class="comment">// B1[i - mp][j - mp]</span></div>
<div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;        B1mm = <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>) ;</div>
<div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;        B1mp = <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),j  ,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>) ;</div>
<div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;        B1pm = <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,i  ,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>) ;</div>
<div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;        B1pp = <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,i  ,j  ,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>) ;</div>
<div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;</div>
<div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;        <span class="comment">// B2 for all centers around CORN3</span></div>
<div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;        <span class="comment">// B2[i - mp][j - mp]</span></div>
<div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;        B2mm = <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>) ;</div>
<div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;        B2mp = <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),j  ,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>) ;</div>
<div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;        B2pm = <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,i  ,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>) ;</div>
<div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;        B2pp = <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,i  ,j  ,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>) ;</div>
<div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;</div>
<div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;        <span class="comment">// compute characteristic velocity -- only for Athena2 method</span></div>
<div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;</div>
<div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;</div>
<div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;        <span class="comment">// average pb to CORN3 for average phase speed there</span></div>
<div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) pbavg[pl]=0.25*(<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,i,j,k,pl)+<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,i,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),k,pl)+<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),j,k,pl)+<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),k,pl));</div>
<div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;        <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a3059ed7bfcfb692cbe8014d55fd7c1e4">get_geometry</a>(i, j, k, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a1a05e117efd4dbc39b7c590141004470">CORN3</a>, ptrgeomco3); <span class="comment">// used here and below emf&#39;s</span></div>
<div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;        <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(get_state(pbavg, ptrgeomco3, &amp;state),&quot;<a class="code" href="../../d9/de0/step__ch_8c.html#afe241569412f22a86dea9cd91b516af8" title="take step itself">step_ch</a>.c:flux_ct()&quot;, &quot;get_state()&quot;, 1);</div>
<div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;        dir=1; <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(<a class="code" href="../../d8/d20/vchar_8c.html#acdcca98ca82b041999cdb29fdf958a22" title="Charles believed that near polar axis one should set vmax=vmin=0, but not right since makes flux comp...">vchar</a>(pbavg, &amp;state, dir, ptrgeomco3, &amp;cmax1, &amp;cmin1,&amp;ignorecourant),&quot;<a class="code" href="../../d9/de0/step__ch_8c.html#afe241569412f22a86dea9cd91b516af8" title="take step itself">step_ch</a>.c:flux_ct()&quot;, &quot;<a class="code" href="../../d8/d20/vchar_8c.html#acdcca98ca82b041999cdb29fdf958a22" title="Charles believed that near polar axis one should set vmax=vmin=0, but not right since makes flux comp...">vchar</a>() dir=1&quot;, 1);</div>
<div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;        dir=2; <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(<a class="code" href="../../d8/d20/vchar_8c.html#acdcca98ca82b041999cdb29fdf958a22" title="Charles believed that near polar axis one should set vmax=vmin=0, but not right since makes flux comp...">vchar</a>(pbavg, &amp;state, dir, ptrgeomco3, &amp;cmax2, &amp;cmin2,&amp;ignorecourant),&quot;<a class="code" href="../../d9/de0/step__ch_8c.html#afe241569412f22a86dea9cd91b516af8" title="take step itself">step_ch</a>.c:flux_ct()&quot;, &quot;<a class="code" href="../../d8/d20/vchar_8c.html#acdcca98ca82b041999cdb29fdf958a22" title="Charles believed that near polar axis one should set vmax=vmin=0, but not right since makes flux comp...">vchar</a>() dir=2&quot;, 2);</div>
<div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;        ctop1 = <a class="code" href="../../dc/dc2/f2c_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a>(fabs(cmax1), fabs(cmin1));</div>
<div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;        ctop2 = <a class="code" href="../../dc/dc2/f2c_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a>(fabs(cmax2), fabs(cmin2));</div>
<div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;        <span class="comment">//      alpha=0.5*(ctop1+ctop2); // use average?</span></div>
<div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;        <span class="comment">//      alpha=max(ctop1,ctop2); // use maximum?</span></div>
<div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;        <span class="comment">// seems alpha can be arbitrary since 0 is ATHENA1</span></div>
<div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;</div>
<div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;        <span class="comment">//      alpha = dx1/dt ; /* crude approx */</span></div>
<div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;</div>
<div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;</div>
<div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;        <span class="comment">// GODMARK: seems to have left/right and up/down asymmetry due to subtraction</span></div>
<div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;        <span class="comment">// if fabs were around each sutracted term, then would be ok (e.g. fabs(B1d-B1u))</span></div>
<div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;</div>
<div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;        <span class="comment">// notice that ctop1 and ctop2 have different &quot;units&quot;, so cannot use with B2/B3 arbitrarily, must be consistent.</span></div>
<div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;        diffusiveterm[3] =  0.125*(</div>
<div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;                                   +ctop1*(</div>
<div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;                                           + B1d - B1mm - B1u + B1mp</div>
<div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;                                           + B1d - B1pm - B1u + B1pp</div>
<div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;                                           )</div>
<div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;                                   +ctop2*(</div>
<div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;                                           + B2r - B2pm - B2l + B2mm</div>
<div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;                                           + B2r - B2pp - B2l + B2mp</div>
<div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;                                           )</div>
<div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;                                   ) ;</div>
<div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;</div>
<div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;</div>
<div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;</div>
<div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;        <span class="comment">// add geometry</span></div>
<div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160;        <span class="comment">// must add geometry (no choice since above diffusive correction never had geometry)</span></div>
<div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;        <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a9740cb914b7803b1ba73f76a9a37ddc2">get_geometry_gdetmix</a>(i,j,k,CORN1,ptrgeomf1);</div>
<div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160;        <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a9740cb914b7803b1ba73f76a9a37ddc2">get_geometry_gdetmix</a>(i,j,k,CORN2,ptrgeomf2);</div>
<div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160;        <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a9740cb914b7803b1ba73f76a9a37ddc2">get_geometry_gdetmix</a>(i,j,k,CORN3,ptrgeomf3);</div>
<div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;      </div>
<div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160;        <span class="comment">// obviously ptrgeom-&gt;EOMFUNCMAC(B2) has to be equal to ptrgeom-&gt;EOMFUNCMAC(B3) for this method</span></div>
<div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;        diffusiveterm[1] *=(ptrgeomf1-&gt;EOMFUNCMAC(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>));</div>
<div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160;        <span class="comment">// obviously ptrgeom-&gt;EOMFUNCMAC(B1) has to be equal to ptrgeom-&gt;EOMFUNCMAC(B2) for this method</span></div>
<div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;        diffusiveterm[2] *=(ptrgeomf2-&gt;EOMFUNCMAC(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>));</div>
<div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;        <span class="comment">// obviously ptrgeom-&gt;EOMFUNCMAC(B1) has to be equal to ptrgeom-&gt;EOMFUNCMAC(B2) for this method</span></div>
<div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;        diffusiveterm[3] *=(ptrgeomf3-&gt;EOMFUNCMAC(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>));</div>
<div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;</div>
<div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;        <span class="comment">// now add diffusive term to emf</span></div>
<div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;<span class="comment"></span>        <span class="keywordflow">for</span>(l=1;l&lt;=3;l++){</div>
<div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;          <a class="code" href="../../df/d1c/global_8storage_8h.html#a4589594cbb3d23d258245b68273e6df6">MACP1A0</a>(emf,l,i,j,k)+= - diffusiveterm[l];</div>
<div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;        }</div>
<div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160;</div>
<div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;</div>
<div class="line"><a name="l01133"></a><span class="lineno"> 1133</span>&#160;      }<span class="comment">// end EMF loop</span></div>
<div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;    }<span class="comment">// end parallel region</span></div>
<div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160;</div>
<div class="line"><a name="l01136"></a><span class="lineno"> 1136</span>&#160;  }<span class="comment">// end if athena2</span></div>
<div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;</div>
<div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160;</div>
<div class="line"><a name="l01139"></a><span class="lineno"> 1139</span>&#160;</div>
<div class="line"><a name="l01140"></a><span class="lineno"> 1140</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160;}</div>
<div class="line"><a name="l01142"></a><span class="lineno"> 1142</span>&#160;</div>
<div class="line"><a name="l01143"></a><span class="lineno"> 1143</span>&#160;</div>
<div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160;</div>
<div class="line"><a name="l01145"></a><span class="lineno"> 1145</span>&#160;</div>
<div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160;</div>
<div class="line"><a name="l01147"></a><span class="lineno"> 1147</span>&#160;</div>
<div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160;</div>
<div class="line"><a name="l01149"></a><span class="lineno"> 1149</span>&#160;</div>
<div class="line"><a name="l01150"></a><span class="lineno"> 1150</span>&#160;</div>
<div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160;</div>
<div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160;</div>
<div class="line"><a name="l01153"></a><span class="lineno"> 1153</span>&#160;</div>
<div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;</div>
<div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160;</div>
<div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160;</div>
<div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160;</div>
<div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160;</div>
<div class="line"><a name="l01161"></a><span class="lineno"> 1161</span>&#160;<span class="keywordtype">int</span> flux_ct_emf2flux(<span class="keywordtype">int</span> stage, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pb)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*emf)[<a class="code" href="../../df/d1c/global_8storage_8h.html#a917a6677d5e3b38aa54aa577978bf823" title="123">NSTORE1</a>+<a class="code" href="../../df/d1c/global_8storage_8h.html#a1c452bce7a227fd9f2c8f937a3c7841c">SHIFTSTORE1</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>+<a class="code" href="../../df/d1c/global_8storage_8h.html#adfe8c351b7f60e189dbd9bfca47af5c5">SHIFTSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>+<a class="code" href="../../df/d1c/global_8storage_8h.html#a6dc540b0373d80d3ea2db53d03a9fa72">SHIFTSTORE3</a>], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*vconemf)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>-1], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*dq1)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*dq2)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*dq3)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*F1)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*F2)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*F3)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>])</div>
<div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160;{</div>
<div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;  <span class="comment">// full-type geometry below</span></div>
<div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> coefemf[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l01165"></a><span class="lineno"> 1165</span>&#160;  <span class="keyword">extern</span> <span class="keywordtype">int</span> choose_limiter(<span class="keywordtype">int</span> dir, <span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k, <span class="keywordtype">int</span> pl);</div>
<div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160;</div>
<div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;</div>
<div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160;</div>
<div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160;</div>
<div class="line"><a name="l01170"></a><span class="lineno"> 1170</span>&#160;</div>
<div class="line"><a name="l01173"></a><span class="lineno"> 1173</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01174"></a><span class="lineno"> 1174</span>&#160;  <span class="comment">// compute flux from EMF (signs must be consistent so that similar signed quantity in end)</span></div>
<div class="line"><a name="l01175"></a><span class="lineno"> 1175</span>&#160;  <span class="comment">// e.g. flux terms originally involving B^2 v^1 - B^1 v^2 must come out with same sign at end</span></div>
<div class="line"><a name="l01176"></a><span class="lineno"> 1176</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01177"></a><span class="lineno"> 1177</span>&#160;  <span class="comment">// This calculation takes care of case when EMF is not needed, so above need not worry about resetting values of emf to 0 or something</span></div>
<div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160;  <span class="comment">// we set flux to 0 when that dimension doesn&#39;t matter, but note that flux really is not 0.  Rather the differences in the flux are 0 across that direction.  However, this difference never enters since this flux is only used as flux differences.</span></div>
<div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160;  <span class="comment">// These flux differences are *assumed* to vanish if that dimension has N=1.  However, a problem could be setup such that those differences would NOT be 0.</span></div>
<div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160;  <span class="comment">// For example, a wedge out of an axisymmetric slice that has boundaries that are not symmetric around the equator.  This would have flux differences that would lead to changes in the quantity.  This would be a quasi-2D problem modelled in 1D.</span></div>
<div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160;  <span class="comment">// Presume emf[N+SHIFT] so can combine loops, which just ignores values at emf[N+SHIFT-1].  Increases cache miss for F1,F2,F3, but less for emf(1,2,3) and less loop overhead, especially for OpenMP</span></div>
<div class="line"><a name="l01187"></a><span class="lineno"> 1187</span>&#160;</div>
<div class="line"><a name="l01188"></a><span class="lineno"> 1188</span>&#160;  <span class="keywordflow">if</span>((<a class="code" href="../../d8/d5b/defs_8general_8h.html#a11c4e99e1493d0c1914ad1ab313ea472">FLUXB</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a5014e44c6e710d8827ef79dd18abe6ad">FLUXCTTOTH</a>)||(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a11c4e99e1493d0c1914ad1ab313ea472">FLUXB</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a203809114fcd4d7fc35a2a22538dd6c1">ATHENA2</a>)||(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a11c4e99e1493d0c1914ad1ab313ea472">FLUXB</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a5c288047377b976b5c630d0eb8856257">ATHENA1</a>)){</div>
<div class="line"><a name="l01189"></a><span class="lineno"> 1189</span>&#160;    <span class="comment">/* rewrite EMFs as fluxes, after Toth */</span></div>
<div class="line"><a name="l01190"></a><span class="lineno"> 1190</span>&#160;</div>
<div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;</div>
<div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160;<span class="preprocessor">#pragma omp parallel  // no copyin() needed since not calling any functions that use global vars</span></div>
<div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;<span class="preprocessor"></span>    {</div>
<div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160;      <span class="keywordtype">int</span> <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>,<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>,k;</div>
<div class="line"><a name="l01195"></a><span class="lineno"> 1195</span>&#160;      <a class="code" href="../../d5/d7b/global_8openmploops_8h.html#a1389db2daf5bd9e94918090c253a16c9">OPENMP3DLOOPVARSDEFINE</a>;</div>
<div class="line"><a name="l01196"></a><span class="lineno"> 1196</span>&#160;</div>
<div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160;      <span class="comment">//      OPENMP3DLOOPSETUP(INFULL1,OUTFULLM11,-N2BND,N2-1+N2BND,INFULL3,OUTFULLM13);</span></div>
<div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160;      <span class="comment">//    COMPF2CTZLOOP {</span></div>
<div class="line"><a name="l01203"></a><span class="lineno"> 1203</span>&#160;<span class="comment"></span>      <span class="comment">//OPENMP3DLOOPSETUP(INFULL1,OUTFULLM11,INFULL2,OUTFULLM12,-N3BND,N3-1+N3BND);</span></div>
<div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;      <span class="comment">//    COMPF3CTZLOOP {</span></div>
<div class="line"><a name="l01205"></a><span class="lineno"> 1205</span>&#160;</div>
<div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;      </div>
<div class="line"><a name="l01207"></a><span class="lineno"> 1207</span>&#160;      <a class="code" href="../../d5/d7b/global_8openmploops_8h.html#a7518365209531b952c067f47c80777c2" title="COMPFULLLOOP equivalent for OpenMP.">OPENMP3DLOOPSETUPFULL</a>;</div>
<div class="line"><a name="l01208"></a><span class="lineno"> 1208</span>&#160;<span class="preprocessor">#pragma omp for schedule(OPENMPFULLNOVARYSCHEDULE()) // not needed with just 1 loop: nowait // Can &quot;nowait&quot; since each F1,F2,F3 set independently on successive loops</span></div>
<div class="line"><a name="l01209"></a><span class="lineno"> 1209</span>&#160;<span class="preprocessor"></span>      <a class="code" href="../../d5/d7b/global_8openmploops_8h.html#a9e48537d3cb58cc3a3765b8a18b43b15" title="Oddly, performance changes by 10% when changing how start and stop blockijk (and fixing how used too ...">OPENMP3DLOOPBLOCK</a>{</div>
<div class="line"><a name="l01210"></a><span class="lineno"> 1210</span>&#160;        <a class="code" href="../../df/d1c/global_8storage_8h.html#a96983b0c56e836f50cb7c1af16f59fb6">OPENMP3DLOOPBLOCK2IJK</a>(i,j,k);</div>
<div class="line"><a name="l01211"></a><span class="lineno"> 1211</span>&#160;</div>
<div class="line"><a name="l01213"></a><span class="lineno"> 1213</span>&#160;        <span class="comment">// F1</span></div>
<div class="line"><a name="l01215"></a><span class="lineno"> 1215</span>&#160;<span class="comment"></span><span class="preprocessor">#if(N1&gt;1)</span></div>
<div class="line"><a name="l01216"></a><span class="lineno"> 1216</span>&#160;<span class="preprocessor"></span>        <span class="comment">// below line always true</span></div>
<div class="line"><a name="l01217"></a><span class="lineno"> 1217</span>&#160;        <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F1,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>) = 0.;</div>
<div class="line"><a name="l01218"></a><span class="lineno"> 1218</span>&#160;        <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F1,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>) = 0.5 * (<a class="code" href="../../df/d1c/global_8storage_8h.html#a4589594cbb3d23d258245b68273e6df6">MACP1A0</a>(emf,3,i,j,k) + <a class="code" href="../../df/d1c/global_8storage_8h.html#a4589594cbb3d23d258245b68273e6df6">MACP1A0</a>(emf,3,i,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a3e64aa2cd3c5e0933e74fa4e7a925570">jp1mac</a>(j),k)); <span class="comment">// put emf3 back to FACE1</span></div>
<div class="line"><a name="l01219"></a><span class="lineno"> 1219</span>&#160;        <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F1,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>) = - 0.5 * (<a class="code" href="../../df/d1c/global_8storage_8h.html#a4589594cbb3d23d258245b68273e6df6">MACP1A0</a>(emf,2,i,j,k) + <a class="code" href="../../df/d1c/global_8storage_8h.html#a4589594cbb3d23d258245b68273e6df6">MACP1A0</a>(emf,2,i,j,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#aafe7c78a2d0713ddc9a4f1c61764e3b9">kp1mac</a>(k))); <span class="comment">// put emf2 back to FACE1</span></div>
<div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01221"></a><span class="lineno"> 1221</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01222"></a><span class="lineno"> 1222</span>&#160;</div>
<div class="line"><a name="l01223"></a><span class="lineno"> 1223</span>&#160;</div>
<div class="line"><a name="l01225"></a><span class="lineno"> 1225</span>&#160;        <span class="comment">// F2</span></div>
<div class="line"><a name="l01227"></a><span class="lineno"> 1227</span>&#160;<span class="comment"></span><span class="preprocessor">#if(N2&gt;1)</span></div>
<div class="line"><a name="l01228"></a><span class="lineno"> 1228</span>&#160;<span class="preprocessor"></span>        <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F2,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>) = - 0.5 * (<a class="code" href="../../df/d1c/global_8storage_8h.html#a4589594cbb3d23d258245b68273e6df6">MACP1A0</a>(emf,3,i,j,k) + <a class="code" href="../../df/d1c/global_8storage_8h.html#a4589594cbb3d23d258245b68273e6df6">MACP1A0</a>(emf,3,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a27e1e0a92af691ffd03d7e9d0a628392">ip1mac</a>(i),j,k));</div>
<div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160;        <span class="comment">// below line always true</span></div>
<div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160;        <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F2,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>) = 0.;</div>
<div class="line"><a name="l01231"></a><span class="lineno"> 1231</span>&#160;        <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F2,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>) = 0.5 * (<a class="code" href="../../df/d1c/global_8storage_8h.html#a4589594cbb3d23d258245b68273e6df6">MACP1A0</a>(emf,1,i,j,k) + <a class="code" href="../../df/d1c/global_8storage_8h.html#a4589594cbb3d23d258245b68273e6df6">MACP1A0</a>(emf,1,i,j,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#aafe7c78a2d0713ddc9a4f1c61764e3b9">kp1mac</a>(k)));</div>
<div class="line"><a name="l01232"></a><span class="lineno"> 1232</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01233"></a><span class="lineno"> 1233</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01235"></a><span class="lineno"> 1235</span>&#160;        <span class="comment">// F3</span></div>
<div class="line"><a name="l01237"></a><span class="lineno"> 1237</span>&#160;<span class="comment"></span><span class="preprocessor">#if(N3&gt;1)</span></div>
<div class="line"><a name="l01238"></a><span class="lineno"> 1238</span>&#160;<span class="preprocessor"></span>        <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F3,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>) = 0.5 * (<a class="code" href="../../df/d1c/global_8storage_8h.html#a4589594cbb3d23d258245b68273e6df6">MACP1A0</a>(emf,2,i,j,k) + <a class="code" href="../../df/d1c/global_8storage_8h.html#a4589594cbb3d23d258245b68273e6df6">MACP1A0</a>(emf,2,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a27e1e0a92af691ffd03d7e9d0a628392">ip1mac</a>(i),j,k));</div>
<div class="line"><a name="l01239"></a><span class="lineno"> 1239</span>&#160;        <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F3,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>) = - 0.5 * (<a class="code" href="../../df/d1c/global_8storage_8h.html#a4589594cbb3d23d258245b68273e6df6">MACP1A0</a>(emf,1,i,j,k) + <a class="code" href="../../df/d1c/global_8storage_8h.html#a4589594cbb3d23d258245b68273e6df6">MACP1A0</a>(emf,1,i,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a3e64aa2cd3c5e0933e74fa4e7a925570">jp1mac</a>(j),k));</div>
<div class="line"><a name="l01240"></a><span class="lineno"> 1240</span>&#160;        <span class="comment">// below line always true</span></div>
<div class="line"><a name="l01241"></a><span class="lineno"> 1241</span>&#160;        <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F3,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>) = 0.;</div>
<div class="line"><a name="l01242"></a><span class="lineno"> 1242</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01243"></a><span class="lineno"> 1243</span>&#160;<span class="preprocessor"></span>      }<span class="comment">// end loop block [using outer loop since even though 3X more expensive cache-wise for F1, less so for emf.  Reduces OpenMP overhead alot.</span></div>
<div class="line"><a name="l01244"></a><span class="lineno"> 1244</span>&#160;    }<span class="comment">// end parallel region (and implied barrier)</span></div>
<div class="line"><a name="l01245"></a><span class="lineno"> 1245</span>&#160;</div>
<div class="line"><a name="l01246"></a><span class="lineno"> 1246</span>&#160;</div>
<div class="line"><a name="l01247"></a><span class="lineno"> 1247</span>&#160;</div>
<div class="line"><a name="l01248"></a><span class="lineno"> 1248</span>&#160;</div>
<div class="line"><a name="l01249"></a><span class="lineno"> 1249</span>&#160;</div>
<div class="line"><a name="l01250"></a><span class="lineno"> 1250</span>&#160;  } <span class="comment">// end if FLUXCT</span></div>
<div class="line"><a name="l01251"></a><span class="lineno"> 1251</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a11c4e99e1493d0c1914ad1ab313ea472">FLUXB</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6cf8dd4f55e698316ccf74b8e57e317a">FLUXCD</a>){</div>
<div class="line"><a name="l01252"></a><span class="lineno"> 1252</span>&#160;</div>
<div class="line"><a name="l01253"></a><span class="lineno"> 1253</span>&#160;</div>
<div class="line"><a name="l01254"></a><span class="lineno"> 1254</span>&#160;</div>
<div class="line"><a name="l01255"></a><span class="lineno"> 1255</span>&#160;</div>
<div class="line"><a name="l01256"></a><span class="lineno"> 1256</span>&#160;</div>
<div class="line"><a name="l01257"></a><span class="lineno"> 1257</span>&#160;    <span class="comment">// F&#39;s are emf&#39;s, where dF/dx is (F(i+1)-F(i-1))/dx</span></div>
<div class="line"><a name="l01258"></a><span class="lineno"> 1258</span>&#160;    <span class="comment">// fluxes remain at center!</span></div>
<div class="line"><a name="l01259"></a><span class="lineno"> 1259</span>&#160;</div>
<div class="line"><a name="l01260"></a><span class="lineno"> 1260</span>&#160;<span class="preprocessor">#pragma omp parallel  // no copyin() required</span></div>
<div class="line"><a name="l01261"></a><span class="lineno"> 1261</span>&#160;<span class="preprocessor"></span>    {</div>
<div class="line"><a name="l01262"></a><span class="lineno"> 1262</span>&#160;      <span class="keywordtype">int</span> <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>,<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>,k;</div>
<div class="line"><a name="l01263"></a><span class="lineno"> 1263</span>&#160;      <a class="code" href="../../d5/d7b/global_8openmploops_8h.html#a1389db2daf5bd9e94918090c253a16c9">OPENMP3DLOOPVARSDEFINE</a>; </div>
<div class="line"><a name="l01264"></a><span class="lineno"> 1264</span>&#160;</div>
<div class="line"><a name="l01265"></a><span class="lineno"> 1265</span>&#160;</div>
<div class="line"><a name="l01266"></a><span class="lineno"> 1266</span>&#160;</div>
<div class="line"><a name="l01267"></a><span class="lineno"> 1267</span>&#160;      <span class="comment">//    COMPF1CTZLOOP {</span></div>
<div class="line"><a name="l01269"></a><span class="lineno"> 1269</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01270"></a><span class="lineno"> 1270</span>&#160;</div>
<div class="line"><a name="l01271"></a><span class="lineno"> 1271</span>&#160;      <a class="code" href="../../d5/d7b/global_8openmploops_8h.html#a7518365209531b952c067f47c80777c2" title="COMPFULLLOOP equivalent for OpenMP.">OPENMP3DLOOPSETUPFULL</a>;</div>
<div class="line"><a name="l01272"></a><span class="lineno"> 1272</span>&#160;<span class="preprocessor">#pragma omp for schedule(OPENMPFULLNOVARYSCHEDULE()) // nowait // Can &quot;nowait&quot; since each successive loop sets F1,F2,F3 independently</span></div>
<div class="line"><a name="l01273"></a><span class="lineno"> 1273</span>&#160;<span class="preprocessor"></span>      <a class="code" href="../../d5/d7b/global_8openmploops_8h.html#a9e48537d3cb58cc3a3765b8a18b43b15" title="Oddly, performance changes by 10% when changing how start and stop blockijk (and fixing how used too ...">OPENMP3DLOOPBLOCK</a>{</div>
<div class="line"><a name="l01274"></a><span class="lineno"> 1274</span>&#160;        <a class="code" href="../../df/d1c/global_8storage_8h.html#a96983b0c56e836f50cb7c1af16f59fb6">OPENMP3DLOOPBLOCK2IJK</a>(i,j,k);</div>
<div class="line"><a name="l01275"></a><span class="lineno"> 1275</span>&#160;</div>
<div class="line"><a name="l01277"></a><span class="lineno"> 1277</span>&#160;        <span class="comment">// F1</span></div>
<div class="line"><a name="l01279"></a><span class="lineno"> 1279</span>&#160;<span class="comment"></span><span class="preprocessor">#if(N1&gt;1)</span></div>
<div class="line"><a name="l01280"></a><span class="lineno"> 1280</span>&#160;<span class="preprocessor"></span>        <span class="comment">// always below line</span></div>
<div class="line"><a name="l01281"></a><span class="lineno"> 1281</span>&#160;        <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F1,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>) = 0.0;</div>
<div class="line"><a name="l01282"></a><span class="lineno"> 1282</span>&#160;        <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F1,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>) = <a class="code" href="../../df/d1c/global_8storage_8h.html#a4589594cbb3d23d258245b68273e6df6">MACP1A0</a>(emf,3,i,j,k);</div>
<div class="line"><a name="l01283"></a><span class="lineno"> 1283</span>&#160;        <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F1,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>) = -<a class="code" href="../../df/d1c/global_8storage_8h.html#a4589594cbb3d23d258245b68273e6df6">MACP1A0</a>(emf,2,i,j,k);</div>
<div class="line"><a name="l01284"></a><span class="lineno"> 1284</span>&#160;<span class="preprocessor">#endif // end if doing F1</span></div>
<div class="line"><a name="l01285"></a><span class="lineno"> 1285</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01286"></a><span class="lineno"> 1286</span>&#160;</div>
<div class="line"><a name="l01287"></a><span class="lineno"> 1287</span>&#160;</div>
<div class="line"><a name="l01289"></a><span class="lineno"> 1289</span>&#160;        <span class="comment">// F2</span></div>
<div class="line"><a name="l01291"></a><span class="lineno"> 1291</span>&#160;<span class="comment"></span><span class="preprocessor">#if(N2&gt;1)</span></div>
<div class="line"><a name="l01292"></a><span class="lineno"> 1292</span>&#160;<span class="preprocessor"></span>        <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F2,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>) = -<a class="code" href="../../df/d1c/global_8storage_8h.html#a4589594cbb3d23d258245b68273e6df6">MACP1A0</a>(emf,3,i,j,k);</div>
<div class="line"><a name="l01293"></a><span class="lineno"> 1293</span>&#160;        <span class="comment">// always below line</span></div>
<div class="line"><a name="l01294"></a><span class="lineno"> 1294</span>&#160;        <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F2,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>) = 0.;</div>
<div class="line"><a name="l01295"></a><span class="lineno"> 1295</span>&#160;        <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F2,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>) = <a class="code" href="../../df/d1c/global_8storage_8h.html#a4589594cbb3d23d258245b68273e6df6">MACP1A0</a>(emf,1,i,j,k);</div>
<div class="line"><a name="l01296"></a><span class="lineno"> 1296</span>&#160;<span class="preprocessor">#endif // end if doing F2</span></div>
<div class="line"><a name="l01297"></a><span class="lineno"> 1297</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01298"></a><span class="lineno"> 1298</span>&#160;</div>
<div class="line"><a name="l01299"></a><span class="lineno"> 1299</span>&#160;</div>
<div class="line"><a name="l01301"></a><span class="lineno"> 1301</span>&#160;        <span class="comment">// F3</span></div>
<div class="line"><a name="l01303"></a><span class="lineno"> 1303</span>&#160;<span class="comment"></span><span class="preprocessor">#if(N3&gt;1)</span></div>
<div class="line"><a name="l01304"></a><span class="lineno"> 1304</span>&#160;<span class="preprocessor"></span>        <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F3,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>) = <a class="code" href="../../df/d1c/global_8storage_8h.html#a4589594cbb3d23d258245b68273e6df6">MACP1A0</a>(emf,2,i,j,k);</div>
<div class="line"><a name="l01305"></a><span class="lineno"> 1305</span>&#160;        <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F3,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>) = -<a class="code" href="../../df/d1c/global_8storage_8h.html#a4589594cbb3d23d258245b68273e6df6">MACP1A0</a>(emf,1,i,j,k);</div>
<div class="line"><a name="l01306"></a><span class="lineno"> 1306</span>&#160;        <span class="comment">// always below line</span></div>
<div class="line"><a name="l01307"></a><span class="lineno"> 1307</span>&#160;        <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F3,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>) = 0.;</div>
<div class="line"><a name="l01308"></a><span class="lineno"> 1308</span>&#160;<span class="preprocessor">#endif // end if doing F3</span></div>
<div class="line"><a name="l01309"></a><span class="lineno"> 1309</span>&#160;<span class="preprocessor"></span>      }<span class="comment">// end loop block [using outer loop since even though 3X more expensive cache-wise for F1, less so for emf.  Reduces OpenMP overhead alot.</span></div>
<div class="line"><a name="l01310"></a><span class="lineno"> 1310</span>&#160;    }<span class="comment">// end parallel region (and implied barrier)</span></div>
<div class="line"><a name="l01311"></a><span class="lineno"> 1311</span>&#160;</div>
<div class="line"><a name="l01312"></a><span class="lineno"> 1312</span>&#160;</div>
<div class="line"><a name="l01313"></a><span class="lineno"> 1313</span>&#160;</div>
<div class="line"><a name="l01314"></a><span class="lineno"> 1314</span>&#160;  } <span class="comment">// end if FLUXCD</span></div>
<div class="line"><a name="l01315"></a><span class="lineno"> 1315</span>&#160;</div>
<div class="line"><a name="l01316"></a><span class="lineno"> 1316</span>&#160;</div>
<div class="line"><a name="l01317"></a><span class="lineno"> 1317</span>&#160;</div>
<div class="line"><a name="l01318"></a><span class="lineno"> 1318</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l01319"></a><span class="lineno"> 1319</span>&#160;}</div>
</div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Fri May 20 2016 15:52:33 for HARM by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.8.3.1
</small></address>
</body>
</html>
