<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.3.1"/>
<title>HARM: fixup.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">HARM
   </div>
   <div id="projectbrief">harm and utilities</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.3.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="../../search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">fixup.c</div>  </div>
</div><!--header-->
<div class="contents">
<a href="../../de/d95/fixup_8c.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;</div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="preprocessor">#include &quot;decs.h&quot;</span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;</div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;</div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../de/d95/fixup_8c.html#a2f58e3b2c769ab1ac0fd7670a9014695" title="simple average of good surrounding zones">simple_average</a>(<span class="keywordtype">int</span> startpl, <span class="keywordtype">int</span> endpl, <span class="keywordtype">int</span> <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>, <span class="keywordtype">int</span> <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>, <span class="keywordtype">int</span> k, <span class="keywordtype">int</span> doingmhd, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> (*lpflagfailorig)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ad7f624f14282b4bf2160fec8261c1c57">NUMFAILPFLAGS</a>],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pv)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*ptoavg)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR]);</div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> general_average(<span class="keywordtype">int</span> useonlynonfailed, <span class="keywordtype">int</span> numbndtotry, <span class="keywordtype">int</span> maxnumbndtotry, <span class="keywordtype">int</span> startpl, <span class="keywordtype">int</span> endpl, <span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k, <span class="keywordtype">int</span> doingmhd, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> mhdlpflag, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> radlpflag, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> (*lpflagfailorig)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NUMFAILPFLAGS],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pv)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*ptoavg)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR], <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom);</div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> fixup_nogood(<span class="keywordtype">int</span> startpl, <span class="keywordtype">int</span> endpl, <span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k, <span class="keywordtype">int</span> doingmhd, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> mhdlpflag, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> radlpflag, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pv)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*ptoavg)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pbackup)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR], <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom);</div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> fixuputoprim_accounting(<span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> mhdlpflag, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> radlpflag, <span class="keywordtype">int</span> limitgammamhd, <span class="keywordtype">int</span> limitgammarad, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> (*lpflag)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2769e7932b44819ba2a159091c5def43" title="flag failures/problems for correction/check in fixup">NUMPFLAGS</a>],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pv)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*ptoavg)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR], <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *geom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr0, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*ucons)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR], <span class="keywordtype">int</span> finalstep);</div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> fixup_negdensities(<span class="keywordtype">int</span> whichtofix, <span class="keywordtype">int</span> *fixed, <span class="keywordtype">int</span> startpl, <span class="keywordtype">int</span> endpl, <span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> mhdlpflag, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pv)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*ptoavg)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR], <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *geom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr0, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*ucons)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR], <span class="keywordtype">int</span> finalstep);</div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;</div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> superdebug_utoprim(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr0, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *<a class="code" href="../../dc/dd2/newcodediff_8txt.html#ae7ab77d7e616dc02fba121a009b48c27">pr</a>, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <span class="keywordtype">int</span> whocalled);</div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;</div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;</div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;</div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="comment">// whether to add radiation YFL4,YFL5 to gas YFL2,YFL3</span></div>
<div class="line"><a name="l00024"></a><span class="lineno"><a class="code" href="../../de/d95/fixup_8c.html#ad7222bf183c76ad39adea3084ff61ba4">   24</a></span>&#160;<span class="preprocessor">#define YFLADDRADTOGAS 0</span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;</div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;</div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="keywordtype">int</span> pre_fixup(<span class="keywordtype">int</span> stage,<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pv)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR])</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;{</div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;</div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;  <span class="comment">// grab b^2 flags (above fixup may change u or rho, so must do this after)</span></div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;  get_bsqflags(stage,pv);</div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;</div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;</div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;}</div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;</div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;</div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="keywordtype">int</span> post_fixup(<span class="keywordtype">int</span> stageit,<span class="keywordtype">int</span> finalstep, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a0263684ebff8e72a2f0de1861393595f">SFTYPE</a> boundtime, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pv)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pbackup)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*ucons)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR])</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;{</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;  <span class="keywordtype">int</span> stage,stagei,stagef;</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;  <span class="keywordtype">int</span> boundstage;</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;<span class="preprocessor">#if(UTOPRIMADJUST!=0)</span></div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;  <span class="comment">// utoprim fixup of primitive solution</span></div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;</div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../dc/dd8/mympi_8definit_8h.html#a03f1dae933f1317ed8f046b200e4963e">SIMULBCCALC</a>&lt;=0){ stagei=<a class="code" href="../../d5/d14/mympi_8global_8nondepmnemonics_8h.html#affb13608b845e81f4595b80927fbedbd" title="for various uses (dumping and special boundary/comp interchange routine">STAGEM1</a>; stagef=<a class="code" href="../../d5/d14/mympi_8global_8nondepmnemonics_8h.html#affb13608b845e81f4595b80927fbedbd" title="for various uses (dumping and special boundary/comp interchange routine">STAGEM1</a>; }</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../dc/dd8/mympi_8definit_8h.html#a03f1dae933f1317ed8f046b200e4963e">SIMULBCCALC</a>==1) { stagei=<a class="code" href="../../d5/d14/mympi_8global_8nondepmnemonics_8h.html#a55cd17c293a7db0ea2fce2d2be563ad8">STAGE0</a>; stagef=<a class="code" href="../../d5/d14/mympi_8global_8nondepmnemonics_8h.html#a5b294b2a38519989044561129393a5c3">STAGE2</a>;}</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../dc/dd8/mympi_8definit_8h.html#a03f1dae933f1317ed8f046b200e4963e">SIMULBCCALC</a>==2) { stagei=<a class="code" href="../../d5/d14/mympi_8global_8nondepmnemonics_8h.html#a55cd17c293a7db0ea2fce2d2be563ad8">STAGE0</a>; stagef=<a class="code" href="../../d5/d14/mympi_8global_8nondepmnemonics_8h.html#ac9e39afa6c08127945b21e93f02a63b0">STAGE5</a>;}</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../dc/dd8/mympi_8definit_8h.html#a03f1dae933f1317ed8f046b200e4963e">SIMULBCCALC</a>&gt;=1) boundstage=<a class="code" href="../../d5/d14/mympi_8global_8nondepmnemonics_8h.html#a55cd17c293a7db0ea2fce2d2be563ad8">STAGE0</a>;</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;  <span class="keywordflow">else</span> boundstage=<a class="code" href="../../d5/d14/mympi_8global_8nondepmnemonics_8h.html#affb13608b845e81f4595b80927fbedbd" title="for various uses (dumping and special boundary/comp interchange routine">STAGEM1</a>;</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;  <span class="keywordflow">for</span>(stage=stagei;stage&lt;=stagef;stage++){</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;    <span class="comment">// first bound failure flag</span></div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;    <span class="comment">// OPTMARK: could optimize bound of pflag since often failures don&#39;t occur (just ask if any failures first), although probably negligible performance hit</span></div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;    <span class="keywordflow">if</span>(stage&lt;<a class="code" href="../../d5/d14/mympi_8global_8nondepmnemonics_8h.html#a5b294b2a38519989044561129393a5c3">STAGE2</a>){</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;      bound_pflag(boundstage, finalstep, boundtime, <a class="code" href="../../df/d1c/global_8storage_8h.html#ad89dafa5d772b862a44b0f576983ead3" title="shifted pointer (a_s_) wrappers Couldn&#39;t figure out how to macrofy a_s_ or a_, so when changing have ...">GLOBALPOINT</a>(pflag), USEMPI);</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;      <span class="keywordflow">if</span>(stage!=<a class="code" href="../../d5/d14/mympi_8global_8nondepmnemonics_8h.html#affb13608b845e81f4595b80927fbedbd" title="for various uses (dumping and special boundary/comp interchange routine">STAGEM1</a>) boundstage++;</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;    }</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;    <span class="comment">// check for bad solutions and set as failure if good is reasonably bad</span></div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;<span class="preprocessor">#if(CHECKSOLUTION)</span></div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;<span class="preprocessor"></span>    fixup_checksolution(stage,pv,finalstep);</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;    <span class="comment">// check solution changed pflag, so have to bound again</span></div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;    <span class="keywordflow">if</span>(stage&lt;<a class="code" href="../../d5/d14/mympi_8global_8nondepmnemonics_8h.html#a5b294b2a38519989044561129393a5c3">STAGE2</a>){</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;      bound_pflag(boundstage, finalstep, boundtime, pflag, USEMPI);</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;      <span class="keywordflow">if</span>(stage!=<a class="code" href="../../d5/d14/mympi_8global_8nondepmnemonics_8h.html#affb13608b845e81f4595b80927fbedbd" title="for various uses (dumping and special boundary/comp interchange routine">STAGEM1</a>) boundstage++;</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;    }</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;<span class="preprocessor"></span>    </div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;    <span class="comment">//    int long long nstepfake;</span></div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;    <span class="comment">//    nstepfake=nstep;</span></div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;    <span class="comment">//    nstep=0;</span></div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;    <span class="comment">//    image_dump(-4);</span></div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;    <span class="comment">//    nstep=nstepfake;</span></div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;    <span class="comment">// fixup before new solution (has to be here since need previous stage&#39;s failure flag)</span></div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;    fixup_utoprim(stage,pv,pbackup,ucons,finalstep);</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;    <span class="comment">// after fixup_utoprim(), the floors/ceilings won&#39;t be satisfied anymore, especially near sharp jumps in densities, so repeat.</span></div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;    fixup(stage, pv, ucons, finalstep);</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;    </div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;<span class="preprocessor">#if(0)</span></div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;<span class="preprocessor"></span>    <span class="comment">// GODMARK: I don&#39;t see why need to bound pflag since already done with using pflag</span></div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;    <span class="keywordflow">if</span>(stage&lt;<a class="code" href="../../d5/d14/mympi_8global_8nondepmnemonics_8h.html#a5b294b2a38519989044561129393a5c3">STAGE2</a>){</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;      <span class="keywordflow">if</span>(stage!=<a class="code" href="../../d5/d14/mympi_8global_8nondepmnemonics_8h.html#affb13608b845e81f4595b80927fbedbd" title="for various uses (dumping and special boundary/comp interchange routine">STAGEM1</a>){</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;        bound_pflag(boundstage, finalstep, boundtime, pflag, USEMPI);</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;        boundstage++;</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;      }</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;    }</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;  }</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;  <span class="comment">// standard fixup of floor</span></div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;  <span class="comment">// in this case stageit=-1, so does all stages</span></div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;  <span class="comment">//  fixup(stageit,pv,finalstep);</span></div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;</div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;}</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;<span class="keywordtype">int</span> post_fixup_nofixup(<span class="keywordtype">int</span> stageit, <span class="keywordtype">int</span> finalstep, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a0263684ebff8e72a2f0de1861393595f">SFTYPE</a> boundtime, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pv)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pbackup)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*ucons)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR])</div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;{</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;  fixup_utoprim_nofixup(<a class="code" href="../../d5/d14/mympi_8global_8nondepmnemonics_8h.html#affb13608b845e81f4595b80927fbedbd" title="for various uses (dumping and special boundary/comp interchange routine">STAGEM1</a>,pv,pbackup,ucons,finalstep);</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;}</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;<span class="keywordtype">int</span> fixup(<span class="keywordtype">int</span> stage,<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pv)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*ucons)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR], <span class="keywordtype">int</span> finalstep)</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;{</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>, <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>, k;</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> geomdontuse;</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom=&amp;geomdontuse;</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;  <a class="code" href="../../df/da8/global_8comploops_8h.html#afca0c679f7f4d211de239537a2cd685b" title="below are not original multi-D combindations, just renamings that have no control over order of dimen...">COMPZLOOP</a>{</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;    <span class="comment">//    dualfprintf(fail_file,&quot;i=%d j=%d k=%d\n&quot;,i,j,k); fflush(fail_file);</span></div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;    <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a3059ed7bfcfb692cbe8014d55fd7c1e4">get_geometry</a>(i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8936711f57f82d1fc75c21fa2894e1c6">CENT</a>,ptrgeom);</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;    <span class="keywordflow">if</span>(fixup1zone(0,<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(pv,i,j,k),<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(ucons,i,j,k), ptrgeom,finalstep)&gt;=1)</div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;      <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a5febb92786c5f7a1479e7e65f1c23ef3">FAILSTATEMENT</a>(<span class="stringliteral">&quot;fixup.c:fixup()&quot;</span>, <span class="stringliteral">&quot;fixup1zone()&quot;</span>, 1);</div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;  }</div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;}</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;</div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;<span class="keywordtype">int</span> diag_fixup_correctablecheck(<span class="keywordtype">int</span> docorrectucons, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom)</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;{</div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;  <span class="keywordtype">int</span> is_within_correctable_region;</div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;  <span class="keywordtype">int</span> docorrectuconslocal;</div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;  <span class="comment">// determine if within correctable region</span></div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;<span class="comment"></span>  <span class="keywordflow">if</span>( <a class="code" href="../../d8/d5b/defs_8general_8h.html#a55732148d2616d6d1f5d2abbe8710850">DOENOFLUX</a> != <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#adacaaf8526353cfe870206f0cf4d2ca7" title="for DOENOFLUX: 0: no ENO flux reconstruction 1: reconstruct F for finite difference rep...">NOENOFLUX</a> ) {</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;    is_within_correctable_region=((ptrgeom-&gt;i)&gt;=<a class="code" href="../../d8/d5b/defs_8general_8h.html#ab5c60dcb37b1f7e5642525031cd5cbcf">Uconsevolveloop</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aefa679918e336291a5fb0e5cfd0dc269">FIS</a>])&amp;&amp;((ptrgeom-&gt;i)&lt;=<a class="code" href="../../d8/d5b/defs_8general_8h.html#ab5c60dcb37b1f7e5642525031cd5cbcf">Uconsevolveloop</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aa9efa612e7e6b889d1fd42e644bf3cce">FIE</a>])&amp;&amp;((ptrgeom-&gt;j)&gt;=<a class="code" href="../../d8/d5b/defs_8general_8h.html#ab5c60dcb37b1f7e5642525031cd5cbcf">Uconsevolveloop</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a141f293b4491fd91a765cc74553edbea">FJS</a>])&amp;&amp;((ptrgeom-&gt;j)&lt;=<a class="code" href="../../d8/d5b/defs_8general_8h.html#ab5c60dcb37b1f7e5642525031cd5cbcf">Uconsevolveloop</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a82364cc36a73d5f4c269b5ad8b9f0dd4">FJE</a>])&amp;&amp;((ptrgeom-&gt;k)&gt;=<a class="code" href="../../d8/d5b/defs_8general_8h.html#ab5c60dcb37b1f7e5642525031cd5cbcf">Uconsevolveloop</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab2806eafbffb43c634853ab47d7fd7d7">FKS</a>])&amp;&amp;((ptrgeom-&gt;k)&lt;=<a class="code" href="../../d8/d5b/defs_8general_8h.html#ab5c60dcb37b1f7e5642525031cd5cbcf">Uconsevolveloop</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8de59f913fa18843ee34d376002f5bbc">FKE</a>]);</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;  }</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;    is_within_correctable_region=1; <span class="comment">// assume diag_fixup() only called where ok to do change to ucons!</span></div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;  }</div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;  <span class="comment">// determine if should do correction to ucons</span></div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;  <span class="comment">// only correct once -- should really put correction somewhere else.</span></div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;<span class="comment"></span>  docorrectuconslocal=docorrectucons  &amp;&amp; is_within_correctable_region;</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;  <span class="keywordflow">return</span>(docorrectuconslocal);</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;}</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;</div>
<div class="line"><a name="l00199"></a><span class="lineno"><a class="code" href="../../de/d95/fixup_8c.html#a43fb15d762b67f635ac6c63a158bf558">  199</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="../../de/d95/fixup_8c.html#a43fb15d762b67f635ac6c63a158bf558" title="record who called the diag_fixup routine">count_whocalled</a>(<span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k, <span class="keywordtype">int</span> finalstep, <span class="keywordtype">int</span> whocalled, CTYPE toadd)</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;{</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;  <span class="keywordtype">int</span> tscale;</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;  <span class="comment">// Count times in diag_fixup() and who called diag_fixup()</span></div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;  <span class="comment">// count every time corrects, not just on conserved quantity tracking time</span></div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;<span class="comment"></span>  <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#aefc47346bd5140a39b6d744385796e56" title="0: don&#39;t output debug dump file or ener file(ener is based on dump counts) 1: do">DODEBUG</a>){</div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;    <span class="keywordflow">if</span>(whocalled&gt;=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ad9bb736bd7bcb5b96bf37975a5b7cbec">NUMFAILFLOORFLAGS</a> || whocalled&lt;<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aae4571e79c28a280618d20eebdb051cf" title="see failfloorcount counter">COUNTNOTHING</a> || i&lt;-N1BND || i&gt;<a class="code" href="../../da/d3e/definit_8h.html#abd7b39be02bc15d79b73e5cf2b531299" title="#define CORNGDETVERSION 0">N1</a>-1+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#aa00aaa6c09563827fbe601635b149ef8">N1BND</a> ||j&lt;-N2BND || j&gt;<a class="code" href="../../da/d3e/definit_8h.html#acd864640121c7df2c19f61f7baa507e4">N2</a>-1+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a4053d825930f47a796f9f13678ef32e3">N2BND</a> ||k&lt;-N3BND || k&gt;<a class="code" href="../../da/d3e/definit_8h.html#ad66109fbdc4d3adc9c3d6ff917038aef">N3</a>-1+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a90d132cb201447b8fe71388f1b0ffe93">N3BND</a> ){</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;      dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;In diag_fixup() whocalled=%d for i=%d j=%d k=%d\n&quot;</span>,whocalled,i,j,k);</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;      myexit(24683463);</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;    }</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;    <span class="keywordflow">if</span>(whocalled&gt;=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a5bd63d86b10ce66f09529e2b3ed5965a">COUNTREALSTART</a>){</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;      <span class="keywordtype">int</span> indexfinalstep;</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;      indexfinalstep=0;</div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a979d409ad1a4d007f6ec25e62a6d0415" title="loop over debug time scales">TSCALELOOP</a>(tscale) <a class="code" href="../../df/d1c/global_8storage_8h.html#a4ca176a81d2229ced28a5c53ebeacc06">GLOBALMACP0A3</a>(failfloorcount,i,j,k,indexfinalstep,tscale,whocalled)+=toadd;</div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;      <span class="keywordflow">if</span>(finalstep){</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;        indexfinalstep=1;</div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;        <span class="comment">// iterate finalstep version</span></div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a979d409ad1a4d007f6ec25e62a6d0415" title="loop over debug time scales">TSCALELOOP</a>(tscale) <a class="code" href="../../df/d1c/global_8storage_8h.html#a4ca176a81d2229ced28a5c53ebeacc06">GLOBALMACP0A3</a>(failfloorcount,i,j,k,indexfinalstep,tscale,whocalled)+=toadd;</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;      }</div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;    }<span class="comment">// end if counting something</span></div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;</div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;  }<span class="comment">// end if DODEBUG</span></div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;</div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;</div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;</div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;}</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;</div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;</div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;<span class="keywordtype">int</span> diag_fixup_dUandaccount(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ui, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Uf, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *ucons, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <span class="keywordtype">int</span> finalstep, <span class="keywordtype">int</span> whocalled, <span class="keywordtype">int</span> docorrectuconslocal)</div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;{</div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dUincell[NPR];</div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;  <span class="keywordtype">int</span> is_within_diagnostic_region;</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> deltaUavg[NPR],Uiavg[NPR];</div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Uprefixup[NPR],Upostfixup[NPR];</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;  <span class="keywordtype">int</span> pliter,pl;</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;  <span class="keywordtype">int</span> enerregion;</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;</div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;</div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;  <span class="comment">// Get deltaUavg[] and also modify ucons if required and should</span></div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a55732148d2616d6d1f5d2abbe8710850">DOENOFLUX</a> != <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#adacaaf8526353cfe870206f0cf4d2ca7" title="for DOENOFLUX: 0: no ENO flux reconstruction 1: reconstruct F for finite difference rep...">NOENOFLUX</a>) {  <span class="comment">//SASMARKx: adjust the conserved quantity to correspond to the adjusted primitive quanitities</span></div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;    <span class="comment">// Correction to conserved quantities not exactly accurate because using point values where should use averaged values</span></div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;    <span class="comment">// notice that geometry comes after subtractions/additions of EOMs</span></div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;    UtoU(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0339344098add3b8dbaaf3f753ed4b4f">UDIAG</a>,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a15d073255fcc246f09aa26337e643d22" title="defines data return types for primtoU() and primtoflux()">UEVOLVE</a>,ptrgeom,Ui,Uprefixup);  <span class="comment">// convert from UDIAG -&gt; UEVOLVE</span></div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;    UtoU(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0339344098add3b8dbaaf3f753ed4b4f">UDIAG</a>,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a15d073255fcc246f09aa26337e643d22" title="defines data return types for primtoU() and primtoflux()">UEVOLVE</a>,ptrgeom,Uf,Upostfixup); <span class="comment">// convert from UDIAG -&gt; UEVOLVE</span></div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;   </div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl) deltaUavg[pl] = Uf[pl]-Ui[pl];</div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;   </div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;    if(docorrectuconslocal){</div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;      <span class="comment">// correct ucons if requested</span></div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;      <span class="comment">//adjust the averaged conserved quantity by the same amt. as the point conserved quantity</span></div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl) ucons[pl] += Upostfixup[pl] - Uprefixup[pl];  </div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;</div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;      <span class="comment">// old code: UtoU(UDIAG,UEVOLVE,ptrgeom,Uf,ucons); // convert from UNOTHING-&gt;returntype (jon&#39;s comment)</span></div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;      <span class="comment">// the above line actually converts fixed up U from diagnostic form of U (with gdet) </span></div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;      <span class="comment">// to evolution form of U (maybe withnogdet) and replaces the avg. conserved quantity (ADT)</span></div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;    }</div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;</div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;  }</div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;  else if(0){</div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;</div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;    <span class="comment">// this method doesn&#39;t work:</span></div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;    UtoU(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a15d073255fcc246f09aa26337e643d22" title="defines data return types for primtoU() and primtoflux()">UEVOLVE</a>,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0339344098add3b8dbaaf3f753ed4b4f">UDIAG</a>,ptrgeom,ucons,Uiavg); <span class="comment">// convert from UNOTHING-&gt;returntype</span></div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;</div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;    <span class="keywordflow">if</span>(docorrectuconslocal){</div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;      <span class="comment">// notice that geometry comes after subtractions/additions of EOMs</span></div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;      UtoU(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0339344098add3b8dbaaf3f753ed4b4f">UDIAG</a>,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a15d073255fcc246f09aa26337e643d22" title="defines data return types for primtoU() and primtoflux()">UEVOLVE</a>,ptrgeom,Uf,ucons); <span class="comment">// convert from UNOTHING-&gt;returntype</span></div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;    }</div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;   </div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl) deltaUavg[pl] = Uf[pl]-Uiavg[pl];</div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;  }</div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;  else{</div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;    <span class="comment">// original HARM method</span></div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;    <span class="comment">// don&#39;t modify ucons.  That is, we ignore docorrectuconslocal.</span></div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;</div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl) deltaUavg[pl] = Uf[pl]-Ui[pl];</div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;  }</div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;</div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;</div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;</div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;  <span class="comment">//only do aggregate accounting, after the fact (just before taking the new time step)</span></div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;  if(DOONESTEPDUACCOUNTING &amp;&amp; whocalled==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7a9213c1f8c2fd2d354615be55bd32bc">COUNTONESTEP</a> ||  DOONESTEPDUACCOUNTING==0){</div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;</div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;    <span class="comment">// get correction</span></div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;<span class="comment"></span>    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl){</div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;     </div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;      <span class="comment">// dUincell means already (e.g.) (dU0)*(\detg&#39;)*(dV&#39;) = integral of energy in cell = dUint0 in SM</span></div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;      <span class="comment">// So compare this to (e.g.) (U0)*(\detg&#39;)*(dV&#39;) = U0*gdet*dV in SM</span></div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;      dUincell[pl]=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a9e6da72f4fb3e32d9bbf657ae60ec39c">dVF</a> * deltaUavg[pl];</div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;</div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;      <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#a926e8df3554baffbda6ddeb65ded6feb">DOFLOORDIAG</a>){</div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;        <span class="comment">// only store this diagnostic once (not for each enerregion)</span></div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;        <span class="comment">// Note that unlike failfloorcount[], failfloordu[] is independent of fladd and fladdterms that are integrated simultaneously rather than in dump_ener.c</span></div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;        <span class="comment">// Also note that failfloordu not stored in restart file, so like spatial debug info it is lost upon restart.</span></div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;        GLOBALMACP0A1(failfloordu,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,pl)+=dUincell[pl];</div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;      }</div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;</div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;    }<span class="comment">// end over pl&#39;s</span></div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;</div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;</div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;</div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;</div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;    <span class="comment">// Loop over ENERREGIONs</span></div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;<span class="comment"></span>    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a2eb6e271008c49cc3feaa64c6eea2ddb" title="loop over ener/flux regions">ENERREGIONLOOP</a>(enerregion){</div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;</div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;      <span class="comment">// setup pointers to enerregion diagnostics</span></div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;      <a class="code" href="../../d8/d5b/defs_8general_8h.html#ac5158fb917bf2fb5e916aec0b420439c">enerpos</a>=<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad41a84c69f5ec4a51492e96b4dc61ac4">enerposreg</a>[enerregion];</div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;      <a class="code" href="../../d8/d5b/defs_8general_8h.html#aebda2a7dfd8109bff10160f9bf2993fa">fladd</a>=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a6707f24b846a9a6236e3f6b2b64e7e82" title="these quantities contain diagnostics all these require writing to restart file other _tot quantities ...">fladdreg</a>[enerregion];</div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;      <a class="code" href="../../d8/d5b/defs_8general_8h.html#af56ce3c03a54f45dd2230f39521a1489">fladdterms</a>=<a class="code" href="../../d8/d5b/defs_8general_8h.html#acd071ad3c75fd969b717fc8872aa70c4">fladdtermsreg</a>[enerregion];</div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;</div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;</div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;      <span class="comment">//</span></div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;      <span class="comment">// determine if within diagnostic region</span></div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;      <span class="comment">//</span></div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;<span class="comment"></span>      is_within_diagnostic_region=<a class="code" href="../../dd/d5e/global_8loops_8diagnostics_8h.html#adce09b604562ed55df79f487e8d038e4" title="defines whether within the enerregion considered loop-related macro">WITHINENERREGION</a>(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ac5158fb917bf2fb5e916aec0b420439c">enerpos</a>,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k);</div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;</div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;</div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;      <span class="comment">//</span></div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;      <span class="comment">// diagnostics (both for enerregion and single-region types)</span></div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;      <span class="comment">//</span></div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;<span class="comment"></span>      <span class="keywordflow">if</span>(is_within_diagnostic_region){</div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;</div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl){</div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;     </div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;          <span class="comment">// dUincell means already (e.g.) (dU0)*(\detg&#39;)*(dV&#39;) = integral of energy in cell = dUint0 in SM</span></div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;          <span class="comment">// So compare this to (e.g.) (U0)*(\detg&#39;)*(dV&#39;) = U0*gdet*dV in SM</span></div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;          dUincell[pl]=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a9e6da72f4fb3e32d9bbf657ae60ec39c">dVF</a> * deltaUavg[pl];</div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;</div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;          <a class="code" href="../../d8/d5b/defs_8general_8h.html#aebda2a7dfd8109bff10160f9bf2993fa">fladd</a>[pl] += dUincell[pl];</div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;</div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;        }<span class="comment">// end over pl&#39;s</span></div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;      }<span class="comment">// end if within diagnostic region</span></div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;</div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;    }<span class="comment">// end over enerregions</span></div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;</div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;  }<span class="comment">// end if doing accounting</span></div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;</div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;  <span class="keywordflow">if</span>(whocalled&gt;=0 &amp;&amp; whocalled!=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7a9213c1f8c2fd2d354615be55bd32bc">COUNTONESTEP</a>){</div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;</div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;    <span class="comment">// Loop over ENERREGIONs</span></div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;<span class="comment"></span>    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a2eb6e271008c49cc3feaa64c6eea2ddb" title="loop over ener/flux regions">ENERREGIONLOOP</a>(enerregion){</div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;</div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;      <span class="comment">// setup pointers to enerregion diagnostics</span></div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;      <a class="code" href="../../d8/d5b/defs_8general_8h.html#ac5158fb917bf2fb5e916aec0b420439c">enerpos</a>=<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad41a84c69f5ec4a51492e96b4dc61ac4">enerposreg</a>[enerregion];</div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;      <a class="code" href="../../d8/d5b/defs_8general_8h.html#af56ce3c03a54f45dd2230f39521a1489">fladdterms</a>=<a class="code" href="../../d8/d5b/defs_8general_8h.html#acd071ad3c75fd969b717fc8872aa70c4">fladdtermsreg</a>[enerregion];</div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;</div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;</div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;      <span class="comment">//</span></div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;      <span class="comment">// determine if within diagnostic region</span></div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;      <span class="comment">//</span></div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;<span class="comment"></span>      is_within_diagnostic_region=<a class="code" href="../../dd/d5e/global_8loops_8diagnostics_8h.html#adce09b604562ed55df79f487e8d038e4" title="defines whether within the enerregion considered loop-related macro">WITHINENERREGION</a>(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ac5158fb917bf2fb5e916aec0b420439c">enerpos</a>,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k);</div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;</div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;</div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;      <span class="comment">//</span></div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;      <span class="comment">// diagnostics (both for enerregion and single-region types)</span></div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;      <span class="comment">//</span></div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;<span class="comment"></span>      <span class="keywordflow">if</span>(is_within_diagnostic_region){</div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;</div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl){</div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;     </div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;          <span class="comment">// dUincell means already (e.g.) (dU0)*(\detg&#39;)*(dV&#39;) = integral of energy in cell = dUint0 in SM</span></div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;          <span class="comment">// So compare this to (e.g.) (U0)*(\detg&#39;)*(dV&#39;) = U0*gdet*dV in SM</span></div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;          dUincell[pl]=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a9e6da72f4fb3e32d9bbf657ae60ec39c">dVF</a> * deltaUavg[pl];</div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;</div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;          <a class="code" href="../../d8/d5b/defs_8general_8h.html#af56ce3c03a54f45dd2230f39521a1489">fladdterms</a>[whocalled][pl] += (<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a0263684ebff8e72a2f0de1861393595f">SFTYPE</a>)dUincell[pl];</div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;     </div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;</div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;        }<span class="comment">// end over pl&#39;s</span></div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;      }<span class="comment">// end if within diagnostic region</span></div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;</div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;    }<span class="comment">// end over enerregions</span></div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;</div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;  }<span class="comment">// end if doing accounting</span></div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;</div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;</div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;}</div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;</div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;</div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;</div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;<span class="keywordtype">int</span> consfixup_allzones(<span class="keywordtype">int</span> finaluu, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pf)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*ucons)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR])</div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;{</div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;</div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;</div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>, <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>, k, pliter,pl;</div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom;</div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> geomdontuse;</div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;</div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;   </div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;  ptrgeom=&amp;(geomdontuse);</div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;    </div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;  <a class="code" href="../../df/da8/global_8comploops_8h.html#afca0c679f7f4d211de239537a2cd685b" title="below are not original multi-D combindations, just renamings that have no control over order of dimen...">COMPZLOOP</a>{</div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;    <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a3059ed7bfcfb692cbe8014d55fd7c1e4">get_geometry</a>(i, j, k, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8936711f57f82d1fc75c21fa2894e1c6">CENT</a>, ptrgeom);</div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;    <span class="comment">// account for change of conserved quantities</span></div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;    <span class="comment">// Primitives have been modified by fixup1zone() in advance.c (floors).</span></div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;    <span class="comment">// During this call, called from post_advance(), pf also modified by bounds (poledeath,gammadeath) and also post_fixup() (failures, checks, limits).</span></div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;    <span class="comment">// ucons=unewglobal that stores last steps final substep version of ucum that is full U[]</span></div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;    <span class="comment">// ucons has yet to be modified at all, so is true conserved quantity without corrections (as long as avoided corrections to ucons during other diag_fixup calls).</span></div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;    <span class="comment">// GODMARK: So this method only works if NOENOFLUX==1, since otherwise *need* to modify U[] during modification of p[] since know how much to modify.</span></div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;</div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;    consfixup_1zone(finaluu, i,j,k, ptrgeom, &amp;<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pf,i,j,k,0), &amp;<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(ucons,i,j,k,0));</div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;</div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;</div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;  }</div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;</div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;</div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;</div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;}</div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;</div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;</div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;<span class="keywordtype">int</span> consfixup_1zone(<span class="keywordtype">int</span> finaluu, <span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pf, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *ucons)</div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;{</div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;  <span class="keywordflow">if</span>(ENSURECONS==0 || (<a class="code" href="../../da/d3e/definit_8h.html#a99ba7daf58b283bc831b8f507f5873a4" title="#define EOMTYPE EOMCOLDGRMHD">EOMRADTYPE</a>==<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a993e29ef4139116d822d89bccb92180d" title="radiation equations of motion">EOMRADNONE</a>)) <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;</div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;  <span class="keywordtype">int</span> pliter,pl;</div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;  <span class="comment">// now that have averaged values, try to enforce energy conservation by borrowing from radiation</span></div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pp=pf;</div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> qp;</div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;  <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a11e17cd8b0594d1ad52e3594aa9f477e" title="find ucon, ucov, bcon, bcov from primitive variables when calling get_state, users of this function e...">get_state</a>(pp,ptrgeom,&amp;qp);</div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;  <span class="keywordtype">int</span> uutype=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab2be21bd5eff40ca89c20eeecbeab5e0">UNOTHING</a>;</div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> uu[NPR],uuabs[NPR];</div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;  <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a9a54096e4c40a15a2c1bf74266153616" title="calculate &quot;conserved&quot; quantities">primtoU</a>(uutype,pp,&amp;qp,ptrgeom,uu,uuabs);</div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> uu0[NPR];</div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;  <span class="keywordflow">if</span>(finaluu==1){</div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;<span class="preprocessor">#if(WHICHEOM==WITHGDET)</span></div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;<span class="preprocessor"></span>    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) uu0[pl]=ucons[pl]*ptrgeom-&gt;igdetnosing; <span class="comment">// put in UNOTHING form</span></div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;<span class="preprocessor"></span>    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) uu0[pl]=ucons[pl]*ptrgeom-&gt;ieomfuncnosing[pl]; <span class="comment">// put in UNOTHING form</span></div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;<span class="preprocessor"></span>  }</div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;    <span class="comment">//    PLOOP(pliter,pl) uu0[pl] = GLOBALMACP0A1(uu0old,i,j,k,pl); // USE OF GLOBALS from phys.tools.rad.c // already in UNOTHING form</span></div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;  }</div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;  </div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;</div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;  </div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> uunew1[NPR];</div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) uunew1[pl]=uu[pl];</div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dugas[4];</div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;  <span class="keywordtype">int</span> jj;</div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) uunew1[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>+jj] = uu[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>+jj];</div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) dugas[jj] = uu[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>+jj]-uu0[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>+jj];</div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) uunew1[URAD0+jj] = uu0[URAD0+jj] - dugas[jj];</div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;</div>
<div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;</div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;  </div>
<div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;<span class="preprocessor">#if(0)</span></div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;<span class="preprocessor"></span>  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> uunew2[NPR];</div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) uunew2[pl]=uu[pl];</div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> durad[4];</div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) uunew2[URAD0+jj] = uu[URAD0+jj];</div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) durad[jj] = uu[URAD0+jj]-uu0[URAD0+jj];</div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) uunew2[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>+jj] = uu0[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>+jj] - durad[jj];</div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;  <span class="comment">// choose which or how much of each uunew and uunew2</span></div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> uunewfinal[NPR];</div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) uunewfinal[pl] = uu[pl];</div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj){</div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;    uunewfinal[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>+jj]   = 0.5*(uunew1[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>+jj] + uunew2[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>+jj]);</div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;    uunewfinal[URAD0+jj] = 0.5*(uunew1[URAD0+jj] + uunew2[URAD0+jj]);</div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;  }</div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;  <span class="comment">// now invert just radiation</span></div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;  <span class="keywordtype">int</span> showmessages=0;</div>
<div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;  <span class="keywordtype">int</span> allowlocalfailurefixandnoreport=1;</div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;  <span class="keywordtype">int</span> whichcap=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a4b6c6060c025e15f1d92aae3dcb9365b" title="which cap type to place in rad inversion">CAPTYPEBASIC</a>; <span class="comment">// finalcheck type</span></div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;</div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;  <span class="keywordtype">int</span> didrad=0;</div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;  <span class="keywordflow">if</span>(-uunew1[URAD0]&lt;-uu[URAD0]){ <span class="comment">// only modify radiation if forcing less radiation, not more as that can run-away</span></div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> <a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#addff6a9e94a657b1acf23dbc17257475" title="during implicit solver, don&#39;t limit gamma so much as normally. Otherwise, solution may not be found a...">GAMMAMAXRADIMPLICITSOLVER</a>=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a51ef12e4cafc4a8fe70374c37f57d565">GAMMAMAXRAD</a>;</div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;    <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> lpflag=0;</div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;    <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> lpflagrad=0;</div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> pprad[NPR];</div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) pprad[pl]=pp[pl];</div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;    <span class="comment">// u2p_rad takes UNOTHING form</span></div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;    <a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#a9fe58e7f372421d18633c8fc5007b815">u2p_rad</a>(showmessages, allowlocalfailurefixandnoreport,GAMMAMAXRADIMPLICITSOLVER,whichcap,uunew1,pprad,ptrgeom,&amp;lpflag,&amp;lpflagrad);</div>
<div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;    <span class="keywordtype">int</span> radinvmod=(<span class="keywordtype">int</span>)(lpflagrad);</div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;    if(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0e5fdba5f1203c30829d49bad47dae01">RADINVOK</a>(radinvmod) &amp;&amp; <a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(pprad[URAD0])==1 &amp;&amp; <a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(pprad[URAD1])==1 &amp;&amp; <a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(pprad[URAD2])==1 &amp;&amp; <a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(pprad[URAD3])==1 &amp;&amp; pprad[URAD0] &lt; pp[URAD0]){</div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) if(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a43791f6c1915cf7bfe3a02a4502510e4">RADFULLPL</a>(pl)) pp[pl] = pprad[pl];</div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;      didrad=1;</div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;    }</div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;    else{</div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;      didrad=0;</div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;      <span class="comment">//    dualfprintf(fail_file,&quot;issue ijk=%d %d %d radinvmod=%d\n&quot;,i,j,k,radinvmod);</span></div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;      <span class="comment">//    PLOOP(pliter,pl) if(RADFULLPL(pl)) dualfprintf(fail_file,&quot;pprad[%d]=%g\n&quot;,pl,pprad[pl]);</span></div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;    }</div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;  }</div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;</div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;</div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;<span class="preprocessor">#if(0)</span></div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;<span class="preprocessor"></span>  <span class="keywordflow">if</span>(0&amp;&amp;didrad==0){</div>
<div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;    <span class="keywordtype">int</span> finalstep=finaluu;</div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;    <span class="keywordtype">int</span> eomtypelocal=<a class="code" href="../../da/d3e/definit_8h.html#a87e5572748e4cc27373e50bd78e6f2e8">EOMTYPE</a>;</div>
<div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;    <span class="keywordtype">int</span> whichmethod=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aef33cf4e6c2534137907bc2eaefdb224">MODEPICKBEST</a>; <span class="comment">// try to choose best option for this &quot;external&quot; inversion</span></div>
<div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;    <span class="keywordtype">int</span> modprim=0;</div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;    <span class="keywordtype">int</span> checkoninversiongas=<a class="code" href="../../da/d3e/definit_8h.html#a5dc18e6d15e4420586d45d912fccebac" title="whether to check on inversion and report problem Also, use diag_fixup() to account for changes in U w...">CHECKONINVERSION</a>;</div>
<div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;    <span class="keywordtype">int</span> checkoninversionrad=<a class="code" href="../../da/d3e/definit_8h.html#a70e4418eb8c6479afc202024b46ad581">CHECKONINVERSIONRAD</a>;</div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dissmeasure=0.0;</div>
<div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;  </div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;</div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;    <span class="keyword">struct </span><a class="code" href="../../db/d3a/structof__newtonstats.html">of_newtonstats</a> newtonstats; setnewtonstatsdefault(&amp;newtonstats);</div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;    <span class="comment">// initialize counters</span></div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;    newtonstats.nstroke=newtonstats.lntries=0;</div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;    <span class="comment">// KORALNOTE: If make newtonstats.tryconv~convabs, then if convabs~1E-12, then MHD inversion may return error~1E-10 in terms of how measured with f_error_check(), so must try harder than expected.</span></div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;    newtonstats.tryconv=1<a class="code" href="../../d8/d60/init_8c.html#a07484107e6d9fdf38b53edf631d6511d">E</a>-3;</div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;    newtonstats.tryconvultrarel=1<a class="code" href="../../d8/d60/init_8c.html#a07484107e6d9fdf38b53edf631d6511d">E</a>-5;</div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;    newtonstats.extra_newt_iter=1;</div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;    newtonstats.extra_newt_iter_ultrarel=1;</div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;<span class="preprocessor">#define MINTRYCONVFORMHDINVERSION (1E-4) // assume not failure if got down to this much. -- don&#39;t have to be related to implicit allowance.</span></div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;    newtonstats.mintryconv=<a class="code" href="../../d2/d72/phys_8tools_8rad_8c.html#a9246a73614335644963eb4e47ec0de8c">MINTRYCONVFORMHDINVERSION</a>;</div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;    newtonstats.maxiter=100;</div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;</div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> pptry[NPR];</div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) pptry[pl] = pf[pl];</div>
<div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;    <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(<a class="code" href="../../d1/d3e/utoprimgen_8c.html#a7e078cc9a354495bc85554d875a705d9" title="General explicit inversion of U[MHD]-&gt;P[MHD] and also inverts scalars. Inverts radiation if(EOMRADTYP...">Utoprimgen</a>(showmessages,checkoninversiongas,checkoninversionrad,allowlocalfailurefixandnoreport, finalstep,&amp;eomtypelocal,whichcap,whichmethod,modprim,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7d1dc231c422450f87fdb3e71b4a7aff" title="defines how Utoprimgen is used">EVOLVEUTOPRIM</a>,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab2be21bd5eff40ca89c20eeecbeab5e0">UNOTHING</a>,uunewfinal, &amp;qp, ptrgeom, dissmeasure, pptry, pptry, &amp;newtonstats),&quot;<a class="code" href="../../d9/de0/step__ch_8c.html#afe241569412f22a86dea9cd91b516af8" title="take step itself">step_ch</a>.c:<a class="code" href="../../df/d22/advance_8c.html#a22dff5dc24ff389254919e70b79be489" title="pi: initial values at t=t0 to compute Ui pb: values used to compute flux/source pf: solution using fl...">advance</a>()&quot;, &quot;<a class="code" href="../../d1/d3e/utoprimgen_8c.html#a7e078cc9a354495bc85554d875a705d9" title="General explicit inversion of U[MHD]-&gt;P[MHD] and also inverts scalars. Inverts radiation if(EOMRADTYP...">Utoprimgen</a>&quot;, 1);</div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;</div>
<div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;    <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflag,*lpflagrad;</div>
<div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;    lpflag=&amp;GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>);</div>
<div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;    lpflagrad=&amp;GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>);</div>
<div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;  </div>
<div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;</div>
<div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;    if(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a294c90ee60024e6f3548814e7ff10a41">IFUTOPRIMFAILSOFT</a>(*lpflag)){</div>
<div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;      <span class="comment">// PLOOP(pliter,pl) pf[pl] = pptry[pl]; </span></div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;    }</div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a781d24b3e646f7f4597b0b7004507a63">IFUTOPRIMRADFAIL</a>(*lpflagrad)){</div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;    }</div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>( <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0894a5e6c53e2e8a143d10be7a42d492">IFUTOPRIMFAIL</a>(*lpflag) || <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a781d24b3e646f7f4597b0b7004507a63">IFUTOPRIMRADFAIL</a>(*lpflagrad) ){</div>
<div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;    }</div>
<div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) pf[pl] = pptry[pl]; </div>
<div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;    }</div>
<div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;  }  </div>
<div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> qf;</div>
<div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;  <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a11e17cd8b0594d1ad52e3594aa9f477e" title="find ucon, ucov, bcon, bcov from primitive variables when calling get_state, users of this function e...">get_state</a>(pf,ptrgeom,&amp;qf);</div>
<div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> uf[NPR],ufabs[NPR];</div>
<div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;  <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a9a54096e4c40a15a2c1bf74266153616" title="calculate &quot;conserved&quot; quantities">primtoU</a>(uutype,pf,&amp;qf,ptrgeom,uf,ufabs); <span class="comment">// should be closer to having uf[UU]+uf[URAD0] = ucons[UU]+ucons[URAD0]</span></div>
<div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;</div>
<div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> uudiag[NPR],ufdiag[NPR];</div>
<div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;  UtoU(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab2be21bd5eff40ca89c20eeecbeab5e0">UNOTHING</a>,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0339344098add3b8dbaaf3f753ed4b4f">UDIAG</a>,ptrgeom,uu,uudiag);  <span class="comment">// convert from UNOTHING -&gt; UDIAG</span></div>
<div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;  UtoU(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab2be21bd5eff40ca89c20eeecbeab5e0">UNOTHING</a>,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0339344098add3b8dbaaf3f753ed4b4f">UDIAG</a>,ptrgeom,uf,ufdiag); <span class="comment">// convert from UNOTHING -&gt; UDIAG</span></div>
<div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;</div>
<div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;</div>
<div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;  <span class="comment">// Get deltaUavg[] and also modify ucons if required and should</span></div>
<div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;  <span class="keywordtype">int</span> whocalled=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2d812458ea90372704d47577b54f3687">COUNTUCONSFIXUP</a>;</div>
<div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;  <span class="keywordtype">int</span> docorrectuconslocal=0;</div>
<div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;  <span class="keywordtype">int</span> finalstep=finaluu;</div>
<div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;  diag_fixup_dUandaccount(uudiag, ufdiag, ucons, ptrgeom, finalstep, whocalled, docorrectuconslocal);</div>
<div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;</div>
<div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;</div>
<div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;</div>
<div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;</div>
<div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;  <span class="comment">// so exact energy conservation at cost of unknown effect on radiation</span></div>
<div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;  <span class="comment">// so one-step accounting below will include a floor for both gas and radiation, but sum of floors will always be zero net gain of energy-momentum as long as radiation has radinvmod==0</span></div>
<div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;</div>
<div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;}</div>
<div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;</div>
<div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;</div>
<div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;</div>
<div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;<span class="keywordtype">int</span> diag_fixup_allzones(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pf)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*ucons)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR])</div>
<div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;{</div>
<div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;</div>
<div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>, <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>, k, pliter,pl;</div>
<div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom;</div>
<div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> geomdontuse;</div>
<div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;</div>
<div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a55732148d2616d6d1f5d2abbe8710850">DOENOFLUX</a>!=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#adacaaf8526353cfe870206f0cf4d2ca7" title="for DOENOFLUX: 0: no ENO flux reconstruction 1: reconstruct F for finite difference rep...">NOENOFLUX</a>){</div>
<div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;    dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;Cannot use diag_fixup_allzones() with DOENOFLUX!=NOENOFLUX\n&quot;</span>);</div>
<div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;    myexit(3487622211);</div>
<div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;  }</div>
<div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;    </div>
<div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;  ptrgeom=&amp;(geomdontuse);</div>
<div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;    </div>
<div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;  <a class="code" href="../../df/da8/global_8comploops_8h.html#afca0c679f7f4d211de239537a2cd685b" title="below are not original multi-D combindations, just renamings that have no control over order of dimen...">COMPZLOOP</a>{</div>
<div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;    <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a3059ed7bfcfb692cbe8014d55fd7c1e4">get_geometry</a>(i, j, k, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8936711f57f82d1fc75c21fa2894e1c6">CENT</a>, ptrgeom);</div>
<div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;    <span class="comment">// account for change of conserved quantities</span></div>
<div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;    <span class="comment">// Primitives have been modified by fixup1zone() in advance.c (floors).</span></div>
<div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;    <span class="comment">// During this call, called from post_advance(), pf also modified by bounds (poledeath,gammadeath) and also post_fixup() (failures, checks, limits).</span></div>
<div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;    <span class="comment">// ucons=unewglobal that stores last steps final substep version of ucum that is full U[]</span></div>
<div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;    <span class="comment">// ucons has yet to be modified at all, so is true conserved quantity without corrections (as long as avoided corrections to ucons during other diag_fixup calls).</span></div>
<div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;    <span class="comment">// GODMARK: So this method only works if NOENOFLUX==1, since otherwise *need* to modify U[] during modification of p[] since know how much to modify.</span></div>
<div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;</div>
<div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;    <span class="keywordtype">int</span> docorrectucons=(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a55732148d2616d6d1f5d2abbe8710850">DOENOFLUX</a> != <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#adacaaf8526353cfe870206f0cf4d2ca7" title="for DOENOFLUX: 0: no ENO flux reconstruction 1: reconstruct F for finite difference rep...">NOENOFLUX</a>); <span class="comment">// make any needed corrections if doing corrections</span></div>
<div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;    <span class="keywordtype">int</span> finalstep=1; <span class="comment">// if here, always on finalstep=1</span></div>
<div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Uf[NPR]; <span class="comment">// for returning back pf-&gt;Uf result so don&#39;t have to repeat if needed later</span></div>
<div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;    diag_fixup_Ui_pf(docorrectucons,<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(ucons,i,j,k),<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(pf,i,j,k),ptrgeom,finalstep,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7a9213c1f8c2fd2d354615be55bd32bc">COUNTONESTEP</a>, Uf); <span class="comment">// Uf in UDIAG form</span></div>
<div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;</div>
<div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *<a class="code" href="../../dc/dd2/newcodediff_8txt.html#ae7ab77d7e616dc02fba121a009b48c27">pr</a>=<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(pf,i,j,k);</div>
<div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;</div>
<div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;    <span class="keywordtype">int</span> map[NPR];</div>
<div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> uconmap[NPR];</div>
<div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;      uconmap[pl]=1.0; <span class="comment">// default</span></div>
<div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;</div>
<div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;      <span class="keywordflow">if</span>(pl==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>) map[pl]=YFL1;</div>
<div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span>(pl==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>) map[pl]=YFL2;</div>
<div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span>(pl==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8de9104f1fffa59f057b214d74c5cfea">U3</a>) map[pl]=YFL3;</div>
<div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span>(pl==URAD0) map[pl]=YFL4;</div>
<div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span>(pl==URAD3) map[pl]=YFL5;</div>
<div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;      <span class="keywordflow">else</span> map[pl]=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a44eb78b5d9896ae73ef10b5612a3b570">VARNOTDEFINED</a>;</div>
<div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;    }</div>
<div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;</div>
<div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;</div>
<div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ucon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>],others[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a266c1c3ab2959dbfc603c7d3f12783fb" title="strict limit (doesn&#39;t work in general)">NUMOTHERSTATERESULTS</a>];</div>
<div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;    <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#afc93fd4a6f7a2b87a9315d5fba5a529c">ucon_calc</a>(pr,ptrgeom,ucon,others);</div>
<div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;    <span class="keywordflow">if</span>(YFL1&gt;=0) uconmap[YFL1]=ucon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>];</div>
<div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;    <span class="keywordflow">if</span>(YFL2&gt;=0) uconmap[YFL2]=-ucon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>]; <span class="comment">// NOTEMARK: Same sign as in other places like utoprimgen.c</span></div>
<div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;    <span class="keywordflow">if</span>(YFL3&gt;=0) uconmap[YFL3]=ucon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>];</div>
<div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;    </div>
<div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;    <span class="keywordflow">if</span>(YFL4&gt;=0 || YFL5&gt;=0){</div>
<div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> uradcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>],othersrad[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a266c1c3ab2959dbfc603c7d3f12783fb" title="strict limit (doesn&#39;t work in general)">NUMOTHERSTATERESULTS</a>];</div>
<div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;      <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#afc93fd4a6f7a2b87a9315d5fba5a529c">ucon_calc</a>(&amp;pr[URAD1-<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>],ptrgeom,uradcon,othersrad);</div>
<div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;      <span class="keywordflow">if</span>(YFL4&gt;=0) uconmap[YFL4]=-uradcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>]; <span class="comment">// NOTEMARK: Same sign as in other places like utoprimgen.c</span></div>
<div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;      <span class="keywordflow">if</span>(YFL5&gt;=0) uconmap[YFL5]=uradcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>];</div>
<div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;    }</div>
<div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;</div>
<div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;    <span class="comment">// assume fixed floor for YFLx like at t=0</span></div>
<div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> offset[NPR];</div>
<div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;</div>
<div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> rhofloor=pr[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>]*<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a8913cb5d64cfec23ae1a3052930ec468">NUMEPSILON</a>*10.0;</div>
<div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> vfloor=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a8913cb5d64cfec23ae1a3052930ec468">NUMEPSILON</a>*10.0;</div>
<div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> enfloor=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a5bd9da451f108352614cbc457524c5b0">ERADLIMIT</a>;</div>
<div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;    <span class="keywordflow">if</span>(URAD0&gt;=0) enfloor+= (pr[URAD0])*<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a8913cb5d64cfec23ae1a3052930ec468">NUMEPSILON</a>*10.0;</div>
<div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) offset[pl]=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a09c78d2f8feb311dd9fc969a0bf84979">SMALL</a>;</div>
<div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;    if(YFL1&gt;=0) offset[YFL1] = SMALL + rhofloor; <span class="comment">// rho floor</span></div>
<div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;    if(YFL2&gt;=0) offset[YFL2] = SMALL + rhofloor*vfloor*vfloor + <a class="code" href="../../d8/d5b/defs_8general_8h.html#aa0ed69c2bd22558a88c5030c33d90371">UULIMIT</a>; <span class="comment">// -T^t_t-rho u^r floor</span></div>
<div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;    if(YFL3&gt;=0) offset[YFL3] = SMALL + rhofloor*vfloor; <span class="comment">// T^t_phi floor</span></div>
<div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;    if(YFL4&gt;=0) offset[YFL4] = SMALL + enfloor; <span class="comment">// -R^t_t floor</span></div>
<div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;    if(YFL5&gt;=0) offset[YFL5] = SMALL + enfloor*vfloor; <span class="comment">// R^t_\phi floor</span></div>
<div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;  </div>
<div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;</div>
<div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> uconsnothing[NPR];</div>
<div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;    UtoU(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a15d073255fcc246f09aa26337e643d22" title="defines data return types for primtoU() and primtoflux()">UEVOLVE</a>,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab2be21bd5eff40ca89c20eeecbeab5e0">UNOTHING</a>,ptrgeom,<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(ucons,i,j,k),uconsnothing);</div>
<div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;</div>
<div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Ufnothing[NPR];</div>
<div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;    UtoU(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0339344098add3b8dbaaf3f753ed4b4f">UDIAG</a>,UNOTHING,ptrgeom,Uf,Ufnothing);</div>
<div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;</div>
<div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;    <span class="keywordtype">int</span> mapvar;</div>
<div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;      mapvar=map[pl];</div>
<div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;      <span class="keywordflow">if</span>(mapvar&gt;=0){</div>
<div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;      </div>
<div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;        <span class="comment">// effective source term for floor scalar accounting for all changes to pl not accounted for by conserved quantity additions (that includes no floors or failures or anything else except fluxes)</span></div>
<div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;        <span class="comment">// Assumes floor and mass have same velocity</span></div>
<div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;        <span class="comment">// dpl can actually be negative or positive, but only negative when failure</span></div>
<div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;        <span class="comment">//      FTYPE pl=MACP0A1(pf,i,j,k,PL); // new final total</span></div>
<div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;        <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> pltotal=Ufnothing[pl]/uconmap[mapvar];</div>
<div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;        <span class="comment">//FTYPE dpl=pl - uconsnothing[pl]/uconmap[mapvar];</span></div>
<div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;        <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dpl=(Ufnothing[pl] - uconsnothing[pl])/uconmap[mapvar];</div>
<div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;</div>
<div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;        <span class="keywordflow">if</span>(<a class="code" href="../../de/d95/fixup_8c.html#ad7222bf183c76ad39adea3084ff61ba4">YFLADDRADTOGAS</a>){</div>
<div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;          <span class="keywordtype">int</span> plalt;</div>
<div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;          <span class="keywordflow">if</span>(pl==URAD0){</div>
<div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;            plalt=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>;</div>
<div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;            dpl+=(Ufnothing[plalt] - uconsnothing[plalt])/uconmap[map[plalt]];</div>
<div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;          }</div>
<div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;          <span class="keywordflow">if</span>(pl==URAD3){</div>
<div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;            plalt=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8de9104f1fffa59f057b214d74c5cfea">U3</a>;</div>
<div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;            dpl+=(Ufnothing[plalt] - uconsnothing[plalt])/uconmap[map[plalt]];</div>
<div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;          }</div>
<div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;        }</div>
<div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;</div>
<div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;        <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> plfl;</div>
<div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;        <span class="comment">//      FTYPE plfl = MACP0A1(pf,i,j,k,mapvar)*pltotal); // final plfl without source term (if failure, then yflx and pl come from averaging, then plfl and pltotal will not be related by conserved fluxes and (e.g.) yflx can become &gt;1</span></div>
<div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;        <span class="comment">//        FTYPE yflx = uconsnothing[mapvar]/uconsnothing[pl]; // yflx expected from ucons that accounts for fluxes but no sources, but uconsnothing[pl] could be negative or zero and would have led to failure</span></div>
<div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;        plfl = uconsnothing[mapvar]/uconmap[mapvar]; <span class="comment">// plfl from ucons, not consistent with final yflx,pltotal if failure, but averaged yflx probably worse than yflx linked to pltotal</span></div>
<div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;        <span class="comment">//      if(plfl&lt;SMALL) plfl=SMALL;</span></div>
<div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;</div>
<div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;        <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> plflfinal = plfl + dpl;</div>
<div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;        <span class="keywordflow">if</span>(1&amp;&amp;(mapvar==YFL2 || mapvar==YFL4)){ <span class="comment">// just energy densities.  Can&#39;t apply to angular momenta that can be any sign.  Could apply to density, but doesn&#39;t seem to need it.</span></div>
<div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;          <span class="comment">// at least for non-densities, especially energy densities, having near 0 or negative values leads to an instability and crazy run-away in the values due to fluxes.</span></div>
<div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;          <span class="comment">// So won&#39;t be able to track losses of energy, only gains, unless split gains and losses.</span></div>
<div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;          <span class="comment">// Or maybe need floor at t=0 at least so that not dealing with crazy small values?</span></div>
<div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;          <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> offsetfull=0.0;</div>
<div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;          <span class="keywordflow">if</span>(pl==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>&amp;&amp;0){ <span class="comment">// need to compare to zero when rest-mass added</span></div>
<div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;            offsetfull=offset[mapvar]-uconsnothing[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>]/ucon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>];</div>
<div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;          }</div>
<div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;          <span class="keywordflow">else</span> offsetfull=offset[mapvar];</div>
<div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;          <span class="keywordflow">if</span>(plflfinal&lt;offsetfull) plflfinal=offsetfull; <span class="comment">// allow flux and source to compensate to give final &gt;0 quantity</span></div>
<div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;        }</div>
<div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;</div>
<div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;<span class="preprocessor">#if(0)</span></div>
<div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;<span class="preprocessor"></span>        <span class="comment">// plfl could have been negative, as if failure or other process pulled away total rest-mass.  Since force not have floor on value, then that means plfl can go greater than pltotal sometimes.  So avoid.</span></div>
<div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;        <span class="keywordflow">if</span>(plflfinal&gt;pltotal) plflfinal=pltotal; <span class="comment">// limit so effective true Y_fl&lt;=1</span></div>
<div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;        <span class="comment">// set actual total change in effective floor</span></div>
<div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;        <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#a79e43847a28767578803cc5af29883cc" title="must also set RESCALEINTERP=1">DOYFL</a>==1){ <span class="comment">// here get true Y_fl=plflfinal/pltotal</span></div>
<div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;          <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pf,i,j,k,mapvar) = plflfinal/(SMALL+fabs(pltotal)); <span class="comment">// newYflx = newplfl / newpltotal</span></div>
<div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;        }</div>
<div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#a79e43847a28767578803cc5af29883cc" title="must also set RESCALEINTERP=1">DOYFL</a>==2){ <span class="comment">// source term to density scalar, assuming pf was evolved via fluxes already for YFLx itself, so here we just add error term from normal evolved quantities</span></div>
<div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;          <span class="comment">//          if(mapvar==YFL4 &amp;&amp; plflfinal&lt;ERADLIMIT) plflfinal=ERADLIMIT;</span></div>
<div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;          <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pf,i,j,k,mapvar) = plflfinal;</div>
<div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;        }</div>
<div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;        <span class="comment">//      dualfprintf(fail_file,&quot;pltotal=%g dpl=%g plfl=%g plflfinal=%g yfl=%g\n&quot;,pltotal,dpl,plfl,plflfinal,MACP0A1(pf,i,j,k,YFL));</span></div>
<div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;</div>
<div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;</div>
<div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;      } <span class="comment">// end if doing this Yflx</span></div>
<div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;    }<span class="comment">// end loop over Yflx</span></div>
<div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;  }<span class="comment">// end spatial loop</span></div>
<div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;</div>
<div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;</div>
<div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;</div>
<div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;}</div>
<div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;</div>
<div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;</div>
<div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;</div>
<div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;<span class="keywordtype">int</span> diag_fixup(<span class="keywordtype">int</span> docorrectucons, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr0, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *uconsinput, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <span class="keywordtype">int</span> finalstep, <span class="keywordtype">int</span> doingmhdfixup, <span class="keywordtype">int</span> whocalled)</div>
<div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;{</div>
<div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> q;</div>
<div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Uicent[NPR],Ufcent[NPR];</div>
<div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;  <span class="keywordtype">int</span> failreturn;</div>
<div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;  <span class="keywordtype">void</span> UtoU(<span class="keywordtype">int</span> inputtype, <span class="keywordtype">int</span> returntype,<span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom,<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Uin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Uout);</div>
<div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> deltaUavg[NPR],Uiavg[NPR];</div>
<div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Uprefixup[NPR],Upostfixup[NPR];</div>
<div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;  <span class="keywordtype">int</span> docorrectuconslocal;</div>
<div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;  <span class="keywordtype">int</span> pliter,pl;</div>
<div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;</div>
<div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;  <span class="comment">// store ucons and only change if needed (and handle avoidance of B1,B2,B3 in case ucons points to unewglobal staggered field, while here we operate on centers)</span></div>
<div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ucons[NPR];</div>
<div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;  <span class="keywordflow">if</span>(uconsinput!=NULL){</div>
<div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) ucons[pl]=uconsinput[pl];</div>
<div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;  }</div>
<div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;</div>
<div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;<span class="preprocessor">#if(DOSUPERDEBUG)</span></div>
<div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;<span class="preprocessor"></span>  superdebug_utoprim(pr0,pr,ptrgeom,whocalled);</div>
<div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;  <span class="comment">// collect values for non-failed and failed zones</span></div>
<div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;</div>
<div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;</div>
<div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;  <span class="comment">// count whocalled diag_fixup()</span></div>
<div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;  <span class="keywordflow">if</span>(doingmhdfixup) <a class="code" href="../../de/d95/fixup_8c.html#a43fb15d762b67f635ac6c63a158bf558" title="record who called the diag_fixup routine">count_whocalled</a>(ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k, finalstep, whocalled,1);</div>
<div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;</div>
<div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;</div>
<div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;</div>
<div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;  <span class="comment">// Account for changes in primitives or conserved quantities due to fixups (floor or failures or any other thing that can call diag_fixup()</span></div>
<div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;  <span class="comment">// only account if on full timestep</span></div>
<div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;  <span class="comment">// ucum (unew) only inverted to primitives on final substep.  Any other conserved or primitive corrections do not matter since they only affected fluxes that go into true conserved quantity that is ucum (unew)</span></div>
<div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;  <span class="keywordflow">if</span>(finalstep &gt; 0){</div>
<div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;</div>
<div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;    <span class="comment">// determine if within correctable region</span></div>
<div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;<span class="comment"></span>    docorrectuconslocal=diag_fixup_correctablecheck(docorrectucons,ptrgeom);</div>
<div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;</div>
<div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;</div>
<div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;</div>
<div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;    <span class="comment">//      </span></div>
<div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;    <span class="comment">// Get Uicent and Ufcent.  Don&#39;t do this inside enerregion because no point since assume diag_fixup() called in limited regions of i,j,k anyways.</span></div>
<div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;    <span class="comment">// only account if within active zones for that region</span></div>
<div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;    <span class="comment">// Only valid if not higher order method or if MERGED method where conserved (except field) are at points as also the primitives are</span></div>
<div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;</div>
<div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;    <span class="comment">// before any changes</span></div>
<div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;    failreturn=<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a11e17cd8b0594d1ad52e3594aa9f477e" title="find ucon, ucov, bcon, bcov from primitive variables when calling get_state, users of this function e...">get_state</a>(pr0,ptrgeom,&amp;q);</div>
<div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;    <span class="keywordflow">if</span>(failreturn&gt;=1) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;get_state(1) failed in fixup.c, why???\n&quot;</span>);</div>
<div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;    failreturn=<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a9a54096e4c40a15a2c1bf74266153616" title="calculate &quot;conserved&quot; quantities">primtoU</a>(UDIAG,pr0,&amp;q,ptrgeom,Uicent, NULL);</div>
<div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;    <span class="keywordflow">if</span>(failreturn&gt;=1) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;primtoU(1) failed in fixup.c, why???\n&quot;</span>);</div>
<div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160; </div>
<div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;</div>
<div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;    <span class="comment">// after any changes</span></div>
<div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;    failreturn=<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a11e17cd8b0594d1ad52e3594aa9f477e" title="find ucon, ucov, bcon, bcov from primitive variables when calling get_state, users of this function e...">get_state</a>(pr,ptrgeom,&amp;q);</div>
<div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;    <span class="keywordflow">if</span>(failreturn&gt;=1) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;get_state(2) failed in fixup.c, why???\n&quot;</span>);</div>
<div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;    failreturn=<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a9a54096e4c40a15a2c1bf74266153616" title="calculate &quot;conserved&quot; quantities">primtoU</a>(UDIAG,pr,&amp;q,ptrgeom,Ufcent, NULL);</div>
<div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;    <span class="keywordflow">if</span>(failreturn&gt;=1) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;primtoU(2) failed in fixup.c, why???\n&quot;</span>);</div>
<div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;</div>
<div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;    <span class="comment">// if Uicent and Ufcent are both from pi and pf at CENT, then B1,B2,B3 entries are agreeably located even for FLUXB==FLUXCTSTAG</span></div>
<div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;</div>
<div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;    <span class="comment">// Get deltaUavg[] and also modify ucons if required and should</span></div>
<div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;    diag_fixup_dUandaccount(Uicent, Ufcent, ucons, ptrgeom, finalstep, whocalled, docorrectuconslocal);</div>
<div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;</div>
<div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;</div>
<div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;    <span class="keywordflow">if</span>(uconsinput!=NULL &amp;&amp; docorrectuconslocal){</div>
<div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;      </div>
<div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;      <span class="comment">// copy over ucons result in case changed.</span></div>
<div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;        <span class="comment">// if staggered field, avoid modifying field since at FACEs, not CENT where pr lives.</span></div>
<div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;        <span class="keywordflow">if</span>(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a56c640597356b6f642dd6ee1afb87e74">BPL</a>(pl)==0 &amp;&amp; <a class="code" href="../../d8/d5b/defs_8general_8h.html#a11c4e99e1493d0c1914ad1ab313ea472">FLUXB</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0b6762cef74e396f50a83864bb53fb6c">FLUXCTSTAG</a> || <a class="code" href="../../d8/d5b/defs_8general_8h.html#a11c4e99e1493d0c1914ad1ab313ea472">FLUXB</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a5014e44c6e710d8827ef79dd18abe6ad">FLUXCTTOTH</a>){</div>
<div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;          uconsinput[pl] = ucons[pl];</div>
<div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;        }</div>
<div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;      }</div>
<div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;    }</div>
<div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;</div>
<div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;</div>
<div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;  }<span class="comment">// end if finalstep&gt;0</span></div>
<div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;</div>
<div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;</div>
<div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;</div>
<div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;}</div>
<div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;</div>
<div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;</div>
<div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;</div>
<div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;<span class="keywordtype">int</span> diag_fixup_Ui_pf(<span class="keywordtype">int</span> docorrectucons, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Uievolve, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pf, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <span class="keywordtype">int</span> finalstep, <span class="keywordtype">int</span> whocalled, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Uf)</div>
<div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;{</div>
<div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> q;</div>
<div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Ufcent[NPR],Uicent[NPR],uconsinput[NPR],ucons[NPR];</div>
<div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;  <span class="keywordtype">int</span> failreturn;</div>
<div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;  <span class="keywordtype">int</span> pliter,pl,enerregion;</div>
<div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;  <span class="keywordtype">void</span> UtoU(<span class="keywordtype">int</span> inputtype, <span class="keywordtype">int</span> returntype,<span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom,<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Uin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Uout);</div>
<div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;  <span class="keywordtype">int</span> docorrectuconslocal;</div>
<div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;</div>
<div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;</div>
<div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;</div>
<div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;</div>
<div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;</div>
<div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;  <span class="comment">// count whocalled diag_fixup()</span></div>
<div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;  <a class="code" href="../../de/d95/fixup_8c.html#a43fb15d762b67f635ac6c63a158bf558" title="record who called the diag_fixup routine">count_whocalled</a>(ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k, finalstep, whocalled,1);</div>
<div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;</div>
<div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;</div>
<div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;  <span class="keywordflow">if</span>(finalstep &gt; 0){</div>
<div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;</div>
<div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;    <span class="comment">// determine if within correctable region</span></div>
<div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;    docorrectuconslocal=diag_fixup_correctablecheck(docorrectucons,ptrgeom);</div>
<div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;</div>
<div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;</div>
<div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;</div>
<div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;    <span class="comment">// Get ucons</span></div>
<div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;    <span class="comment">// GODMARK: NOENOFLUX==0 not accounted for (have to change unewglobal or something like that)</span></div>
<div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) ucons[pl]=Uievolve[pl];</div>
<div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;</div>
<div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;</div>
<div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;    <span class="comment">// Get Ufcent(pf[cent])</span></div>
<div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;    failreturn=<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a11e17cd8b0594d1ad52e3594aa9f477e" title="find ucon, ucov, bcon, bcov from primitive variables when calling get_state, users of this function e...">get_state</a>(pf,ptrgeom,&amp;q);</div>
<div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;    if(failreturn&gt;=1) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,&quot;<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a11e17cd8b0594d1ad52e3594aa9f477e" title="find ucon, ucov, bcon, bcov from primitive variables when calling get_state, users of this function e...">get_state</a>(2) <a class="code" href="../../d8/d5b/defs_8general_8h.html#ad4ec5aab9b62fbbe9b8fc2d8ac0a5989">failed</a> in fixup.c, why???\n&quot;);</div>
<div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;    failreturn=<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a9a54096e4c40a15a2c1bf74266153616" title="calculate &quot;conserved&quot; quantities">primtoU</a>(UDIAG,pf,&amp;q,ptrgeom,Ufcent, NULL);</div>
<div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;    if(failreturn&gt;=1) dualfprintf(fail_file,&quot;<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a9a54096e4c40a15a2c1bf74266153616" title="calculate &quot;conserved&quot; quantities">primtoU</a>(2) <a class="code" href="../../d8/d5b/defs_8general_8h.html#ad4ec5aab9b62fbbe9b8fc2d8ac0a5989">failed</a> in fixup.c, why???\n&quot;);</div>
<div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;</div>
<div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;    if(Uf!=NULL) <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) Uf[pl]=Ufcent[pl];<span class="comment">// store result for returning before gets modified</span></div>
<div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;</div>
<div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;    <span class="comment">// Get Uicent</span></div>
<div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;<span class="comment"></span>    </div>
<div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;    <span class="comment">// UEVOLVE -&gt; UDIAG</span></div>
<div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;    <span class="comment">// Assumes that Uievolve is like unewglobal and is at general U[] position (i.e. U[B1..B3] staggered and otherwise centered for FLUXB==FLUXCTSTAG)</span></div>
<div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;    UtoU(UEVOLVE,UDIAG,ptrgeom,Uievolve,Uicent);</div>
<div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;</div>
<div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;    <span class="comment">// Override B1..B3 with correct centered versions (correct both for value and geometry)</span></div>
<div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;    <span class="comment">// ensure B^i is really at center even if FLUXB==FLUXCTSTAG (that would have Ui[B1..B3] at staggered)</span></div>
<div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;    <span class="comment">// Assumes, as very generally true, that U[B1..B3] never change and can never be adjusted.</span></div>
<div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a9afde1f1647e18e733406a1566b8b550">PLOOPBONLY</a>(pl) Uicent[pl]=Ufcent[pl];</div>
<div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;</div>
<div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;    <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflag,*lpflagrad;</div>
<div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;    lpflag=&amp;GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>);</div>
<div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;    lpflagrad=&amp;GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>);</div>
<div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;</div>
<div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;    <span class="comment">//    if((startpos[1]+ptrgeom-&gt;i==17) &amp;&amp; (startpos[2]+ptrgeom-&gt;j)==0){</span></div>
<div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;    <span class="comment">//      dualfprintf(fail_file,&quot;lpflag=%d lpflagrad=%d\n&quot;,*lpflag,*lpflagrad);</span></div>
<div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;    <span class="comment">//    }</span></div>
<div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;</div>
<div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;    if(*lpflag&gt;<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#abdf9e55b7b15ec0bcd386055f1787f47">UTOPRIMNOFAIL</a>){</div>
<div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;      <span class="comment">// then assume fixup_utoprim() needs to operate and will also handle accounting</span></div>
<div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) if(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a385beb27e1712b12184404ccdceb9fbe">RADPL</a>(pl)==0) Ufcent[pl] = Uicent[pl];</div>
<div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;    }</div>
<div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;    if(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a781d24b3e646f7f4597b0b7004507a63">IFUTOPRIMRADFAIL</a>(*lpflagrad)){</div>
<div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;      <span class="comment">// then assume fixup_utoprim() needs to operate and will also handle accounting</span></div>
<div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) if(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a385beb27e1712b12184404ccdceb9fbe">RADPL</a>(pl)==1) Ufcent[pl] = Uicent[pl];</div>
<div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;    }</div>
<div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;</div>
<div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;</div>
<div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;</div>
<div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;    <span class="comment">// Get deltaUavg[] and also modify ucons if required and should</span></div>
<div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;<span class="comment"></span>    diag_fixup_dUandaccount(Uicent, Ufcent, ucons, ptrgeom, finalstep, whocalled, docorrectuconslocal);</div>
<div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;</div>
<div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;</div>
<div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;    if(docorrectuconslocal){</div>
<div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;      <span class="comment">// copy over ucons result in case changed.</span></div>
<div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;        <span class="comment">// if staggered field, avoid modifying field since at FACEs, not CENT where pr lives.</span></div>
<div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;        <span class="keywordflow">if</span>(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a56c640597356b6f642dd6ee1afb87e74">BPL</a>(pl)==0 &amp;&amp; <a class="code" href="../../d8/d5b/defs_8general_8h.html#a11c4e99e1493d0c1914ad1ab313ea472">FLUXB</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0b6762cef74e396f50a83864bb53fb6c">FLUXCTSTAG</a> || <a class="code" href="../../d8/d5b/defs_8general_8h.html#a11c4e99e1493d0c1914ad1ab313ea472">FLUXB</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a5014e44c6e710d8827ef79dd18abe6ad">FLUXCTTOTH</a>){</div>
<div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;          uconsinput[pl] = ucons[pl];</div>
<div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;        }</div>
<div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;      }</div>
<div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;    }</div>
<div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;</div>
<div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;</div>
<div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;  }<span class="comment">// end if finalstep&gt;0</span></div>
<div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;</div>
<div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;</div>
<div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;</div>
<div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;}</div>
<div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;</div>
<div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;</div>
<div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;</div>
<div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;</div>
<div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;<span class="keywordtype">int</span> diag_fixup_U(<span class="keywordtype">int</span> docorrectucons, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ui, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Uf, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *uconsinput, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <span class="keywordtype">int</span> finalstep,<span class="keywordtype">int</span> whocalled)</div>
<div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;{</div>
<div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Uicent[NPR],Ufcent[NPR];</div>
<div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> q;</div>
<div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;  <span class="keywordtype">int</span> failreturn;</div>
<div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;  <span class="keywordtype">int</span> pliter,pl,enerregion, tscale;</div>
<div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;  <span class="keywordtype">void</span> UtoU(<span class="keywordtype">int</span> inputtype, <span class="keywordtype">int</span> returntype,<span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom,<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Uin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Uout);</div>
<div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;  <span class="keywordtype">int</span> docorrectuconslocal;</div>
<div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;</div>
<div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;</div>
<div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;  <span class="comment">// store ucons and only change if needed (and handle avoidance of B1,B2,B3 in case ucons points to unewglobal staggered field, while here we operate on centers)</span></div>
<div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ucons[NPR];</div>
<div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;  <span class="keywordflow">if</span>(uconsinput!=NULL){</div>
<div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) ucons[pl]=uconsinput[pl];</div>
<div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;  }</div>
<div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;</div>
<div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;  <span class="comment">// count whocalled diag_fixup()</span></div>
<div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;  <a class="code" href="../../de/d95/fixup_8c.html#a43fb15d762b67f635ac6c63a158bf558" title="record who called the diag_fixup routine">count_whocalled</a>(ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k, finalstep, whocalled,1);</div>
<div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;  </div>
<div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;</div>
<div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;</div>
<div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;  if(finalstep&gt;0){ <span class="comment">// only account if on full timestep (assume only called if finalstep==1</span></div>
<div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;</div>
<div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;</div>
<div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;    <span class="comment">// determine if within correctable region</span></div>
<div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;<span class="comment"></span>    docorrectuconslocal=diag_fixup_correctablecheck(docorrectucons,ptrgeom);</div>
<div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;</div>
<div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;</div>
<div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;    <span class="comment">// First get correction (don&#39;t do inside enerregion loop since would be overly expensive and assume will need correction for at least one enerregion)</span></div>
<div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;    <span class="comment">// Change ucons (GODMARK: assumes Uf at CENT since uses single ptrgeom -- even though ucons is normally capable of being staggered for B1..B3)</span></div>
<div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;<span class="comment"></span>    <span class="keywordflow">if</span>(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a55732148d2616d6d1f5d2abbe8710850">DOENOFLUX</a> != <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#adacaaf8526353cfe870206f0cf4d2ca7" title="for DOENOFLUX: 0: no ENO flux reconstruction 1: reconstruct F for finite difference rep...">NOENOFLUX</a>){ <span class="comment">// JONMARK</span></div>
<div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;      <span class="comment">// notice that geometry comes after subtractions/additions of EOMs</span></div>
<div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;      UtoU(UDIAG,UEVOLVE,ptrgeom,Uf,ucons); <span class="comment">// convert from UDIAG-&gt;UEVOLVE </span></div>
<div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;    }</div>
<div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;</div>
<div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;</div>
<div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;    <span class="comment">// get Uicent and Ufcent</span></div>
<div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;    <span class="comment">// Assumes that Ui is like unewglobal and is at general U[] position (i.e. U[B1..B3] staggered and otherwise centered for FLUXB==FLUXCTSTAG)</span></div>
<div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;      Uicent[pl]=Ui[pl];</div>
<div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;      Ufcent[pl]=Uf[pl];</div>
<div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;    }</div>
<div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;</div>
<div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;    <span class="comment">// ensure B^i is really at center even if FLUXB==FLUXCTSTAG (that would have Ui[B1..B3] at staggered)</span></div>
<div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;    <span class="comment">// Assumes, as very generally true, that U[B1..B3] never change and can never be adjusted.</span></div>
<div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a9afde1f1647e18e733406a1566b8b550">PLOOPBONLY</a>(pl) Uicent[pl]=Ufcent[pl];</div>
<div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;</div>
<div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;</div>
<div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;    <span class="comment">// Get deltaUavg[] and also modify ucons if required and should</span></div>
<div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;    diag_fixup_dUandaccount(Uicent, Ufcent, ucons, ptrgeom, finalstep, whocalled, docorrectuconslocal);</div>
<div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;</div>
<div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;    if(uconsinput!=NULL &amp;&amp; docorrectuconslocal){</div>
<div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;      <span class="comment">// copy over ucons result in case changed.</span></div>
<div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;        <span class="comment">// if staggered field, avoid modifying field since at FACEs, not CENT where pr lives.</span></div>
<div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;        <span class="keywordflow">if</span>(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a56c640597356b6f642dd6ee1afb87e74">BPL</a>(pl)==0 &amp;&amp; <a class="code" href="../../d8/d5b/defs_8general_8h.html#a11c4e99e1493d0c1914ad1ab313ea472">FLUXB</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0b6762cef74e396f50a83864bb53fb6c">FLUXCTSTAG</a> || <a class="code" href="../../d8/d5b/defs_8general_8h.html#a11c4e99e1493d0c1914ad1ab313ea472">FLUXB</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a5014e44c6e710d8827ef79dd18abe6ad">FLUXCTTOTH</a>){</div>
<div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;          uconsinput[pl] = ucons[pl];</div>
<div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;        }</div>
<div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;      }</div>
<div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;    }</div>
<div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;</div>
<div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;</div>
<div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;  }</div>
<div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;</div>
<div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;</div>
<div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;</div>
<div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;</div>
<div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;}</div>
<div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;</div>
<div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;</div>
<div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;</div>
<div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;</div>
<div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;<span class="preprocessor">#if(VARTOINTERP==PRIMTOINTERP_GDETFULLVERSION_WALD)</span></div>
<div class="line"><a name="l01067"></a><span class="lineno"><a class="code" href="../../de/d95/fixup_8c.html#a7aaec1dfe849c661be660bb8d1869585"> 1067</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define FIXUPTYPE 0 // or else would create spurious Poynting flux</span></div>
<div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#else</span></div>
<div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define FIXUPTYPE 0 // too expensive if inversion fails alot as can happen near floors, near poles, or with radiation.</span></div>
<div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;</div>
<div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;</div>
<div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;</div>
<div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;</div>
<div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;<span class="keywordtype">int</span> fixup1zone(<span class="keywordtype">int</span> docorrectucons, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *uconsinput, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <span class="keywordtype">int</span> finalstep)</div>
<div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;{</div>
<div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;  <span class="keywordtype">int</span> pliter,pl;</div>
<div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;  <span class="keywordtype">int</span> ip, jp, im, jm;</div>
<div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> <a class="code" href="../../d1/d83/structof__state.html#a2b38c522ec7321af3368706fa4632834">bsq</a>, del;</div>
<div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> r, th, <a class="code" href="../../dc/dd2/newcodediff_8txt.html#a933233ff9879962bcc2ff987c6920f90">X</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ftempA,ftempB;</div>
<div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> q;</div>
<div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> dq;</div>
<div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> prfloor[NPR],prceiling[NPR];</div>
<div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> prdiag[NPR];</div>
<div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> pr0[NPR];</div>
<div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> prmhdnew[NPR];</div>
<div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> U[NPR],U0[NPR];</div>
<div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;  <span class="keywordtype">int</span> checkfl[NPR];</div>
<div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;  <span class="keywordtype">int</span> failreturn;</div>
<div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;  <span class="keywordtype">int</span> didchangeprim;</div>
<div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> scalemin[NPR];</div>
<div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;  <span class="comment">//  FTYPE ucovzamo[NDIM];</span></div>
<div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;  <span class="comment">//  FTYPE uconzamo[NDIM];</span></div>
<div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dprmhd[NPR];</div>
<div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> prmhd[NPR];</div>
<div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dU[NPR];</div>
<div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;  <span class="comment">//  FTYPE P,Pnew;</span></div>
<div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;  <span class="keywordtype">int</span> jj;</div>
<div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;  <span class="keywordtype">int</span> badinversion;</div>
<div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;  <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> oldmhdpflag,oldradpflag;</div>
<div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;</div>
<div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;</div>
<div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;</div>
<div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;  <span class="comment">// store ucons and only change if needed (and handle avoidance of B1,B2,B3 in case ucons points to unewglobal staggered field, while here we operate on centers)</span></div>
<div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ucons[NPR];</div>
<div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;  <span class="keywordflow">if</span>(uconsinput!=NULL){</div>
<div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) ucons[pl]=uconsinput[pl];</div>
<div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160;  }</div>
<div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160;</div>
<div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;</div>
<div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160;  <span class="comment">// assign general floor variables</span></div>
<div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160;  <span class="comment">// whether to check floor condition</span></div>
<div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl){</div>
<div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160;    checkfl[pl]=0;</div>
<div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;    pr0[pl]=pr[pl];</div>
<div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160;    prmhd[pl]=pr0[pl];</div>
<div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;    prdiag[pl]=pr0[pl];</div>
<div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;  }</div>
<div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;</div>
<div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;  <span class="comment">// shouldn&#39;t fail since before and after states should be ok, as</span></div>
<div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160;  <span class="comment">// long as would have changed the value.  Check will occur if</span></div>
<div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;  <span class="comment">// simulation continues ok.  Could place check inside if below.</span></div>
<div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;  didchangeprim=0;</div>
<div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160;</div>
<div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;</div>
<div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;</div>
<div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160;  <span class="comment">// Set which quantities to check</span></div>
<div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;<span class="comment"></span>  <span class="keywordflow">if</span>(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a71b7c970651a395e2500645e74862abc">DOEVOLVERHO</a>){</div>
<div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160;    checkfl[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>]=1;</div>
<div class="line"><a name="l01136"></a><span class="lineno"> 1136</span>&#160;  }</div>
<div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#abc7fe8413995280e1b65fa54885bf547">DOEVOLVEUU</a>){</div>
<div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160;    checkfl[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]=1;</div>
<div class="line"><a name="l01139"></a><span class="lineno"> 1139</span>&#160;  }</div>
<div class="line"><a name="l01140"></a><span class="lineno"> 1140</span>&#160;  <span class="comment">// KORALTODO: Keep as mhd only for now.</span></div>
<div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160;  <span class="keywordtype">int</span> DOEVOLVEURAD0=PRAD0&gt;=0 &amp;&amp; <a class="code" href="../../da/d3e/definit_8h.html#a99ba7daf58b283bc831b8f507f5873a4" title="#define EOMTYPE EOMCOLDGRMHD">EOMRADTYPE</a>!=<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a993e29ef4139116d822d89bccb92180d" title="radiation equations of motion">EOMRADNONE</a>;</div>
<div class="line"><a name="l01142"></a><span class="lineno"> 1142</span>&#160;  <span class="keywordflow">if</span>(DOEVOLVEURAD0) checkfl[PRAD0]=1;</div>
<div class="line"><a name="l01143"></a><span class="lineno"> 1143</span>&#160;</div>
<div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160;</div>
<div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01147"></a><span class="lineno"> 1147</span>&#160;  <span class="comment">// limit gamma wrt normal observer -- this can change b^2, so do this first.</span></div>
<div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01150"></a><span class="lineno"> 1150</span>&#160;<span class="comment"></span><span class="preprocessor">#if(WHICHVEL==VELREL4)</span></div>
<div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160;<span class="preprocessor"></span>  <span class="comment">//  int docorrectucons=(DOENOFLUX != NOENOFLUX);</span></div>
<div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160;  <span class="comment">//  didchangeprim=0;</span></div>
<div class="line"><a name="l01153"></a><span class="lineno"> 1153</span>&#160;</div>
<div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;  <span class="comment">//  if((startpos[1]+ptrgeom-&gt;i==17) &amp;&amp; (startpos[2]+ptrgeom-&gt;j)==0){</span></div>
<div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160;  <span class="comment">//    dualfprintf(fail_file,&quot;BEFORE IN FIXUP1ZONE LIMITGAMMA: finalstep=%d\n&quot;,finalstep);</span></div>
<div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160;  <span class="comment">//  }</span></div>
<div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160;  failreturn=limit_gamma(docorrectucons,<a class="code" href="../../d8/d5b/defs_8general_8h.html#accef7ff74daca804b9a5a3ad7d3db882">GAMMAMAX</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a51ef12e4cafc4a8fe70374c37f57d565">GAMMAMAXRAD</a>,prmhd,ucons,ptrgeom,-1);</div>
<div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160;  <span class="keywordflow">if</span>(failreturn&gt;=1) <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a5febb92786c5f7a1479e7e65f1c23ef3">FAILSTATEMENT</a>(<span class="stringliteral">&quot;fixup.c:fixup()&quot;</span>, <span class="stringliteral">&quot;limit_gamma()&quot;</span>, 1);</div>
<div class="line"><a name="l01159"></a><span class="lineno"> 1159</span>&#160;  <span class="keywordflow">if</span>(failreturn==-1) didchangeprim=1;</div>
<div class="line"><a name="l01160"></a><span class="lineno"> 1160</span>&#160;  <span class="comment">//  PALLLOOP(pl) prdiag[pl]=prmhd[pl];</span></div>
<div class="line"><a name="l01161"></a><span class="lineno"> 1161</span>&#160;  <span class="comment">//  if((startpos[1]+ptrgeom-&gt;i==17) &amp;&amp; (startpos[2]+ptrgeom-&gt;j)==0){</span></div>
<div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160;  <span class="comment">//    dualfprintf(fail_file,&quot;AFTER IN FIXUP1ZONE LIMITGAMMA: didchangeprim=%d\n&quot;,didchangeprim);</span></div>
<div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;  <span class="comment">//  }</span></div>
<div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160;</div>
<div class="line"><a name="l01165"></a><span class="lineno"> 1165</span>&#160;  <span class="comment">//  if(didchangeprim&amp;&amp;FLOORDIAGS){// FLOORDIAGS includes fail diags</span></div>
<div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160;  <span class="comment">//    int doingmhdfixup=1;</span></div>
<div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;  <span class="comment">//    diag_fixup(docorrectucons,prdiag, prmhd, ucons, ptrgeom, finalstep,doingmhdfixup,COUNTLIMITGAMMAACT);</span></div>
<div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160;  <span class="comment">//    PALLLOOP(pl) prdiag[pl]=prmhd[pl];</span></div>
<div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160;  <span class="comment">//  }</span></div>
<div class="line"><a name="l01170"></a><span class="lineno"> 1170</span>&#160;</div>
<div class="line"><a name="l01171"></a><span class="lineno"> 1171</span>&#160;<span class="preprocessor">#endif// end if WHICHVEL==VEL4REL</span></div>
<div class="line"><a name="l01172"></a><span class="lineno"> 1172</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01173"></a><span class="lineno"> 1173</span>&#160;</div>
<div class="line"><a name="l01174"></a><span class="lineno"> 1174</span>&#160;    </div>
<div class="line"><a name="l01176"></a><span class="lineno"> 1176</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01177"></a><span class="lineno"> 1177</span>&#160;  <span class="comment">// Only apply floor if cold or hot GRMHD</span></div>
<div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160;<span class="comment"></span>  <span class="keywordflow">if</span>(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a71b7c970651a395e2500645e74862abc">DOEVOLVERHO</a>||<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#abc7fe8413995280e1b65fa54885bf547">DOEVOLVEUU</a>||DOEVOLVEURAD0){</div>
<div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160;</div>
<div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160;</div>
<div class="line"><a name="l01184"></a><span class="lineno"> 1184</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160;    <span class="comment">// get floor value (computes, e.g., bsq)</span></div>
<div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01188"></a><span class="lineno"> 1188</span>&#160;<span class="comment"></span>    set_density_floors(ptrgeom,prmhd,prfloor,prceiling);</div>
<div class="line"><a name="l01189"></a><span class="lineno"> 1189</span>&#160;    scalemin[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>]=<a class="code" href="../../d8/d5b/defs_8general_8h.html#aaf25d08a41cff499b5e3d448ad7f76f7">RHOMINLIMIT</a>;</div>
<div class="line"><a name="l01190"></a><span class="lineno"> 1190</span>&#160;    scalemin[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a13f615d7832e3abc6abd54325112daf3">UUMINLIMIT</a>;</div>
<div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;    <span class="keywordflow">if</span>(URAD0&gt;=0) scalemin[URAD0]=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a5bd9da451f108352614cbc457524c5b0">ERADLIMIT</a>;</div>
<div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160;    </div>
<div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;    </div>
<div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160;</div>
<div class="line"><a name="l01196"></a><span class="lineno"> 1196</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01197"></a><span class="lineno"> 1197</span>&#160;    <span class="comment">// Set super low floor</span></div>
<div class="line"><a name="l01198"></a><span class="lineno"> 1198</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160;<span class="comment"></span>    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl){</div>
<div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160;      <span class="keywordflow">if</span>(checkfl[pl]){</div>
<div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160;        <span class="keywordflow">if</span>(prfloor[pl]&lt;scalemin[pl]) prfloor[pl]=scalemin[pl];</div>
<div class="line"><a name="l01203"></a><span class="lineno"> 1203</span>&#160;      }</div>
<div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;    }</div>
<div class="line"><a name="l01205"></a><span class="lineno"> 1205</span>&#160;    </div>
<div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;</div>
<div class="line"><a name="l01208"></a><span class="lineno"> 1208</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01209"></a><span class="lineno"> 1209</span>&#160;    <span class="comment">// Get new primitive if went beyond floor</span></div>
<div class="line"><a name="l01210"></a><span class="lineno"> 1210</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01212"></a><span class="lineno"> 1212</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01214"></a><span class="lineno"> 1214</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl){</div>
<div class="line"><a name="l01215"></a><span class="lineno"> 1215</span>&#160;      prmhdnew[pl]=prmhd[pl];</div>
<div class="line"><a name="l01216"></a><span class="lineno"> 1216</span>&#160;    }</div>
<div class="line"><a name="l01217"></a><span class="lineno"> 1217</span>&#160;</div>
<div class="line"><a name="l01218"></a><span class="lineno"> 1218</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl){</div>
<div class="line"><a name="l01219"></a><span class="lineno"> 1219</span>&#160;      <span class="keywordflow">if</span> ( checkfl[pl]&amp;&amp;(prmhd[pl] &lt; prfloor[pl] &amp;&amp; prmhd[pl]&lt;prceiling[pl]) ){</div>
<div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160;        didchangeprim=1;</div>
<div class="line"><a name="l01221"></a><span class="lineno"> 1221</span>&#160;        <span class="comment">//dualfprintf(fail_file,&quot;%d : %d %d %d : %d : %d : %21.15g - %21.15g\n&quot;,pl,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,ptrgeom-&gt;p,checkfl[pl],prfloor[pl],prmhd[pl]); </span></div>
<div class="line"><a name="l01222"></a><span class="lineno"> 1222</span>&#160;        <span class="comment">// only add on full step since middle step is not really updating primitive variables</span></div>
<div class="line"><a name="l01223"></a><span class="lineno"> 1223</span>&#160;        prmhdnew[pl]=prfloor[pl];</div>
<div class="line"><a name="l01224"></a><span class="lineno"> 1224</span>&#160;      }</div>
<div class="line"><a name="l01225"></a><span class="lineno"> 1225</span>&#160;    }</div>
<div class="line"><a name="l01226"></a><span class="lineno"> 1226</span>&#160;</div>
<div class="line"><a name="l01227"></a><span class="lineno"> 1227</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl){</div>
<div class="line"><a name="l01228"></a><span class="lineno"> 1228</span>&#160;      <span class="keywordflow">if</span> ( checkfl[pl]&amp;&amp;(prmhd[pl] &gt; prfloor[pl] &amp;&amp; prmhd[pl]&gt;prceiling[pl]) ){</div>
<div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160;        didchangeprim=1;</div>
<div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160;        <span class="comment">//dualfprintf(fail_file,&quot;%d : %d %d %d : %d : %d : %21.15g - %21.15g\n&quot;,pl,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,ptrgeom-&gt;p,checkfl[pl],prfloor[pl],prmhd[pl]); </span></div>
<div class="line"><a name="l01231"></a><span class="lineno"> 1231</span>&#160;        <span class="comment">// only add on full step since middle step is not really updating primitive variables</span></div>
<div class="line"><a name="l01232"></a><span class="lineno"> 1232</span>&#160;        prmhdnew[pl]=prceiling[pl];</div>
<div class="line"><a name="l01233"></a><span class="lineno"> 1233</span>&#160;      }</div>
<div class="line"><a name="l01234"></a><span class="lineno"> 1234</span>&#160;    }</div>
<div class="line"><a name="l01235"></a><span class="lineno"> 1235</span>&#160;</div>
<div class="line"><a name="l01236"></a><span class="lineno"> 1236</span>&#160;</div>
<div class="line"><a name="l01237"></a><span class="lineno"> 1237</span>&#160;</div>
<div class="line"><a name="l01238"></a><span class="lineno"> 1238</span>&#160;</div>
<div class="line"><a name="l01240"></a><span class="lineno"> 1240</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01241"></a><span class="lineno"> 1241</span>&#160;    <span class="comment">// ONLY do something if want lower than floor</span></div>
<div class="line"><a name="l01242"></a><span class="lineno"> 1242</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01244"></a><span class="lineno"> 1244</span>&#160;<span class="comment"></span>    <span class="keywordflow">if</span>(didchangeprim){</div>
<div class="line"><a name="l01245"></a><span class="lineno"> 1245</span>&#160;</div>
<div class="line"><a name="l01246"></a><span class="lineno"> 1246</span>&#160;<span class="preprocessor">#if(FIXUPTYPE==0)</span></div>
<div class="line"><a name="l01247"></a><span class="lineno"> 1247</span>&#160;<span class="preprocessor"></span>      <span class="comment">// effectively adds mass/internal energy in comoving frame, which can lead to instabilities as momentum is added</span></div>
<div class="line"><a name="l01248"></a><span class="lineno"> 1248</span>&#160;      <span class="comment">// For example, occurs on poles where u^r\sim 0 (stagnation surface) which launches artificially high u^t stuff only because goes below floor for a range of radii and so adds momentum to low density material</span></div>
<div class="line"><a name="l01249"></a><span class="lineno"> 1249</span>&#160;      <span class="comment">// </span></div>
<div class="line"><a name="l01250"></a><span class="lineno"> 1250</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl){</div>
<div class="line"><a name="l01251"></a><span class="lineno"> 1251</span>&#160;        prmhd[pl]=prmhdnew[pl];</div>
<div class="line"><a name="l01252"></a><span class="lineno"> 1252</span>&#160;      }</div>
<div class="line"><a name="l01253"></a><span class="lineno"> 1253</span>&#160;</div>
<div class="line"><a name="l01254"></a><span class="lineno"> 1254</span>&#160;</div>
<div class="line"><a name="l01255"></a><span class="lineno"> 1255</span>&#160;<span class="preprocessor">#elif(FIXUPTYPE==1 || FIXUPTYPE==2)</span></div>
<div class="line"><a name="l01256"></a><span class="lineno"> 1256</span>&#160;<span class="preprocessor"></span>      <span class="comment">// mass and internal energy added in frame not necessarily the comoving frame</span></div>
<div class="line"><a name="l01257"></a><span class="lineno"> 1257</span>&#160;      <span class="comment">// using a frame not directly associated with comoving frame avoids arbitrary energy-momentum  growth</span></div>
<div class="line"><a name="l01258"></a><span class="lineno"> 1258</span>&#160;      <span class="comment">// GODMARK: FIXUPTYPE==1 doesn&#39;t exactly match between when b^2/\rho_0&gt;BSQORHOULIMIT such that amount of mass added will force equality of b^2/\rho_0==BSQORHOLIMIT, so this may lead to problems.</span></div>
<div class="line"><a name="l01259"></a><span class="lineno"> 1259</span>&#160;      <span class="comment">// physically FIXUPTYPE==1 models some non-local transport of baryons and energy to a location that supposedly occurs when b^2/rho_0 is too large.</span></div>
<div class="line"><a name="l01260"></a><span class="lineno"> 1260</span>&#160;      <span class="comment">// FIXUPTYPE==2 models a local injection of baryons/energy with momentum conserved and energy-momentum conserved if mass injected.  Injection will slow flow.  Essentially there is an ad hoc conversion of kinetic/thermal energy into mass energy.</span></div>
<div class="line"><a name="l01261"></a><span class="lineno"> 1261</span>&#160;</div>
<div class="line"><a name="l01262"></a><span class="lineno"> 1262</span>&#160;      <span class="comment">// compute original conserved quantities</span></div>
<div class="line"><a name="l01263"></a><span class="lineno"> 1263</span>&#160;      failreturn=<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a11e17cd8b0594d1ad52e3594aa9f477e" title="find ucon, ucov, bcon, bcov from primitive variables when calling get_state, users of this function e...">get_state</a>(prmhd,ptrgeom,&amp;q);</div>
<div class="line"><a name="l01264"></a><span class="lineno"> 1264</span>&#160;      <span class="keywordflow">if</span>(failreturn&gt;=1) dualfprintf(fail_file,<span class="stringliteral">&quot;get_state(1) failed in fixup.c, why???\n&quot;</span>);</div>
<div class="line"><a name="l01265"></a><span class="lineno"> 1265</span>&#160;      failreturn=<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a9a54096e4c40a15a2c1bf74266153616" title="calculate &quot;conserved&quot; quantities">primtoU</a>(UNOTHING,prmhd,&amp;q,ptrgeom,U, NULL);</div>
<div class="line"><a name="l01266"></a><span class="lineno"> 1266</span>&#160;      <span class="keywordflow">if</span>(failreturn&gt;=1) dualfprintf(fail_file,<span class="stringliteral">&quot;primtoU(1) failed in fixup.c, why???\n&quot;</span>);</div>
<div class="line"><a name="l01267"></a><span class="lineno"> 1267</span>&#160;</div>
<div class="line"><a name="l01268"></a><span class="lineno"> 1268</span>&#160;      <span class="comment">// store original U</span></div>
<div class="line"><a name="l01269"></a><span class="lineno"> 1269</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) U0[pl]=U[pl];</div>
<div class="line"><a name="l01270"></a><span class="lineno"> 1270</span>&#160;</div>
<div class="line"><a name="l01271"></a><span class="lineno"> 1271</span>&#160;      <span class="comment">// get change in primitive quantities</span></div>
<div class="line"><a name="l01272"></a><span class="lineno"> 1272</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl) dprmhd[pl]=0.0; <span class="comment">// default</span></div>
<div class="line"><a name="l01273"></a><span class="lineno"> 1273</span>&#160;      <span class="comment">// use ZAMO velocity as velocity of inserted fluid</span></div>
<div class="line"><a name="l01274"></a><span class="lineno"> 1274</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl) <span class="keywordflow">if</span>(pl==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a> || pl==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a> || pl==URAD0){ dprmhd[pl]=prmhdnew[pl]-prmhd[pl];}</div>
<div class="line"><a name="l01275"></a><span class="lineno"> 1275</span>&#160;      set_zamo_velocity(<a class="code" href="../../da/d3e/definit_8h.html#a3d14480f30d39eff4e51ae8bc93df56f" title="whether we use ultimately precise inversion or &quot;workable&quot; inversion precision (see utoprim&#39;s for ho...">WHICHVEL</a>,ptrgeom,dprmhd);</div>
<div class="line"><a name="l01276"></a><span class="lineno"> 1276</span>&#160;</div>
<div class="line"><a name="l01277"></a><span class="lineno"> 1277</span>&#160;      <span class="comment">// get change in conserved quantities</span></div>
<div class="line"><a name="l01278"></a><span class="lineno"> 1278</span>&#160;      failreturn=<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a11e17cd8b0594d1ad52e3594aa9f477e" title="find ucon, ucov, bcon, bcov from primitive variables when calling get_state, users of this function e...">get_state</a>(dprmhd,ptrgeom,&amp;dq);</div>
<div class="line"><a name="l01279"></a><span class="lineno"> 1279</span>&#160;      failreturn=<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a9a54096e4c40a15a2c1bf74266153616" title="calculate &quot;conserved&quot; quantities">primtoU</a>(UNOTHING,dprmhd,&amp;dq,ptrgeom,dU, NULL);</div>
<div class="line"><a name="l01280"></a><span class="lineno"> 1280</span>&#160;      <span class="keywordflow">if</span>(failreturn&gt;=1) dualfprintf(fail_file,<span class="stringliteral">&quot;primtoU(2) failed in fixup.c, why???\n&quot;</span>);</div>
<div class="line"><a name="l01281"></a><span class="lineno"> 1281</span>&#160;</div>
<div class="line"><a name="l01282"></a><span class="lineno"> 1282</span>&#160;</div>
<div class="line"><a name="l01283"></a><span class="lineno"> 1283</span>&#160;      <span class="keywordflow">if</span>(<a class="code" href="../../de/d95/fixup_8c.html#a7aaec1dfe849c661be660bb8d1869585">FIXUPTYPE</a>==1){</div>
<div class="line"><a name="l01284"></a><span class="lineno"> 1284</span>&#160;        <span class="comment">// then done, dU is right</span></div>
<div class="line"><a name="l01285"></a><span class="lineno"> 1285</span>&#160;      }</div>
<div class="line"><a name="l01286"></a><span class="lineno"> 1286</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../de/d95/fixup_8c.html#a7aaec1dfe849c661be660bb8d1869585">FIXUPTYPE</a>==2){</div>
<div class="line"><a name="l01287"></a><span class="lineno"> 1287</span>&#160;        <span class="comment">// then don&#39;t allow momentum to change regardless of meaning for implied rho,u</span></div>
<div class="line"><a name="l01288"></a><span class="lineno"> 1288</span>&#160;        dU[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>]=dU[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae907e773ef038f3fc0c2ad5de0cb0f07">U2</a>]=dU[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8de9104f1fffa59f057b214d74c5cfea">U3</a>]=0.0;</div>
<div class="line"><a name="l01289"></a><span class="lineno"> 1289</span>&#160;        <span class="keywordflow">if</span>(URAD0&gt;=0) dU[URAD0]=dU[URAD1]=dU[URAD2]=dU[URAD3]=0.0;</div>
<div class="line"><a name="l01290"></a><span class="lineno"> 1290</span>&#160;</div>
<div class="line"><a name="l01291"></a><span class="lineno"> 1291</span>&#160;        pl=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>;</div>
<div class="line"><a name="l01292"></a><span class="lineno"> 1292</span>&#160;        <span class="keywordflow">if</span> ( checkfl[pl]&amp;&amp;(prfloor[pl] &gt; prmhd[pl] || prceiling[pl] &lt; prmhd[pl]) ){</div>
<div class="line"><a name="l01293"></a><span class="lineno"> 1293</span>&#160;          <span class="comment">// then must change dU[UU]</span></div>
<div class="line"><a name="l01294"></a><span class="lineno"> 1294</span>&#160;        }</div>
<div class="line"><a name="l01295"></a><span class="lineno"> 1295</span>&#160;        <span class="keywordflow">else</span> dU[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]=0.0; <span class="comment">// if only mass added, then no change needed to energy-momentum</span></div>
<div class="line"><a name="l01296"></a><span class="lineno"> 1296</span>&#160;</div>
<div class="line"><a name="l01297"></a><span class="lineno"> 1297</span>&#160;</div>
<div class="line"><a name="l01298"></a><span class="lineno"> 1298</span>&#160;      }</div>
<div class="line"><a name="l01299"></a><span class="lineno"> 1299</span>&#160;</div>
<div class="line"><a name="l01300"></a><span class="lineno"> 1300</span>&#160;      <span class="comment">// get final new conserved quantity</span></div>
<div class="line"><a name="l01301"></a><span class="lineno"> 1301</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl) U[pl]+=dU[pl];</div>
<div class="line"><a name="l01302"></a><span class="lineno"> 1302</span>&#160;      <span class="comment">// except, if fixed-up u_g or rho because &lt;0, then just set entropy.</span></div>
<div class="line"><a name="l01303"></a><span class="lineno"> 1303</span>&#160;      <span class="comment">// If u_g&gt;0 and rho&gt;0, then assume entropy adjustment also ok.</span></div>
<div class="line"><a name="l01304"></a><span class="lineno"> 1304</span>&#160;      <span class="comment">//      if((prmhd[UU]&lt;=0.0 || prmhd[RHO]&lt;=0.0) &amp;&amp; ENTROPY&gt;0) U[ENTROPY] = U0[ENTROPY];</span></div>
<div class="line"><a name="l01305"></a><span class="lineno"> 1305</span>&#160;      <span class="comment">// assume this adjustment is energy-only based.</span></div>
<div class="line"><a name="l01306"></a><span class="lineno"> 1306</span>&#160;      <span class="comment">// must do this because otherwise if u_g&lt;0 or rho&lt;0, then entropy is ill-defined, and here assume floor always activated related to too small u_g or rho so that entropy would be badly defined or ill-defined.</span></div>
<div class="line"><a name="l01307"></a><span class="lineno"> 1307</span>&#160;      <span class="keywordflow">if</span>(ENTROPY&gt;=0) U[ENTROPY] = U0[ENTROPY];</div>
<div class="line"><a name="l01308"></a><span class="lineno"> 1308</span>&#160;</div>
<div class="line"><a name="l01309"></a><span class="lineno"> 1309</span>&#160;</div>
<div class="line"><a name="l01310"></a><span class="lineno"> 1310</span>&#160;      <span class="comment">// pr finally changes here</span></div>
<div class="line"><a name="l01311"></a><span class="lineno"> 1311</span>&#160;      <span class="comment">// get primitive associated with new conserved quantities</span></div>
<div class="line"><a name="l01312"></a><span class="lineno"> 1312</span>&#160;      oldmhdpflag=GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,FLAGUTOPRIMFAIL);</div>
<div class="line"><a name="l01313"></a><span class="lineno"> 1313</span>&#160;      oldradpflag=GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,FLAGUTOPRIMRADFAIL);</div>
<div class="line"><a name="l01314"></a><span class="lineno"> 1314</span>&#160;</div>
<div class="line"><a name="l01315"></a><span class="lineno"> 1315</span>&#160;      <span class="keywordtype">int</span> showmessages=0; <span class="comment">// messages not important if fixup doens&#39;t work, unless debugging.</span></div>
<div class="line"><a name="l01316"></a><span class="lineno"> 1316</span>&#160;      <span class="keywordtype">int</span> allowlocalfailurefixandnoreport=1; </div>
<div class="line"><a name="l01317"></a><span class="lineno"> 1317</span>&#160;      <span class="keywordtype">int</span> eomtype=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aa28b06d889a02621b45edc716bfb2d01">EOMDEFAULT</a>;</div>
<div class="line"><a name="l01318"></a><span class="lineno"> 1318</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dissmeasure=-1.0; <span class="comment">// assume energy try ok</span></div>
<div class="line"><a name="l01319"></a><span class="lineno"> 1319</span>&#160;      <span class="keywordtype">int</span> whichcap=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a4b6c6060c025e15f1d92aae3dcb9365b" title="which cap type to place in rad inversion">CAPTYPEBASIC</a>;</div>
<div class="line"><a name="l01320"></a><span class="lineno"> 1320</span>&#160;      <span class="keywordtype">int</span> whichmethod=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a46b689a25732194a759b43d32ac1570c" title="mode for inversion">MODEDEFAULT</a>;</div>
<div class="line"><a name="l01321"></a><span class="lineno"> 1321</span>&#160;      <span class="keywordtype">int</span> modprim=0;</div>
<div class="line"><a name="l01322"></a><span class="lineno"> 1322</span>&#160;      <span class="keywordtype">int</span> checkoninversiongas=<a class="code" href="../../da/d3e/definit_8h.html#a5dc18e6d15e4420586d45d912fccebac" title="whether to check on inversion and report problem Also, use diag_fixup() to account for changes in U w...">CHECKONINVERSION</a>;</div>
<div class="line"><a name="l01323"></a><span class="lineno"> 1323</span>&#160;      <span class="keywordtype">int</span> checkoninversionrad=<a class="code" href="../../da/d3e/definit_8h.html#a70e4418eb8c6479afc202024b46ad581">CHECKONINVERSIONRAD</a>;</div>
<div class="line"><a name="l01324"></a><span class="lineno"> 1324</span>&#160;</div>
<div class="line"><a name="l01325"></a><span class="lineno"> 1325</span>&#160;      <span class="keyword">struct </span><a class="code" href="../../db/d3a/structof__newtonstats.html">of_newtonstats</a> newtonstats; setnewtonstatsdefault(&amp;newtonstats);</div>
<div class="line"><a name="l01326"></a><span class="lineno"> 1326</span>&#160;      <span class="keywordflow">if</span>(0){</div>
<div class="line"><a name="l01327"></a><span class="lineno"> 1327</span>&#160;        newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a073783ba864c07681c8999a67162202b">nstroke</a>=newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a83280998e47831044a7e35299495a9bb">lntries</a>=0;</div>
<div class="line"><a name="l01328"></a><span class="lineno"> 1328</span>&#160;      }</div>
<div class="line"><a name="l01329"></a><span class="lineno"> 1329</span>&#160;      <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l01331"></a><span class="lineno"> 1331</span>&#160;        <span class="comment">// be quick about checking this</span></div>
<div class="line"><a name="l01332"></a><span class="lineno"> 1332</span>&#160;        newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a073783ba864c07681c8999a67162202b">nstroke</a>=newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a83280998e47831044a7e35299495a9bb">lntries</a>=0;</div>
<div class="line"><a name="l01333"></a><span class="lineno"> 1333</span>&#160;        <span class="comment">// set inputs for errors, maxiters, etc.</span></div>
<div class="line"><a name="l01334"></a><span class="lineno"> 1334</span>&#160;<span class="preprocessor">#define IMPTRYCONVCONSTFORFX (1E-6)</span></div>
<div class="line"><a name="l01335"></a><span class="lineno"> 1335</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define IMPOKCONVCONSTFORFX (1E-4)</span></div>
<div class="line"><a name="l01336"></a><span class="lineno"> 1336</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define IMPALLOWCONVCONSTFORFX (1E-3)</span></div>
<div class="line"><a name="l01337"></a><span class="lineno"> 1337</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define IMPMAXITERFORFX (10)</span></div>
<div class="line"><a name="l01338"></a><span class="lineno"> 1338</span>&#160;<span class="preprocessor"></span>        newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#abaf99ec9e8c395755285cd9a44858314">tryconv</a>=1<a class="code" href="../../d8/d60/init_8c.html#a07484107e6d9fdf38b53edf631d6511d">E</a>-2*<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(IMPTRYCONVCONSTFORFX,IMPOKCONVCONSTFORFX);</div>
<div class="line"><a name="l01339"></a><span class="lineno"> 1339</span>&#160;        newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a00940ef45bf3eb6e72c49ea66dd7c8b2">tryconvultrarel</a>=1<a class="code" href="../../d8/d60/init_8c.html#a07484107e6d9fdf38b53edf631d6511d">E</a>-2*<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(IMPTRYCONVCONSTFORFX,IMPOKCONVCONSTFORFX);</div>
<div class="line"><a name="l01340"></a><span class="lineno"> 1340</span>&#160;        newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a28c2335afb8757d40128392034402c17">extra_newt_iter</a>=1;</div>
<div class="line"><a name="l01341"></a><span class="lineno"> 1341</span>&#160;        newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a08186e529162af19adc29e62eaaf31d9">extra_newt_iter_ultrarel</a>=2;</div>
<div class="line"><a name="l01342"></a><span class="lineno"> 1342</span>&#160;        newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a98ac5de850a4bd5b495a8c9e1975499b">mintryconv</a>=IMPALLOWCONVCONSTFORFX;</div>
<div class="line"><a name="l01343"></a><span class="lineno"> 1343</span>&#160;        newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a767c6b7671c51ec6db1a3d7199775588">maxiter</a>=IMPMAXITERFORFX;</div>
<div class="line"><a name="l01344"></a><span class="lineno"> 1344</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01345"></a><span class="lineno"> 1345</span>&#160;      }</div>
<div class="line"><a name="l01346"></a><span class="lineno"> 1346</span>&#160;      <span class="comment">//      dualfprintf(fail_file,&quot;BEFORE FIXUPUTOPRIMGEN\n&quot;);</span></div>
<div class="line"><a name="l01347"></a><span class="lineno"> 1347</span>&#160;      failreturn=<a class="code" href="../../d1/d3e/utoprimgen_8c.html#a7e078cc9a354495bc85554d875a705d9" title="General explicit inversion of U[MHD]-&gt;P[MHD] and also inverts scalars. Inverts radiation if(EOMRADTYP...">Utoprimgen</a>(showmessages,checkoninversiongas,checkoninversionrad,allowlocalfailurefixandnoreport, finalstep,&amp;eomtype,whichcap,whichmethod,modprim,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a90ec042ae4fcf0baf8954f1e91be10a8">OTHERUTOPRIM</a>,UNOTHING,U,&amp;q, ptrgeom,dissmeasure,prmhd,prmhd,&amp;newtonstats);</div>
<div class="line"><a name="l01348"></a><span class="lineno"> 1348</span>&#160;      <span class="comment">//      dualfprintf(fail_file,&quot;AFTER FIXUPUTOPRIMGEN\n&quot;);</span></div>
<div class="line"><a name="l01349"></a><span class="lineno"> 1349</span>&#160;      <span class="comment">// have to add since takes effort.s</span></div>
<div class="line"><a name="l01350"></a><span class="lineno"> 1350</span>&#160;      <a class="code" href="../../d8/d5b/defs_8general_8h.html#a5f1c4a4bf07f7a6010404484cb9e6b50">nstroke</a>+=newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a073783ba864c07681c8999a67162202b">nstroke</a>; newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a073783ba864c07681c8999a67162202b">nstroke</a>=newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a83280998e47831044a7e35299495a9bb">lntries</a>=0;</div>
<div class="line"><a name="l01351"></a><span class="lineno"> 1351</span>&#160;</div>
<div class="line"><a name="l01352"></a><span class="lineno"> 1352</span>&#160;      <span class="comment">// KORALNOTEMARK: Only changing floor related to MHD fluid so far, so no check on failure of radiation inversion.</span></div>
<div class="line"><a name="l01353"></a><span class="lineno"> 1353</span>&#160;      badinversion = (failreturn&gt;=1 || <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0894a5e6c53e2e8a143d10be7a42d492">IFUTOPRIMFAIL</a>(GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,FLAGUTOPRIMFAIL)));</div>
<div class="line"><a name="l01354"></a><span class="lineno"> 1354</span>&#160;</div>
<div class="line"><a name="l01355"></a><span class="lineno"> 1355</span>&#160;      <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> utoprimgenfixup=0,utoprimgenfixupbad=0;</div>
<div class="line"><a name="l01356"></a><span class="lineno"> 1356</span>&#160;      utoprimgenfixup++;</div>
<div class="line"><a name="l01357"></a><span class="lineno"> 1357</span>&#160;      <span class="keywordflow">if</span>(badinversion) utoprimgenfixupbad++;</div>
<div class="line"><a name="l01358"></a><span class="lineno"> 1358</span>&#160;      <span class="keywordflow">if</span>(debugfail&gt;=2) <span class="keywordflow">if</span>(utoprimgenfixup%<a class="code" href="../../dd/d46/mpidefs_8h.html#a38e1083345af2cf99e31d941f18b56ad">totalzones</a>==0) dualfprintf(fail_file,<span class="stringliteral">&quot;UTOPRIMGENFIXUP: %lld (bad=%lld) : %ld %d\n&quot;</span>,utoprimgenfixup,utoprimgenfixupbad,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a1a1088d87617078680f1fd0f0d707384">nstep</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a70170b90229f9fc05eebf8508a685c70">steppart</a>);</div>
<div class="line"><a name="l01359"></a><span class="lineno"> 1359</span>&#160;</div>
<div class="line"><a name="l01360"></a><span class="lineno"> 1360</span>&#160;</div>
<div class="line"><a name="l01361"></a><span class="lineno"> 1361</span>&#160;      <span class="keywordflow">if</span>(badinversion){</div>
<div class="line"><a name="l01362"></a><span class="lineno"> 1362</span>&#160;        <span class="keywordflow">if</span>(debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;Utoprimgen failed in fixup.c&quot;</span>);</div>
<div class="line"><a name="l01363"></a><span class="lineno"> 1363</span>&#160;        <span class="comment">// if problem with Utoprim, then just modify primitive quantities as normal without any special constraints</span></div>
<div class="line"><a name="l01364"></a><span class="lineno"> 1364</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl){</div>
<div class="line"><a name="l01365"></a><span class="lineno"> 1365</span>&#160;          prmhd[pl]=prmhdnew[pl];</div>
<div class="line"><a name="l01366"></a><span class="lineno"> 1366</span>&#160;        }</div>
<div class="line"><a name="l01367"></a><span class="lineno"> 1367</span>&#160;      }</div>
<div class="line"><a name="l01368"></a><span class="lineno"> 1368</span>&#160;</div>
<div class="line"><a name="l01369"></a><span class="lineno"> 1369</span>&#160;      <span class="comment">// in any case, this is not normal inversion procedure, so clear the flags</span></div>
<div class="line"><a name="l01370"></a><span class="lineno"> 1370</span>&#160;      GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,FLAGUTOPRIMFAIL)=oldmhdpflag;</div>
<div class="line"><a name="l01371"></a><span class="lineno"> 1371</span>&#160;      GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,FLAGUTOPRIMRADFAIL)=oldradpflag;</div>
<div class="line"><a name="l01372"></a><span class="lineno"> 1372</span>&#160;</div>
<div class="line"><a name="l01373"></a><span class="lineno"> 1373</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01374"></a><span class="lineno"> 1374</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01375"></a><span class="lineno"> 1375</span>&#160;</div>
<div class="line"><a name="l01376"></a><span class="lineno"> 1376</span>&#160;      <span class="comment">// get min or max of comoving and ZAMO frame versions of densities</span></div>
<div class="line"><a name="l01377"></a><span class="lineno"> 1377</span>&#160;      <span class="comment">// generally trying to keep atmosphere non-relativistic</span></div>
<div class="line"><a name="l01378"></a><span class="lineno"> 1378</span>&#160;      <span class="comment">//      pl=RHO;   prmhd[pl]=MIN(prmhd[pl],prmhdnew[pl]);</span></div>
<div class="line"><a name="l01379"></a><span class="lineno"> 1379</span>&#160;      <span class="comment">// get larger of rho</span></div>
<div class="line"><a name="l01380"></a><span class="lineno"> 1380</span>&#160;      <span class="keywordflow">if</span>(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>&gt;=0){ pl=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>;   prmhd[pl]=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(prmhd[pl],prmhdnew[pl]);}</div>
<div class="line"><a name="l01381"></a><span class="lineno"> 1381</span>&#160;      <span class="comment">// get smallest of two</span></div>
<div class="line"><a name="l01382"></a><span class="lineno"> 1382</span>&#160;      <span class="keywordflow">if</span>(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>&gt;=0){ pl=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>;    prmhd[pl]=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(prmhd[pl],prmhdnew[pl]);}</div>
<div class="line"><a name="l01383"></a><span class="lineno"> 1383</span>&#160;      <span class="keywordflow">if</span>(URAD0&gt;=0){ pl=URAD0; prmhd[pl]=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(prmhd[pl],prmhdnew[pl]);}</div>
<div class="line"><a name="l01384"></a><span class="lineno"> 1384</span>&#160;</div>
<div class="line"><a name="l01385"></a><span class="lineno"> 1385</span>&#160;</div>
<div class="line"><a name="l01386"></a><span class="lineno"> 1386</span>&#160;    }<span class="comment">// end if didchangeprim</span></div>
<div class="line"><a name="l01387"></a><span class="lineno"> 1387</span>&#160;</div>
<div class="line"><a name="l01388"></a><span class="lineno"> 1388</span>&#160;  }<span class="comment">// end if cold or hot GRMHD</span></div>
<div class="line"><a name="l01389"></a><span class="lineno"> 1389</span>&#160;</div>
<div class="line"><a name="l01390"></a><span class="lineno"> 1390</span>&#160;</div>
<div class="line"><a name="l01391"></a><span class="lineno"> 1391</span>&#160;</div>
<div class="line"><a name="l01392"></a><span class="lineno"> 1392</span>&#160;</div>
<div class="line"><a name="l01394"></a><span class="lineno"> 1394</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01395"></a><span class="lineno"> 1395</span>&#160;  <span class="comment">// since inflow check is on boundary values, no need for inflow check here</span></div>
<div class="line"><a name="l01396"></a><span class="lineno"> 1396</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01398"></a><span class="lineno"> 1398</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01399"></a><span class="lineno"> 1399</span>&#160;</div>
<div class="line"><a name="l01401"></a><span class="lineno"> 1401</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01402"></a><span class="lineno"> 1402</span>&#160;  <span class="comment">// account for primitive changes</span></div>
<div class="line"><a name="l01403"></a><span class="lineno"> 1403</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01405"></a><span class="lineno"> 1405</span>&#160;<span class="comment"></span>  <span class="keywordflow">if</span>(didchangeprim&amp;&amp;<a class="code" href="../../da/d3e/definit_8h.html#ac4f2d98c32265f13da601400273b8ba5">FLOORDIAGS</a>){<span class="comment">// FLOORDIAGS includes fail diags</span></div>
<div class="line"><a name="l01406"></a><span class="lineno"> 1406</span>&#160;    <span class="keywordtype">int</span> docorrectucons2=(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a55732148d2616d6d1f5d2abbe8710850">DOENOFLUX</a> != <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#adacaaf8526353cfe870206f0cf4d2ca7" title="for DOENOFLUX: 0: no ENO flux reconstruction 1: reconstruct F for finite difference rep...">NOENOFLUX</a>);</div>
<div class="line"><a name="l01407"></a><span class="lineno"> 1407</span>&#160;    <span class="keywordtype">int</span> doingmhdfixup=1;</div>
<div class="line"><a name="l01408"></a><span class="lineno"> 1408</span>&#160;    <span class="comment">//    if((startpos[1]+ptrgeom-&gt;i==17) &amp;&amp; (startpos[2]+ptrgeom-&gt;j)==0){</span></div>
<div class="line"><a name="l01409"></a><span class="lineno"> 1409</span>&#160;    <span class="comment">//      dualfprintf(fail_file,&quot;FLOORACTBEFORE: steppart=%d nstep=%ld\n&quot;,steppart,nstep);</span></div>
<div class="line"><a name="l01410"></a><span class="lineno"> 1410</span>&#160;    <span class="comment">//    }</span></div>
<div class="line"><a name="l01411"></a><span class="lineno"> 1411</span>&#160;</div>
<div class="line"><a name="l01412"></a><span class="lineno"> 1412</span>&#160;    <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflag,*lpflagrad;</div>
<div class="line"><a name="l01413"></a><span class="lineno"> 1413</span>&#160;    lpflag=&amp;GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,FLAGUTOPRIMFAIL);</div>
<div class="line"><a name="l01414"></a><span class="lineno"> 1414</span>&#160;    lpflagrad=&amp;GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,FLAGUTOPRIMRADFAIL);</div>
<div class="line"><a name="l01415"></a><span class="lineno"> 1415</span>&#160;</div>
<div class="line"><a name="l01416"></a><span class="lineno"> 1416</span>&#160;    <span class="keywordflow">if</span>(*lpflag&gt;UTOPRIMNOFAIL || <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a781d24b3e646f7f4597b0b7004507a63">IFUTOPRIMRADFAIL</a>(*lpflagrad)){</div>
<div class="line"><a name="l01417"></a><span class="lineno"> 1417</span>&#160;      <span class="comment">// by this point, pr0 or prdiag are not necessarily consistent with ucons, which if finalstep=1 is the final conserved quantity.  This occurs when no implicit solution and no explicit inversion.  Happens when (e.g.) U[RHO]&lt;0.</span></div>
<div class="line"><a name="l01418"></a><span class="lineno"> 1418</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Uievolve[NPR];</div>
<div class="line"><a name="l01419"></a><span class="lineno"> 1419</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) Uievolve[pl] = ucons[pl];</div>
<div class="line"><a name="l01420"></a><span class="lineno"> 1420</span>&#160;      diag_fixup_Ui_pf(docorrectucons2, Uievolve, prmhd, ptrgeom, finalstep,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afed85fb18f4cb9bac34876ffa14a7ea5">COUNTFLOORACT</a>,NULL);</div>
<div class="line"><a name="l01421"></a><span class="lineno"> 1421</span>&#160;    }</div>
<div class="line"><a name="l01422"></a><span class="lineno"> 1422</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l01423"></a><span class="lineno"> 1423</span>&#160;      <span class="comment">// if no failure, then fixup_utoprim won&#39;t be called or do diagnostics, so floor will be preserved and so do accounting here.</span></div>
<div class="line"><a name="l01424"></a><span class="lineno"> 1424</span>&#160;      diag_fixup(docorrectucons2,prdiag, prmhd, ucons, ptrgeom, finalstep,doingmhdfixup,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afed85fb18f4cb9bac34876ffa14a7ea5">COUNTFLOORACT</a>);</div>
<div class="line"><a name="l01425"></a><span class="lineno"> 1425</span>&#160;    }</div>
<div class="line"><a name="l01426"></a><span class="lineno"> 1426</span>&#160;</div>
<div class="line"><a name="l01427"></a><span class="lineno"> 1427</span>&#160;    </div>
<div class="line"><a name="l01428"></a><span class="lineno"> 1428</span>&#160;</div>
<div class="line"><a name="l01429"></a><span class="lineno"> 1429</span>&#160;</div>
<div class="line"><a name="l01430"></a><span class="lineno"> 1430</span>&#160;    <span class="comment">// now prdiag=prmhd as far as diag_fixup() is concerned, so next changes are new changes (i.e. don&#39;t cumulative w.r.t. pr0 multiple times, since that (relative to prmhd each time) would add each prior change to each next change)</span></div>
<div class="line"><a name="l01431"></a><span class="lineno"> 1431</span>&#160;    <span class="comment">//    PALLLOOP(pl) prdiag[pl]=prmhd[pl];</span></div>
<div class="line"><a name="l01432"></a><span class="lineno"> 1432</span>&#160;    <span class="comment">//    if((startpos[1]+ptrgeom-&gt;i==17) &amp;&amp; (startpos[2]+ptrgeom-&gt;j)==0){</span></div>
<div class="line"><a name="l01433"></a><span class="lineno"> 1433</span>&#160;    <span class="comment">//      dualfprintf(fail_file,&quot;FLOORACTAFTER: steppart=%d nstep=%ld\n&quot;,steppart,nstep);</span></div>
<div class="line"><a name="l01434"></a><span class="lineno"> 1434</span>&#160;    <span class="comment">//    }</span></div>
<div class="line"><a name="l01435"></a><span class="lineno"> 1435</span>&#160;  }</div>
<div class="line"><a name="l01436"></a><span class="lineno"> 1436</span>&#160;</div>
<div class="line"><a name="l01437"></a><span class="lineno"> 1437</span>&#160;</div>
<div class="line"><a name="l01438"></a><span class="lineno"> 1438</span>&#160;</div>
<div class="line"><a name="l01439"></a><span class="lineno"> 1439</span>&#160;</div>
<div class="line"><a name="l01440"></a><span class="lineno"> 1440</span>&#160;</div>
<div class="line"><a name="l01441"></a><span class="lineno"> 1441</span>&#160;</div>
<div class="line"><a name="l01442"></a><span class="lineno"> 1442</span>&#160;    <span class="comment">// assume once we go below floor, all hell will break loose unless we calm the storm by shutting down this zone&#39;s relative velocity</span></div>
<div class="line"><a name="l01443"></a><span class="lineno"> 1443</span>&#160;    <span class="comment">// normal observer velocity</span></div>
<div class="line"><a name="l01444"></a><span class="lineno"> 1444</span>&#160;    <span class="comment">// i.e. consider this a failure</span></div>
<div class="line"><a name="l01445"></a><span class="lineno"> 1445</span>&#160;    <span class="comment">//GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,FLAGUTOPRIMFAIL)= 1;</span></div>
<div class="line"><a name="l01446"></a><span class="lineno"> 1446</span>&#160;</div>
<div class="line"><a name="l01447"></a><span class="lineno"> 1447</span>&#160;</div>
<div class="line"><a name="l01449"></a><span class="lineno"> 1449</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01450"></a><span class="lineno"> 1450</span>&#160;  <span class="comment">// now keep track of modified primitives via conserved quantities</span></div>
<div class="line"><a name="l01451"></a><span class="lineno"> 1451</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01453"></a><span class="lineno"> 1453</span>&#160;<span class="comment"></span>  <span class="keywordflow">if</span>(didchangeprim){</div>
<div class="line"><a name="l01454"></a><span class="lineno"> 1454</span>&#160;</div>
<div class="line"><a name="l01456"></a><span class="lineno"> 1456</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01457"></a><span class="lineno"> 1457</span>&#160;    <span class="comment">// Assign final primitives</span></div>
<div class="line"><a name="l01458"></a><span class="lineno"> 1458</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01460"></a><span class="lineno"> 1460</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01461"></a><span class="lineno"> 1461</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl) pr[pl]=prmhd[pl];</div>
<div class="line"><a name="l01462"></a><span class="lineno"> 1462</span>&#160;</div>
<div class="line"><a name="l01463"></a><span class="lineno"> 1463</span>&#160;    <span class="comment">// SUPERGODMARK: only doing rest-mass density here for now.  Still account for YFL2-5 via finalstep==1 source injection, but sub-steps only then handle fluxes for YFL2-5 currently unless add how conserved quantities changed here.  In any case, this is estimate for finalstep actual ucons vs. Uf(pf) changes.</span></div>
<div class="line"><a name="l01464"></a><span class="lineno"> 1464</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#a79e43847a28767578803cc5af29883cc" title="must also set RESCALEINTERP=1">DOYFL</a>){</div>
<div class="line"><a name="l01465"></a><span class="lineno"> 1465</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> drho=(pr[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>]-pr0[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>]);</div>
<div class="line"><a name="l01466"></a><span class="lineno"> 1466</span>&#160;      <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#a79e43847a28767578803cc5af29883cc" title="must also set RESCALEINTERP=1">DOYFL</a>==1){</div>
<div class="line"><a name="l01467"></a><span class="lineno"> 1467</span>&#160;        pr[YFL1] = (pr0[YFL1]*pr0[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>] + drho)/pr[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>];<span class="comment">// have floor set new floor scalar fraction.  Adds mass at same velocity for FIXUPTYPE==0</span></div>
<div class="line"><a name="l01468"></a><span class="lineno"> 1468</span>&#160;        <span class="keywordflow">if</span>(pr[YFL1]&lt;0.0) pr[YFL1]=0.0;</div>
<div class="line"><a name="l01469"></a><span class="lineno"> 1469</span>&#160;        <span class="keywordflow">if</span>(pr[YFL1]&gt;1.0) pr[YFL1]=1.0;</div>
<div class="line"><a name="l01470"></a><span class="lineno"> 1470</span>&#160;      }</div>
<div class="line"><a name="l01471"></a><span class="lineno"> 1471</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#a79e43847a28767578803cc5af29883cc" title="must also set RESCALEINTERP=1">DOYFL</a>==2){</div>
<div class="line"><a name="l01472"></a><span class="lineno"> 1472</span>&#160;        pr[YFL1] = pr0[YFL1] + drho;</div>
<div class="line"><a name="l01473"></a><span class="lineno"> 1473</span>&#160;        <span class="keywordflow">if</span>(pr[YFL1]&lt;SMALL) pr[YFL1]=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a09c78d2f8feb311dd9fc969a0bf84979">SMALL</a>;</div>
<div class="line"><a name="l01474"></a><span class="lineno"> 1474</span>&#160;        <span class="keywordflow">if</span>(pr[YFL1]&gt;pr[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>]) pr[YFL1]=pr[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>];</div>
<div class="line"><a name="l01475"></a><span class="lineno"> 1475</span>&#160;      }</div>
<div class="line"><a name="l01476"></a><span class="lineno"> 1476</span>&#160;</div>
<div class="line"><a name="l01477"></a><span class="lineno"> 1477</span>&#160;</div>
<div class="line"><a name="l01478"></a><span class="lineno"> 1478</span>&#160;      <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#a79e43847a28767578803cc5af29883cc" title="must also set RESCALEINTERP=1">DOYFL</a>==2&amp;&amp;0){</div>
<div class="line"><a name="l01479"></a><span class="lineno"> 1479</span>&#160;        <span class="comment">// also iterate on other YFLx&#39;s</span></div>
<div class="line"><a name="l01480"></a><span class="lineno"> 1480</span>&#160;        <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> qnew;</div>
<div class="line"><a name="l01481"></a><span class="lineno"> 1481</span>&#160;        <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a11e17cd8b0594d1ad52e3594aa9f477e" title="find ucon, ucov, bcon, bcov from primitive variables when calling get_state, users of this function e...">get_state</a>(pr,ptrgeom,&amp;qnew);</div>
<div class="line"><a name="l01482"></a><span class="lineno"> 1482</span>&#160;        <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Unew[NPR];</div>
<div class="line"><a name="l01483"></a><span class="lineno"> 1483</span>&#160;        <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a9a54096e4c40a15a2c1bf74266153616" title="calculate &quot;conserved&quot; quantities">primtoU</a>(UNOTHING,pr,&amp;qnew,ptrgeom,Unew, NULL);</div>
<div class="line"><a name="l01484"></a><span class="lineno"> 1484</span>&#160;</div>
<div class="line"><a name="l01485"></a><span class="lineno"> 1485</span>&#160;        <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> q0;</div>
<div class="line"><a name="l01486"></a><span class="lineno"> 1486</span>&#160;        <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a11e17cd8b0594d1ad52e3594aa9f477e" title="find ucon, ucov, bcon, bcov from primitive variables when calling get_state, users of this function e...">get_state</a>(pr0,ptrgeom,&amp;q0);</div>
<div class="line"><a name="l01487"></a><span class="lineno"> 1487</span>&#160;        <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> U0[NPR];</div>
<div class="line"><a name="l01488"></a><span class="lineno"> 1488</span>&#160;        <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a9a54096e4c40a15a2c1bf74266153616" title="calculate &quot;conserved&quot; quantities">primtoU</a>(UNOTHING,pr0,&amp;q0,ptrgeom,U0, NULL);</div>
<div class="line"><a name="l01489"></a><span class="lineno"> 1489</span>&#160;</div>
<div class="line"><a name="l01490"></a><span class="lineno"> 1490</span>&#160;        <span class="keywordflow">if</span>(YFL2&gt;=0) pr[YFL2]+= -(Unew[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]-U0[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>])/qnew.<a class="code" href="../../d1/d83/structof__state.html#aab723d3c7c2c48b7246cc7d7d5379eed">ucon</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>];</div>
<div class="line"><a name="l01491"></a><span class="lineno"> 1491</span>&#160;        <span class="keywordflow">if</span>(YFL3&gt;=0) pr[YFL3]+= +(Unew[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8de9104f1fffa59f057b214d74c5cfea">U3</a>]-U0[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8de9104f1fffa59f057b214d74c5cfea">U3</a>])/qnew.<a class="code" href="../../d1/d83/structof__state.html#aab723d3c7c2c48b7246cc7d7d5379eed">ucon</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>];</div>
<div class="line"><a name="l01492"></a><span class="lineno"> 1492</span>&#160;        <span class="keywordflow">if</span>(<a class="code" href="../../de/d95/fixup_8c.html#ad7222bf183c76ad39adea3084ff61ba4">YFLADDRADTOGAS</a>){</div>
<div class="line"><a name="l01493"></a><span class="lineno"> 1493</span>&#160;          <span class="keywordflow">if</span>(YFL2&gt;=0) pr[YFL2]+= -(Unew[URAD0]-U0[URAD0])/qnew.<a class="code" href="../../d1/d83/structof__state.html#a3bf8e15ee6ae95831230791baf2fc570">uradcon</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>];</div>
<div class="line"><a name="l01494"></a><span class="lineno"> 1494</span>&#160;          <span class="keywordflow">if</span>(YFL3&gt;=0) pr[YFL3]+= +(Unew[URAD3]-U0[URAD3])/qnew.<a class="code" href="../../d1/d83/structof__state.html#a3bf8e15ee6ae95831230791baf2fc570">uradcon</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>];</div>
<div class="line"><a name="l01495"></a><span class="lineno"> 1495</span>&#160;        }</div>
<div class="line"><a name="l01496"></a><span class="lineno"> 1496</span>&#160;</div>
<div class="line"><a name="l01497"></a><span class="lineno"> 1497</span>&#160;        <span class="keywordflow">if</span>(YFL4&gt;=0){</div>
<div class="line"><a name="l01498"></a><span class="lineno"> 1498</span>&#160;          pr[YFL4]+= -(Unew[URAD0]-U0[URAD0])/qnew.<a class="code" href="../../d1/d83/structof__state.html#a3bf8e15ee6ae95831230791baf2fc570">uradcon</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>];</div>
<div class="line"><a name="l01499"></a><span class="lineno"> 1499</span>&#160;          <span class="keywordflow">if</span>(pr[YFL4]&lt;<a class="code" href="../../d8/d5b/defs_8general_8h.html#a5bd9da451f108352614cbc457524c5b0">ERADLIMIT</a>) pr[YFL4]=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a5bd9da451f108352614cbc457524c5b0">ERADLIMIT</a>;</div>
<div class="line"><a name="l01500"></a><span class="lineno"> 1500</span>&#160;        }</div>
<div class="line"><a name="l01501"></a><span class="lineno"> 1501</span>&#160;        <span class="keywordflow">if</span>(YFL5&gt;=0) pr[YFL5]+= (Unew[URAD3]-U0[URAD3])/qnew.<a class="code" href="../../d1/d83/structof__state.html#a3bf8e15ee6ae95831230791baf2fc570">uradcon</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>];</div>
<div class="line"><a name="l01502"></a><span class="lineno"> 1502</span>&#160;      }</div>
<div class="line"><a name="l01503"></a><span class="lineno"> 1503</span>&#160;    }</div>
<div class="line"><a name="l01504"></a><span class="lineno"> 1504</span>&#160;</div>
<div class="line"><a name="l01505"></a><span class="lineno"> 1505</span>&#160;</div>
<div class="line"><a name="l01506"></a><span class="lineno"> 1506</span>&#160;<span class="preprocessor">#if(0)</span></div>
<div class="line"><a name="l01507"></a><span class="lineno"> 1507</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01508"></a><span class="lineno"> 1508</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01509"></a><span class="lineno"> 1509</span>&#160;    <span class="comment">// now ensure primitive and conserved consistent for RK3 and other methods that use Uf</span></div>
<div class="line"><a name="l01510"></a><span class="lineno"> 1510</span>&#160;    <span class="comment">// assumes &quot;ucons&quot; is utoinvert in advance.c so it&#39;s uf or utempcum when necessary as associated with inversion (internal implicit or external).</span></div>
<div class="line"><a name="l01511"></a><span class="lineno"> 1511</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01513"></a><span class="lineno"> 1513</span>&#160;<span class="comment"></span>    <span class="comment">// here&#39;s where we correct ucons</span></div>
<div class="line"><a name="l01514"></a><span class="lineno"> 1514</span>&#160;    docorrectucons=1;</div>
<div class="line"><a name="l01515"></a><span class="lineno"> 1515</span>&#160;    <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> qnew;</div>
<div class="line"><a name="l01516"></a><span class="lineno"> 1516</span>&#160;    <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a11e17cd8b0594d1ad52e3594aa9f477e" title="find ucon, ucov, bcon, bcov from primitive variables when calling get_state, users of this function e...">get_state</a>(pr,ptrgeom,&amp;qnew);</div>
<div class="line"><a name="l01517"></a><span class="lineno"> 1517</span>&#160;</div>
<div class="line"><a name="l01518"></a><span class="lineno"> 1518</span>&#160;    <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a9a54096e4c40a15a2c1bf74266153616" title="calculate &quot;conserved&quot; quantities">primtoU</a>(UEVOLVE,pr,&amp;qnew,ptrgeom,ucons, NULL);</div>
<div class="line"><a name="l01519"></a><span class="lineno"> 1519</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01520"></a><span class="lineno"> 1520</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01521"></a><span class="lineno"> 1521</span>&#160;    <span class="keywordflow">return</span>(-1); <span class="comment">// -1 means made changes</span></div>
<div class="line"><a name="l01522"></a><span class="lineno"> 1522</span>&#160;</div>
<div class="line"><a name="l01523"></a><span class="lineno"> 1523</span>&#160;  }</div>
<div class="line"><a name="l01524"></a><span class="lineno"> 1524</span>&#160;</div>
<div class="line"><a name="l01525"></a><span class="lineno"> 1525</span>&#160;</div>
<div class="line"><a name="l01526"></a><span class="lineno"> 1526</span>&#160;  <span class="keywordflow">if</span>(uconsinput!=NULL &amp;&amp; docorrectucons){</div>
<div class="line"><a name="l01527"></a><span class="lineno"> 1527</span>&#160;    <span class="comment">// copy over ucons result in case changed.</span></div>
<div class="line"><a name="l01528"></a><span class="lineno"> 1528</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l01529"></a><span class="lineno"> 1529</span>&#160;      <span class="comment">// if staggered field, avoid modifying field since at FACEs, not CENT where pr lives.</span></div>
<div class="line"><a name="l01530"></a><span class="lineno"> 1530</span>&#160;      <span class="keywordflow">if</span>(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a56c640597356b6f642dd6ee1afb87e74">BPL</a>(pl)==0 &amp;&amp; <a class="code" href="../../d8/d5b/defs_8general_8h.html#a11c4e99e1493d0c1914ad1ab313ea472">FLUXB</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0b6762cef74e396f50a83864bb53fb6c">FLUXCTSTAG</a> || <a class="code" href="../../d8/d5b/defs_8general_8h.html#a11c4e99e1493d0c1914ad1ab313ea472">FLUXB</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a5014e44c6e710d8827ef79dd18abe6ad">FLUXCTTOTH</a>){</div>
<div class="line"><a name="l01531"></a><span class="lineno"> 1531</span>&#160;        uconsinput[pl] = ucons[pl];</div>
<div class="line"><a name="l01532"></a><span class="lineno"> 1532</span>&#160;      }</div>
<div class="line"><a name="l01533"></a><span class="lineno"> 1533</span>&#160;    }</div>
<div class="line"><a name="l01534"></a><span class="lineno"> 1534</span>&#160;  }</div>
<div class="line"><a name="l01535"></a><span class="lineno"> 1535</span>&#160;</div>
<div class="line"><a name="l01536"></a><span class="lineno"> 1536</span>&#160;</div>
<div class="line"><a name="l01537"></a><span class="lineno"> 1537</span>&#160;  <span class="comment">//  if((startpos[1]+ptrgeom-&gt;i==17) &amp;&amp; (startpos[2]+ptrgeom-&gt;j)==0){</span></div>
<div class="line"><a name="l01538"></a><span class="lineno"> 1538</span>&#160;  <span class="comment">//    struct of_state qb;</span></div>
<div class="line"><a name="l01539"></a><span class="lineno"> 1539</span>&#160;  <span class="comment">//    get_state(pr,ptrgeom,&amp;qb);</span></div>
<div class="line"><a name="l01540"></a><span class="lineno"> 1540</span>&#160;  <span class="comment">//    FTYPE ub[NPR],ubabs[NPR];</span></div>
<div class="line"><a name="l01541"></a><span class="lineno"> 1541</span>&#160;  <span class="comment">//    int uutype=UDIAG;</span></div>
<div class="line"><a name="l01542"></a><span class="lineno"> 1542</span>&#160;  <span class="comment">//    primtoU(uutype,pr,&amp;qb,ptrgeom,ub,ubabs);</span></div>
<div class="line"><a name="l01543"></a><span class="lineno"> 1543</span>&#160;  <span class="comment">//    dualfprintf(fail_file,&quot;URHOINFIXUPU1ZONE=%21.15g\n&quot;,ub[RHO]*dx[1]*dx[2]*dx[3]);</span></div>
<div class="line"><a name="l01544"></a><span class="lineno"> 1544</span>&#160;  <span class="comment">//  }</span></div>
<div class="line"><a name="l01545"></a><span class="lineno"> 1545</span>&#160;  </div>
<div class="line"><a name="l01546"></a><span class="lineno"> 1546</span>&#160;</div>
<div class="line"><a name="l01547"></a><span class="lineno"> 1547</span>&#160;</div>
<div class="line"><a name="l01548"></a><span class="lineno"> 1548</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l01549"></a><span class="lineno"> 1549</span>&#160;}</div>
<div class="line"><a name="l01550"></a><span class="lineno"> 1550</span>&#160;</div>
<div class="line"><a name="l01551"></a><span class="lineno"> 1551</span>&#160;</div>
<div class="line"><a name="l01552"></a><span class="lineno"> 1552</span>&#160;<span class="comment">// number of vote checks per zone</span></div>
<div class="line"><a name="l01553"></a><span class="lineno"><a class="code" href="../../de/d95/fixup_8c.html#a17354bf5b5383aa1dd2a84ef3c491e61"> 1553</a></span>&#160;<span class="preprocessor">#define MAXVOTES 8</span></div>
<div class="line"><a name="l01554"></a><span class="lineno"> 1554</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01555"></a><span class="lineno"><a class="code" href="../../de/d95/fixup_8c.html#ac78101f2f05aee4b1a74e808d6dfa254"> 1555</a></span>&#160;<span class="preprocessor">#define NUMCHECKS 2</span></div>
<div class="line"><a name="l01556"></a><span class="lineno"><a class="code" href="../../de/d95/fixup_8c.html#a66622da09337a2216daa3df71e34513d"> 1556</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define ISGAMMACHECK 0</span></div>
<div class="line"><a name="l01557"></a><span class="lineno"><a class="code" href="../../de/d95/fixup_8c.html#a0dd2a8968355aec0c8d35c011fc7f055"> 1557</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define ISUUCHECK 0</span></div>
<div class="line"><a name="l01558"></a><span class="lineno"> 1558</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01567"></a><span class="lineno"> 1567</span>&#160;<span class="keywordtype">int</span> fixup_checksolution(<span class="keywordtype">int</span> stage, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pv)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR],<span class="keywordtype">int</span> finalstep)</div>
<div class="line"><a name="l01568"></a><span class="lineno"> 1568</span>&#160;{</div>
<div class="line"><a name="l01569"></a><span class="lineno"> 1569</span>&#160;  <span class="comment">//  int inboundloop[NDIM];</span></div>
<div class="line"><a name="l01570"></a><span class="lineno"> 1570</span>&#160;  <span class="comment">//  int outboundloop[NDIM];</span></div>
<div class="line"><a name="l01571"></a><span class="lineno"> 1571</span>&#160;  <span class="comment">//  int innormalloop[NDIM];</span></div>
<div class="line"><a name="l01572"></a><span class="lineno"> 1572</span>&#160;  <span class="comment">//  int outnormalloop[NDIM];</span></div>
<div class="line"><a name="l01573"></a><span class="lineno"> 1573</span>&#160;  <span class="comment">//  int inoutlohi[NUMUPDOWN][NUMUPDOWN][NDIM];</span></div>
<div class="line"><a name="l01574"></a><span class="lineno"> 1574</span>&#160;  <span class="comment">//  int riin,riout,rjin,rjout,rkin,rkout;</span></div>
<div class="line"><a name="l01575"></a><span class="lineno"> 1575</span>&#160;  <span class="comment">//  int dosetbc[COMPDIM*2];</span></div>
<div class="line"><a name="l01576"></a><span class="lineno"> 1576</span>&#160;  <span class="comment">//  int ri;</span></div>
<div class="line"><a name="l01577"></a><span class="lineno"> 1577</span>&#160;  <span class="comment">//  int boundvartype=BOUNDINTTYPE;</span></div>
<div class="line"><a name="l01578"></a><span class="lineno"> 1578</span>&#160;  <span class="comment">// extra memory</span></div>
<div class="line"><a name="l01579"></a><span class="lineno"> 1579</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*gammacheck)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR];</div>
<div class="line"><a name="l01580"></a><span class="lineno"> 1580</span>&#160;  <span class="keyword">extern</span> <span class="keywordtype">void</span> get_advance_startendindices(<span class="keywordtype">int</span> *is,<span class="keywordtype">int</span> *ie,<span class="keywordtype">int</span> *js,<span class="keywordtype">int</span> *je,<span class="keywordtype">int</span> *ks,<span class="keywordtype">int</span> *ke);</div>
<div class="line"><a name="l01581"></a><span class="lineno"> 1581</span>&#160;  <span class="keywordtype">int</span> is,ie,js,je,ks,ke;</div>
<div class="line"><a name="l01582"></a><span class="lineno"> 1582</span>&#160;</div>
<div class="line"><a name="l01584"></a><span class="lineno"> 1584</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01585"></a><span class="lineno"> 1585</span>&#160;  <span class="comment">// setup memory space for gammacheck</span></div>
<div class="line"><a name="l01586"></a><span class="lineno"> 1586</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01588"></a><span class="lineno"> 1588</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01589"></a><span class="lineno"> 1589</span>&#160;  <span class="comment">// use UU space for holding \gamma</span></div>
<div class="line"><a name="l01590"></a><span class="lineno"> 1590</span>&#160;  gammacheck = <a class="code" href="../../df/d1c/global_8storage_8h.html#ad89dafa5d772b862a44b0f576983ead3" title="shifted pointer (a_s_) wrappers Couldn&#39;t figure out how to macrofy a_s_ or a_, so when changing have ...">GLOBALPOINT</a>(ptemparray); <span class="comment">// should be ok to use since fixup_checksolution() not called inside higher order or EOS or in fixup_utoprim() where also used</span></div>
<div class="line"><a name="l01591"></a><span class="lineno"> 1591</span>&#160;</div>
<div class="line"><a name="l01592"></a><span class="lineno"> 1592</span>&#160;</div>
<div class="line"><a name="l01594"></a><span class="lineno"> 1594</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01595"></a><span class="lineno"> 1595</span>&#160;  <span class="comment">// set bound loop</span></div>
<div class="line"><a name="l01596"></a><span class="lineno"> 1596</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01598"></a><span class="lineno"> 1598</span>&#160;<span class="comment"></span>  <span class="comment">//  set_boundloop(boundvartype, inboundloop,outboundloop,innormalloop,outnormalloop,inoutlohi, &amp;riin, &amp;riout, &amp;rjin, &amp;rjout, &amp;rkin, &amp;rkout, dosetbc);</span></div>
<div class="line"><a name="l01599"></a><span class="lineno"> 1599</span>&#160;  <span class="comment">// +-1 extra so can do check</span></div>
<div class="line"><a name="l01600"></a><span class="lineno"> 1600</span>&#160;  is=<a class="code" href="../../d8/d5b/defs_8general_8h.html#ab5c60dcb37b1f7e5642525031cd5cbcf">Uconsevolveloop</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aefa679918e336291a5fb0e5cfd0dc269">FIS</a>]-<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a2fb146af349ab49ff48fa36b12b9e4fe" title="x1">SHIFT1</a>;</div>
<div class="line"><a name="l01601"></a><span class="lineno"> 1601</span>&#160;  ie=<a class="code" href="../../d8/d5b/defs_8general_8h.html#ab5c60dcb37b1f7e5642525031cd5cbcf">Uconsevolveloop</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aa9efa612e7e6b889d1fd42e644bf3cce">FIE</a>]+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a2fb146af349ab49ff48fa36b12b9e4fe" title="x1">SHIFT1</a>;</div>
<div class="line"><a name="l01602"></a><span class="lineno"> 1602</span>&#160;  js=<a class="code" href="../../d8/d5b/defs_8general_8h.html#ab5c60dcb37b1f7e5642525031cd5cbcf">Uconsevolveloop</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a141f293b4491fd91a765cc74553edbea">FJS</a>]-<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a4601f340e88302d63182d0844c4e3c09" title="x2">SHIFT2</a>;</div>
<div class="line"><a name="l01603"></a><span class="lineno"> 1603</span>&#160;  je=<a class="code" href="../../d8/d5b/defs_8general_8h.html#ab5c60dcb37b1f7e5642525031cd5cbcf">Uconsevolveloop</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a82364cc36a73d5f4c269b5ad8b9f0dd4">FJE</a>]+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a4601f340e88302d63182d0844c4e3c09" title="x2">SHIFT2</a>;</div>
<div class="line"><a name="l01604"></a><span class="lineno"> 1604</span>&#160;  ks=<a class="code" href="../../d8/d5b/defs_8general_8h.html#ab5c60dcb37b1f7e5642525031cd5cbcf">Uconsevolveloop</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab2806eafbffb43c634853ab47d7fd7d7">FKS</a>]-<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac3ff9bd198294b5b3a9c6a22b9cf456a" title="x3">SHIFT3</a>;</div>
<div class="line"><a name="l01605"></a><span class="lineno"> 1605</span>&#160;  ke=<a class="code" href="../../d8/d5b/defs_8general_8h.html#ab5c60dcb37b1f7e5642525031cd5cbcf">Uconsevolveloop</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8de59f913fa18843ee34d376002f5bbc">FKE</a>]+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac3ff9bd198294b5b3a9c6a22b9cf456a" title="x3">SHIFT3</a>;</div>
<div class="line"><a name="l01606"></a><span class="lineno"> 1606</span>&#160;</div>
<div class="line"><a name="l01607"></a><span class="lineno"> 1607</span>&#160;</div>
<div class="line"><a name="l01608"></a><span class="lineno"> 1608</span>&#160;</div>
<div class="line"><a name="l01609"></a><span class="lineno"> 1609</span>&#160;</div>
<div class="line"><a name="l01611"></a><span class="lineno"> 1611</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01612"></a><span class="lineno"> 1612</span>&#160;  <span class="comment">// determine gamma to be used</span></div>
<div class="line"><a name="l01613"></a><span class="lineno"> 1613</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01615"></a><span class="lineno"> 1615</span>&#160;<span class="comment"></span>  <span class="comment">//  LOOPXalldir{</span></div>
<div class="line"><a name="l01617"></a><span class="lineno"> 1617</span>&#160;<span class="comment"></span><span class="preprocessor">#pragma omp parallel  // don&#39;t need full (i.e. don&#39;t need EOS here)</span></div>
<div class="line"><a name="l01618"></a><span class="lineno"> 1618</span>&#160;<span class="preprocessor"></span>  {</div>
<div class="line"><a name="l01619"></a><span class="lineno"> 1619</span>&#160;    <span class="keywordtype">int</span> <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>,<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>,k;</div>
<div class="line"><a name="l01620"></a><span class="lineno"> 1620</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ucon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>],others[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a266c1c3ab2959dbfc603c7d3f12783fb" title="strict limit (doesn&#39;t work in general)">NUMOTHERSTATERESULTS</a>];</div>
<div class="line"><a name="l01621"></a><span class="lineno"> 1621</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> qsq;</div>
<div class="line"><a name="l01622"></a><span class="lineno"> 1622</span>&#160;    <span class="keyword">struct </span><a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> geomdontuse;</div>
<div class="line"><a name="l01623"></a><span class="lineno"> 1623</span>&#160;    <span class="keyword">struct </span><a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom=&amp;geomdontuse;</div>
<div class="line"><a name="l01624"></a><span class="lineno"> 1624</span>&#160;    <a class="code" href="../../d5/d7b/global_8openmploops_8h.html#a1389db2daf5bd9e94918090c253a16c9">OPENMP3DLOOPVARSDEFINE</a>; <a class="code" href="../../d5/d7b/global_8openmploops_8h.html#a8de37da93c3462c536ef830f2fbaee61" title="forced to be a computational loop, so start/stop cannot already have shifts in them (which is normal ...">OPENMP3DLOOPSETUP</a>(is,ie,js,je,ks,ke);</div>
<div class="line"><a name="l01625"></a><span class="lineno"> 1625</span>&#160;</div>
<div class="line"><a name="l01626"></a><span class="lineno"> 1626</span>&#160;</div>
<div class="line"><a name="l01627"></a><span class="lineno"> 1627</span>&#160;<span class="preprocessor">#pragma omp for schedule(OPENMPSCHEDULE(),OPENMPCHUNKSIZE(blocksize))</span></div>
<div class="line"><a name="l01628"></a><span class="lineno"> 1628</span>&#160;<span class="preprocessor"></span>    <a class="code" href="../../d5/d7b/global_8openmploops_8h.html#a9e48537d3cb58cc3a3765b8a18b43b15" title="Oddly, performance changes by 10% when changing how start and stop blockijk (and fixing how used too ...">OPENMP3DLOOPBLOCK</a>{</div>
<div class="line"><a name="l01629"></a><span class="lineno"> 1629</span>&#160;      <a class="code" href="../../df/d1c/global_8storage_8h.html#a96983b0c56e836f50cb7c1af16f59fb6">OPENMP3DLOOPBLOCK2IJK</a>(i,j,k);</div>
<div class="line"><a name="l01630"></a><span class="lineno"> 1630</span>&#160;</div>
<div class="line"><a name="l01631"></a><span class="lineno"> 1631</span>&#160;      <span class="comment">//    if(1|| (GLOBALMACP0A1(pflag,i,j,k,FLAGBSQORHO)||GLOBALMACP0A1(pflag,i,j,k,FLAGBSQOU))&amp;&amp;(IFUTOPRIMFAILORFIXED(GLOBALMACP0A1(pflag,i,j,k,FLAGUTOPRIMFAIL)))){</span></div>
<div class="line"><a name="l01632"></a><span class="lineno"> 1632</span>&#160;      <span class="keywordflow">if</span>(1){</div>
<div class="line"><a name="l01633"></a><span class="lineno"> 1633</span>&#160;        <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a3059ed7bfcfb692cbe8014d55fd7c1e4">get_geometry</a>(i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8936711f57f82d1fc75c21fa2894e1c6">CENT</a>,ptrgeom);</div>
<div class="line"><a name="l01634"></a><span class="lineno"> 1634</span>&#160;      </div>
<div class="line"><a name="l01635"></a><span class="lineno"> 1635</span>&#160;<span class="preprocessor">#if(WHICHVEL==VELREL4)</span></div>
<div class="line"><a name="l01636"></a><span class="lineno"> 1636</span>&#160;<span class="preprocessor"></span>        <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(gamma_calc(<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(pv,i,j,k),ptrgeom,&amp;<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(gammacheck,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>),&amp;qsq),<span class="stringliteral">&quot;fixup_checksolution: gamma calc failed\n&quot;</span>,<span class="stringliteral">&quot;fixup.c&quot;</span>,1);</div>
<div class="line"><a name="l01637"></a><span class="lineno"> 1637</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l01638"></a><span class="lineno"> 1638</span>&#160;<span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#afc93fd4a6f7a2b87a9315d5fba5a529c">ucon_calc</a>(<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(pv,i,j,k), ptrgeom, ucon, others) &gt;= 1)  <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a5febb92786c5f7a1479e7e65f1c23ef3">FAILSTATEMENT</a>(<span class="stringliteral">&quot;fixup.c:fixup_checksolution()&quot;</span>, <span class="stringliteral">&quot;ucon_calc()&quot;</span>, 1);</div>
<div class="line"><a name="l01639"></a><span class="lineno"> 1639</span>&#160;        <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(gammacheck,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>)=ucon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>];</div>
<div class="line"><a name="l01640"></a><span class="lineno"> 1640</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01641"></a><span class="lineno"> 1641</span>&#160;<span class="preprocessor"></span>      }<span class="comment">// end if 1</span></div>
<div class="line"><a name="l01642"></a><span class="lineno"> 1642</span>&#160;    }<span class="comment">// end 3D LOOP</span></div>
<div class="line"><a name="l01643"></a><span class="lineno"> 1643</span>&#160;  }<span class="comment">// end parallel region</span></div>
<div class="line"><a name="l01644"></a><span class="lineno"> 1644</span>&#160;</div>
<div class="line"><a name="l01645"></a><span class="lineno"> 1645</span>&#160;</div>
<div class="line"><a name="l01646"></a><span class="lineno"> 1646</span>&#160;</div>
<div class="line"><a name="l01647"></a><span class="lineno"> 1647</span>&#160;</div>
<div class="line"><a name="l01648"></a><span class="lineno"> 1648</span>&#160;</div>
<div class="line"><a name="l01649"></a><span class="lineno"> 1649</span>&#160;</div>
<div class="line"><a name="l01651"></a><span class="lineno"> 1651</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01652"></a><span class="lineno"> 1652</span>&#160;  <span class="comment">// see if percent differences (actually factors) are too large</span></div>
<div class="line"><a name="l01653"></a><span class="lineno"> 1653</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01655"></a><span class="lineno"> 1655</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01657"></a><span class="lineno"> 1657</span>&#160;<span class="preprocessor">#pragma omp parallel  // don&#39;t need copyin, doesn&#39;t currently use global non-array vars</span></div>
<div class="line"><a name="l01658"></a><span class="lineno"> 1658</span>&#160;<span class="preprocessor"></span>  {</div>
<div class="line"><a name="l01659"></a><span class="lineno"> 1659</span>&#160;    <span class="keywordtype">int</span> <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>,<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>,k;</div>
<div class="line"><a name="l01660"></a><span class="lineno"> 1660</span>&#160;    <span class="keywordtype">int</span> l;</div>
<div class="line"><a name="l01661"></a><span class="lineno"> 1661</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> percdiff[<a class="code" href="../../de/d95/fixup_8c.html#ac78101f2f05aee4b1a74e808d6dfa254">NUMCHECKS</a>][<a class="code" href="../../de/d95/fixup_8c.html#a17354bf5b5383aa1dd2a84ef3c491e61">MAXVOTES</a>];</div>
<div class="line"><a name="l01662"></a><span class="lineno"> 1662</span>&#160;    <span class="keywordtype">int</span> vote[<a class="code" href="../../de/d95/fixup_8c.html#ac78101f2f05aee4b1a74e808d6dfa254">NUMCHECKS</a>];</div>
<div class="line"><a name="l01663"></a><span class="lineno"> 1663</span>&#160;    <span class="keywordtype">int</span> numvotes[<a class="code" href="../../de/d95/fixup_8c.html#ac78101f2f05aee4b1a74e808d6dfa254">NUMCHECKS</a>];</div>
<div class="line"><a name="l01664"></a><span class="lineno"> 1664</span>&#160;    <span class="keywordtype">int</span> checkcondition[<a class="code" href="../../de/d95/fixup_8c.html#ac78101f2f05aee4b1a74e808d6dfa254">NUMCHECKS</a>];</div>
<div class="line"><a name="l01665"></a><span class="lineno"> 1665</span>&#160;    <span class="keywordtype">int</span> checki;</div>
<div class="line"><a name="l01666"></a><span class="lineno"> 1666</span>&#160;</div>
<div class="line"><a name="l01667"></a><span class="lineno"> 1667</span>&#160;    <a class="code" href="../../d5/d7b/global_8openmploops_8h.html#a1389db2daf5bd9e94918090c253a16c9">OPENMP3DLOOPVARSDEFINE</a>; <a class="code" href="../../d5/d7b/global_8openmploops_8h.html#a865b7d98f1e7cba888ee63d052621383" title="COMPZLOOP equivalent for OpenMP.">OPENMP3DLOOPSETUPZLOOP</a>;</div>
<div class="line"><a name="l01668"></a><span class="lineno"> 1668</span>&#160;</div>
<div class="line"><a name="l01669"></a><span class="lineno"> 1669</span>&#160;</div>
<div class="line"><a name="l01670"></a><span class="lineno"> 1670</span>&#160;<span class="preprocessor">#pragma omp for schedule(OPENMPSCHEDULE(),OPENMPCHUNKSIZE(blocksize))</span></div>
<div class="line"><a name="l01671"></a><span class="lineno"> 1671</span>&#160;<span class="preprocessor"></span>    <a class="code" href="../../d5/d7b/global_8openmploops_8h.html#a9e48537d3cb58cc3a3765b8a18b43b15" title="Oddly, performance changes by 10% when changing how start and stop blockijk (and fixing how used too ...">OPENMP3DLOOPBLOCK</a>{</div>
<div class="line"><a name="l01672"></a><span class="lineno"> 1672</span>&#160;      <a class="code" href="../../df/d1c/global_8storage_8h.html#a96983b0c56e836f50cb7c1af16f59fb6">OPENMP3DLOOPBLOCK2IJK</a>(i,j,k);</div>
<div class="line"><a name="l01673"></a><span class="lineno"> 1673</span>&#160;</div>
<div class="line"><a name="l01674"></a><span class="lineno"> 1674</span>&#160;</div>
<div class="line"><a name="l01675"></a><span class="lineno"> 1675</span>&#160;</div>
<div class="line"><a name="l01676"></a><span class="lineno"> 1676</span>&#160;      <span class="comment">// doesn&#39;t need bound of pflag since don&#39;t check pflag of surrounding values (assumes if comparing with failure point, failure point is reasonable afterwards if before)</span></div>
<div class="line"><a name="l01677"></a><span class="lineno"> 1677</span>&#160;      <span class="comment">//    if(1 || (GLOBALMACP0A1(pflag,i,j,k,FLAGBSQORHO)||GLOBALMACP0A1(pflag,i,j,k,FLAGBSQOU))&amp;&amp;(IFUTOPRIMFAILORFIXED(GLOBALMACP0A1(pflag,i,j,k,FLAGUTOPRIMFAIL)))){// if b^2/{rho,u}\gg 1 and not failure already, check if solution is reasonable</span></div>
<div class="line"><a name="l01678"></a><span class="lineno"> 1678</span>&#160;</div>
<div class="line"><a name="l01679"></a><span class="lineno"> 1679</span>&#160;      checkcondition[<a class="code" href="../../de/d95/fixup_8c.html#a66622da09337a2216daa3df71e34513d">ISGAMMACHECK</a>]=(<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(gammacheck,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>)&gt;=2.0);</div>
<div class="line"><a name="l01680"></a><span class="lineno"> 1680</span>&#160;      checkcondition[<a class="code" href="../../de/d95/fixup_8c.html#a0dd2a8968355aec0c8d35c011fc7f055">ISUUCHECK</a>]=1;</div>
<div class="line"><a name="l01681"></a><span class="lineno"> 1681</span>&#160;</div>
<div class="line"><a name="l01682"></a><span class="lineno"> 1682</span>&#160;      <span class="comment">// use fabs in case gamma&lt;0 or especially if u&lt;zerouuperbaryon*prim[RHO] that can easily happen</span></div>
<div class="line"><a name="l01683"></a><span class="lineno"> 1683</span>&#160;      <span class="keywordflow">if</span>(checkcondition[<a class="code" href="../../de/d95/fixup_8c.html#a66622da09337a2216daa3df71e34513d">ISGAMMACHECK</a>]){</div>
<div class="line"><a name="l01684"></a><span class="lineno"> 1684</span>&#160;        percdiff[<a class="code" href="../../de/d95/fixup_8c.html#a66622da09337a2216daa3df71e34513d">ISGAMMACHECK</a>][0]=(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afaacb1c256e44ec7be2adaac65713f2b">IFUTOPRIMNOFAILORFIXED</a>(GLOBALMACP0A1(pflag,i,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a3e64aa2cd3c5e0933e74fa4e7a925570">jp1mac</a>(j),k,FLAGUTOPRIMFAIL))) ? fabs(<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(gammacheck,i,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a3e64aa2cd3c5e0933e74fa4e7a925570">jp1mac</a>(j),k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>)/<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(gammacheck,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>)) : -1;</div>
<div class="line"><a name="l01685"></a><span class="lineno"> 1685</span>&#160;        percdiff[<a class="code" href="../../de/d95/fixup_8c.html#a66622da09337a2216daa3df71e34513d">ISGAMMACHECK</a>][1]=(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afaacb1c256e44ec7be2adaac65713f2b">IFUTOPRIMNOFAILORFIXED</a>(GLOBALMACP0A1(pflag,i,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),k,FLAGUTOPRIMFAIL))) ? fabs(<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(gammacheck,i,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>)/<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(gammacheck,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>)) : -1;</div>
<div class="line"><a name="l01686"></a><span class="lineno"> 1686</span>&#160;        percdiff[<a class="code" href="../../de/d95/fixup_8c.html#a66622da09337a2216daa3df71e34513d">ISGAMMACHECK</a>][2]=(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afaacb1c256e44ec7be2adaac65713f2b">IFUTOPRIMNOFAILORFIXED</a>(GLOBALMACP0A1(pflag,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a27e1e0a92af691ffd03d7e9d0a628392">ip1mac</a>(i),j,k,FLAGUTOPRIMFAIL))) ? fabs(<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(gammacheck,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a27e1e0a92af691ffd03d7e9d0a628392">ip1mac</a>(i),j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>)/<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(gammacheck,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>)) : -1;</div>
<div class="line"><a name="l01687"></a><span class="lineno"> 1687</span>&#160;        percdiff[<a class="code" href="../../de/d95/fixup_8c.html#a66622da09337a2216daa3df71e34513d">ISGAMMACHECK</a>][3]=(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afaacb1c256e44ec7be2adaac65713f2b">IFUTOPRIMNOFAILORFIXED</a>(GLOBALMACP0A1(pflag,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),j,k,FLAGUTOPRIMFAIL))) ? fabs(<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(gammacheck,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>)/<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(gammacheck,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>)) : -1;</div>
<div class="line"><a name="l01688"></a><span class="lineno"> 1688</span>&#160;</div>
<div class="line"><a name="l01689"></a><span class="lineno"> 1689</span>&#160;        percdiff[<a class="code" href="../../de/d95/fixup_8c.html#a66622da09337a2216daa3df71e34513d">ISGAMMACHECK</a>][4]=(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afaacb1c256e44ec7be2adaac65713f2b">IFUTOPRIMNOFAILORFIXED</a>(GLOBALMACP0A1(pflag,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a27e1e0a92af691ffd03d7e9d0a628392">ip1mac</a>(i),<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a3e64aa2cd3c5e0933e74fa4e7a925570">jp1mac</a>(j),k,FLAGUTOPRIMFAIL))) ? fabs(<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(gammacheck,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a27e1e0a92af691ffd03d7e9d0a628392">ip1mac</a>(i),<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a3e64aa2cd3c5e0933e74fa4e7a925570">jp1mac</a>(j),k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>)/<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(gammacheck,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>)) : -1;</div>
<div class="line"><a name="l01690"></a><span class="lineno"> 1690</span>&#160;        percdiff[<a class="code" href="../../de/d95/fixup_8c.html#a66622da09337a2216daa3df71e34513d">ISGAMMACHECK</a>][5]=(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afaacb1c256e44ec7be2adaac65713f2b">IFUTOPRIMNOFAILORFIXED</a>(GLOBALMACP0A1(pflag,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a27e1e0a92af691ffd03d7e9d0a628392">ip1mac</a>(i),<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),k,FLAGUTOPRIMFAIL))) ? fabs(<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(gammacheck,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a27e1e0a92af691ffd03d7e9d0a628392">ip1mac</a>(i),<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>)/<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(gammacheck,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>)) : -1;</div>
<div class="line"><a name="l01691"></a><span class="lineno"> 1691</span>&#160;        percdiff[<a class="code" href="../../de/d95/fixup_8c.html#a66622da09337a2216daa3df71e34513d">ISGAMMACHECK</a>][6]=(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afaacb1c256e44ec7be2adaac65713f2b">IFUTOPRIMNOFAILORFIXED</a>(GLOBALMACP0A1(pflag,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a27e1e0a92af691ffd03d7e9d0a628392">ip1mac</a>(i),<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a3e64aa2cd3c5e0933e74fa4e7a925570">jp1mac</a>(j),k,FLAGUTOPRIMFAIL))) ? fabs(<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(gammacheck,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a27e1e0a92af691ffd03d7e9d0a628392">ip1mac</a>(i),<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a3e64aa2cd3c5e0933e74fa4e7a925570">jp1mac</a>(j),k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>)/<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(gammacheck,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>)) : -1;</div>
<div class="line"><a name="l01692"></a><span class="lineno"> 1692</span>&#160;        percdiff[<a class="code" href="../../de/d95/fixup_8c.html#a66622da09337a2216daa3df71e34513d">ISGAMMACHECK</a>][7]=(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afaacb1c256e44ec7be2adaac65713f2b">IFUTOPRIMNOFAILORFIXED</a>(GLOBALMACP0A1(pflag,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),k,FLAGUTOPRIMFAIL))) ? fabs(<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(gammacheck,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>)/<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(gammacheck,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>)) : -1;</div>
<div class="line"><a name="l01693"></a><span class="lineno"> 1693</span>&#160;      }</div>
<div class="line"><a name="l01694"></a><span class="lineno"> 1694</span>&#160;      </div>
<div class="line"><a name="l01695"></a><span class="lineno"> 1695</span>&#160;      <span class="keywordflow">if</span>(checkcondition[<a class="code" href="../../de/d95/fixup_8c.html#a0dd2a8968355aec0c8d35c011fc7f055">ISUUCHECK</a>]){</div>
<div class="line"><a name="l01696"></a><span class="lineno"> 1696</span>&#160;        percdiff[<a class="code" href="../../de/d95/fixup_8c.html#a0dd2a8968355aec0c8d35c011fc7f055">ISUUCHECK</a>][0]=(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afaacb1c256e44ec7be2adaac65713f2b">IFUTOPRIMNOFAILORFIXED</a>(GLOBALMACP0A1(pflag,i,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a3e64aa2cd3c5e0933e74fa4e7a925570">jp1mac</a>(j),k,FLAGUTOPRIMFAIL))) ? fabs(<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a3e64aa2cd3c5e0933e74fa4e7a925570">jp1mac</a>(j),k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>)/<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>)) : -1;</div>
<div class="line"><a name="l01697"></a><span class="lineno"> 1697</span>&#160;        percdiff[<a class="code" href="../../de/d95/fixup_8c.html#a0dd2a8968355aec0c8d35c011fc7f055">ISUUCHECK</a>][1]=(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afaacb1c256e44ec7be2adaac65713f2b">IFUTOPRIMNOFAILORFIXED</a>(GLOBALMACP0A1(pflag,i,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),k,FLAGUTOPRIMFAIL))) ? fabs(<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>)/<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>)) : -1;</div>
<div class="line"><a name="l01698"></a><span class="lineno"> 1698</span>&#160;        percdiff[<a class="code" href="../../de/d95/fixup_8c.html#a0dd2a8968355aec0c8d35c011fc7f055">ISUUCHECK</a>][2]=(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afaacb1c256e44ec7be2adaac65713f2b">IFUTOPRIMNOFAILORFIXED</a>(GLOBALMACP0A1(pflag,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a27e1e0a92af691ffd03d7e9d0a628392">ip1mac</a>(i),j,k,FLAGUTOPRIMFAIL))) ? fabs(<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a27e1e0a92af691ffd03d7e9d0a628392">ip1mac</a>(i),j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>)/<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>)) : -1;</div>
<div class="line"><a name="l01699"></a><span class="lineno"> 1699</span>&#160;        percdiff[<a class="code" href="../../de/d95/fixup_8c.html#a0dd2a8968355aec0c8d35c011fc7f055">ISUUCHECK</a>][3]=(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afaacb1c256e44ec7be2adaac65713f2b">IFUTOPRIMNOFAILORFIXED</a>(GLOBALMACP0A1(pflag,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),j,k,FLAGUTOPRIMFAIL))) ? fabs(<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>)/<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>)) : -1;</div>
<div class="line"><a name="l01700"></a><span class="lineno"> 1700</span>&#160;      </div>
<div class="line"><a name="l01701"></a><span class="lineno"> 1701</span>&#160;        percdiff[<a class="code" href="../../de/d95/fixup_8c.html#a0dd2a8968355aec0c8d35c011fc7f055">ISUUCHECK</a>][4]=(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afaacb1c256e44ec7be2adaac65713f2b">IFUTOPRIMNOFAILORFIXED</a>(GLOBALMACP0A1(pflag,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a27e1e0a92af691ffd03d7e9d0a628392">ip1mac</a>(i),<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a3e64aa2cd3c5e0933e74fa4e7a925570">jp1mac</a>(j),k,FLAGUTOPRIMFAIL))) ? fabs(<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a27e1e0a92af691ffd03d7e9d0a628392">ip1mac</a>(i),<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a3e64aa2cd3c5e0933e74fa4e7a925570">jp1mac</a>(j),k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>)/<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>)) : -1;</div>
<div class="line"><a name="l01702"></a><span class="lineno"> 1702</span>&#160;        percdiff[<a class="code" href="../../de/d95/fixup_8c.html#a0dd2a8968355aec0c8d35c011fc7f055">ISUUCHECK</a>][5]=(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afaacb1c256e44ec7be2adaac65713f2b">IFUTOPRIMNOFAILORFIXED</a>(GLOBALMACP0A1(pflag,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a27e1e0a92af691ffd03d7e9d0a628392">ip1mac</a>(i),<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),k,FLAGUTOPRIMFAIL))) ? fabs(<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a27e1e0a92af691ffd03d7e9d0a628392">ip1mac</a>(i),<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>)/<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>)) : -1;</div>
<div class="line"><a name="l01703"></a><span class="lineno"> 1703</span>&#160;        percdiff[<a class="code" href="../../de/d95/fixup_8c.html#a0dd2a8968355aec0c8d35c011fc7f055">ISUUCHECK</a>][6]=(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afaacb1c256e44ec7be2adaac65713f2b">IFUTOPRIMNOFAILORFIXED</a>(GLOBALMACP0A1(pflag,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a27e1e0a92af691ffd03d7e9d0a628392">ip1mac</a>(i),<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a3e64aa2cd3c5e0933e74fa4e7a925570">jp1mac</a>(j),k,FLAGUTOPRIMFAIL))) ? fabs(<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a27e1e0a92af691ffd03d7e9d0a628392">ip1mac</a>(i),<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a3e64aa2cd3c5e0933e74fa4e7a925570">jp1mac</a>(j),k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>)/<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>)) : -1;</div>
<div class="line"><a name="l01704"></a><span class="lineno"> 1704</span>&#160;        percdiff[<a class="code" href="../../de/d95/fixup_8c.html#a0dd2a8968355aec0c8d35c011fc7f055">ISUUCHECK</a>][7]=(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afaacb1c256e44ec7be2adaac65713f2b">IFUTOPRIMNOFAILORFIXED</a>(GLOBALMACP0A1(pflag,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),k,FLAGUTOPRIMFAIL))) ? fabs(<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>)/<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>)) : -1;</div>
<div class="line"><a name="l01705"></a><span class="lineno"> 1705</span>&#160;      }</div>
<div class="line"><a name="l01706"></a><span class="lineno"> 1706</span>&#160;</div>
<div class="line"><a name="l01708"></a><span class="lineno"> 1708</span>&#160;      <span class="comment">//</span></div>
<div class="line"><a name="l01709"></a><span class="lineno"> 1709</span>&#160;      <span class="comment">// determine how many votes</span></div>
<div class="line"><a name="l01710"></a><span class="lineno"> 1710</span>&#160;      <span class="comment">//</span></div>
<div class="line"><a name="l01712"></a><span class="lineno"> 1712</span>&#160;<span class="comment"></span>      <span class="keywordflow">for</span>(checki=0;checki&lt;<a class="code" href="../../de/d95/fixup_8c.html#ac78101f2f05aee4b1a74e808d6dfa254">NUMCHECKS</a>;checki++){</div>
<div class="line"><a name="l01713"></a><span class="lineno"> 1713</span>&#160;        vote[checki]=0;</div>
<div class="line"><a name="l01714"></a><span class="lineno"> 1714</span>&#160;        numvotes[checki]=0;</div>
<div class="line"><a name="l01715"></a><span class="lineno"> 1715</span>&#160;      }</div>
<div class="line"><a name="l01716"></a><span class="lineno"> 1716</span>&#160;      <span class="keywordflow">for</span>(l=0;l&lt;<a class="code" href="../../de/d95/fixup_8c.html#a17354bf5b5383aa1dd2a84ef3c491e61">MAXVOTES</a>;l++){</div>
<div class="line"><a name="l01717"></a><span class="lineno"> 1717</span>&#160;        <span class="comment">// No vote for failed zones</span></div>
<div class="line"><a name="l01718"></a><span class="lineno"> 1718</span>&#160;        <span class="keywordflow">if</span>(checkcondition[ISGAMMACHECK] &amp;&amp; percdiff[ISGAMMACHECK][l]&gt;=0.0){</div>
<div class="line"><a name="l01719"></a><span class="lineno"> 1719</span>&#160;          <span class="keywordflow">if</span>( (fabs(percdiff[ISGAMMACHECK][l])&gt;<a class="code" href="../../da/d3e/definit_8h.html#a3a4b054f7332879818cc5c3d9c2b3c7c" title="factor by which zone-zone values can be different for  and internal energy, used of CHECKSOLUTION==1...">GAMMAPERCDIFFMAX</a>)||(fabs(percdiff[ISGAMMACHECK][l])&lt;1.0/<a class="code" href="../../da/d3e/definit_8h.html#a3a4b054f7332879818cc5c3d9c2b3c7c" title="factor by which zone-zone values can be different for  and internal energy, used of CHECKSOLUTION==1...">GAMMAPERCDIFFMAX</a>) ) vote[<a class="code" href="../../de/d95/fixup_8c.html#a66622da09337a2216daa3df71e34513d">ISGAMMACHECK</a>]++;</div>
<div class="line"><a name="l01720"></a><span class="lineno"> 1720</span>&#160;          numvotes[<a class="code" href="../../de/d95/fixup_8c.html#a66622da09337a2216daa3df71e34513d">ISGAMMACHECK</a>]++;</div>
<div class="line"><a name="l01721"></a><span class="lineno"> 1721</span>&#160;        }</div>
<div class="line"><a name="l01722"></a><span class="lineno"> 1722</span>&#160;        <span class="keywordflow">if</span>(checkcondition[ISUUCHECK] &amp;&amp; percdiff[ISUUCHECK][l]&gt;=0.0){</div>
<div class="line"><a name="l01723"></a><span class="lineno"> 1723</span>&#160;          <span class="keywordflow">if</span>((<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#abc7fe8413995280e1b65fa54885bf547">DOEVOLVEUU</a>)&amp;&amp; ((fabs(percdiff[ISUUCHECK][l])&gt;<a class="code" href="../../da/d3e/definit_8h.html#abd5d4129dd0e995827a13a17b640729a">UPERCDIFFMAX</a>)||(fabs(percdiff[ISUUCHECK][l])&lt;1.0/<a class="code" href="../../da/d3e/definit_8h.html#abd5d4129dd0e995827a13a17b640729a">UPERCDIFFMAX</a>)) ) vote[ISUUCHECK]++;</div>
<div class="line"><a name="l01724"></a><span class="lineno"> 1724</span>&#160;          numvotes[<a class="code" href="../../de/d95/fixup_8c.html#a0dd2a8968355aec0c8d35c011fc7f055">ISUUCHECK</a>]++;</div>
<div class="line"><a name="l01725"></a><span class="lineno"> 1725</span>&#160;        }</div>
<div class="line"><a name="l01726"></a><span class="lineno"> 1726</span>&#160;      }</div>
<div class="line"><a name="l01727"></a><span class="lineno"> 1727</span>&#160;</div>
<div class="line"><a name="l01729"></a><span class="lineno"> 1729</span>&#160;      <span class="comment">//    </span></div>
<div class="line"><a name="l01730"></a><span class="lineno"> 1730</span>&#160;      <span class="comment">// Use majority rule:  This allows shock fronts, but no faster members.</span></div>
<div class="line"><a name="l01731"></a><span class="lineno"> 1731</span>&#160;      <span class="comment">// Don&#39;t include failures in voting process (either count or total voting)</span></div>
<div class="line"><a name="l01732"></a><span class="lineno"> 1732</span>&#160;      <span class="comment">// &gt; is used in case degenerate condition 0&gt;0 so if no votes and no total, then do nothing</span></div>
<div class="line"><a name="l01733"></a><span class="lineno"> 1733</span>&#160;      <span class="comment">//</span></div>
<div class="line"><a name="l01735"></a><span class="lineno"> 1735</span>&#160;<span class="comment"></span>      checki=<a class="code" href="../../de/d95/fixup_8c.html#a66622da09337a2216daa3df71e34513d">ISGAMMACHECK</a>;</div>
<div class="line"><a name="l01736"></a><span class="lineno"> 1736</span>&#160;      <span class="keywordflow">if</span>(checkcondition[checki] &amp;&amp; (vote[checki]&gt;numvotes[checki]*0.5)){</div>
<div class="line"><a name="l01737"></a><span class="lineno"> 1737</span>&#160;        <span class="comment">// then majority rules</span></div>
<div class="line"><a name="l01738"></a><span class="lineno"> 1738</span>&#160;        <span class="comment">// stderrfprintf(&quot;caught one-0: %d %d\n&quot;,i,j);</span></div>
<div class="line"><a name="l01739"></a><span class="lineno"> 1739</span>&#160;        GLOBALMACP0A1(pflag,i,j,k,FLAGUTOPRIMFAIL)=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ad6ba8deb8dab694606b9f4a79845aada">UTOPRIMFAILGAMMAPERC</a>;</div>
<div class="line"><a name="l01740"></a><span class="lineno"> 1740</span>&#160;      }</div>
<div class="line"><a name="l01741"></a><span class="lineno"> 1741</span>&#160;      checki=<a class="code" href="../../de/d95/fixup_8c.html#a0dd2a8968355aec0c8d35c011fc7f055">ISUUCHECK</a>;</div>
<div class="line"><a name="l01742"></a><span class="lineno"> 1742</span>&#160;      <span class="keywordflow">if</span>(checkcondition[checki] &amp;&amp; (vote[checki]&gt;numvotes[checki]*0.5)){</div>
<div class="line"><a name="l01743"></a><span class="lineno"> 1743</span>&#160;        <span class="comment">// then majority rules</span></div>
<div class="line"><a name="l01744"></a><span class="lineno"> 1744</span>&#160;        <span class="comment">// stderrfprintf(&quot;caught one-1: %d %d\n&quot;,i,j);</span></div>
<div class="line"><a name="l01745"></a><span class="lineno"> 1745</span>&#160;        GLOBALMACP0A1(pflag,i,j,k,FLAGUTOPRIMFAIL)=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a58149f1f58f5a6b52e613a93c22efe30">UTOPRIMFAILUPERC</a>;</div>
<div class="line"><a name="l01746"></a><span class="lineno"> 1746</span>&#160;      }</div>
<div class="line"><a name="l01747"></a><span class="lineno"> 1747</span>&#160;</div>
<div class="line"><a name="l01748"></a><span class="lineno"> 1748</span>&#160;    }<span class="comment">// end COMPZLOOP</span></div>
<div class="line"><a name="l01749"></a><span class="lineno"> 1749</span>&#160;  }<span class="comment">// end parallel region</span></div>
<div class="line"><a name="l01750"></a><span class="lineno"> 1750</span>&#160;</div>
<div class="line"><a name="l01751"></a><span class="lineno"> 1751</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l01752"></a><span class="lineno"> 1752</span>&#160;}</div>
<div class="line"><a name="l01753"></a><span class="lineno"> 1753</span>&#160;</div>
<div class="line"><a name="l01754"></a><span class="lineno"> 1754</span>&#160;</div>
<div class="line"><a name="l01755"></a><span class="lineno"> 1755</span>&#160;</div>
<div class="line"><a name="l01756"></a><span class="lineno"> 1756</span>&#160;</div>
<div class="line"><a name="l01757"></a><span class="lineno"> 1757</span>&#160;</div>
<div class="line"><a name="l01758"></a><span class="lineno"> 1758</span>&#160;</div>
<div class="line"><a name="l01759"></a><span class="lineno"> 1759</span>&#160;</div>
<div class="line"><a name="l01760"></a><span class="lineno"> 1760</span>&#160;</div>
<div class="line"><a name="l01761"></a><span class="lineno"> 1761</span>&#160;</div>
<div class="line"><a name="l01762"></a><span class="lineno"> 1762</span>&#160;</div>
<div class="line"><a name="l01763"></a><span class="lineno"> 1763</span>&#160;</div>
<div class="line"><a name="l01764"></a><span class="lineno"> 1764</span>&#160;</div>
<div class="line"><a name="l01765"></a><span class="lineno"> 1765</span>&#160;</div>
<div class="line"><a name="l01766"></a><span class="lineno"> 1766</span>&#160;<span class="preprocessor">#if(MPIEQUALNONMPI==1)</span></div>
<div class="line"><a name="l01767"></a><span class="lineno"> 1767</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define ORDERINDEPENDENT 1 // no choice</span></div>
<div class="line"><a name="l01768"></a><span class="lineno"> 1768</span>&#160;<span class="preprocessor"></span><span class="comment">// whether fixup_utoprim should be order-independent or not</span></div>
<div class="line"><a name="l01769"></a><span class="lineno"> 1769</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l01770"></a><span class="lineno"><a class="code" href="../../de/d95/fixup_8c.html#abda4dfa491b7b19fde55b450bd3eff77"> 1770</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define ORDERINDEPENDENT 1 // NO choice anymore, with fixup done before assigning initial D0, gamma, etc.</span></div>
<div class="line"><a name="l01771"></a><span class="lineno"> 1771</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01772"></a><span class="lineno"> 1772</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01773"></a><span class="lineno"> 1773</span>&#160;<span class="comment">// whether to do specific chosen points for averages or do maximal average</span></div>
<div class="line"><a name="l01774"></a><span class="lineno"><a class="code" href="../../de/d95/fixup_8c.html#a931229567debd7f1a1ec868b3ec722dc"> 1774</a></span>&#160;<span class="preprocessor">#define GENERALAVERAGE 1</span></div>
<div class="line"><a name="l01775"></a><span class="lineno"> 1775</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01776"></a><span class="lineno"> 1776</span>&#160;<span class="comment">// whether to conserve D when averaging (uses original D to keep D constant -- less problematic compared to how used in limit_gamma() where original \gamma might be quite large)</span></div>
<div class="line"><a name="l01777"></a><span class="lineno"> 1777</span>&#160;<span class="comment">// This is probably not useful</span></div>
<div class="line"><a name="l01778"></a><span class="lineno"> 1778</span>&#160;<span class="comment">// More useful to use conserved D from unew as reference D0 so particle mass really conserved -- and this is ok compared to limit_gamma since newly averaged 4-velocity will not imply a large \gamma (unless averaging nearly failed regions!)</span></div>
<div class="line"><a name="l01779"></a><span class="lineno"> 1779</span>&#160;<span class="comment">// Also, during failure, can&#39;t assume mass can be so easily conserved and D might be bad</span></div>
<div class="line"><a name="l01780"></a><span class="lineno"> 1780</span>&#160;<span class="comment">// So disable for now</span></div>
<div class="line"><a name="l01781"></a><span class="lineno"> 1781</span>&#160;<span class="comment">// enable for finalstep for YFL, but for RHO causes high gamma fixed in regions, so disable for that</span></div>
<div class="line"><a name="l01782"></a><span class="lineno"><a class="code" href="../../de/d95/fixup_8c.html#a87882c2666708d89915909a258021528"> 1782</a></span>&#160;<span class="preprocessor">#define DO_CONSERVE_D_INFAILFIXUPS (0&amp;&amp;finalstep==1 &amp;&amp; (SCALARPL(pl))) // not pl==RHO</span></div>
<div class="line"><a name="l01783"></a><span class="lineno"> 1783</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01784"></a><span class="lineno"><a class="code" href="../../de/d95/fixup_8c.html#aa9d04e5483d7cc6a8e71924763748705"> 1784</a></span>&#160;<span class="preprocessor">#define HANDLEUNEG 0</span></div>
<div class="line"><a name="l01785"></a><span class="lineno"> 1785</span>&#160;<span class="preprocessor"></span><span class="comment">// seems to keep failing with this, so probably treating u&lt;zerouuperbaryon*prim[RHO] like failure is better idea</span></div>
<div class="line"><a name="l01786"></a><span class="lineno"> 1786</span>&#160;<span class="comment">// 0: treat as full failure</span></div>
<div class="line"><a name="l01787"></a><span class="lineno"> 1787</span>&#160;<span class="comment">// 1: treat as floor issue</span></div>
<div class="line"><a name="l01788"></a><span class="lineno"> 1788</span>&#160;</div>
<div class="line"><a name="l01789"></a><span class="lineno"><a class="code" href="../../de/d95/fixup_8c.html#a9a6f871146b8c53c825eb272435083d5"> 1789</a></span>&#160;<span class="preprocessor">#define HANDLERHONEG 0</span></div>
<div class="line"><a name="l01790"></a><span class="lineno"> 1790</span>&#160;<span class="preprocessor"></span><span class="comment">// seems to keep failing with this, so probably treating rho&lt;0 like failure is better idea</span></div>
<div class="line"><a name="l01791"></a><span class="lineno"> 1791</span>&#160;<span class="comment">// 0: treat as full failure</span></div>
<div class="line"><a name="l01792"></a><span class="lineno"> 1792</span>&#160;<span class="comment">// 1: treat as floor issue</span></div>
<div class="line"><a name="l01793"></a><span class="lineno"> 1793</span>&#160;</div>
<div class="line"><a name="l01794"></a><span class="lineno"><a class="code" href="../../de/d95/fixup_8c.html#a7500256c2ba86b67ce5059a9b525e7ef"> 1794</a></span>&#160;<span class="preprocessor">#define HANDLERHOUNEG 0</span></div>
<div class="line"><a name="l01795"></a><span class="lineno"> 1795</span>&#160;<span class="preprocessor"></span><span class="comment">// seems to keep failing with this, so probably treating rho&lt;0 like failure is better idea</span></div>
<div class="line"><a name="l01796"></a><span class="lineno"> 1796</span>&#160;<span class="comment">// 0: treat as full failure</span></div>
<div class="line"><a name="l01797"></a><span class="lineno"> 1797</span>&#160;<span class="comment">// 1: treat as floor issue</span></div>
<div class="line"><a name="l01798"></a><span class="lineno"> 1798</span>&#160;</div>
<div class="line"><a name="l01799"></a><span class="lineno"> 1799</span>&#160;</div>
<div class="line"><a name="l01802"></a><span class="lineno"> 1802</span>&#160;<span class="keywordtype">int</span> fixup_utoprim(<span class="keywordtype">int</span> stage, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pv)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pbackup)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*ucons)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR], <span class="keywordtype">int</span> finalstep)</div>
<div class="line"><a name="l01803"></a><span class="lineno"> 1803</span>&#160;{</div>
<div class="line"><a name="l01804"></a><span class="lineno"> 1804</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*ptoavg)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR];</div>
<div class="line"><a name="l01805"></a><span class="lineno"> 1805</span>&#160;  <span class="keyword">extern</span> <span class="keywordtype">void</span> get_advance_startendindices(<span class="keywordtype">int</span> *is,<span class="keywordtype">int</span> *ie,<span class="keywordtype">int</span> *js,<span class="keywordtype">int</span> *je,<span class="keywordtype">int</span> *ks,<span class="keywordtype">int</span> *ke);</div>
<div class="line"><a name="l01806"></a><span class="lineno"> 1806</span>&#160;  <span class="keywordtype">int</span> is,ie,js,je,ks,ke;</div>
<div class="line"><a name="l01807"></a><span class="lineno"> 1807</span>&#160;</div>
<div class="line"><a name="l01808"></a><span class="lineno"> 1808</span>&#160;</div>
<div class="line"><a name="l01809"></a><span class="lineno"> 1809</span>&#160;</div>
<div class="line"><a name="l01810"></a><span class="lineno"> 1810</span>&#160;</div>
<div class="line"><a name="l01811"></a><span class="lineno"> 1811</span>&#160;  <span class="comment">// this average only works if using 4 velocity since only then guaranteed solution is good after interpolation</span></div>
<div class="line"><a name="l01812"></a><span class="lineno"> 1812</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#a3d14480f30d39eff4e51ae8bc93df56f" title="whether we use ultimately precise inversion or &quot;workable&quot; inversion precision (see utoprim&#39;s for ho...">WHICHVEL</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a22de13ceb1d46983868c7f22fbd0201a">VEL3</a>) <span class="keywordflow">return</span>(0); <span class="comment">// just stick with static, best can do</span></div>
<div class="line"><a name="l01813"></a><span class="lineno"> 1813</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#a87e5572748e4cc27373e50bd78e6f2e8">EOMTYPE</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6f6094bc467dc61f9490ad7e1de63580">EOMFFDE</a> || <a class="code" href="../../da/d3e/definit_8h.html#a87e5572748e4cc27373e50bd78e6f2e8">EOMTYPE</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a30a753538ac3bf4801ac123a37dfcc57">EOMFFDE2</a>) <span class="keywordflow">return</span>(0); <span class="comment">// nothing to do</span></div>
<div class="line"><a name="l01814"></a><span class="lineno"> 1814</span>&#160;</div>
<div class="line"><a name="l01815"></a><span class="lineno"> 1815</span>&#160;</div>
<div class="line"><a name="l01816"></a><span class="lineno"> 1816</span>&#160;</div>
<div class="line"><a name="l01817"></a><span class="lineno"> 1817</span>&#160;</div>
<div class="line"><a name="l01818"></a><span class="lineno"> 1818</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../de/d95/fixup_8c.html#abda4dfa491b7b19fde55b450bd3eff77">ORDERINDEPENDENT</a>){</div>
<div class="line"><a name="l01819"></a><span class="lineno"> 1819</span>&#160;    <span class="comment">// then on the right-side of equations should appear ptoavg and on left side pv</span></div>
<div class="line"><a name="l01820"></a><span class="lineno"> 1820</span>&#160;    <span class="comment">// put another way, ptoavg contains constant thing never to be modified.  Usually then, pv is never used except to have something assigned to it, but could be conditions and such post-assignment that modifies the assignment but NOT the behavior of the routine otherwise.</span></div>
<div class="line"><a name="l01821"></a><span class="lineno"> 1821</span>&#160;    ptoavg=<a class="code" href="../../df/d1c/global_8storage_8h.html#ad89dafa5d772b862a44b0f576983ead3" title="shifted pointer (a_s_) wrappers Couldn&#39;t figure out how to macrofy a_s_ or a_, so when changing have ...">GLOBALPOINT</a>(ptemparray);</div>
<div class="line"><a name="l01822"></a><span class="lineno"> 1822</span>&#160;    <span class="comment">// ptemparray is used since in step_ch.c not needed after each advance()</span></div>
<div class="line"><a name="l01823"></a><span class="lineno"> 1823</span>&#160;    <span class="comment">// ptemparray is template for values used to fixup failures.</span></div>
<div class="line"><a name="l01824"></a><span class="lineno"> 1824</span>&#160;    <span class="comment">// In fixup-loop below, only change/fixup pv, not prc.  Otherwise order-dependent and not MPI friendly</span></div>
<div class="line"><a name="l01825"></a><span class="lineno"> 1825</span>&#160;    <span class="comment">// ptoavg is only used for surrounding zones used to fixup local zone</span></div>
<div class="line"><a name="l01826"></a><span class="lineno"> 1826</span>&#160;    <span class="comment">//LOOPXalldir</span></div>
<div class="line"><a name="l01827"></a><span class="lineno"> 1827</span>&#160;</div>
<div class="line"><a name="l01828"></a><span class="lineno"> 1828</span>&#160;    get_inversion_startendindices(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ab5c60dcb37b1f7e5642525031cd5cbcf">Uconsevolveloop</a>,&amp;is,&amp;ie,&amp;js,&amp;je,&amp;ks,&amp;ke);</div>
<div class="line"><a name="l01829"></a><span class="lineno"> 1829</span>&#160;    </div>
<div class="line"><a name="l01830"></a><span class="lineno"> 1830</span>&#160;    <span class="comment">// +-NUMPFLAGBNDx extra so can do check</span></div>
<div class="line"><a name="l01831"></a><span class="lineno"> 1831</span>&#160;    is += -<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#aad70b682862be003c6e5785df344c708">NUMPFLAGBND1</a>;</div>
<div class="line"><a name="l01832"></a><span class="lineno"> 1832</span>&#160;    ie += +<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#aad70b682862be003c6e5785df344c708">NUMPFLAGBND1</a>;</div>
<div class="line"><a name="l01833"></a><span class="lineno"> 1833</span>&#160;    js += -<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a085da7f203f487d6c8bf51fd67f72002">NUMPFLAGBND2</a>;</div>
<div class="line"><a name="l01834"></a><span class="lineno"> 1834</span>&#160;    je += +<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a085da7f203f487d6c8bf51fd67f72002">NUMPFLAGBND2</a>;</div>
<div class="line"><a name="l01835"></a><span class="lineno"> 1835</span>&#160;    ks += -<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#af3ec27b51afe3809a504884d90c6aca3">NUMPFLAGBND3</a>;</div>
<div class="line"><a name="l01836"></a><span class="lineno"> 1836</span>&#160;    ke += +<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#af3ec27b51afe3809a504884d90c6aca3">NUMPFLAGBND3</a>;</div>
<div class="line"><a name="l01837"></a><span class="lineno"> 1837</span>&#160;</div>
<div class="line"><a name="l01839"></a><span class="lineno"> 1839</span>&#160;    copy_3dnpr(is,ie,js,je,ks,ke,pv,ptoavg); <span class="comment">// GODMARK: Won&#39;t PLOOP be PALLLOOP here, so ok?</span></div>
<div class="line"><a name="l01840"></a><span class="lineno"> 1840</span>&#160;  }</div>
<div class="line"><a name="l01841"></a><span class="lineno"> 1841</span>&#160;  <span class="keywordflow">else</span> ptoavg=pv;</div>
<div class="line"><a name="l01842"></a><span class="lineno"> 1842</span>&#160;</div>
<div class="line"><a name="l01844"></a><span class="lineno"> 1844</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01845"></a><span class="lineno"> 1845</span>&#160;  <span class="comment">// Save original pflag before changed.  This ensures thread-safety</span></div>
<div class="line"><a name="l01846"></a><span class="lineno"> 1846</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01848"></a><span class="lineno"> 1848</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01849"></a><span class="lineno"> 1849</span>&#160;  <span class="comment">// shouldn&#39;t modify pflagfailorig once inside parallel region below</span></div>
<div class="line"><a name="l01850"></a><span class="lineno"> 1850</span>&#160;  <span class="comment">// Should only modify final (true) pflag value</span></div>
<div class="line"><a name="l01851"></a><span class="lineno"> 1851</span>&#160;  <span class="comment">// only copies fail flags</span></div>
<div class="line"><a name="l01852"></a><span class="lineno"> 1852</span>&#160;  copy_3dpftype_special_fullloop(<a class="code" href="../../df/d1c/global_8storage_8h.html#ad89dafa5d772b862a44b0f576983ead3" title="shifted pointer (a_s_) wrappers Couldn&#39;t figure out how to macrofy a_s_ or a_, so when changing have ...">GLOBALPOINT</a>(pflag),<a class="code" href="../../df/d1c/global_8storage_8h.html#ad89dafa5d772b862a44b0f576983ead3" title="shifted pointer (a_s_) wrappers Couldn&#39;t figure out how to macrofy a_s_ or a_, so when changing have ...">GLOBALPOINT</a>(pflagfailorig));</div>
<div class="line"><a name="l01853"></a><span class="lineno"> 1853</span>&#160;</div>
<div class="line"><a name="l01854"></a><span class="lineno"> 1854</span>&#160;</div>
<div class="line"><a name="l01855"></a><span class="lineno"> 1855</span>&#160;</div>
<div class="line"><a name="l01856"></a><span class="lineno"> 1856</span>&#160;</div>
<div class="line"><a name="l01857"></a><span class="lineno"> 1857</span>&#160;</div>
<div class="line"><a name="l01859"></a><span class="lineno"> 1859</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01860"></a><span class="lineno"> 1860</span>&#160;  <span class="comment">// first check for bad solutions and try to fix based upon average surrounding solution</span></div>
<div class="line"><a name="l01861"></a><span class="lineno"> 1861</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01863"></a><span class="lineno"> 1863</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01865"></a><span class="lineno"> 1865</span>&#160;<span class="preprocessor">#pragma omp parallel OPENMPGLOBALPRIVATEFORSTATEANDGEOM // accounting requires state stuff</span></div>
<div class="line"><a name="l01866"></a><span class="lineno"> 1866</span>&#160;<span class="preprocessor"></span>  {</div>
<div class="line"><a name="l01867"></a><span class="lineno"> 1867</span>&#160;    <span class="keywordtype">int</span> <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>,<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>,k,pl,pliter;</div>
<div class="line"><a name="l01868"></a><span class="lineno"> 1868</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gamma,alpha,vsq,ucon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>],others[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a266c1c3ab2959dbfc603c7d3f12783fb" title="strict limit (doesn&#39;t work in general)">NUMOTHERSTATERESULTS</a>];</div>
<div class="line"><a name="l01869"></a><span class="lineno"> 1869</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> qsq;</div>
<div class="line"><a name="l01870"></a><span class="lineno"> 1870</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> pr0[NPR];</div>
<div class="line"><a name="l01871"></a><span class="lineno"> 1871</span>&#160;    <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> mhdlpflag,radlpflag;</div>
<div class="line"><a name="l01872"></a><span class="lineno"> 1872</span>&#160;    <span class="keywordtype">int</span> fixedmhd,fixedrad;</div>
<div class="line"><a name="l01873"></a><span class="lineno"> 1873</span>&#160;    <span class="keywordtype">int</span> startpl,endpl;</div>
<div class="line"><a name="l01874"></a><span class="lineno"> 1874</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ftemp;</div>
<div class="line"><a name="l01875"></a><span class="lineno"> 1875</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> D0;</div>
<div class="line"><a name="l01876"></a><span class="lineno"> 1876</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01877"></a><span class="lineno"> 1877</span>&#160;    <span class="keywordtype">int</span> limitedgamma;</div>
<div class="line"><a name="l01878"></a><span class="lineno"> 1878</span>&#160;    <span class="keywordtype">int</span> nogood;</div>
<div class="line"><a name="l01879"></a><span class="lineno"> 1879</span>&#160;    <span class="keyword">struct </span><a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> geomdontuse;</div>
<div class="line"><a name="l01880"></a><span class="lineno"> 1880</span>&#160;    <span class="keyword">struct </span><a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom=&amp;geomdontuse;</div>
<div class="line"><a name="l01881"></a><span class="lineno"> 1881</span>&#160;    <span class="keywordtype">int</span> fixingmhd,fixingrad;</div>
<div class="line"><a name="l01882"></a><span class="lineno"> 1882</span>&#160;    <span class="keywordtype">int</span> limitgammamhd,limitgammarad;</div>
<div class="line"><a name="l01883"></a><span class="lineno"> 1883</span>&#160;</div>
<div class="line"><a name="l01884"></a><span class="lineno"> 1884</span>&#160;</div>
<div class="line"><a name="l01885"></a><span class="lineno"> 1885</span>&#160;    <a class="code" href="../../d5/d7b/global_8openmploops_8h.html#a1389db2daf5bd9e94918090c253a16c9">OPENMP3DLOOPVARSDEFINE</a>; <a class="code" href="../../d5/d7b/global_8openmploops_8h.html#a865b7d98f1e7cba888ee63d052621383" title="COMPZLOOP equivalent for OpenMP.">OPENMP3DLOOPSETUPZLOOP</a>;</div>
<div class="line"><a name="l01886"></a><span class="lineno"> 1886</span>&#160;<span class="preprocessor">#pragma omp for schedule(OPENMPSCHEDULE(),OPENMPCHUNKSIZE(blocksize))</span></div>
<div class="line"><a name="l01887"></a><span class="lineno"> 1887</span>&#160;<span class="preprocessor"></span>    <a class="code" href="../../d5/d7b/global_8openmploops_8h.html#a9e48537d3cb58cc3a3765b8a18b43b15" title="Oddly, performance changes by 10% when changing how start and stop blockijk (and fixing how used too ...">OPENMP3DLOOPBLOCK</a>{</div>
<div class="line"><a name="l01888"></a><span class="lineno"> 1888</span>&#160;      <a class="code" href="../../df/d1c/global_8storage_8h.html#a96983b0c56e836f50cb7c1af16f59fb6">OPENMP3DLOOPBLOCK2IJK</a>(i,j,k);</div>
<div class="line"><a name="l01889"></a><span class="lineno"> 1889</span>&#160;      </div>
<div class="line"><a name="l01890"></a><span class="lineno"> 1890</span>&#160;</div>
<div class="line"><a name="l01891"></a><span class="lineno"> 1891</span>&#160;     </div>
<div class="line"><a name="l01892"></a><span class="lineno"> 1892</span>&#160;      <span class="comment">// get failure flag</span></div>
<div class="line"><a name="l01893"></a><span class="lineno"> 1893</span>&#160;      mhdlpflag=GLOBALMACP0A1(pflagfailorig,i,j,k,FLAGUTOPRIMFAIL);</div>
<div class="line"><a name="l01894"></a><span class="lineno"> 1894</span>&#160;      radlpflag=GLOBALMACP0A1(pflagfailorig,i,j,k,FLAGUTOPRIMRADFAIL);</div>
<div class="line"><a name="l01895"></a><span class="lineno"> 1895</span>&#160;</div>
<div class="line"><a name="l01896"></a><span class="lineno"> 1896</span>&#160;      <span class="comment">// assume not fixing anything</span></div>
<div class="line"><a name="l01897"></a><span class="lineno"> 1897</span>&#160;      fixingmhd=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0894a5e6c53e2e8a143d10be7a42d492">IFUTOPRIMFAIL</a>(mhdlpflag);</div>
<div class="line"><a name="l01898"></a><span class="lineno"> 1898</span>&#160;      fixingrad=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a781d24b3e646f7f4597b0b7004507a63">IFUTOPRIMRADFAIL</a>(radlpflag); <span class="comment">// not just a hard failure, but some softish ones too</span></div>
<div class="line"><a name="l01899"></a><span class="lineno"> 1899</span>&#160;</div>
<div class="line"><a name="l01900"></a><span class="lineno"> 1900</span>&#160;      </div>
<div class="line"><a name="l01901"></a><span class="lineno"> 1901</span>&#160;      </div>
<div class="line"><a name="l01902"></a><span class="lineno"> 1902</span>&#160;      <span class="keywordflow">if</span>(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aa8eee7433c798188aabfeea0809f0718">IFUTOPRIMFAILFIXED</a>(mhdlpflag) &amp;&amp; <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aa8eee7433c798188aabfeea0809f0718">IFUTOPRIMFAILFIXED</a>(radlpflag)){ <span class="comment">// IF BOTH MHD AND RAD FIXED-UP ELSEWHERE</span></div>
<div class="line"><a name="l01904"></a><span class="lineno"> 1904</span>&#160;<span class="comment"></span>        <span class="comment">//</span></div>
<div class="line"><a name="l01905"></a><span class="lineno"> 1905</span>&#160;        <span class="comment">// see if utoprim() previously fixed so can do diagnostics</span></div>
<div class="line"><a name="l01906"></a><span class="lineno"> 1906</span>&#160;        <span class="comment">// only do accounting</span></div>
<div class="line"><a name="l01907"></a><span class="lineno"> 1907</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01909"></a><span class="lineno"> 1909</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01910"></a><span class="lineno"> 1910</span>&#160;        <span class="comment">// set pre-fixed primitives</span></div>
<div class="line"><a name="l01911"></a><span class="lineno"> 1911</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl)    pr0[pl]=<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(ptoavg,i,j,k,pl);</div>
<div class="line"><a name="l01912"></a><span class="lineno"> 1912</span>&#160;        <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a3059ed7bfcfb692cbe8014d55fd7c1e4">get_geometry</a>(i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8936711f57f82d1fc75c21fa2894e1c6">CENT</a>,ptrgeom);</div>
<div class="line"><a name="l01913"></a><span class="lineno"> 1913</span>&#160;</div>
<div class="line"><a name="l01915"></a><span class="lineno"> 1915</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01916"></a><span class="lineno"> 1916</span>&#160;        <span class="comment">// ACCOUNTING (static or average)</span></div>
<div class="line"><a name="l01917"></a><span class="lineno"> 1917</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01919"></a><span class="lineno"> 1919</span>&#160;<span class="comment"></span>        fixuputoprim_accounting(i, j, k, mhdlpflag, radlpflag, 0, 0, <a class="code" href="../../df/d1c/global_8storage_8h.html#ad89dafa5d772b862a44b0f576983ead3" title="shifted pointer (a_s_) wrappers Couldn&#39;t figure out how to macrofy a_s_ or a_, so when changing have ...">GLOBALPOINT</a>(pflag),pv,ptoavg, ptrgeom, pr0, ucons, finalstep);</div>
<div class="line"><a name="l01920"></a><span class="lineno"> 1920</span>&#160;</div>
<div class="line"><a name="l01921"></a><span class="lineno"> 1921</span>&#160;</div>
<div class="line"><a name="l01922"></a><span class="lineno"> 1922</span>&#160;      }</div>
<div class="line"><a name="l01923"></a><span class="lineno"> 1923</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span>(fixingmhd || fixingrad){</div>
<div class="line"><a name="l01924"></a><span class="lineno"> 1924</span>&#160;</div>
<div class="line"><a name="l01925"></a><span class="lineno"> 1925</span>&#160;</div>
<div class="line"><a name="l01926"></a><span class="lineno"> 1926</span>&#160;</div>
<div class="line"><a name="l01927"></a><span class="lineno"> 1927</span>&#160;</div>
<div class="line"><a name="l01928"></a><span class="lineno"> 1928</span>&#160;</div>
<div class="line"><a name="l01929"></a><span class="lineno"> 1929</span>&#160;        <span class="keywordflow">if</span>(fixingmhd){</div>
<div class="line"><a name="l01930"></a><span class="lineno"> 1930</span>&#160;</div>
<div class="line"><a name="l01933"></a><span class="lineno"> 1933</span>&#160;          <span class="comment">//</span></div>
<div class="line"><a name="l01934"></a><span class="lineno"> 1934</span>&#160;          <span class="comment">// see if MHD utoprim() failed</span></div>
<div class="line"><a name="l01935"></a><span class="lineno"> 1935</span>&#160;          <span class="comment">//</span></div>
<div class="line"><a name="l01938"></a><span class="lineno"> 1938</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01939"></a><span class="lineno"> 1939</span>&#160;          fixedmhd=0; <span class="comment">// assume not fixed yet</span></div>
<div class="line"><a name="l01940"></a><span class="lineno"> 1940</span>&#160;</div>
<div class="line"><a name="l01941"></a><span class="lineno"> 1941</span>&#160;          <span class="comment">// set pre-fixed primitives</span></div>
<div class="line"><a name="l01942"></a><span class="lineno"> 1942</span>&#160;          <span class="comment">// put back inside &quot;if&quot; when not superdebugging since wasteful of cpu</span></div>
<div class="line"><a name="l01943"></a><span class="lineno"> 1943</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl)    pr0[pl]=<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(ptoavg,i,j,k,pl);</div>
<div class="line"><a name="l01944"></a><span class="lineno"> 1944</span>&#160;          <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a3059ed7bfcfb692cbe8014d55fd7c1e4">get_geometry</a>(i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8936711f57f82d1fc75c21fa2894e1c6">CENT</a>,ptrgeom);</div>
<div class="line"><a name="l01945"></a><span class="lineno"> 1945</span>&#160;</div>
<div class="line"><a name="l01946"></a><span class="lineno"> 1946</span>&#160; </div>
<div class="line"><a name="l01948"></a><span class="lineno"> 1948</span>&#160;          <span class="comment">//</span></div>
<div class="line"><a name="l01949"></a><span class="lineno"> 1949</span>&#160;          <span class="comment">// Check if want to average</span></div>
<div class="line"><a name="l01950"></a><span class="lineno"> 1950</span>&#160;          <span class="comment">//</span></div>
<div class="line"><a name="l01951"></a><span class="lineno"> 1951</span>&#160;          <span class="comment">// only modified if doing some kind of averaging, else static since already kept old value in inversion method</span></div>
<div class="line"><a name="l01952"></a><span class="lineno"> 1952</span>&#160;          <span class="comment">//</span></div>
<div class="line"><a name="l01954"></a><span class="lineno"> 1954</span>&#160;<span class="comment"></span>          <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#a7bc78010e912554415d2e2788d252169" title="#define UTOPRIMADJUST UTOPRIMSTATIC">UTOPRIMADJUST</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a9e4e6cdbb30e8d514fc2828848e1f0ce">UTOPRIMAVG</a>){</div>
<div class="line"><a name="l01955"></a><span class="lineno"> 1955</span>&#160;</div>
<div class="line"><a name="l01957"></a><span class="lineno"> 1957</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l01958"></a><span class="lineno"> 1958</span>&#160;            <span class="comment">// choose which range of quantities to average</span></div>
<div class="line"><a name="l01959"></a><span class="lineno"> 1959</span>&#160;            <span class="comment">// Doesn&#39;t include any floor scalars (e.g. YFLx) presumed to be forced as fully conservative post-adjusted ucon[TT] unlike (normally) evolved density</span></div>
<div class="line"><a name="l01960"></a><span class="lineno"> 1960</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l01962"></a><span class="lineno"> 1962</span>&#160;<span class="comment"></span>            <span class="comment">// field is evolved fine, so only average non-field</span></div>
<div class="line"><a name="l01963"></a><span class="lineno"> 1963</span>&#160;            <span class="keywordflow">if</span>(mhdlpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a24290f84c3e2b725f7cbbdff81da4760">UTOPRIMFAILRHOUNEG</a> &amp;&amp; <a class="code" href="../../de/d95/fixup_8c.html#a7500256c2ba86b67ce5059a9b525e7ef">HANDLERHOUNEG</a>==1){</div>
<div class="line"><a name="l01964"></a><span class="lineno"> 1964</span>&#160;              startpl=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>;</div>
<div class="line"><a name="l01965"></a><span class="lineno"> 1965</span>&#160;              endpl=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>;</div>
<div class="line"><a name="l01966"></a><span class="lineno"> 1966</span>&#160;            }</div>
<div class="line"><a name="l01967"></a><span class="lineno"> 1967</span>&#160;            <span class="keywordflow">else</span> <span class="keywordflow">if</span>(mhdlpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ac3b05e85d00237f2aaa8ec4ec6ff82a3">UTOPRIMFAILU2AVG1</a> || mhdlpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a042dcc3162731841db25689b5f94c2ac">UTOPRIMFAILU2AVG2</a> || mhdlpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afc8db2dfa526f28224a0903680453240">UTOPRIMFAILU2AVG1FROMCOLD</a> || mhdlpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ace792b5d6cf33871003798c658ba55b2">UTOPRIMFAILU2AVG2FROMCOLD</a> || mhdlpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a58149f1f58f5a6b52e613a93c22efe30">UTOPRIMFAILUPERC</a> || mhdlpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a17c167aa50c0750a25baba351db69740">UTOPRIMFAILUNEG</a> &amp;&amp; (<a class="code" href="../../de/d95/fixup_8c.html#aa9d04e5483d7cc6a8e71924763748705">HANDLEUNEG</a>==1) ){</div>
<div class="line"><a name="l01968"></a><span class="lineno"> 1968</span>&#160;              startpl=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>;</div>
<div class="line"><a name="l01969"></a><span class="lineno"> 1969</span>&#160;              endpl=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>;</div>
<div class="line"><a name="l01970"></a><span class="lineno"> 1970</span>&#160;            }</div>
<div class="line"><a name="l01971"></a><span class="lineno"> 1971</span>&#160;            <span class="keywordflow">else</span> <span class="keywordflow">if</span>(mhdlpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ad5bd994b947d2a46102582b38e4b1529">UTOPRIMFAILRHONEG</a> &amp;&amp; <a class="code" href="../../de/d95/fixup_8c.html#a9a6f871146b8c53c825eb272435083d5">HANDLERHONEG</a>==1){</div>
<div class="line"><a name="l01972"></a><span class="lineno"> 1972</span>&#160;              startpl=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>;</div>
<div class="line"><a name="l01973"></a><span class="lineno"> 1973</span>&#160;              endpl=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>;</div>
<div class="line"><a name="l01974"></a><span class="lineno"> 1974</span>&#160;            }</div>
<div class="line"><a name="l01975"></a><span class="lineno"> 1975</span>&#160;            <span class="keywordflow">else</span> <span class="keywordflow">if</span>(mhdlpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a4fb558d7d5fa8343d7ca417d8b0bb418">UTOPRIMFAILURHO2AVG1FROMFFDE</a>){</div>
<div class="line"><a name="l01976"></a><span class="lineno"> 1976</span>&#160;              startpl=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>;</div>
<div class="line"><a name="l01977"></a><span class="lineno"> 1977</span>&#160;              endpl=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>;</div>
<div class="line"><a name="l01978"></a><span class="lineno"> 1978</span>&#160;              <span class="comment">// SUPERGODMARK: should also average v along v.B</span></div>
<div class="line"><a name="l01979"></a><span class="lineno"> 1979</span>&#160;            }</div>
<div class="line"><a name="l01980"></a><span class="lineno"> 1980</span>&#160;            <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l01981"></a><span class="lineno"> 1981</span>&#160;              <span class="comment">// then presume inversion failure with no solution or assuming rho&lt;=0 or u&lt;=zerouuperbaryon*prim[RHO] is bad inversion if HANDLE?NEG==0</span></div>
<div class="line"><a name="l01982"></a><span class="lineno"> 1982</span>&#160;              startpl=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>;</div>
<div class="line"><a name="l01983"></a><span class="lineno"> 1983</span>&#160;              endpl=NPR-1;</div>
<div class="line"><a name="l01984"></a><span class="lineno"> 1984</span>&#160;            }</div>
<div class="line"><a name="l01985"></a><span class="lineno"> 1985</span>&#160;</div>
<div class="line"><a name="l01986"></a><span class="lineno"> 1986</span>&#160;</div>
<div class="line"><a name="l01987"></a><span class="lineno"> 1987</span>&#160;</div>
<div class="line"><a name="l01988"></a><span class="lineno"> 1988</span>&#160;</div>
<div class="line"><a name="l01989"></a><span class="lineno"> 1989</span>&#160;</div>
<div class="line"><a name="l01990"></a><span class="lineno"> 1990</span>&#160;</div>
<div class="line"><a name="l01991"></a><span class="lineno"> 1991</span>&#160;</div>
<div class="line"><a name="l01993"></a><span class="lineno"> 1993</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l01994"></a><span class="lineno"> 1994</span>&#160;            <span class="comment">// other kinds of failures not caught by above (inversion convergence type failures)</span></div>
<div class="line"><a name="l01995"></a><span class="lineno"> 1995</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l01997"></a><span class="lineno"> 1997</span>&#160;<span class="comment"></span>            <span class="keywordflow">if</span>(fixedmhd==0){</div>
<div class="line"><a name="l01998"></a><span class="lineno"> 1998</span>&#160;</div>
<div class="line"><a name="l01999"></a><span class="lineno"> 1999</span>&#160;</div>
<div class="line"><a name="l02001"></a><span class="lineno"> 2001</span>&#160;              <span class="comment">//</span></div>
<div class="line"><a name="l02002"></a><span class="lineno"> 2002</span>&#160;              <span class="comment">// fix using average of surrounding good values, if they exist</span></div>
<div class="line"><a name="l02003"></a><span class="lineno"> 2003</span>&#160;              <span class="comment">//</span></div>
<div class="line"><a name="l02005"></a><span class="lineno"> 2005</span>&#160;<span class="comment"></span>              nogood=0;</div>
<div class="line"><a name="l02006"></a><span class="lineno"> 2006</span>&#160;              <span class="keywordtype">int</span> doingmhd=1;</div>
<div class="line"><a name="l02007"></a><span class="lineno"> 2007</span>&#160;<span class="preprocessor">#if(GENERALAVERAGE==1)</span></div>
<div class="line"><a name="l02008"></a><span class="lineno"> 2008</span>&#160;<span class="preprocessor"></span>              <span class="keywordtype">int</span> useonlynonfailed=1;</div>
<div class="line"><a name="l02009"></a><span class="lineno"> 2009</span>&#160;              <span class="keywordtype">int</span> maxnumbndtotry=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a1ded763384a648a49be714387e7189f7">MAXNUMPFLAGBND</a>; <span class="comment">// choice smaller or equal to MAXNUMPFLAGBND</span></div>
<div class="line"><a name="l02010"></a><span class="lineno"> 2010</span>&#160;              <span class="keywordtype">int</span> numbndtotry;</div>
<div class="line"><a name="l02011"></a><span class="lineno"> 2011</span>&#160;              <span class="comment">// TODOMARK: could also do multi-pass fixup_utoprim() with BCs done as squeeze in on failure region from outside, in case region is not caught by this.</span></div>
<div class="line"><a name="l02012"></a><span class="lineno"> 2012</span>&#160;              <span class="keywordflow">for</span>(numbndtotry=1;numbndtotry&lt;=maxnumbndtotry;numbndtotry++){</div>
<div class="line"><a name="l02013"></a><span class="lineno"> 2013</span>&#160;                nogood=general_average(useonlynonfailed,numbndtotry,maxnumbndtotry,startpl, endpl, i, j, k, doingmhd, mhdlpflag, radlpflag, <a class="code" href="../../df/d1c/global_8storage_8h.html#ad89dafa5d772b862a44b0f576983ead3" title="shifted pointer (a_s_) wrappers Couldn&#39;t figure out how to macrofy a_s_ or a_, so when changing have ...">GLOBALPOINT</a>(pflagfailorig) ,pv,ptoavg,ptrgeom);</div>
<div class="line"><a name="l02014"></a><span class="lineno"> 2014</span>&#160;                <span class="keywordflow">if</span>(nogood==0) <span class="keywordflow">break</span>; <span class="comment">// then success before using any more points</span></div>
<div class="line"><a name="l02015"></a><span class="lineno"> 2015</span>&#160;              }</div>
<div class="line"><a name="l02016"></a><span class="lineno"> 2016</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l02017"></a><span class="lineno"> 2017</span>&#160;<span class="preprocessor"></span>              nogood=<a class="code" href="../../de/d95/fixup_8c.html#a2f58e3b2c769ab1ac0fd7670a9014695" title="simple average of good surrounding zones">simple_average</a>(startpl,endpl,i,j,k, doingmhd, <a class="code" href="../../df/d1c/global_8storage_8h.html#ad89dafa5d772b862a44b0f576983ead3" title="shifted pointer (a_s_) wrappers Couldn&#39;t figure out how to macrofy a_s_ or a_, so when changing have ...">GLOBALPOINT</a>(pflagfailorig) ,pv,ptoavg);</div>
<div class="line"><a name="l02018"></a><span class="lineno"> 2018</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02019"></a><span class="lineno"> 2019</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l02020"></a><span class="lineno"> 2020</span>&#160;</div>
<div class="line"><a name="l02021"></a><span class="lineno"> 2021</span>&#160;              <span class="keywordflow">if</span>(nogood){</div>
<div class="line"><a name="l02023"></a><span class="lineno"> 2023</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l02024"></a><span class="lineno"> 2024</span>&#160;                <span class="comment">// fixup negative densities (if no good case)</span></div>
<div class="line"><a name="l02025"></a><span class="lineno"> 2025</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l02027"></a><span class="lineno"> 2027</span>&#160;<span class="comment"></span>                fixup_negdensities(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#adb456e768bc8848a978ac49b06194bbd">EOMSETMHD</a>, &amp;fixedmhd, startpl, endpl, i, j, k, mhdlpflag, pv,ptoavg, ptrgeom, pr0, ucons, finalstep);</div>
<div class="line"><a name="l02028"></a><span class="lineno"> 2028</span>&#160;</div>
<div class="line"><a name="l02029"></a><span class="lineno"> 2029</span>&#160;                <span class="keywordflow">if</span>(fixedmhd==1 &amp;&amp; (startpl&lt;=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a> &amp;&amp; endpl&lt;=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>)){</div>
<div class="line"><a name="l02030"></a><span class="lineno"> 2030</span>&#160;                  <span class="comment">// assume success for densities, so no longer nogood.</span></div>
<div class="line"><a name="l02031"></a><span class="lineno"> 2031</span>&#160;                  nogood=0;</div>
<div class="line"><a name="l02032"></a><span class="lineno"> 2032</span>&#160;                }</div>
<div class="line"><a name="l02033"></a><span class="lineno"> 2033</span>&#160;</div>
<div class="line"><a name="l02034"></a><span class="lineno"> 2034</span>&#160;                <span class="keywordflow">if</span>(fixedmhd==1 &amp;&amp; (startpl&lt;=RHO &amp;&amp; endpl&gt;=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>)){</div>
<div class="line"><a name="l02035"></a><span class="lineno"> 2035</span>&#160;                  <span class="comment">// then fixup but only changed densities, so still need to process non-densities</span></div>
<div class="line"><a name="l02036"></a><span class="lineno"> 2036</span>&#160;                  startpl=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>; <span class="comment">// start at U1 (first velocity) and finish at same ending if was ending on some velocity</span></div>
<div class="line"><a name="l02037"></a><span class="lineno"> 2037</span>&#160;                  fixedmhd=0; <span class="comment">// then reset fixedmhd-&gt;0 so can still modify these remaining quantities -- otherwise v^i would be unchanged even if wanted to average that out for (e.g.) negative density results for inversions.</span></div>
<div class="line"><a name="l02038"></a><span class="lineno"> 2038</span>&#160;                }</div>
<div class="line"><a name="l02039"></a><span class="lineno"> 2039</span>&#160;              }</div>
<div class="line"><a name="l02040"></a><span class="lineno"> 2040</span>&#160;</div>
<div class="line"><a name="l02042"></a><span class="lineno"> 2042</span>&#160;              <span class="comment">//</span></div>
<div class="line"><a name="l02043"></a><span class="lineno"> 2043</span>&#160;              <span class="comment">// If no good surrounding value found, then average bad values in some way</span></div>
<div class="line"><a name="l02044"></a><span class="lineno"> 2044</span>&#160;              <span class="comment">//</span></div>
<div class="line"><a name="l02046"></a><span class="lineno"> 2046</span>&#160;<span class="comment"></span>              <span class="keywordflow">if</span>(nogood){</div>
<div class="line"><a name="l02047"></a><span class="lineno"> 2047</span>&#160;                <span class="comment">//                dualfprintf(fail_file,&quot;fixupnogood: mhd %d %d %d : %d %d\n&quot;,i,j,k,startpl,endpl);</span></div>
<div class="line"><a name="l02048"></a><span class="lineno"> 2048</span>&#160;                fixup_nogood(startpl, endpl, i, j, k, doingmhd, mhdlpflag, radlpflag, pv,ptoavg, pbackup, ptrgeom);</div>
<div class="line"><a name="l02049"></a><span class="lineno"> 2049</span>&#160;              }</div>
<div class="line"><a name="l02050"></a><span class="lineno"> 2050</span>&#160;</div>
<div class="line"><a name="l02051"></a><span class="lineno"> 2051</span>&#160;</div>
<div class="line"><a name="l02052"></a><span class="lineno"> 2052</span>&#160;</div>
<div class="line"><a name="l02054"></a><span class="lineno"> 2054</span>&#160;              <span class="comment">//</span></div>
<div class="line"><a name="l02055"></a><span class="lineno"> 2055</span>&#160;              <span class="comment">// Things to do only if modifying velocity</span></div>
<div class="line"><a name="l02056"></a><span class="lineno"> 2056</span>&#160;              <span class="comment">//</span></div>
<div class="line"><a name="l02058"></a><span class="lineno"> 2058</span>&#160;<span class="comment"></span>              <span class="keywordflow">if</span>(startpl&lt;=U1 &amp;&amp; endpl&gt;=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8de9104f1fffa59f057b214d74c5cfea">U3</a>){</div>
<div class="line"><a name="l02059"></a><span class="lineno"> 2059</span>&#160;</div>
<div class="line"><a name="l02060"></a><span class="lineno"> 2060</span>&#160;<span class="preprocessor">#if(WHICHVEL==VELREL4)</span></div>
<div class="line"><a name="l02061"></a><span class="lineno"> 2061</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l02062"></a><span class="lineno"> 2062</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l02063"></a><span class="lineno"> 2063</span>&#160;                <span class="comment">// check gamma to so calibrate new gamma to no larger than previous gamma</span></div>
<div class="line"><a name="l02065"></a><span class="lineno"> 2065</span>&#160;<span class="comment"></span>                <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(gamma_calc(<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(ptoavg,i,j,k),ptrgeom,&amp;gamma,&amp;qsq),<span class="stringliteral">&quot;fixup_utoprim: gamma calc failed\n&quot;</span>,<span class="stringliteral">&quot;fixup.c&quot;</span>,1);</div>
<div class="line"><a name="l02066"></a><span class="lineno"> 2066</span>&#160;                <span class="keywordflow">if</span> (<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#afc93fd4a6f7a2b87a9315d5fba5a529c">ucon_calc</a>(<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(ptoavg,i,j,k), ptrgeom, ucon, others) &gt;= 1) <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a5febb92786c5f7a1479e7e65f1c23ef3">FAILSTATEMENT</a>(<span class="stringliteral">&quot;fixup.c:utoprimfail_fixup()&quot;</span>, <span class="stringliteral">&quot;ucon_calc()&quot;</span>, 1);</div>
<div class="line"><a name="l02067"></a><span class="lineno"> 2067</span>&#160;                <span class="comment">//   alpha = 1. / sqrt(-ptrgeom-&gt;gcon[GIND(0,0)]);</span></div>
<div class="line"><a name="l02068"></a><span class="lineno"> 2068</span>&#160;                alpha = ptrgeom-&gt;alphalapse;</div>
<div class="line"><a name="l02069"></a><span class="lineno"> 2069</span>&#160;                vsq = 1. - 1. / (alpha * alpha * ucon[0] * ucon[0]);</div>
<div class="line"><a name="l02070"></a><span class="lineno"> 2070</span>&#160;</div>
<div class="line"><a name="l02071"></a><span class="lineno"> 2071</span>&#160;                limitedgamma=0;</div>
<div class="line"><a name="l02072"></a><span class="lineno"> 2072</span>&#160;                <span class="keywordflow">if</span>(gamma&gt;<a class="code" href="../../d8/d5b/defs_8general_8h.html#accef7ff74daca804b9a5a3ad7d3db882">GAMMAMAX</a>){</div>
<div class="line"><a name="l02073"></a><span class="lineno"> 2073</span>&#160;                  limitedgamma=1;</div>
<div class="line"><a name="l02074"></a><span class="lineno"> 2074</span>&#160;                  <span class="keywordflow">if</span>(debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;MHD: initial gamma: %21.15g,  max: %21.15g, initial vsq: %21.15g\n&quot;</span>,gamma,<a class="code" href="../../d8/d5b/defs_8general_8h.html#accef7ff74daca804b9a5a3ad7d3db882">GAMMAMAX</a>,vsq);</div>
<div class="line"><a name="l02075"></a><span class="lineno"> 2075</span>&#160;                  <span class="comment">// limit:</span></div>
<div class="line"><a name="l02076"></a><span class="lineno"> 2076</span>&#160;                  gamma=<a class="code" href="../../d8/d5b/defs_8general_8h.html#accef7ff74daca804b9a5a3ad7d3db882">GAMMAMAX</a>;</div>
<div class="line"><a name="l02077"></a><span class="lineno"> 2077</span>&#160;                }</div>
<div class="line"><a name="l02078"></a><span class="lineno"> 2078</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l02079"></a><span class="lineno"> 2079</span>&#160;<span class="preprocessor"></span>                limitedgamma=0;</div>
<div class="line"><a name="l02080"></a><span class="lineno"> 2080</span>&#160;                <span class="keywordflow">if</span> (<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#afc93fd4a6f7a2b87a9315d5fba5a529c">ucon_calc</a>(<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(ptoavg,i,j,k), ptrgeom, ucon,others) &gt;= 1) <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a5febb92786c5f7a1479e7e65f1c23ef3">FAILSTATEMENT</a>(<span class="stringliteral">&quot;fixup.c:utoprimfail_fixup()&quot;</span>, <span class="stringliteral">&quot;ucon_calc()&quot;</span>, 1);</div>
<div class="line"><a name="l02081"></a><span class="lineno"> 2081</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02082"></a><span class="lineno"> 2082</span>&#160;<span class="preprocessor"></span>   </div>
<div class="line"><a name="l02083"></a><span class="lineno"> 2083</span>&#160;</div>
<div class="line"><a name="l02085"></a><span class="lineno"> 2085</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l02086"></a><span class="lineno"> 2086</span>&#160;                <span class="comment">// check new gamma to make sure smaller than original (i.e. for pv, not original ptoavg)</span></div>
<div class="line"><a name="l02087"></a><span class="lineno"> 2087</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l02089"></a><span class="lineno"> 2089</span>&#160;<span class="comment"></span>     </div>
<div class="line"><a name="l02090"></a><span class="lineno"> 2090</span>&#160;<span class="preprocessor">#if(WHICHVEL==VELREL4)</span></div>
<div class="line"><a name="l02091"></a><span class="lineno"> 2091</span>&#160;<span class="preprocessor"></span>                <span class="comment">//                if((startpos[1]+ptrgeom-&gt;i==17) &amp;&amp; (startpos[2]+ptrgeom-&gt;j)==0){</span></div>
<div class="line"><a name="l02092"></a><span class="lineno"> 2092</span>&#160;                <span class="comment">//                  dualfprintf(fail_file,&quot;BEFORE IN FIXUPUTOPRIM LIMITGAMMA: finalstep=%d flag=%d\n&quot;,finalstep,mhdlpflag);</span></div>
<div class="line"><a name="l02093"></a><span class="lineno"> 2093</span>&#160;                <span class="comment">//                }</span></div>
<div class="line"><a name="l02094"></a><span class="lineno"> 2094</span>&#160;                <span class="keywordflow">if</span>(limitgammamhd=limit_gamma(0,gamma,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a51ef12e4cafc4a8fe70374c37f57d565">GAMMAMAXRAD</a>,<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(pv,i,j,k),<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(ucons,i,j,k),ptrgeom,-1)&gt;=1) <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a5febb92786c5f7a1479e7e65f1c23ef3">FAILSTATEMENT</a>(<span class="stringliteral">&quot;fixup.c:fixup()&quot;</span>, <span class="stringliteral">&quot;limit_gamma()&quot;</span>, 2);</div>
<div class="line"><a name="l02095"></a><span class="lineno"> 2095</span>&#160;                <span class="comment">//                if((startpos[1]+ptrgeom-&gt;i==17) &amp;&amp; (startpos[2]+ptrgeom-&gt;j)==0){</span></div>
<div class="line"><a name="l02096"></a><span class="lineno"> 2096</span>&#160;                <span class="comment">//                  dualfprintf(fail_file,&quot;AFTER IN FIXUPUTOPRIM LIMITGAMMA: finalstep=%d\n&quot;,finalstep);</span></div>
<div class="line"><a name="l02097"></a><span class="lineno"> 2097</span>&#160;                <span class="comment">//                }</span></div>
<div class="line"><a name="l02098"></a><span class="lineno"> 2098</span>&#160;</div>
<div class="line"><a name="l02099"></a><span class="lineno"> 2099</span>&#160;                <span class="keywordflow">if</span>(debugfail&gt;=3){</div>
<div class="line"><a name="l02100"></a><span class="lineno"> 2100</span>&#160;                  <span class="keywordflow">if</span>(limitedgamma){</div>
<div class="line"><a name="l02101"></a><span class="lineno"> 2101</span>&#160;                    <span class="comment">// check gamma</span></div>
<div class="line"><a name="l02102"></a><span class="lineno"> 2102</span>&#160;                    <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(gamma_calc(<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(pv,i,j,k),ptrgeom,&amp;gamma,&amp;qsq),<span class="stringliteral">&quot;fixup_utoprim: gamma calc failed\n&quot;</span>,<span class="stringliteral">&quot;fixup.c&quot;</span>,2);</div>
<div class="line"><a name="l02103"></a><span class="lineno"> 2103</span>&#160;                    dualfprintf(fail_file,<span class="stringliteral">&quot;MHD: final gamma: %21.15g\n&quot;</span>,gamma);</div>
<div class="line"><a name="l02104"></a><span class="lineno"> 2104</span>&#160;                  }</div>
<div class="line"><a name="l02105"></a><span class="lineno"> 2105</span>&#160;                }</div>
<div class="line"><a name="l02106"></a><span class="lineno"> 2106</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02107"></a><span class="lineno"> 2107</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l02108"></a><span class="lineno"> 2108</span>&#160;              }<span class="comment">// end if dealing with velocity</span></div>
<div class="line"><a name="l02109"></a><span class="lineno"> 2109</span>&#160;</div>
<div class="line"><a name="l02110"></a><span class="lineno"> 2110</span>&#160;</div>
<div class="line"><a name="l02111"></a><span class="lineno"> 2111</span>&#160;</div>
<div class="line"><a name="l02113"></a><span class="lineno"> 2113</span>&#160;              <span class="comment">//</span></div>
<div class="line"><a name="l02114"></a><span class="lineno"> 2114</span>&#160;              <span class="comment">// Things to do only if modifying density (must come after modifying velocity that enters ucon[TT])</span></div>
<div class="line"><a name="l02115"></a><span class="lineno"> 2115</span>&#160;              <span class="comment">//</span></div>
<div class="line"><a name="l02117"></a><span class="lineno"> 2117</span>&#160;<span class="comment"></span>              <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l02118"></a><span class="lineno"> 2118</span>&#160;                <span class="keywordflow">if</span>(pl==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a> || pl==YFL1 || pl==YFL2 || pl==YFL3){</div>
<div class="line"><a name="l02119"></a><span class="lineno"> 2119</span>&#160;                  <span class="keywordflow">if</span>(startpl&lt;=pl &amp;&amp; endpl&gt;=pl){</div>
<div class="line"><a name="l02120"></a><span class="lineno"> 2120</span>&#160;</div>
<div class="line"><a name="l02121"></a><span class="lineno"> 2121</span>&#160;</div>
<div class="line"><a name="l02122"></a><span class="lineno"> 2122</span>&#160;                    <span class="keywordflow">if</span>(<a class="code" href="../../de/d95/fixup_8c.html#a87882c2666708d89915909a258021528">DO_CONSERVE_D_INFAILFIXUPS</a>){</div>
<div class="line"><a name="l02123"></a><span class="lineno"> 2123</span>&#160;                      </div>
<div class="line"><a name="l02124"></a><span class="lineno"> 2124</span>&#160;                      <span class="keywordflow">if</span>(mhdlpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ad6ba8deb8dab694606b9f4a79845aada">UTOPRIMFAILGAMMAPERC</a> || 1){ <span class="comment">// GODMARK: always doing it</span></div>
<div class="line"><a name="l02125"></a><span class="lineno"> 2125</span>&#160;</div>
<div class="line"><a name="l02126"></a><span class="lineno"> 2126</span>&#160;                        <span class="keywordflow">if</span> (<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#afc93fd4a6f7a2b87a9315d5fba5a529c">ucon_calc</a>(<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(ptoavg,i,j,k), ptrgeom, ucon, others) &gt;= 1) <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a5febb92786c5f7a1479e7e65f1c23ef3">FAILSTATEMENT</a>(<span class="stringliteral">&quot;fixup.c:utoprimfail_fixup()&quot;</span>, <span class="stringliteral">&quot;ucon_calc()&quot;</span>, 1);</div>
<div class="line"><a name="l02127"></a><span class="lineno"> 2127</span>&#160;</div>
<div class="line"><a name="l02128"></a><span class="lineno"> 2128</span>&#160;                        <span class="comment">// Use D0 to constrain how changing u^t changes rho</span></div>
<div class="line"><a name="l02129"></a><span class="lineno"> 2129</span>&#160;                        <span class="comment">// GODMARK: Why not used evolved D=\rho_0 u^t  from conserved quantity?</span></div>
<div class="line"><a name="l02130"></a><span class="lineno"> 2130</span>&#160;                        <span class="comment">// GODMARK: See fixup.c&#39;s limit_gamma() notes on why using conserved version of D not good to use</span></div>
<div class="line"><a name="l02131"></a><span class="lineno"> 2131</span>&#160;                        <span class="comment">// Here we ignore all conserved quantities and just ensure that D0 is conserved (close) to original value after averaging that assumes original value was reasonable</span></div>
<div class="line"><a name="l02132"></a><span class="lineno"> 2132</span>&#160;                        <span class="keywordflow">if</span>(finalstep==1){</div>
<div class="line"><a name="l02133"></a><span class="lineno"> 2133</span>&#160;                          <span class="comment">// this is not reasonable, because ignores any mass injection required during failure to make sense of solution</span></div>
<div class="line"><a name="l02134"></a><span class="lineno"> 2134</span>&#160;                          <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Unothing[NPR];</div>
<div class="line"><a name="l02135"></a><span class="lineno"> 2135</span>&#160;                          UtoU(UEVOLVE,UNOTHING,ptrgeom,<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(ucons,i,j,k),Unothing);</div>
<div class="line"><a name="l02136"></a><span class="lineno"> 2136</span>&#160;                          D0 = Unothing[pl] ;</div>
<div class="line"><a name="l02137"></a><span class="lineno"> 2137</span>&#160;                        }</div>
<div class="line"><a name="l02138"></a><span class="lineno"> 2138</span>&#160;                        <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l02139"></a><span class="lineno"> 2139</span>&#160;                          <span class="comment">// This is probably not necessary or useful</span></div>
<div class="line"><a name="l02140"></a><span class="lineno"> 2140</span>&#160;                          D0 = <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(ptoavg,i,j,k,pl)*ucon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>];</div>
<div class="line"><a name="l02141"></a><span class="lineno"> 2141</span>&#160;                        }</div>
<div class="line"><a name="l02142"></a><span class="lineno"> 2142</span>&#160;                        </div>
<div class="line"><a name="l02144"></a><span class="lineno"> 2144</span>&#160;                        <span class="comment">//</span></div>
<div class="line"><a name="l02145"></a><span class="lineno"> 2145</span>&#160;                        <span class="comment">// constrain change in density so conserve particle number</span></div>
<div class="line"><a name="l02146"></a><span class="lineno"> 2146</span>&#160;                        <span class="comment">//</span></div>
<div class="line"><a name="l02148"></a><span class="lineno"> 2148</span>&#160;<span class="comment"></span>                        <span class="keywordflow">if</span>(D0&gt;0.0 &amp;&amp; pl==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a> || pl==YFL1 || pl==YFL2 || pl==YFL3){ <span class="comment">// only makes sense if D0 implies positive density at least</span></div>
<div class="line"><a name="l02149"></a><span class="lineno"> 2149</span>&#160;                          <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,pl) = D0/ucon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>];</div>
<div class="line"><a name="l02150"></a><span class="lineno"> 2150</span>&#160;                        }</div>
<div class="line"><a name="l02151"></a><span class="lineno"> 2151</span>&#160;                      }</div>
<div class="line"><a name="l02152"></a><span class="lineno"> 2152</span>&#160;                    }</div>
<div class="line"><a name="l02153"></a><span class="lineno"> 2153</span>&#160;                  }</div>
<div class="line"><a name="l02154"></a><span class="lineno"> 2154</span>&#160;                }</div>
<div class="line"><a name="l02155"></a><span class="lineno"> 2155</span>&#160;              }<span class="comment">// end over density or scalars</span></div>
<div class="line"><a name="l02156"></a><span class="lineno"> 2156</span>&#160;</div>
<div class="line"><a name="l02157"></a><span class="lineno"> 2157</span>&#160;</div>
<div class="line"><a name="l02158"></a><span class="lineno"> 2158</span>&#160;</div>
<div class="line"><a name="l02159"></a><span class="lineno"> 2159</span>&#160;<span class="preprocessor">#if(0)</span></div>
<div class="line"><a name="l02160"></a><span class="lineno"> 2160</span>&#160;<span class="preprocessor"></span>              <span class="comment">// DEBUG problem of launch with pressureless stellar model collapse</span></div>
<div class="line"><a name="l02161"></a><span class="lineno"> 2161</span>&#160;              <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl) dualfprintf(fail_file,<span class="stringliteral">&quot;nstep=%ld steppart=%d :: i=%d j=%d k=%d pl=%d pv=%21.15g ptoavg=%21.15g\n&quot;</span>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a1a1088d87617078680f1fd0f0d707384">nstep</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a70170b90229f9fc05eebf8508a685c70">steppart</a>,i,j,k,pl,<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,pl),<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(ptoavg,i,j,k,pl));</div>
<div class="line"><a name="l02162"></a><span class="lineno"> 2162</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02163"></a><span class="lineno"> 2163</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l02164"></a><span class="lineno"> 2164</span>&#160;</div>
<div class="line"><a name="l02165"></a><span class="lineno"> 2165</span>&#160;</div>
<div class="line"><a name="l02166"></a><span class="lineno"> 2166</span>&#160;            } <span class="comment">// end if fixedmhd==0</span></div>
<div class="line"><a name="l02167"></a><span class="lineno"> 2167</span>&#160;</div>
<div class="line"><a name="l02168"></a><span class="lineno"> 2168</span>&#160;          }<span class="comment">// end if not keeping static</span></div>
<div class="line"><a name="l02169"></a><span class="lineno"> 2169</span>&#160;        }<span class="comment">// end if mhd failed</span></div>
<div class="line"><a name="l02170"></a><span class="lineno"> 2170</span>&#160;</div>
<div class="line"><a name="l02171"></a><span class="lineno"> 2171</span>&#160;</div>
<div class="line"><a name="l02172"></a><span class="lineno"> 2172</span>&#160;</div>
<div class="line"><a name="l02173"></a><span class="lineno"> 2173</span>&#160;</div>
<div class="line"><a name="l02174"></a><span class="lineno"> 2174</span>&#160;</div>
<div class="line"><a name="l02175"></a><span class="lineno"> 2175</span>&#160;</div>
<div class="line"><a name="l02176"></a><span class="lineno"> 2176</span>&#160;      </div>
<div class="line"><a name="l02177"></a><span class="lineno"> 2177</span>&#160;        <span class="keywordflow">if</span>(fixingrad){ <span class="comment">// RAD FAILED</span></div>
<div class="line"><a name="l02178"></a><span class="lineno"> 2178</span>&#160;</div>
<div class="line"><a name="l02181"></a><span class="lineno"> 2181</span>&#160;          <span class="comment">//</span></div>
<div class="line"><a name="l02182"></a><span class="lineno"> 2182</span>&#160;          <span class="comment">// see if u2p_rad() failed in some way</span></div>
<div class="line"><a name="l02183"></a><span class="lineno"> 2183</span>&#160;          <span class="comment">//</span></div>
<div class="line"><a name="l02186"></a><span class="lineno"> 2186</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02187"></a><span class="lineno"> 2187</span>&#160;          fixedrad=0; <span class="comment">// assume not fixedrad yet</span></div>
<div class="line"><a name="l02188"></a><span class="lineno"> 2188</span>&#160;</div>
<div class="line"><a name="l02189"></a><span class="lineno"> 2189</span>&#160;          <span class="comment">// set pre-fixedrad primitives</span></div>
<div class="line"><a name="l02190"></a><span class="lineno"> 2190</span>&#160;          <span class="comment">// put back inside &quot;if&quot; when not superdebugging since wasteful of cpu</span></div>
<div class="line"><a name="l02191"></a><span class="lineno"> 2191</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl)    pr0[pl]=<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(ptoavg,i,j,k,pl);</div>
<div class="line"><a name="l02192"></a><span class="lineno"> 2192</span>&#160;          <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a3059ed7bfcfb692cbe8014d55fd7c1e4">get_geometry</a>(i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8936711f57f82d1fc75c21fa2894e1c6">CENT</a>,ptrgeom);</div>
<div class="line"><a name="l02193"></a><span class="lineno"> 2193</span>&#160;</div>
<div class="line"><a name="l02194"></a><span class="lineno"> 2194</span>&#160; </div>
<div class="line"><a name="l02196"></a><span class="lineno"> 2196</span>&#160;          <span class="comment">//</span></div>
<div class="line"><a name="l02197"></a><span class="lineno"> 2197</span>&#160;          <span class="comment">// Check if want to average</span></div>
<div class="line"><a name="l02198"></a><span class="lineno"> 2198</span>&#160;          <span class="comment">//</span></div>
<div class="line"><a name="l02199"></a><span class="lineno"> 2199</span>&#160;          <span class="comment">// only modified if doing some kind of averaging, else static since already kept old value in inversion method</span></div>
<div class="line"><a name="l02200"></a><span class="lineno"> 2200</span>&#160;          <span class="comment">//</span></div>
<div class="line"><a name="l02202"></a><span class="lineno"> 2202</span>&#160;<span class="comment"></span>          <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#a7bc78010e912554415d2e2788d252169" title="#define UTOPRIMADJUST UTOPRIMSTATIC">UTOPRIMADJUST</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a9e4e6cdbb30e8d514fc2828848e1f0ce">UTOPRIMAVG</a>){</div>
<div class="line"><a name="l02203"></a><span class="lineno"> 2203</span>&#160;</div>
<div class="line"><a name="l02205"></a><span class="lineno"> 2205</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l02206"></a><span class="lineno"> 2206</span>&#160;            <span class="comment">// choose which range of quantities to average</span></div>
<div class="line"><a name="l02207"></a><span class="lineno"> 2207</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l02209"></a><span class="lineno"> 2209</span>&#160;<span class="comment"></span>            <span class="comment">// field is evolved fine, so only average non-field</span></div>
<div class="line"><a name="l02210"></a><span class="lineno"> 2210</span>&#160;            <span class="keywordflow">if</span>(radlpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ac3b05e85d00237f2aaa8ec4ec6ff82a3">UTOPRIMFAILU2AVG1</a> || radlpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a042dcc3162731841db25689b5f94c2ac">UTOPRIMFAILU2AVG2</a> || radlpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afc8db2dfa526f28224a0903680453240">UTOPRIMFAILU2AVG1FROMCOLD</a> || radlpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ace792b5d6cf33871003798c658ba55b2">UTOPRIMFAILU2AVG2FROMCOLD</a> || radlpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a58149f1f58f5a6b52e613a93c22efe30">UTOPRIMFAILUPERC</a> || radlpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a17c167aa50c0750a25baba351db69740">UTOPRIMFAILUNEG</a> &amp;&amp; (<a class="code" href="../../de/d95/fixup_8c.html#aa9d04e5483d7cc6a8e71924763748705">HANDLEUNEG</a>==1) || radlpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a38b0585ec02d900ad0413645acb00918">UTOPRIMRADFAILERFNEG</a>){</div>
<div class="line"><a name="l02211"></a><span class="lineno"> 2211</span>&#160;              startpl=PRAD0; <span class="comment">// use as minimum for PRAD0 and average for PRAD1-PRAD3</span></div>
<div class="line"><a name="l02212"></a><span class="lineno"> 2212</span>&#160;              endpl=PRAD3;</div>
<div class="line"><a name="l02213"></a><span class="lineno"> 2213</span>&#160;            }</div>
<div class="line"><a name="l02214"></a><span class="lineno"> 2214</span>&#160;            <span class="keywordflow">else</span> <span class="keywordflow">if</span>(radlpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a36f23f21f8e90ce3e39940621c912714">UTOPRIMRADFAILGAMMAHIGH</a>){ <span class="comment">// fixing gammarad so no constant high value from hitting ceiling on gammaradmax</span></div>
<div class="line"><a name="l02215"></a><span class="lineno"> 2215</span>&#160;              startpl=PRAD1;</div>
<div class="line"><a name="l02216"></a><span class="lineno"> 2216</span>&#160;              endpl=PRAD3;</div>
<div class="line"><a name="l02217"></a><span class="lineno"> 2217</span>&#160;            }</div>
<div class="line"><a name="l02218"></a><span class="lineno"> 2218</span>&#160;            <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l02219"></a><span class="lineno"> 2219</span>&#160;              <span class="comment">// then presume inversion failure with no solution</span></div>
<div class="line"><a name="l02220"></a><span class="lineno"> 2220</span>&#160;              startpl=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>;</div>
<div class="line"><a name="l02221"></a><span class="lineno"> 2221</span>&#160;              endpl=NPR-1;</div>
<div class="line"><a name="l02222"></a><span class="lineno"> 2222</span>&#160;            }</div>
<div class="line"><a name="l02223"></a><span class="lineno"> 2223</span>&#160;</div>
<div class="line"><a name="l02224"></a><span class="lineno"> 2224</span>&#160;</div>
<div class="line"><a name="l02225"></a><span class="lineno"> 2225</span>&#160;</div>
<div class="line"><a name="l02226"></a><span class="lineno"> 2226</span>&#160;</div>
<div class="line"><a name="l02227"></a><span class="lineno"> 2227</span>&#160;</div>
<div class="line"><a name="l02229"></a><span class="lineno"> 2229</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l02230"></a><span class="lineno"> 2230</span>&#160;            <span class="comment">// other kinds of failures not caught by above (inversion convergence type failures)</span></div>
<div class="line"><a name="l02231"></a><span class="lineno"> 2231</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l02233"></a><span class="lineno"> 2233</span>&#160;<span class="comment"></span>            <span class="keywordflow">if</span>(fixedrad==0){</div>
<div class="line"><a name="l02234"></a><span class="lineno"> 2234</span>&#160;</div>
<div class="line"><a name="l02235"></a><span class="lineno"> 2235</span>&#160;</div>
<div class="line"><a name="l02237"></a><span class="lineno"> 2237</span>&#160;              <span class="comment">//</span></div>
<div class="line"><a name="l02238"></a><span class="lineno"> 2238</span>&#160;              <span class="comment">// fix using average of surrounding good values, if they exist</span></div>
<div class="line"><a name="l02239"></a><span class="lineno"> 2239</span>&#160;              <span class="comment">//</span></div>
<div class="line"><a name="l02241"></a><span class="lineno"> 2241</span>&#160;<span class="comment"></span>              nogood=0;</div>
<div class="line"><a name="l02242"></a><span class="lineno"> 2242</span>&#160;              <span class="keywordtype">int</span> doingmhd=0;</div>
<div class="line"><a name="l02243"></a><span class="lineno"> 2243</span>&#160;<span class="preprocessor">#if(GENERALAVERAGE==1)</span></div>
<div class="line"><a name="l02244"></a><span class="lineno"> 2244</span>&#160;<span class="preprocessor"></span>              <span class="keywordtype">int</span> useonlynonfailed=1;</div>
<div class="line"><a name="l02245"></a><span class="lineno"> 2245</span>&#160;              <span class="keywordtype">int</span> maxnumbndtotry=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a1ded763384a648a49be714387e7189f7">MAXNUMPFLAGBND</a>; <span class="comment">// choice smaller or equal to MAXNUMPFLAGBND</span></div>
<div class="line"><a name="l02246"></a><span class="lineno"> 2246</span>&#160;              <span class="keywordtype">int</span> numbndtotry;</div>
<div class="line"><a name="l02247"></a><span class="lineno"> 2247</span>&#160;              <span class="keywordflow">for</span>(numbndtotry=1;numbndtotry&lt;=maxnumbndtotry;numbndtotry++){</div>
<div class="line"><a name="l02248"></a><span class="lineno"> 2248</span>&#160;                nogood=general_average(useonlynonfailed,numbndtotry,maxnumbndtotry,startpl, endpl, i, j, k, doingmhd, mhdlpflag, radlpflag, <a class="code" href="../../df/d1c/global_8storage_8h.html#ad89dafa5d772b862a44b0f576983ead3" title="shifted pointer (a_s_) wrappers Couldn&#39;t figure out how to macrofy a_s_ or a_, so when changing have ...">GLOBALPOINT</a>(pflagfailorig) ,pv,ptoavg,ptrgeom);</div>
<div class="line"><a name="l02249"></a><span class="lineno"> 2249</span>&#160;                <span class="keywordflow">if</span>(nogood==0) <span class="keywordflow">break</span>; <span class="comment">// then success before using any more points</span></div>
<div class="line"><a name="l02250"></a><span class="lineno"> 2250</span>&#160;              }</div>
<div class="line"><a name="l02251"></a><span class="lineno"> 2251</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l02252"></a><span class="lineno"> 2252</span>&#160;<span class="preprocessor"></span>              nogood=<a class="code" href="../../de/d95/fixup_8c.html#a2f58e3b2c769ab1ac0fd7670a9014695" title="simple average of good surrounding zones">simple_average</a>(startpl,endpl,i,j,k, doingmhd, <a class="code" href="../../df/d1c/global_8storage_8h.html#ad89dafa5d772b862a44b0f576983ead3" title="shifted pointer (a_s_) wrappers Couldn&#39;t figure out how to macrofy a_s_ or a_, so when changing have ...">GLOBALPOINT</a>(pflagfailorig) ,pv,ptoavg);</div>
<div class="line"><a name="l02253"></a><span class="lineno"> 2253</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02254"></a><span class="lineno"> 2254</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l02255"></a><span class="lineno"> 2255</span>&#160;</div>
<div class="line"><a name="l02256"></a><span class="lineno"> 2256</span>&#160;              <span class="keywordflow">if</span>(nogood &amp;&amp; 0){ <span class="comment">// avoid fixup_negdensities() because resets to ERADLIMIT</span></div>
<div class="line"><a name="l02258"></a><span class="lineno"> 2258</span>&#160;<span class="comment"></span>                <span class="comment">//</span></div>
<div class="line"><a name="l02259"></a><span class="lineno"> 2259</span>&#160;                <span class="comment">// fixup negative densities</span></div>
<div class="line"><a name="l02260"></a><span class="lineno"> 2260</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l02262"></a><span class="lineno"> 2262</span>&#160;<span class="comment"></span>                fixup_negdensities(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#af1a7c8e357fefc78efe71526c0630a61">EOMSETRAD</a>,&amp;fixedrad, startpl, endpl, i, j, k, radlpflag, pv,ptoavg, ptrgeom, pr0, ucons, finalstep);</div>
<div class="line"><a name="l02263"></a><span class="lineno"> 2263</span>&#160;</div>
<div class="line"><a name="l02264"></a><span class="lineno"> 2264</span>&#160;                <span class="keywordflow">if</span>(fixedrad==1 &amp;&amp; (startpl==URAD0 &amp;&amp; endpl==URAD0)){</div>
<div class="line"><a name="l02265"></a><span class="lineno"> 2265</span>&#160;                  <span class="comment">// assume success for densities, so no longer nogood.</span></div>
<div class="line"><a name="l02266"></a><span class="lineno"> 2266</span>&#160;                  nogood=0;</div>
<div class="line"><a name="l02267"></a><span class="lineno"> 2267</span>&#160;                }</div>
<div class="line"><a name="l02268"></a><span class="lineno"> 2268</span>&#160;                <span class="keywordflow">if</span>(fixedrad==1 &amp;&amp; (startpl&lt;=URAD0 &amp;&amp; endpl&gt;=URAD1)){</div>
<div class="line"><a name="l02269"></a><span class="lineno"> 2269</span>&#160;                  <span class="comment">// then fixup but only changed densities, so still need to process non-densities</span></div>
<div class="line"><a name="l02270"></a><span class="lineno"> 2270</span>&#160;                  startpl=URAD1; <span class="comment">// start at U1 (first velocity) and finish at same ending if was ending on some velocity</span></div>
<div class="line"><a name="l02271"></a><span class="lineno"> 2271</span>&#160;                  fixedrad=0; <span class="comment">// then reset fixedmhd-&gt;0 so can still modify these remaining quantities -- otherwise v^i would be unchanged even if wanted to average that out for (e.g.) negative density results for inversions.</span></div>
<div class="line"><a name="l02272"></a><span class="lineno"> 2272</span>&#160;                }</div>
<div class="line"><a name="l02273"></a><span class="lineno"> 2273</span>&#160;              }</div>
<div class="line"><a name="l02274"></a><span class="lineno"> 2274</span>&#160;</div>
<div class="line"><a name="l02275"></a><span class="lineno"> 2275</span>&#160;              <span class="comment">//              dualfprintf(fail_file,&quot;Trying no good? nogood=%d\n&quot;,nogood);</span></div>
<div class="line"><a name="l02276"></a><span class="lineno"> 2276</span>&#160;</div>
<div class="line"><a name="l02278"></a><span class="lineno"> 2278</span>&#160;              <span class="comment">//</span></div>
<div class="line"><a name="l02279"></a><span class="lineno"> 2279</span>&#160;              <span class="comment">// If no good surrounding value found, then average bad values in some way</span></div>
<div class="line"><a name="l02280"></a><span class="lineno"> 2280</span>&#160;              <span class="comment">//</span></div>
<div class="line"><a name="l02282"></a><span class="lineno"> 2282</span>&#160;<span class="comment"></span>              <span class="keywordflow">if</span>(1){ <span class="comment">// should stay 1, see below.</span></div>
<div class="line"><a name="l02283"></a><span class="lineno"> 2283</span>&#160;                <span class="keywordflow">if</span>(nogood){</div>
<div class="line"><a name="l02284"></a><span class="lineno"> 2284</span>&#160;                  <span class="comment">//                  dualfprintf(fail_file,&quot;fixupnogood: rad %d %d %d : %d %d\n&quot;,i,j,k,startpl,endpl);</span></div>
<div class="line"><a name="l02285"></a><span class="lineno"> 2285</span>&#160;                  fixup_nogood(startpl, endpl, i, j, k, doingmhd, mhdlpflag, radlpflag, pv,ptoavg, pbackup, ptrgeom);</div>
<div class="line"><a name="l02286"></a><span class="lineno"> 2286</span>&#160;                }</div>
<div class="line"><a name="l02287"></a><span class="lineno"> 2287</span>&#160;              }</div>
<div class="line"><a name="l02288"></a><span class="lineno"> 2288</span>&#160;              <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l02289"></a><span class="lineno"> 2289</span>&#160;                <span class="comment">// normally assume u2p_rad() did ok local fixup if non-local fixup doesn&#39;t work out.</span></div>
<div class="line"><a name="l02290"></a><span class="lineno"> 2290</span>&#160;                <span class="comment">// NO, reset failure to non-failure if ok local fixup.  If here, want fixup even of radiation quantity, such as when implicit solver fails.</span></div>
<div class="line"><a name="l02291"></a><span class="lineno"> 2291</span>&#160;              }</div>
<div class="line"><a name="l02292"></a><span class="lineno"> 2292</span>&#160;</div>
<div class="line"><a name="l02293"></a><span class="lineno"> 2293</span>&#160;              <span class="comment">//              if(MACP0A1(pv,i,j,k,URAD0)&lt;1.5*ERADLIMIT){</span></div>
<div class="line"><a name="l02294"></a><span class="lineno"> 2294</span>&#160;              <span class="comment">//                dualfprintf(fail_file,&quot;Why not fixed? %d %d %d: %21.15g err=%d\n&quot;,i,j,k,MACP0A1(pv,i,j,k,URAD0),radlpflag);</span></div>
<div class="line"><a name="l02295"></a><span class="lineno"> 2295</span>&#160;              <span class="comment">//                myexit(0);</span></div>
<div class="line"><a name="l02296"></a><span class="lineno"> 2296</span>&#160;              <span class="comment">//              }</span></div>
<div class="line"><a name="l02297"></a><span class="lineno"> 2297</span>&#160;</div>
<div class="line"><a name="l02298"></a><span class="lineno"> 2298</span>&#160;</div>
<div class="line"><a name="l02300"></a><span class="lineno"> 2300</span>&#160;              <span class="comment">//</span></div>
<div class="line"><a name="l02301"></a><span class="lineno"> 2301</span>&#160;              <span class="comment">// Things to do only if modifying radiation velocity</span></div>
<div class="line"><a name="l02302"></a><span class="lineno"> 2302</span>&#160;              <span class="comment">//</span></div>
<div class="line"><a name="l02304"></a><span class="lineno"> 2304</span>&#160;<span class="comment"></span>              <span class="keywordflow">if</span>(startpl&lt;=PRAD1 &amp;&amp; endpl&gt;=PRAD3){</div>
<div class="line"><a name="l02305"></a><span class="lineno"> 2305</span>&#160;</div>
<div class="line"><a name="l02306"></a><span class="lineno"> 2306</span>&#160;<span class="preprocessor">#if(WHICHVEL==VELREL4)</span></div>
<div class="line"><a name="l02307"></a><span class="lineno"> 2307</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l02308"></a><span class="lineno"> 2308</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l02309"></a><span class="lineno"> 2309</span>&#160;                <span class="comment">// check gamma to so calibrate new gamma to no larger than previous gamma</span></div>
<div class="line"><a name="l02311"></a><span class="lineno"> 2311</span>&#160;<span class="comment"></span>                <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(gamma_calc(&amp;<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(ptoavg,i,j,k,URAD1-<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>),ptrgeom,&amp;gamma,&amp;qsq),<span class="stringliteral">&quot;fixup_utoprim: gamma calc failed\n&quot;</span>,<span class="stringliteral">&quot;fixup.c&quot;</span>,1);</div>
<div class="line"><a name="l02312"></a><span class="lineno"> 2312</span>&#160;                <span class="keywordflow">if</span> (<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#afc93fd4a6f7a2b87a9315d5fba5a529c">ucon_calc</a>(&amp;<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(ptoavg,i,j,k,URAD1-<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>), ptrgeom, ucon, others) &gt;= 1) <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a5febb92786c5f7a1479e7e65f1c23ef3">FAILSTATEMENT</a>(<span class="stringliteral">&quot;fixup.c:utoprimfail_fixup()&quot;</span>, <span class="stringliteral">&quot;ucon_calc()&quot;</span>, 1);</div>
<div class="line"><a name="l02313"></a><span class="lineno"> 2313</span>&#160;                <span class="comment">//   alpha = 1. / sqrt(-ptrgeom-&gt;gcon[GIND(0,0)]);</span></div>
<div class="line"><a name="l02314"></a><span class="lineno"> 2314</span>&#160;                alpha = ptrgeom-&gt;alphalapse;</div>
<div class="line"><a name="l02315"></a><span class="lineno"> 2315</span>&#160;                vsq = 1. - 1. / (alpha * alpha * ucon[0] * ucon[0]);</div>
<div class="line"><a name="l02316"></a><span class="lineno"> 2316</span>&#160;</div>
<div class="line"><a name="l02317"></a><span class="lineno"> 2317</span>&#160;                limitedgamma=0;</div>
<div class="line"><a name="l02318"></a><span class="lineno"> 2318</span>&#160;                <span class="keywordflow">if</span>(gamma&gt;<a class="code" href="../../d8/d5b/defs_8general_8h.html#a51ef12e4cafc4a8fe70374c37f57d565">GAMMAMAXRAD</a>){</div>
<div class="line"><a name="l02319"></a><span class="lineno"> 2319</span>&#160;                  limitedgamma=1;</div>
<div class="line"><a name="l02320"></a><span class="lineno"> 2320</span>&#160;                  <span class="keywordflow">if</span>(debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;RAD: initial gamma: %21.15g,  max: %21.15g, initial vsq: %21.15g\n&quot;</span>,gamma,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a51ef12e4cafc4a8fe70374c37f57d565">GAMMAMAXRAD</a>,vsq);</div>
<div class="line"><a name="l02321"></a><span class="lineno"> 2321</span>&#160;                  <span class="comment">// limit:</span></div>
<div class="line"><a name="l02322"></a><span class="lineno"> 2322</span>&#160;                  gamma=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a51ef12e4cafc4a8fe70374c37f57d565">GAMMAMAXRAD</a>;</div>
<div class="line"><a name="l02323"></a><span class="lineno"> 2323</span>&#160;                }</div>
<div class="line"><a name="l02324"></a><span class="lineno"> 2324</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l02325"></a><span class="lineno"> 2325</span>&#160;<span class="preprocessor"></span>                limitedgamma=0;</div>
<div class="line"><a name="l02326"></a><span class="lineno"> 2326</span>&#160;                <span class="keywordflow">if</span> (<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#afc93fd4a6f7a2b87a9315d5fba5a529c">ucon_calc</a>(&amp;<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(ptoavg,i,j,k,URAD1-<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>), ptrgeom, ucon,others) &gt;= 1) <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a5febb92786c5f7a1479e7e65f1c23ef3">FAILSTATEMENT</a>(<span class="stringliteral">&quot;fixup.c:utoprimfail_fixup()&quot;</span>, <span class="stringliteral">&quot;ucon_calc()&quot;</span>, 1);</div>
<div class="line"><a name="l02327"></a><span class="lineno"> 2327</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02328"></a><span class="lineno"> 2328</span>&#160;<span class="preprocessor"></span>   </div>
<div class="line"><a name="l02329"></a><span class="lineno"> 2329</span>&#160;</div>
<div class="line"><a name="l02331"></a><span class="lineno"> 2331</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l02332"></a><span class="lineno"> 2332</span>&#160;                <span class="comment">// check new gamma to make sure smaller than original (i.e. for pv, not original ptoavg)</span></div>
<div class="line"><a name="l02333"></a><span class="lineno"> 2333</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l02335"></a><span class="lineno"> 2335</span>&#160;<span class="comment"></span>     </div>
<div class="line"><a name="l02336"></a><span class="lineno"> 2336</span>&#160;<span class="preprocessor">#if(WHICHVEL==VELREL4)</span></div>
<div class="line"><a name="l02337"></a><span class="lineno"> 2337</span>&#160;<span class="preprocessor"></span>                <span class="comment">//                if((startpos[1]+ptrgeom-&gt;i==17) &amp;&amp; (startpos[2]+ptrgeom-&gt;j)==0){</span></div>
<div class="line"><a name="l02338"></a><span class="lineno"> 2338</span>&#160;                <span class="comment">//                  dualfprintf(fail_file,&quot;BEFORE IN FIXUPUTOPRIM LIMITGAMMA2: finalstep=%d radlpflag=%d\n&quot;,finalstep,radlpflag);</span></div>
<div class="line"><a name="l02339"></a><span class="lineno"> 2339</span>&#160;                <span class="comment">//                }</span></div>
<div class="line"><a name="l02340"></a><span class="lineno"> 2340</span>&#160;                <span class="keywordflow">if</span>(limitgammarad=limit_gamma(0,<a class="code" href="../../d8/d5b/defs_8general_8h.html#accef7ff74daca804b9a5a3ad7d3db882">GAMMAMAX</a>,gamma,<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(pv,i,j,k),<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(ucons,i,j,k),ptrgeom,-1)&gt;=1) <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a5febb92786c5f7a1479e7e65f1c23ef3">FAILSTATEMENT</a>(<span class="stringliteral">&quot;fixup.c:fixup()&quot;</span>, <span class="stringliteral">&quot;limit_gamma()&quot;</span>, 2);</div>
<div class="line"><a name="l02341"></a><span class="lineno"> 2341</span>&#160;                <span class="comment">//                if((startpos[1]+ptrgeom-&gt;i==17) &amp;&amp; (startpos[2]+ptrgeom-&gt;j)==0){</span></div>
<div class="line"><a name="l02342"></a><span class="lineno"> 2342</span>&#160;                <span class="comment">//                  dualfprintf(fail_file,&quot;AFTER IN FIXUPUTOPRIM LIMITGAMMA2: finalstep=%d\n&quot;,finalstep);</span></div>
<div class="line"><a name="l02343"></a><span class="lineno"> 2343</span>&#160;                <span class="comment">//                }</span></div>
<div class="line"><a name="l02344"></a><span class="lineno"> 2344</span>&#160;</div>
<div class="line"><a name="l02345"></a><span class="lineno"> 2345</span>&#160;                <span class="keywordflow">if</span>(debugfail&gt;=3){</div>
<div class="line"><a name="l02346"></a><span class="lineno"> 2346</span>&#160;                  <span class="keywordflow">if</span>(limitedgamma){</div>
<div class="line"><a name="l02347"></a><span class="lineno"> 2347</span>&#160;                    <span class="comment">// check gamma</span></div>
<div class="line"><a name="l02348"></a><span class="lineno"> 2348</span>&#160;                    <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(gamma_calc(&amp;<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,URAD1-<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>),ptrgeom,&amp;gamma,&amp;qsq),<span class="stringliteral">&quot;fixup_utoprim: gamma calc failed\n&quot;</span>,<span class="stringliteral">&quot;fixup.c&quot;</span>,2);</div>
<div class="line"><a name="l02349"></a><span class="lineno"> 2349</span>&#160;                    dualfprintf(fail_file,<span class="stringliteral">&quot;RAD: final gamma: %21.15g\n&quot;</span>,gamma);</div>
<div class="line"><a name="l02350"></a><span class="lineno"> 2350</span>&#160;                  }</div>
<div class="line"><a name="l02351"></a><span class="lineno"> 2351</span>&#160;                }</div>
<div class="line"><a name="l02352"></a><span class="lineno"> 2352</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02353"></a><span class="lineno"> 2353</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l02354"></a><span class="lineno"> 2354</span>&#160;              }<span class="comment">// end if dealing with velocity</span></div>
<div class="line"><a name="l02355"></a><span class="lineno"> 2355</span>&#160;</div>
<div class="line"><a name="l02356"></a><span class="lineno"> 2356</span>&#160;</div>
<div class="line"><a name="l02357"></a><span class="lineno"> 2357</span>&#160;</div>
<div class="line"><a name="l02359"></a><span class="lineno"> 2359</span>&#160;              <span class="comment">//</span></div>
<div class="line"><a name="l02360"></a><span class="lineno"> 2360</span>&#160;              <span class="comment">// Things to do only if modifying density (must come after modifying velocity that enters ucon[TT])</span></div>
<div class="line"><a name="l02361"></a><span class="lineno"> 2361</span>&#160;              <span class="comment">//</span></div>
<div class="line"><a name="l02363"></a><span class="lineno"> 2363</span>&#160;<span class="comment"></span>              <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l02364"></a><span class="lineno"> 2364</span>&#160;                <span class="keywordflow">if</span>(pl==YFL4 || pl==YFL5){</div>
<div class="line"><a name="l02365"></a><span class="lineno"> 2365</span>&#160;                  <span class="keywordflow">if</span>(startpl&lt;=pl &amp;&amp; endpl&gt;=pl){</div>
<div class="line"><a name="l02366"></a><span class="lineno"> 2366</span>&#160;</div>
<div class="line"><a name="l02367"></a><span class="lineno"> 2367</span>&#160;</div>
<div class="line"><a name="l02368"></a><span class="lineno"> 2368</span>&#160;                    <span class="keywordflow">if</span>(<a class="code" href="../../de/d95/fixup_8c.html#a87882c2666708d89915909a258021528">DO_CONSERVE_D_INFAILFIXUPS</a>){</div>
<div class="line"><a name="l02369"></a><span class="lineno"> 2369</span>&#160;                      </div>
<div class="line"><a name="l02370"></a><span class="lineno"> 2370</span>&#160;                      <span class="keywordflow">if</span>(mhdlpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ad6ba8deb8dab694606b9f4a79845aada">UTOPRIMFAILGAMMAPERC</a> || 1){ <span class="comment">// GODMARK: always doing it</span></div>
<div class="line"><a name="l02371"></a><span class="lineno"> 2371</span>&#160;</div>
<div class="line"><a name="l02372"></a><span class="lineno"> 2372</span>&#160;                        <span class="keywordflow">if</span> (<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#afc93fd4a6f7a2b87a9315d5fba5a529c">ucon_calc</a>(&amp;<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,URAD1-<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>), ptrgeom, ucon,others) &gt;= 1) <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a5febb92786c5f7a1479e7e65f1c23ef3">FAILSTATEMENT</a>(<span class="stringliteral">&quot;fixup.c:utoprimfail_fixup()&quot;</span>, <span class="stringliteral">&quot;ucon_calc()&quot;</span>, 1);</div>
<div class="line"><a name="l02373"></a><span class="lineno"> 2373</span>&#160;</div>
<div class="line"><a name="l02374"></a><span class="lineno"> 2374</span>&#160;                        <span class="keywordflow">if</span>(finalstep==1){</div>
<div class="line"><a name="l02375"></a><span class="lineno"> 2375</span>&#160;                          <span class="comment">// this is not reasonable, because ignores any mass injection required during failure to make sense of solution</span></div>
<div class="line"><a name="l02376"></a><span class="lineno"> 2376</span>&#160;                          <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Unothing[NPR];</div>
<div class="line"><a name="l02377"></a><span class="lineno"> 2377</span>&#160;                          UtoU(UEVOLVE,UNOTHING,ptrgeom,<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(ucons,i,j,k),Unothing);</div>
<div class="line"><a name="l02378"></a><span class="lineno"> 2378</span>&#160;                          D0 = Unothing[pl] ;</div>
<div class="line"><a name="l02379"></a><span class="lineno"> 2379</span>&#160;                        }</div>
<div class="line"><a name="l02380"></a><span class="lineno"> 2380</span>&#160;                        <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l02381"></a><span class="lineno"> 2381</span>&#160;                          <span class="comment">// This is probably not necessary or useful</span></div>
<div class="line"><a name="l02382"></a><span class="lineno"> 2382</span>&#160;                          D0 = <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(ptoavg,i,j,k,pl)*ucon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>];</div>
<div class="line"><a name="l02383"></a><span class="lineno"> 2383</span>&#160;                        }</div>
<div class="line"><a name="l02384"></a><span class="lineno"> 2384</span>&#160;                        </div>
<div class="line"><a name="l02386"></a><span class="lineno"> 2386</span>&#160;                        <span class="comment">//</span></div>
<div class="line"><a name="l02387"></a><span class="lineno"> 2387</span>&#160;                        <span class="comment">// constrain change in density so conserve particle number</span></div>
<div class="line"><a name="l02388"></a><span class="lineno"> 2388</span>&#160;                        <span class="comment">//</span></div>
<div class="line"><a name="l02390"></a><span class="lineno"> 2390</span>&#160;<span class="comment"></span>                        <span class="keywordflow">if</span>(pl==YFL4 || pl==YFL5){</div>
<div class="line"><a name="l02391"></a><span class="lineno"> 2391</span>&#160;                          <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,pl) = D0/ucon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>];</div>
<div class="line"><a name="l02392"></a><span class="lineno"> 2392</span>&#160;                        }</div>
<div class="line"><a name="l02393"></a><span class="lineno"> 2393</span>&#160;                      }</div>
<div class="line"><a name="l02394"></a><span class="lineno"> 2394</span>&#160;                    }</div>
<div class="line"><a name="l02395"></a><span class="lineno"> 2395</span>&#160;                  }</div>
<div class="line"><a name="l02396"></a><span class="lineno"> 2396</span>&#160;                }</div>
<div class="line"><a name="l02397"></a><span class="lineno"> 2397</span>&#160;              }<span class="comment">// end over density or scalars</span></div>
<div class="line"><a name="l02398"></a><span class="lineno"> 2398</span>&#160;</div>
<div class="line"><a name="l02399"></a><span class="lineno"> 2399</span>&#160;</div>
<div class="line"><a name="l02400"></a><span class="lineno"> 2400</span>&#160;</div>
<div class="line"><a name="l02401"></a><span class="lineno"> 2401</span>&#160;</div>
<div class="line"><a name="l02402"></a><span class="lineno"> 2402</span>&#160;</div>
<div class="line"><a name="l02403"></a><span class="lineno"> 2403</span>&#160;<span class="preprocessor">#if(0)</span></div>
<div class="line"><a name="l02404"></a><span class="lineno"> 2404</span>&#160;<span class="preprocessor"></span>              <span class="comment">// DEBUG problem of launch with pressureless stellar model collapse</span></div>
<div class="line"><a name="l02405"></a><span class="lineno"> 2405</span>&#160;              <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl) dualfprintf(fail_file,<span class="stringliteral">&quot;nstep=%ld steppart=%d :: i=%d j=%d k=%d pl=%d pv=%21.15g ptoavg=%21.15g\n&quot;</span>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a1a1088d87617078680f1fd0f0d707384">nstep</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a70170b90229f9fc05eebf8508a685c70">steppart</a>,i,j,k,pl,<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,pl),<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(ptoavg,i,j,k,pl));</div>
<div class="line"><a name="l02406"></a><span class="lineno"> 2406</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02407"></a><span class="lineno"> 2407</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l02408"></a><span class="lineno"> 2408</span>&#160;</div>
<div class="line"><a name="l02409"></a><span class="lineno"> 2409</span>&#160;              <span class="comment">//              int finaluu=0;</span></div>
<div class="line"><a name="l02410"></a><span class="lineno"> 2410</span>&#160;              <span class="comment">//              consfixup_1zone(finaluu,i,j,k,ptrgeom, &amp;MACP0A1(pv,i,j,k,0),NULL);</span></div>
<div class="line"><a name="l02411"></a><span class="lineno"> 2411</span>&#160;</div>
<div class="line"><a name="l02412"></a><span class="lineno"> 2412</span>&#160;</div>
<div class="line"><a name="l02413"></a><span class="lineno"> 2413</span>&#160;            } <span class="comment">// end if fixedrad==0</span></div>
<div class="line"><a name="l02414"></a><span class="lineno"> 2414</span>&#160;          }<span class="comment">// end if not keeping static</span></div>
<div class="line"><a name="l02415"></a><span class="lineno"> 2415</span>&#160;        }<span class="comment">// end if radiation failed </span></div>
<div class="line"><a name="l02416"></a><span class="lineno"> 2416</span>&#160; </div>
<div class="line"><a name="l02417"></a><span class="lineno"> 2417</span>&#160;</div>
<div class="line"><a name="l02419"></a><span class="lineno"> 2419</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l02420"></a><span class="lineno"> 2420</span>&#160;        <span class="comment">// ACCOUNTING (static or average)</span></div>
<div class="line"><a name="l02421"></a><span class="lineno"> 2421</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l02423"></a><span class="lineno"> 2423</span>&#160;<span class="comment"></span>        fixuputoprim_accounting(i, j, k, mhdlpflag, radlpflag, limitgammamhd, limitgammarad, <a class="code" href="../../df/d1c/global_8storage_8h.html#ad89dafa5d772b862a44b0f576983ead3" title="shifted pointer (a_s_) wrappers Couldn&#39;t figure out how to macrofy a_s_ or a_, so when changing have ...">GLOBALPOINT</a>(pflag),pv,ptoavg, ptrgeom, pr0, ucons, finalstep);</div>
<div class="line"><a name="l02424"></a><span class="lineno"> 2424</span>&#160;</div>
<div class="line"><a name="l02425"></a><span class="lineno"> 2425</span>&#160;</div>
<div class="line"><a name="l02426"></a><span class="lineno"> 2426</span>&#160;      }<span class="comment">// if fixing mhd or fixing radiation  </span></div>
<div class="line"><a name="l02427"></a><span class="lineno"> 2427</span>&#160;   </div>
<div class="line"><a name="l02428"></a><span class="lineno"> 2428</span>&#160;    }<span class="comment">// end over COMPZLOOP loop</span></div>
<div class="line"><a name="l02429"></a><span class="lineno"> 2429</span>&#160;  }<span class="comment">// end over parallel region</span></div>
<div class="line"><a name="l02430"></a><span class="lineno"> 2430</span>&#160;</div>
<div class="line"><a name="l02431"></a><span class="lineno"> 2431</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l02432"></a><span class="lineno"> 2432</span>&#160;}</div>
<div class="line"><a name="l02433"></a><span class="lineno"> 2433</span>&#160;</div>
<div class="line"><a name="l02434"></a><span class="lineno"> 2434</span>&#160;</div>
<div class="line"><a name="l02435"></a><span class="lineno"> 2435</span>&#160;</div>
<div class="line"><a name="l02436"></a><span class="lineno"> 2436</span>&#160;</div>
<div class="line"><a name="l02437"></a><span class="lineno"> 2437</span>&#160;</div>
<div class="line"><a name="l02438"></a><span class="lineno"> 2438</span>&#160;</div>
<div class="line"><a name="l02439"></a><span class="lineno"> 2439</span>&#160;</div>
<div class="line"><a name="l02440"></a><span class="lineno"> 2440</span>&#160;</div>
<div class="line"><a name="l02442"></a><span class="lineno"> 2442</span>&#160;<span class="keywordtype">int</span> fixup_utoprim_nofixup(<span class="keywordtype">int</span> stage, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pv)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pbackup)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*ucons)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR], <span class="keywordtype">int</span> finalstep)</div>
<div class="line"><a name="l02443"></a><span class="lineno"> 2443</span>&#160;{</div>
<div class="line"><a name="l02444"></a><span class="lineno"> 2444</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*ptoavg)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR];</div>
<div class="line"><a name="l02445"></a><span class="lineno"> 2445</span>&#160;</div>
<div class="line"><a name="l02446"></a><span class="lineno"> 2446</span>&#160;  <span class="comment">// this average only works if using 4 velocity since only then guaranteed solution is good after interpolation</span></div>
<div class="line"><a name="l02447"></a><span class="lineno"> 2447</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#a3d14480f30d39eff4e51ae8bc93df56f" title="whether we use ultimately precise inversion or &quot;workable&quot; inversion precision (see utoprim&#39;s for ho...">WHICHVEL</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a22de13ceb1d46983868c7f22fbd0201a">VEL3</a>) <span class="keywordflow">return</span>(0); <span class="comment">// just stick with static, best can do</span></div>
<div class="line"><a name="l02448"></a><span class="lineno"> 2448</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#a87e5572748e4cc27373e50bd78e6f2e8">EOMTYPE</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6f6094bc467dc61f9490ad7e1de63580">EOMFFDE</a> || <a class="code" href="../../da/d3e/definit_8h.html#a87e5572748e4cc27373e50bd78e6f2e8">EOMTYPE</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a30a753538ac3bf4801ac123a37dfcc57">EOMFFDE2</a>) <span class="keywordflow">return</span>(0); <span class="comment">// nothing to do</span></div>
<div class="line"><a name="l02449"></a><span class="lineno"> 2449</span>&#160;</div>
<div class="line"><a name="l02450"></a><span class="lineno"> 2450</span>&#160;</div>
<div class="line"><a name="l02452"></a><span class="lineno"> 2452</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02453"></a><span class="lineno"> 2453</span>&#160;  <span class="comment">// Just loop over and only report problems</span></div>
<div class="line"><a name="l02454"></a><span class="lineno"> 2454</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02456"></a><span class="lineno"> 2456</span>&#160;<span class="comment"></span>  </div>
<div class="line"><a name="l02457"></a><span class="lineno"> 2457</span>&#160;  ptoavg=pv;</div>
<div class="line"><a name="l02458"></a><span class="lineno"> 2458</span>&#160;</div>
<div class="line"><a name="l02459"></a><span class="lineno"> 2459</span>&#160;</div>
<div class="line"><a name="l02461"></a><span class="lineno"> 2461</span>&#160;<span class="preprocessor">#pragma omp parallel OPENMPGLOBALPRIVATEFORSTATEANDGEOM // accounting requires state stuff</span></div>
<div class="line"><a name="l02462"></a><span class="lineno"> 2462</span>&#160;<span class="preprocessor"></span>  {</div>
<div class="line"><a name="l02463"></a><span class="lineno"> 2463</span>&#160;    <span class="keywordtype">int</span> <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>,<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>,k,pl,pliter;</div>
<div class="line"><a name="l02464"></a><span class="lineno"> 2464</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> pr0[NPR];</div>
<div class="line"><a name="l02465"></a><span class="lineno"> 2465</span>&#160;    <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> mhdlpflag,radlpflag;</div>
<div class="line"><a name="l02466"></a><span class="lineno"> 2466</span>&#160;    <span class="keyword">struct </span><a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> geomdontuse;</div>
<div class="line"><a name="l02467"></a><span class="lineno"> 2467</span>&#160;    <span class="keyword">struct </span><a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom=&amp;geomdontuse;</div>
<div class="line"><a name="l02468"></a><span class="lineno"> 2468</span>&#160;</div>
<div class="line"><a name="l02469"></a><span class="lineno"> 2469</span>&#160;</div>
<div class="line"><a name="l02470"></a><span class="lineno"> 2470</span>&#160;    <a class="code" href="../../d5/d7b/global_8openmploops_8h.html#a1389db2daf5bd9e94918090c253a16c9">OPENMP3DLOOPVARSDEFINE</a>; <a class="code" href="../../d5/d7b/global_8openmploops_8h.html#a865b7d98f1e7cba888ee63d052621383" title="COMPZLOOP equivalent for OpenMP.">OPENMP3DLOOPSETUPZLOOP</a>;</div>
<div class="line"><a name="l02471"></a><span class="lineno"> 2471</span>&#160;<span class="preprocessor">#pragma omp for schedule(OPENMPSCHEDULE(),OPENMPCHUNKSIZE(blocksize))</span></div>
<div class="line"><a name="l02472"></a><span class="lineno"> 2472</span>&#160;<span class="preprocessor"></span>    <a class="code" href="../../d5/d7b/global_8openmploops_8h.html#a9e48537d3cb58cc3a3765b8a18b43b15" title="Oddly, performance changes by 10% when changing how start and stop blockijk (and fixing how used too ...">OPENMP3DLOOPBLOCK</a>{</div>
<div class="line"><a name="l02473"></a><span class="lineno"> 2473</span>&#160;      <a class="code" href="../../df/d1c/global_8storage_8h.html#a96983b0c56e836f50cb7c1af16f59fb6">OPENMP3DLOOPBLOCK2IJK</a>(i,j,k);</div>
<div class="line"><a name="l02474"></a><span class="lineno"> 2474</span>&#160;</div>
<div class="line"><a name="l02475"></a><span class="lineno"> 2475</span>&#160;</div>
<div class="line"><a name="l02476"></a><span class="lineno"> 2476</span>&#160;      <span class="comment">// get failure flag</span></div>
<div class="line"><a name="l02477"></a><span class="lineno"> 2477</span>&#160;      mhdlpflag=GLOBALMACP0A1(pflag,i,j,k,FLAGUTOPRIMFAIL);</div>
<div class="line"><a name="l02478"></a><span class="lineno"> 2478</span>&#160;      radlpflag=GLOBALMACP0A1(pflag,i,j,k,FLAGUTOPRIMRADFAIL);</div>
<div class="line"><a name="l02479"></a><span class="lineno"> 2479</span>&#160;</div>
<div class="line"><a name="l02480"></a><span class="lineno"> 2480</span>&#160;</div>
<div class="line"><a name="l02481"></a><span class="lineno"> 2481</span>&#160;      <span class="keywordflow">if</span>(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0894a5e6c53e2e8a143d10be7a42d492">IFUTOPRIMFAIL</a>(mhdlpflag)||<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0894a5e6c53e2e8a143d10be7a42d492">IFUTOPRIMFAIL</a>(radlpflag)){</div>
<div class="line"><a name="l02482"></a><span class="lineno"> 2482</span>&#160; </div>
<div class="line"><a name="l02483"></a><span class="lineno"> 2483</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl)    pr0[pl]=<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(ptoavg,i,j,k,pl);</div>
<div class="line"><a name="l02484"></a><span class="lineno"> 2484</span>&#160;        <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a3059ed7bfcfb692cbe8014d55fd7c1e4">get_geometry</a>(i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8936711f57f82d1fc75c21fa2894e1c6">CENT</a>,ptrgeom);</div>
<div class="line"><a name="l02485"></a><span class="lineno"> 2485</span>&#160; </div>
<div class="line"><a name="l02487"></a><span class="lineno"> 2487</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l02488"></a><span class="lineno"> 2488</span>&#160;        <span class="comment">// ACCOUNTING (static or average)</span></div>
<div class="line"><a name="l02489"></a><span class="lineno"> 2489</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l02491"></a><span class="lineno"> 2491</span>&#160;<span class="comment"></span>        fixuputoprim_accounting(i, j, k, mhdlpflag, radlpflag, 0, 0, <a class="code" href="../../df/d1c/global_8storage_8h.html#ad89dafa5d772b862a44b0f576983ead3" title="shifted pointer (a_s_) wrappers Couldn&#39;t figure out how to macrofy a_s_ or a_, so when changing have ...">GLOBALPOINT</a>(pflag),pv,ptoavg, ptrgeom, pr0, ucons, finalstep);</div>
<div class="line"><a name="l02492"></a><span class="lineno"> 2492</span>&#160;   </div>
<div class="line"><a name="l02493"></a><span class="lineno"> 2493</span>&#160;      }<span class="comment">// end if failure</span></div>
<div class="line"><a name="l02494"></a><span class="lineno"> 2494</span>&#160;    }<span class="comment">// end over COMPZLOOP loop</span></div>
<div class="line"><a name="l02495"></a><span class="lineno"> 2495</span>&#160;  }<span class="comment">// end over parallel region</span></div>
<div class="line"><a name="l02496"></a><span class="lineno"> 2496</span>&#160;</div>
<div class="line"><a name="l02497"></a><span class="lineno"> 2497</span>&#160;  return(0);</div>
<div class="line"><a name="l02498"></a><span class="lineno"> 2498</span>&#160;}</div>
<div class="line"><a name="l02499"></a><span class="lineno"> 2499</span>&#160;</div>
<div class="line"><a name="l02500"></a><span class="lineno"> 2500</span>&#160;</div>
<div class="line"><a name="l02501"></a><span class="lineno"> 2501</span>&#160;</div>
<div class="line"><a name="l02502"></a><span class="lineno"> 2502</span>&#160;</div>
<div class="line"><a name="l02503"></a><span class="lineno"> 2503</span>&#160;</div>
<div class="line"><a name="l02504"></a><span class="lineno"> 2504</span>&#160;</div>
<div class="line"><a name="l02505"></a><span class="lineno"> 2505</span>&#160;</div>
<div class="line"><a name="l02506"></a><span class="lineno"> 2506</span>&#160;</div>
<div class="line"><a name="l02507"></a><span class="lineno"> 2507</span>&#160;</div>
<div class="line"><a name="l02509"></a><span class="lineno"> 2509</span>&#160;static <span class="keywordtype">int</span> fixup_negdensities(<span class="keywordtype">int</span> whicheomset, <span class="keywordtype">int</span> *fixed, <span class="keywordtype">int</span> startpl, <span class="keywordtype">int</span> endpl, <span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> lpflag, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pv)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*ptoavg)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR], struct <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr0, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*ucons)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR], <span class="keywordtype">int</span> finalstep)</div>
<div class="line"><a name="l02510"></a><span class="lineno"> 2510</span>&#160;{</div>
<div class="line"><a name="l02511"></a><span class="lineno"> 2511</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> prguess[NPR],prceiling[NPR];</div>
<div class="line"><a name="l02512"></a><span class="lineno"> 2512</span>&#160;</div>
<div class="line"><a name="l02513"></a><span class="lineno"> 2513</span>&#160;</div>
<div class="line"><a name="l02514"></a><span class="lineno"> 2514</span>&#160;  <span class="keywordflow">if</span>(whicheomset==<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#adb456e768bc8848a978ac49b06194bbd">EOMSETMHD</a>){</div>
<div class="line"><a name="l02516"></a><span class="lineno"> 2516</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02517"></a><span class="lineno"> 2517</span>&#160;    <span class="comment">// deal with negative internal energy as special case of failure</span></div>
<div class="line"><a name="l02518"></a><span class="lineno"> 2518</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02519"></a><span class="lineno"> 2519</span>&#160;</div>
<div class="line"><a name="l02520"></a><span class="lineno"> 2520</span>&#160;    <span class="keywordflow">if</span>(*fixed!=0){</div>
<div class="line"><a name="l02521"></a><span class="lineno"> 2521</span>&#160;      <span class="keywordflow">if</span>(lpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a17c167aa50c0750a25baba351db69740">UTOPRIMFAILUNEG</a>){</div>
<div class="line"><a name="l02522"></a><span class="lineno"> 2522</span>&#160;   </div>
<div class="line"><a name="l02523"></a><span class="lineno"> 2523</span>&#160;        <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#a01d34fa922c4eaac94e27f2179523626" title="whether to allow negative internal energy in substep UTOPRIMFAILRETURNTYPE==UTOPRIMRETURNADJUSTED sho...">STEPOVERNEGU</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae8f476756e2b5ced42c76e0536c77369" title="STEPOVERNEGXXX: possible modes of stepping over occurences of negative densities: controls when to re...">NEGDENSITY_NEVERFIXUP</a>){ <span class="keywordflow">if</span>(<a class="code" href="../../de/d95/fixup_8c.html#aa9d04e5483d7cc6a8e71924763748705">HANDLEUNEG</a>==1) *fixed=1; }</div>
<div class="line"><a name="l02524"></a><span class="lineno"> 2524</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>((<a class="code" href="../../da/d3e/definit_8h.html#a01d34fa922c4eaac94e27f2179523626" title="whether to allow negative internal energy in substep UTOPRIMFAILRETURNTYPE==UTOPRIMRETURNADJUSTED sho...">STEPOVERNEGU</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aadfa6222f83a05ce3739fedf420bdfea">NEGDENSITY_ALWAYSFIXUP</a>)||(<a class="code" href="../../da/d3e/definit_8h.html#a01d34fa922c4eaac94e27f2179523626" title="whether to allow negative internal energy in substep UTOPRIMFAILRETURNTYPE==UTOPRIMRETURNADJUSTED sho...">STEPOVERNEGU</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#af662b2a90aec340ab38528c25b7b5aa6">NEGDENSITY_FIXONFULLSTEP</a> &amp;&amp; finalstep)){</div>
<div class="line"><a name="l02525"></a><span class="lineno"> 2525</span>&#160;</div>
<div class="line"><a name="l02526"></a><span class="lineno"> 2526</span>&#160;          <span class="keywordflow">if</span>(<a class="code" href="../../de/d95/fixup_8c.html#aa9d04e5483d7cc6a8e71924763748705">HANDLEUNEG</a>==1){</div>
<div class="line"><a name="l02527"></a><span class="lineno"> 2527</span>&#160;            <span class="comment">// set back to floor level</span></div>
<div class="line"><a name="l02528"></a><span class="lineno"> 2528</span>&#160;            set_density_floors(ptrgeom,<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(pv,i,j,k),prguess,prceiling);</div>
<div class="line"><a name="l02529"></a><span class="lineno"> 2529</span>&#160;            <span class="comment">// GODMARK -- maybe too agressive, maybe allow more negative?</span></div>
<div class="line"><a name="l02530"></a><span class="lineno"> 2530</span>&#160;  </div>
<div class="line"><a name="l02531"></a><span class="lineno"> 2531</span>&#160;            <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#af7f8bb0dd82ef282496bd6d11f919be1" title="0: return non-updated quantities 1: if u&lt;0 or rho&lt;0, then return updated quantities, else return non-updated quantities">UTOPRIMFAILRETURNTYPE</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae45d7fdd916bc9cf67ed08dcc627068b">UTOPRIMRETURNADJUSTED</a>){</div>
<div class="line"><a name="l02532"></a><span class="lineno"> 2532</span>&#160;              <span class="comment">// then pv is previous timestep value and can use to make fix</span></div>
<div class="line"><a name="l02533"></a><span class="lineno"> 2533</span>&#160;              <span class="keywordflow">if</span>(-<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>)&lt;prguess[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]){ *fixed=1; <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,UU)=prguess[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>];} <span class="comment">// otherwise assume really so bad that failure</span></div>
<div class="line"><a name="l02534"></a><span class="lineno"> 2534</span>&#160;            }</div>
<div class="line"><a name="l02535"></a><span class="lineno"> 2535</span>&#160;            <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l02536"></a><span class="lineno"> 2536</span>&#160;              <span class="comment">// just treat as floor for all failures since do not know what updated quantity is</span></div>
<div class="line"><a name="l02537"></a><span class="lineno"> 2537</span>&#160;              <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>)=prguess[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>];</div>
<div class="line"><a name="l02538"></a><span class="lineno"> 2538</span>&#160;              *fixed=1;</div>
<div class="line"><a name="l02539"></a><span class="lineno"> 2539</span>&#160;            }</div>
<div class="line"><a name="l02540"></a><span class="lineno"> 2540</span>&#160;          }<span class="comment">// end if handling u&lt;zerouuperbaryon*prim[RHO] in special way</span></div>
<div class="line"><a name="l02541"></a><span class="lineno"> 2541</span>&#160;        }<span class="comment">// end if not allowing negative u or if allowing but not yet final step</span></div>
<div class="line"><a name="l02542"></a><span class="lineno"> 2542</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>((<a class="code" href="../../da/d3e/definit_8h.html#a01d34fa922c4eaac94e27f2179523626" title="whether to allow negative internal energy in substep UTOPRIMFAILRETURNTYPE==UTOPRIMRETURNADJUSTED sho...">STEPOVERNEGU</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#af662b2a90aec340ab38528c25b7b5aa6">NEGDENSITY_FIXONFULLSTEP</a>)&amp;&amp;(!finalstep)){</div>
<div class="line"><a name="l02543"></a><span class="lineno"> 2543</span>&#160;          <span class="keywordflow">if</span>(<a class="code" href="../../de/d95/fixup_8c.html#aa9d04e5483d7cc6a8e71924763748705">HANDLEUNEG</a>==1) *fixed=1; <span class="comment">// tells rest of routine to leave alone and say ok solution, but don&#39;t use it to fix convergence failures for other zones</span></div>
<div class="line"><a name="l02544"></a><span class="lineno"> 2544</span>&#160;        }</div>
<div class="line"><a name="l02545"></a><span class="lineno"> 2545</span>&#160;      }<span class="comment">// end if u&lt;zerouuperbaryon*prim[RHO]</span></div>
<div class="line"><a name="l02546"></a><span class="lineno"> 2546</span>&#160;    }<span class="comment">// end if not fixed</span></div>
<div class="line"><a name="l02547"></a><span class="lineno"> 2547</span>&#160;</div>
<div class="line"><a name="l02548"></a><span class="lineno"> 2548</span>&#160;</div>
<div class="line"><a name="l02550"></a><span class="lineno"> 2550</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02551"></a><span class="lineno"> 2551</span>&#160;    <span class="comment">// deal with negative density as special case of failure (as for internal energy above)</span></div>
<div class="line"><a name="l02552"></a><span class="lineno"> 2552</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02553"></a><span class="lineno"> 2553</span>&#160;</div>
<div class="line"><a name="l02554"></a><span class="lineno"> 2554</span>&#160;    <span class="keywordflow">if</span>(*fixed!=0){</div>
<div class="line"><a name="l02555"></a><span class="lineno"> 2555</span>&#160;      <span class="keywordflow">if</span>(lpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ad5bd994b947d2a46102582b38e4b1529">UTOPRIMFAILRHONEG</a>){</div>
<div class="line"><a name="l02556"></a><span class="lineno"> 2556</span>&#160;   </div>
<div class="line"><a name="l02557"></a><span class="lineno"> 2557</span>&#160;        <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#a23eeede57657104811b4f7e5e7dda656" title="seems to make things worse (more failures, but also worse failures)">STEPOVERNEGRHO</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae8f476756e2b5ced42c76e0536c77369" title="STEPOVERNEGXXX: possible modes of stepping over occurences of negative densities: controls when to re...">NEGDENSITY_NEVERFIXUP</a>){ <span class="keywordflow">if</span>(<a class="code" href="../../de/d95/fixup_8c.html#a9a6f871146b8c53c825eb272435083d5">HANDLERHONEG</a>) *fixed=1; }</div>
<div class="line"><a name="l02558"></a><span class="lineno"> 2558</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>((<a class="code" href="../../da/d3e/definit_8h.html#a23eeede57657104811b4f7e5e7dda656" title="seems to make things worse (more failures, but also worse failures)">STEPOVERNEGRHO</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aadfa6222f83a05ce3739fedf420bdfea">NEGDENSITY_ALWAYSFIXUP</a>)||(<a class="code" href="../../da/d3e/definit_8h.html#a23eeede57657104811b4f7e5e7dda656" title="seems to make things worse (more failures, but also worse failures)">STEPOVERNEGRHO</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#af662b2a90aec340ab38528c25b7b5aa6">NEGDENSITY_FIXONFULLSTEP</a> &amp;&amp; finalstep)){</div>
<div class="line"><a name="l02559"></a><span class="lineno"> 2559</span>&#160;</div>
<div class="line"><a name="l02560"></a><span class="lineno"> 2560</span>&#160;          <span class="keywordflow">if</span>(<a class="code" href="../../de/d95/fixup_8c.html#a9a6f871146b8c53c825eb272435083d5">HANDLERHONEG</a>==1){</div>
<div class="line"><a name="l02561"></a><span class="lineno"> 2561</span>&#160;            <span class="comment">// set back to floor level</span></div>
<div class="line"><a name="l02562"></a><span class="lineno"> 2562</span>&#160;            set_density_floors(ptrgeom,<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(pv,i,j,k),prguess,prceiling);</div>
<div class="line"><a name="l02563"></a><span class="lineno"> 2563</span>&#160;            <span class="comment">// GODMARK -- maybe too agressive, maybe allow more negative?</span></div>
<div class="line"><a name="l02564"></a><span class="lineno"> 2564</span>&#160;  </div>
<div class="line"><a name="l02565"></a><span class="lineno"> 2565</span>&#160;            <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#af7f8bb0dd82ef282496bd6d11f919be1" title="0: return non-updated quantities 1: if u&lt;0 or rho&lt;0, then return updated quantities, else return non-updated quantities">UTOPRIMFAILRETURNTYPE</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae45d7fdd916bc9cf67ed08dcc627068b">UTOPRIMRETURNADJUSTED</a>){</div>
<div class="line"><a name="l02566"></a><span class="lineno"> 2566</span>&#160;              <span class="comment">// then pv is previous timestep value and can use to make fix</span></div>
<div class="line"><a name="l02567"></a><span class="lineno"> 2567</span>&#160;              <span class="keywordflow">if</span>(-<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>)&lt;prguess[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>]){ *fixed=1; <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,RHO)=prguess[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>];} <span class="comment">// otherwise assume really so bad that failure</span></div>
<div class="line"><a name="l02568"></a><span class="lineno"> 2568</span>&#160;            }</div>
<div class="line"><a name="l02569"></a><span class="lineno"> 2569</span>&#160;            <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l02570"></a><span class="lineno"> 2570</span>&#160;              <span class="comment">// just treat as floor for all failures since do not know what updated quantity is</span></div>
<div class="line"><a name="l02571"></a><span class="lineno"> 2571</span>&#160;              <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>)=prguess[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>];</div>
<div class="line"><a name="l02572"></a><span class="lineno"> 2572</span>&#160;              *fixed=1;</div>
<div class="line"><a name="l02573"></a><span class="lineno"> 2573</span>&#160;            }</div>
<div class="line"><a name="l02574"></a><span class="lineno"> 2574</span>&#160;          }<span class="comment">// end if handling rho&lt;0 in special way</span></div>
<div class="line"><a name="l02575"></a><span class="lineno"> 2575</span>&#160;        }<span class="comment">// end if not allowing negative rho or if allowing but not yet final step</span></div>
<div class="line"><a name="l02576"></a><span class="lineno"> 2576</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>((<a class="code" href="../../da/d3e/definit_8h.html#a23eeede57657104811b4f7e5e7dda656" title="seems to make things worse (more failures, but also worse failures)">STEPOVERNEGRHO</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#af662b2a90aec340ab38528c25b7b5aa6">NEGDENSITY_FIXONFULLSTEP</a>)&amp;&amp;(!finalstep)){</div>
<div class="line"><a name="l02577"></a><span class="lineno"> 2577</span>&#160;          <span class="keywordflow">if</span>(<a class="code" href="../../de/d95/fixup_8c.html#a9a6f871146b8c53c825eb272435083d5">HANDLERHONEG</a>) *fixed=1; <span class="comment">// tells rest of routine to leave alone and say ok solution, but don&#39;t use it to fix convergence failures for other zones</span></div>
<div class="line"><a name="l02578"></a><span class="lineno"> 2578</span>&#160;        }</div>
<div class="line"><a name="l02579"></a><span class="lineno"> 2579</span>&#160;      }<span class="comment">// end if rho&lt;0</span></div>
<div class="line"><a name="l02580"></a><span class="lineno"> 2580</span>&#160;    }<span class="comment">// end if not fixed</span></div>
<div class="line"><a name="l02581"></a><span class="lineno"> 2581</span>&#160;</div>
<div class="line"><a name="l02582"></a><span class="lineno"> 2582</span>&#160;</div>
<div class="line"><a name="l02583"></a><span class="lineno"> 2583</span>&#160;</div>
<div class="line"><a name="l02585"></a><span class="lineno"> 2585</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02586"></a><span class="lineno"> 2586</span>&#160;    <span class="comment">// deal with negative density and negative internal energy as special case of failure (as for internal energy above)</span></div>
<div class="line"><a name="l02587"></a><span class="lineno"> 2587</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02588"></a><span class="lineno"> 2588</span>&#160;</div>
<div class="line"><a name="l02589"></a><span class="lineno"> 2589</span>&#160;    <span class="keywordflow">if</span>(*fixed!=0){</div>
<div class="line"><a name="l02590"></a><span class="lineno"> 2590</span>&#160;      <span class="keywordflow">if</span>(lpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a24290f84c3e2b725f7cbbdff81da4760">UTOPRIMFAILRHOUNEG</a>){</div>
<div class="line"><a name="l02591"></a><span class="lineno"> 2591</span>&#160;</div>
<div class="line"><a name="l02592"></a><span class="lineno"> 2592</span>&#160;        <span class="keywordflow">if</span>(<a class="code" href="../../d8/dc0/init_8h.html#a352ef6d348d5c3986dc77165755b8733">STEPOVERNEGRHOU</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae8f476756e2b5ced42c76e0536c77369" title="STEPOVERNEGXXX: possible modes of stepping over occurences of negative densities: controls when to re...">NEGDENSITY_NEVERFIXUP</a>){ <span class="keywordflow">if</span>(<a class="code" href="../../de/d95/fixup_8c.html#a7500256c2ba86b67ce5059a9b525e7ef">HANDLERHOUNEG</a>) *fixed=1; }</div>
<div class="line"><a name="l02593"></a><span class="lineno"> 2593</span>&#160;        <span class="comment">// GODMARK: Why use STEPOVERNEGU and STEPOVERNEGRH instead of STEPOVERNEGRHOU below?</span></div>
<div class="line"><a name="l02594"></a><span class="lineno"> 2594</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>( (<a class="code" href="../../d8/dc0/init_8h.html#a352ef6d348d5c3986dc77165755b8733">STEPOVERNEGRHOU</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aadfa6222f83a05ce3739fedf420bdfea">NEGDENSITY_ALWAYSFIXUP</a>)  ||(<a class="code" href="../../da/d3e/definit_8h.html#a01d34fa922c4eaac94e27f2179523626" title="whether to allow negative internal energy in substep UTOPRIMFAILRETURNTYPE==UTOPRIMRETURNADJUSTED sho...">STEPOVERNEGU</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#af662b2a90aec340ab38528c25b7b5aa6">NEGDENSITY_FIXONFULLSTEP</a> &amp;&amp; <a class="code" href="../../da/d3e/definit_8h.html#a23eeede57657104811b4f7e5e7dda656" title="seems to make things worse (more failures, but also worse failures)">STEPOVERNEGRHO</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#af662b2a90aec340ab38528c25b7b5aa6">NEGDENSITY_FIXONFULLSTEP</a> &amp;&amp; finalstep)){</div>
<div class="line"><a name="l02595"></a><span class="lineno"> 2595</span>&#160;</div>
<div class="line"><a name="l02596"></a><span class="lineno"> 2596</span>&#160;          <span class="keywordflow">if</span>(<a class="code" href="../../de/d95/fixup_8c.html#a7500256c2ba86b67ce5059a9b525e7ef">HANDLERHOUNEG</a>==1){</div>
<div class="line"><a name="l02597"></a><span class="lineno"> 2597</span>&#160;            <span class="comment">// set back to floor level</span></div>
<div class="line"><a name="l02598"></a><span class="lineno"> 2598</span>&#160;            set_density_floors(ptrgeom,<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(pv,i,j,k),prguess,prceiling);</div>
<div class="line"><a name="l02599"></a><span class="lineno"> 2599</span>&#160;            <span class="comment">// GODMARK -- maybe too agressive, maybe allow more negative?</span></div>
<div class="line"><a name="l02600"></a><span class="lineno"> 2600</span>&#160;  </div>
<div class="line"><a name="l02601"></a><span class="lineno"> 2601</span>&#160;            <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#af7f8bb0dd82ef282496bd6d11f919be1" title="0: return non-updated quantities 1: if u&lt;0 or rho&lt;0, then return updated quantities, else return non-updated quantities">UTOPRIMFAILRETURNTYPE</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae45d7fdd916bc9cf67ed08dcc627068b">UTOPRIMRETURNADJUSTED</a>){</div>
<div class="line"><a name="l02602"></a><span class="lineno"> 2602</span>&#160;              <span class="comment">// then pv is previous timestep value and can use to make fix</span></div>
<div class="line"><a name="l02603"></a><span class="lineno"> 2603</span>&#160;              <span class="keywordflow">if</span>(-<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>)&lt;prguess[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]){ *fixed=1; <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,UU)=prguess[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>];} <span class="comment">// otherwise assume really so bad that failure</span></div>
<div class="line"><a name="l02604"></a><span class="lineno"> 2604</span>&#160;              <span class="keywordflow">if</span>(-<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>)&lt;prguess[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>]){ *fixed=1; <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,RHO)=prguess[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>];} <span class="comment">// otherwise assume really so bad that failure</span></div>
<div class="line"><a name="l02605"></a><span class="lineno"> 2605</span>&#160;            }</div>
<div class="line"><a name="l02606"></a><span class="lineno"> 2606</span>&#160;            <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l02607"></a><span class="lineno"> 2607</span>&#160;              <span class="comment">// just treat as floor for all failures since do not know what updated quantity is</span></div>
<div class="line"><a name="l02608"></a><span class="lineno"> 2608</span>&#160;              <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,UU)=prguess[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>];</div>
<div class="line"><a name="l02609"></a><span class="lineno"> 2609</span>&#160;              <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>)=prguess[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>];</div>
<div class="line"><a name="l02610"></a><span class="lineno"> 2610</span>&#160;              *fixed=1;</div>
<div class="line"><a name="l02611"></a><span class="lineno"> 2611</span>&#160;            }</div>
<div class="line"><a name="l02612"></a><span class="lineno"> 2612</span>&#160;          }<span class="comment">// end if handling rho&lt;0 and u&lt;zerouuperbaryon*prim[RHO] in special way</span></div>
<div class="line"><a name="l02613"></a><span class="lineno"> 2613</span>&#160;        }<span class="comment">// end if not allowing negative rho or if allowing but not yet final step</span></div>
<div class="line"><a name="l02614"></a><span class="lineno"> 2614</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../d8/dc0/init_8h.html#a352ef6d348d5c3986dc77165755b8733">STEPOVERNEGRHOU</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#af662b2a90aec340ab38528c25b7b5aa6">NEGDENSITY_FIXONFULLSTEP</a> &amp;&amp;(!finalstep)){</div>
<div class="line"><a name="l02615"></a><span class="lineno"> 2615</span>&#160;          <span class="keywordflow">if</span>(<a class="code" href="../../de/d95/fixup_8c.html#a7500256c2ba86b67ce5059a9b525e7ef">HANDLERHOUNEG</a>) *fixed=1; <span class="comment">// tells rest of routine to leave alone and say ok solution, but don&#39;t use it to fix convergence failures for other zones</span></div>
<div class="line"><a name="l02616"></a><span class="lineno"> 2616</span>&#160;        }</div>
<div class="line"><a name="l02617"></a><span class="lineno"> 2617</span>&#160;      }<span class="comment">// end if rho&lt;0 and u&lt;zerouuperbaryon*prim[RHO]</span></div>
<div class="line"><a name="l02618"></a><span class="lineno"> 2618</span>&#160;    }<span class="comment">// end if not fixed</span></div>
<div class="line"><a name="l02619"></a><span class="lineno"> 2619</span>&#160;  }</div>
<div class="line"><a name="l02620"></a><span class="lineno"> 2620</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(whicheomset==<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#af1a7c8e357fefc78efe71526c0630a61">EOMSETRAD</a>){</div>
<div class="line"><a name="l02621"></a><span class="lineno"> 2621</span>&#160;</div>
<div class="line"><a name="l02623"></a><span class="lineno"> 2623</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02624"></a><span class="lineno"> 2624</span>&#160;    <span class="comment">// deal with negative internal energy as special case of failure</span></div>
<div class="line"><a name="l02625"></a><span class="lineno"> 2625</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02626"></a><span class="lineno"> 2626</span>&#160;</div>
<div class="line"><a name="l02627"></a><span class="lineno"> 2627</span>&#160;    <span class="keywordflow">if</span>(*fixed!=0){</div>
<div class="line"><a name="l02628"></a><span class="lineno"> 2628</span>&#160;      <span class="keywordflow">if</span>(lpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a38b0585ec02d900ad0413645acb00918">UTOPRIMRADFAILERFNEG</a>){</div>
<div class="line"><a name="l02629"></a><span class="lineno"> 2629</span>&#160;   </div>
<div class="line"><a name="l02630"></a><span class="lineno"> 2630</span>&#160;        <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#a01d34fa922c4eaac94e27f2179523626" title="whether to allow negative internal energy in substep UTOPRIMFAILRETURNTYPE==UTOPRIMRETURNADJUSTED sho...">STEPOVERNEGU</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae8f476756e2b5ced42c76e0536c77369" title="STEPOVERNEGXXX: possible modes of stepping over occurences of negative densities: controls when to re...">NEGDENSITY_NEVERFIXUP</a>){ <span class="keywordflow">if</span>(<a class="code" href="../../de/d95/fixup_8c.html#aa9d04e5483d7cc6a8e71924763748705">HANDLEUNEG</a>==1) *fixed=1; }</div>
<div class="line"><a name="l02631"></a><span class="lineno"> 2631</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>((<a class="code" href="../../da/d3e/definit_8h.html#a01d34fa922c4eaac94e27f2179523626" title="whether to allow negative internal energy in substep UTOPRIMFAILRETURNTYPE==UTOPRIMRETURNADJUSTED sho...">STEPOVERNEGU</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aadfa6222f83a05ce3739fedf420bdfea">NEGDENSITY_ALWAYSFIXUP</a>)||(<a class="code" href="../../da/d3e/definit_8h.html#a01d34fa922c4eaac94e27f2179523626" title="whether to allow negative internal energy in substep UTOPRIMFAILRETURNTYPE==UTOPRIMRETURNADJUSTED sho...">STEPOVERNEGU</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#af662b2a90aec340ab38528c25b7b5aa6">NEGDENSITY_FIXONFULLSTEP</a> &amp;&amp; finalstep)){</div>
<div class="line"><a name="l02632"></a><span class="lineno"> 2632</span>&#160;</div>
<div class="line"><a name="l02633"></a><span class="lineno"> 2633</span>&#160;          <span class="keywordflow">if</span>(<a class="code" href="../../de/d95/fixup_8c.html#aa9d04e5483d7cc6a8e71924763748705">HANDLEUNEG</a>==1){</div>
<div class="line"><a name="l02634"></a><span class="lineno"> 2634</span>&#160;            <span class="comment">// set back to floor level</span></div>
<div class="line"><a name="l02635"></a><span class="lineno"> 2635</span>&#160;            prguess[URAD0]=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a5bd9da451f108352614cbc457524c5b0">ERADLIMIT</a>;</div>
<div class="line"><a name="l02636"></a><span class="lineno"> 2636</span>&#160;  </div>
<div class="line"><a name="l02637"></a><span class="lineno"> 2637</span>&#160;            <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#af7f8bb0dd82ef282496bd6d11f919be1" title="0: return non-updated quantities 1: if u&lt;0 or rho&lt;0, then return updated quantities, else return non-updated quantities">UTOPRIMFAILRETURNTYPE</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae45d7fdd916bc9cf67ed08dcc627068b">UTOPRIMRETURNADJUSTED</a>){</div>
<div class="line"><a name="l02638"></a><span class="lineno"> 2638</span>&#160;              <span class="comment">// then pv is previous timestep value and can use to make fix</span></div>
<div class="line"><a name="l02639"></a><span class="lineno"> 2639</span>&#160;              <span class="keywordflow">if</span>(-<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,URAD0)&lt;prguess[URAD0]){ *fixed=1; <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,URAD0)=prguess[URAD0];} <span class="comment">// otherwise assume really so bad that failure</span></div>
<div class="line"><a name="l02640"></a><span class="lineno"> 2640</span>&#160;            }</div>
<div class="line"><a name="l02641"></a><span class="lineno"> 2641</span>&#160;            <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l02642"></a><span class="lineno"> 2642</span>&#160;              <span class="comment">// just treat as floor for all failures since do not know what updated quantity is</span></div>
<div class="line"><a name="l02643"></a><span class="lineno"> 2643</span>&#160;              <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>)=prguess[URAD0];</div>
<div class="line"><a name="l02644"></a><span class="lineno"> 2644</span>&#160;              *fixed=1;</div>
<div class="line"><a name="l02645"></a><span class="lineno"> 2645</span>&#160;            }</div>
<div class="line"><a name="l02646"></a><span class="lineno"> 2646</span>&#160;          }<span class="comment">// end if handling u&lt;zerouuperbaryon*prim[RHO] in special way</span></div>
<div class="line"><a name="l02647"></a><span class="lineno"> 2647</span>&#160;        }<span class="comment">// end if not allowing negative u or if allowing but not yet final step</span></div>
<div class="line"><a name="l02648"></a><span class="lineno"> 2648</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>((<a class="code" href="../../da/d3e/definit_8h.html#a01d34fa922c4eaac94e27f2179523626" title="whether to allow negative internal energy in substep UTOPRIMFAILRETURNTYPE==UTOPRIMRETURNADJUSTED sho...">STEPOVERNEGU</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#af662b2a90aec340ab38528c25b7b5aa6">NEGDENSITY_FIXONFULLSTEP</a>)&amp;&amp;(!finalstep)){</div>
<div class="line"><a name="l02649"></a><span class="lineno"> 2649</span>&#160;          <span class="keywordflow">if</span>(<a class="code" href="../../de/d95/fixup_8c.html#aa9d04e5483d7cc6a8e71924763748705">HANDLEUNEG</a>==1) *fixed=1; <span class="comment">// tells rest of routine to leave alone and say ok solution, but don&#39;t use it to fix convergence failures for other zones</span></div>
<div class="line"><a name="l02650"></a><span class="lineno"> 2650</span>&#160;        }</div>
<div class="line"><a name="l02651"></a><span class="lineno"> 2651</span>&#160;      }<span class="comment">// end if u&lt;zerouuperbaryon*prim[RHO]</span></div>
<div class="line"><a name="l02652"></a><span class="lineno"> 2652</span>&#160;    }<span class="comment">// end if not fixed</span></div>
<div class="line"><a name="l02653"></a><span class="lineno"> 2653</span>&#160;</div>
<div class="line"><a name="l02654"></a><span class="lineno"> 2654</span>&#160;</div>
<div class="line"><a name="l02655"></a><span class="lineno"> 2655</span>&#160;  }</div>
<div class="line"><a name="l02656"></a><span class="lineno"> 2656</span>&#160;  </div>
<div class="line"><a name="l02657"></a><span class="lineno"> 2657</span>&#160;</div>
<div class="line"><a name="l02658"></a><span class="lineno"> 2658</span>&#160; </div>
<div class="line"><a name="l02659"></a><span class="lineno"> 2659</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l02660"></a><span class="lineno"> 2660</span>&#160;}</div>
<div class="line"><a name="l02661"></a><span class="lineno"> 2661</span>&#160;</div>
<div class="line"><a name="l02662"></a><span class="lineno"> 2662</span>&#160;</div>
<div class="line"><a name="l02663"></a><span class="lineno"> 2663</span>&#160;</div>
<div class="line"><a name="l02664"></a><span class="lineno"> 2664</span>&#160;</div>
<div class="line"><a name="l02665"></a><span class="lineno"> 2665</span>&#160;<span class="comment">// DOCOUNTNEG???? only applies for STEPOVERNEG???==NEGDENSITY_NEVERFIXUP</span></div>
<div class="line"><a name="l02666"></a><span class="lineno"> 2666</span>&#160;</div>
<div class="line"><a name="l02667"></a><span class="lineno"> 2667</span>&#160;<span class="comment">// whether to count any substep u&lt;zerouuperbaryon*prim[RHO] as failure in debug data</span></div>
<div class="line"><a name="l02668"></a><span class="lineno"> 2668</span>&#160;<span class="comment">// 2: always counted</span></div>
<div class="line"><a name="l02669"></a><span class="lineno"> 2669</span>&#160;<span class="comment">// 1: only counted on final substep</span></div>
<div class="line"><a name="l02670"></a><span class="lineno"> 2670</span>&#160;<span class="comment">// 0: never counted</span></div>
<div class="line"><a name="l02671"></a><span class="lineno"><a class="code" href="../../de/d95/fixup_8c.html#ad7a9da5efbe45da60bd92f67daac3c9c"> 2671</a></span>&#160;<span class="preprocessor">#define DOCOUNTNEGU 1</span></div>
<div class="line"><a name="l02672"></a><span class="lineno"> 2672</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l02673"></a><span class="lineno"> 2673</span>&#160;<span class="comment">// whether to count any substep rho&lt;0 as failure in debug data</span></div>
<div class="line"><a name="l02674"></a><span class="lineno"><a class="code" href="../../de/d95/fixup_8c.html#afb5003642981a4141d2a82ce20f9b089"> 2674</a></span>&#160;<span class="preprocessor">#define DOCOUNTNEGRHO 1</span></div>
<div class="line"><a name="l02675"></a><span class="lineno"> 2675</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l02676"></a><span class="lineno"> 2676</span>&#160;<span class="comment">// whether to count any substep rho&lt;0 &amp;&amp; u&lt;zerouuperbaryon*prim[RHO] case as failure in debug data</span></div>
<div class="line"><a name="l02677"></a><span class="lineno"><a class="code" href="../../de/d95/fixup_8c.html#a647519dfd99fcca0f65ca5a61d79e476"> 2677</a></span>&#160;<span class="preprocessor">#define DOCOUNTNEGRHOU 1</span></div>
<div class="line"><a name="l02678"></a><span class="lineno"> 2678</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l02679"></a><span class="lineno"> 2679</span>&#160;</div>
<div class="line"><a name="l02680"></a><span class="lineno"> 2680</span>&#160;<span class="comment">// whether to make conserved quantity consistent with the associated fixed primitive quantity.</span></div>
<div class="line"><a name="l02681"></a><span class="lineno"> 2681</span>&#160;<span class="comment">// required at least at the finalstep.</span></div>
<div class="line"><a name="l02682"></a><span class="lineno"> 2682</span>&#160;<span class="comment">// 0: don&#39;t do it</span></div>
<div class="line"><a name="l02683"></a><span class="lineno"> 2683</span>&#160;<span class="comment">// 1: adjust only if finalstep==1</span></div>
<div class="line"><a name="l02684"></a><span class="lineno"> 2684</span>&#160;<span class="comment">// 2: adjust for all substeps</span></div>
<div class="line"><a name="l02685"></a><span class="lineno"><a class="code" href="../../de/d95/fixup_8c.html#a15e7961b48e1b05d7500628768512aed"> 2685</a></span>&#160;<span class="preprocessor">#define ADJUSTCONSERVEDQUANTITY 0</span></div>
<div class="line"><a name="l02686"></a><span class="lineno"> 2686</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l02688"></a><span class="lineno"> 2688</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> fixuputoprim_accounting(<span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> mhdlpflag, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> radlpflag, <span class="keywordtype">int</span> limitgammamhd, <span class="keywordtype">int</span> limitgammarad, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> (*lpflag)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NUMPFLAGS],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pv)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*ptoavg)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR], <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr0, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*uconsinput)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR], <span class="keywordtype">int</span> finalstep)</div>
<div class="line"><a name="l02689"></a><span class="lineno"> 2689</span>&#160;{</div>
<div class="line"><a name="l02690"></a><span class="lineno"> 2690</span>&#160;  <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> mhdutoprimfailtype,radutoprimfailtype;</div>
<div class="line"><a name="l02691"></a><span class="lineno"> 2691</span>&#160;  <span class="keywordtype">int</span> doadjustcons;</div>
<div class="line"><a name="l02692"></a><span class="lineno"> 2692</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> q;</div>
<div class="line"><a name="l02693"></a><span class="lineno"> 2693</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*utoinvert)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR];</div>
<div class="line"><a name="l02694"></a><span class="lineno"> 2694</span>&#160;  <span class="keywordtype">int</span> docorrectucons;</div>
<div class="line"><a name="l02695"></a><span class="lineno"> 2695</span>&#160;  <span class="keywordtype">int</span> pliter,pl;</div>
<div class="line"><a name="l02696"></a><span class="lineno"> 2696</span>&#160;</div>
<div class="line"><a name="l02697"></a><span class="lineno"> 2697</span>&#160;</div>
<div class="line"><a name="l02698"></a><span class="lineno"> 2698</span>&#160;</div>
<div class="line"><a name="l02699"></a><span class="lineno"> 2699</span>&#160;  <span class="comment">// store ucons and only change if needed (and handle avoidance of B1,B2,B3 in case ucons points to unewglobal staggered field, while here we operate on centers)</span></div>
<div class="line"><a name="l02700"></a><span class="lineno"> 2700</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ucons[NPR];</div>
<div class="line"><a name="l02701"></a><span class="lineno"> 2701</span>&#160;  <span class="keywordflow">if</span>(uconsinput!=NULL){</div>
<div class="line"><a name="l02702"></a><span class="lineno"> 2702</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) ucons[pl]=<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(uconsinput,i,j,k,pl);</div>
<div class="line"><a name="l02703"></a><span class="lineno"> 2703</span>&#160;  }</div>
<div class="line"><a name="l02704"></a><span class="lineno"> 2704</span>&#160;</div>
<div class="line"><a name="l02706"></a><span class="lineno"> 2706</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02707"></a><span class="lineno"> 2707</span>&#160;  <span class="comment">// MHD</span></div>
<div class="line"><a name="l02708"></a><span class="lineno"> 2708</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02710"></a><span class="lineno"> 2710</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02711"></a><span class="lineno"> 2711</span>&#160;  <span class="comment">// account for changes by tracking conserved quantities</span></div>
<div class="line"><a name="l02712"></a><span class="lineno"> 2712</span>&#160;  <span class="comment">// note that if new utoprim solution was impossible, we are using here prior solution as new state, which means the diagnostics won&#39;t be acccurate.  There&#39;s no way to fix this unless the fluxes always give a well-defined new primitive variable.</span></div>
<div class="line"><a name="l02713"></a><span class="lineno"> 2713</span>&#160;  <span class="comment">// specific value of the mhdlpflag&gt;0 communicates the type of failure</span></div>
<div class="line"><a name="l02714"></a><span class="lineno"> 2714</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae162617b4cfeeb980353283edc2db221">IFUTOPRIMNOFAIL</a>(mhdlpflag)){</div>
<div class="line"><a name="l02715"></a><span class="lineno"> 2715</span>&#160;    mhdutoprimfailtype=-1;</div>
<div class="line"><a name="l02716"></a><span class="lineno"> 2716</span>&#160;    docorrectucons=0;</div>
<div class="line"><a name="l02717"></a><span class="lineno"> 2717</span>&#160;  }</div>
<div class="line"><a name="l02718"></a><span class="lineno"> 2718</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(</div>
<div class="line"><a name="l02719"></a><span class="lineno"> 2719</span>&#160;          (mhdlpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2de5944abdafe2f29ef970d24869a883">UTOPRIMFAILCONV</a>)|| <span class="comment">// only used by 5D method currently</span></div>
<div class="line"><a name="l02720"></a><span class="lineno"> 2720</span>&#160;          (mhdlpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae592fb13c08de6ebcb503295f27d7f25">UTOPRIMFAILCONVGUESSUTSQ</a>)|| <span class="comment">// rest are only used by 1D/2D method currently</span></div>
<div class="line"><a name="l02721"></a><span class="lineno"> 2721</span>&#160;          (mhdlpflag&gt;=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a9e8b2b95acecbfffd1cd90d36c295f9b">UTOPRIMFAILCONVRET</a>)||</div>
<div class="line"><a name="l02722"></a><span class="lineno"> 2722</span>&#160;          (mhdlpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aee238136c1e827204c5b589fd49483d8">UTOPRIMFAILCONVW</a>)||</div>
<div class="line"><a name="l02723"></a><span class="lineno"> 2723</span>&#160;          (mhdlpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab947eb88dee7f7a97006ffb0c5e76cb6">UTOPRIMFAILCONVUTSQVERYBAD</a>)||</div>
<div class="line"><a name="l02724"></a><span class="lineno"> 2724</span>&#160;          (mhdlpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8038577145888857d1fbcec2ab5d5d70">UTOPRIMFAILNANGUESS</a>)||</div>
<div class="line"><a name="l02725"></a><span class="lineno"> 2725</span>&#160;          (mhdlpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a60b4996e25f5f432174dfaaf02872642">UTOPRIMFAILNANRESULT</a>)||</div>
<div class="line"><a name="l02726"></a><span class="lineno"> 2726</span>&#160;          (mhdlpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a179f5cb85b123b8923f126fbf59b5481">UTOPRIMFAILCONVBADINVERTCOMPARE</a>)||</div>
<div class="line"><a name="l02727"></a><span class="lineno"> 2727</span>&#160;          (mhdlpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#af5aa8bcea9cce083c4b132a466974ad6">UTOPRIMFAILCONVUTSQ</a>)||</div>
<div class="line"><a name="l02728"></a><span class="lineno"> 2728</span>&#160;          (mhdlpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a1cfd743fe705971858ab82d45846e1c0">UTOPRIMFAILFAKEVALUE</a>) <span class="comment">// fake value for avoiding MPI boundary call and so MPI boundary values for fixup</span></div>
<div class="line"><a name="l02729"></a><span class="lineno"> 2729</span>&#160;          ){</div>
<div class="line"><a name="l02730"></a><span class="lineno"> 2730</span>&#160;    mhdutoprimfailtype=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a9927f9e410e033c10e773383ed48b09a" title="mnemonics">COUNTUTOPRIMFAILCONV</a>;</div>
<div class="line"><a name="l02731"></a><span class="lineno"> 2731</span>&#160;    docorrectucons=1;</div>
<div class="line"><a name="l02732"></a><span class="lineno"> 2732</span>&#160;  }</div>
<div class="line"><a name="l02733"></a><span class="lineno"> 2733</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(mhdlpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ad5bd994b947d2a46102582b38e4b1529">UTOPRIMFAILRHONEG</a>){</div>
<div class="line"><a name="l02734"></a><span class="lineno"> 2734</span>&#160;    <span class="comment">// whether to count uneg as failure in diagnostic reporting or not</span></div>
<div class="line"><a name="l02735"></a><span class="lineno"> 2735</span>&#160;    <span class="comment">// should really have a new diagnostic for substep u&lt;zerouuperbaryon*prim[RHO] &#39;s.</span></div>
<div class="line"><a name="l02736"></a><span class="lineno"> 2736</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#a23eeede57657104811b4f7e5e7dda656" title="seems to make things worse (more failures, but also worse failures)">STEPOVERNEGRHO</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae8f476756e2b5ced42c76e0536c77369" title="STEPOVERNEGXXX: possible modes of stepping over occurences of negative densities: controls when to re...">NEGDENSITY_NEVERFIXUP</a>){</div>
<div class="line"><a name="l02737"></a><span class="lineno"> 2737</span>&#160;      <span class="keywordflow">if</span>(<a class="code" href="../../de/d95/fixup_8c.html#afb5003642981a4141d2a82ce20f9b089">DOCOUNTNEGRHO</a>==1){</div>
<div class="line"><a name="l02738"></a><span class="lineno"> 2738</span>&#160;        <span class="keywordflow">if</span>(finalstep){</div>
<div class="line"><a name="l02739"></a><span class="lineno"> 2739</span>&#160;          mhdutoprimfailtype=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aa904af262beb70f05b9cf57f98862269">COUNTUTOPRIMFAILRHONEG</a>;</div>
<div class="line"><a name="l02740"></a><span class="lineno"> 2740</span>&#160;          docorrectucons=1;</div>
<div class="line"><a name="l02741"></a><span class="lineno"> 2741</span>&#160;        }</div>
<div class="line"><a name="l02742"></a><span class="lineno"> 2742</span>&#160;        <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l02743"></a><span class="lineno"> 2743</span>&#160;          mhdutoprimfailtype=-1;</div>
<div class="line"><a name="l02744"></a><span class="lineno"> 2744</span>&#160;          docorrectucons=0;</div>
<div class="line"><a name="l02745"></a><span class="lineno"> 2745</span>&#160;        }</div>
<div class="line"><a name="l02746"></a><span class="lineno"> 2746</span>&#160;      }</div>
<div class="line"><a name="l02747"></a><span class="lineno"> 2747</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../de/d95/fixup_8c.html#afb5003642981a4141d2a82ce20f9b089">DOCOUNTNEGRHO</a>==2){</div>
<div class="line"><a name="l02748"></a><span class="lineno"> 2748</span>&#160;        mhdutoprimfailtype=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aa904af262beb70f05b9cf57f98862269">COUNTUTOPRIMFAILRHONEG</a>;</div>
<div class="line"><a name="l02749"></a><span class="lineno"> 2749</span>&#160;        docorrectucons=1;</div>
<div class="line"><a name="l02750"></a><span class="lineno"> 2750</span>&#160;      }</div>
<div class="line"><a name="l02751"></a><span class="lineno"> 2751</span>&#160;      <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l02752"></a><span class="lineno"> 2752</span>&#160;        mhdutoprimfailtype=-1;</div>
<div class="line"><a name="l02753"></a><span class="lineno"> 2753</span>&#160;        docorrectucons=0;</div>
<div class="line"><a name="l02754"></a><span class="lineno"> 2754</span>&#160;      }</div>
<div class="line"><a name="l02755"></a><span class="lineno"> 2755</span>&#160;    } </div>
<div class="line"><a name="l02756"></a><span class="lineno"> 2756</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>((<a class="code" href="../../da/d3e/definit_8h.html#a23eeede57657104811b4f7e5e7dda656" title="seems to make things worse (more failures, but also worse failures)">STEPOVERNEGRHO</a>)&amp;&amp;(!finalstep)){</div>
<div class="line"><a name="l02757"></a><span class="lineno"> 2757</span>&#160;      mhdutoprimfailtype=-1;</div>
<div class="line"><a name="l02758"></a><span class="lineno"> 2758</span>&#160;      docorrectucons=0;</div>
<div class="line"><a name="l02759"></a><span class="lineno"> 2759</span>&#160;    }</div>
<div class="line"><a name="l02760"></a><span class="lineno"> 2760</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l02761"></a><span class="lineno"> 2761</span>&#160;      mhdutoprimfailtype=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aa904af262beb70f05b9cf57f98862269">COUNTUTOPRIMFAILRHONEG</a>;</div>
<div class="line"><a name="l02762"></a><span class="lineno"> 2762</span>&#160;      docorrectucons=1;</div>
<div class="line"><a name="l02763"></a><span class="lineno"> 2763</span>&#160;    }</div>
<div class="line"><a name="l02764"></a><span class="lineno"> 2764</span>&#160;  }</div>
<div class="line"><a name="l02765"></a><span class="lineno"> 2765</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(mhdlpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a17c167aa50c0750a25baba351db69740">UTOPRIMFAILUNEG</a> || mhdlpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ac3b05e85d00237f2aaa8ec4ec6ff82a3">UTOPRIMFAILU2AVG1</a>|| mhdlpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a042dcc3162731841db25689b5f94c2ac">UTOPRIMFAILU2AVG2</a> || mhdlpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afc8db2dfa526f28224a0903680453240">UTOPRIMFAILU2AVG1FROMCOLD</a>|| mhdlpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ace792b5d6cf33871003798c658ba55b2">UTOPRIMFAILU2AVG2FROMCOLD</a> || mhdlpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a4fb558d7d5fa8343d7ca417d8b0bb418">UTOPRIMFAILURHO2AVG1FROMFFDE</a>){ <span class="comment">// GODMARK: maybe want separate accounting</span></div>
<div class="line"><a name="l02766"></a><span class="lineno"> 2766</span>&#160;    <span class="comment">// whether to count uneg as failure in diagnostic reporting or not</span></div>
<div class="line"><a name="l02767"></a><span class="lineno"> 2767</span>&#160;    <span class="comment">// should really have a new diagnostic for substep u&lt;zerouuperbaryon*prim[RHO] &#39;s.</span></div>
<div class="line"><a name="l02768"></a><span class="lineno"> 2768</span>&#160;</div>
<div class="line"><a name="l02769"></a><span class="lineno"> 2769</span>&#160;    <span class="comment">// default counting:</span></div>
<div class="line"><a name="l02770"></a><span class="lineno"> 2770</span>&#160;    <span class="keywordflow">if</span>(mhdlpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afc8db2dfa526f28224a0903680453240">UTOPRIMFAILU2AVG1FROMCOLD</a>|| mhdlpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ace792b5d6cf33871003798c658ba55b2">UTOPRIMFAILU2AVG2FROMCOLD</a>) mhdutoprimfailtype=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8abe1988c6f1a6b93a649dad925ec1f0">COUNTCOLD</a>;</div>
<div class="line"><a name="l02771"></a><span class="lineno"> 2771</span>&#160;    <span class="keywordflow">else</span> mhdutoprimfailtype=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0644ef77f90dc261207bf02f44727050">COUNTUTOPRIMFAILUNEG</a>;</div>
<div class="line"><a name="l02772"></a><span class="lineno"> 2772</span>&#160;</div>
<div class="line"><a name="l02773"></a><span class="lineno"> 2773</span>&#160;    <span class="comment">// default counting:</span></div>
<div class="line"><a name="l02774"></a><span class="lineno"> 2774</span>&#160;    <span class="keywordflow">if</span>(mhdlpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a4fb558d7d5fa8343d7ca417d8b0bb418">UTOPRIMFAILURHO2AVG1FROMFFDE</a>) mhdutoprimfailtype=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0dda43c4bdbf60d595e12f9f1ca81fc9">COUNTFFDE</a>;</div>
<div class="line"><a name="l02775"></a><span class="lineno"> 2775</span>&#160;    <span class="keywordflow">else</span> mhdutoprimfailtype=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0644ef77f90dc261207bf02f44727050">COUNTUTOPRIMFAILUNEG</a>;</div>
<div class="line"><a name="l02776"></a><span class="lineno"> 2776</span>&#160;</div>
<div class="line"><a name="l02777"></a><span class="lineno"> 2777</span>&#160;    <span class="comment">// now set whether to ucons correction or override counting</span></div>
<div class="line"><a name="l02778"></a><span class="lineno"> 2778</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#a01d34fa922c4eaac94e27f2179523626" title="whether to allow negative internal energy in substep UTOPRIMFAILRETURNTYPE==UTOPRIMRETURNADJUSTED sho...">STEPOVERNEGU</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae8f476756e2b5ced42c76e0536c77369" title="STEPOVERNEGXXX: possible modes of stepping over occurences of negative densities: controls when to re...">NEGDENSITY_NEVERFIXUP</a>){</div>
<div class="line"><a name="l02779"></a><span class="lineno"> 2779</span>&#160;      <span class="keywordflow">if</span>(<a class="code" href="../../de/d95/fixup_8c.html#ad7a9da5efbe45da60bd92f67daac3c9c">DOCOUNTNEGU</a>==1){</div>
<div class="line"><a name="l02780"></a><span class="lineno"> 2780</span>&#160;        <span class="keywordflow">if</span>(finalstep){</div>
<div class="line"><a name="l02781"></a><span class="lineno"> 2781</span>&#160;          docorrectucons=1;</div>
<div class="line"><a name="l02782"></a><span class="lineno"> 2782</span>&#160;        }</div>
<div class="line"><a name="l02783"></a><span class="lineno"> 2783</span>&#160;        <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l02784"></a><span class="lineno"> 2784</span>&#160;          mhdutoprimfailtype=-1;</div>
<div class="line"><a name="l02785"></a><span class="lineno"> 2785</span>&#160;          docorrectucons=0;</div>
<div class="line"><a name="l02786"></a><span class="lineno"> 2786</span>&#160;        }</div>
<div class="line"><a name="l02787"></a><span class="lineno"> 2787</span>&#160;      }</div>
<div class="line"><a name="l02788"></a><span class="lineno"> 2788</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../de/d95/fixup_8c.html#ad7a9da5efbe45da60bd92f67daac3c9c">DOCOUNTNEGU</a>==2){</div>
<div class="line"><a name="l02789"></a><span class="lineno"> 2789</span>&#160;        docorrectucons=1;</div>
<div class="line"><a name="l02790"></a><span class="lineno"> 2790</span>&#160;      }</div>
<div class="line"><a name="l02791"></a><span class="lineno"> 2791</span>&#160;      <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l02792"></a><span class="lineno"> 2792</span>&#160;        mhdutoprimfailtype=-1;</div>
<div class="line"><a name="l02793"></a><span class="lineno"> 2793</span>&#160;        docorrectucons=0;</div>
<div class="line"><a name="l02794"></a><span class="lineno"> 2794</span>&#160;      }</div>
<div class="line"><a name="l02795"></a><span class="lineno"> 2795</span>&#160;    } </div>
<div class="line"><a name="l02796"></a><span class="lineno"> 2796</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>((<a class="code" href="../../da/d3e/definit_8h.html#a01d34fa922c4eaac94e27f2179523626" title="whether to allow negative internal energy in substep UTOPRIMFAILRETURNTYPE==UTOPRIMRETURNADJUSTED sho...">STEPOVERNEGU</a>)&amp;&amp;(!finalstep)){</div>
<div class="line"><a name="l02797"></a><span class="lineno"> 2797</span>&#160;      mhdutoprimfailtype=-1;</div>
<div class="line"><a name="l02798"></a><span class="lineno"> 2798</span>&#160;      docorrectucons=0;</div>
<div class="line"><a name="l02799"></a><span class="lineno"> 2799</span>&#160;    }</div>
<div class="line"><a name="l02800"></a><span class="lineno"> 2800</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l02801"></a><span class="lineno"> 2801</span>&#160;      docorrectucons=1;</div>
<div class="line"><a name="l02802"></a><span class="lineno"> 2802</span>&#160;    }</div>
<div class="line"><a name="l02803"></a><span class="lineno"> 2803</span>&#160;  }</div>
<div class="line"><a name="l02804"></a><span class="lineno"> 2804</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(mhdlpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a24290f84c3e2b725f7cbbdff81da4760">UTOPRIMFAILRHOUNEG</a>){</div>
<div class="line"><a name="l02805"></a><span class="lineno"> 2805</span>&#160;    <span class="comment">// whether to count uneg as failure in diagnostic reporting or not</span></div>
<div class="line"><a name="l02806"></a><span class="lineno"> 2806</span>&#160;    <span class="comment">// should really have a new diagnostic for substep u&lt;zerouuperbaryon*prim[RHO] &#39;s.</span></div>
<div class="line"><a name="l02807"></a><span class="lineno"> 2807</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../d8/dc0/init_8h.html#a352ef6d348d5c3986dc77165755b8733">STEPOVERNEGRHOU</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae8f476756e2b5ced42c76e0536c77369" title="STEPOVERNEGXXX: possible modes of stepping over occurences of negative densities: controls when to re...">NEGDENSITY_NEVERFIXUP</a>){</div>
<div class="line"><a name="l02808"></a><span class="lineno"> 2808</span>&#160;      <span class="keywordflow">if</span>(<a class="code" href="../../de/d95/fixup_8c.html#a647519dfd99fcca0f65ca5a61d79e476">DOCOUNTNEGRHOU</a>==1){</div>
<div class="line"><a name="l02809"></a><span class="lineno"> 2809</span>&#160;        <span class="keywordflow">if</span>(finalstep){</div>
<div class="line"><a name="l02810"></a><span class="lineno"> 2810</span>&#160;          mhdutoprimfailtype=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ad13eb3464c138d9f179e20d5f4973205">COUNTUTOPRIMFAILRHOUNEG</a>;</div>
<div class="line"><a name="l02811"></a><span class="lineno"> 2811</span>&#160;          docorrectucons=1;</div>
<div class="line"><a name="l02812"></a><span class="lineno"> 2812</span>&#160;        }</div>
<div class="line"><a name="l02813"></a><span class="lineno"> 2813</span>&#160;        <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l02814"></a><span class="lineno"> 2814</span>&#160;          mhdutoprimfailtype=-1;</div>
<div class="line"><a name="l02815"></a><span class="lineno"> 2815</span>&#160;          docorrectucons=0;</div>
<div class="line"><a name="l02816"></a><span class="lineno"> 2816</span>&#160;        }</div>
<div class="line"><a name="l02817"></a><span class="lineno"> 2817</span>&#160;      }</div>
<div class="line"><a name="l02818"></a><span class="lineno"> 2818</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../de/d95/fixup_8c.html#a647519dfd99fcca0f65ca5a61d79e476">DOCOUNTNEGRHOU</a>==2){</div>
<div class="line"><a name="l02819"></a><span class="lineno"> 2819</span>&#160;        mhdutoprimfailtype=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ad13eb3464c138d9f179e20d5f4973205">COUNTUTOPRIMFAILRHOUNEG</a>;</div>
<div class="line"><a name="l02820"></a><span class="lineno"> 2820</span>&#160;        docorrectucons=1;</div>
<div class="line"><a name="l02821"></a><span class="lineno"> 2821</span>&#160;      }</div>
<div class="line"><a name="l02822"></a><span class="lineno"> 2822</span>&#160;      <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l02823"></a><span class="lineno"> 2823</span>&#160;        mhdutoprimfailtype=-1;</div>
<div class="line"><a name="l02824"></a><span class="lineno"> 2824</span>&#160;        docorrectucons=0;</div>
<div class="line"><a name="l02825"></a><span class="lineno"> 2825</span>&#160;      }</div>
<div class="line"><a name="l02826"></a><span class="lineno"> 2826</span>&#160;    } </div>
<div class="line"><a name="l02827"></a><span class="lineno"> 2827</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>((<a class="code" href="../../d8/dc0/init_8h.html#a352ef6d348d5c3986dc77165755b8733">STEPOVERNEGRHOU</a>)&amp;&amp;(!finalstep)){</div>
<div class="line"><a name="l02828"></a><span class="lineno"> 2828</span>&#160;      mhdutoprimfailtype=-1;</div>
<div class="line"><a name="l02829"></a><span class="lineno"> 2829</span>&#160;      docorrectucons=0;</div>
<div class="line"><a name="l02830"></a><span class="lineno"> 2830</span>&#160;    }</div>
<div class="line"><a name="l02831"></a><span class="lineno"> 2831</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l02832"></a><span class="lineno"> 2832</span>&#160;      mhdutoprimfailtype=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ad13eb3464c138d9f179e20d5f4973205">COUNTUTOPRIMFAILRHOUNEG</a>;</div>
<div class="line"><a name="l02833"></a><span class="lineno"> 2833</span>&#160;      docorrectucons=1;</div>
<div class="line"><a name="l02834"></a><span class="lineno"> 2834</span>&#160;    }</div>
<div class="line"><a name="l02835"></a><span class="lineno"> 2835</span>&#160;  }</div>
<div class="line"><a name="l02836"></a><span class="lineno"> 2836</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(mhdlpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ad6ba8deb8dab694606b9f4a79845aada">UTOPRIMFAILGAMMAPERC</a>){</div>
<div class="line"><a name="l02837"></a><span class="lineno"> 2837</span>&#160;    mhdutoprimfailtype=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6b3ac86b1b82e9b68329b10dfd5d3a5e">COUNTGAMMAPERC</a>;</div>
<div class="line"><a name="l02838"></a><span class="lineno"> 2838</span>&#160;    docorrectucons=1;</div>
<div class="line"><a name="l02839"></a><span class="lineno"> 2839</span>&#160;  }</div>
<div class="line"><a name="l02840"></a><span class="lineno"> 2840</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(mhdlpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a58149f1f58f5a6b52e613a93c22efe30">UTOPRIMFAILUPERC</a>){</div>
<div class="line"><a name="l02841"></a><span class="lineno"> 2841</span>&#160;    mhdutoprimfailtype=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aa400570d20b4125ac9deefb7d0451fca">COUNTUPERC</a>;</div>
<div class="line"><a name="l02842"></a><span class="lineno"> 2842</span>&#160;    docorrectucons=1;</div>
<div class="line"><a name="l02843"></a><span class="lineno"> 2843</span>&#160;  }</div>
<div class="line"><a name="l02844"></a><span class="lineno"> 2844</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(mhdlpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8ec47c7a495701cda2ff6a8e03eb8e8f">UTOPRIMFAILFIXEDENTROPY</a>){</div>
<div class="line"><a name="l02845"></a><span class="lineno"> 2845</span>&#160;    mhdutoprimfailtype=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aa0d32121a7b591280e425c8741457d16">COUNTENTROPY</a>;</div>
<div class="line"><a name="l02846"></a><span class="lineno"> 2846</span>&#160;    docorrectucons=0; <span class="comment">// account, but don&#39;t change conserved quantities</span></div>
<div class="line"><a name="l02847"></a><span class="lineno"> 2847</span>&#160;  }</div>
<div class="line"><a name="l02848"></a><span class="lineno"> 2848</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(mhdlpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab9759d44dd5fcddae024c6464ab6e769">UTOPRIMFAILFIXEDCOLD</a>){</div>
<div class="line"><a name="l02849"></a><span class="lineno"> 2849</span>&#160;    mhdutoprimfailtype=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8abe1988c6f1a6b93a649dad925ec1f0">COUNTCOLD</a>;</div>
<div class="line"><a name="l02850"></a><span class="lineno"> 2850</span>&#160;    docorrectucons=0; <span class="comment">// account, but don&#39;t change conserved quantities</span></div>
<div class="line"><a name="l02851"></a><span class="lineno"> 2851</span>&#160;  }</div>
<div class="line"><a name="l02852"></a><span class="lineno"> 2852</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(mhdlpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ad824248f759af3345f68a410c53e7853">UTOPRIMFAILFIXEDBOUND1</a>){</div>
<div class="line"><a name="l02853"></a><span class="lineno"> 2853</span>&#160;    mhdutoprimfailtype=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#af8b31f18274e9f9383fc7ce832f81ed4">COUNTBOUND1</a>;</div>
<div class="line"><a name="l02854"></a><span class="lineno"> 2854</span>&#160;    docorrectucons=0; <span class="comment">// account, but don&#39;t change conserved quantities</span></div>
<div class="line"><a name="l02855"></a><span class="lineno"> 2855</span>&#160;  }</div>
<div class="line"><a name="l02856"></a><span class="lineno"> 2856</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(mhdlpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a89fcc7a90829c2a8b50c5c458cf3391b">UTOPRIMFAILFIXEDBOUND2</a>){</div>
<div class="line"><a name="l02857"></a><span class="lineno"> 2857</span>&#160;    mhdutoprimfailtype=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a59b07a3f239854b5afc545ae495a2020">COUNTBOUND2</a>;</div>
<div class="line"><a name="l02858"></a><span class="lineno"> 2858</span>&#160;    docorrectucons=0; <span class="comment">// account, but don&#39;t change conserved quantities</span></div>
<div class="line"><a name="l02859"></a><span class="lineno"> 2859</span>&#160;  }</div>
<div class="line"><a name="l02860"></a><span class="lineno"> 2860</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(mhdlpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a31984a48acce79cf07b32f0688481a66">UTOPRIMFAILFIXEDUTOPRIM</a>){</div>
<div class="line"><a name="l02861"></a><span class="lineno"> 2861</span>&#160;    dualfprintf(fail_file,<span class="stringliteral">&quot;prior pflag not cleared: nstep=%ld steppart=%d t=%21.15g i=%d j=%d k=%d \n&quot;</span>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a1a1088d87617078680f1fd0f0d707384">nstep</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a70170b90229f9fc05eebf8508a685c70">steppart</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#ae1ee1e1c83c3f70e2e1afed4f4f5b41e">t</a>,i,j,k);</div>
<div class="line"><a name="l02862"></a><span class="lineno"> 2862</span>&#160;    mhdutoprimfailtype=-1;</div>
<div class="line"><a name="l02863"></a><span class="lineno"> 2863</span>&#160;    docorrectucons=0;</div>
<div class="line"><a name="l02864"></a><span class="lineno"> 2864</span>&#160;  }</div>
<div class="line"><a name="l02865"></a><span class="lineno"> 2865</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l02866"></a><span class="lineno"> 2866</span>&#160;    dualfprintf(fail_file,<span class="stringliteral">&quot;No such pflag failure type: %d for t=%21.15g nstep=%ld steppart=%d i=%d j=%d k=%d\n&quot;</span>,mhdlpflag,<a class="code" href="../../d8/d5b/defs_8general_8h.html#ae1ee1e1c83c3f70e2e1afed4f4f5b41e">t</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a1a1088d87617078680f1fd0f0d707384">nstep</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a70170b90229f9fc05eebf8508a685c70">steppart</a>,i,j,k);</div>
<div class="line"><a name="l02867"></a><span class="lineno"> 2867</span>&#160;    myexit(1);</div>
<div class="line"><a name="l02868"></a><span class="lineno"> 2868</span>&#160;  }</div>
<div class="line"><a name="l02869"></a><span class="lineno"> 2869</span>&#160;</div>
<div class="line"><a name="l02870"></a><span class="lineno"> 2870</span>&#160;</div>
<div class="line"><a name="l02872"></a><span class="lineno"> 2872</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02873"></a><span class="lineno"> 2873</span>&#160;  <span class="comment">// RADIATION</span></div>
<div class="line"><a name="l02874"></a><span class="lineno"> 2874</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02876"></a><span class="lineno"> 2876</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02877"></a><span class="lineno"> 2877</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae162617b4cfeeb980353283edc2db221">IFUTOPRIMNOFAIL</a>(radlpflag)){</div>
<div class="line"><a name="l02878"></a><span class="lineno"> 2878</span>&#160;    radutoprimfailtype=-1;</div>
<div class="line"><a name="l02879"></a><span class="lineno"> 2879</span>&#160;    docorrectucons=0;</div>
<div class="line"><a name="l02880"></a><span class="lineno"> 2880</span>&#160;  }</div>
<div class="line"><a name="l02881"></a><span class="lineno"> 2881</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(radlpflag&gt;=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aba9c5f566b4227c5e5d8faef0f62e4e6" title="locally fixed inversion problems (as possible sometimes with radiation): see phys.tools.rad.c:u2p_rad()">UTOPRIMRADFAILCASE1A</a> || radlpflag&lt;=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0ef4f7b1581d3a52ce8d9f09a1febd6b">UTOPRIMRADFAILCASE3B</a> || radlpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a38b0585ec02d900ad0413645acb00918">UTOPRIMRADFAILERFNEG</a>){</div>
<div class="line"><a name="l02882"></a><span class="lineno"> 2882</span>&#160;    radutoprimfailtype=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a48326de35686b1e3cb8cd18118bda9b0">COUNTRADLOCAL</a>;</div>
<div class="line"><a name="l02883"></a><span class="lineno"> 2883</span>&#160;    docorrectucons=1;</div>
<div class="line"><a name="l02884"></a><span class="lineno"> 2884</span>&#160;  }</div>
<div class="line"><a name="l02885"></a><span class="lineno"> 2885</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(radlpflag&gt;=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ad987489760e6592057a80faf09588c88" title="unfixable inversion problems">UTOPRIMRADFAILBAD1</a> || radlpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a36f23f21f8e90ce3e39940621c912714">UTOPRIMRADFAILGAMMAHIGH</a> || radlpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a38b0585ec02d900ad0413645acb00918">UTOPRIMRADFAILERFNEG</a>){</div>
<div class="line"><a name="l02886"></a><span class="lineno"> 2886</span>&#160;    radutoprimfailtype=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0cc34f918e89b016a61ef0acac3c95ec">COUNTRADNONLOCAL</a>;</div>
<div class="line"><a name="l02887"></a><span class="lineno"> 2887</span>&#160;    docorrectucons=1;</div>
<div class="line"><a name="l02888"></a><span class="lineno"> 2888</span>&#160;  }</div>
<div class="line"><a name="l02889"></a><span class="lineno"> 2889</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(radlpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ac2e41dde6ad6ac3afe36f33ff2e1a720">UTOPRIMRADFAILFIXEDUTOPRIMRAD</a>){</div>
<div class="line"><a name="l02890"></a><span class="lineno"> 2890</span>&#160;    dualfprintf(fail_file,<span class="stringliteral">&quot;prior rad pflag not cleared: nstep=%ld steppart=%d t=%21.15g i=%d j=%d k=%d \n&quot;</span>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a1a1088d87617078680f1fd0f0d707384">nstep</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a70170b90229f9fc05eebf8508a685c70">steppart</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#ae1ee1e1c83c3f70e2e1afed4f4f5b41e">t</a>,i,j,k);</div>
<div class="line"><a name="l02891"></a><span class="lineno"> 2891</span>&#160;    radutoprimfailtype=-1;</div>
<div class="line"><a name="l02892"></a><span class="lineno"> 2892</span>&#160;    docorrectucons=0;</div>
<div class="line"><a name="l02893"></a><span class="lineno"> 2893</span>&#160;  }</div>
<div class="line"><a name="l02894"></a><span class="lineno"> 2894</span>&#160;</div>
<div class="line"><a name="l02895"></a><span class="lineno"> 2895</span>&#160;</div>
<div class="line"><a name="l02896"></a><span class="lineno"> 2896</span>&#160;</div>
<div class="line"><a name="l02898"></a><span class="lineno"> 2898</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02899"></a><span class="lineno"> 2899</span>&#160;  <span class="comment">// Check if either MHD or RADIATION was corrected</span></div>
<div class="line"><a name="l02900"></a><span class="lineno"> 2900</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02902"></a><span class="lineno"> 2902</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02903"></a><span class="lineno"> 2903</span>&#160;  <span class="keywordflow">if</span>(mhdutoprimfailtype!=-1 || radutoprimfailtype!=-1 || limitgammamhd==-1 || limitgammarad==-1){ </div>
<div class="line"><a name="l02904"></a><span class="lineno"> 2904</span>&#160;    <span class="keywordflow">if</span>(docorrectucons==1){</div>
<div class="line"><a name="l02905"></a><span class="lineno"> 2905</span>&#160;      docorrectucons=(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a55732148d2616d6d1f5d2abbe8710850">DOENOFLUX</a> != <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#adacaaf8526353cfe870206f0cf4d2ca7" title="for DOENOFLUX: 0: no ENO flux reconstruction 1: reconstruct F for finite difference rep...">NOENOFLUX</a>);</div>
<div class="line"><a name="l02906"></a><span class="lineno"> 2906</span>&#160;    }</div>
<div class="line"><a name="l02907"></a><span class="lineno"> 2907</span>&#160;</div>
<div class="line"><a name="l02909"></a><span class="lineno"> 2909</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02910"></a><span class="lineno"> 2910</span>&#160;    <span class="comment">// reset true pflag counter to &quot;no&quot; (fixed) failure so diagnostics account for change</span></div>
<div class="line"><a name="l02911"></a><span class="lineno"> 2911</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02913"></a><span class="lineno"> 2913</span>&#160;<span class="comment"></span>    <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(lpflag,i,j,k,FLAGUTOPRIMFAIL)=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a31984a48acce79cf07b32f0688481a66">UTOPRIMFAILFIXEDUTOPRIM</a>;</div>
<div class="line"><a name="l02914"></a><span class="lineno"> 2914</span>&#160;    <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(lpflag,i,j,k,FLAGUTOPRIMRADFAIL)=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ac2e41dde6ad6ac3afe36f33ff2e1a720">UTOPRIMRADFAILFIXEDUTOPRIMRAD</a>;</div>
<div class="line"><a name="l02915"></a><span class="lineno"> 2915</span>&#160;</div>
<div class="line"><a name="l02916"></a><span class="lineno"> 2916</span>&#160;</div>
<div class="line"><a name="l02917"></a><span class="lineno"> 2917</span>&#160;</div>
<div class="line"><a name="l02918"></a><span class="lineno"> 2918</span>&#160;    <span class="comment">// diagnostics</span></div>
<div class="line"><a name="l02919"></a><span class="lineno"> 2919</span>&#160;    <span class="comment">//    FTYPE prdiag[NPR],pr[NPR];</span></div>
<div class="line"><a name="l02920"></a><span class="lineno"> 2920</span>&#160;    <span class="comment">//    PLOOP(pliter,pl) prdiag[pl]=pr0[pl];</span></div>
<div class="line"><a name="l02921"></a><span class="lineno"> 2921</span>&#160;    <span class="comment">//    int doingmhdfixup=(mhdutoprimfailtype!=-1); // diag_fixup() accounting diagnostics part doesn&#39;t have radiation yet</span></div>
<div class="line"><a name="l02922"></a><span class="lineno"> 2922</span>&#160;</div>
<div class="line"><a name="l02923"></a><span class="lineno"> 2923</span>&#160;    <span class="comment">//    if((startpos[1]+ptrgeom-&gt;i==17) &amp;&amp; (startpos[2]+ptrgeom-&gt;j)==0){</span></div>
<div class="line"><a name="l02924"></a><span class="lineno"> 2924</span>&#160;    <span class="comment">//      dualfprintf(fail_file,&quot;BEFORE IN FIXUPUTOPRIM: finalstep=%d\n&quot;,finalstep);</span></div>
<div class="line"><a name="l02925"></a><span class="lineno"> 2925</span>&#160;    <span class="comment">//    }</span></div>
<div class="line"><a name="l02926"></a><span class="lineno"> 2926</span>&#160;</div>
<div class="line"><a name="l02927"></a><span class="lineno"> 2927</span>&#160;</div>
<div class="line"><a name="l02928"></a><span class="lineno"> 2928</span>&#160;    <span class="comment">//    diag_fixup(docorrectucons,prdiag, MAC(pv,i,j,k), ucons, ptrgeom, finalstep, doingmhdfixup, (int)mhdutoprimfailtype); // do corrections in general, but only include accounting for MHD case so far (KORALTODO, not too crucial, just diags).</span></div>
<div class="line"><a name="l02929"></a><span class="lineno"> 2929</span>&#160;    <span class="comment">//    PLOOP(pliter,pl) prdiag[pl]=MACP0A1(pv,i,j,k,pl);</span></div>
<div class="line"><a name="l02930"></a><span class="lineno"> 2930</span>&#160;</div>
<div class="line"><a name="l02931"></a><span class="lineno"> 2931</span>&#160;    <span class="comment">// pr0=prdiag only correct as reference primitive if was no failure of any kind, but some kind of failure if here, so need to use ucons as reference to what should be.</span></div>
<div class="line"><a name="l02932"></a><span class="lineno"> 2932</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Uievolve[NPR];</div>
<div class="line"><a name="l02933"></a><span class="lineno"> 2933</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) Uievolve[pl] = <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(uconsinput,i,j,k,pl);</div>
<div class="line"><a name="l02934"></a><span class="lineno"> 2934</span>&#160;    diag_fixup_Ui_pf(docorrectucons, Uievolve, <a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(pv,i,j,k), ptrgeom, finalstep,(<span class="keywordtype">int</span>)mhdutoprimfailtype, NULL);</div>
<div class="line"><a name="l02935"></a><span class="lineno"> 2935</span>&#160;</div>
<div class="line"><a name="l02936"></a><span class="lineno"> 2936</span>&#160;    </div>
<div class="line"><a name="l02937"></a><span class="lineno"> 2937</span>&#160;</div>
<div class="line"><a name="l02938"></a><span class="lineno"> 2938</span>&#160;</div>
<div class="line"><a name="l02939"></a><span class="lineno"> 2939</span>&#160;</div>
<div class="line"><a name="l02940"></a><span class="lineno"> 2940</span>&#160;    <span class="comment">//    if((startpos[1]+ptrgeom-&gt;i==17) &amp;&amp; (startpos[2]+ptrgeom-&gt;j)==0){</span></div>
<div class="line"><a name="l02941"></a><span class="lineno"> 2941</span>&#160;    <span class="comment">//      dualfprintf(fail_file,&quot;AFTER IN FIXUPUTOPRIM: UievolveRHO=%21.15g\n&quot;,Uievolve[RHO]*dx[1]*dx[2]*dx[3]);</span></div>
<div class="line"><a name="l02942"></a><span class="lineno"> 2942</span>&#160;    <span class="comment">//    }</span></div>
<div class="line"><a name="l02943"></a><span class="lineno"> 2943</span>&#160;</div>
<div class="line"><a name="l02944"></a><span class="lineno"> 2944</span>&#160;</div>
<div class="line"><a name="l02945"></a><span class="lineno"> 2945</span>&#160;    <span class="comment">//    if((startpos[1]+ptrgeom-&gt;i==17) &amp;&amp; (startpos[2]+ptrgeom-&gt;j)==0){</span></div>
<div class="line"><a name="l02946"></a><span class="lineno"> 2946</span>&#160;    <span class="comment">//      struct of_state qb;</span></div>
<div class="line"><a name="l02947"></a><span class="lineno"> 2947</span>&#160;    <span class="comment">//      get_state(MAC(pv,i,j,k),ptrgeom,&amp;qb);</span></div>
<div class="line"><a name="l02948"></a><span class="lineno"> 2948</span>&#160;    <span class="comment">//      FTYPE ub[NPR],ubabs[NPR];</span></div>
<div class="line"><a name="l02949"></a><span class="lineno"> 2949</span>&#160;    <span class="comment">//      int uutype=UDIAG;</span></div>
<div class="line"><a name="l02950"></a><span class="lineno"> 2950</span>&#160;    <span class="comment">//      primtoU(uutype,MAC(pv,i,j,k),&amp;qb,ptrgeom,ub,ubabs);</span></div>
<div class="line"><a name="l02951"></a><span class="lineno"> 2951</span>&#160;    <span class="comment">//      dualfprintf(fail_file,&quot;URHOINFIXUPUTOPRIMACCTT=%21.15g\n&quot;,ub[RHO]*dx[1]*dx[2]*dx[3]);</span></div>
<div class="line"><a name="l02952"></a><span class="lineno"> 2952</span>&#160;    <span class="comment">//    }</span></div>
<div class="line"><a name="l02953"></a><span class="lineno"> 2953</span>&#160;</div>
<div class="line"><a name="l02954"></a><span class="lineno"> 2954</span>&#160;</div>
<div class="line"><a name="l02955"></a><span class="lineno"> 2955</span>&#160;</div>
<div class="line"><a name="l02956"></a><span class="lineno"> 2956</span>&#160;    <span class="comment">// now adjust uf or ucum so agrees [already done in diag_fixup() but only if final step.  This allows one to do it on any step in case want to control behavior of conserved quantities or primitive quantities used to create fluxes.</span></div>
<div class="line"><a name="l02957"></a><span class="lineno"> 2957</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../de/d95/fixup_8c.html#a15e7961b48e1b05d7500628768512aed">ADJUSTCONSERVEDQUANTITY</a>&amp;&amp;docorrectucons){</div>
<div class="line"><a name="l02958"></a><span class="lineno"> 2958</span>&#160;</div>
<div class="line"><a name="l02959"></a><span class="lineno"> 2959</span>&#160;      <span class="keywordflow">if</span>((<a class="code" href="../../de/d95/fixup_8c.html#a15e7961b48e1b05d7500628768512aed">ADJUSTCONSERVEDQUANTITY</a>==1)&amp;&amp;(finalstep)) doadjustcons=1;</div>
<div class="line"><a name="l02960"></a><span class="lineno"> 2960</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../de/d95/fixup_8c.html#a15e7961b48e1b05d7500628768512aed">ADJUSTCONSERVEDQUANTITY</a>==2) doadjustcons=1;</div>
<div class="line"><a name="l02961"></a><span class="lineno"> 2961</span>&#160;      <span class="keywordflow">else</span> doadjustcons=0;</div>
<div class="line"><a name="l02962"></a><span class="lineno"> 2962</span>&#160;</div>
<div class="line"><a name="l02963"></a><span class="lineno"> 2963</span>&#160;      <span class="keywordflow">if</span>(doadjustcons){</div>
<div class="line"><a name="l02964"></a><span class="lineno"> 2964</span>&#160;        <span class="comment">//utoinvert=ucons;</span></div>
<div class="line"><a name="l02965"></a><span class="lineno"> 2965</span>&#160;        <span class="comment">//     if(finalstep){ // last call, so ucum is cooked and ready to eat!</span></div>
<div class="line"><a name="l02966"></a><span class="lineno"> 2966</span>&#160;        <span class="comment">//     }</span></div>
<div class="line"><a name="l02967"></a><span class="lineno"> 2967</span>&#160;        <span class="comment">//     else{ // otherwise still iterating on primitives</span></div>
<div class="line"><a name="l02968"></a><span class="lineno"> 2968</span>&#160;        <span class="comment">//       utoinvert=ulast;</span></div>
<div class="line"><a name="l02969"></a><span class="lineno"> 2969</span>&#160;        <span class="comment">//     }</span></div>
<div class="line"><a name="l02970"></a><span class="lineno"> 2970</span>&#160;     </div>
<div class="line"><a name="l02971"></a><span class="lineno"> 2971</span>&#160;        <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a11e17cd8b0594d1ad52e3594aa9f477e" title="find ucon, ucov, bcon, bcov from primitive variables when calling get_state, users of this function e...">get_state</a>(<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(pv,i,j,k), ptrgeom, &amp;q),<span class="stringliteral">&quot;fixup.c:fixup_utoprim()&quot;</span>, <span class="stringliteral">&quot;get_state()&quot;</span>, 1);</div>
<div class="line"><a name="l02972"></a><span class="lineno"> 2972</span>&#160;        <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a9a54096e4c40a15a2c1bf74266153616" title="calculate &quot;conserved&quot; quantities">primtoU</a>(UEVOLVE,<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(pv,i,j,k), &amp;q, ptrgeom, ucons, NULL),<span class="stringliteral">&quot;fixup.c:fixup_utoprim()&quot;</span>, <span class="stringliteral">&quot;primtoU()&quot;</span>, 1);</div>
<div class="line"><a name="l02973"></a><span class="lineno"> 2973</span>&#160;      }</div>
<div class="line"><a name="l02974"></a><span class="lineno"> 2974</span>&#160;    }</div>
<div class="line"><a name="l02975"></a><span class="lineno"> 2975</span>&#160;</div>
<div class="line"><a name="l02976"></a><span class="lineno"> 2976</span>&#160;    <span class="comment">// copy over ucons result in case changed.</span></div>
<div class="line"><a name="l02977"></a><span class="lineno"> 2977</span>&#160;    <span class="keywordflow">if</span>(uconsinput!=NULL &amp;&amp; docorrectucons){</div>
<div class="line"><a name="l02978"></a><span class="lineno"> 2978</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l02979"></a><span class="lineno"> 2979</span>&#160;        <span class="comment">// if staggered field, avoid modifying field since at FACEs, not CENT where pr lives.</span></div>
<div class="line"><a name="l02980"></a><span class="lineno"> 2980</span>&#160;        <span class="keywordflow">if</span>(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a56c640597356b6f642dd6ee1afb87e74">BPL</a>(pl)==0 &amp;&amp; <a class="code" href="../../d8/d5b/defs_8general_8h.html#a11c4e99e1493d0c1914ad1ab313ea472">FLUXB</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0b6762cef74e396f50a83864bb53fb6c">FLUXCTSTAG</a> || <a class="code" href="../../d8/d5b/defs_8general_8h.html#a11c4e99e1493d0c1914ad1ab313ea472">FLUXB</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a5014e44c6e710d8827ef79dd18abe6ad">FLUXCTTOTH</a>){</div>
<div class="line"><a name="l02981"></a><span class="lineno"> 2981</span>&#160;          <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(uconsinput,i,j,k,pl) = ucons[pl];</div>
<div class="line"><a name="l02982"></a><span class="lineno"> 2982</span>&#160;        }</div>
<div class="line"><a name="l02983"></a><span class="lineno"> 2983</span>&#160;      }</div>
<div class="line"><a name="l02984"></a><span class="lineno"> 2984</span>&#160;    }</div>
<div class="line"><a name="l02985"></a><span class="lineno"> 2985</span>&#160;</div>
<div class="line"><a name="l02986"></a><span class="lineno"> 2986</span>&#160;  }<span class="comment">// end if mhdutoprimfailtype!=-1 || radutoprimfailtype!=-1</span></div>
<div class="line"><a name="l02987"></a><span class="lineno"> 2987</span>&#160;</div>
<div class="line"><a name="l02988"></a><span class="lineno"> 2988</span>&#160;</div>
<div class="line"><a name="l02989"></a><span class="lineno"> 2989</span>&#160;</div>
<div class="line"><a name="l02990"></a><span class="lineno"> 2990</span>&#160;<span class="preprocessor">#if(DOSUPERDEBUG)</span></div>
<div class="line"><a name="l02991"></a><span class="lineno"> 2991</span>&#160;<span class="preprocessor"></span>  <span class="comment">// only used to keep track of normal non-failure points</span></div>
<div class="line"><a name="l02992"></a><span class="lineno"> 2992</span>&#160;  <span class="comment">// some non-utoprim-failure points will be picked up by this.  I.E. those with limitgammaact/flooract/inflowact</span></div>
<div class="line"><a name="l02993"></a><span class="lineno"> 2993</span>&#160;  <span class="keywordflow">if</span>(mhdutoprimfailtype==-1) superdebug_utoprim(pr0,<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(pv,i,j,k),ptrgeom,mhdutoprimfailtype);</div>
<div class="line"><a name="l02994"></a><span class="lineno"> 2994</span>&#160;  <span class="comment">// collect values for non-failed and failed zones</span></div>
<div class="line"><a name="l02995"></a><span class="lineno"> 2995</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02996"></a><span class="lineno"> 2996</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l02997"></a><span class="lineno"> 2997</span>&#160;</div>
<div class="line"><a name="l02998"></a><span class="lineno"> 2998</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l02999"></a><span class="lineno"> 2999</span>&#160;}</div>
<div class="line"><a name="l03000"></a><span class="lineno"> 3000</span>&#160;</div>
<div class="line"><a name="l03001"></a><span class="lineno"> 3001</span>&#160;</div>
<div class="line"><a name="l03002"></a><span class="lineno"> 3002</span>&#160;<span class="comment">// what quantities to average or treat in fixup_utoprim()</span></div>
<div class="line"><a name="l03003"></a><span class="lineno"> 3003</span>&#160;<span class="comment">// only touch mhd quantities for mhd case, rad quantities for rad case, and never touch field</span></div>
<div class="line"><a name="l03004"></a><span class="lineno"><a class="code" href="../../de/d95/fixup_8c.html#a7c32d22e47927c62e7c993461b335acf"> 3004</a></span>&#160;<span class="preprocessor">#define PLOOPSTARTEND(pl) for(pl=startpl;pl&lt;=endpl;pl++) if((NONRADFULLPL(pl) &amp;&amp; doingmhd || RADFULLPL(pl) &amp;&amp; doingmhd==0) &amp;&amp; BPL(pl)==0)</span></div>
<div class="line"><a name="l03005"></a><span class="lineno"> 3005</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l03006"></a><span class="lineno"> 3006</span>&#160;</div>
<div class="line"><a name="l03007"></a><span class="lineno"> 3007</span>&#160;</div>
<div class="line"><a name="l03008"></a><span class="lineno"> 3008</span>&#160;</div>
<div class="line"><a name="l03009"></a><span class="lineno"> 3009</span>&#160;<span class="comment">// sums need to be symmerized in order to preserve exact symmetry</span></div>
<div class="line"><a name="l03010"></a><span class="lineno"> 3010</span>&#160;<span class="preprocessor">#define AVG4_1(pr,i,j,k,pl) (0.25*((MACP0A1(pr,i,jp1mac(j),k,pl)+MACP0A1(pr,i,jm1mac(j),k,pl))+(MACP0A1(pr,im1mac(i),j,k,pl)+MACP0A1(pr,ip1mac(i),j,k,pl))))  // symmetrized sum</span></div>
<div class="line"><a name="l03011"></a><span class="lineno"> 3011</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define AVG4_2(pr,i,j,k,pl) (0.25*((MACP0A1(pr,ip1mac(i),jp1mac(j),k,pl)+MACP0A1(pr,ip1mac(i),jm1mac(j),k,pl))+(MACP0A1(pr,im1mac(i),jp1mac(j),k,pl)+MACP0A1(pr,im1mac(i),jm1mac(j),k,pl))))  //symmetrized sum</span></div>
<div class="line"><a name="l03012"></a><span class="lineno"> 3012</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l03013"></a><span class="lineno"><a class="code" href="../../de/d95/fixup_8c.html#ad0615cca7029b15274e21979b2528a45"> 3013</a></span>&#160;<span class="preprocessor">#define AVG2_1(pr,i,j,k,pl) (0.5*(MACP0A1(pr,i,jp1mac(j),k,pl)+MACP0A1(pr,i,jm1mac(j),k,pl)))  </span></div>
<div class="line"><a name="l03014"></a><span class="lineno"><a class="code" href="../../de/d95/fixup_8c.html#aaf583eed3447eb70e3460cce4e756621"> 3014</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define AVG2_2(pr,i,j,k,pl) (0.5*(MACP0A1(pr,ip1mac(i),j,k,pl)+MACP0A1(pr,im1mac(i),j,k,pl)))</span></div>
<div class="line"><a name="l03015"></a><span class="lineno"><a class="code" href="../../de/d95/fixup_8c.html#ae02075847c8bcb609daeeb21fbe25b2a"> 3015</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define AVG2_3(pr,i,j,k,pl) (0.5*(MACP0A1(pr,ip1mac(i),jp1mac(j),k,pl)+MACP0A1(pr,im1mac(i),jm1mac(j),k,pl)))</span></div>
<div class="line"><a name="l03016"></a><span class="lineno"><a class="code" href="../../de/d95/fixup_8c.html#a1402725322506948abac361681b1cbb5"> 3016</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define AVG2_4(pr,i,j,k,pl) (0.5*(MACP0A1(pr,ip1mac(i),jm1mac(j),k,pl)+MACP0A1(pr,im1mac(i),jp1mac(j),k,pl)))</span></div>
<div class="line"><a name="l03017"></a><span class="lineno"> 3017</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l03018"></a><span class="lineno"><a class="code" href="../../de/d95/fixup_8c.html#afffb4925f444309c751a6aa55468d412"> 3018</a></span>&#160;<span class="preprocessor">#define AVG4_1(pr,i,j,k,pl) (0.25*((MACP0A1(pr,i,jp1mac(j),k,pl)+MACP0A1(pr,i,jm1mac(j),k,pl))+(MACP0A1(pr,im1mac(i),j,k,pl)+MACP0A1(pr,ip1mac(i),j,k,pl))))  // symmetrized sum</span></div>
<div class="line"><a name="l03019"></a><span class="lineno"><a class="code" href="../../de/d95/fixup_8c.html#a8988b8749add2fcc20cb7ee1706bf6b4"> 3019</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define AVG4_2(pr,i,j,k,pl) (0.25*((MACP0A1(pr,ip1mac(i),jp1mac(j),k,pl)+MACP0A1(pr,ip1mac(i),jm1mac(j),k,pl))+(MACP0A1(pr,im1mac(i),jp1mac(j),k,pl)+MACP0A1(pr,im1mac(i),jm1mac(j),k,pl))))  //symmetrized sum</span></div>
<div class="line"><a name="l03020"></a><span class="lineno"> 3020</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l03021"></a><span class="lineno"> 3021</span>&#160;</div>
<div class="line"><a name="l03022"></a><span class="lineno"> 3022</span>&#160;<span class="comment">// whether doing causal averaging for non-U2AVG failures</span></div>
<div class="line"><a name="l03023"></a><span class="lineno"><a class="code" href="../../de/d95/fixup_8c.html#a1f33f1ec00b0aa5720d289189166ef1b"> 3023</a></span>&#160;<span class="preprocessor">#define CAUSALAVG 0</span></div>
<div class="line"><a name="l03024"></a><span class="lineno"> 3024</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l03025"></a><span class="lineno"><a class="code" href="../../de/d95/fixup_8c.html#a646497b0bea7066a88e6d519680ddc3c"> 3025</a></span>&#160;<span class="preprocessor">#define CAUSALAVG_WHEN_U2AVG 0 // causal way -- uses same normal loops</span></div>
<div class="line"><a name="l03026"></a><span class="lineno"><a class="code" href="../../de/d95/fixup_8c.html#a88d66280026f287cd8ae02a41207621b"> 3026</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define SIMPLEAVG_WHEN_U2AVG 1 // normal average</span></div>
<div class="line"><a name="l03027"></a><span class="lineno"><a class="code" href="../../de/d95/fixup_8c.html#aded03130748c931cd4e2f8bc387f7223"> 3027</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define MAXUPOSAVG_WHEN_U2AVG 2 // Sasha way -- take min of positive internal energies</span></div>
<div class="line"><a name="l03028"></a><span class="lineno"><a class="code" href="../../de/d95/fixup_8c.html#ad8e502ba1f37cbccf27f7e9e3b305f47"> 3028</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define CAUSAL_THENMIN_WHEN_U2AVG 3 // Jon way -- use min of ANY (pos or neg) answer between (1) causal and (2) min of all positive</span></div>
<div class="line"><a name="l03029"></a><span class="lineno"> 3029</span>&#160;<span class="preprocessor"></span>       </div>
<div class="line"><a name="l03030"></a><span class="lineno"> 3030</span>&#160;<span class="comment">//#define HOWTOAVG_WHEN_U2AVG SIMPLEAVG_WHEN_U2AVG // can artificially pump up internal energy as in caustic test</span></div>
<div class="line"><a name="l03031"></a><span class="lineno"> 3031</span>&#160;<span class="comment">//#define HOWTOAVG_WHEN_U2AVG CAUSALAVG_WHEN_U2AVG</span></div>
<div class="line"><a name="l03032"></a><span class="lineno"><a class="code" href="../../de/d95/fixup_8c.html#acde3ea5c40031339938829f703c7f8de"> 3032</a></span>&#160;<span class="preprocessor">#define HOWTOAVG_WHEN_U2AVG MAXUPOSAVG_WHEN_U2AVG</span></div>
<div class="line"><a name="l03033"></a><span class="lineno"> 3033</span>&#160;<span class="preprocessor"></span><span class="comment">//#define HOWTOAVG_WHEN_U2AVG CAUSAL_THENMIN_WHEN_U2AVG</span></div>
<div class="line"><a name="l03034"></a><span class="lineno"> 3034</span>&#160;</div>
<div class="line"><a name="l03036"></a><span class="lineno"> 3036</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> general_average(<span class="keywordtype">int</span> useonlynonfailed, <span class="keywordtype">int</span> numbndtotry, <span class="keywordtype">int</span> maxnumbndtotry, <span class="keywordtype">int</span> startpl, <span class="keywordtype">int</span> endpl, <span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k, <span class="keywordtype">int</span> doingmhd, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> mhdlpflag, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> radlpflag, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> (*lpflagfailorig)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NUMFAILPFLAGS],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pv)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*ptoavg)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR], <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom)</div>
<div class="line"><a name="l03037"></a><span class="lineno"> 3037</span>&#160;{</div>
<div class="line"><a name="l03038"></a><span class="lineno"> 3038</span>&#160;  <span class="keywordtype">int</span> doavgcausal,failavglooptype;</div>
<div class="line"><a name="l03039"></a><span class="lineno"> 3039</span>&#160;  <span class="keywordtype">int</span> pl,pliter;</div>
<div class="line"><a name="l03040"></a><span class="lineno"> 3040</span>&#160;  <span class="keywordtype">int</span> ii,jj,kk;</div>
<div class="line"><a name="l03041"></a><span class="lineno"> 3041</span>&#160;  <span class="keywordtype">int</span> jjj;</div>
<div class="line"><a name="l03042"></a><span class="lineno"> 3042</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> state_pv;</div>
<div class="line"><a name="l03043"></a><span class="lineno"> 3043</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> cminmax[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>][<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a3299de85771e134921ac37c7b5b2c9b8" title="for wavespeeds.c and fluxcompute.c">NUMCS</a>];</div>
<div class="line"><a name="l03044"></a><span class="lineno"> 3044</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> superfast[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l03045"></a><span class="lineno"> 3045</span>&#160;  <span class="keywordtype">int</span> numavg[NPR];</div>
<div class="line"><a name="l03046"></a><span class="lineno"> 3046</span>&#160;  <span class="keywordtype">int</span> numavg0,numavg1[NPR];</div>
<div class="line"><a name="l03047"></a><span class="lineno"> 3047</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> mysum[2][NPR];</div>
<div class="line"><a name="l03048"></a><span class="lineno"> 3048</span>&#160;  <span class="keywordtype">int</span> numupairs,qq,thisnotfail,thatnotfail,rnx,rny,rnz;</div>
<div class="line"><a name="l03049"></a><span class="lineno"> 3049</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ref[NPR];</div>
<div class="line"><a name="l03050"></a><span class="lineno"> 3050</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ftemp,ftemp1,ftemp2;</div>
<div class="line"><a name="l03051"></a><span class="lineno"> 3051</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> lastmin[NPR],avganswer0[NPR],avganswer1[NPR];</div>
<div class="line"><a name="l03052"></a><span class="lineno"> 3052</span>&#160;  <span class="keywordtype">int</span> ignorecourant=0;</div>
<div class="line"><a name="l03053"></a><span class="lineno"> 3053</span>&#160;  <span class="keywordtype">int</span> factor;</div>
<div class="line"><a name="l03054"></a><span class="lineno"> 3054</span>&#160;  <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> lpflag;</div>
<div class="line"><a name="l03055"></a><span class="lineno"> 3055</span>&#160;  <span class="keywordtype">int</span> whichpflag;</div>
<div class="line"><a name="l03056"></a><span class="lineno"> 3056</span>&#160;</div>
<div class="line"><a name="l03057"></a><span class="lineno"> 3057</span>&#160;  </div>
<div class="line"><a name="l03058"></a><span class="lineno"> 3058</span>&#160;  <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a7df8286c59d491ba1117884d33499a7a">prod0dualfprintf</a>(debugfail&gt;=2,fail_file,<span class="stringliteral">&quot;uc2generalA: doingmhd=%d mhdlpflag=%d radlpflag=%d startpl=%d endpl=%d :: i=%d j=%d k=%d\n&quot;</span>,doingmhd,mhdlpflag,radlpflag,startpl,endpl,i,j,k); <span class="comment">// not too much</span></div>
<div class="line"><a name="l03059"></a><span class="lineno"> 3059</span>&#160;  <span class="comment">//  if(debugfail&gt;=2) for(pl=startpl; pl&lt;=endpl; pl++) dualfprintf(fail_file,&quot;uc2generalSTART: pl=%d pv=%g\n&quot;,pl,MACP0A1(pv,i,j,k,pl));</span></div>
<div class="line"><a name="l03060"></a><span class="lineno"> 3060</span>&#160;</div>
<div class="line"><a name="l03061"></a><span class="lineno"> 3061</span>&#160;</div>
<div class="line"><a name="l03062"></a><span class="lineno"> 3062</span>&#160;  <span class="keywordflow">if</span>(doingmhd==1){ <span class="comment">// if MHD</span></div>
<div class="line"><a name="l03063"></a><span class="lineno"> 3063</span>&#160;    whichpflag=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>;</div>
<div class="line"><a name="l03064"></a><span class="lineno"> 3064</span>&#160;    lpflag=mhdlpflag;</div>
<div class="line"><a name="l03065"></a><span class="lineno"> 3065</span>&#160;</div>
<div class="line"><a name="l03066"></a><span class="lineno"> 3066</span>&#160;    <span class="keywordflow">if</span>(mhdlpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ac3b05e85d00237f2aaa8ec4ec6ff82a3">UTOPRIMFAILU2AVG1</a> || mhdlpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a042dcc3162731841db25689b5f94c2ac">UTOPRIMFAILU2AVG2</a> || mhdlpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afc8db2dfa526f28224a0903680453240">UTOPRIMFAILU2AVG1FROMCOLD</a> || mhdlpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ace792b5d6cf33871003798c658ba55b2">UTOPRIMFAILU2AVG2FROMCOLD</a>){</div>
<div class="line"><a name="l03067"></a><span class="lineno"> 3067</span>&#160;      <span class="keywordflow">if</span>(<a class="code" href="../../de/d95/fixup_8c.html#acde3ea5c40031339938829f703c7f8de">HOWTOAVG_WHEN_U2AVG</a>==<a class="code" href="../../de/d95/fixup_8c.html#a646497b0bea7066a88e6d519680ddc3c">CAUSALAVG_WHEN_U2AVG</a>){ <span class="comment">// causal type</span></div>
<div class="line"><a name="l03068"></a><span class="lineno"> 3068</span>&#160;        doavgcausal=1;</div>
<div class="line"><a name="l03069"></a><span class="lineno"> 3069</span>&#160;        failavglooptype=0;</div>
<div class="line"><a name="l03070"></a><span class="lineno"> 3070</span>&#160;      }</div>
<div class="line"><a name="l03071"></a><span class="lineno"> 3071</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../de/d95/fixup_8c.html#acde3ea5c40031339938829f703c7f8de">HOWTOAVG_WHEN_U2AVG</a>==<a class="code" href="../../de/d95/fixup_8c.html#aded03130748c931cd4e2f8bc387f7223">MAXUPOSAVG_WHEN_U2AVG</a>){ <span class="comment">// Sasha type</span></div>
<div class="line"><a name="l03072"></a><span class="lineno"> 3072</span>&#160;        doavgcausal=0; <span class="comment">// doesn&#39;t hurt, it&#39;s just wasted process</span></div>
<div class="line"><a name="l03073"></a><span class="lineno"> 3073</span>&#160;        failavglooptype=1;</div>
<div class="line"><a name="l03074"></a><span class="lineno"> 3074</span>&#160;      }</div>
<div class="line"><a name="l03075"></a><span class="lineno"> 3075</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../de/d95/fixup_8c.html#acde3ea5c40031339938829f703c7f8de">HOWTOAVG_WHEN_U2AVG</a>==<a class="code" href="../../de/d95/fixup_8c.html#a88d66280026f287cd8ae02a41207621b">SIMPLEAVG_WHEN_U2AVG</a>){ <span class="comment">// simple type</span></div>
<div class="line"><a name="l03076"></a><span class="lineno"> 3076</span>&#160;        doavgcausal=0;</div>
<div class="line"><a name="l03077"></a><span class="lineno"> 3077</span>&#160;        failavglooptype=0;</div>
<div class="line"><a name="l03078"></a><span class="lineno"> 3078</span>&#160;      }</div>
<div class="line"><a name="l03079"></a><span class="lineno"> 3079</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../de/d95/fixup_8c.html#acde3ea5c40031339938829f703c7f8de">HOWTOAVG_WHEN_U2AVG</a>==<a class="code" href="../../de/d95/fixup_8c.html#ad8e502ba1f37cbccf27f7e9e3b305f47">CAUSAL_THENMIN_WHEN_U2AVG</a>){ <span class="comment">// Jon&#39;s mixed type</span></div>
<div class="line"><a name="l03080"></a><span class="lineno"> 3080</span>&#160;        doavgcausal=1;</div>
<div class="line"><a name="l03081"></a><span class="lineno"> 3081</span>&#160;        failavglooptype=2; <span class="comment">// do both loops</span></div>
<div class="line"><a name="l03082"></a><span class="lineno"> 3082</span>&#160;      }</div>
<div class="line"><a name="l03083"></a><span class="lineno"> 3083</span>&#160;    }</div>
<div class="line"><a name="l03084"></a><span class="lineno"> 3084</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../de/d95/fixup_8c.html#a1f33f1ec00b0aa5720d289189166ef1b">CAUSALAVG</a>){ <span class="comment">// other types of failures besides U2AVG</span></div>
<div class="line"><a name="l03085"></a><span class="lineno"> 3085</span>&#160;      failavglooptype=0;</div>
<div class="line"><a name="l03086"></a><span class="lineno"> 3086</span>&#160;      doavgcausal=1;</div>
<div class="line"><a name="l03087"></a><span class="lineno"> 3087</span>&#160;    }</div>
<div class="line"><a name="l03088"></a><span class="lineno"> 3088</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l03089"></a><span class="lineno"> 3089</span>&#160;      doavgcausal=0;</div>
<div class="line"><a name="l03090"></a><span class="lineno"> 3090</span>&#160;      failavglooptype=0; <span class="comment">// must stay 0 since can&#39;t assume a density of some kind with min value</span></div>
<div class="line"><a name="l03091"></a><span class="lineno"> 3091</span>&#160;    }  </div>
<div class="line"><a name="l03092"></a><span class="lineno"> 3092</span>&#160;  }</div>
<div class="line"><a name="l03093"></a><span class="lineno"> 3093</span>&#160;  <span class="keywordflow">else</span>{ <span class="comment">// if RAD</span></div>
<div class="line"><a name="l03094"></a><span class="lineno"> 3094</span>&#160;    whichpflag=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>;</div>
<div class="line"><a name="l03095"></a><span class="lineno"> 3095</span>&#160;    lpflag=radlpflag;</div>
<div class="line"><a name="l03096"></a><span class="lineno"> 3096</span>&#160;    doavgcausal=0;</div>
<div class="line"><a name="l03097"></a><span class="lineno"> 3097</span>&#160;    failavglooptype=0; <span class="comment">// must stay 0</span></div>
<div class="line"><a name="l03098"></a><span class="lineno"> 3098</span>&#160;  }</div>
<div class="line"><a name="l03099"></a><span class="lineno"> 3099</span>&#160;</div>
<div class="line"><a name="l03100"></a><span class="lineno"> 3100</span>&#160;</div>
<div class="line"><a name="l03101"></a><span class="lineno"> 3101</span>&#160;</div>
<div class="line"><a name="l03102"></a><span class="lineno"> 3102</span>&#160;</div>
<div class="line"><a name="l03103"></a><span class="lineno"> 3103</span>&#160; </div>
<div class="line"><a name="l03104"></a><span class="lineno"> 3104</span>&#160;  <span class="keywordflow">if</span>(doavgcausal){</div>
<div class="line"><a name="l03106"></a><span class="lineno"> 3106</span>&#160;    <span class="comment">// first get wave speed to check if superfast so need causal averaging</span></div>
<div class="line"><a name="l03107"></a><span class="lineno"> 3107</span>&#160;    <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a11e17cd8b0594d1ad52e3594aa9f477e" title="find ucon, ucov, bcon, bcov from primitive variables when calling get_state, users of this function e...">get_state</a>(<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(ptoavg,i,j,k), ptrgeom, &amp;state_pv),<span class="stringliteral">&quot;fixup.c:fixup_utporim()&quot;</span>, <span class="stringliteral">&quot;get_state()&quot;</span>, 1);</div>
<div class="line"><a name="l03108"></a><span class="lineno"> 3108</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a51b48b29d7903bb94a3d7879c3ff8eb9">N1NOT1</a>){</div>
<div class="line"><a name="l03109"></a><span class="lineno"> 3109</span>&#160;      <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(<a class="code" href="../../de/db6/wavespeeds_8c.html#a89ebfcafdd16ff4aafb94363ca6da464" title="get wave speeds for flux calculation and for dt calculation">vchar_all</a>(<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(ptoavg,i,j,k), &amp;state_pv, 1, ptrgeom, &amp;cminmax[1][<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#af54f93f6144a25245050831c9fe45a57">CMAX</a>], &amp;cminmax[1][<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a41349685ec12c0ae4978fbb9780f7a1b">CMIN</a>],&amp;ignorecourant),<span class="stringliteral">&quot;fixup.c:fixup_utoprim()&quot;</span>, <span class="stringliteral">&quot;vchar_all() dir=1or2&quot;</span>, 1);</div>
<div class="line"><a name="l03110"></a><span class="lineno"> 3110</span>&#160;    }</div>
<div class="line"><a name="l03111"></a><span class="lineno"> 3111</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9d8b7e3d088c68f51e7b29b95326a4ac">N2NOT1</a>){</div>
<div class="line"><a name="l03112"></a><span class="lineno"> 3112</span>&#160;      <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(<a class="code" href="../../de/db6/wavespeeds_8c.html#a89ebfcafdd16ff4aafb94363ca6da464" title="get wave speeds for flux calculation and for dt calculation">vchar_all</a>(<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(ptoavg,i,j,k), &amp;state_pv, 2, ptrgeom, &amp;cminmax[2][<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#af54f93f6144a25245050831c9fe45a57">CMAX</a>], &amp;cminmax[2][<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a41349685ec12c0ae4978fbb9780f7a1b">CMIN</a>],&amp;ignorecourant),<span class="stringliteral">&quot;fixup.c:fixup_utoprim()&quot;</span>, <span class="stringliteral">&quot;vchar_all() dir=1or2&quot;</span>, 2);</div>
<div class="line"><a name="l03113"></a><span class="lineno"> 3113</span>&#160;    }</div>
<div class="line"><a name="l03114"></a><span class="lineno"> 3114</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#aabbd6bada71f73d78d57d14e9adc0c29">N3NOT1</a>){</div>
<div class="line"><a name="l03115"></a><span class="lineno"> 3115</span>&#160;      <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(<a class="code" href="../../de/db6/wavespeeds_8c.html#a89ebfcafdd16ff4aafb94363ca6da464" title="get wave speeds for flux calculation and for dt calculation">vchar_all</a>(<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(ptoavg,i,j,k), &amp;state_pv, 3, ptrgeom, &amp;cminmax[3][<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#af54f93f6144a25245050831c9fe45a57">CMAX</a>], &amp;cminmax[3][<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a41349685ec12c0ae4978fbb9780f7a1b">CMIN</a>],&amp;ignorecourant),<span class="stringliteral">&quot;fixup.c:fixup_utoprim()&quot;</span>, <span class="stringliteral">&quot;vchar_all() dir=1or2&quot;</span>, 3);</div>
<div class="line"><a name="l03116"></a><span class="lineno"> 3116</span>&#160;    }</div>
<div class="line"><a name="l03117"></a><span class="lineno"> 3117</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jjj){</div>
<div class="line"><a name="l03118"></a><span class="lineno"> 3118</span>&#160;      superfast[jjj]=0; <span class="comment">// assume subfast</span></div>
<div class="line"><a name="l03119"></a><span class="lineno"> 3119</span>&#160;</div>
<div class="line"><a name="l03120"></a><span class="lineno"> 3120</span>&#160;<span class="preprocessor">#if(1)</span></div>
<div class="line"><a name="l03121"></a><span class="lineno"> 3121</span>&#160;<span class="preprocessor"></span>      <span class="keywordflow">if</span>(cminmax[jjj][<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a41349685ec12c0ae4978fbb9780f7a1b">CMIN</a>]&gt;0.0){ superfast[jjj]=1.0;} <span class="comment">// superfast to right</span></div>
<div class="line"><a name="l03122"></a><span class="lineno"> 3122</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span>(cminmax[jjj][<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#af54f93f6144a25245050831c9fe45a57">CMAX</a>]&lt;0.0){ superfast[jjj]=-1.0;} <span class="comment">// superfast to left</span></div>
<div class="line"><a name="l03123"></a><span class="lineno"> 3123</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l03124"></a><span class="lineno"> 3124</span>&#160;<span class="preprocessor"></span>      <span class="keywordflow">if</span>(<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(ptoavg,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>-1+jjj)&gt;0.0){ superfast[jjj]=1.0;} <span class="comment">// wind blows to right</span></div>
<div class="line"><a name="l03125"></a><span class="lineno"> 3125</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(ptoavg,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>-1+jjj)&lt;0.0){ superfast[jjj]=-1.0;} <span class="comment">// wind blows to left</span></div>
<div class="line"><a name="l03126"></a><span class="lineno"> 3126</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03127"></a><span class="lineno"> 3127</span>&#160;<span class="preprocessor"></span>    }</div>
<div class="line"><a name="l03128"></a><span class="lineno"> 3128</span>&#160;</div>
<div class="line"><a name="l03129"></a><span class="lineno"> 3129</span>&#160;  } <span class="comment">// end if doing causal loop -- end getting wave speeds</span></div>
<div class="line"><a name="l03130"></a><span class="lineno"> 3130</span>&#160;</div>
<div class="line"><a name="l03131"></a><span class="lineno"> 3131</span>&#160;</div>
<div class="line"><a name="l03132"></a><span class="lineno"> 3132</span>&#160;   </div>
<div class="line"><a name="l03133"></a><span class="lineno"> 3133</span>&#160;</div>
<div class="line"><a name="l03134"></a><span class="lineno"> 3134</span>&#160;</div>
<div class="line"><a name="l03135"></a><span class="lineno"> 3135</span>&#160; </div>
<div class="line"><a name="l03137"></a><span class="lineno"> 3137</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l03138"></a><span class="lineno"> 3138</span>&#160;  <span class="comment">// average all surrounding good values (keeps symmetry)</span></div>
<div class="line"><a name="l03139"></a><span class="lineno"> 3139</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l03141"></a><span class="lineno"> 3141</span>&#160;<span class="comment"></span>  numavg0=0;</div>
<div class="line"><a name="l03142"></a><span class="lineno"> 3142</span>&#160;  <a class="code" href="../../de/d95/fixup_8c.html#a7c32d22e47927c62e7c993461b335acf">PLOOPSTARTEND</a>(pl){</div>
<div class="line"><a name="l03143"></a><span class="lineno"> 3143</span>&#160;    numavg1[pl]=0;</div>
<div class="line"><a name="l03144"></a><span class="lineno"> 3144</span>&#160;    numavg[pl]=0;</div>
<div class="line"><a name="l03145"></a><span class="lineno"> 3145</span>&#160;    mysum[0][pl]=0.0;</div>
<div class="line"><a name="l03146"></a><span class="lineno"> 3146</span>&#160;    mysum[1][pl]=0.0;</div>
<div class="line"><a name="l03147"></a><span class="lineno"> 3147</span>&#160;    lastmin[pl]=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a492fbe489a78316b029c696db35a5ec5">VERYBIG</a>;</div>
<div class="line"><a name="l03148"></a><span class="lineno"> 3148</span>&#160;  }</div>
<div class="line"><a name="l03149"></a><span class="lineno"> 3149</span>&#160;  <span class="comment">// size of little averaging box, from -NUMPFLAGBNDx to +NUMPFLAGBNDx</span></div>
<div class="line"><a name="l03150"></a><span class="lineno"> 3150</span>&#160;  <span class="keywordtype">int</span> rbndx=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(numbndtotry,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#aad70b682862be003c6e5785df344c708">NUMPFLAGBND1</a>);</div>
<div class="line"><a name="l03151"></a><span class="lineno"> 3151</span>&#160;  <span class="keywordtype">int</span> rbndy=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(numbndtotry,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a085da7f203f487d6c8bf51fd67f72002">NUMPFLAGBND2</a>);</div>
<div class="line"><a name="l03152"></a><span class="lineno"> 3152</span>&#160;  <span class="keywordtype">int</span> rbndz=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(numbndtotry,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#af3ec27b51afe3809a504884d90c6aca3">NUMPFLAGBND3</a>);</div>
<div class="line"><a name="l03153"></a><span class="lineno"> 3153</span>&#160;  rnx=(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a2fb146af349ab49ff48fa36b12b9e4fe" title="x1">SHIFT1</a>==1) ? (rbndx*2+1) : 1;</div>
<div class="line"><a name="l03154"></a><span class="lineno"> 3154</span>&#160;  rny=(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a4601f340e88302d63182d0844c4e3c09" title="x2">SHIFT2</a>==1) ? (rbndy*2+1) : 1;</div>
<div class="line"><a name="l03155"></a><span class="lineno"> 3155</span>&#160;  rnz=(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac3ff9bd198294b5b3a9c6a22b9cf456a" title="x3">SHIFT3</a>==1) ? (rbndz*2+1) : 1;</div>
<div class="line"><a name="l03156"></a><span class="lineno"> 3156</span>&#160;     </div>
<div class="line"><a name="l03157"></a><span class="lineno"> 3157</span>&#160;  <span class="comment">// number of unique pairs ( NUMPFLAGBND1*NUMPFLAGBND2*NUMPFLAGBND3 + NUMPFLAGBND1</span></div>
<div class="line"><a name="l03158"></a><span class="lineno"> 3158</span>&#160;  numupairs=(int)(rnx*rny*rnz-1)/2;</div>
<div class="line"><a name="l03159"></a><span class="lineno"> 3159</span>&#160;     </div>
<div class="line"><a name="l03160"></a><span class="lineno"> 3160</span>&#160;  <span class="keywordflow">for</span>(qq=0;qq&lt;numupairs;qq++){</div>
<div class="line"><a name="l03161"></a><span class="lineno"> 3161</span>&#160;       </div>
<div class="line"><a name="l03162"></a><span class="lineno"> 3162</span>&#160;    <span class="comment">// 1-d to 3D index</span></div>
<div class="line"><a name="l03163"></a><span class="lineno"> 3163</span>&#160;    ii=(int)(qq%rnx)-rbndx;</div>
<div class="line"><a name="l03164"></a><span class="lineno"> 3164</span>&#160;    jj=(int)((qq%(rnx*rny))/rnx)-rbndy;</div>
<div class="line"><a name="l03165"></a><span class="lineno"> 3165</span>&#160;    kk=(int)(qq/(rnx*rny))-rbndz;</div>
<div class="line"><a name="l03166"></a><span class="lineno"> 3166</span>&#160;</div>
<div class="line"><a name="l03167"></a><span class="lineno"> 3167</span>&#160;    <span class="keywordflow">if</span>(useonlynonfailed==1){</div>
<div class="line"><a name="l03168"></a><span class="lineno"> 3168</span>&#160;      <span class="keywordflow">if</span>(doingmhd){</div>
<div class="line"><a name="l03169"></a><span class="lineno"> 3169</span>&#160;        thisnotfail=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afaacb1c256e44ec7be2adaac65713f2b">IFUTOPRIMNOFAILORFIXED</a>(<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(lpflagfailorig,i+ii,j+jj,k+kk,whichpflag));</div>
<div class="line"><a name="l03170"></a><span class="lineno"> 3170</span>&#160;        thatnotfail=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afaacb1c256e44ec7be2adaac65713f2b">IFUTOPRIMNOFAILORFIXED</a>(<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(lpflagfailorig,i-ii,j-jj,k-kk,whichpflag));</div>
<div class="line"><a name="l03171"></a><span class="lineno"> 3171</span>&#160;      }</div>
<div class="line"><a name="l03172"></a><span class="lineno"> 3172</span>&#160;      <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l03173"></a><span class="lineno"> 3173</span>&#160;        thisnotfail=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a26e79fd0bd0fceae505ae32a790c9f1a">IFUTOPRIMRADNOFAILORFIXED</a>(<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(lpflagfailorig,i+ii,j+jj,k+kk,whichpflag));</div>
<div class="line"><a name="l03174"></a><span class="lineno"> 3174</span>&#160;        thatnotfail=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a26e79fd0bd0fceae505ae32a790c9f1a">IFUTOPRIMRADNOFAILORFIXED</a>(<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(lpflagfailorig,i-ii,j-jj,k-kk,whichpflag));</div>
<div class="line"><a name="l03175"></a><span class="lineno"> 3175</span>&#160;      }</div>
<div class="line"><a name="l03176"></a><span class="lineno"> 3176</span>&#160;    }</div>
<div class="line"><a name="l03177"></a><span class="lineno"> 3177</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l03178"></a><span class="lineno"> 3178</span>&#160;      <span class="comment">// here lpflagfailorig can be just NULL since not used</span></div>
<div class="line"><a name="l03179"></a><span class="lineno"> 3179</span>&#160;      thisnotfail=thatnotfail=1; <span class="comment">// just ignores whether failed</span></div>
<div class="line"><a name="l03180"></a><span class="lineno"> 3180</span>&#160;    }</div>
<div class="line"><a name="l03181"></a><span class="lineno"> 3181</span>&#160;</div>
<div class="line"><a name="l03182"></a><span class="lineno"> 3182</span>&#160;</div>
<div class="line"><a name="l03183"></a><span class="lineno"> 3183</span>&#160;</div>
<div class="line"><a name="l03184"></a><span class="lineno"> 3184</span>&#160;</div>
<div class="line"><a name="l03185"></a><span class="lineno"> 3185</span>&#160;    <span class="keywordflow">if</span>(doavgcausal){</div>
<div class="line"><a name="l03186"></a><span class="lineno"> 3186</span>&#160;<span class="preprocessor">#if(1)</span></div>
<div class="line"><a name="l03187"></a><span class="lineno"> 3187</span>&#160;<span class="preprocessor"></span>      <span class="keywordflow">if</span>( ii&lt;0 &amp;&amp; superfast[1]&gt;0 &amp;&amp; thisnotfail ) thatnotfail=0; <span class="comment">// then don&#39;t need this one</span></div>
<div class="line"><a name="l03188"></a><span class="lineno"> 3188</span>&#160;      <span class="keywordflow">if</span>( ii&gt;0 &amp;&amp; superfast[1]&lt;0 &amp;&amp; thatnotfail ) thisnotfail=0; <span class="comment">// then don&#39;t need this one</span></div>
<div class="line"><a name="l03189"></a><span class="lineno"> 3189</span>&#160;      <span class="keywordflow">if</span>( jj&lt;0 &amp;&amp; superfast[2]&gt;0 &amp;&amp; thisnotfail ) thatnotfail=0; <span class="comment">// then don&#39;t need this one</span></div>
<div class="line"><a name="l03190"></a><span class="lineno"> 3190</span>&#160;      <span class="keywordflow">if</span>( jj&gt;0 &amp;&amp; superfast[2]&lt;0 &amp;&amp; thatnotfail ) thisnotfail=0; <span class="comment">// then don&#39;t need this one</span></div>
<div class="line"><a name="l03191"></a><span class="lineno"> 3191</span>&#160;      <span class="keywordflow">if</span>( kk&lt;0 &amp;&amp; superfast[3]&gt;0 &amp;&amp; thisnotfail ) thatnotfail=0; <span class="comment">// then don&#39;t need this one</span></div>
<div class="line"><a name="l03192"></a><span class="lineno"> 3192</span>&#160;      <span class="keywordflow">if</span>( kk&gt;0 &amp;&amp; superfast[3]&lt;0 &amp;&amp; thatnotfail ) thisnotfail=0; <span class="comment">// then don&#39;t need this one</span></div>
<div class="line"><a name="l03193"></a><span class="lineno"> 3193</span>&#160;<span class="preprocessor">#elif(0)</span></div>
<div class="line"><a name="l03194"></a><span class="lineno"> 3194</span>&#160;<span class="preprocessor"></span>      <span class="keywordflow">if</span>(i&lt;<a class="code" href="../../dd/d46/mpidefs_8h.html#ab3efab8b1f2dffc5907e0b0a5aa3988f">totalsize</a>[1]/2 &amp;&amp; ii&lt;0) thatnotfail=0;</div>
<div class="line"><a name="l03195"></a><span class="lineno"> 3195</span>&#160;      <span class="keywordflow">if</span>(i&lt;<a class="code" href="../../dd/d46/mpidefs_8h.html#ab3efab8b1f2dffc5907e0b0a5aa3988f">totalsize</a>[1]/2 &amp;&amp; ii&gt;0) thisnotfail=0;</div>
<div class="line"><a name="l03196"></a><span class="lineno"> 3196</span>&#160;      <span class="keywordflow">if</span>(i&gt;=<a class="code" href="../../dd/d46/mpidefs_8h.html#ab3efab8b1f2dffc5907e0b0a5aa3988f">totalsize</a>[1]/2 &amp;&amp; ii&lt;0) thisnotfail=0;</div>
<div class="line"><a name="l03197"></a><span class="lineno"> 3197</span>&#160;      <span class="keywordflow">if</span>(i&gt;=<a class="code" href="../../dd/d46/mpidefs_8h.html#ab3efab8b1f2dffc5907e0b0a5aa3988f">totalsize</a>[1]/2 &amp;&amp; ii&gt;0) thatnotfail=0;</div>
<div class="line"><a name="l03198"></a><span class="lineno"> 3198</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03199"></a><span class="lineno"> 3199</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l03200"></a><span class="lineno"> 3200</span>&#160;    }</div>
<div class="line"><a name="l03201"></a><span class="lineno"> 3201</span>&#160;</div>
<div class="line"><a name="l03202"></a><span class="lineno"> 3202</span>&#160;<span class="preprocessor">#if(1)</span></div>
<div class="line"><a name="l03203"></a><span class="lineno"> 3203</span>&#160;<span class="preprocessor"></span>    <span class="comment">// bigger than myself and absolute limit</span></div>
<div class="line"><a name="l03204"></a><span class="lineno"> 3204</span>&#160;    <a class="code" href="../../de/d95/fixup_8c.html#a7c32d22e47927c62e7c993461b335acf">PLOOPSTARTEND</a>(pl){</div>
<div class="line"><a name="l03205"></a><span class="lineno"> 3205</span>&#160;      ref[pl]=0.0; <span class="comment">// default</span></div>
<div class="line"><a name="l03206"></a><span class="lineno"> 3206</span>&#160;      <span class="keywordflow">if</span>(pl==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>) ref[pl]=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(1.001*<a class="code" href="../../d8/d5b/defs_8general_8h.html#aaf25d08a41cff499b5e3d448ad7f76f7">RHOMINLIMIT</a>,<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(ptoavg,i,j,k,pl)); <span class="comment">// MHD</span></div>
<div class="line"><a name="l03207"></a><span class="lineno"> 3207</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span>(pl==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>) ref[pl]=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(1.001*<a class="code" href="../../d8/d5b/defs_8general_8h.html#a13f615d7832e3abc6abd54325112daf3">UUMINLIMIT</a>,<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(ptoavg,i,j,k,pl)); <span class="comment">// MHD</span></div>
<div class="line"><a name="l03208"></a><span class="lineno"> 3208</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span>(pl==URAD0) ref[pl]=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(1.001*<a class="code" href="../../d8/d5b/defs_8general_8h.html#a5bd9da451f108352614cbc457524c5b0">ERADLIMIT</a>,<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(ptoavg,i,j,k,URAD0)); <span class="comment">// RAD</span></div>
<div class="line"><a name="l03209"></a><span class="lineno"> 3209</span>&#160;    }</div>
<div class="line"><a name="l03210"></a><span class="lineno"> 3210</span>&#160;<span class="preprocessor">#elif(0)</span></div>
<div class="line"><a name="l03211"></a><span class="lineno"> 3211</span>&#160;<span class="preprocessor"></span>    <span class="comment">// bigger than 0</span></div>
<div class="line"><a name="l03212"></a><span class="lineno"> 3212</span>&#160;    <a class="code" href="../../de/d95/fixup_8c.html#a7c32d22e47927c62e7c993461b335acf">PLOOPSTARTEND</a>(pl) ref[pl]=0.0;</div>
<div class="line"><a name="l03213"></a><span class="lineno"> 3213</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03214"></a><span class="lineno"> 3214</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l03215"></a><span class="lineno"> 3215</span>&#160;    <span class="comment">//     if(failavglooptype==1  || failavglooptype==2){  // only use if positive</span></div>
<div class="line"><a name="l03216"></a><span class="lineno"> 3216</span>&#160;</div>
<div class="line"><a name="l03217"></a><span class="lineno"> 3217</span>&#160;    <span class="comment">// number of quantities one summed</span></div>
<div class="line"><a name="l03218"></a><span class="lineno"> 3218</span>&#160;    numavg0+=thisnotfail+thatnotfail;</div>
<div class="line"><a name="l03219"></a><span class="lineno"> 3219</span>&#160;     </div>
<div class="line"><a name="l03220"></a><span class="lineno"> 3220</span>&#160;    <span class="comment">// do sum or min of these 2 pairs</span></div>
<div class="line"><a name="l03221"></a><span class="lineno"> 3221</span>&#160;    <a class="code" href="../../de/d95/fixup_8c.html#a7c32d22e47927c62e7c993461b335acf">PLOOPSTARTEND</a>(pl){</div>
<div class="line"><a name="l03222"></a><span class="lineno"> 3222</span>&#160;      ftemp1=<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(ptoavg,i+ii,j+jj,k+kk,pl);</div>
<div class="line"><a name="l03223"></a><span class="lineno"> 3223</span>&#160;      ftemp2=<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(ptoavg,i-ii,j-jj,k-kk,pl);</div>
<div class="line"><a name="l03224"></a><span class="lineno"> 3224</span>&#160;</div>
<div class="line"><a name="l03226"></a><span class="lineno"> 3226</span>&#160;      <span class="comment">// AVG type</span></div>
<div class="line"><a name="l03228"></a><span class="lineno"> 3228</span>&#160;<span class="comment"></span>      mysum[qq%2][pl]+=ftemp1*thisnotfail + ftemp2*thatnotfail;</div>
<div class="line"><a name="l03229"></a><span class="lineno"> 3229</span>&#160;</div>
<div class="line"><a name="l03231"></a><span class="lineno"> 3231</span>&#160;      <span class="comment">// MIN type</span></div>
<div class="line"><a name="l03233"></a><span class="lineno"> 3233</span>&#160;<span class="comment"></span><span class="preprocessor">#if(0)</span></div>
<div class="line"><a name="l03234"></a><span class="lineno"> 3234</span>&#160;<span class="preprocessor"></span>      <span class="keywordflow">if</span>(ftemp1&gt;ref[pl] &amp;&amp; thisnotfail){</div>
<div class="line"><a name="l03235"></a><span class="lineno"> 3235</span>&#160;        lastmin[pl]=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(lastmin[pl],ftemp1); <span class="comment">// smallest positive number</span></div>
<div class="line"><a name="l03236"></a><span class="lineno"> 3236</span>&#160;        numavg1[pl]++;</div>
<div class="line"><a name="l03237"></a><span class="lineno"> 3237</span>&#160;      }</div>
<div class="line"><a name="l03238"></a><span class="lineno"> 3238</span>&#160;      </div>
<div class="line"><a name="l03239"></a><span class="lineno"> 3239</span>&#160;      <span class="keywordflow">if</span>(ftemp2&gt;ref[pl] &amp;&amp; thatnotfail){</div>
<div class="line"><a name="l03240"></a><span class="lineno"> 3240</span>&#160;        lastmin[pl]=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(lastmin[pl],ftemp2);</div>
<div class="line"><a name="l03241"></a><span class="lineno"> 3241</span>&#160;        numavg1[pl]++;</div>
<div class="line"><a name="l03242"></a><span class="lineno"> 3242</span>&#160;      }</div>
<div class="line"><a name="l03243"></a><span class="lineno"> 3243</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l03244"></a><span class="lineno"> 3244</span>&#160;<span class="preprocessor"></span>      <span class="comment">//      if(pl==8) dualfprintf(fail_file,&quot;ii=%d jj=%d kk=%d i+ii=%d j+jj=%d k+kk=%d pl=%d testing: %g&gt;%g &amp;&amp; %g&gt;%g : %d %d\n&quot;,ii,jj,kk,i+ii,j+jj,k+kk,pl,ftemp1,ref[pl],ftemp2,ref[pl],thisnotfail,thatnotfail);</span></div>
<div class="line"><a name="l03245"></a><span class="lineno"> 3245</span>&#160;      <span class="keywordflow">if</span>(ftemp1&gt;ref[pl] &amp;&amp; thisnotfail &amp;&amp; ftemp2&gt;ref[pl] &amp;&amp; thatnotfail){</div>
<div class="line"><a name="l03246"></a><span class="lineno"> 3246</span>&#160;        lastmin[pl]=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(lastmin[pl],ftemp1),ftemp2); <span class="comment">// smallest positive number if both of pair are larger than my value (else keep my small value)</span></div>
<div class="line"><a name="l03247"></a><span class="lineno"> 3247</span>&#160;        numavg1[pl]+=2;</div>
<div class="line"><a name="l03248"></a><span class="lineno"> 3248</span>&#160;      }</div>
<div class="line"><a name="l03249"></a><span class="lineno"> 3249</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span>(ftemp1&gt;ref[pl] &amp;&amp; thisnotfail){</div>
<div class="line"><a name="l03250"></a><span class="lineno"> 3250</span>&#160;        lastmin[pl]=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(lastmin[pl],ftemp1); <span class="comment">// smallest positive number if both of pair are larger than my value (else keep my small value)</span></div>
<div class="line"><a name="l03251"></a><span class="lineno"> 3251</span>&#160;        numavg1[pl]++;</div>
<div class="line"><a name="l03252"></a><span class="lineno"> 3252</span>&#160;      }</div>
<div class="line"><a name="l03253"></a><span class="lineno"> 3253</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span>(ftemp2&gt;ref[pl] &amp;&amp; thatnotfail){</div>
<div class="line"><a name="l03254"></a><span class="lineno"> 3254</span>&#160;        lastmin[pl]=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(lastmin[pl],ftemp2); <span class="comment">// smallest positive number if both of pair are larger than my value (else keep my small value)</span></div>
<div class="line"><a name="l03255"></a><span class="lineno"> 3255</span>&#160;        numavg1[pl]++;</div>
<div class="line"><a name="l03256"></a><span class="lineno"> 3256</span>&#160;      }</div>
<div class="line"><a name="l03257"></a><span class="lineno"> 3257</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03258"></a><span class="lineno"> 3258</span>&#160;<span class="preprocessor"></span>    }<span class="comment">// pl loop</span></div>
<div class="line"><a name="l03259"></a><span class="lineno"> 3259</span>&#160;  } <span class="comment">//end loop over pairs</span></div>
<div class="line"><a name="l03260"></a><span class="lineno"> 3260</span>&#160;</div>
<div class="line"><a name="l03261"></a><span class="lineno"> 3261</span>&#160; </div>
<div class="line"><a name="l03262"></a><span class="lineno"> 3262</span>&#160;</div>
<div class="line"><a name="l03263"></a><span class="lineno"> 3263</span>&#160;</div>
<div class="line"><a name="l03264"></a><span class="lineno"> 3264</span>&#160;</div>
<div class="line"><a name="l03266"></a><span class="lineno"> 3266</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l03267"></a><span class="lineno"> 3267</span>&#160;  <span class="comment">// all loops over surrounding points is done, now get average answer</span></div>
<div class="line"><a name="l03268"></a><span class="lineno"> 3268</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l03271"></a><span class="lineno"> 3271</span>&#160;<span class="comment"></span>  <span class="comment">// NORMAL:</span></div>
<div class="line"><a name="l03273"></a><span class="lineno"> 3273</span>&#160;<span class="comment"></span>  <span class="keywordflow">if</span>(numavg0!=0){</div>
<div class="line"><a name="l03274"></a><span class="lineno"> 3274</span>&#160;    <a class="code" href="../../de/d95/fixup_8c.html#a7c32d22e47927c62e7c993461b335acf">PLOOPSTARTEND</a>(pl){</div>
<div class="line"><a name="l03275"></a><span class="lineno"> 3275</span>&#160;      avganswer0[pl]=(mysum[0][pl]+mysum[1][pl])/((<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a>)(numavg0));</div>
<div class="line"><a name="l03276"></a><span class="lineno"> 3276</span>&#160;    }</div>
<div class="line"><a name="l03277"></a><span class="lineno"> 3277</span>&#160;  }</div>
<div class="line"><a name="l03278"></a><span class="lineno"> 3278</span>&#160;  <a class="code" href="../../de/d95/fixup_8c.html#a7c32d22e47927c62e7c993461b335acf">PLOOPSTARTEND</a>(pl){</div>
<div class="line"><a name="l03279"></a><span class="lineno"> 3279</span>&#160;    avganswer1[pl]=lastmin[pl];</div>
<div class="line"><a name="l03280"></a><span class="lineno"> 3280</span>&#160;  }</div>
<div class="line"><a name="l03281"></a><span class="lineno"> 3281</span>&#160;  </div>
<div class="line"><a name="l03282"></a><span class="lineno"> 3282</span>&#160;   </div>
<div class="line"><a name="l03283"></a><span class="lineno"> 3283</span>&#160;</div>
<div class="line"><a name="l03285"></a><span class="lineno"> 3285</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l03286"></a><span class="lineno"> 3286</span>&#160;  <span class="comment">// choose final answer (avg or min)</span></div>
<div class="line"><a name="l03287"></a><span class="lineno"> 3287</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l03289"></a><span class="lineno"> 3289</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03290"></a><span class="lineno"> 3290</span>&#160;  <span class="keywordtype">int</span> doingavgtype[NPR];</div>
<div class="line"><a name="l03291"></a><span class="lineno"> 3291</span>&#160;  <a class="code" href="../../de/d95/fixup_8c.html#a7c32d22e47927c62e7c993461b335acf">PLOOPSTARTEND</a>(pl){</div>
<div class="line"><a name="l03292"></a><span class="lineno"> 3292</span>&#160;    doingavgtype[pl]=-1; <span class="comment">// default avoidance of pl</span></div>
<div class="line"><a name="l03293"></a><span class="lineno"> 3293</span>&#160;</div>
<div class="line"><a name="l03294"></a><span class="lineno"> 3294</span>&#160;    <span class="comment">// default</span></div>
<div class="line"><a name="l03295"></a><span class="lineno"> 3295</span>&#160;    <span class="keywordflow">if</span>(failavglooptype==0 || ((failavglooptype==2)&amp;&amp;(numavg1[pl]==0)) ){</div>
<div class="line"><a name="l03296"></a><span class="lineno"> 3296</span>&#160;      doingavgtype[pl]=1;</div>
<div class="line"><a name="l03297"></a><span class="lineno"> 3297</span>&#160;    }</div>
<div class="line"><a name="l03298"></a><span class="lineno"> 3298</span>&#160;    <span class="keywordflow">if</span>(failavglooptype==1 || ((failavglooptype==2)&amp;&amp;(numavg0==0)) ){  </div>
<div class="line"><a name="l03299"></a><span class="lineno"> 3299</span>&#160;      doingavgtype[pl]=0;</div>
<div class="line"><a name="l03300"></a><span class="lineno"> 3300</span>&#160;    }</div>
<div class="line"><a name="l03301"></a><span class="lineno"> 3301</span>&#160;</div>
<div class="line"><a name="l03302"></a><span class="lineno"> 3302</span>&#160;</div>
<div class="line"><a name="l03303"></a><span class="lineno"> 3303</span>&#160;    <span class="comment">// override</span></div>
<div class="line"><a name="l03304"></a><span class="lineno"> 3304</span>&#160;    <span class="keywordflow">if</span>(doingmhd==0 &amp;&amp; radlpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a38b0585ec02d900ad0413645acb00918">UTOPRIMRADFAILERFNEG</a> &amp;&amp; pl==URAD0 || doingmhd==1 &amp;&amp; lpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ad5bd994b947d2a46102582b38e4b1529">UTOPRIMFAILRHONEG</a> &amp;&amp; pl==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a> || doingmhd==1 &amp;&amp; lpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a17c167aa50c0750a25baba351db69740">UTOPRIMFAILUNEG</a> &amp;&amp; pl==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a> || doingmhd==1 &amp;&amp; lpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a24290f84c3e2b725f7cbbdff81da4760">UTOPRIMFAILRHOUNEG</a> &amp;&amp; (pl==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a> || pl==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>)){</div>
<div class="line"><a name="l03305"></a><span class="lineno"> 3305</span>&#160;      doingavgtype[pl]=0; <span class="comment">// min type</span></div>
<div class="line"><a name="l03306"></a><span class="lineno"> 3306</span>&#160;    }</div>
<div class="line"><a name="l03307"></a><span class="lineno"> 3307</span>&#160;    <span class="keywordflow">else</span> doingavgtype[pl]=1; <span class="comment">// avg type</span></div>
<div class="line"><a name="l03308"></a><span class="lineno"> 3308</span>&#160;  }</div>
<div class="line"><a name="l03309"></a><span class="lineno"> 3309</span>&#160;</div>
<div class="line"><a name="l03310"></a><span class="lineno"> 3310</span>&#160;</div>
<div class="line"><a name="l03311"></a><span class="lineno"> 3311</span>&#160;</div>
<div class="line"><a name="l03312"></a><span class="lineno"> 3312</span>&#160;  <span class="keywordtype">int</span> numavgfinal=256; <span class="comment">// just large number (at least (2*NxBND)**3</span></div>
<div class="line"><a name="l03313"></a><span class="lineno"> 3313</span>&#160;  <a class="code" href="../../de/d95/fixup_8c.html#a7c32d22e47927c62e7c993461b335acf">PLOOPSTARTEND</a>(pl){<span class="comment">// should only be over specific density(s)</span></div>
<div class="line"><a name="l03314"></a><span class="lineno"> 3314</span>&#160;    <span class="comment">// choose min</span></div>
<div class="line"><a name="l03315"></a><span class="lineno"> 3315</span>&#160;    <span class="keywordflow">if</span>(numavg1[pl]!=0 &amp;&amp; doingavgtype[pl]==0){</div>
<div class="line"><a name="l03316"></a><span class="lineno"> 3316</span>&#160;      <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,pl)=avganswer1[pl]; <span class="comment">// else keep same as original answer</span></div>
<div class="line"><a name="l03317"></a><span class="lineno"> 3317</span>&#160;      <span class="comment">//        dualfprintf(fail_file,&quot;HERE: pl=%d %21.15g %d\n&quot;,pl,MACP0A1(pv,i,j,k,pl),numavg1[pl]);</span></div>
<div class="line"><a name="l03318"></a><span class="lineno"> 3318</span>&#160;      numavg[pl]=numavg1[pl];</div>
<div class="line"><a name="l03319"></a><span class="lineno"> 3319</span>&#160;    }</div>
<div class="line"><a name="l03320"></a><span class="lineno"> 3320</span>&#160;    <span class="comment">// choose avg</span></div>
<div class="line"><a name="l03321"></a><span class="lineno"> 3321</span>&#160;    <span class="keywordflow">if</span>(numavg0!=0 &amp;&amp; doingavgtype[pl]==1){</div>
<div class="line"><a name="l03322"></a><span class="lineno"> 3322</span>&#160;      <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,pl)=avganswer0[pl];</div>
<div class="line"><a name="l03323"></a><span class="lineno"> 3323</span>&#160;      numavg[pl]=numavg0;</div>
<div class="line"><a name="l03324"></a><span class="lineno"> 3324</span>&#160;    }</div>
<div class="line"><a name="l03325"></a><span class="lineno"> 3325</span>&#160;    numavgfinal=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(numavg[pl],numavgfinal); <span class="comment">// get minimum number of good points over those wanted &quot;average&quot;.  If one was bad, have to do nogood version</span></div>
<div class="line"><a name="l03326"></a><span class="lineno"> 3326</span>&#160;  }<span class="comment">// end pl loop</span></div>
<div class="line"><a name="l03327"></a><span class="lineno"> 3327</span>&#160;</div>
<div class="line"><a name="l03328"></a><span class="lineno"> 3328</span>&#160;  </div>
<div class="line"><a name="l03329"></a><span class="lineno"> 3329</span>&#160;</div>
<div class="line"><a name="l03330"></a><span class="lineno"> 3330</span>&#160;  <span class="keywordflow">if</span>( lpflag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a042dcc3162731841db25689b5f94c2ac">UTOPRIMFAILU2AVG2</a>){ <span class="comment">// lpflag here is either for MHD or RAD depending upon doingmhd=1 or 0</span></div>
<div class="line"><a name="l03331"></a><span class="lineno"> 3331</span>&#160;    <span class="keywordflow">if</span>(numbndtotry==maxnumbndtotry) numavgfinal++; <span class="comment">// assume at least always one good one so don&#39;t treat as real failure if no good values surrounding.  But only do so if last chance for no good average.</span></div>
<div class="line"><a name="l03332"></a><span class="lineno"> 3332</span>&#160;  }</div>
<div class="line"><a name="l03333"></a><span class="lineno"> 3333</span>&#160;  <span class="comment">// else use real numavgfinal</span></div>
<div class="line"><a name="l03334"></a><span class="lineno"> 3334</span>&#160;   </div>
<div class="line"><a name="l03335"></a><span class="lineno"> 3335</span>&#160;   </div>
<div class="line"><a name="l03336"></a><span class="lineno"> 3336</span>&#160;  <span class="keywordflow">if</span>(numavgfinal==0){</div>
<div class="line"><a name="l03337"></a><span class="lineno"> 3337</span>&#160;    <span class="keywordflow">return</span>(1);</div>
<div class="line"><a name="l03338"></a><span class="lineno"> 3338</span>&#160;  }</div>
<div class="line"><a name="l03339"></a><span class="lineno"> 3339</span>&#160;   </div>
<div class="line"><a name="l03340"></a><span class="lineno"> 3340</span>&#160;  <span class="comment">// good value exist</span></div>
<div class="line"><a name="l03341"></a><span class="lineno"> 3341</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l03342"></a><span class="lineno"> 3342</span>&#160;}</div>
<div class="line"><a name="l03343"></a><span class="lineno"> 3343</span>&#160;</div>
<div class="line"><a name="l03344"></a><span class="lineno"> 3344</span>&#160;</div>
<div class="line"><a name="l03345"></a><span class="lineno"> 3345</span>&#160;</div>
<div class="line"><a name="l03346"></a><span class="lineno"> 3346</span>&#160;</div>
<div class="line"><a name="l03348"></a><span class="lineno"><a class="code" href="../../de/d95/fixup_8c.html#a2f58e3b2c769ab1ac0fd7670a9014695"> 3348</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../de/d95/fixup_8c.html#a2f58e3b2c769ab1ac0fd7670a9014695" title="simple average of good surrounding zones">simple_average</a>(<span class="keywordtype">int</span> startpl, <span class="keywordtype">int</span> endpl, <span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k,<span class="keywordtype">int</span> doingmhd, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> (*lpflagfailorig)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NUMFAILPFLAGS],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pv)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*ptoavg)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR])</div>
<div class="line"><a name="l03349"></a><span class="lineno"> 3349</span>&#160;{</div>
<div class="line"><a name="l03350"></a><span class="lineno"> 3350</span>&#160;  <span class="keywordtype">int</span> pl,pliter;</div>
<div class="line"><a name="l03351"></a><span class="lineno"> 3351</span>&#160;  <span class="keywordtype">int</span> whichpflag;</div>
<div class="line"><a name="l03352"></a><span class="lineno"> 3352</span>&#160;</div>
<div class="line"><a name="l03353"></a><span class="lineno"> 3353</span>&#160;  <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a7df8286c59d491ba1117884d33499a7a">prod0dualfprintf</a>(debugfail&gt;=2,fail_file,<span class="stringliteral">&quot;uc2simple: i=%d j=%d k=%d\n&quot;</span>,i,j,k); <span class="comment">// not too much</span></div>
<div class="line"><a name="l03354"></a><span class="lineno"> 3354</span>&#160;</div>
<div class="line"><a name="l03355"></a><span class="lineno"> 3355</span>&#160;</div>
<div class="line"><a name="l03356"></a><span class="lineno"> 3356</span>&#160;</div>
<div class="line"><a name="l03357"></a><span class="lineno"> 3357</span>&#160;  <span class="keywordflow">if</span>(doingmhd==1){ <span class="comment">// if MHD</span></div>
<div class="line"><a name="l03358"></a><span class="lineno"> 3358</span>&#160;    whichpflag=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>;</div>
<div class="line"><a name="l03359"></a><span class="lineno"> 3359</span>&#160;  }</div>
<div class="line"><a name="l03360"></a><span class="lineno"> 3360</span>&#160;  <span class="keywordflow">else</span>{ <span class="comment">// if RAD</span></div>
<div class="line"><a name="l03361"></a><span class="lineno"> 3361</span>&#160;    whichpflag=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a393b558a72d89962204c8cb8b214f9ce">FLAGUTOPRIMRADFAIL</a>;</div>
<div class="line"><a name="l03362"></a><span class="lineno"> 3362</span>&#160;  }</div>
<div class="line"><a name="l03363"></a><span class="lineno"> 3363</span>&#160;</div>
<div class="line"><a name="l03364"></a><span class="lineno"> 3364</span>&#160;</div>
<div class="line"><a name="l03366"></a><span class="lineno"> 3366</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l03367"></a><span class="lineno"> 3367</span>&#160;  <span class="comment">// 4 VALUES</span></div>
<div class="line"><a name="l03368"></a><span class="lineno"> 3368</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l03370"></a><span class="lineno"> 3370</span>&#160;<span class="comment"></span>  <span class="keywordflow">if</span>( <span class="comment">// but if surrounded by good values</span></div>
<div class="line"><a name="l03371"></a><span class="lineno"> 3371</span>&#160;     (<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afaacb1c256e44ec7be2adaac65713f2b">IFUTOPRIMNOFAILORFIXED</a>(<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(lpflagfailorig,i,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a3e64aa2cd3c5e0933e74fa4e7a925570">jp1mac</a>(j),k,whichpflag)))&amp;&amp;</div>
<div class="line"><a name="l03372"></a><span class="lineno"> 3372</span>&#160;     (<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afaacb1c256e44ec7be2adaac65713f2b">IFUTOPRIMNOFAILORFIXED</a>(<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(lpflagfailorig,i,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),k,whichpflag)))&amp;&amp;</div>
<div class="line"><a name="l03373"></a><span class="lineno"> 3373</span>&#160;     (<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afaacb1c256e44ec7be2adaac65713f2b">IFUTOPRIMNOFAILORFIXED</a>(<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(lpflagfailorig,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a27e1e0a92af691ffd03d7e9d0a628392">ip1mac</a>(i),j,k,whichpflag)))&amp;&amp;  </div>
<div class="line"><a name="l03374"></a><span class="lineno"> 3374</span>&#160;     (<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afaacb1c256e44ec7be2adaac65713f2b">IFUTOPRIMNOFAILORFIXED</a>(<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(lpflagfailorig,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),j,k,whichpflag)))    </div>
<div class="line"><a name="l03375"></a><span class="lineno"> 3375</span>&#160;      ){</div>
<div class="line"><a name="l03376"></a><span class="lineno"> 3376</span>&#160;    <span class="keywordflow">if</span>(debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;t=%21.15g : i=%d j=%d k=%d : utoprim corrected1\n&quot;</span>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#ae1ee1e1c83c3f70e2e1afed4f4f5b41e">t</a>,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[1]+i,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[2]+j,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[3]+k);</div>
<div class="line"><a name="l03377"></a><span class="lineno"> 3377</span>&#160;    <span class="comment">// then average</span></div>
<div class="line"><a name="l03378"></a><span class="lineno"> 3378</span>&#160;    <span class="comment">// don&#39;t mess with B field, it&#39;s correct already</span></div>
<div class="line"><a name="l03379"></a><span class="lineno"> 3379</span>&#160;    <a class="code" href="../../de/d95/fixup_8c.html#a7c32d22e47927c62e7c993461b335acf">PLOOPSTARTEND</a>(pl){</div>
<div class="line"><a name="l03380"></a><span class="lineno"> 3380</span>&#160;      <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,pl)=<a class="code" href="../../de/d95/fixup_8c.html#afffb4925f444309c751a6aa55468d412">AVG4_1</a>(ptoavg,i,j,k,pl);  </div>
<div class="line"><a name="l03381"></a><span class="lineno"> 3381</span>&#160;      <span class="keywordflow">if</span>(debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;uc2: pl=%d pv=%21.15g\n&quot;</span>,pl,<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,pl));</div>
<div class="line"><a name="l03382"></a><span class="lineno"> 3382</span>&#160;    }</div>
<div class="line"><a name="l03383"></a><span class="lineno"> 3383</span>&#160;  }</div>
<div class="line"><a name="l03384"></a><span class="lineno"> 3384</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>( <span class="comment">// but if surrounded by good values</span></div>
<div class="line"><a name="l03385"></a><span class="lineno"> 3385</span>&#160;          (<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afaacb1c256e44ec7be2adaac65713f2b">IFUTOPRIMNOFAILORFIXED</a>(<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(lpflagfailorig,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a27e1e0a92af691ffd03d7e9d0a628392">ip1mac</a>(i),<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a3e64aa2cd3c5e0933e74fa4e7a925570">jp1mac</a>(j),k,whichpflag)))&amp;&amp;</div>
<div class="line"><a name="l03386"></a><span class="lineno"> 3386</span>&#160;          (<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afaacb1c256e44ec7be2adaac65713f2b">IFUTOPRIMNOFAILORFIXED</a>(<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(lpflagfailorig,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a27e1e0a92af691ffd03d7e9d0a628392">ip1mac</a>(i),<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),k,whichpflag)))&amp;&amp;</div>
<div class="line"><a name="l03387"></a><span class="lineno"> 3387</span>&#160;          (<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afaacb1c256e44ec7be2adaac65713f2b">IFUTOPRIMNOFAILORFIXED</a>(<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(lpflagfailorig,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a3e64aa2cd3c5e0933e74fa4e7a925570">jp1mac</a>(j),k,whichpflag)))&amp;&amp;</div>
<div class="line"><a name="l03388"></a><span class="lineno"> 3388</span>&#160;          (<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afaacb1c256e44ec7be2adaac65713f2b">IFUTOPRIMNOFAILORFIXED</a>(<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(lpflagfailorig,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),k,whichpflag)))</div>
<div class="line"><a name="l03389"></a><span class="lineno"> 3389</span>&#160;           ){</div>
<div class="line"><a name="l03390"></a><span class="lineno"> 3390</span>&#160;    <span class="keywordflow">if</span>(debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;t=%21.15g : i=%d j=%d k=%d : utoprim corrected2\n&quot;</span>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#ae1ee1e1c83c3f70e2e1afed4f4f5b41e">t</a>,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[1]+i,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[2]+j,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[3]+k);</div>
<div class="line"><a name="l03391"></a><span class="lineno"> 3391</span>&#160;    <span class="comment">// then average</span></div>
<div class="line"><a name="l03392"></a><span class="lineno"> 3392</span>&#160;    <a class="code" href="../../de/d95/fixup_8c.html#a7c32d22e47927c62e7c993461b335acf">PLOOPSTARTEND</a>(pl){</div>
<div class="line"><a name="l03393"></a><span class="lineno"> 3393</span>&#160;      <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,pl)=<a class="code" href="../../de/d95/fixup_8c.html#a8988b8749add2fcc20cb7ee1706bf6b4">AVG4_2</a>(ptoavg,i,j,k,pl);</div>
<div class="line"><a name="l03394"></a><span class="lineno"> 3394</span>&#160;      <span class="keywordflow">if</span>(debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;uc2: pl=%d pv=%21.15g\n&quot;</span>,pl,<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,pl));</div>
<div class="line"><a name="l03395"></a><span class="lineno"> 3395</span>&#160;    }</div>
<div class="line"><a name="l03396"></a><span class="lineno"> 3396</span>&#160;  }</div>
<div class="line"><a name="l03398"></a><span class="lineno"> 3398</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l03399"></a><span class="lineno"> 3399</span>&#160;  <span class="comment">// 2 VALUES</span></div>
<div class="line"><a name="l03400"></a><span class="lineno"> 3400</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l03402"></a><span class="lineno"> 3402</span>&#160;<span class="comment"></span>  <span class="keywordflow">else</span> <span class="keywordflow">if</span>( <span class="comment">// but if &quot;surrounded&quot; by good values</span></div>
<div class="line"><a name="l03403"></a><span class="lineno"> 3403</span>&#160;          (<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afaacb1c256e44ec7be2adaac65713f2b">IFUTOPRIMNOFAILORFIXED</a>(<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(lpflagfailorig,i,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a3e64aa2cd3c5e0933e74fa4e7a925570">jp1mac</a>(j),k,whichpflag)))&amp;&amp;</div>
<div class="line"><a name="l03404"></a><span class="lineno"> 3404</span>&#160;          (<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afaacb1c256e44ec7be2adaac65713f2b">IFUTOPRIMNOFAILORFIXED</a>(<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(lpflagfailorig,i,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),k,whichpflag)))</div>
<div class="line"><a name="l03405"></a><span class="lineno"> 3405</span>&#160;           ){</div>
<div class="line"><a name="l03406"></a><span class="lineno"> 3406</span>&#160;    <span class="keywordflow">if</span>(debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;t=%21.15g : i=%d j=%d k=%d : utoprim corrected3\n&quot;</span>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#ae1ee1e1c83c3f70e2e1afed4f4f5b41e">t</a>,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[1]+i,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[2]+j,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[3]+k);</div>
<div class="line"><a name="l03407"></a><span class="lineno"> 3407</span>&#160;    <span class="comment">// then average</span></div>
<div class="line"><a name="l03408"></a><span class="lineno"> 3408</span>&#160;    <a class="code" href="../../de/d95/fixup_8c.html#a7c32d22e47927c62e7c993461b335acf">PLOOPSTARTEND</a>(pl){</div>
<div class="line"><a name="l03409"></a><span class="lineno"> 3409</span>&#160;      <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,pl)=<a class="code" href="../../de/d95/fixup_8c.html#ad0615cca7029b15274e21979b2528a45">AVG2_1</a>(ptoavg,i,j,k,pl);</div>
<div class="line"><a name="l03410"></a><span class="lineno"> 3410</span>&#160;      <span class="keywordflow">if</span>(debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;uc2: pl=%d pv=%21.15g\n&quot;</span>,pl,<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,pl));</div>
<div class="line"><a name="l03411"></a><span class="lineno"> 3411</span>&#160;    }</div>
<div class="line"><a name="l03412"></a><span class="lineno"> 3412</span>&#160;  }</div>
<div class="line"><a name="l03413"></a><span class="lineno"> 3413</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>( <span class="comment">// but if &quot;surrounded&quot; by good values</span></div>
<div class="line"><a name="l03414"></a><span class="lineno"> 3414</span>&#160;          (<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afaacb1c256e44ec7be2adaac65713f2b">IFUTOPRIMNOFAILORFIXED</a>(<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(lpflagfailorig,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a27e1e0a92af691ffd03d7e9d0a628392">ip1mac</a>(i),j,k,whichpflag)))&amp;&amp;</div>
<div class="line"><a name="l03415"></a><span class="lineno"> 3415</span>&#160;          (<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afaacb1c256e44ec7be2adaac65713f2b">IFUTOPRIMNOFAILORFIXED</a>(<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(lpflagfailorig,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),j,k,whichpflag)))</div>
<div class="line"><a name="l03416"></a><span class="lineno"> 3416</span>&#160;           ){</div>
<div class="line"><a name="l03417"></a><span class="lineno"> 3417</span>&#160;    <span class="keywordflow">if</span>(debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;t=%21.15g : i=%d j=%d k=%d : utoprim corrected4\n&quot;</span>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#ae1ee1e1c83c3f70e2e1afed4f4f5b41e">t</a>,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[1]+i,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[2]+j,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[3]+k);</div>
<div class="line"><a name="l03418"></a><span class="lineno"> 3418</span>&#160;    <span class="comment">// then average</span></div>
<div class="line"><a name="l03419"></a><span class="lineno"> 3419</span>&#160;    <a class="code" href="../../de/d95/fixup_8c.html#a7c32d22e47927c62e7c993461b335acf">PLOOPSTARTEND</a>(pl){</div>
<div class="line"><a name="l03420"></a><span class="lineno"> 3420</span>&#160;      <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,pl)=<a class="code" href="../../de/d95/fixup_8c.html#aaf583eed3447eb70e3460cce4e756621">AVG2_2</a>(ptoavg,i,j,k,pl);</div>
<div class="line"><a name="l03421"></a><span class="lineno"> 3421</span>&#160;      <span class="keywordflow">if</span>(debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;uc2: pl=%d pv=%21.15g\n&quot;</span>,pl,<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,pl));</div>
<div class="line"><a name="l03422"></a><span class="lineno"> 3422</span>&#160;    }</div>
<div class="line"><a name="l03423"></a><span class="lineno"> 3423</span>&#160;  }</div>
<div class="line"><a name="l03424"></a><span class="lineno"> 3424</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>( <span class="comment">// but if &quot;surrounded&quot; by good values</span></div>
<div class="line"><a name="l03425"></a><span class="lineno"> 3425</span>&#160;          (<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afaacb1c256e44ec7be2adaac65713f2b">IFUTOPRIMNOFAILORFIXED</a>(<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(lpflagfailorig,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a27e1e0a92af691ffd03d7e9d0a628392">ip1mac</a>(i),<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a3e64aa2cd3c5e0933e74fa4e7a925570">jp1mac</a>(j),k,whichpflag)))&amp;&amp;</div>
<div class="line"><a name="l03426"></a><span class="lineno"> 3426</span>&#160;          (<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afaacb1c256e44ec7be2adaac65713f2b">IFUTOPRIMNOFAILORFIXED</a>(<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(lpflagfailorig,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),k,whichpflag)))</div>
<div class="line"><a name="l03427"></a><span class="lineno"> 3427</span>&#160;           ){</div>
<div class="line"><a name="l03428"></a><span class="lineno"> 3428</span>&#160;    <span class="keywordflow">if</span>(debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;t=%21.15g : i=%d j=%d k=%d : utoprim corrected5\n&quot;</span>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#ae1ee1e1c83c3f70e2e1afed4f4f5b41e">t</a>,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[1]+i,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[2]+j,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[3]+k);</div>
<div class="line"><a name="l03429"></a><span class="lineno"> 3429</span>&#160;    <span class="comment">// then average</span></div>
<div class="line"><a name="l03430"></a><span class="lineno"> 3430</span>&#160;    <a class="code" href="../../de/d95/fixup_8c.html#a7c32d22e47927c62e7c993461b335acf">PLOOPSTARTEND</a>(pl){</div>
<div class="line"><a name="l03431"></a><span class="lineno"> 3431</span>&#160;      <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,pl)=<a class="code" href="../../de/d95/fixup_8c.html#ae02075847c8bcb609daeeb21fbe25b2a">AVG2_3</a>(ptoavg,i,j,k,pl);</div>
<div class="line"><a name="l03432"></a><span class="lineno"> 3432</span>&#160;      <span class="keywordflow">if</span>(debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;uc2: pl=%d pv=%21.15g\n&quot;</span>,pl,<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,pl));</div>
<div class="line"><a name="l03433"></a><span class="lineno"> 3433</span>&#160;    }</div>
<div class="line"><a name="l03434"></a><span class="lineno"> 3434</span>&#160;  }</div>
<div class="line"><a name="l03435"></a><span class="lineno"> 3435</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>( <span class="comment">// but if &quot;surrounded&quot; by good values</span></div>
<div class="line"><a name="l03436"></a><span class="lineno"> 3436</span>&#160;          (<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afaacb1c256e44ec7be2adaac65713f2b">IFUTOPRIMNOFAILORFIXED</a>(<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(lpflagfailorig,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a27e1e0a92af691ffd03d7e9d0a628392">ip1mac</a>(i),<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),k,whichpflag)))&amp;&amp;</div>
<div class="line"><a name="l03437"></a><span class="lineno"> 3437</span>&#160;          (<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afaacb1c256e44ec7be2adaac65713f2b">IFUTOPRIMNOFAILORFIXED</a>(<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(lpflagfailorig,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a3e64aa2cd3c5e0933e74fa4e7a925570">jp1mac</a>(j),k,whichpflag)))</div>
<div class="line"><a name="l03438"></a><span class="lineno"> 3438</span>&#160;           ){</div>
<div class="line"><a name="l03439"></a><span class="lineno"> 3439</span>&#160;    <span class="keywordflow">if</span>(debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;t=%21.15g : i=%d j=%d k=%d : utoprim corrected6\n&quot;</span>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#ae1ee1e1c83c3f70e2e1afed4f4f5b41e">t</a>,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[1]+i,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[2]+j,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[3]+k);</div>
<div class="line"><a name="l03440"></a><span class="lineno"> 3440</span>&#160;    <span class="comment">// then average</span></div>
<div class="line"><a name="l03441"></a><span class="lineno"> 3441</span>&#160;    <a class="code" href="../../de/d95/fixup_8c.html#a7c32d22e47927c62e7c993461b335acf">PLOOPSTARTEND</a>(pl){</div>
<div class="line"><a name="l03442"></a><span class="lineno"> 3442</span>&#160;      <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,pl)=<a class="code" href="../../de/d95/fixup_8c.html#a1402725322506948abac361681b1cbb5">AVG2_4</a>(ptoavg,i,j,k,pl);</div>
<div class="line"><a name="l03443"></a><span class="lineno"> 3443</span>&#160;      <span class="keywordflow">if</span>(debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;uc2: pl=%d pv=%21.15g\n&quot;</span>,pl,<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,pl));</div>
<div class="line"><a name="l03444"></a><span class="lineno"> 3444</span>&#160;    }</div>
<div class="line"><a name="l03445"></a><span class="lineno"> 3445</span>&#160;  }</div>
<div class="line"><a name="l03447"></a><span class="lineno"> 3447</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l03448"></a><span class="lineno"> 3448</span>&#160;  <span class="comment">// SINGLE VALUES</span></div>
<div class="line"><a name="l03449"></a><span class="lineno"> 3449</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l03451"></a><span class="lineno"> 3451</span>&#160;<span class="comment"></span>  <span class="keywordflow">else</span> <span class="keywordflow">if</span>( <span class="comment">// but if &quot;surrounded&quot; by good value</span></div>
<div class="line"><a name="l03452"></a><span class="lineno"> 3452</span>&#160;          (<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afaacb1c256e44ec7be2adaac65713f2b">IFUTOPRIMNOFAILORFIXED</a>(<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(lpflagfailorig,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a27e1e0a92af691ffd03d7e9d0a628392">ip1mac</a>(i),<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a3e64aa2cd3c5e0933e74fa4e7a925570">jp1mac</a>(j),k,whichpflag)))</div>
<div class="line"><a name="l03453"></a><span class="lineno"> 3453</span>&#160;           ){</div>
<div class="line"><a name="l03454"></a><span class="lineno"> 3454</span>&#160;    <span class="keywordflow">if</span>(debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;t=%21.15g : i=%d j=%d k=%d : utoprim corrected7\n&quot;</span>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#ae1ee1e1c83c3f70e2e1afed4f4f5b41e">t</a>,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[1]+i,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[2]+j,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[3]+k);</div>
<div class="line"><a name="l03455"></a><span class="lineno"> 3455</span>&#160;    <span class="comment">// then ASSIGN</span></div>
<div class="line"><a name="l03456"></a><span class="lineno"> 3456</span>&#160;    <a class="code" href="../../de/d95/fixup_8c.html#a7c32d22e47927c62e7c993461b335acf">PLOOPSTARTEND</a>(pl){</div>
<div class="line"><a name="l03457"></a><span class="lineno"> 3457</span>&#160;      <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,pl)=<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(ptoavg,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a27e1e0a92af691ffd03d7e9d0a628392">ip1mac</a>(i),<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a3e64aa2cd3c5e0933e74fa4e7a925570">jp1mac</a>(j),k,pl);</div>
<div class="line"><a name="l03458"></a><span class="lineno"> 3458</span>&#160;      <span class="keywordflow">if</span>(debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;uc2: pl=%d pv=%21.15g\n&quot;</span>,pl,<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,pl));</div>
<div class="line"><a name="l03459"></a><span class="lineno"> 3459</span>&#160;    }</div>
<div class="line"><a name="l03460"></a><span class="lineno"> 3460</span>&#160;  }</div>
<div class="line"><a name="l03461"></a><span class="lineno"> 3461</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>( <span class="comment">// but if &quot;surrounded&quot; by good value</span></div>
<div class="line"><a name="l03462"></a><span class="lineno"> 3462</span>&#160;          (<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afaacb1c256e44ec7be2adaac65713f2b">IFUTOPRIMNOFAILORFIXED</a>(<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(lpflagfailorig,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a27e1e0a92af691ffd03d7e9d0a628392">ip1mac</a>(i),j,k,whichpflag)))</div>
<div class="line"><a name="l03463"></a><span class="lineno"> 3463</span>&#160;           ){</div>
<div class="line"><a name="l03464"></a><span class="lineno"> 3464</span>&#160;    <span class="keywordflow">if</span>(debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;t=%21.15g : i=%d j=%d k=%d : utoprim corrected7\n&quot;</span>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#ae1ee1e1c83c3f70e2e1afed4f4f5b41e">t</a>,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[1]+i,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[2]+j,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[3]+k);</div>
<div class="line"><a name="l03465"></a><span class="lineno"> 3465</span>&#160;    <span class="comment">// then ASSIGN</span></div>
<div class="line"><a name="l03466"></a><span class="lineno"> 3466</span>&#160;    <a class="code" href="../../de/d95/fixup_8c.html#a7c32d22e47927c62e7c993461b335acf">PLOOPSTARTEND</a>(pl){</div>
<div class="line"><a name="l03467"></a><span class="lineno"> 3467</span>&#160;      <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,pl)=<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(ptoavg,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a27e1e0a92af691ffd03d7e9d0a628392">ip1mac</a>(i),j,k,pl);</div>
<div class="line"><a name="l03468"></a><span class="lineno"> 3468</span>&#160;      <span class="keywordflow">if</span>(debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;uc2: pl=%d pv=%21.15g\n&quot;</span>,pl,<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,pl));</div>
<div class="line"><a name="l03469"></a><span class="lineno"> 3469</span>&#160;    }</div>
<div class="line"><a name="l03470"></a><span class="lineno"> 3470</span>&#160;  }</div>
<div class="line"><a name="l03471"></a><span class="lineno"> 3471</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>( <span class="comment">// but if &quot;surrounded&quot; by good value</span></div>
<div class="line"><a name="l03472"></a><span class="lineno"> 3472</span>&#160;          (<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afaacb1c256e44ec7be2adaac65713f2b">IFUTOPRIMNOFAILORFIXED</a>(<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(lpflagfailorig,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a27e1e0a92af691ffd03d7e9d0a628392">ip1mac</a>(i),<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),k,whichpflag)))</div>
<div class="line"><a name="l03473"></a><span class="lineno"> 3473</span>&#160;           ){</div>
<div class="line"><a name="l03474"></a><span class="lineno"> 3474</span>&#160;    <span class="keywordflow">if</span>(debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;t=%21.15g : i=%d j=%d k=%d : utoprim corrected7\n&quot;</span>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#ae1ee1e1c83c3f70e2e1afed4f4f5b41e">t</a>,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[1]+i,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[2]+j,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[3]+k);</div>
<div class="line"><a name="l03475"></a><span class="lineno"> 3475</span>&#160;    <span class="comment">// then ASSIGN</span></div>
<div class="line"><a name="l03476"></a><span class="lineno"> 3476</span>&#160;    <a class="code" href="../../de/d95/fixup_8c.html#a7c32d22e47927c62e7c993461b335acf">PLOOPSTARTEND</a>(pl){</div>
<div class="line"><a name="l03477"></a><span class="lineno"> 3477</span>&#160;      <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,pl)=<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(ptoavg,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a27e1e0a92af691ffd03d7e9d0a628392">ip1mac</a>(i),<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),k,pl);</div>
<div class="line"><a name="l03478"></a><span class="lineno"> 3478</span>&#160;      <span class="keywordflow">if</span>(debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;uc2: pl=%d pv=%21.15g\n&quot;</span>,pl,<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,pl));</div>
<div class="line"><a name="l03479"></a><span class="lineno"> 3479</span>&#160;    }</div>
<div class="line"><a name="l03480"></a><span class="lineno"> 3480</span>&#160;  }</div>
<div class="line"><a name="l03481"></a><span class="lineno"> 3481</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>( <span class="comment">// but if &quot;surrounded&quot; by good value</span></div>
<div class="line"><a name="l03482"></a><span class="lineno"> 3482</span>&#160;          (<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afaacb1c256e44ec7be2adaac65713f2b">IFUTOPRIMNOFAILORFIXED</a>(<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(lpflagfailorig,i,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),k,whichpflag)))</div>
<div class="line"><a name="l03483"></a><span class="lineno"> 3483</span>&#160;           ){</div>
<div class="line"><a name="l03484"></a><span class="lineno"> 3484</span>&#160;    <span class="keywordflow">if</span>(debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;t=%21.15g : i=%d j=%d k=%d : utoprim corrected7\n&quot;</span>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#ae1ee1e1c83c3f70e2e1afed4f4f5b41e">t</a>,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[1]+i,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[2]+j,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[3]+k);</div>
<div class="line"><a name="l03485"></a><span class="lineno"> 3485</span>&#160;    <span class="comment">// then ASSIGN</span></div>
<div class="line"><a name="l03486"></a><span class="lineno"> 3486</span>&#160;    <a class="code" href="../../de/d95/fixup_8c.html#a7c32d22e47927c62e7c993461b335acf">PLOOPSTARTEND</a>(pl){</div>
<div class="line"><a name="l03487"></a><span class="lineno"> 3487</span>&#160;      <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,pl)=<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(ptoavg,i,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),k,pl);</div>
<div class="line"><a name="l03488"></a><span class="lineno"> 3488</span>&#160;      <span class="keywordflow">if</span>(debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;uc2: pl=%d pv=%21.15g\n&quot;</span>,pl,<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,pl));</div>
<div class="line"><a name="l03489"></a><span class="lineno"> 3489</span>&#160;    }</div>
<div class="line"><a name="l03490"></a><span class="lineno"> 3490</span>&#160;  }</div>
<div class="line"><a name="l03491"></a><span class="lineno"> 3491</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>( <span class="comment">// but if &quot;surrounded&quot; by good value</span></div>
<div class="line"><a name="l03492"></a><span class="lineno"> 3492</span>&#160;          (<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afaacb1c256e44ec7be2adaac65713f2b">IFUTOPRIMNOFAILORFIXED</a>(<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(lpflagfailorig,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),k,whichpflag)))</div>
<div class="line"><a name="l03493"></a><span class="lineno"> 3493</span>&#160;           ){</div>
<div class="line"><a name="l03494"></a><span class="lineno"> 3494</span>&#160;    <span class="keywordflow">if</span>(debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;t=%21.15g : i=%d j=%d k=%d : utoprim corrected7\n&quot;</span>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#ae1ee1e1c83c3f70e2e1afed4f4f5b41e">t</a>,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[1]+i,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[2]+j,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[3]+k);</div>
<div class="line"><a name="l03495"></a><span class="lineno"> 3495</span>&#160;    <span class="comment">// then ASSIGN</span></div>
<div class="line"><a name="l03496"></a><span class="lineno"> 3496</span>&#160;    <a class="code" href="../../de/d95/fixup_8c.html#a7c32d22e47927c62e7c993461b335acf">PLOOPSTARTEND</a>(pl){</div>
<div class="line"><a name="l03497"></a><span class="lineno"> 3497</span>&#160;      <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,pl)=<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(ptoavg,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),k,pl);</div>
<div class="line"><a name="l03498"></a><span class="lineno"> 3498</span>&#160;      <span class="keywordflow">if</span>(debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;uc2: pl=%d pv=%21.15g\n&quot;</span>,pl,<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,pl));</div>
<div class="line"><a name="l03499"></a><span class="lineno"> 3499</span>&#160;    }</div>
<div class="line"><a name="l03500"></a><span class="lineno"> 3500</span>&#160;  }</div>
<div class="line"><a name="l03501"></a><span class="lineno"> 3501</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>( <span class="comment">// but if &quot;surrounded&quot; by good value</span></div>
<div class="line"><a name="l03502"></a><span class="lineno"> 3502</span>&#160;          (<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afaacb1c256e44ec7be2adaac65713f2b">IFUTOPRIMNOFAILORFIXED</a>(<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(lpflagfailorig,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),j,k,whichpflag)))</div>
<div class="line"><a name="l03503"></a><span class="lineno"> 3503</span>&#160;           ){</div>
<div class="line"><a name="l03504"></a><span class="lineno"> 3504</span>&#160;    <span class="keywordflow">if</span>(debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;t=%21.15g : i=%d j=%d k=%d : utoprim corrected7\n&quot;</span>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#ae1ee1e1c83c3f70e2e1afed4f4f5b41e">t</a>,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[1]+i,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[2]+j,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[3]+k);</div>
<div class="line"><a name="l03505"></a><span class="lineno"> 3505</span>&#160;    <span class="comment">// then ASSIGN</span></div>
<div class="line"><a name="l03506"></a><span class="lineno"> 3506</span>&#160;    <a class="code" href="../../de/d95/fixup_8c.html#a7c32d22e47927c62e7c993461b335acf">PLOOPSTARTEND</a>(pl){</div>
<div class="line"><a name="l03507"></a><span class="lineno"> 3507</span>&#160;      <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,pl)=<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(ptoavg,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),j,k,pl);</div>
<div class="line"><a name="l03508"></a><span class="lineno"> 3508</span>&#160;      <span class="keywordflow">if</span>(debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;uc2: pl=%d pv=%21.15g\n&quot;</span>,pl,<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,pl));</div>
<div class="line"><a name="l03509"></a><span class="lineno"> 3509</span>&#160;    }</div>
<div class="line"><a name="l03510"></a><span class="lineno"> 3510</span>&#160;  }</div>
<div class="line"><a name="l03511"></a><span class="lineno"> 3511</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>( <span class="comment">// but if &quot;surrounded&quot; by good value</span></div>
<div class="line"><a name="l03512"></a><span class="lineno"> 3512</span>&#160;          (<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afaacb1c256e44ec7be2adaac65713f2b">IFUTOPRIMNOFAILORFIXED</a>(<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(lpflagfailorig,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a3e64aa2cd3c5e0933e74fa4e7a925570">jp1mac</a>(j),k,whichpflag)))</div>
<div class="line"><a name="l03513"></a><span class="lineno"> 3513</span>&#160;           ){</div>
<div class="line"><a name="l03514"></a><span class="lineno"> 3514</span>&#160;    <span class="keywordflow">if</span>(debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;t=%21.15g : i=%d j=%d k=%d : utoprim corrected7\n&quot;</span>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#ae1ee1e1c83c3f70e2e1afed4f4f5b41e">t</a>,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[1]+i,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[2]+j,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[3]+k);</div>
<div class="line"><a name="l03515"></a><span class="lineno"> 3515</span>&#160;    <span class="comment">// then ASSIGN</span></div>
<div class="line"><a name="l03516"></a><span class="lineno"> 3516</span>&#160;    <a class="code" href="../../de/d95/fixup_8c.html#a7c32d22e47927c62e7c993461b335acf">PLOOPSTARTEND</a>(pl){</div>
<div class="line"><a name="l03517"></a><span class="lineno"> 3517</span>&#160;      <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,pl)=<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(ptoavg,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a3e64aa2cd3c5e0933e74fa4e7a925570">jp1mac</a>(j),k,pl);</div>
<div class="line"><a name="l03518"></a><span class="lineno"> 3518</span>&#160;      <span class="keywordflow">if</span>(debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;uc2: pl=%d pv=%21.15g\n&quot;</span>,pl,<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,pl));</div>
<div class="line"><a name="l03519"></a><span class="lineno"> 3519</span>&#160;    }</div>
<div class="line"><a name="l03520"></a><span class="lineno"> 3520</span>&#160;  }</div>
<div class="line"><a name="l03521"></a><span class="lineno"> 3521</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>( <span class="comment">// but if &quot;surrounded&quot; by good value</span></div>
<div class="line"><a name="l03522"></a><span class="lineno"> 3522</span>&#160;          (<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afaacb1c256e44ec7be2adaac65713f2b">IFUTOPRIMNOFAILORFIXED</a>(<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(lpflagfailorig,i,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a3e64aa2cd3c5e0933e74fa4e7a925570">jp1mac</a>(j),k,whichpflag)))</div>
<div class="line"><a name="l03523"></a><span class="lineno"> 3523</span>&#160;           ){</div>
<div class="line"><a name="l03524"></a><span class="lineno"> 3524</span>&#160;    <span class="keywordflow">if</span>(debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;t=%21.15g : i=%d j=%d k=%d : utoprim corrected7\n&quot;</span>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#ae1ee1e1c83c3f70e2e1afed4f4f5b41e">t</a>,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[1]+i,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[2]+j,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[3]+k);</div>
<div class="line"><a name="l03525"></a><span class="lineno"> 3525</span>&#160;    <span class="comment">// then ASSIGN</span></div>
<div class="line"><a name="l03526"></a><span class="lineno"> 3526</span>&#160;    <a class="code" href="../../de/d95/fixup_8c.html#a7c32d22e47927c62e7c993461b335acf">PLOOPSTARTEND</a>(pl){</div>
<div class="line"><a name="l03527"></a><span class="lineno"> 3527</span>&#160;      <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,pl)=<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(ptoavg,i,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a3e64aa2cd3c5e0933e74fa4e7a925570">jp1mac</a>(j),k,pl);</div>
<div class="line"><a name="l03528"></a><span class="lineno"> 3528</span>&#160;      <span class="keywordflow">if</span>(debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;uc2: pl=%d pv=%21.15g\n&quot;</span>,pl,<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,pl));</div>
<div class="line"><a name="l03529"></a><span class="lineno"> 3529</span>&#160;    }</div>
<div class="line"><a name="l03530"></a><span class="lineno"> 3530</span>&#160;  }</div>
<div class="line"><a name="l03531"></a><span class="lineno"> 3531</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l03532"></a><span class="lineno"> 3532</span>&#160;    <span class="keywordflow">return</span>(1);</div>
<div class="line"><a name="l03533"></a><span class="lineno"> 3533</span>&#160;  }</div>
<div class="line"><a name="l03534"></a><span class="lineno"> 3534</span>&#160;</div>
<div class="line"><a name="l03535"></a><span class="lineno"> 3535</span>&#160;  <span class="comment">// reaches here if ok</span></div>
<div class="line"><a name="l03536"></a><span class="lineno"> 3536</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l03537"></a><span class="lineno"> 3537</span>&#160;}</div>
<div class="line"><a name="l03538"></a><span class="lineno"> 3538</span>&#160;</div>
<div class="line"><a name="l03539"></a><span class="lineno"> 3539</span>&#160;</div>
<div class="line"><a name="l03540"></a><span class="lineno"> 3540</span>&#160;</div>
<div class="line"><a name="l03541"></a><span class="lineno"> 3541</span>&#160;</div>
<div class="line"><a name="l03542"></a><span class="lineno"> 3542</span>&#160;</div>
<div class="line"><a name="l03543"></a><span class="lineno"><a class="code" href="../../de/d95/fixup_8c.html#a0d23f070342ff51f55caea387c61a68b"> 3543</a></span>&#160;<span class="preprocessor">#define NOGOODSTATIC 0</span></div>
<div class="line"><a name="l03544"></a><span class="lineno"><a class="code" href="../../de/d95/fixup_8c.html#a9c751feb0e2cff1d9b2f9c43a573b7ce"> 3544</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define NOGOODRESET 1</span></div>
<div class="line"><a name="l03545"></a><span class="lineno"><a class="code" href="../../de/d95/fixup_8c.html#a6148af2b41aac1ddec4b0f2eaea10658"> 3545</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define NOGOODAVERAGE 2</span></div>
<div class="line"><a name="l03546"></a><span class="lineno"> 3546</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l03547"></a><span class="lineno"> 3547</span>&#160;<span class="comment">// no good values.  Choices: STATIC, RESET to something, and AVERAGE failed (t-dt surrounding) values.</span></div>
<div class="line"><a name="l03548"></a><span class="lineno"><a class="code" href="../../de/d95/fixup_8c.html#a13f142795a88ea5b347fba667497b39f"> 3548</a></span>&#160;<span class="preprocessor">#define TODONOGOOD NOGOODAVERAGE</span></div>
<div class="line"><a name="l03549"></a><span class="lineno"> 3549</span>&#160;<span class="preprocessor"></span><span class="comment">// 0=STATIC // model-independent, but really bad idea -- causes death of computation for accretion disks in jet region.</span></div>
<div class="line"><a name="l03550"></a><span class="lineno"> 3550</span>&#160;<span class="comment">// 1=RESET // model-dependent</span></div>
<div class="line"><a name="l03551"></a><span class="lineno"> 3551</span>&#160;<span class="comment">// 2=AVERAGE // model-independent -- probably best idea -- and then hope for the best.</span></div>
<div class="line"><a name="l03552"></a><span class="lineno"> 3552</span>&#160;</div>
<div class="line"><a name="l03553"></a><span class="lineno"> 3553</span>&#160;</div>
<div class="line"><a name="l03554"></a><span class="lineno"> 3554</span>&#160;<span class="comment">// as stated</span></div>
<div class="line"><a name="l03555"></a><span class="lineno"> 3555</span>&#160;<span class="comment">// 0 : pv</span></div>
<div class="line"><a name="l03556"></a><span class="lineno"> 3556</span>&#160;<span class="comment">// 1: pbackup</span></div>
<div class="line"><a name="l03557"></a><span class="lineno"><a class="code" href="../../de/d95/fixup_8c.html#af7940d13309b1793495d537743905b8d"> 3557</a></span>&#160;<span class="preprocessor">#define WHICHPTOUSEWHENNOGOOD 0</span></div>
<div class="line"><a name="l03558"></a><span class="lineno"> 3558</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l03559"></a><span class="lineno"> 3559</span>&#160;</div>
<div class="line"><a name="l03561"></a><span class="lineno"> 3561</span>&#160;<span class="comment">//static int fixup_nogood(int startpl, int endpl, int i, int j, int k, FTYPE (*pv)[NSTORE2][NSTORE3][NPR],FTYPE (*ptoavg)[NSTORE2][NSTORE3][NPR],FTYPE (*pbackup)[NSTORE2][NSTORE3][NPR], struct of_geom *ptrgeom)</span></div>
<div class="line"><a name="l03562"></a><span class="lineno"> 3562</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> fixup_nogood(<span class="keywordtype">int</span> startpl, <span class="keywordtype">int</span> endpl, <span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k, <span class="keywordtype">int</span> doingmhd, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> mhdlpflag, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> radlpflag, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pv)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*ptoavg)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pbackup)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR], <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom)</div>
<div class="line"><a name="l03563"></a><span class="lineno"> 3563</span>&#160;{</div>
<div class="line"><a name="l03564"></a><span class="lineno"> 3564</span>&#160;  <span class="keywordtype">int</span> pl,pliter;</div>
<div class="line"><a name="l03565"></a><span class="lineno"> 3565</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> prguess[NPR];</div>
<div class="line"><a name="l03566"></a><span class="lineno"> 3566</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*ptoavgwhennogood)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR];</div>
<div class="line"><a name="l03567"></a><span class="lineno"> 3567</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../dc/dd2/newcodediff_8txt.html#ae1f54cf2f1b8578003f6de5bd09531f5">ti</a>,tj,tk,resetregion;</div>
<div class="line"><a name="l03568"></a><span class="lineno"> 3568</span>&#160;</div>
<div class="line"><a name="l03569"></a><span class="lineno"> 3569</span>&#160;</div>
<div class="line"><a name="l03570"></a><span class="lineno"> 3570</span>&#160;  </div>
<div class="line"><a name="l03571"></a><span class="lineno"> 3571</span>&#160;  <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a7df8286c59d491ba1117884d33499a7a">prod0dualfprintf</a>(debugfail&gt;=2,fail_file,<span class="stringliteral">&quot;uc2nogood: i=%d j=%d k=%d\n&quot;</span>,i,j,k); <span class="comment">// not too much</span></div>
<div class="line"><a name="l03572"></a><span class="lineno"> 3572</span>&#160;</div>
<div class="line"><a name="l03573"></a><span class="lineno"> 3573</span>&#160;</div>
<div class="line"><a name="l03574"></a><span class="lineno"> 3574</span>&#160;  <span class="comment">// Determine which primitive to use to average when no good solution</span></div>
<div class="line"><a name="l03575"></a><span class="lineno"> 3575</span>&#160;  <span class="comment">// exists around to average</span></div>
<div class="line"><a name="l03576"></a><span class="lineno"> 3576</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../de/d95/fixup_8c.html#af7940d13309b1793495d537743905b8d">WHICHPTOUSEWHENNOGOOD</a>==0){</div>
<div class="line"><a name="l03577"></a><span class="lineno"> 3577</span>&#160;    ptoavgwhennogood=ptoavg;</div>
<div class="line"><a name="l03578"></a><span class="lineno"> 3578</span>&#160;  }</div>
<div class="line"><a name="l03579"></a><span class="lineno"> 3579</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../de/d95/fixup_8c.html#af7940d13309b1793495d537743905b8d">WHICHPTOUSEWHENNOGOOD</a>==1){</div>
<div class="line"><a name="l03580"></a><span class="lineno"> 3580</span>&#160;    ptoavgwhennogood=pbackup;</div>
<div class="line"><a name="l03581"></a><span class="lineno"> 3581</span>&#160;  }</div>
<div class="line"><a name="l03582"></a><span class="lineno"> 3582</span>&#160;</div>
<div class="line"><a name="l03583"></a><span class="lineno"> 3583</span>&#160;</div>
<div class="line"><a name="l03584"></a><span class="lineno"> 3584</span>&#160;  ti=<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[1]+<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>;</div>
<div class="line"><a name="l03585"></a><span class="lineno"> 3585</span>&#160;  tj=<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[2]+<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>;</div>
<div class="line"><a name="l03586"></a><span class="lineno"> 3586</span>&#160;  tk=<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[3]+k;</div>
<div class="line"><a name="l03587"></a><span class="lineno"> 3587</span>&#160;</div>
<div class="line"><a name="l03588"></a><span class="lineno"> 3588</span>&#160;</div>
<div class="line"><a name="l03590"></a><span class="lineno"> 3590</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l03591"></a><span class="lineno"> 3591</span>&#160;  <span class="comment">// no good values.  Choices: STATIC, RESET to something, and AVERAGE failed (t-dt surrounding) values.</span></div>
<div class="line"><a name="l03592"></a><span class="lineno"> 3592</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l03594"></a><span class="lineno"> 3594</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03595"></a><span class="lineno"> 3595</span>&#160;</div>
<div class="line"><a name="l03597"></a><span class="lineno"> 3597</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l03599"></a><span class="lineno"> 3599</span>&#160;<span class="comment"></span>  <span class="comment">//</span></div>
<div class="line"><a name="l03601"></a><span class="lineno"> 3601</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03602"></a><span class="lineno"> 3602</span>&#160;<span class="preprocessor">#if(USERRESETREGION==1)</span></div>
<div class="line"><a name="l03603"></a><span class="lineno"> 3603</span>&#160;<span class="preprocessor"></span>  <span class="comment">// tj = 0,1,totalsize[2]-2,totalsize[2]-1 are reset region</span></div>
<div class="line"><a name="l03604"></a><span class="lineno"> 3604</span>&#160;  <span class="comment">// ti&lt;10 near BH is reset region</span></div>
<div class="line"><a name="l03605"></a><span class="lineno"> 3605</span>&#160;  <span class="comment">//  resetregion=(tj&gt;=-2 &amp;&amp; tj&lt;=1 || tj&gt;=totalsize[2]-2 &amp;&amp; tj&lt;=totalsize[2]+1) || (ti&lt;10);</span></div>
<div class="line"><a name="l03606"></a><span class="lineno"> 3606</span>&#160;  resetregion=(tj&lt;=1 || tj&gt;=<a class="code" href="../../dd/d46/mpidefs_8h.html#ab3efab8b1f2dffc5907e0b0a5aa3988f">totalsize</a>[2]-2) || (ti&lt;10);</div>
<div class="line"><a name="l03607"></a><span class="lineno"> 3607</span>&#160;<span class="preprocessor">#elif(USERRESETREGION==0)</span></div>
<div class="line"><a name="l03608"></a><span class="lineno"> 3608</span>&#160;<span class="preprocessor"></span>  resetregion=0;</div>
<div class="line"><a name="l03609"></a><span class="lineno"> 3609</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03610"></a><span class="lineno"> 3610</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l03611"></a><span class="lineno"> 3611</span>&#160;</div>
<div class="line"><a name="l03612"></a><span class="lineno"> 3612</span>&#160;</div>
<div class="line"><a name="l03613"></a><span class="lineno"> 3613</span>&#160;  <span class="keywordflow">if</span>(resetregion || <a class="code" href="../../de/d95/fixup_8c.html#a13f142795a88ea5b347fba667497b39f">TODONOGOOD</a>==<a class="code" href="../../de/d95/fixup_8c.html#a9c751feb0e2cff1d9b2f9c43a573b7ce">NOGOODRESET</a>){<span class="comment">// if no solution, revert to normal observer and averaged densities</span></div>
<div class="line"><a name="l03614"></a><span class="lineno"> 3614</span>&#160;</div>
<div class="line"><a name="l03615"></a><span class="lineno"> 3615</span>&#160;    <span class="comment">// model-dependent: assumes failures occur mostly in jet region near where matter is mostly freefalling near black hole where b^2/rho_0&gt;&gt;1</span></div>
<div class="line"><a name="l03616"></a><span class="lineno"> 3616</span>&#160;</div>
<div class="line"><a name="l03617"></a><span class="lineno"> 3617</span>&#160;    <span class="keywordflow">if</span>(debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;t=%21.15g : i=%d j=%d k=%d : utoprim corrected9\n&quot;</span>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#ae1ee1e1c83c3f70e2e1afed4f4f5b41e">t</a>,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[1]+i,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[2]+j,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[3]+k);</div>
<div class="line"><a name="l03618"></a><span class="lineno"> 3618</span>&#160;    <span class="comment">// otherwise some surrounding solutions are also bad, so just keep static</span></div>
<div class="line"><a name="l03619"></a><span class="lineno"> 3619</span>&#160;    <span class="comment">// keeping static can lead to large regions of high gamma that are static and unstable to interactions.  Thus, reset static to normal observer flow for safety.</span></div>
<div class="line"><a name="l03620"></a><span class="lineno"> 3620</span>&#160;    <span class="comment">// setting to normal observer for surrounding high gamma flows leads to large shocks and high internal energy.</span></div>
<div class="line"><a name="l03621"></a><span class="lineno"> 3621</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l03622"></a><span class="lineno"> 3622</span>&#160;    <span class="comment">// thus not sure what to do. (should have gotten correct U in first place! -- that&#39;s what you should do)</span></div>
<div class="line"><a name="l03623"></a><span class="lineno"> 3623</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l03624"></a><span class="lineno"> 3624</span>&#160;    <span class="comment">// limit_gamma?  Could also reset v completely to normal observer</span></div>
<div class="line"><a name="l03625"></a><span class="lineno"> 3625</span>&#160;    <span class="comment">// if(limit_gamma(0,1.0,MAC(pv,i,j,k),ptrgeom,-1)&gt;=1)</span></div>
<div class="line"><a name="l03626"></a><span class="lineno"> 3626</span>&#160;    <span class="comment">//   FAILSTATEMENT(&quot;fixup.c:fixup_utoprim()&quot;, &quot;limit_gamma()&quot;, 1);</span></div>
<div class="line"><a name="l03627"></a><span class="lineno"> 3627</span>&#160;</div>
<div class="line"><a name="l03628"></a><span class="lineno"> 3628</span>&#160;    <span class="comment">// average out densities</span></div>
<div class="line"><a name="l03629"></a><span class="lineno"> 3629</span>&#160;    <span class="keywordflow">for</span>(pl=0;pl&lt;=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>;pl++) <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,pl)=0.5*(<a class="code" href="../../de/d95/fixup_8c.html#afffb4925f444309c751a6aa55468d412">AVG4_1</a>(ptoavgwhennogood,i,j,k,pl)+<a class="code" href="../../de/d95/fixup_8c.html#a8988b8749add2fcc20cb7ee1706bf6b4">AVG4_2</a>(ptoavgwhennogood,i,j,k,pl));</div>
<div class="line"><a name="l03630"></a><span class="lineno"> 3630</span>&#160;    <span class="comment">// make velocity the normal observer</span></div>
<div class="line"><a name="l03631"></a><span class="lineno"> 3631</span>&#160;    set_atmosphere(0,<a class="code" href="../../da/d3e/definit_8h.html#a3d14480f30d39eff4e51ae8bc93df56f" title="whether we use ultimately precise inversion or &quot;workable&quot; inversion precision (see utoprim&#39;s for ho...">WHICHVEL</a>,ptrgeom,prguess);</div>
<div class="line"><a name="l03632"></a><span class="lineno"> 3632</span>&#160;    <span class="keywordflow">for</span>(pl=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>;pl&lt;=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8de9104f1fffa59f057b214d74c5cfea">U3</a>;pl++) <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,pl)=prguess[pl];</div>
<div class="line"><a name="l03633"></a><span class="lineno"> 3633</span>&#160;    <span class="comment">// average out things above field &quot;pl&quot;</span></div>
<div class="line"><a name="l03634"></a><span class="lineno"> 3634</span>&#160;    <span class="keywordflow">for</span>(pl=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>+1;pl&lt;NPR;pl++) <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,pl)=0.5*(<a class="code" href="../../de/d95/fixup_8c.html#afffb4925f444309c751a6aa55468d412">AVG4_1</a>(ptoavgwhennogood,i,j,k,pl)+<a class="code" href="../../de/d95/fixup_8c.html#a8988b8749add2fcc20cb7ee1706bf6b4">AVG4_2</a>(ptoavgwhennogood,i,j,k,pl));</div>
<div class="line"><a name="l03635"></a><span class="lineno"> 3635</span>&#160;</div>
<div class="line"><a name="l03636"></a><span class="lineno"> 3636</span>&#160;  }</div>
<div class="line"><a name="l03638"></a><span class="lineno"> 3638</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l03640"></a><span class="lineno"> 3640</span>&#160;<span class="comment"></span>  <span class="comment">//</span></div>
<div class="line"><a name="l03642"></a><span class="lineno"> 3642</span>&#160;<span class="comment"></span>  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../de/d95/fixup_8c.html#a13f142795a88ea5b347fba667497b39f">TODONOGOOD</a>==<a class="code" href="../../de/d95/fixup_8c.html#a6148af2b41aac1ddec4b0f2eaea10658">NOGOODAVERAGE</a>){<span class="comment">// if no solution, revert to normal observer and averaged densities</span></div>
<div class="line"><a name="l03643"></a><span class="lineno"> 3643</span>&#160;    <span class="comment">// average out densities+velocity</span></div>
<div class="line"><a name="l03644"></a><span class="lineno"> 3644</span>&#160;<span class="preprocessor">#if(GENERALAVERAGE==1)</span></div>
<div class="line"><a name="l03645"></a><span class="lineno"> 3645</span>&#160;<span class="preprocessor"></span>    <span class="comment">// use general average without regard to failure</span></div>
<div class="line"><a name="l03646"></a><span class="lineno"> 3646</span>&#160;    <span class="keywordtype">int</span> useonlynonfailed=0; <span class="comment">// any type of cell, failed or not, will be used in the average</span></div>
<div class="line"><a name="l03647"></a><span class="lineno"> 3647</span>&#160;    <span class="keywordtype">int</span> numbndtotry=1;</div>
<div class="line"><a name="l03648"></a><span class="lineno"> 3648</span>&#160;    <span class="keywordtype">int</span> maxnumbndtotry=1; <span class="comment">//MAXNUMPFLAGBND; // choice smaller or equal to MAXNUMPFLAGBND</span></div>
<div class="line"><a name="l03649"></a><span class="lineno"> 3649</span>&#160;    <span class="keywordtype">int</span> nogood=general_average(useonlynonfailed,numbndtotry,maxnumbndtotry,startpl, endpl, i, j, k, doingmhd, mhdlpflag, radlpflag, NULL ,pv,ptoavg,ptrgeom);</div>
<div class="line"><a name="l03650"></a><span class="lineno"> 3650</span>&#160;    <span class="comment">// nogood will be 1</span></div>
<div class="line"><a name="l03651"></a><span class="lineno"> 3651</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l03652"></a><span class="lineno"> 3652</span>&#160;<span class="preprocessor"></span>    <a class="code" href="../../de/d95/fixup_8c.html#a7c32d22e47927c62e7c993461b335acf">PLOOPSTARTEND</a>(pl) <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,pl)=0.5*(<a class="code" href="../../de/d95/fixup_8c.html#afffb4925f444309c751a6aa55468d412">AVG4_1</a>(ptoavgwhennogood,i,j,k,pl)+<a class="code" href="../../de/d95/fixup_8c.html#a8988b8749add2fcc20cb7ee1706bf6b4">AVG4_2</a>(ptoavgwhennogood,i,j,k,pl)); <span class="comment">// like simple average</span></div>
<div class="line"><a name="l03653"></a><span class="lineno"> 3653</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03654"></a><span class="lineno"> 3654</span>&#160;<span class="preprocessor"></span>    </div>
<div class="line"><a name="l03655"></a><span class="lineno"> 3655</span>&#160;  }</div>
<div class="line"><a name="l03656"></a><span class="lineno"> 3656</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../de/d95/fixup_8c.html#a13f142795a88ea5b347fba667497b39f">TODONOGOOD</a>==<a class="code" href="../../de/d95/fixup_8c.html#a0d23f070342ff51f55caea387c61a68b">NOGOODSTATIC</a>){<span class="comment">// if no solution, revert to normal observer and averaged densities</span></div>
<div class="line"><a name="l03657"></a><span class="lineno"> 3657</span>&#160;    <span class="comment">// don&#39;t change -- stay at previous timestep value (or whatever utoprim() left it as).</span></div>
<div class="line"><a name="l03658"></a><span class="lineno"> 3658</span>&#160;  }</div>
<div class="line"><a name="l03659"></a><span class="lineno"> 3659</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l03660"></a><span class="lineno"> 3660</span>&#160;    dualfprintf(fail_file,<span class="stringliteral">&quot;No condition for failure in fixup_nogood()\n&quot;</span>);</div>
<div class="line"><a name="l03661"></a><span class="lineno"> 3661</span>&#160;    myexit(348576346);</div>
<div class="line"><a name="l03662"></a><span class="lineno"> 3662</span>&#160;  }</div>
<div class="line"><a name="l03663"></a><span class="lineno"> 3663</span>&#160;</div>
<div class="line"><a name="l03664"></a><span class="lineno"> 3664</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l03665"></a><span class="lineno"> 3665</span>&#160;}</div>
<div class="line"><a name="l03666"></a><span class="lineno"> 3666</span>&#160;</div>
<div class="line"><a name="l03667"></a><span class="lineno"> 3667</span>&#160;</div>
<div class="line"><a name="l03668"></a><span class="lineno"> 3668</span>&#160;</div>
<div class="line"><a name="l03669"></a><span class="lineno"> 3669</span>&#160;</div>
<div class="line"><a name="l03671"></a><span class="lineno"> 3671</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> superdebug_utoprim(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr0, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <span class="keywordtype">int</span> whocalled)</div>
<div class="line"><a name="l03672"></a><span class="lineno"> 3672</span>&#160;{</div>
<div class="line"><a name="l03673"></a><span class="lineno"> 3673</span>&#160;  <span class="keywordtype">int</span> pl,pliter;</div>
<div class="line"><a name="l03674"></a><span class="lineno"> 3674</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> q;</div>
<div class="line"><a name="l03675"></a><span class="lineno"> 3675</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Ui[NPR],Uf[NPR];</div>
<div class="line"><a name="l03676"></a><span class="lineno"> 3676</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> <a class="code" href="../../dc/dd2/newcodediff_8txt.html#a933233ff9879962bcc2ff987c6920f90">X</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>],<a class="code" href="../../dc/dd2/newcodediff_8txt.html#af84f2c3bf153920b7c8d186132d39bc7">V</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l03677"></a><span class="lineno"> 3677</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ftemp;</div>
<div class="line"><a name="l03678"></a><span class="lineno"> 3678</span>&#160;  <span class="keywordtype">int</span> failreturn;</div>
<div class="line"><a name="l03679"></a><span class="lineno"> 3679</span>&#160;  <span class="keyword">static</span> FILE * super_fail_file;</div>
<div class="line"><a name="l03680"></a><span class="lineno"> 3680</span>&#160;  <span class="keyword">static</span> <span class="keywordtype">int</span> firsttime=1;</div>
<div class="line"><a name="l03681"></a><span class="lineno"> 3681</span>&#160;  <span class="keywordtype">int</span> output;</div>
<div class="line"><a name="l03682"></a><span class="lineno"> 3682</span>&#160;  <span class="keyword">static</span> <span class="keywordtype">int</span> countoutput=0;</div>
<div class="line"><a name="l03683"></a><span class="lineno"> 3683</span>&#160;</div>
<div class="line"><a name="l03684"></a><span class="lineno"> 3684</span>&#160;<span class="preprocessor">#if(USEOPENMP)</span></div>
<div class="line"><a name="l03685"></a><span class="lineno"> 3685</span>&#160;<span class="preprocessor"></span>  dualfprintf(fail_file,<span class="stringliteral">&quot;Cannot Superdebug with OpenMP\n&quot;</span>);</div>
<div class="line"><a name="l03686"></a><span class="lineno"> 3686</span>&#160;  myexit(45968546);</div>
<div class="line"><a name="l03687"></a><span class="lineno"> 3687</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03688"></a><span class="lineno"> 3688</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l03689"></a><span class="lineno"> 3689</span>&#160;</div>
<div class="line"><a name="l03690"></a><span class="lineno"> 3690</span>&#160;  <span class="keywordflow">if</span>(firsttime){</div>
<div class="line"><a name="l03691"></a><span class="lineno"> 3691</span>&#160;    super_fail_file=fopen(<span class="stringliteral">&quot;superdebug.out&quot;</span>,<span class="stringliteral">&quot;wt&quot;</span>);</div>
<div class="line"><a name="l03692"></a><span class="lineno"> 3692</span>&#160;    <span class="keywordflow">if</span>(super_fail_file==NULL){</div>
<div class="line"><a name="l03693"></a><span class="lineno"> 3693</span>&#160;      dualfprintf(fail_file,<span class="stringliteral">&quot;Cannot open superdebug.out\n&quot;</span>);</div>
<div class="line"><a name="l03694"></a><span class="lineno"> 3694</span>&#160;      myexit(1);</div>
<div class="line"><a name="l03695"></a><span class="lineno"> 3695</span>&#160;    }</div>
<div class="line"><a name="l03696"></a><span class="lineno"> 3696</span>&#160;    countoutput=0;</div>
<div class="line"><a name="l03697"></a><span class="lineno"> 3697</span>&#160;  }</div>
<div class="line"><a name="l03698"></a><span class="lineno"> 3698</span>&#160;</div>
<div class="line"><a name="l03699"></a><span class="lineno"> 3699</span>&#160;  <span class="keywordflow">if</span>(whocalled==-1){</div>
<div class="line"><a name="l03700"></a><span class="lineno"> 3700</span>&#160;    <span class="comment">// then only output if every so often, randomly in step</span></div>
<div class="line"><a name="l03701"></a><span class="lineno"> 3701</span>&#160;    <span class="keywordflow">if</span>(ranc(0,0)&gt;0.99) output=1;</div>
<div class="line"><a name="l03702"></a><span class="lineno"> 3702</span>&#160;    <span class="keywordflow">else</span> output=0;</div>
<div class="line"><a name="l03703"></a><span class="lineno"> 3703</span>&#160;  }</div>
<div class="line"><a name="l03704"></a><span class="lineno"> 3704</span>&#160;  <span class="keywordflow">else</span> output=1;</div>
<div class="line"><a name="l03705"></a><span class="lineno"> 3705</span>&#160;</div>
<div class="line"><a name="l03706"></a><span class="lineno"> 3706</span>&#160;  <span class="keywordflow">if</span>(output){</div>
<div class="line"><a name="l03707"></a><span class="lineno"> 3707</span>&#160;    <span class="comment">// before any changes</span></div>
<div class="line"><a name="l03708"></a><span class="lineno"> 3708</span>&#160;    failreturn=<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a11e17cd8b0594d1ad52e3594aa9f477e" title="find ucon, ucov, bcon, bcov from primitive variables when calling get_state, users of this function e...">get_state</a>(pr0,ptrgeom,&amp;q);</div>
<div class="line"><a name="l03709"></a><span class="lineno"> 3709</span>&#160;    <span class="keywordflow">if</span>(failreturn&gt;=1) dualfprintf(fail_file,<span class="stringliteral">&quot;get_state(1) failed in fixup.c, why???\n&quot;</span>);</div>
<div class="line"><a name="l03710"></a><span class="lineno"> 3710</span>&#160;    failreturn=<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a9a54096e4c40a15a2c1bf74266153616" title="calculate &quot;conserved&quot; quantities">primtoU</a>(UDIAG,pr0,&amp;q,ptrgeom,Ui, NULL);</div>
<div class="line"><a name="l03711"></a><span class="lineno"> 3711</span>&#160;    <span class="keywordflow">if</span>(failreturn&gt;=1) dualfprintf(fail_file,<span class="stringliteral">&quot;primtoU(1) failed in fixup.c, why???\n&quot;</span>);</div>
<div class="line"><a name="l03712"></a><span class="lineno"> 3712</span>&#160;    </div>
<div class="line"><a name="l03713"></a><span class="lineno"> 3713</span>&#160;    <span class="comment">// after any changes</span></div>
<div class="line"><a name="l03714"></a><span class="lineno"> 3714</span>&#160;    failreturn=<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a11e17cd8b0594d1ad52e3594aa9f477e" title="find ucon, ucov, bcon, bcov from primitive variables when calling get_state, users of this function e...">get_state</a>(pr,ptrgeom,&amp;q);</div>
<div class="line"><a name="l03715"></a><span class="lineno"> 3715</span>&#160;    <span class="keywordflow">if</span>(failreturn&gt;=1) dualfprintf(fail_file,<span class="stringliteral">&quot;get_state(2) failed in fixup.c, why???\n&quot;</span>);</div>
<div class="line"><a name="l03716"></a><span class="lineno"> 3716</span>&#160;    failreturn=<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a9a54096e4c40a15a2c1bf74266153616" title="calculate &quot;conserved&quot; quantities">primtoU</a>(UDIAG,pr,&amp;q,ptrgeom,Uf, NULL);</div>
<div class="line"><a name="l03717"></a><span class="lineno"> 3717</span>&#160;    <span class="keywordflow">if</span>(failreturn&gt;=1) dualfprintf(fail_file,<span class="stringliteral">&quot;primtoU(2) failed in fixup.c, why???\n&quot;</span>);</div>
<div class="line"><a name="l03718"></a><span class="lineno"> 3718</span>&#160;</div>
<div class="line"><a name="l03719"></a><span class="lineno"> 3719</span>&#160;</div>
<div class="line"><a name="l03720"></a><span class="lineno"> 3720</span>&#160;    <a class="code" href="../../d9/de9/coord_8c.html#a1e1d4fd69f1234cb8751c4ea66297995" title="normally-used bl_coord[i,j,k] {i,j,k} -&gt; X only">coord_ijk</a>(ptrgeom-&gt;i, ptrgeom-&gt;j, ptrgeom-&gt;k, ptrgeom-&gt;p, X);</div>
<div class="line"><a name="l03721"></a><span class="lineno"> 3721</span>&#160;    <a class="code" href="../../d9/de9/coord_8c.html#a96290375e27d5d0aa4d843b07e228e14" title="normally-used bl_coord[i,j,k] {i,j,k} -&gt; V only">bl_coord_ijk</a>(ptrgeom-&gt;i, ptrgeom-&gt;j, ptrgeom-&gt;k, ptrgeom-&gt;p, V);</div>
<div class="line"><a name="l03722"></a><span class="lineno"> 3722</span>&#160;    </div>
<div class="line"><a name="l03723"></a><span class="lineno"> 3723</span>&#160;    </div>
<div class="line"><a name="l03724"></a><span class="lineno"> 3724</span>&#160;    <span class="comment">// used to determine nature of pre and post failure quantities</span></div>
<div class="line"><a name="l03725"></a><span class="lineno"> 3725</span>&#160;    fprintf(super_fail_file,<span class="stringliteral">&quot;%21.15g %ld %d %d %d &quot;</span>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#ae1ee1e1c83c3f70e2e1afed4f4f5b41e">t</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a0b92e4d6197989f0f9b0609c8615a46f">realnstep</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a70170b90229f9fc05eebf8508a685c70">steppart</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a4aa8d6658437fa43b57a498c7230bf27">numstepparts</a>,whocalled);</div>
<div class="line"><a name="l03726"></a><span class="lineno"> 3726</span>&#160;    fprintf(super_fail_file,<span class="stringliteral">&quot;%21.15g %21.15g %21.15g %d %d %d &quot;</span>,V[1],V[2],V[3],<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[1]+ptrgeom-&gt;i,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[2]+ptrgeom-&gt;j,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[3]+ptrgeom-&gt;k);</div>
<div class="line"><a name="l03727"></a><span class="lineno"> 3727</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) fprintf(super_fail_file,&quot;%21.15g %21.15g %21.15g %21.15g &quot;,pr0[pl],pr[pl],Ui[pl],Uf[pl]);</div>
<div class="line"><a name="l03728"></a><span class="lineno"> 3728</span>&#160;    fprintf(super_fail_file,&quot;\n&quot;);</div>
<div class="line"><a name="l03729"></a><span class="lineno"> 3729</span>&#160;    if(!(countoutput%1000)) fflush(super_fail_file);</div>
<div class="line"><a name="l03730"></a><span class="lineno"> 3730</span>&#160;    countoutput++;</div>
<div class="line"><a name="l03731"></a><span class="lineno"> 3731</span>&#160;  }</div>
<div class="line"><a name="l03732"></a><span class="lineno"> 3732</span>&#160;</div>
<div class="line"><a name="l03733"></a><span class="lineno"> 3733</span>&#160;</div>
<div class="line"><a name="l03734"></a><span class="lineno"> 3734</span>&#160;</div>
<div class="line"><a name="l03735"></a><span class="lineno"> 3735</span>&#160;  firsttime=0;</div>
<div class="line"><a name="l03736"></a><span class="lineno"> 3736</span>&#160;</div>
<div class="line"><a name="l03737"></a><span class="lineno"> 3737</span>&#160;  return(0);</div>
<div class="line"><a name="l03738"></a><span class="lineno"> 3738</span>&#160;}</div>
<div class="line"><a name="l03739"></a><span class="lineno"> 3739</span>&#160;</div>
<div class="line"><a name="l03741"></a><span class="lineno"> 3741</span>&#160;<span class="keywordtype">int</span> set_density_floors_default(struct <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *prfloor, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *prceiling)</div>
<div class="line"><a name="l03742"></a><span class="lineno"> 3742</span>&#160;{</div>
<div class="line"><a name="l03743"></a><span class="lineno"> 3743</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> q;</div>
<div class="line"><a name="l03744"></a><span class="lineno"> 3744</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> U[NPR];</div>
<div class="line"><a name="l03745"></a><span class="lineno"> 3745</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> <a class="code" href="../../d1/d83/structof__state.html#a2b38c522ec7321af3368706fa4632834">bsq</a>;</div>
<div class="line"><a name="l03746"></a><span class="lineno"> 3746</span>&#160;</div>
<div class="line"><a name="l03747"></a><span class="lineno"> 3747</span>&#160;  <span class="keywordflow">if</span>(rescaletype==2){</div>
<div class="line"><a name="l03748"></a><span class="lineno"> 3748</span>&#160;    <span class="comment">// to best conserve E and L along magnetic field lines</span></div>
<div class="line"><a name="l03749"></a><span class="lineno"> 3749</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a11e17cd8b0594d1ad52e3594aa9f477e" title="find ucon, ucov, bcon, bcov from primitive variables when calling get_state, users of this function e...">get_state</a>(pr, ptrgeom, &amp;q) &gt;= 1)</div>
<div class="line"><a name="l03750"></a><span class="lineno"> 3750</span>&#160;      <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a5febb92786c5f7a1479e7e65f1c23ef3">FAILSTATEMENT</a>(<span class="stringliteral">&quot;fixup.c:set_density_floors()&quot;</span>, <span class="stringliteral">&quot;get_state() dir=0&quot;</span>, 1);</div>
<div class="line"><a name="l03751"></a><span class="lineno"> 3751</span>&#160;    </div>
<div class="line"><a name="l03752"></a><span class="lineno"> 3752</span>&#160;    <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a9a54096e4c40a15a2c1bf74266153616" title="calculate &quot;conserved&quot; quantities">primtoU</a>(UDIAG,pr, &amp;q, ptrgeom, U, NULL),<span class="stringliteral">&quot;fixup.c:set_density_floors()&quot;</span>, <span class="stringliteral">&quot;primtoU()&quot;</span>, 1);</div>
<div class="line"><a name="l03753"></a><span class="lineno"> 3753</span>&#160;  }</div>
<div class="line"><a name="l03754"></a><span class="lineno"> 3754</span>&#160;</div>
<div class="line"><a name="l03755"></a><span class="lineno"> 3755</span>&#160;  <span class="keywordflow">if</span>(rescaletype==4||rescaletype==5){</div>
<div class="line"><a name="l03756"></a><span class="lineno"> 3756</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a837cc5e285c9e98d2b74a324352b0117">bsq_calc</a>(pr,ptrgeom,&amp;bsq)&gt;=1){</div>
<div class="line"><a name="l03757"></a><span class="lineno"> 3757</span>&#160;      dualfprintf(fail_file,<span class="stringliteral">&quot;bsq_calc:bsq_calc: failure\n&quot;</span>);</div>
<div class="line"><a name="l03758"></a><span class="lineno"> 3758</span>&#160;      <span class="keywordflow">return</span>(1);</div>
<div class="line"><a name="l03759"></a><span class="lineno"> 3759</span>&#160;    }</div>
<div class="line"><a name="l03760"></a><span class="lineno"> 3760</span>&#160;  }</div>
<div class="line"><a name="l03761"></a><span class="lineno"> 3761</span>&#160;</div>
<div class="line"><a name="l03762"></a><span class="lineno"> 3762</span>&#160;  set_density_floors_default_alt(ptrgeom, &amp;q, pr, U, bsq, prfloor, prceiling);</div>
<div class="line"><a name="l03763"></a><span class="lineno"> 3763</span>&#160;</div>
<div class="line"><a name="l03764"></a><span class="lineno"> 3764</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l03765"></a><span class="lineno"> 3765</span>&#160;}</div>
<div class="line"><a name="l03766"></a><span class="lineno"> 3766</span>&#160;</div>
<div class="line"><a name="l03768"></a><span class="lineno"> 3768</span>&#160;<span class="keywordtype">int</span> set_density_floors_default_alt(<span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *q, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *U, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> bsq, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *prfloor, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *prceiling)</div>
<div class="line"><a name="l03769"></a><span class="lineno"> 3769</span>&#160;{</div>
<div class="line"><a name="l03770"></a><span class="lineno"> 3770</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Upbinf[NPR];</div>
<div class="line"><a name="l03771"></a><span class="lineno"> 3771</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> r,th,X[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>],V[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l03772"></a><span class="lineno"> 3772</span>&#160;  <span class="keywordtype">int</span> pl,pliter;</div>
<div class="line"><a name="l03773"></a><span class="lineno"> 3773</span>&#160;  <span class="keywordtype">int</span> i=ptrgeom-&gt;i,j=ptrgeom-&gt;j,k=ptrgeom-&gt;k,<a class="code" href="../../d9/d54/other6_8txt.html#a4c46d2d3bb1db943c0dce6af1c779ff5">p</a>=ptrgeom-&gt;p;</div>
<div class="line"><a name="l03774"></a><span class="lineno"> 3774</span>&#160;</div>
<div class="line"><a name="l03775"></a><span class="lineno"> 3775</span>&#160;  <a class="code" href="../../d9/de9/coord_8c.html#a1e1d4fd69f1234cb8751c4ea66297995" title="normally-used bl_coord[i,j,k] {i,j,k} -&gt; X only">coord_ijk</a>(ptrgeom-&gt;i, ptrgeom-&gt;j, ptrgeom-&gt;k, ptrgeom-&gt;p, X);</div>
<div class="line"><a name="l03776"></a><span class="lineno"> 3776</span>&#160;  <a class="code" href="../../d9/de9/coord_8c.html#a96290375e27d5d0aa4d843b07e228e14" title="normally-used bl_coord[i,j,k] {i,j,k} -&gt; V only">bl_coord_ijk</a>(ptrgeom-&gt;i, ptrgeom-&gt;j, ptrgeom-&gt;k, ptrgeom-&gt;p, V);</div>
<div class="line"><a name="l03777"></a><span class="lineno"> 3777</span>&#160;  r=V[1];</div>
<div class="line"><a name="l03778"></a><span class="lineno"> 3778</span>&#160;  th=V[2];</div>
<div class="line"><a name="l03779"></a><span class="lineno"> 3779</span>&#160;</div>
<div class="line"><a name="l03780"></a><span class="lineno"> 3780</span>&#160;  <span class="comment">// default</span></div>
<div class="line"><a name="l03781"></a><span class="lineno"> 3781</span>&#160;  prceiling[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>]=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>;</div>
<div class="line"><a name="l03782"></a><span class="lineno"> 3782</span>&#160;  prceiling[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>;</div>
<div class="line"><a name="l03783"></a><span class="lineno"> 3783</span>&#160;</div>
<div class="line"><a name="l03784"></a><span class="lineno"> 3784</span>&#160;</div>
<div class="line"><a name="l03785"></a><span class="lineno"> 3785</span>&#160;  <span class="keywordflow">if</span>(PRAD0&gt;=0.0) prfloor[PRAD0]=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a5bd9da451f108352614cbc457524c5b0">ERADLIMIT</a>;</div>
<div class="line"><a name="l03786"></a><span class="lineno"> 3786</span>&#160;</div>
<div class="line"><a name="l03788"></a><span class="lineno"> 3788</span>&#160;  <span class="comment">// scaling functions</span></div>
<div class="line"><a name="l03790"></a><span class="lineno"> 3790</span>&#160;<span class="comment"></span>  <span class="keywordflow">if</span>(1){ <span class="comment">// choice</span></div>
<div class="line"><a name="l03791"></a><span class="lineno"> 3791</span>&#160;    <span class="keywordflow">if</span>(rescaletype==0){</div>
<div class="line"><a name="l03792"></a><span class="lineno"> 3792</span>&#160;      <span class="comment">// to be like Bondi</span></div>
<div class="line"><a name="l03793"></a><span class="lineno"> 3793</span>&#160;</div>
<div class="line"><a name="l03794"></a><span class="lineno"> 3794</span>&#160;      <span class="comment">// even if d/dt-&gt;0 and d/dphi-&gt;0, this doesn&#39;t conserve E and L along magnetic flux lines in the funnel region.  This is bad!</span></div>
<div class="line"><a name="l03795"></a><span class="lineno"> 3795</span>&#160;      prfloor[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>] = <a class="code" href="../../d8/d5b/defs_8general_8h.html#a7b1907984bc130eb01fe29d3fc3c064b">prfloorcoef</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>]*pow(r, -1.5); </div>
<div class="line"><a name="l03796"></a><span class="lineno"> 3796</span>&#160;      prfloor[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>] = <a class="code" href="../../d8/d5b/defs_8general_8h.html#a7b1907984bc130eb01fe29d3fc3c064b">prfloorcoef</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]*pow(r,-2.5);</div>
<div class="line"><a name="l03797"></a><span class="lineno"> 3797</span>&#160;    }</div>
<div class="line"><a name="l03798"></a><span class="lineno"> 3798</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(rescaletype==1){</div>
<div class="line"><a name="l03799"></a><span class="lineno"> 3799</span>&#160;      <span class="comment">// to conserve E and L along magnetic lines, have b^2/\rho\sim const.</span></div>
<div class="line"><a name="l03800"></a><span class="lineno"> 3800</span>&#160;      prfloor[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>] = <a class="code" href="../../d8/d5b/defs_8general_8h.html#a7b1907984bc130eb01fe29d3fc3c064b">prfloorcoef</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>]*pow(r, -2.7);</div>
<div class="line"><a name="l03801"></a><span class="lineno"> 3801</span>&#160;      prfloor[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>] = <a class="code" href="../../d8/d5b/defs_8general_8h.html#a7b1907984bc130eb01fe29d3fc3c064b">prfloorcoef</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]*pow(r,-2.7) ;</div>
<div class="line"><a name="l03802"></a><span class="lineno"> 3802</span>&#160;    }</div>
<div class="line"><a name="l03803"></a><span class="lineno"> 3803</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(rescaletype==2){</div>
<div class="line"><a name="l03804"></a><span class="lineno"> 3804</span>&#160;      <span class="comment">// only set absolute limits and let density be set later</span></div>
<div class="line"><a name="l03805"></a><span class="lineno"> 3805</span>&#160;</div>
<div class="line"><a name="l03806"></a><span class="lineno"> 3806</span>&#160;      <span class="comment">// absolute limits determined by what density contrast can be handled by flux calculation.  This is at least limited by machine precision, but more likely an instability is generated for some  ratio of densities that&#39;s much smaller than machine precision.</span></div>
<div class="line"><a name="l03807"></a><span class="lineno"> 3807</span>&#160;</div>
<div class="line"><a name="l03808"></a><span class="lineno"> 3808</span>&#160;      <span class="comment">// we should fix absolute floor so that this point is not too much different than surrounding points.</span></div>
<div class="line"><a name="l03809"></a><span class="lineno"> 3809</span>&#160;      <span class="comment">// this is difficult because process depends on how done, so just set reasonable minimum</span></div>
<div class="line"><a name="l03810"></a><span class="lineno"> 3810</span>&#160;</div>
<div class="line"><a name="l03811"></a><span class="lineno"> 3811</span>&#160;      <span class="comment">// Bondi like</span></div>
<div class="line"><a name="l03812"></a><span class="lineno"> 3812</span>&#160;      <span class="comment">// coefficient should be small enough so that at outer radius the energy per baryon at infinity limit of (say) 100 can be maintained (b^2 \sim 0.01 r^{-2.7} for \rho=1 density maximum)</span></div>
<div class="line"><a name="l03813"></a><span class="lineno"> 3813</span>&#160;      <span class="comment">// these will do for rout=10^4</span></div>
<div class="line"><a name="l03814"></a><span class="lineno"> 3814</span>&#160;      <span class="comment">//      prfloor[RHO] = 1E-12*pow(r, -1.5);</span></div>
<div class="line"><a name="l03815"></a><span class="lineno"> 3815</span>&#160;      <span class="comment">//prfloor[UU] = 1E-14*prfloor[RHO]/r ;</span></div>
<div class="line"><a name="l03816"></a><span class="lineno"> 3816</span>&#160;      </div>
<div class="line"><a name="l03817"></a><span class="lineno"> 3817</span>&#160;</div>
<div class="line"><a name="l03818"></a><span class="lineno"> 3818</span>&#160;</div>
<div class="line"><a name="l03819"></a><span class="lineno"> 3819</span>&#160;</div>
<div class="line"><a name="l03820"></a><span class="lineno"> 3820</span>&#160;      <span class="comment">// now have U[UU] and U[PH]</span></div>
<div class="line"><a name="l03821"></a><span class="lineno"> 3821</span>&#160;      <span class="comment">// note that U[UU]/(gdet*rho*u^t) is conserved along field lines, even in non-ideal MHD, where A_{\phi} is still a good stream function in non-ideal MHD.</span></div>
<div class="line"><a name="l03822"></a><span class="lineno"> 3822</span>&#160;      <span class="comment">// same in terms of U[PH]</span></div>
<div class="line"><a name="l03823"></a><span class="lineno"> 3823</span>&#160;      <span class="comment">// this is really a coordinate dependent quantity, but if field lines connect to infinity, then this is the same at infinity.</span></div>
<div class="line"><a name="l03824"></a><span class="lineno"> 3824</span>&#160;</div>
<div class="line"><a name="l03825"></a><span class="lineno"> 3825</span>&#160;      <span class="comment">// Conserved quantity per baryon (or rest-mass unit)</span></div>
<div class="line"><a name="l03826"></a><span class="lineno"> 3826</span>&#160;      <span class="comment">//      PALLLOOP(k) Upbinf=U[k]/(ptrgeom-&gt;gdet * pr[RHO]*(q.ucon[TT]));</span></div>
<div class="line"><a name="l03827"></a><span class="lineno"> 3827</span>&#160;      <span class="comment">//Upbinf[UU]*=-1.0; // time component has - sign in this -+++ signature code</span></div>
<div class="line"><a name="l03828"></a><span class="lineno"> 3828</span>&#160;</div>
<div class="line"><a name="l03829"></a><span class="lineno"> 3829</span>&#160;      <span class="comment">// could inject mass or enthalpy, we choose mass for now since rho&gt;h typically (except at very edge of torus)</span></div>
<div class="line"><a name="l03830"></a><span class="lineno"> 3830</span>&#160;      prfloor[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>]=-U[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]/(ptrgeom-&gt;gdet * <a class="code" href="../../d8/d5b/defs_8general_8h.html#accef7ff74daca804b9a5a3ad7d3db882">GAMMAMAX</a> * (q-&gt;<a class="code" href="../../d1/d83/structof__state.html#aab723d3c7c2c48b7246cc7d7d5379eed">ucon</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>]));</div>
<div class="line"><a name="l03831"></a><span class="lineno"> 3831</span>&#160;      prfloor[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]=prfloor[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>]*0.01; <span class="comment">// cold injection</span></div>
<div class="line"><a name="l03832"></a><span class="lineno"> 3832</span>&#160;</div>
<div class="line"><a name="l03833"></a><span class="lineno"> 3833</span>&#160;    }</div>
<div class="line"><a name="l03834"></a><span class="lineno"> 3834</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(rescaletype==3){</div>
<div class="line"><a name="l03835"></a><span class="lineno"> 3835</span>&#160;      <span class="comment">// for dipole</span></div>
<div class="line"><a name="l03836"></a><span class="lineno"> 3836</span>&#160;      prfloor[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>] = <a class="code" href="../../d8/d5b/defs_8general_8h.html#a7b1907984bc130eb01fe29d3fc3c064b">prfloorcoef</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>]*pow(r/<a class="code" href="../../d8/d5b/defs_8general_8h.html#aede4c57c0916c7d1ba3760915a650067">Rin</a>, -5);</div>
<div class="line"><a name="l03837"></a><span class="lineno"> 3837</span>&#160;      prfloor[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>] = <a class="code" href="../../d8/d5b/defs_8general_8h.html#a7b1907984bc130eb01fe29d3fc3c064b">prfloorcoef</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]*pow(r/<a class="code" href="../../d8/d5b/defs_8general_8h.html#aede4c57c0916c7d1ba3760915a650067">Rin</a>,-6) ;</div>
<div class="line"><a name="l03838"></a><span class="lineno"> 3838</span>&#160;    }</div>
<div class="line"><a name="l03839"></a><span class="lineno"> 3839</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(rescaletype==4||rescaletype==5){</div>
<div class="line"><a name="l03840"></a><span class="lineno"> 3840</span>&#160;      <span class="comment">// for jet injection with maximum b^2/rho and b^2/u and maximum u/rho</span></div>
<div class="line"><a name="l03841"></a><span class="lineno"> 3841</span>&#160;      </div>
<div class="line"><a name="l03842"></a><span class="lineno"> 3842</span>&#160;      <span class="comment">// below uses max of present u and floor u since present u may be too small (or negative!) and then density comparison isn&#39;t consistent with final floor between u and rho</span></div>
<div class="line"><a name="l03843"></a><span class="lineno"> 3843</span>&#160;</div>
<div class="line"><a name="l03844"></a><span class="lineno"> 3844</span>&#160;      <span class="keywordflow">if</span>(0 &amp;&amp; <a class="code" href="../../d8/d5b/defs_8general_8h.html#a00bdeb72a08e745eb0a5482af9e8cb74">RESTARTMODE</a>==1){ <span class="comment">// not on by default  // choose</span></div>
<div class="line"><a name="l03845"></a><span class="lineno"> 3845</span>&#160;        <span class="comment">// temporarily used to restart if cleaned field or increased resolution of field, because in high b^2/rho or b^2/u regions, the field dissipation due to small-scale structure in the field leads to heating that can become relativistic and disrupt the solution</span></div>
<div class="line"><a name="l03846"></a><span class="lineno"> 3846</span>&#160;        <span class="comment">// Then also temporarily set UORHOLIMIT to 1.0 or some limiting thing</span></div>
<div class="line"><a name="l03847"></a><span class="lineno"> 3847</span>&#160;        <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> UORHOLIMITTEMP=0.5; <span class="comment">// choose</span></div>
<div class="line"><a name="l03848"></a><span class="lineno"> 3848</span>&#160;        <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> TRESTART=5930; <span class="comment">// choose</span></div>
<div class="line"><a name="l03849"></a><span class="lineno"> 3849</span>&#160;        <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> TRESTARTE=5921; <span class="comment">// choose</span></div>
<div class="line"><a name="l03850"></a><span class="lineno"> 3850</span>&#160;        <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> BSQORHOLIMITTEMP=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a0fe8d3c7642e667dd8ae3635506c4273">BSQORHOLIMIT</a>*2.0;</div>
<div class="line"><a name="l03851"></a><span class="lineno"> 3851</span>&#160;        <span class="keywordtype">int</span> POLESIZEE=8;</div>
<div class="line"><a name="l03852"></a><span class="lineno"> 3852</span>&#160;        <span class="keywordtype">int</span> POLESIZE=3;</div>
<div class="line"><a name="l03853"></a><span class="lineno"> 3853</span>&#160;        <span class="keywordflow">if</span>(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ae1ee1e1c83c3f70e2e1afed4f4f5b41e">t</a>&lt;TRESTARTE &amp;&amp; <a class="code" href="../../d2/dbf/metric_8h.html#a720c791e54d46bbf744b0e3ed7050947">ISSPCMCOORD</a>(<a class="code" href="../../da/d3e/definit_8h.html#ab343edb2f60f3de2d654dcf1c58e06a2" title="#else define MAXBND 3 endif">MCOORD</a>) &amp;&amp; (<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[2]+j&lt;POLESIZEE || <a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[2]+j&gt;<a class="code" href="../../dd/d46/mpidefs_8h.html#ab3efab8b1f2dffc5907e0b0a5aa3988f">totalsize</a>[2]-1-POLESIZEE)){</div>
<div class="line"><a name="l03854"></a><span class="lineno"> 3854</span>&#160;          <span class="comment">// temporarily allow much higher field due to very early adjustments in field near pole.  This avoids dumping mass into the pole at learly times.</span></div>
<div class="line"><a name="l03855"></a><span class="lineno"> 3855</span>&#160;          <span class="comment">// But don&#39;t let u_g respond to field at all</span></div>
<div class="line"><a name="l03856"></a><span class="lineno"> 3856</span>&#160;          prfloor[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>]=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(bsq/BSQORHOLIMITTEMP,SMALL);</div>
<div class="line"><a name="l03857"></a><span class="lineno"> 3857</span>&#160;          prfloor[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(pr[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>],UORHOLIMITTEMP*prfloor[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>]),SMALL);</div>
<div class="line"><a name="l03858"></a><span class="lineno"> 3858</span>&#160;        }</div>
<div class="line"><a name="l03859"></a><span class="lineno"> 3859</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ae1ee1e1c83c3f70e2e1afed4f4f5b41e">t</a>&lt;TRESTART){</div>
<div class="line"><a name="l03860"></a><span class="lineno"> 3860</span>&#160;          <span class="comment">//          if(t&lt;TRESTARTE &amp;&amp; ISSPCMCOORD(MCOORD) &amp;&amp; (startpos[2]+j&lt;=1 || startpos[2]+j&gt;=totalsize[2]-2)){</span></div>
<div class="line"><a name="l03861"></a><span class="lineno"> 3861</span>&#160;          <span class="comment">//            // don&#39;t allow floor injection of mass density related to u/rho during very early phase</span></div>
<div class="line"><a name="l03862"></a><span class="lineno"> 3862</span>&#160;          <span class="comment">//            prfloor[RHO]=MAX(bsq/BSQORHOLIMIT);</span></div>
<div class="line"><a name="l03863"></a><span class="lineno"> 3863</span>&#160;          <span class="comment">//            prfloor[UU]=MIN(pr[UU],UORHOLIMITTEMP*prfloor[RHO]);</span></div>
<div class="line"><a name="l03864"></a><span class="lineno"> 3864</span>&#160;          <span class="comment">//          }</span></div>
<div class="line"><a name="l03865"></a><span class="lineno"> 3865</span>&#160;          <span class="comment">//          else{</span></div>
<div class="line"><a name="l03866"></a><span class="lineno"> 3866</span>&#160;          <span class="comment">//          }</span></div>
<div class="line"><a name="l03867"></a><span class="lineno"> 3867</span>&#160;          <span class="comment">// don&#39;t allow floor injection of mass density related to u/rho during very early phase</span></div>
<div class="line"><a name="l03868"></a><span class="lineno"> 3868</span>&#160;          prfloor[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>]=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(bsq/<a class="code" href="../../d8/d5b/defs_8general_8h.html#a0fe8d3c7642e667dd8ae3635506c4273">BSQORHOLIMIT</a>,SMALL);</div>
<div class="line"><a name="l03869"></a><span class="lineno"> 3869</span>&#160;          prfloor[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(pr[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>],UORHOLIMITTEMP*prfloor[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>]),SMALL);</div>
<div class="line"><a name="l03870"></a><span class="lineno"> 3870</span>&#160;        }</div>
<div class="line"><a name="l03871"></a><span class="lineno"> 3871</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../d2/dbf/metric_8h.html#a720c791e54d46bbf744b0e3ed7050947">ISSPCMCOORD</a>(<a class="code" href="../../da/d3e/definit_8h.html#ab343edb2f60f3de2d654dcf1c58e06a2" title="#else define MAXBND 3 endif">MCOORD</a>) &amp;&amp; (<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[2]+j&lt;POLESIZE || <a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[2]+j&gt;<a class="code" href="../../dd/d46/mpidefs_8h.html#ab3efab8b1f2dffc5907e0b0a5aa3988f">totalsize</a>[2]-1-POLESIZE)){</div>
<div class="line"><a name="l03872"></a><span class="lineno"> 3872</span>&#160;          prfloor[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>]=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(bsq/<a class="code" href="../../d8/d5b/defs_8general_8h.html#a0fe8d3c7642e667dd8ae3635506c4273">BSQORHOLIMIT</a>,SMALL);</div>
<div class="line"><a name="l03873"></a><span class="lineno"> 3873</span>&#160;          <span class="comment">// still limit u near pole</span></div>
<div class="line"><a name="l03874"></a><span class="lineno"> 3874</span>&#160;          prfloor[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(pr[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>],UORHOLIMITTEMP*prfloor[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>]),SMALL);</div>
<div class="line"><a name="l03875"></a><span class="lineno"> 3875</span>&#160;          <span class="comment">//prceiling[UU]=MAX(prfloor[UU],MIN(prceiling[UU],UORHOLIMIT*MAX(pr[RHO],prfloor[RHO])));</span></div>
<div class="line"><a name="l03876"></a><span class="lineno"> 3876</span>&#160;        }</div>
<div class="line"><a name="l03877"></a><span class="lineno"> 3877</span>&#160;        <span class="keywordflow">else</span>{ <span class="comment">// NORMAL CASE when restarting,etc.</span></div>
<div class="line"><a name="l03878"></a><span class="lineno"> 3878</span>&#160;          prfloor[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>]=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(bsq/<a class="code" href="../../d8/d5b/defs_8general_8h.html#a0fe8d3c7642e667dd8ae3635506c4273">BSQORHOLIMIT</a>,SMALL);</div>
<div class="line"><a name="l03879"></a><span class="lineno"> 3879</span>&#160;          prfloor[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(bsq/<a class="code" href="../../d8/d5b/defs_8general_8h.html#a2ac5e41aa897e1fa82d748b7e38b9c6a">BSQOULIMIT</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a7a6f9a2927c5dc63051c63873b1fddc9">zerouuperbaryon</a>*<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(prfloor[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>],SMALL));</div>
<div class="line"><a name="l03880"></a><span class="lineno"> 3880</span>&#160;          <span class="comment">//          prfloor[UU]=MAX(MIN(MAX(pr[UU],prfloor[UU]),UORHOLIMIT*prfloor[RHO]),SMALL);</span></div>
<div class="line"><a name="l03881"></a><span class="lineno"> 3881</span>&#160;          prceiling[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(prfloor[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>],<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(prceiling[UU],<a class="code" href="../../d8/d5b/defs_8general_8h.html#a29e0b9f4e26a839ec5b98c698e90ca17">UORHOLIMIT</a>*<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(pr[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>],prfloor[RHO])));</div>
<div class="line"><a name="l03882"></a><span class="lineno"> 3882</span>&#160;</div>
<div class="line"><a name="l03883"></a><span class="lineno"> 3883</span>&#160;        }<span class="comment">// end NORMAL else conditional</span></div>
<div class="line"><a name="l03884"></a><span class="lineno"> 3884</span>&#160;      }</div>
<div class="line"><a name="l03885"></a><span class="lineno"> 3885</span>&#160;      <span class="keywordflow">else</span>{ <span class="comment">// FULLY NORMAL CASE</span></div>
<div class="line"><a name="l03886"></a><span class="lineno"> 3886</span>&#160;        prfloor[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>]=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(bsq/<a class="code" href="../../d8/d5b/defs_8general_8h.html#a0fe8d3c7642e667dd8ae3635506c4273">BSQORHOLIMIT</a>,SMALL);</div>
<div class="line"><a name="l03887"></a><span class="lineno"> 3887</span>&#160;        prfloor[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(bsq/<a class="code" href="../../d8/d5b/defs_8general_8h.html#a2ac5e41aa897e1fa82d748b7e38b9c6a">BSQOULIMIT</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a7a6f9a2927c5dc63051c63873b1fddc9">zerouuperbaryon</a>*<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(prfloor[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>],SMALL));</div>
<div class="line"><a name="l03888"></a><span class="lineno"> 3888</span>&#160;        <span class="comment">//        prfloor[UU]=MAX(MIN(MAX(pr[UU],prfloor[UU]),UORHOLIMIT*prfloor[RHO]),SMALL);</span></div>
<div class="line"><a name="l03889"></a><span class="lineno"> 3889</span>&#160;        prceiling[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(prfloor[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>],<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(prceiling[UU],<a class="code" href="../../d8/d5b/defs_8general_8h.html#a29e0b9f4e26a839ec5b98c698e90ca17">UORHOLIMIT</a>*<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(pr[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>],prfloor[RHO])));</div>
<div class="line"><a name="l03890"></a><span class="lineno"> 3890</span>&#160;</div>
<div class="line"><a name="l03891"></a><span class="lineno"> 3891</span>&#160;        <span class="keywordflow">if</span>(rescaletype==5){<span class="comment">//WALD</span></div>
<div class="line"><a name="l03892"></a><span class="lineno"> 3892</span>&#160;          <span class="keywordflow">if</span>(1){</div>
<div class="line"><a name="l03893"></a><span class="lineno"> 3893</span>&#160;            <span class="comment">// do nothing, so constant bsq/rho</span></div>
<div class="line"><a name="l03894"></a><span class="lineno"> 3894</span>&#160;          }</div>
<div class="line"><a name="l03895"></a><span class="lineno"> 3895</span>&#160;          <span class="keywordflow">if</span>(0){</div>
<div class="line"><a name="l03896"></a><span class="lineno"> 3896</span>&#160;            <span class="keywordflow">if</span>(r&gt;500.0){</div>
<div class="line"><a name="l03897"></a><span class="lineno"> 3897</span>&#160;              prfloor[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>]*=pow(500,-1.5);</div>
<div class="line"><a name="l03898"></a><span class="lineno"> 3898</span>&#160;              prfloor[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]*=pow(500,-2.5);</div>
<div class="line"><a name="l03899"></a><span class="lineno"> 3899</span>&#160;            }</div>
<div class="line"><a name="l03900"></a><span class="lineno"> 3900</span>&#160;            <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l03901"></a><span class="lineno"> 3901</span>&#160;              prfloor[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>]*=(pow(r,-1.5)+pow(500,-1.5));</div>
<div class="line"><a name="l03902"></a><span class="lineno"> 3902</span>&#160;              prfloor[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]*=(pow(r,-2.5)+pow(500,-2.5));</div>
<div class="line"><a name="l03903"></a><span class="lineno"> 3903</span>&#160;            }</div>
<div class="line"><a name="l03904"></a><span class="lineno"> 3904</span>&#160;          }</div>
<div class="line"><a name="l03905"></a><span class="lineno"> 3905</span>&#160;          <span class="keywordflow">if</span>(0){</div>
<div class="line"><a name="l03906"></a><span class="lineno"> 3906</span>&#160;            <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> <a class="code" href="../../d8/d5b/defs_8general_8h.html#abf002e87ba3ed4d3c9dcc98216e6d9d6">R</a>=r*sin(th);</div>
<div class="line"><a name="l03907"></a><span class="lineno"> 3907</span>&#160;            <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Z=fabs(r*cos(th));</div>
<div class="line"><a name="l03908"></a><span class="lineno"> 3908</span>&#160;            <span class="keywordflow">if</span>(Z&gt;500.0){</div>
<div class="line"><a name="l03909"></a><span class="lineno"> 3909</span>&#160;              prfloor[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>]*=pow(500,-1.5);</div>
<div class="line"><a name="l03910"></a><span class="lineno"> 3910</span>&#160;              prfloor[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]*=pow(500,-2.5);</div>
<div class="line"><a name="l03911"></a><span class="lineno"> 3911</span>&#160;            }</div>
<div class="line"><a name="l03912"></a><span class="lineno"> 3912</span>&#160;            <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l03913"></a><span class="lineno"> 3913</span>&#160;              prfloor[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>]*=pow(Z,-1.5);</div>
<div class="line"><a name="l03914"></a><span class="lineno"> 3914</span>&#160;              prfloor[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]*=pow(Z,-2.5);</div>
<div class="line"><a name="l03915"></a><span class="lineno"> 3915</span>&#160;            }</div>
<div class="line"><a name="l03916"></a><span class="lineno"> 3916</span>&#160;          }</div>
<div class="line"><a name="l03917"></a><span class="lineno"> 3917</span>&#160;          <span class="keywordflow">if</span>(0){ <span class="comment">// WALD TEST</span></div>
<div class="line"><a name="l03918"></a><span class="lineno"> 3918</span>&#160;            <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> R=r*sin(th);</div>
<div class="line"><a name="l03919"></a><span class="lineno"> 3919</span>&#160;            <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Z=fabs(r*cos(th));</div>
<div class="line"><a name="l03920"></a><span class="lineno"> 3920</span>&#160;            prfloor[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>]*=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(1.0/(pow(Z,1.5)*pow(R,-1.5)),1.0);</div>
<div class="line"><a name="l03921"></a><span class="lineno"> 3921</span>&#160;            prfloor[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]*=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(1.0/(pow(Z,2.5)*pow(R,-2.5)),1.0);</div>
<div class="line"><a name="l03922"></a><span class="lineno"> 3922</span>&#160;          }</div>
<div class="line"><a name="l03923"></a><span class="lineno"> 3923</span>&#160;</div>
<div class="line"><a name="l03924"></a><span class="lineno"> 3924</span>&#160;        }<span class="comment">// end rescapetype==5</span></div>
<div class="line"><a name="l03925"></a><span class="lineno"> 3925</span>&#160;      }<span class="comment">// else NORMAL case</span></div>
<div class="line"><a name="l03926"></a><span class="lineno"> 3926</span>&#160;</div>
<div class="line"><a name="l03927"></a><span class="lineno"> 3927</span>&#160;</div>
<div class="line"><a name="l03928"></a><span class="lineno"> 3928</span>&#160;</div>
<div class="line"><a name="l03929"></a><span class="lineno"> 3929</span>&#160;    }<span class="comment">// end rescaletype==4 || rescaletype==5</span></div>
<div class="line"><a name="l03930"></a><span class="lineno"> 3930</span>&#160;  }</div>
<div class="line"><a name="l03931"></a><span class="lineno"> 3931</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l03932"></a><span class="lineno"> 3932</span>&#160;    prfloor[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>] = <a class="code" href="../../d8/d5b/defs_8general_8h.html#a7ea29d2d3d2dedf13e5530aae75489db">RHOMIN</a>*pow(r, -2.0);</div>
<div class="line"><a name="l03933"></a><span class="lineno"> 3933</span>&#160;    prfloor[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>] = <a class="code" href="../../d8/d5b/defs_8general_8h.html#a5f145b29adcf588cf7f2821cb5c9302f">UUMIN</a>*prfloor[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>] ;</div>
<div class="line"><a name="l03934"></a><span class="lineno"> 3934</span>&#160;  }</div>
<div class="line"><a name="l03935"></a><span class="lineno"> 3935</span>&#160;  </div>
<div class="line"><a name="l03936"></a><span class="lineno"> 3936</span>&#160;  <span class="comment">// KORALTODO: Maybe implement floor to ERAD relative to other energy densities like how handle UU and BSQ relative to RHO.</span></div>
<div class="line"><a name="l03937"></a><span class="lineno"> 3937</span>&#160;</div>
<div class="line"><a name="l03938"></a><span class="lineno"> 3938</span>&#160;</div>
<div class="line"><a name="l03939"></a><span class="lineno"> 3939</span>&#160;</div>
<div class="line"><a name="l03940"></a><span class="lineno"> 3940</span>&#160;</div>
<div class="line"><a name="l03941"></a><span class="lineno"> 3941</span>&#160;</div>
<div class="line"><a name="l03942"></a><span class="lineno"> 3942</span>&#160;</div>
<div class="line"><a name="l03943"></a><span class="lineno"> 3943</span>&#160;  <span class="comment">// some old attempts</span></div>
<div class="line"><a name="l03944"></a><span class="lineno"> 3944</span>&#160;  <span class="comment">/*</span></div>
<div class="line"><a name="l03945"></a><span class="lineno"> 3945</span>&#160;<span class="comment">    if(0){ // choice</span></div>
<div class="line"><a name="l03946"></a><span class="lineno"> 3946</span>&#160;<span class="comment">    ftempA=(RHOMAX+RHOMIN)*0.5/RHOMIN;</span></div>
<div class="line"><a name="l03947"></a><span class="lineno"> 3947</span>&#160;<span class="comment">    ftempB=(RHOMAX-RHOMIN)*0.5/RHOMIN;</span></div>
<div class="line"><a name="l03948"></a><span class="lineno"> 3948</span>&#160;<span class="comment">    // choice</span></div>
<div class="line"><a name="l03949"></a><span class="lineno"> 3949</span>&#160;<span class="comment">    if(1) rhotscal = ftempA+ftempB*cos(2.0*M_PI*X[2]);</span></div>
<div class="line"><a name="l03950"></a><span class="lineno"> 3950</span>&#160;<span class="comment">    else  rhotscal = ftempA+ftempB*cos(2.0*M_PI*th);</span></div>
<div class="line"><a name="l03951"></a><span class="lineno"> 3951</span>&#160;<span class="comment">    ftempA=(UUMAX+UUMIN)*0.5/UUMIN;</span></div>
<div class="line"><a name="l03952"></a><span class="lineno"> 3952</span>&#160;<span class="comment">    // choice (make same as above)</span></div>
<div class="line"><a name="l03953"></a><span class="lineno"> 3953</span>&#160;<span class="comment">    ftempB=(UUMAX-UUMIN)*0.5/UUMIN;</span></div>
<div class="line"><a name="l03954"></a><span class="lineno"> 3954</span>&#160;<span class="comment">    if(1) uutscal = ftempA+ftempB*cos(2.0*M_PI*X[2]);</span></div>
<div class="line"><a name="l03955"></a><span class="lineno"> 3955</span>&#160;<span class="comment">    else  uutscal = ftempA+ftempB*cos(2.0*M_PI*th);</span></div>
<div class="line"><a name="l03956"></a><span class="lineno"> 3956</span>&#160;<span class="comment">    }</span></div>
<div class="line"><a name="l03957"></a><span class="lineno"> 3957</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03958"></a><span class="lineno"> 3958</span>&#160;<span class="comment">    //    else{</span></div>
<div class="line"><a name="l03959"></a><span class="lineno"> 3959</span>&#160;<span class="comment">    if(1){ </span></div>
<div class="line"><a name="l03960"></a><span class="lineno"> 3960</span>&#160;<span class="comment">    rhotscal = 1.0;</span></div>
<div class="line"><a name="l03961"></a><span class="lineno"> 3961</span>&#160;<span class="comment">    uutscal = 1.0;</span></div>
<div class="line"><a name="l03962"></a><span class="lineno"> 3962</span>&#160;<span class="comment">    }</span></div>
<div class="line"><a name="l03963"></a><span class="lineno"> 3963</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03964"></a><span class="lineno"> 3964</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03965"></a><span class="lineno"> 3965</span>&#160;<span class="comment">    prfloor[UU] = UUMIN*uurscal*uutscal;</span></div>
<div class="line"><a name="l03966"></a><span class="lineno"> 3966</span>&#160;<span class="comment">    prfloor[RHO] = RHOMIN*rhorscal*rhotscal;</span></div>
<div class="line"><a name="l03967"></a><span class="lineno"> 3967</span>&#160;<span class="comment">  */</span></div>
<div class="line"><a name="l03968"></a><span class="lineno"> 3968</span>&#160;</div>
<div class="line"><a name="l03969"></a><span class="lineno"> 3969</span>&#160;</div>
<div class="line"><a name="l03970"></a><span class="lineno"> 3970</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l03971"></a><span class="lineno"> 3971</span>&#160;}</div>
<div class="line"><a name="l03972"></a><span class="lineno"> 3972</span>&#160;</div>
<div class="line"><a name="l03973"></a><span class="lineno"> 3973</span>&#160;</div>
<div class="line"><a name="l03974"></a><span class="lineno"> 3974</span>&#160;</div>
<div class="line"><a name="l03975"></a><span class="lineno"><a class="code" href="../../de/d95/fixup_8c.html#ab5613183105f2fc9394342944634ce8b"> 3975</a></span>&#160;<span class="preprocessor">#define FLOORDAMPFRAC (0.1)</span></div>
<div class="line"><a name="l03976"></a><span class="lineno"><a class="code" href="../../de/d95/fixup_8c.html#aa1e1e88a797d7ba653dfb514c0ad9513"> 3976</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define NUMBSQFLAGS 5</span></div>
<div class="line"><a name="l03977"></a><span class="lineno"> 3977</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l03979"></a><span class="lineno"> 3979</span>&#160;<span class="keywordtype">int</span> get_bsqflags(<span class="keywordtype">int</span> stage, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pv)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR])</div>
<div class="line"><a name="l03980"></a><span class="lineno"> 3980</span>&#160;{</div>
<div class="line"><a name="l03981"></a><span class="lineno"> 3981</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>,<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>,k;</div>
<div class="line"><a name="l03982"></a><span class="lineno"> 3982</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> <a class="code" href="../../d1/d83/structof__state.html#a2b38c522ec7321af3368706fa4632834">bsq</a>;</div>
<div class="line"><a name="l03983"></a><span class="lineno"> 3983</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> q;</div>
<div class="line"><a name="l03984"></a><span class="lineno"> 3984</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gamma,X[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>],V[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l03985"></a><span class="lineno"> 3985</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> qsq;</div>
<div class="line"><a name="l03986"></a><span class="lineno"> 3986</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> prfloor[NPR];</div>
<div class="line"><a name="l03987"></a><span class="lineno"> 3987</span>&#160;  <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> flags[<a class="code" href="../../de/d95/fixup_8c.html#aa1e1e88a797d7ba653dfb514c0ad9513">NUMBSQFLAGS</a>]={0};</div>
<div class="line"><a name="l03988"></a><span class="lineno"> 3988</span>&#160;  <span class="keywordtype">int</span> limgen;</div>
<div class="line"><a name="l03989"></a><span class="lineno"> 3989</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> geomdontuse;</div>
<div class="line"><a name="l03990"></a><span class="lineno"> 3990</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom=&amp;geomdontuse;</div>
<div class="line"><a name="l03991"></a><span class="lineno"> 3991</span>&#160;  <span class="keywordtype">int</span> loc=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8936711f57f82d1fc75c21fa2894e1c6">CENT</a>;</div>
<div class="line"><a name="l03992"></a><span class="lineno"> 3992</span>&#160;</div>
<div class="line"><a name="l03993"></a><span class="lineno"> 3993</span>&#160;</div>
<div class="line"><a name="l03994"></a><span class="lineno"> 3994</span>&#160;</div>
<div class="line"><a name="l03995"></a><span class="lineno"> 3995</span>&#160;</div>
<div class="line"><a name="l03996"></a><span class="lineno"> 3996</span>&#160;  <span class="comment">//  if((CHECKSOLUTION==0)&amp;&amp;(LIMADJUST==0)&amp;&amp;(FLUXADJUST==0)) return(0); // otherwise do it</span></div>
<div class="line"><a name="l03997"></a><span class="lineno"> 3997</span>&#160;  <span class="comment">// fixup_checksolution() only uses failure flag right now</span></div>
<div class="line"><a name="l03998"></a><span class="lineno"> 3998</span>&#160;  <span class="keywordflow">if</span>((<a class="code" href="../../da/d3e/definit_8h.html#ad0b6e48e02378f461462c8f802915a50" title="whether to control the limiter">LIMADJUST</a>==0)&amp;&amp;(<a class="code" href="../../da/d3e/definit_8h.html#a2f3f15de5e0b2c16a3ff30317badb3d9" title="determine how flux is computed per zone">FLUXADJUST</a>==0)) <span class="keywordflow">return</span>(0); <span class="comment">// otherwise do it</span></div>
<div class="line"><a name="l03999"></a><span class="lineno"> 3999</span>&#160;</div>
<div class="line"><a name="l04000"></a><span class="lineno"> 4000</span>&#160;</div>
<div class="line"><a name="l04001"></a><span class="lineno"> 4001</span>&#160;</div>
<div class="line"><a name="l04002"></a><span class="lineno"> 4002</span>&#160;  <span class="comment">// temporary hack</span></div>
<div class="line"><a name="l04003"></a><span class="lineno"> 4003</span>&#160;  limgen=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a817404fd8a61abc2300c378e1eb2d122">lim</a>[1],<a class="code" href="../../d8/d5b/defs_8general_8h.html#a817404fd8a61abc2300c378e1eb2d122">lim</a>[2]),<a class="code" href="../../d8/d5b/defs_8general_8h.html#a817404fd8a61abc2300c378e1eb2d122">lim</a>[3]); <span class="comment">// not reached if((LIMADJUST==0)&amp;&amp;(FLUXADJUST==0))</span></div>
<div class="line"><a name="l04004"></a><span class="lineno"> 4004</span>&#160;</div>
<div class="line"><a name="l04005"></a><span class="lineno"> 4005</span>&#160;</div>
<div class="line"><a name="l04006"></a><span class="lineno"> 4006</span>&#160;</div>
<div class="line"><a name="l04007"></a><span class="lineno"> 4007</span>&#160;  <a class="code" href="../../df/da8/global_8comploops_8h.html#aee39ae9b4652df6d37e7151398612e11">COMPDQZLOOP</a> { <span class="comment">// over range wspeed and dq are computed // OPENMPOPTMARK: Could optimize this, but not using it currently</span></div>
<div class="line"><a name="l04008"></a><span class="lineno"> 4008</span>&#160;</div>
<div class="line"><a name="l04009"></a><span class="lineno"> 4009</span>&#160;    <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a3059ed7bfcfb692cbe8014d55fd7c1e4">get_geometry</a>(i, j, k, loc, ptrgeom);</div>
<div class="line"><a name="l04010"></a><span class="lineno"> 4010</span>&#160;</div>
<div class="line"><a name="l04011"></a><span class="lineno"> 4011</span>&#160;</div>
<div class="line"><a name="l04012"></a><span class="lineno"> 4012</span>&#160;<span class="preprocessor">#if(DOEVOLVERHO)</span></div>
<div class="line"><a name="l04013"></a><span class="lineno"> 4013</span>&#160;<span class="preprocessor"></span>    <span class="comment">// b^2</span></div>
<div class="line"><a name="l04014"></a><span class="lineno"> 4014</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a11e17cd8b0594d1ad52e3594aa9f477e" title="find ucon, ucov, bcon, bcov from primitive variables when calling get_state, users of this function e...">get_state</a>(<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(pv,i,j,k), ptrgeom, &amp;q) &gt;= 1)</div>
<div class="line"><a name="l04015"></a><span class="lineno"> 4015</span>&#160;      <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a5febb92786c5f7a1479e7e65f1c23ef3">FAILSTATEMENT</a>(<span class="stringliteral">&quot;fixup.c:get_bsqflags()&quot;</span>, <span class="stringliteral">&quot;get_state()&quot;</span>, 1);</div>
<div class="line"><a name="l04016"></a><span class="lineno"> 4016</span>&#160;    bsq = <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a7aac0a38641f2d6b53549677fa052a79">dot</a>(q.<a class="code" href="../../d1/d83/structof__state.html#a9a5aa459c68ba51073dd9a245c1a7798">bcon</a>, q.<a class="code" href="../../d1/d83/structof__state.html#a60ad0baeb54ce3584309ba5567a72f41">bcov</a>);</div>
<div class="line"><a name="l04017"></a><span class="lineno"> 4017</span>&#160;    <span class="comment">// initial</span></div>
<div class="line"><a name="l04018"></a><span class="lineno"> 4018</span>&#160;    GLOBALMACP0A1(pflag,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6bd0bc5c69aac300e7bb3288d288cae1">FLAGBSQORHO</a>)=0;</div>
<div class="line"><a name="l04019"></a><span class="lineno"> 4019</span>&#160;</div>
<div class="line"><a name="l04020"></a><span class="lineno"> 4020</span>&#160;    <span class="comment">// now do checks 10/31/2003 : constants fixed based upon accretion</span></div>
<div class="line"><a name="l04021"></a><span class="lineno"> 4021</span>&#160;    <span class="comment">// models and locations of disk, corona, and funnel (b^2/rho&gt;1)</span></div>
<div class="line"><a name="l04022"></a><span class="lineno"> 4022</span>&#160;</div>
<div class="line"><a name="l04023"></a><span class="lineno"> 4023</span>&#160;    <span class="comment">// b^2/\rho</span></div>
<div class="line"><a name="l04024"></a><span class="lineno"> 4024</span>&#160;    <span class="keywordflow">if</span>(bsq/<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>)&gt;<a class="code" href="../../d8/d5b/defs_8general_8h.html#a0fe8d3c7642e667dd8ae3635506c4273">BSQORHOLIMIT</a>) flags[0]=2;</div>
<div class="line"><a name="l04025"></a><span class="lineno"> 4025</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(bsq/<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>)&gt;0.9*<a class="code" href="../../d8/d5b/defs_8general_8h.html#a0fe8d3c7642e667dd8ae3635506c4273">BSQORHOLIMIT</a>) flags[0]=1;</div>
<div class="line"><a name="l04026"></a><span class="lineno"> 4026</span>&#160;    <span class="keywordflow">else</span> flags[0]=0;</div>
<div class="line"><a name="l04027"></a><span class="lineno"> 4027</span>&#160;</div>
<div class="line"><a name="l04028"></a><span class="lineno"> 4028</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l04029"></a><span class="lineno"> 4029</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l04030"></a><span class="lineno"> 4030</span>&#160;    <span class="comment">// KORALTODO: Maybe implement floor to ERAD relative to other energy densities like how handle UU and BSQ relative to RHO.</span></div>
<div class="line"><a name="l04031"></a><span class="lineno"> 4031</span>&#160;</div>
<div class="line"><a name="l04032"></a><span class="lineno"> 4032</span>&#160;</div>
<div class="line"><a name="l04033"></a><span class="lineno"> 4033</span>&#160;<span class="preprocessor">#if(DOEVOLVEUU)</span></div>
<div class="line"><a name="l04034"></a><span class="lineno"> 4034</span>&#160;<span class="preprocessor"></span>    <span class="comment">// b^2/u</span></div>
<div class="line"><a name="l04035"></a><span class="lineno"> 4035</span>&#160;</div>
<div class="line"><a name="l04036"></a><span class="lineno"> 4036</span>&#160;    <span class="keywordflow">if</span>(bsq/<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,UU)&gt;<a class="code" href="../../d8/d5b/defs_8general_8h.html#a2ac5e41aa897e1fa82d748b7e38b9c6a">BSQOULIMIT</a>) flags[3]=2;</div>
<div class="line"><a name="l04037"></a><span class="lineno"> 4037</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(bsq/<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,UU)&gt;0.9*<a class="code" href="../../d8/d5b/defs_8general_8h.html#a2ac5e41aa897e1fa82d748b7e38b9c6a">BSQOULIMIT</a>) flags[3]=1;</div>
<div class="line"><a name="l04038"></a><span class="lineno"> 4038</span>&#160;    <span class="keywordflow">else</span> flags[3]=0;</div>
<div class="line"><a name="l04039"></a><span class="lineno"> 4039</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l04040"></a><span class="lineno"> 4040</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l04041"></a><span class="lineno"> 4041</span>&#160;</div>
<div class="line"><a name="l04042"></a><span class="lineno"> 4042</span>&#160;</div>
<div class="line"><a name="l04043"></a><span class="lineno"> 4043</span>&#160;<span class="preprocessor">#if(WHICHVEL==VELREL4)</span></div>
<div class="line"><a name="l04044"></a><span class="lineno"> 4044</span>&#160;<span class="preprocessor"></span>    <span class="comment">// gamma</span></div>
<div class="line"><a name="l04045"></a><span class="lineno"> 4045</span>&#160;    <span class="keywordflow">if</span>(gamma_calc(<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(pv,i,j,k),ptrgeom,&amp;gamma,&amp;qsq)&gt;=1){</div>
<div class="line"><a name="l04046"></a><span class="lineno"> 4046</span>&#160;      dualfprintf(fail_file,<span class="stringliteral">&quot;gamma calc failed: get_bsqflags\n&quot;</span>);</div>
<div class="line"><a name="l04047"></a><span class="lineno"> 4047</span>&#160;      <span class="keywordflow">if</span> (fail(i,j,k,loc,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab80e0a4ad12720e26d9e904b4796ec14">FAIL_UTCALC_DISCR</a>) &gt;= 1)</div>
<div class="line"><a name="l04048"></a><span class="lineno"> 4048</span>&#160;        <span class="keywordflow">return</span> (1);</div>
<div class="line"><a name="l04049"></a><span class="lineno"> 4049</span>&#160;    }</div>
<div class="line"><a name="l04050"></a><span class="lineno"> 4050</span>&#160;    <span class="comment">// \gamma relative to 4-velocity</span></div>
<div class="line"><a name="l04051"></a><span class="lineno"> 4051</span>&#160;    <span class="keywordflow">if</span>(gamma&gt;2.0*<a class="code" href="../../d8/d5b/defs_8general_8h.html#acfae75775b104373e85c66288d127747">GAMMADAMP</a>) flags[1]=2;</div>
<div class="line"><a name="l04052"></a><span class="lineno"> 4052</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(gamma&gt;<a class="code" href="../../d8/d5b/defs_8general_8h.html#acfae75775b104373e85c66288d127747">GAMMADAMP</a>) flags[1]=1;</div>
<div class="line"><a name="l04053"></a><span class="lineno"> 4053</span>&#160;    <span class="keywordflow">else</span> flags[1]=0;</div>
<div class="line"><a name="l04054"></a><span class="lineno"> 4054</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l04055"></a><span class="lineno"> 4055</span>&#160;<span class="preprocessor"></span>    <span class="comment">// these density mod on limiters may be too much diffusivity in otherwise ok regions</span></div>
<div class="line"><a name="l04056"></a><span class="lineno"> 4056</span>&#160;</div>
<div class="line"><a name="l04057"></a><span class="lineno"> 4057</span>&#160;</div>
<div class="line"><a name="l04058"></a><span class="lineno"> 4058</span>&#160;<span class="preprocessor">#if(0)</span></div>
<div class="line"><a name="l04059"></a><span class="lineno"> 4059</span>&#160;<span class="preprocessor"></span>    <span class="comment">// density floors</span></div>
<div class="line"><a name="l04060"></a><span class="lineno"> 4060</span>&#160;    set_density_floors(ptrgeom,<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(pv,i,j,k),prfloor,prceiling);</div>
<div class="line"><a name="l04061"></a><span class="lineno"> 4061</span>&#160;    <span class="comment">// rho/rho_{fl}    </span></div>
<div class="line"><a name="l04062"></a><span class="lineno"> 4062</span>&#160;    <span class="comment">// GODMARK, 0.1 here    </span></div>
<div class="line"><a name="l04063"></a><span class="lineno"> 4063</span>&#160;    <span class="keywordflow">if</span>(prfloor[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>]/<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>)&gt;<a class="code" href="../../de/d95/fixup_8c.html#ab5613183105f2fc9394342944634ce8b">FLOORDAMPFRAC</a>) flags[2]=2;</div>
<div class="line"><a name="l04064"></a><span class="lineno"> 4064</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(prfloor[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>]/<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>)&gt;0.1*<a class="code" href="../../de/d95/fixup_8c.html#ab5613183105f2fc9394342944634ce8b">FLOORDAMPFRAC</a>) flags[2]=1;</div>
<div class="line"><a name="l04065"></a><span class="lineno"> 4065</span>&#160;    <span class="keywordflow">else</span> flags[2]=0;</div>
<div class="line"><a name="l04066"></a><span class="lineno"> 4066</span>&#160;</div>
<div class="line"><a name="l04067"></a><span class="lineno"> 4067</span>&#160;    <span class="comment">// u/u_{fl}</span></div>
<div class="line"><a name="l04068"></a><span class="lineno"> 4068</span>&#160;</div>
<div class="line"><a name="l04069"></a><span class="lineno"> 4069</span>&#160;    <span class="keywordflow">if</span>(prfloor[UU]/<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,UU)&gt;<a class="code" href="../../de/d95/fixup_8c.html#ab5613183105f2fc9394342944634ce8b">FLOORDAMPFRAC</a>) flags[4]=2;</div>
<div class="line"><a name="l04070"></a><span class="lineno"> 4070</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(prfloor[UU]/<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pv,i,j,k,UU)&gt;0.1*<a class="code" href="../../de/d95/fixup_8c.html#ab5613183105f2fc9394342944634ce8b">FLOORDAMPFRAC</a>) flags[4]=1;</div>
<div class="line"><a name="l04071"></a><span class="lineno"> 4071</span>&#160;    <span class="keywordflow">else</span> flags[4]=0;</div>
<div class="line"><a name="l04072"></a><span class="lineno"> 4072</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l04073"></a><span class="lineno"> 4073</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l04074"></a><span class="lineno"> 4074</span>&#160;</div>
<div class="line"><a name="l04075"></a><span class="lineno"> 4075</span>&#160;    <span class="comment">// now check our flag state</span></div>
<div class="line"><a name="l04076"></a><span class="lineno"> 4076</span>&#160;    GLOBALMACP0A1(pflag,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6bd0bc5c69aac300e7bb3288d288cae1">FLAGBSQORHO</a>)=flags[0];</div>
<div class="line"><a name="l04077"></a><span class="lineno"> 4077</span>&#160;    GLOBALMACP0A1(pflag,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ada3aa0ac5659d0901f7f5f447e7743a3">FLAGBSQOU</a>)=flags[3];</div>
<div class="line"><a name="l04078"></a><span class="lineno"> 4078</span>&#160;</div>
<div class="line"><a name="l04079"></a><span class="lineno"> 4079</span>&#160;</div>
<div class="line"><a name="l04080"></a><span class="lineno"> 4080</span>&#160;<span class="preprocessor">#if(LIMADJUST&gt;0)</span></div>
<div class="line"><a name="l04081"></a><span class="lineno"> 4081</span>&#160;<span class="preprocessor"></span>    <span class="comment">// now check our flag state</span></div>
<div class="line"><a name="l04082"></a><span class="lineno"> 4082</span>&#160;    <span class="keywordflow">if</span>((flags[0]==2)||(flags[1]==2)||(flags[2]==2)||(flags[3]==2)||(flags[4]==2)){ GLOBALMACP0A1(pflag,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a70d61b88b6c49b814ea87fee29fa96d2" title="NON-FAILURE FLAGS the below flags are done after bound_prim, and can be determined at any time...">FLAGREALLIM</a>)=limgen-1; }</div>
<div class="line"><a name="l04083"></a><span class="lineno"> 4083</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>((flags[0]==1)||(flags[1]==1)||(flags[2]==1)||(flags[3]==1)||(flags[4]==1)){ GLOBALMACP0A1(pflag,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a70d61b88b6c49b814ea87fee29fa96d2" title="NON-FAILURE FLAGS the below flags are done after bound_prim, and can be determined at any time...">FLAGREALLIM</a>)=limgen-1; }</div>
<div class="line"><a name="l04084"></a><span class="lineno"> 4084</span>&#160;    <span class="keywordflow">else</span>{GLOBALMACP0A1(pflag,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a70d61b88b6c49b814ea87fee29fa96d2" title="NON-FAILURE FLAGS the below flags are done after bound_prim, and can be determined at any time...">FLAGREALLIM</a>)=limgen;}</div>
<div class="line"><a name="l04085"></a><span class="lineno"> 4085</span>&#160;    <span class="keywordflow">if</span>(GLOBALMACP0A1(pflag,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a70d61b88b6c49b814ea87fee29fa96d2" title="NON-FAILURE FLAGS the below flags are done after bound_prim, and can be determined at any time...">FLAGREALLIM</a>)&lt;0) GLOBALMACP0A1(pflag,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a70d61b88b6c49b814ea87fee29fa96d2" title="NON-FAILURE FLAGS the below flags are done after bound_prim, and can be determined at any time...">FLAGREALLIM</a>)=0;</div>
<div class="line"><a name="l04086"></a><span class="lineno"> 4086</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l04087"></a><span class="lineno"> 4087</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l04088"></a><span class="lineno"> 4088</span>&#160;<span class="preprocessor">#if(FLUXADJUST&gt;0)</span></div>
<div class="line"><a name="l04089"></a><span class="lineno"> 4089</span>&#160;<span class="preprocessor"></span>    <span class="comment">// now check our flag state</span></div>
<div class="line"><a name="l04090"></a><span class="lineno"> 4090</span>&#160;    <span class="keywordflow">if</span>((flags[0]==2)||(flags[1]==2)||(flags[2]==2)||(flags[3]==2)||(flags[4]==2)){ GLOBALMACP0A1(pflag,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ad6af3c16d5f7d7324b05736dfe946e5a">FLAGREALFLUX</a>)=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a6b32259475937e434b03862c64fb86a3">fluxmethod</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>]-1;}</div>
<div class="line"><a name="l04091"></a><span class="lineno"> 4091</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>((flags[0]==1)||(flags[1]==1)||(flags[2]==1)||(flags[3]==1)||(flags[4]==1)){ GLOBALMACP0A1(pflag,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ad6af3c16d5f7d7324b05736dfe946e5a">FLAGREALFLUX</a>)=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a6b32259475937e434b03862c64fb86a3">fluxmethod</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>]; }</div>
<div class="line"><a name="l04092"></a><span class="lineno"> 4092</span>&#160;    <span class="keywordflow">else</span>{GLOBALMACP0A1(pflag,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ad6af3c16d5f7d7324b05736dfe946e5a">FLAGREALFLUX</a>)=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a6b32259475937e434b03862c64fb86a3">fluxmethod</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>];}</div>
<div class="line"><a name="l04093"></a><span class="lineno"> 4093</span>&#160;    <span class="keywordflow">if</span>(GLOBALMACP0A1(pflag,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ad6af3c16d5f7d7324b05736dfe946e5a">FLAGREALFLUX</a>)&lt;0) GLOBALMACP0A1(pflag,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ad6af3c16d5f7d7324b05736dfe946e5a">FLAGREALFLUX</a>)=0;</div>
<div class="line"><a name="l04094"></a><span class="lineno"> 4094</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l04095"></a><span class="lineno"> 4095</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l04096"></a><span class="lineno"> 4096</span>&#160;</div>
<div class="line"><a name="l04097"></a><span class="lineno"> 4097</span>&#160;  }</div>
<div class="line"><a name="l04098"></a><span class="lineno"> 4098</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l04099"></a><span class="lineno"> 4099</span>&#160;}</div>
<div class="line"><a name="l04100"></a><span class="lineno"> 4100</span>&#160;</div>
<div class="line"><a name="l04101"></a><span class="lineno"> 4101</span>&#160;</div>
<div class="line"><a name="l04102"></a><span class="lineno"> 4102</span>&#160;</div>
<div class="line"><a name="l04103"></a><span class="lineno"> 4103</span>&#160;<span class="comment">// whether to limit gamma inside ergosphere</span></div>
<div class="line"><a name="l04104"></a><span class="lineno"><a class="code" href="../../de/d95/fixup_8c.html#a968a065d2a5b04a7ad1c7a043b249cfe"> 4104</a></span>&#160;<span class="preprocessor">#define GAMMAERGOLIMIT 0</span></div>
<div class="line"><a name="l04105"></a><span class="lineno"> 4105</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l04106"></a><span class="lineno"> 4106</span>&#160;<span class="comment">// whether to conserve (at least) D=\rho_0 u^t when modifying \gamma</span></div>
<div class="line"><a name="l04107"></a><span class="lineno"> 4107</span>&#160;<span class="comment">// risky to assume D=rho_0 u^t conserved when limiting \gamma because \gamma may be large due to error simply in T^t_\nu evolution alone</span></div>
<div class="line"><a name="l04108"></a><span class="lineno"> 4108</span>&#160;<span class="comment">// So D evolution may be normal and more accurate, and so effectively error in T^t_\nu leads to large u^t but D changes little</span></div>
<div class="line"><a name="l04109"></a><span class="lineno"> 4109</span>&#160;<span class="comment">// so this fix would add a great deal of rest-mass</span></div>
<div class="line"><a name="l04110"></a><span class="lineno"> 4110</span>&#160;<span class="comment">// So for now just limit velocity ignoring all conservation laws</span></div>
<div class="line"><a name="l04111"></a><span class="lineno"><a class="code" href="../../de/d95/fixup_8c.html#a66ad7d401df7e86ff5623b9388b0642e"> 4111</a></span>&#160;<span class="preprocessor">#define DO_CONSERVE_D 0</span></div>
<div class="line"><a name="l04112"></a><span class="lineno"> 4112</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l04114"></a><span class="lineno"> 4114</span>&#160;<span class="keywordtype">int</span> limit_gamma(<span class="keywordtype">int</span> docorrectucons, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammamax, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammamaxrad, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a>*pr, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *ucons, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom,<span class="keywordtype">int</span> finalstep)</div>
<div class="line"><a name="l04115"></a><span class="lineno"> 4115</span>&#160;{</div>
<div class="line"><a name="l04116"></a><span class="lineno"> 4116</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> f,gamma,pref;</div>
<div class="line"><a name="l04117"></a><span class="lineno"> 4117</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> qsq;</div>
<div class="line"><a name="l04118"></a><span class="lineno"> 4118</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> alpha;</div>
<div class="line"><a name="l04119"></a><span class="lineno"> 4119</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> radgamma,radqsq;</div>
<div class="line"><a name="l04120"></a><span class="lineno"> 4120</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> pr0[NPR];</div>
<div class="line"><a name="l04121"></a><span class="lineno"> 4121</span>&#160;  <span class="keywordtype">int</span> pl,pliter;</div>
<div class="line"><a name="l04122"></a><span class="lineno"> 4122</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> realgammamax,realgammamaxrad;</div>
<div class="line"><a name="l04123"></a><span class="lineno"> 4123</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> r,X[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>],V[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l04124"></a><span class="lineno"> 4124</span>&#160;  <span class="keywordtype">int</span> didchange;</div>
<div class="line"><a name="l04125"></a><span class="lineno"> 4125</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> uu0,uu0max;</div>
<div class="line"><a name="l04126"></a><span class="lineno"> 4126</span>&#160;  <span class="keywordtype">int</span> i=ptrgeom-&gt;i;</div>
<div class="line"><a name="l04127"></a><span class="lineno"> 4127</span>&#160;  <span class="keywordtype">int</span> j=ptrgeom-&gt;j;</div>
<div class="line"><a name="l04128"></a><span class="lineno"> 4128</span>&#160;  <span class="keywordtype">int</span> k=ptrgeom-&gt;k;</div>
<div class="line"><a name="l04129"></a><span class="lineno"> 4129</span>&#160;  <span class="keywordtype">int</span> loc=ptrgeom-&gt;p;</div>
<div class="line"><a name="l04130"></a><span class="lineno"> 4130</span>&#160;</div>
<div class="line"><a name="l04131"></a><span class="lineno"> 4131</span>&#160;  <span class="comment">//  if((startpos[1]+ptrgeom-&gt;i==17) &amp;&amp; (startpos[2]+ptrgeom-&gt;j)==0){</span></div>
<div class="line"><a name="l04132"></a><span class="lineno"> 4132</span>&#160;  <span class="comment">//    dualfprintf(fail_file,&quot;inside limit_gamma(): finalstep=%d nstep=%ld steppart=%d\n&quot;,finalstep,nstep,steppart);</span></div>
<div class="line"><a name="l04133"></a><span class="lineno"> 4133</span>&#160;  <span class="comment">//  }</span></div>
<div class="line"><a name="l04134"></a><span class="lineno"> 4134</span>&#160;</div>
<div class="line"><a name="l04135"></a><span class="lineno"> 4135</span>&#160;  <span class="comment">// assume didn&#39;t change primitives</span></div>
<div class="line"><a name="l04136"></a><span class="lineno"> 4136</span>&#160;  didchange=0;</div>
<div class="line"><a name="l04137"></a><span class="lineno"> 4137</span>&#160;</div>
<div class="line"><a name="l04138"></a><span class="lineno"> 4138</span>&#160;</div>
<div class="line"><a name="l04139"></a><span class="lineno"> 4139</span>&#160;</div>
<div class="line"><a name="l04141"></a><span class="lineno"> 4141</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l04142"></a><span class="lineno"> 4142</span>&#160;  <span class="comment">// Ad-hoc ergo fix for force-free black hole problem (enabled very rarely)</span></div>
<div class="line"><a name="l04143"></a><span class="lineno"> 4143</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l04145"></a><span class="lineno"> 4145</span>&#160;<span class="comment"></span><span class="preprocessor">#if(GAMMAERGOLIMIT)</span></div>
<div class="line"><a name="l04146"></a><span class="lineno"> 4146</span>&#160;<span class="preprocessor"></span>  <a class="code" href="../../d9/de9/coord_8c.html#a1e1d4fd69f1234cb8751c4ea66297995" title="normally-used bl_coord[i,j,k] {i,j,k} -&gt; X only">coord_ijk</a>(i,j,k,loc,X);</div>
<div class="line"><a name="l04147"></a><span class="lineno"> 4147</span>&#160;  <a class="code" href="../../d9/de9/coord_8c.html#a96290375e27d5d0aa4d843b07e228e14" title="normally-used bl_coord[i,j,k] {i,j,k} -&gt; V only">bl_coord_ijk</a>(i,j,k,loc,V);</div>
<div class="line"><a name="l04148"></a><span class="lineno"> 4148</span>&#160;  r=V[1];</div>
<div class="line"><a name="l04149"></a><span class="lineno"> 4149</span>&#160;</div>
<div class="line"><a name="l04150"></a><span class="lineno"> 4150</span>&#160;  <span class="comment">// force flow to not move too fast inside ergosphere</span></div>
<div class="line"><a name="l04151"></a><span class="lineno"> 4151</span>&#160;  <span class="keywordflow">if</span>(r&lt;2) realgammamax=3;</div>
<div class="line"><a name="l04152"></a><span class="lineno"> 4152</span>&#160;  <span class="keywordflow">else</span> realgammamax=<a class="code" href="../../d8/d5b/defs_8general_8h.html#accef7ff74daca804b9a5a3ad7d3db882">GAMMAMAX</a>;</div>
<div class="line"><a name="l04153"></a><span class="lineno"> 4153</span>&#160;  realgammamaxrad=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a51ef12e4cafc4a8fe70374c37f57d565">GAMMAMAXRAD</a>;</div>
<div class="line"><a name="l04154"></a><span class="lineno"> 4154</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l04155"></a><span class="lineno"> 4155</span>&#160;<span class="preprocessor"></span>  realgammamax=gammamax;</div>
<div class="line"><a name="l04156"></a><span class="lineno"> 4156</span>&#160;  realgammamaxrad=gammamaxrad;</div>
<div class="line"><a name="l04157"></a><span class="lineno"> 4157</span>&#160;  <span class="keywordflow">if</span>(realgammamax&lt;=1.0 &amp;&amp; realgammamaxrad&lt;=1.0) <span class="keywordflow">return</span>(0); <span class="comment">// nothing to do</span></div>
<div class="line"><a name="l04158"></a><span class="lineno"> 4158</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l04159"></a><span class="lineno"> 4159</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l04160"></a><span class="lineno"> 4160</span>&#160;</div>
<div class="line"><a name="l04161"></a><span class="lineno"> 4161</span>&#160;</div>
<div class="line"><a name="l04162"></a><span class="lineno"> 4162</span>&#160;</div>
<div class="line"><a name="l04163"></a><span class="lineno"> 4163</span>&#160;</div>
<div class="line"><a name="l04164"></a><span class="lineno"> 4164</span>&#160;</div>
<div class="line"><a name="l04166"></a><span class="lineno"> 4166</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l04167"></a><span class="lineno"> 4167</span>&#160;  <span class="comment">// Get \gamma</span></div>
<div class="line"><a name="l04168"></a><span class="lineno"> 4168</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l04170"></a><span class="lineno"> 4170</span>&#160;<span class="comment"></span>  <span class="comment">//PALLLOOP(pl){ dualfprintf(fail_file,&quot;i=%d j=%d k=%d pr[%d]=%21.15g\n&quot;,startpos[1]+i,startpos[2]+j,startpos[3]+k,pl,MAC(pv,i,j,k));}</span></div>
<div class="line"><a name="l04171"></a><span class="lineno"> 4171</span>&#160;  <span class="keywordflow">if</span>(gamma_calc(pr,ptrgeom,&amp;gamma,&amp;qsq)&gt;=1){</div>
<div class="line"><a name="l04172"></a><span class="lineno"> 4172</span>&#160;    dualfprintf(fail_file,<span class="stringliteral">&quot;limit_gamma: gamma calc failed\n&quot;</span>);</div>
<div class="line"><a name="l04173"></a><span class="lineno"> 4173</span>&#160;    dualfprintf(fail_file,<span class="stringliteral">&quot;i=%d j=%d k=%d oldgamma=%21.15g\n&quot;</span>,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[1]+ptrgeom-&gt;i,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[2]+ptrgeom-&gt;j,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[3]+ptrgeom-&gt;k,gamma);</div>
<div class="line"><a name="l04174"></a><span class="lineno"> 4174</span>&#160;    <span class="keywordflow">if</span> (fail(i,j,k,loc,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab80e0a4ad12720e26d9e904b4796ec14">FAIL_UTCALC_DISCR</a>) &gt;= 1)</div>
<div class="line"><a name="l04175"></a><span class="lineno"> 4175</span>&#160;      <span class="keywordflow">return</span> (1);</div>
<div class="line"><a name="l04176"></a><span class="lineno"> 4176</span>&#160;  }</div>
<div class="line"><a name="l04177"></a><span class="lineno"> 4177</span>&#160;</div>
<div class="line"><a name="l04178"></a><span class="lineno"> 4178</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#a99ba7daf58b283bc831b8f507f5873a4" title="#define EOMTYPE EOMCOLDGRMHD">EOMRADTYPE</a>!=<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a993e29ef4139116d822d89bccb92180d" title="radiation equations of motion">EOMRADNONE</a>){</div>
<div class="line"><a name="l04179"></a><span class="lineno"> 4179</span>&#160;    <span class="keywordflow">if</span>(gamma_calc(&amp;pr[URAD1-<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>],ptrgeom,&amp;radgamma,&amp;radqsq)&gt;=1){</div>
<div class="line"><a name="l04180"></a><span class="lineno"> 4180</span>&#160;      dualfprintf(fail_file,<span class="stringliteral">&quot;limit_gamma: gamma calc failed: rad\n&quot;</span>);</div>
<div class="line"><a name="l04181"></a><span class="lineno"> 4181</span>&#160;      dualfprintf(fail_file,<span class="stringliteral">&quot;i=%d j=%d k=%d : rad : oldgamma=%21.15g\n&quot;</span>,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[1]+ptrgeom-&gt;i,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[2]+ptrgeom-&gt;j,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[3]+ptrgeom-&gt;k,gamma);</div>
<div class="line"><a name="l04182"></a><span class="lineno"> 4182</span>&#160;      <span class="keywordflow">if</span> (fail(i,j,k,loc,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab80e0a4ad12720e26d9e904b4796ec14">FAIL_UTCALC_DISCR</a>) &gt;= 1)</div>
<div class="line"><a name="l04183"></a><span class="lineno"> 4183</span>&#160;        <span class="keywordflow">return</span> (1);</div>
<div class="line"><a name="l04184"></a><span class="lineno"> 4184</span>&#160;    }</div>
<div class="line"><a name="l04185"></a><span class="lineno"> 4185</span>&#160;  }</div>
<div class="line"><a name="l04186"></a><span class="lineno"> 4186</span>&#160;  </div>
<div class="line"><a name="l04187"></a><span class="lineno"> 4187</span>&#160;</div>
<div class="line"><a name="l04188"></a><span class="lineno"> 4188</span>&#160;</div>
<div class="line"><a name="l04190"></a><span class="lineno"> 4190</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l04191"></a><span class="lineno"> 4191</span>&#160;  <span class="comment">// set pre-changed primitive</span></div>
<div class="line"><a name="l04192"></a><span class="lineno"> 4192</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l04194"></a><span class="lineno"> 4194</span>&#160;<span class="comment"></span>  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl)    pr0[pl]=pr[pl];</div>
<div class="line"><a name="l04195"></a><span class="lineno"> 4195</span>&#160;</div>
<div class="line"><a name="l04196"></a><span class="lineno"> 4196</span>&#160;</div>
<div class="line"><a name="l04197"></a><span class="lineno"> 4197</span>&#160;    </div>
<div class="line"><a name="l04199"></a><span class="lineno"> 4199</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l04200"></a><span class="lineno"> 4200</span>&#160;  <span class="comment">// If \gamma&gt;\gammamax, then force \gamma=\gammamax</span></div>
<div class="line"><a name="l04201"></a><span class="lineno"> 4201</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l04203"></a><span class="lineno"> 4203</span>&#160;<span class="comment"></span>  <span class="keywordflow">if</span>((gamma &gt; realgammamax &amp;&amp; (gamma!=1.0))) {    </div>
<div class="line"><a name="l04204"></a><span class="lineno"> 4204</span>&#160;</div>
<div class="line"><a name="l04205"></a><span class="lineno"> 4205</span>&#160;    <span class="comment">// rescale velocities to reduce gamma to realgammamax</span></div>
<div class="line"><a name="l04206"></a><span class="lineno"> 4206</span>&#160;    pref=(realgammamax*realgammamax - 1.)/(gamma*gamma - 1.);</div>
<div class="line"><a name="l04207"></a><span class="lineno"> 4207</span>&#160;</div>
<div class="line"><a name="l04208"></a><span class="lineno"> 4208</span>&#160;    <span class="keywordflow">if</span>(debugfail&gt;=3){ <span class="comment">// special &gt;=3 since often called when floor or fixup</span></div>
<div class="line"><a name="l04209"></a><span class="lineno"> 4209</span>&#160;      dualfprintf(fail_file,<span class="stringliteral">&quot;nstep=%ld steppart=%d t=%21.15g :: i=%d j=%d k=%d :: pref=%21.15g oldgamma=%21.15g realgammamax=%21.15g\n&quot;</span>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a1a1088d87617078680f1fd0f0d707384">nstep</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a70170b90229f9fc05eebf8508a685c70">steppart</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#ae1ee1e1c83c3f70e2e1afed4f4f5b41e">t</a>,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[1]+ptrgeom-&gt;i,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[2]+ptrgeom-&gt;j,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[3]+ptrgeom-&gt;k,pref,gamma,realgammamax);</div>
<div class="line"><a name="l04210"></a><span class="lineno"> 4210</span>&#160;    }</div>
<div class="line"><a name="l04211"></a><span class="lineno"> 4211</span>&#160;</div>
<div class="line"><a name="l04212"></a><span class="lineno"> 4212</span>&#160;    <span class="keywordflow">if</span>(pref&lt;0.0){</div>
<div class="line"><a name="l04213"></a><span class="lineno"> 4213</span>&#160;      dualfprintf(fail_file,<span class="stringliteral">&quot;limit_gamma: pref calc failed pref=%21.15g\n&quot;</span>,pref);</div>
<div class="line"><a name="l04214"></a><span class="lineno"> 4214</span>&#160;      dualfprintf(fail_file,<span class="stringliteral">&quot;i=%d j=%d k=%d oldgamma=%21.15g\n&quot;</span>,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[1]+ptrgeom-&gt;i,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[2]+ptrgeom-&gt;j,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[3]+ptrgeom-&gt;k,gamma);</div>
<div class="line"><a name="l04215"></a><span class="lineno"> 4215</span>&#160;      <span class="keywordflow">if</span> (fail(i,j,k,loc,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab80e0a4ad12720e26d9e904b4796ec14">FAIL_UTCALC_DISCR</a>) &gt;= 1)</div>
<div class="line"><a name="l04216"></a><span class="lineno"> 4216</span>&#160;        <span class="keywordflow">return</span> (1);</div>
<div class="line"><a name="l04217"></a><span class="lineno"> 4217</span>&#160;    }</div>
<div class="line"><a name="l04218"></a><span class="lineno"> 4218</span>&#160;</div>
<div class="line"><a name="l04219"></a><span class="lineno"> 4219</span>&#160;    f = sqrt(pref);</div>
<div class="line"><a name="l04220"></a><span class="lineno"> 4220</span>&#160;    pr[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>] *= f ; </div>
<div class="line"><a name="l04221"></a><span class="lineno"> 4221</span>&#160;    pr[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae907e773ef038f3fc0c2ad5de0cb0f07">U2</a>] *= f ; </div>
<div class="line"><a name="l04222"></a><span class="lineno"> 4222</span>&#160;    pr[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8de9104f1fffa59f057b214d74c5cfea">U3</a>] *= f ;</div>
<div class="line"><a name="l04223"></a><span class="lineno"> 4223</span>&#160;</div>
<div class="line"><a name="l04224"></a><span class="lineno"> 4224</span>&#160;</div>
<div class="line"><a name="l04225"></a><span class="lineno"> 4225</span>&#160;<span class="preprocessor">#if(DO_CONSERVE_D)</span></div>
<div class="line"><a name="l04226"></a><span class="lineno"> 4226</span>&#160;<span class="preprocessor"></span>    <span class="comment">//    alpha = alpha = 1./sqrt(-ptrgeom-&gt;gcon[GIND(TT,TT)]) ;</span></div>
<div class="line"><a name="l04227"></a><span class="lineno"> 4227</span>&#160;    <span class="comment">//uu0old=gamma/alpha;</span></div>
<div class="line"><a name="l04228"></a><span class="lineno"> 4228</span>&#160;    <span class="comment">// force conservation of particle number</span></div>
<div class="line"><a name="l04229"></a><span class="lineno"> 4229</span>&#160;    pr[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>] = pr0[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>]*gamma/realgammamax; <span class="comment">// can do this since alpha is constant and so cancels</span></div>
<div class="line"><a name="l04230"></a><span class="lineno"> 4230</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l04231"></a><span class="lineno"> 4231</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l04232"></a><span class="lineno"> 4232</span>&#160;    gamma=gammamax; <span class="comment">// reset gamma for next check</span></div>
<div class="line"><a name="l04233"></a><span class="lineno"> 4233</span>&#160;    didchange=1; <span class="comment">// indicate did change primitive</span></div>
<div class="line"><a name="l04234"></a><span class="lineno"> 4234</span>&#160;  }</div>
<div class="line"><a name="l04235"></a><span class="lineno"> 4235</span>&#160;</div>
<div class="line"><a name="l04236"></a><span class="lineno"> 4236</span>&#160;</div>
<div class="line"><a name="l04237"></a><span class="lineno"> 4237</span>&#160;</div>
<div class="line"><a name="l04238"></a><span class="lineno"> 4238</span>&#160;  <span class="comment">// KORAL:</span></div>
<div class="line"><a name="l04239"></a><span class="lineno"> 4239</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#a99ba7daf58b283bc831b8f507f5873a4" title="#define EOMTYPE EOMCOLDGRMHD">EOMRADTYPE</a>!=<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a993e29ef4139116d822d89bccb92180d" title="radiation equations of motion">EOMRADNONE</a>){</div>
<div class="line"><a name="l04240"></a><span class="lineno"> 4240</span>&#160;</div>
<div class="line"><a name="l04241"></a><span class="lineno"> 4241</span>&#160;    <span class="keywordflow">if</span>((radgamma &gt; realgammamaxrad &amp;&amp; (radgamma!=1.0))) {    </div>
<div class="line"><a name="l04242"></a><span class="lineno"> 4242</span>&#160;</div>
<div class="line"><a name="l04243"></a><span class="lineno"> 4243</span>&#160;      <span class="comment">// rescale velocities to reduce radgamma to realgammamaxrad</span></div>
<div class="line"><a name="l04244"></a><span class="lineno"> 4244</span>&#160;      pref=(realgammamaxrad*realgammamaxrad - 1.)/(radgamma*radgamma - 1.);</div>
<div class="line"><a name="l04245"></a><span class="lineno"> 4245</span>&#160;</div>
<div class="line"><a name="l04246"></a><span class="lineno"> 4246</span>&#160;      <span class="keywordflow">if</span>(debugfail&gt;=3){ <span class="comment">// special &gt;=3 since often called when floor or fixup</span></div>
<div class="line"><a name="l04247"></a><span class="lineno"> 4247</span>&#160;        dualfprintf(fail_file,<span class="stringliteral">&quot;nstep=%ld steppart=%d t=%21.15g :: i=%d j=%d k=%d :: pref=%21.15g oldradgamma=%21.15g realgammamaxrad=%21.15g\n&quot;</span>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a1a1088d87617078680f1fd0f0d707384">nstep</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a70170b90229f9fc05eebf8508a685c70">steppart</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#ae1ee1e1c83c3f70e2e1afed4f4f5b41e">t</a>,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[1]+ptrgeom-&gt;i,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[2]+ptrgeom-&gt;j,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[3]+ptrgeom-&gt;k,pref,radgamma,realgammamaxrad);</div>
<div class="line"><a name="l04248"></a><span class="lineno"> 4248</span>&#160;      }</div>
<div class="line"><a name="l04249"></a><span class="lineno"> 4249</span>&#160;</div>
<div class="line"><a name="l04250"></a><span class="lineno"> 4250</span>&#160;      <span class="keywordflow">if</span>(pref&lt;0.0){</div>
<div class="line"><a name="l04251"></a><span class="lineno"> 4251</span>&#160;        dualfprintf(fail_file,<span class="stringliteral">&quot;limit_gamma: pref calc failed pref=%21.15g\n&quot;</span>,pref);</div>
<div class="line"><a name="l04252"></a><span class="lineno"> 4252</span>&#160;        dualfprintf(fail_file,<span class="stringliteral">&quot;i=%d j=%d k=%d oldgamma=%21.15g\n&quot;</span>,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[1]+ptrgeom-&gt;i,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[2]+ptrgeom-&gt;j,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[3]+ptrgeom-&gt;k,radgamma);</div>
<div class="line"><a name="l04253"></a><span class="lineno"> 4253</span>&#160;        <span class="keywordflow">if</span> (fail(i,j,k,loc,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab80e0a4ad12720e26d9e904b4796ec14">FAIL_UTCALC_DISCR</a>) &gt;= 1)</div>
<div class="line"><a name="l04254"></a><span class="lineno"> 4254</span>&#160;          <span class="keywordflow">return</span> (1);</div>
<div class="line"><a name="l04255"></a><span class="lineno"> 4255</span>&#160;      }</div>
<div class="line"><a name="l04256"></a><span class="lineno"> 4256</span>&#160;</div>
<div class="line"><a name="l04257"></a><span class="lineno"> 4257</span>&#160;      f = sqrt(pref);</div>
<div class="line"><a name="l04258"></a><span class="lineno"> 4258</span>&#160;      pr[URAD1] *= f ; </div>
<div class="line"><a name="l04259"></a><span class="lineno"> 4259</span>&#160;      pr[URAD2] *= f ; </div>
<div class="line"><a name="l04260"></a><span class="lineno"> 4260</span>&#160;      pr[URAD3] *= f ;</div>
<div class="line"><a name="l04261"></a><span class="lineno"> 4261</span>&#160;</div>
<div class="line"><a name="l04262"></a><span class="lineno"> 4262</span>&#160;</div>
<div class="line"><a name="l04263"></a><span class="lineno"> 4263</span>&#160;      radgamma=gammamaxrad; <span class="comment">// reset radgamma for next check</span></div>
<div class="line"><a name="l04264"></a><span class="lineno"> 4264</span>&#160;      didchange=1; <span class="comment">// indicate did change primitive</span></div>
<div class="line"><a name="l04265"></a><span class="lineno"> 4265</span>&#160;    }</div>
<div class="line"><a name="l04266"></a><span class="lineno"> 4266</span>&#160;  }</div>
<div class="line"><a name="l04267"></a><span class="lineno"> 4267</span>&#160;</div>
<div class="line"><a name="l04268"></a><span class="lineno"> 4268</span>&#160;</div>
<div class="line"><a name="l04269"></a><span class="lineno"> 4269</span>&#160;</div>
<div class="line"><a name="l04271"></a><span class="lineno"> 4271</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l04272"></a><span class="lineno"> 4272</span>&#160;  <span class="comment">// limiting u^t makes no sense except as an indicator of when in difficult regime</span></div>
<div class="line"><a name="l04273"></a><span class="lineno"> 4273</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l04275"></a><span class="lineno"> 4275</span>&#160;<span class="comment"></span><span class="preprocessor">#if(0)</span></div>
<div class="line"><a name="l04276"></a><span class="lineno"> 4276</span>&#160;<span class="preprocessor"></span>  <span class="comment">// limit u^t too since maybe alpha very small</span></div>
<div class="line"><a name="l04277"></a><span class="lineno"> 4277</span>&#160;  <span class="comment">//alpha = 1./sqrt(-ptrgeom-&gt;gcon[GIND(TT,TT)]) ;</span></div>
<div class="line"><a name="l04278"></a><span class="lineno"> 4278</span>&#160;  alpha = ptrgeom-&gt;alphalapse;</div>
<div class="line"><a name="l04279"></a><span class="lineno"> 4279</span>&#160;  uu0=gamma/alpha;</div>
<div class="line"><a name="l04280"></a><span class="lineno"> 4280</span>&#160;  uu0max=realgammamax;</div>
<div class="line"><a name="l04281"></a><span class="lineno"> 4281</span>&#160;  <span class="comment">// since alpha is always &gt;=1, then limit on uu0 always overrides limit on gamma?</span></div>
<div class="line"><a name="l04282"></a><span class="lineno"> 4282</span>&#160;  <span class="comment">// here realgammamax is u^t not u^t\alpha</span></div>
<div class="line"><a name="l04283"></a><span class="lineno"> 4283</span>&#160;  <span class="keywordflow">if</span>((uu0 &gt; uu0max &amp;&amp; (uu0!=1.0))) {    </div>
<div class="line"><a name="l04284"></a><span class="lineno"> 4284</span>&#160;</div>
<div class="line"><a name="l04285"></a><span class="lineno"> 4285</span>&#160;    <span class="comment">//dualfprintf(fail_file,&quot;gamma=%21.15g realgammamax=%21.15g\n&quot;,gamma,gammamax);</span></div>
<div class="line"><a name="l04286"></a><span class="lineno"> 4286</span>&#160;</div>
<div class="line"><a name="l04287"></a><span class="lineno"> 4287</span>&#160;    <span class="keywordflow">if</span>(debugfail&gt;=2) dualfprintf(fail_file,<span class="stringliteral">&quot;i=%d j=%d k=%d oldgamma=%21.15g\n&quot;</span>,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[1]+ptrgeom-&gt;i,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[2]+ptrgeom-&gt;j,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[3]+ptrgeom-&gt;k,gamma);</div>
<div class="line"><a name="l04288"></a><span class="lineno"> 4288</span>&#160;    <span class="comment">// rescale velocities to reduce gamma to realgammamax</span></div>
<div class="line"><a name="l04289"></a><span class="lineno"> 4289</span>&#160;    pref=(uu0max*uu0max*alpha*alpha - 1.)/(gamma*gamma - 1.);</div>
<div class="line"><a name="l04290"></a><span class="lineno"> 4290</span>&#160;    <span class="keywordflow">if</span>(pref&lt;0.0){</div>
<div class="line"><a name="l04291"></a><span class="lineno"> 4291</span>&#160;      dualfprintf(fail_file,<span class="stringliteral">&quot;limit_gamma: pref calc failed pref=%21.15g\n&quot;</span>,pref);</div>
<div class="line"><a name="l04292"></a><span class="lineno"> 4292</span>&#160;      dualfprintf(fail_file,<span class="stringliteral">&quot;i=%d j=%d k=%d oldgamma=%21.15g\n&quot;</span>,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[1]+ptrgeom-&gt;i,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[2]+ptrgeom-&gt;j,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[3]+ptrgeom-&gt;k,gamma);</div>
<div class="line"><a name="l04293"></a><span class="lineno"> 4293</span>&#160;      <span class="keywordflow">if</span> (fail(i,j,k,loc,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab80e0a4ad12720e26d9e904b4796ec14">FAIL_UTCALC_DISCR</a>) &gt;= 1)</div>
<div class="line"><a name="l04294"></a><span class="lineno"> 4294</span>&#160;        <span class="keywordflow">return</span> (1);</div>
<div class="line"><a name="l04295"></a><span class="lineno"> 4295</span>&#160;    }</div>
<div class="line"><a name="l04296"></a><span class="lineno"> 4296</span>&#160;</div>
<div class="line"><a name="l04297"></a><span class="lineno"> 4297</span>&#160;    f = sqrt(pref);</div>
<div class="line"><a name="l04298"></a><span class="lineno"> 4298</span>&#160;    pr[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>] *= f ; </div>
<div class="line"><a name="l04299"></a><span class="lineno"> 4299</span>&#160;    pr[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae907e773ef038f3fc0c2ad5de0cb0f07">U2</a>] *= f ; </div>
<div class="line"><a name="l04300"></a><span class="lineno"> 4300</span>&#160;    pr[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8de9104f1fffa59f057b214d74c5cfea">U3</a>] *= f ;</div>
<div class="line"><a name="l04301"></a><span class="lineno"> 4301</span>&#160;</div>
<div class="line"><a name="l04302"></a><span class="lineno"> 4302</span>&#160;<span class="preprocessor">#if(DO_CONSERVE_D)</span></div>
<div class="line"><a name="l04303"></a><span class="lineno"> 4303</span>&#160;<span class="preprocessor"></span>    <span class="comment">//    alpha = alpha = 1./sqrt(-ptrgeom-&gt;gcon[GIND(TT,TT)]) ;</span></div>
<div class="line"><a name="l04304"></a><span class="lineno"> 4304</span>&#160;    <span class="comment">//uu0old=gamma/alpha;</span></div>
<div class="line"><a name="l04305"></a><span class="lineno"> 4305</span>&#160;    <span class="comment">// force conservation of particle number</span></div>
<div class="line"><a name="l04306"></a><span class="lineno"> 4306</span>&#160;    pr[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>] = pr0[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>]*uu0/uu0max;</div>
<div class="line"><a name="l04307"></a><span class="lineno"> 4307</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l04308"></a><span class="lineno"> 4308</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l04309"></a><span class="lineno"> 4309</span>&#160;    didchange=1;</div>
<div class="line"><a name="l04310"></a><span class="lineno"> 4310</span>&#160;  }</div>
<div class="line"><a name="l04311"></a><span class="lineno"> 4311</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l04312"></a><span class="lineno"> 4312</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l04313"></a><span class="lineno"> 4313</span>&#160;</div>
<div class="line"><a name="l04314"></a><span class="lineno"> 4314</span>&#160;</div>
<div class="line"><a name="l04315"></a><span class="lineno"> 4315</span>&#160;</div>
<div class="line"><a name="l04317"></a><span class="lineno"> 4317</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l04318"></a><span class="lineno"> 4318</span>&#160;  <span class="comment">// Account for changes in conserved quantities via changes in: \rho_0 and pr[U1..U3]</span></div>
<div class="line"><a name="l04319"></a><span class="lineno"> 4319</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l04321"></a><span class="lineno"> 4321</span>&#160;<span class="comment"></span>  <span class="keywordflow">if</span>(didchange){</div>
<div class="line"><a name="l04322"></a><span class="lineno"> 4322</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> prdiag[NPR];</div>
<div class="line"><a name="l04323"></a><span class="lineno"> 4323</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) prdiag[pl]=pr0[pl];</div>
<div class="line"><a name="l04324"></a><span class="lineno"> 4324</span>&#160;    <span class="keywordtype">int</span> doingmhdfixup=1;</div>
<div class="line"><a name="l04325"></a><span class="lineno"> 4325</span>&#160;    <span class="comment">//    if((startpos[1]+ptrgeom-&gt;i==17) &amp;&amp; (startpos[2]+ptrgeom-&gt;j)==0){</span></div>
<div class="line"><a name="l04326"></a><span class="lineno"> 4326</span>&#160;    <span class="comment">//      dualfprintf(fail_file,&quot;LIMITGAMMABEFORE: steppart=%d nstep=%ld\n&quot;,steppart,nstep);</span></div>
<div class="line"><a name="l04327"></a><span class="lineno"> 4327</span>&#160;    <span class="comment">//    }</span></div>
<div class="line"><a name="l04328"></a><span class="lineno"> 4328</span>&#160;    diag_fixup(docorrectucons,prdiag, pr, ucons, ptrgeom, finalstep,doingmhdfixup,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#af0f4fd6539ab981966c52db827310106">COUNTLIMITGAMMAACT</a>);</div>
<div class="line"><a name="l04329"></a><span class="lineno"> 4329</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) prdiag[pl]=pr[pl];</div>
<div class="line"><a name="l04330"></a><span class="lineno"> 4330</span>&#160;    <span class="comment">//    if((startpos[1]+ptrgeom-&gt;i==17) &amp;&amp; (startpos[2]+ptrgeom-&gt;j)==0){</span></div>
<div class="line"><a name="l04331"></a><span class="lineno"> 4331</span>&#160;    <span class="comment">//      dualfprintf(fail_file,&quot;LIMITGAMMAAFTER: steppart=%d nstep=%ld\n&quot;,steppart,nstep);</span></div>
<div class="line"><a name="l04332"></a><span class="lineno"> 4332</span>&#160;    <span class="comment">//    }</span></div>
<div class="line"><a name="l04333"></a><span class="lineno"> 4333</span>&#160;</div>
<div class="line"><a name="l04334"></a><span class="lineno"> 4334</span>&#160;    <span class="keywordflow">return</span>(-1);<span class="comment">// indicates did change primitive</span></div>
<div class="line"><a name="l04335"></a><span class="lineno"> 4335</span>&#160;  }</div>
<div class="line"><a name="l04336"></a><span class="lineno"> 4336</span>&#160;</div>
<div class="line"><a name="l04337"></a><span class="lineno"> 4337</span>&#160;</div>
<div class="line"><a name="l04338"></a><span class="lineno"> 4338</span>&#160;  <span class="keywordflow">return</span>(0); <span class="comment">// indicates didn&#39;t change anything</span></div>
<div class="line"><a name="l04339"></a><span class="lineno"> 4339</span>&#160;}</div>
<div class="line"><a name="l04340"></a><span class="lineno"> 4340</span>&#160;</div>
<div class="line"><a name="l04341"></a><span class="lineno"> 4341</span>&#160;</div>
<div class="line"><a name="l04342"></a><span class="lineno"> 4342</span>&#160;</div>
<div class="line"><a name="l04343"></a><span class="lineno"> 4343</span>&#160;</div>
<div class="line"><a name="l04344"></a><span class="lineno"> 4344</span>&#160;</div>
<div class="line"><a name="l04345"></a><span class="lineno"> 4345</span>&#160;</div>
<div class="line"><a name="l04346"></a><span class="lineno"> 4346</span>&#160;</div>
<div class="line"><a name="l04347"></a><span class="lineno"> 4347</span>&#160;<span class="comment">// check_pr() is purely 2D function</span></div>
<div class="line"><a name="l04348"></a><span class="lineno"> 4348</span>&#160;</div>
<div class="line"><a name="l04349"></a><span class="lineno"><a class="code" href="../../de/d95/fixup_8c.html#ab40b40ed45fddec017da48326d878dc3"> 4349</a></span>&#160;<span class="preprocessor">#define UTLIMIT (50.0) // limit of u^t given no other info and need to fix u</span></div>
<div class="line"><a name="l04350"></a><span class="lineno"><a class="code" href="../../de/d95/fixup_8c.html#a1ab56ab19113f9b4b5cb4fcf9ce312cc"> 4350</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define UTFIX (utobs) //  if failed u^t, then fix to this level to keep normal, or use local value as desired value</span></div>
<div class="line"><a name="l04351"></a><span class="lineno"><a class="code" href="../../de/d95/fixup_8c.html#afa5aa04693e0628abceb026dade58034"> 4351</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define GRADIENTFACTOR (.001) // how to set?</span></div>
<div class="line"><a name="l04352"></a><span class="lineno"> 4352</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l04356"></a><span class="lineno"> 4356</span>&#160;<span class="keywordtype">int</span> check_pr(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr,<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *prmodel, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *ucons, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom,<span class="keywordtype">int</span> modelpos, <span class="keywordtype">int</span> finalstep)</div>
<div class="line"><a name="l04357"></a><span class="lineno"> 4357</span>&#160;{</div>
<div class="line"><a name="l04358"></a><span class="lineno"> 4358</span>&#160;</div>
<div class="line"><a name="l04359"></a><span class="lineno"> 4359</span>&#160;<span class="preprocessor">#if(WHICHVEL==VEL3)</span></div>
<div class="line"><a name="l04360"></a><span class="lineno"> 4360</span>&#160;<span class="preprocessor"></span>  <span class="keywordtype">int</span> failedcheck;</div>
<div class="line"><a name="l04361"></a><span class="lineno"> 4361</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ucon[NPR],uconmodel[NPR];</div>
<div class="line"><a name="l04362"></a><span class="lineno"> 4362</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> others[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a266c1c3ab2959dbfc603c7d3f12783fb" title="strict limit (doesn&#39;t work in general)">NUMOTHERSTATERESULTS</a>],othersmodel[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a266c1c3ab2959dbfc603c7d3f12783fb" title="strict limit (doesn&#39;t work in general)">NUMOTHERSTATERESULTS</a>];</div>
<div class="line"><a name="l04363"></a><span class="lineno"> 4363</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> prold[NPR],probs[NPR];</div>
<div class="line"><a name="l04364"></a><span class="lineno"> 4364</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gradient[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>],normsq;</div>
<div class="line"><a name="l04365"></a><span class="lineno"> 4365</span>&#160;  <span class="keywordtype">int</span> trialcount,ntrials;</div>
<div class="line"><a name="l04366"></a><span class="lineno"> 4366</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>,<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>,k;</div>
<div class="line"><a name="l04367"></a><span class="lineno"> 4367</span>&#160;  <span class="keywordtype">int</span> pl,pliter;</div>
<div class="line"><a name="l04368"></a><span class="lineno"> 4368</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> lastuttdiscr,uttdiscr0,utobs;</div>
<div class="line"><a name="l04369"></a><span class="lineno"> 4369</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dampfactor,dampfactorchange;</div>
<div class="line"><a name="l04370"></a><span class="lineno"> 4370</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> newerr,olderr;</div>
<div class="line"><a name="l04371"></a><span class="lineno"> 4371</span>&#160;  <span class="keywordtype">int</span> method;</div>
<div class="line"><a name="l04372"></a><span class="lineno"> 4372</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> modelgeomdontuse;</div>
<div class="line"><a name="l04373"></a><span class="lineno"> 4373</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrmodelgeom=&amp;modelgeomdontuse;</div>
<div class="line"><a name="l04374"></a><span class="lineno"> 4374</span>&#160;  <span class="keywordtype">int</span> idel,jdel,kdel;</div>
<div class="line"><a name="l04375"></a><span class="lineno"> 4375</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> realutlimit,realdiscrlimit;</div>
<div class="line"><a name="l04376"></a><span class="lineno"> 4376</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> modeldiscr;</div>
<div class="line"><a name="l04377"></a><span class="lineno"> 4377</span>&#160;  <span class="keywordtype">int</span> utinterp;</div>
<div class="line"><a name="l04378"></a><span class="lineno"> 4378</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> toldiscr;</div>
<div class="line"><a name="l04379"></a><span class="lineno"> 4379</span>&#160;  <span class="keywordtype">int</span> modeli,modelj,modelk;</div>
<div class="line"><a name="l04380"></a><span class="lineno"> 4380</span>&#160;  <span class="keywordtype">int</span> bctype;</div>
<div class="line"><a name="l04381"></a><span class="lineno"> 4381</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> pr0[NPR];</div>
<div class="line"><a name="l04382"></a><span class="lineno"> 4382</span>&#160;  <span class="keywordtype">int</span> loc=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8936711f57f82d1fc75c21fa2894e1c6">CENT</a>;</div>
<div class="line"><a name="l04383"></a><span class="lineno"> 4383</span>&#160;</div>
<div class="line"><a name="l04384"></a><span class="lineno"> 4384</span>&#160;</div>
<div class="line"><a name="l04385"></a><span class="lineno"> 4385</span>&#160;  <span class="keywordflow">if</span>(modelpos==-100){ <span class="comment">// then utoprim called us from usrfun</span></div>
<div class="line"><a name="l04386"></a><span class="lineno"> 4386</span>&#160;    modelpos=0;</div>
<div class="line"><a name="l04387"></a><span class="lineno"> 4387</span>&#160;    ntrials=30; <span class="comment">// don&#39;t try so hard since failure is more likely, leads to static solution</span></div>
<div class="line"><a name="l04388"></a><span class="lineno"> 4388</span>&#160;  }</div>
<div class="line"><a name="l04389"></a><span class="lineno"> 4389</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l04390"></a><span class="lineno"> 4390</span>&#160;    ntrials=200; <span class="comment">// try really hard since using observer as solution is not fun</span></div>
<div class="line"><a name="l04391"></a><span class="lineno"> 4391</span>&#160;  }</div>
<div class="line"><a name="l04392"></a><span class="lineno"> 4392</span>&#160;  toldiscr=1.E-2;</div>
<div class="line"><a name="l04393"></a><span class="lineno"> 4393</span>&#160;  dampfactorchange=0.5;</div>
<div class="line"><a name="l04394"></a><span class="lineno"> 4394</span>&#160;  dampfactor=1.0;</div>
<div class="line"><a name="l04395"></a><span class="lineno"> 4395</span>&#160;  method=1; <span class="comment">// 0=GRADIENTFACTOR 1=damp newton&#39;s method</span></div>
<div class="line"><a name="l04396"></a><span class="lineno"> 4396</span>&#160;  utinterp=0; <span class="comment">// whether to fix interpolation (if bad) based upon a model pr</span></div>
<div class="line"><a name="l04397"></a><span class="lineno"> 4397</span>&#160;  </div>
<div class="line"><a name="l04398"></a><span class="lineno"> 4398</span>&#160;</div>
<div class="line"><a name="l04399"></a><span class="lineno"> 4399</span>&#160;  <span class="keywordflow">if</span>(method==1){</div>
<div class="line"><a name="l04400"></a><span class="lineno"> 4400</span>&#160;    <span class="comment">// save old pr</span></div>
<div class="line"><a name="l04401"></a><span class="lineno"> 4401</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl) probs[pl]=prold[pl]=pr[pl];</div>
<div class="line"><a name="l04402"></a><span class="lineno"> 4402</span>&#160;  }</div>
<div class="line"><a name="l04403"></a><span class="lineno"> 4403</span>&#160;</div>
<div class="line"><a name="l04404"></a><span class="lineno"> 4404</span>&#160;  <a class="code" href="../../d8/d5b/defs_8general_8h.html#acb23ef211402a7d4f09b95fa70f38766">whocalleducon</a>=1; <span class="comment">// turn off failures</span></div>
<div class="line"><a name="l04405"></a><span class="lineno"> 4405</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#afc93fd4a6f7a2b87a9315d5fba5a529c">ucon_calc</a>(pr, ptrgeom, ucon,others) &gt;= 1) ucon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>]=1E30; <span class="comment">// bad, so keep going</span></div>
<div class="line"><a name="l04406"></a><span class="lineno"> 4406</span>&#160;  uttdiscr0=lastuttdiscr=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a17d1dcb879f265654da7e71c3f4fa999">uttdiscr</a>; <span class="comment">// ucon_calc() set uttdiscr</span></div>
<div class="line"><a name="l04407"></a><span class="lineno"> 4407</span>&#160;  <span class="keywordflow">if</span>(ucon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>]&lt;<a class="code" href="../../de/d95/fixup_8c.html#ab40b40ed45fddec017da48326d878dc3">UTLIMIT</a>) <span class="keywordflow">return</span>(0); <span class="comment">// good, so just continue calculations</span></div>
<div class="line"><a name="l04408"></a><span class="lineno"> 4408</span>&#160;</div>
<div class="line"><a name="l04409"></a><span class="lineno"> 4409</span>&#160;</div>
<div class="line"><a name="l04411"></a><span class="lineno"> 4411</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l04412"></a><span class="lineno"> 4412</span>&#160;  <span class="comment">// if here, need to fix</span></div>
<div class="line"><a name="l04413"></a><span class="lineno"> 4413</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l04414"></a><span class="lineno"> 4414</span>&#160;  <span class="comment">// set pre-primitive</span></div>
<div class="line"><a name="l04415"></a><span class="lineno"> 4415</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl)    pr0[pl]=pr[pl];</div>
<div class="line"><a name="l04416"></a><span class="lineno"> 4416</span>&#160;</div>
<div class="line"><a name="l04417"></a><span class="lineno"> 4417</span>&#160;</div>
<div class="line"><a name="l04418"></a><span class="lineno"> 4418</span>&#160;</div>
<div class="line"><a name="l04419"></a><span class="lineno"> 4419</span>&#160;  <span class="keywordflow">if</span>(modelpos==-2) <span class="keywordflow">return</span>(1); <span class="comment">// don&#39;t try to correct, just fail since ucon[TT] wasn&#39;t less than the limit (otherwise wouldn&#39;t reach here).  Used to just check, no fix.</span></div>
<div class="line"><a name="l04420"></a><span class="lineno"> 4420</span>&#160;  </div>
<div class="line"><a name="l04421"></a><span class="lineno"> 4421</span>&#160;  <span class="keywordflow">if</span>(modelpos==-3){</div>
<div class="line"><a name="l04422"></a><span class="lineno"> 4422</span>&#160;    modelpos=-1;</div>
<div class="line"><a name="l04423"></a><span class="lineno"> 4423</span>&#160;    bctype=1; <span class="comment">// so bound_prim called us</span></div>
<div class="line"><a name="l04424"></a><span class="lineno"> 4424</span>&#160;  }</div>
<div class="line"><a name="l04425"></a><span class="lineno"> 4425</span>&#160;  <span class="keywordflow">else</span> bctype=0; <span class="comment">// non-bound call</span></div>
<div class="line"><a name="l04426"></a><span class="lineno"> 4426</span>&#160;  </div>
<div class="line"><a name="l04427"></a><span class="lineno"> 4427</span>&#160;</div>
<div class="line"><a name="l04429"></a><span class="lineno"> 4429</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l04430"></a><span class="lineno"> 4430</span>&#160;  <span class="comment">// if we are here, original velocities need to be corrected</span></div>
<div class="line"><a name="l04431"></a><span class="lineno"> 4431</span>&#160;</div>
<div class="line"><a name="l04432"></a><span class="lineno"> 4432</span>&#160;  <span class="comment">// first find normal observer to get relevant u^t</span></div>
<div class="line"><a name="l04433"></a><span class="lineno"> 4433</span>&#160;  <span class="keywordflow">for</span>(i=1;i&lt;=3;i++){</div>
<div class="line"><a name="l04434"></a><span class="lineno"> 4434</span>&#160;    probs[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>+i-1] = ptrgeom-&gt;gcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>,i)]/ptrgeom-&gt;gcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>)] ;</div>
<div class="line"><a name="l04435"></a><span class="lineno"> 4435</span>&#160;  }</div>
<div class="line"><a name="l04436"></a><span class="lineno"> 4436</span>&#160;  <span class="comment">// ucon[TT] must be good for normal observer (?) hard to solve for u^t for normal observer in general</span></div>
<div class="line"><a name="l04437"></a><span class="lineno"> 4437</span>&#160;  <span class="comment">// change of whocalleducon forces kill level check on normal observer</span></div>
<div class="line"><a name="l04438"></a><span class="lineno"> 4438</span>&#160;  <a class="code" href="../../d8/d5b/defs_8general_8h.html#acb23ef211402a7d4f09b95fa70f38766">whocalleducon</a>=0;</div>
<div class="line"><a name="l04439"></a><span class="lineno"> 4439</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#afc93fd4a6f7a2b87a9315d5fba5a529c">ucon_calc</a>(probs, ptrgeom, ucon, others) &gt;= 1){</div>
<div class="line"><a name="l04440"></a><span class="lineno"> 4440</span>&#160;    dualfprintf(fail_file,<span class="stringliteral">&quot;Thought normal observer had to have good u^t!\n&quot;</span>);</div>
<div class="line"><a name="l04441"></a><span class="lineno"> 4441</span>&#160;    <span class="keywordflow">return</span>(1);</div>
<div class="line"><a name="l04442"></a><span class="lineno"> 4442</span>&#160;  }</div>
<div class="line"><a name="l04443"></a><span class="lineno"> 4443</span>&#160;  <span class="keywordflow">else</span> utobs=ucon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>];</div>
<div class="line"><a name="l04444"></a><span class="lineno"> 4444</span>&#160;  <a class="code" href="../../d8/d5b/defs_8general_8h.html#acb23ef211402a7d4f09b95fa70f38766">whocalleducon</a>=1;</div>
<div class="line"><a name="l04445"></a><span class="lineno"> 4445</span>&#160;</div>
<div class="line"><a name="l04446"></a><span class="lineno"> 4446</span>&#160;</div>
<div class="line"><a name="l04447"></a><span class="lineno"> 4447</span>&#160;  <span class="keywordflow">if</span>(utinterp&amp;&amp;(modelpos&gt;=0)){ <span class="comment">// use modelpos==-1 for no use of model</span></div>
<div class="line"><a name="l04448"></a><span class="lineno"> 4448</span>&#160;    <span class="comment">// below for no interpolation but use of model</span></div>
<div class="line"><a name="l04449"></a><span class="lineno"> 4449</span>&#160;    <span class="keywordflow">if</span>(modelpos==0){</div>
<div class="line"><a name="l04450"></a><span class="lineno"> 4450</span>&#160;      modeli=ptrgeom-&gt;i;</div>
<div class="line"><a name="l04451"></a><span class="lineno"> 4451</span>&#160;      modelj=ptrgeom-&gt;j;</div>
<div class="line"><a name="l04452"></a><span class="lineno"> 4452</span>&#160;      modelk=ptrgeom-&gt;k;</div>
<div class="line"><a name="l04453"></a><span class="lineno"> 4453</span>&#160;      ptrmodelgeom=ptrgeom;</div>
<div class="line"><a name="l04454"></a><span class="lineno"> 4454</span>&#160;    }</div>
<div class="line"><a name="l04455"></a><span class="lineno"> 4455</span>&#160;    <span class="comment">// modelpos&gt;=1 for interpolations in fluxcalc() (model value on center)</span></div>
<div class="line"><a name="l04456"></a><span class="lineno"> 4456</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(modelpos==1){</div>
<div class="line"><a name="l04457"></a><span class="lineno"> 4457</span>&#160;      <span class="keywordflow">if</span>(ptrgeom-&gt;p==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a1df736ddba855d7b429869f9f09dbd66">FACE1</a>){ idel=1; jdel=0; kdel=0; }</div>
<div class="line"><a name="l04458"></a><span class="lineno"> 4458</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span>(ptrgeom-&gt;p==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a5b4b42f50fd7667c7d22d8001811bc7e">FACE2</a>){ idel=0; jdel=1; kdel=0; }</div>
<div class="line"><a name="l04459"></a><span class="lineno"> 4459</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span>(ptrgeom-&gt;p==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a630fdcefb04bdca66118cfd21476e8fd">FACE3</a>){ idel=0; jdel=0; kdel=1; }</div>
<div class="line"><a name="l04460"></a><span class="lineno"> 4460</span>&#160;      modeli=(ptrgeom-&gt;i) -idel;</div>
<div class="line"><a name="l04461"></a><span class="lineno"> 4461</span>&#160;      modelj=(ptrgeom-&gt;j) -jdel;</div>
<div class="line"><a name="l04462"></a><span class="lineno"> 4462</span>&#160;      modelk=(ptrgeom-&gt;k) -kdel;</div>
<div class="line"><a name="l04463"></a><span class="lineno"> 4463</span>&#160;      <span class="comment">// then i-1,j is center position</span></div>
<div class="line"><a name="l04464"></a><span class="lineno"> 4464</span>&#160;      <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a3059ed7bfcfb692cbe8014d55fd7c1e4">get_geometry</a>(modeli,modelj,modelk,loc,ptrmodelgeom);</div>
<div class="line"><a name="l04465"></a><span class="lineno"> 4465</span>&#160;    }</div>
<div class="line"><a name="l04466"></a><span class="lineno"> 4466</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(modelpos==2){</div>
<div class="line"><a name="l04467"></a><span class="lineno"> 4467</span>&#160;      modeli=ptrgeom-&gt;i;</div>
<div class="line"><a name="l04468"></a><span class="lineno"> 4468</span>&#160;      modelj=ptrgeom-&gt;j;</div>
<div class="line"><a name="l04469"></a><span class="lineno"> 4469</span>&#160;      modelk=ptrgeom-&gt;k;</div>
<div class="line"><a name="l04470"></a><span class="lineno"> 4470</span>&#160;      <span class="comment">// then i,j is center position</span></div>
<div class="line"><a name="l04471"></a><span class="lineno"> 4471</span>&#160;      <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a3059ed7bfcfb692cbe8014d55fd7c1e4">get_geometry</a>(modeli,modelj,modelk,loc,ptrmodelgeom);</div>
<div class="line"><a name="l04472"></a><span class="lineno"> 4472</span>&#160;    }</div>
<div class="line"><a name="l04473"></a><span class="lineno"> 4473</span>&#160;    <span class="comment">// determine model u^t</span></div>
<div class="line"><a name="l04474"></a><span class="lineno"> 4474</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#afc93fd4a6f7a2b87a9315d5fba5a529c">ucon_calc</a>(prmodel, ptrmodelgeom, uconmodel, othersmodel) &gt;= 1){</div>
<div class="line"><a name="l04475"></a><span class="lineno"> 4475</span>&#160;      <span class="comment">// model no good</span></div>
<div class="line"><a name="l04476"></a><span class="lineno"> 4476</span>&#160;      <span class="keywordflow">if</span>(bctype==0){</div>
<div class="line"><a name="l04477"></a><span class="lineno"> 4477</span>&#160;        dualfprintf(fail_file,<span class="stringliteral">&quot;serious failure.  On-grid values and fixed bc values used have u^t imaginary: modeli: %d modelj: %d uttdiscr: %21.15g\n&quot;</span>,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[1]+modeli,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[2]+modelj,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a17d1dcb879f265654da7e71c3f4fa999">uttdiscr</a>);</div>
<div class="line"><a name="l04478"></a><span class="lineno"> 4478</span>&#160;        <a class="code" href="../../d8/d5b/defs_8general_8h.html#acb23ef211402a7d4f09b95fa70f38766">whocalleducon</a>=0; <span class="comment">// turn on failures</span></div>
<div class="line"><a name="l04479"></a><span class="lineno"> 4479</span>&#160;        <span class="keywordflow">if</span> (fail(i,j,k,loc,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab80e0a4ad12720e26d9e904b4796ec14">FAIL_UTCALC_DISCR</a>) &gt;= 1)</div>
<div class="line"><a name="l04480"></a><span class="lineno"> 4480</span>&#160;          <span class="keywordflow">return</span> (1);</div>
<div class="line"><a name="l04481"></a><span class="lineno"> 4481</span>&#160;      }</div>
<div class="line"><a name="l04482"></a><span class="lineno"> 4482</span>&#160;      <span class="keywordflow">else</span> uconmodel[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>]=realutlimit=1E30;</div>
<div class="line"><a name="l04483"></a><span class="lineno"> 4483</span>&#160;      <span class="comment">// otherwise normal to sometimes encounter failure if using model in bc (which isn&#39;t currently)</span></div>
<div class="line"><a name="l04484"></a><span class="lineno"> 4484</span>&#160;    }</div>
<div class="line"><a name="l04485"></a><span class="lineno"> 4485</span>&#160;    <span class="keywordflow">else</span> realutlimit=uconmodel[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>]; <span class="comment">// model ut</span></div>
<div class="line"><a name="l04486"></a><span class="lineno"> 4486</span>&#160;    modeldiscr=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a17d1dcb879f265654da7e71c3f4fa999">uttdiscr</a>;</div>
<div class="line"><a name="l04487"></a><span class="lineno"> 4487</span>&#160;</div>
<div class="line"><a name="l04488"></a><span class="lineno"> 4488</span>&#160;    <span class="comment">// upper limit (if model has large u^t, assume ok to have one)</span></div>
<div class="line"><a name="l04489"></a><span class="lineno"> 4489</span>&#160;    <span class="keywordflow">if</span>(realutlimit&gt;<a class="code" href="../../de/d95/fixup_8c.html#ab40b40ed45fddec017da48326d878dc3">UTLIMIT</a>) realutlimit=<a class="code" href="../../de/d95/fixup_8c.html#ab40b40ed45fddec017da48326d878dc3">UTLIMIT</a>;</div>
<div class="line"><a name="l04490"></a><span class="lineno"> 4490</span>&#160;  }</div>
<div class="line"><a name="l04491"></a><span class="lineno"> 4491</span>&#160;  <span class="keywordflow">else</span> realutlimit=<a class="code" href="../../de/d95/fixup_8c.html#a1ab56ab19113f9b4b5cb4fcf9ce312cc">UTFIX</a>; <span class="comment">// no model, just fix based upon normal observer since no idea what is &quot;ok&quot; to have</span></div>
<div class="line"><a name="l04492"></a><span class="lineno"> 4492</span>&#160;</div>
<div class="line"><a name="l04493"></a><span class="lineno"> 4493</span>&#160;  realdiscrlimit=1.0/(realutlimit*realutlimit);</div>
<div class="line"><a name="l04494"></a><span class="lineno"> 4494</span>&#160;  newerr=olderr=fabs(lastuttdiscr-realdiscrlimit)/realdiscrlimit;</div>
<div class="line"><a name="l04495"></a><span class="lineno"> 4495</span>&#160;</div>
<div class="line"><a name="l04496"></a><span class="lineno"> 4496</span>&#160;</div>
<div class="line"><a name="l04497"></a><span class="lineno"> 4497</span>&#160;  <span class="comment">// LOOP</span></div>
<div class="line"><a name="l04498"></a><span class="lineno"> 4498</span>&#160;</div>
<div class="line"><a name="l04499"></a><span class="lineno"> 4499</span>&#160;</div>
<div class="line"><a name="l04500"></a><span class="lineno"> 4500</span>&#160;  <span class="comment">// otherwise need to fix</span></div>
<div class="line"><a name="l04501"></a><span class="lineno"> 4501</span>&#160;  failedcheck=0;</div>
<div class="line"><a name="l04502"></a><span class="lineno"> 4502</span>&#160;</div>
<div class="line"><a name="l04503"></a><span class="lineno"> 4503</span>&#160;  trialcount=0;</div>
<div class="line"><a name="l04504"></a><span class="lineno"> 4504</span>&#160;  <span class="keywordflow">while</span>( ((newerr&gt;toldiscr)&amp;&amp;(method==1)) ||((ucon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>]&gt;realutlimit)&amp;&amp;(method==0)) ){</div>
<div class="line"><a name="l04505"></a><span class="lineno"> 4505</span>&#160;    <span class="comment">// see if we can fix things since outside limits</span></div>
<div class="line"><a name="l04506"></a><span class="lineno"> 4506</span>&#160;</div>
<div class="line"><a name="l04507"></a><span class="lineno"> 4507</span>&#160;    <span class="comment">// determine gradient</span></div>
<div class="line"><a name="l04508"></a><span class="lineno"> 4508</span>&#160;    normsq=0.0;</div>
<div class="line"><a name="l04509"></a><span class="lineno"> 4509</span>&#160;    <span class="keywordflow">for</span>(i=1;i&lt;=3;i++){</div>
<div class="line"><a name="l04510"></a><span class="lineno"> 4510</span>&#160;      gradient[<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>]=2.0*(ptrgeom-&gt;gcov[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(0,i)]);</div>
<div class="line"><a name="l04511"></a><span class="lineno"> 4511</span>&#160;      <span class="keywordflow">for</span>(j=1;j&lt;=3;j++){</div>
<div class="line"><a name="l04512"></a><span class="lineno"> 4512</span>&#160;        <span class="comment">// note that ucon is the same as pr here since ucon_calc sets spatial terms to pr</span></div>
<div class="line"><a name="l04513"></a><span class="lineno"> 4513</span>&#160;        gradient[<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>]+=2.0*ucon[<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>]*ptrgeom-&gt;gcov[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(i,j)];</div>
<div class="line"><a name="l04514"></a><span class="lineno"> 4514</span>&#160;      }</div>
<div class="line"><a name="l04515"></a><span class="lineno"> 4515</span>&#160;      normsq+=gradient[<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>]*gradient[<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>];</div>
<div class="line"><a name="l04516"></a><span class="lineno"> 4516</span>&#160;    }</div>
<div class="line"><a name="l04517"></a><span class="lineno"> 4517</span>&#160;    <span class="comment">// normalize gradient</span></div>
<div class="line"><a name="l04518"></a><span class="lineno"> 4518</span>&#160;    <span class="keywordflow">for</span>(i=1;i&lt;=3;i++){</div>
<div class="line"><a name="l04519"></a><span class="lineno"> 4519</span>&#160;      gradient[<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>]/=sqrt(normsq);</div>
<div class="line"><a name="l04520"></a><span class="lineno"> 4520</span>&#160;    }</div>
<div class="line"><a name="l04521"></a><span class="lineno"> 4521</span>&#160;    <span class="comment">// save old pr and change new one    </span></div>
<div class="line"><a name="l04522"></a><span class="lineno"> 4522</span>&#160;    <span class="keywordflow">if</span>(method==0){</div>
<div class="line"><a name="l04523"></a><span class="lineno"> 4523</span>&#160;      <span class="keywordflow">for</span>(i=1;i&lt;=3;i++){</div>
<div class="line"><a name="l04524"></a><span class="lineno"> 4524</span>&#160; </div>
<div class="line"><a name="l04525"></a><span class="lineno"> 4525</span>&#160;        pr[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>+i-1]-=gradient[<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>]*<a class="code" href="../../de/d95/fixup_8c.html#afa5aa04693e0628abceb026dade58034">GRADIENTFACTOR</a>*((<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a>)(ntrials)+1.0)/((<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a>)(ntrials)-(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a>)(trialcount)+1.0);</div>
<div class="line"><a name="l04526"></a><span class="lineno"> 4526</span>&#160;        <span class="comment">//pr[U1+i-1]-=gradient[i]*GRADIENTFACTOR;</span></div>
<div class="line"><a name="l04527"></a><span class="lineno"> 4527</span>&#160;      }</div>
<div class="line"><a name="l04528"></a><span class="lineno"> 4528</span>&#160;    }</div>
<div class="line"><a name="l04529"></a><span class="lineno"> 4529</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(method==1){</div>
<div class="line"><a name="l04530"></a><span class="lineno"> 4530</span>&#160;      <span class="keywordflow">for</span>(i=1;i&lt;=3;i++){</div>
<div class="line"><a name="l04531"></a><span class="lineno"> 4531</span>&#160;        prold[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>+i-1]=pr[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>+i-1];</div>
<div class="line"><a name="l04532"></a><span class="lineno"> 4532</span>&#160;        <span class="keywordflow">if</span>(realdiscrlimit-<a class="code" href="../../d8/d5b/defs_8general_8h.html#a17d1dcb879f265654da7e71c3f4fa999">uttdiscr</a>&gt;0) pr[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>+i-1]-=gradient[<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>]*dampfactor;</div>
<div class="line"><a name="l04533"></a><span class="lineno"> 4533</span>&#160;        <span class="keywordflow">else</span>  pr[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>+i-1]+=gradient[<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>]*dampfactor;</div>
<div class="line"><a name="l04534"></a><span class="lineno"> 4534</span>&#160;      }</div>
<div class="line"><a name="l04535"></a><span class="lineno"> 4535</span>&#160;    }</div>
<div class="line"><a name="l04536"></a><span class="lineno"> 4536</span>&#160;    <span class="comment">// get new ucon[TT], is it ok now?</span></div>
<div class="line"><a name="l04537"></a><span class="lineno"> 4537</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#afc93fd4a6f7a2b87a9315d5fba5a529c">ucon_calc</a>(pr, ptrgeom, ucon,others) &gt;= 1) ucon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>]=1E30; <span class="comment">// bad bad, keep going</span></div>
<div class="line"><a name="l04538"></a><span class="lineno"> 4538</span>&#160;    newerr=fabs(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a17d1dcb879f265654da7e71c3f4fa999">uttdiscr</a>-realdiscrlimit)/realdiscrlimit;</div>
<div class="line"><a name="l04539"></a><span class="lineno"> 4539</span>&#160;    <span class="keywordflow">if</span>((method==1)&amp;&amp;(newerr&gt;=olderr)){</div>
<div class="line"><a name="l04540"></a><span class="lineno"> 4540</span>&#160;      <span class="comment">// then went too far (if going in right direction at all)</span></div>
<div class="line"><a name="l04541"></a><span class="lineno"> 4541</span>&#160;      dampfactor*=dampfactorchange;</div>
<div class="line"><a name="l04542"></a><span class="lineno"> 4542</span>&#160;      <span class="keywordflow">if</span>(dampfactor&lt;1<a class="code" href="../../d8/d60/init_8c.html#a07484107e6d9fdf38b53edf631d6511d">E</a>-10){</div>
<div class="line"><a name="l04543"></a><span class="lineno"> 4543</span>&#160;        <span class="keywordflow">if</span>((fabs(ucon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>]-realutlimit)/realutlimit)&lt;0.5) <span class="keywordflow">break</span>; <span class="comment">// just be happy you got out alive</span></div>
<div class="line"><a name="l04544"></a><span class="lineno"> 4544</span>&#160;        <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l04545"></a><span class="lineno"> 4545</span>&#160;          failedcheck=1;</div>
<div class="line"><a name="l04546"></a><span class="lineno"> 4546</span>&#160;          <span class="keywordflow">if</span>(debugfail&gt;=1) dualfprintf(fail_file,<span class="stringliteral">&quot;dumpfactor reached min\n&quot;</span>);</div>
<div class="line"><a name="l04547"></a><span class="lineno"> 4547</span>&#160;          <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l04548"></a><span class="lineno"> 4548</span>&#160;        }</div>
<div class="line"><a name="l04549"></a><span class="lineno"> 4549</span>&#160;      }</div>
<div class="line"><a name="l04550"></a><span class="lineno"> 4550</span>&#160;      <span class="comment">// revert to old pr and start again</span></div>
<div class="line"><a name="l04551"></a><span class="lineno"> 4551</span>&#160;      <span class="keywordflow">for</span>(i=1;i&lt;=3;i++){</div>
<div class="line"><a name="l04552"></a><span class="lineno"> 4552</span>&#160;        pr[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>+i-1]=prold[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>+i-1];</div>
<div class="line"><a name="l04553"></a><span class="lineno"> 4553</span>&#160;      }</div>
<div class="line"><a name="l04554"></a><span class="lineno"> 4554</span>&#160;    }</div>
<div class="line"><a name="l04555"></a><span class="lineno"> 4555</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l04556"></a><span class="lineno"> 4556</span>&#160;      trialcount++; <span class="comment">// only iterate if good step</span></div>
<div class="line"><a name="l04557"></a><span class="lineno"> 4557</span>&#160;      olderr=newerr;</div>
<div class="line"><a name="l04558"></a><span class="lineno"> 4558</span>&#160;    }</div>
<div class="line"><a name="l04559"></a><span class="lineno"> 4559</span>&#160;    <span class="keywordflow">if</span>(debugfail&gt;=2) {</div>
<div class="line"><a name="l04560"></a><span class="lineno"> 4560</span>&#160;      <span class="keywordflow">if</span>((myid==0)&amp;&amp;(ptrgeom-&gt;i==117)&amp;&amp;(ptrgeom-&gt;j==-1)){</div>
<div class="line"><a name="l04561"></a><span class="lineno"> 4561</span>&#160;        dualfprintf(fail_file,<span class="stringliteral">&quot;trialcount=%d uttdiscr0=%21.15g uttdiscr=%21.15g newerr: %21.15g dampfactor=%21.15g\n&quot;</span>,trialcount,uttdiscr0,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a17d1dcb879f265654da7e71c3f4fa999">uttdiscr</a>,newerr,dampfactor);</div>
<div class="line"><a name="l04562"></a><span class="lineno"> 4562</span>&#160;      }</div>
<div class="line"><a name="l04563"></a><span class="lineno"> 4563</span>&#160;    }</div>
<div class="line"><a name="l04564"></a><span class="lineno"> 4564</span>&#160;    <span class="comment">// even if not bad, could still be too large, so check</span></div>
<div class="line"><a name="l04565"></a><span class="lineno"> 4565</span>&#160;    <span class="keywordflow">if</span>(trialcount==ntrials){</div>
<div class="line"><a name="l04566"></a><span class="lineno"> 4566</span>&#160;      <span class="keywordflow">if</span>((fabs(ucon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>]-realutlimit)/realutlimit)&lt;0.5) <span class="keywordflow">break</span>; <span class="comment">// just be happy you got out alive</span></div>
<div class="line"><a name="l04567"></a><span class="lineno"> 4567</span>&#160;      <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l04568"></a><span class="lineno"> 4568</span>&#160;        failedcheck=1;</div>
<div class="line"><a name="l04569"></a><span class="lineno"> 4569</span>&#160;        <span class="keywordflow">if</span>(debugfail&gt;=1) dualfprintf(fail_file,<span class="stringliteral">&quot;number of trials reached max\n&quot;</span>);</div>
<div class="line"><a name="l04570"></a><span class="lineno"> 4570</span>&#160;        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l04571"></a><span class="lineno"> 4571</span>&#160;      }</div>
<div class="line"><a name="l04572"></a><span class="lineno"> 4572</span>&#160;    }</div>
<div class="line"><a name="l04573"></a><span class="lineno"> 4573</span>&#160;  }</div>
<div class="line"><a name="l04574"></a><span class="lineno"> 4574</span>&#160;  <a class="code" href="../../d8/d5b/defs_8general_8h.html#acb23ef211402a7d4f09b95fa70f38766">whocalleducon</a>=0; <span class="comment">// turn back on failures</span></div>
<div class="line"><a name="l04575"></a><span class="lineno"> 4575</span>&#160;</div>
<div class="line"><a name="l04576"></a><span class="lineno"> 4576</span>&#160;  <span class="keywordflow">if</span>(failedcheck){</div>
<div class="line"><a name="l04577"></a><span class="lineno"> 4577</span>&#160;    <span class="keywordflow">if</span>(debugfail&gt;=1) dualfprintf(fail_file,<span class="stringliteral">&quot;couldn&#39;t fix ucon[TT]=%21.15g newerr=%21.15g uttdiscr=%21.15g\n&quot;</span>,ucon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>],newerr,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a17d1dcb879f265654da7e71c3f4fa999">uttdiscr</a>);</div>
<div class="line"><a name="l04578"></a><span class="lineno"> 4578</span>&#160;    <span class="keywordflow">if</span>(debugfail&gt;=1) dualfprintf(fail_file,<span class="stringliteral">&quot;check_pr failure: t=%21.15g , couldn&#39;t fix ucon: i=%d j=%d k=%d p=%d ucon[TT]=%21.15g realutlimit=%21.15g uconmodel[TT]=%21.15g\n&quot;</span>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#ae1ee1e1c83c3f70e2e1afed4f4f5b41e">t</a>,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[1]+ptrgeom-&gt;i,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[2]+ptrgeom-&gt;j,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[3]+ptrgeom-&gt;k,ptrgeom-&gt;p,ucon[TT],realutlimit,uconmodel[TT]);</div>
<div class="line"><a name="l04579"></a><span class="lineno"> 4579</span>&#160;    <span class="keywordflow">if</span>(debugfail&gt;=1) dualfprintf(fail_file,<span class="stringliteral">&quot;uttdiscr0=%21.15g uttdiscr=%21.15g realdiscrlimit=%21.15g modeldiscr=%21.15g dampfactor=%21.15g\n&quot;</span>,uttdiscr0,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a17d1dcb879f265654da7e71c3f4fa999">uttdiscr</a>,realdiscrlimit,modeldiscr,dampfactor);</div>
<div class="line"><a name="l04580"></a><span class="lineno"> 4580</span>&#160;    <span class="comment">// will still run perhaps with UT&gt;realutlimit, could stop it, but won&#39;t for now      </span></div>
<div class="line"><a name="l04581"></a><span class="lineno"> 4581</span>&#160;    <span class="keywordflow">if</span>(debugfail&gt;=1){</div>
<div class="line"><a name="l04582"></a><span class="lineno"> 4582</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl){</div>
<div class="line"><a name="l04583"></a><span class="lineno"> 4583</span>&#160;        dualfprintf(fail_file,<span class="stringliteral">&quot;pr[%d]=%21.15g prmodel[%d]=%21.15g\n&quot;</span>,pl,pr[pl],pl,prmodel[pl]);</div>
<div class="line"><a name="l04584"></a><span class="lineno"> 4584</span>&#160;      }</div>
<div class="line"><a name="l04585"></a><span class="lineno"> 4585</span>&#160;      <span class="keywordflow">if</span>(debugfail&gt;=1) dualfprintf(fail_file,<span class="stringliteral">&quot;need better algorithm: check_pr failure: couldn&#39;t fix ucon: i=%d j=%d k=%d p=%d ucon[TT]=%21.15g\n&quot;</span>,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[1]+ptrgeom-&gt;i,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[2]+ptrgeom-&gt;j,<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[3]+ptrgeom-&gt;k,ptrgeom-&gt;p,ucon[TT]);</div>
<div class="line"><a name="l04586"></a><span class="lineno"> 4586</span>&#160;    }</div>
<div class="line"><a name="l04587"></a><span class="lineno"> 4587</span>&#160;</div>
<div class="line"><a name="l04588"></a><span class="lineno"> 4588</span>&#160;    <span class="comment">// force to normal observer solution</span></div>
<div class="line"><a name="l04589"></a><span class="lineno"> 4589</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl) pr[pl]=probs[pl];</div>
<div class="line"><a name="l04590"></a><span class="lineno"> 4590</span>&#160;  }</div>
<div class="line"><a name="l04591"></a><span class="lineno"> 4591</span>&#160;</div>
<div class="line"><a name="l04592"></a><span class="lineno"> 4592</span>&#160;  <span class="comment">// account for changes</span></div>
<div class="line"><a name="l04593"></a><span class="lineno"> 4593</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> prdiag[NPR];</div>
<div class="line"><a name="l04594"></a><span class="lineno"> 4594</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) prdiag[pl]=pr0[pl];</div>
<div class="line"><a name="l04595"></a><span class="lineno"> 4595</span>&#160;  <span class="keywordtype">int</span> doingmhdfixup=1;</div>
<div class="line"><a name="l04596"></a><span class="lineno"> 4596</span>&#160;  <span class="keywordtype">int</span> docorrectucons=(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a55732148d2616d6d1f5d2abbe8710850">DOENOFLUX</a> != <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#adacaaf8526353cfe870206f0cf4d2ca7" title="for DOENOFLUX: 0: no ENO flux reconstruction 1: reconstruct F for finite difference rep...">NOENOFLUX</a>);</div>
<div class="line"><a name="l04597"></a><span class="lineno"> 4597</span>&#160;  diag_fixup(docorrectucons,prdiag, pr, ucons, ptrgeom, finalstep,doingmhdfixup,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#af0f4fd6539ab981966c52db827310106">COUNTLIMITGAMMAACT</a>);</div>
<div class="line"><a name="l04598"></a><span class="lineno"> 4598</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) prdiag[pl]=pr[pl];</div>
<div class="line"><a name="l04599"></a><span class="lineno"> 4599</span>&#160;</div>
<div class="line"><a name="l04600"></a><span class="lineno"> 4600</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l04601"></a><span class="lineno"> 4601</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l04602"></a><span class="lineno"> 4602</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l04603"></a><span class="lineno"> 4603</span>&#160;}</div>
<div class="line"><a name="l04604"></a><span class="lineno"> 4604</span>&#160;</div>
<div class="line"><a name="l04605"></a><span class="lineno"> 4605</span>&#160;</div>
<div class="line"><a name="l04608"></a><span class="lineno"> 4608</span>&#160;<span class="keywordtype">int</span> inflow_check_4vel(<span class="keywordtype">int</span> dir, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *ucons, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <span class="keywordtype">int</span> finalstep)</div>
<div class="line"><a name="l04609"></a><span class="lineno"> 4609</span>&#160;{</div>
<div class="line"><a name="l04610"></a><span class="lineno"> 4610</span>&#160;  <span class="keywordtype">int</span> ii,jj,kk;</div>
<div class="line"><a name="l04611"></a><span class="lineno"> 4611</span>&#160;  <span class="keywordtype">int</span> iin,iout;</div>
<div class="line"><a name="l04612"></a><span class="lineno"> 4612</span>&#160;  <span class="keywordtype">int</span> jjn,jout;</div>
<div class="line"><a name="l04613"></a><span class="lineno"> 4613</span>&#160;  <span class="keywordtype">int</span> kkn,kout;</div>
<div class="line"><a name="l04614"></a><span class="lineno"> 4614</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> pr0[NPR],prdiag[NPR];</div>
<div class="line"><a name="l04615"></a><span class="lineno"> 4615</span>&#160;  <span class="keywordtype">int</span> pl,pliter;</div>
<div class="line"><a name="l04616"></a><span class="lineno"> 4616</span>&#160;</div>
<div class="line"><a name="l04617"></a><span class="lineno"> 4617</span>&#160;</div>
<div class="line"><a name="l04618"></a><span class="lineno"> 4618</span>&#160;  ii=ptrgeom-&gt;i;</div>
<div class="line"><a name="l04619"></a><span class="lineno"> 4619</span>&#160;  jj=ptrgeom-&gt;j;</div>
<div class="line"><a name="l04620"></a><span class="lineno"> 4620</span>&#160;  kk=ptrgeom-&gt;k;</div>
<div class="line"><a name="l04621"></a><span class="lineno"> 4621</span>&#160;</div>
<div class="line"><a name="l04622"></a><span class="lineno"> 4622</span>&#160;</div>
<div class="line"><a name="l04623"></a><span class="lineno"> 4623</span>&#160;  <span class="keywordflow">if</span>(dir==1){</div>
<div class="line"><a name="l04624"></a><span class="lineno"> 4624</span>&#160;    <span class="comment">// for dir==1</span></div>
<div class="line"><a name="l04625"></a><span class="lineno"> 4625</span>&#160;    <span class="keywordflow">if</span>((ptrgeom-&gt;p==CENT)||(ptrgeom-&gt;p==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a5b4b42f50fd7667c7d22d8001811bc7e">FACE2</a>)||(ptrgeom-&gt;p==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a630fdcefb04bdca66118cfd21476e8fd">FACE3</a>)||(ptrgeom-&gt;p==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a1068bcf25c9f187a8db0f422e0af64c8">CORN1</a>) ){ iin=-1; iout=<a class="code" href="../../dd/d46/mpidefs_8h.html#ab3efab8b1f2dffc5907e0b0a5aa3988f">totalsize</a>[1]; }</div>
<div class="line"><a name="l04626"></a><span class="lineno"> 4626</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>((ptrgeom-&gt;p==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a1df736ddba855d7b429869f9f09dbd66">FACE1</a>)||(ptrgeom-&gt;p==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a1a05e117efd4dbc39b7c590141004470">CORN3</a>)||(ptrgeom-&gt;p==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab10e4ab484f1edd4cecb418ff22a743a">CORN2</a>) ){ iin=0; iout=<a class="code" href="../../dd/d46/mpidefs_8h.html#ab3efab8b1f2dffc5907e0b0a5aa3988f">totalsize</a>[1]; }</div>
<div class="line"><a name="l04627"></a><span class="lineno"> 4627</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l04628"></a><span class="lineno"> 4628</span>&#160;      dualfprintf(fail_file,<span class="stringliteral">&quot;dir=%d no such location: %d\n&quot;</span>,dir,ptrgeom-&gt;p);</div>
<div class="line"><a name="l04629"></a><span class="lineno"> 4629</span>&#160;      myexit(1);</div>
<div class="line"><a name="l04630"></a><span class="lineno"> 4630</span>&#160;    }</div>
<div class="line"><a name="l04631"></a><span class="lineno"> 4631</span>&#160;    <span class="keywordflow">if</span>( </div>
<div class="line"><a name="l04632"></a><span class="lineno"> 4632</span>&#160;       ((<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[1]+ii&lt;=iin)&amp;&amp;((<a class="code" href="../../d8/d5b/defs_8general_8h.html#a516ad1adc872921939df143a56a721af">BCtype</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aab7332b2c03d905515d5350d4fd0850f">X1DN</a>]==OUTFLOW || <a class="code" href="../../d8/d5b/defs_8general_8h.html#a516ad1adc872921939df143a56a721af">BCtype</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aab7332b2c03d905515d5350d4fd0850f">X1DN</a>]==HORIZONOUTFLOW))&amp;&amp;(pr[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>+dir-1] &gt; 0.)) </div>
<div class="line"><a name="l04633"></a><span class="lineno"> 4633</span>&#160;       ||((<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[1]+ii&gt;=iout)&amp;&amp;((<a class="code" href="../../d8/d5b/defs_8general_8h.html#a516ad1adc872921939df143a56a721af">BCtype</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6a3603145c91f722d74610fbd6e4f696" title="----------—&gt; r | 3 | 1-0 | 2 v theta and likewise for 4,5 (4=out,5=in) directions:">X1UP</a>]==OUTFLOW || <a class="code" href="../../d8/d5b/defs_8general_8h.html#a516ad1adc872921939df143a56a721af">BCtype</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6a3603145c91f722d74610fbd6e4f696" title="----------—&gt; r | 3 | 1-0 | 2 v theta and likewise for 4,5 (4=out,5=in) directions:">X1UP</a>]==HORIZONOUTFLOW))&amp;&amp;(pr[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>+dir-1] &lt; 0.)) </div>
<div class="line"><a name="l04634"></a><span class="lineno"> 4634</span>&#160;        ) {</div>
<div class="line"><a name="l04635"></a><span class="lineno"> 4635</span>&#160;      <span class="comment">// set pre-primitive</span></div>
<div class="line"><a name="l04636"></a><span class="lineno"> 4636</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl)    pr0[pl]=pr[pl];</div>
<div class="line"><a name="l04637"></a><span class="lineno"> 4637</span>&#160;      pr[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>]=0;</div>
<div class="line"><a name="l04638"></a><span class="lineno"> 4638</span>&#160;      </div>
<div class="line"><a name="l04639"></a><span class="lineno"> 4639</span>&#160;      <span class="comment">// account for changes</span></div>
<div class="line"><a name="l04640"></a><span class="lineno"> 4640</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) prdiag[pl]=pr0[pl];</div>
<div class="line"><a name="l04641"></a><span class="lineno"> 4641</span>&#160;      <span class="keywordtype">int</span> doingmhdfixup=1;</div>
<div class="line"><a name="l04642"></a><span class="lineno"> 4642</span>&#160;      diag_fixup((<a class="code" href="../../d8/d5b/defs_8general_8h.html#a55732148d2616d6d1f5d2abbe8710850">DOENOFLUX</a> != <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#adacaaf8526353cfe870206f0cf4d2ca7" title="for DOENOFLUX: 0: no ENO flux reconstruction 1: reconstruct F for finite difference rep...">NOENOFLUX</a>),prdiag, pr, ucons, ptrgeom, finalstep,doingmhdfixup,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a418c34a02910942756c1523b7ceb4b95">COUNTINFLOWACT</a>);</div>
<div class="line"><a name="l04643"></a><span class="lineno"> 4643</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) prdiag[pl]=pr[pl];</div>
<div class="line"><a name="l04644"></a><span class="lineno"> 4644</span>&#160;    }</div>
<div class="line"><a name="l04645"></a><span class="lineno"> 4645</span>&#160;    if(<a class="code" href="../../da/d3e/definit_8h.html#a99ba7daf58b283bc831b8f507f5873a4" title="#define EOMTYPE EOMCOLDGRMHD">EOMRADTYPE</a>!=<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a993e29ef4139116d822d89bccb92180d" title="radiation equations of motion">EOMRADNONE</a>&amp;&amp;(</div>
<div class="line"><a name="l04646"></a><span class="lineno"> 4646</span>&#160;                                ((<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[1]+ii&lt;=iin)&amp;&amp;((<a class="code" href="../../d8/d5b/defs_8general_8h.html#a516ad1adc872921939df143a56a721af">BCtype</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aab7332b2c03d905515d5350d4fd0850f">X1DN</a>]==OUTFLOW || <a class="code" href="../../d8/d5b/defs_8general_8h.html#a516ad1adc872921939df143a56a721af">BCtype</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aab7332b2c03d905515d5350d4fd0850f">X1DN</a>]==HORIZONOUTFLOW))&amp;&amp;(pr[URAD1+dir-1] &gt; 0.)) </div>
<div class="line"><a name="l04647"></a><span class="lineno"> 4647</span>&#160;                                ||((<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[1]+ii&gt;=iout)&amp;&amp;((<a class="code" href="../../d8/d5b/defs_8general_8h.html#a516ad1adc872921939df143a56a721af">BCtype</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6a3603145c91f722d74610fbd6e4f696" title="----------—&gt; r | 3 | 1-0 | 2 v theta and likewise for 4,5 (4=out,5=in) directions:">X1UP</a>]==OUTFLOW || <a class="code" href="../../d8/d5b/defs_8general_8h.html#a516ad1adc872921939df143a56a721af">BCtype</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6a3603145c91f722d74610fbd6e4f696" title="----------—&gt; r | 3 | 1-0 | 2 v theta and likewise for 4,5 (4=out,5=in) directions:">X1UP</a>]==HORIZONOUTFLOW))&amp;&amp;(pr[URAD1+dir-1] &lt; 0.)) </div>
<div class="line"><a name="l04648"></a><span class="lineno"> 4648</span>&#160;                                )</div>
<div class="line"><a name="l04649"></a><span class="lineno"> 4649</span>&#160;       ) {</div>
<div class="line"><a name="l04650"></a><span class="lineno"> 4650</span>&#160;      <span class="comment">// set pre-primitive</span></div>
<div class="line"><a name="l04651"></a><span class="lineno"> 4651</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl)    pr0[pl]=pr[pl];</div>
<div class="line"><a name="l04652"></a><span class="lineno"> 4652</span>&#160;      pr[URAD1]=0;</div>
<div class="line"><a name="l04653"></a><span class="lineno"> 4653</span>&#160;      </div>
<div class="line"><a name="l04654"></a><span class="lineno"> 4654</span>&#160;      <span class="comment">// account for changes</span></div>
<div class="line"><a name="l04655"></a><span class="lineno"> 4655</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) prdiag[pl]=pr0[pl];</div>
<div class="line"><a name="l04656"></a><span class="lineno"> 4656</span>&#160;      <span class="keywordtype">int</span> doingmhdfixup=1;</div>
<div class="line"><a name="l04657"></a><span class="lineno"> 4657</span>&#160;      diag_fixup((<a class="code" href="../../d8/d5b/defs_8general_8h.html#a55732148d2616d6d1f5d2abbe8710850">DOENOFLUX</a> != NOENOFLUX),prdiag, pr, ucons, ptrgeom, finalstep,doingmhdfixup,COUNTINFLOWACT);</div>
<div class="line"><a name="l04658"></a><span class="lineno"> 4658</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) prdiag[pl]=pr[pl];</div>
<div class="line"><a name="l04659"></a><span class="lineno"> 4659</span>&#160;    }</div>
<div class="line"><a name="l04660"></a><span class="lineno"> 4660</span>&#160;    if( </div>
<div class="line"><a name="l04661"></a><span class="lineno"> 4661</span>&#160;       ((<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[1]+ii&lt;=iin)&amp;&amp;(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a516ad1adc872921939df143a56a721af">BCtype</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aab7332b2c03d905515d5350d4fd0850f">X1DN</a>]==FIXEDOUTFLOW)&amp;&amp;(pr[U1+dir-1] &gt; 0.)) </div>
<div class="line"><a name="l04662"></a><span class="lineno"> 4662</span>&#160;       ||((<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[1]+ii&gt;=iout)&amp;&amp;(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a516ad1adc872921939df143a56a721af">BCtype</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6a3603145c91f722d74610fbd6e4f696" title="----------—&gt; r | 3 | 1-0 | 2 v theta and likewise for 4,5 (4=out,5=in) directions:">X1UP</a>]==FIXEDOUTFLOW)&amp;&amp;(pr[U1+dir-1] &lt; 0.)) </div>
<div class="line"><a name="l04663"></a><span class="lineno"> 4663</span>&#160;        ) {</div>
<div class="line"><a name="l04664"></a><span class="lineno"> 4664</span>&#160;      <span class="comment">// set pre-primitive</span></div>
<div class="line"><a name="l04665"></a><span class="lineno"> 4665</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl)    pr0[pl]=pr[pl];</div>
<div class="line"><a name="l04666"></a><span class="lineno"> 4666</span>&#160;      <span class="comment">// then inflow according to Bondi-like atmosphere</span></div>
<div class="line"><a name="l04667"></a><span class="lineno"> 4667</span>&#160;      set_atmosphere(1,<a class="code" href="../../da/d3e/definit_8h.html#a3d14480f30d39eff4e51ae8bc93df56f" title="whether we use ultimately precise inversion or &quot;workable&quot; inversion precision (see utoprim&#39;s for ho...">WHICHVEL</a>,ptrgeom,pr);</div>
<div class="line"><a name="l04668"></a><span class="lineno"> 4668</span>&#160;</div>
<div class="line"><a name="l04669"></a><span class="lineno"> 4669</span>&#160;      <span class="comment">// below never really accounted for since on boundary zones</span></div>
<div class="line"><a name="l04670"></a><span class="lineno"> 4670</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) prdiag[pl]=pr0[pl];</div>
<div class="line"><a name="l04671"></a><span class="lineno"> 4671</span>&#160;      <span class="keywordtype">int</span> doingmhdfixup=1;</div>
<div class="line"><a name="l04672"></a><span class="lineno"> 4672</span>&#160;      diag_fixup((<a class="code" href="../../d8/d5b/defs_8general_8h.html#a55732148d2616d6d1f5d2abbe8710850">DOENOFLUX</a> != NOENOFLUX),prdiag, pr, ucons, ptrgeom, finalstep,doingmhdfixup,COUNTINFLOWACT);</div>
<div class="line"><a name="l04673"></a><span class="lineno"> 4673</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) prdiag[pl]=pr[pl];</div>
<div class="line"><a name="l04674"></a><span class="lineno"> 4674</span>&#160;    }</div>
<div class="line"><a name="l04675"></a><span class="lineno"> 4675</span>&#160;  }</div>
<div class="line"><a name="l04676"></a><span class="lineno"> 4676</span>&#160;  else if(dir==2){</div>
<div class="line"><a name="l04677"></a><span class="lineno"> 4677</span>&#160;    <span class="comment">// for dir==2</span></div>
<div class="line"><a name="l04678"></a><span class="lineno"> 4678</span>&#160;    <span class="keywordflow">if</span>((ptrgeom-&gt;p==CENT)||(ptrgeom-&gt;p==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a1df736ddba855d7b429869f9f09dbd66">FACE1</a>)||(ptrgeom-&gt;p==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a630fdcefb04bdca66118cfd21476e8fd">FACE3</a>)||(ptrgeom-&gt;p==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab10e4ab484f1edd4cecb418ff22a743a">CORN2</a>) ){ jjn=-1; jout=<a class="code" href="../../dd/d46/mpidefs_8h.html#ab3efab8b1f2dffc5907e0b0a5aa3988f">totalsize</a>[2]; }</div>
<div class="line"><a name="l04679"></a><span class="lineno"> 4679</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>((ptrgeom-&gt;p==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a5b4b42f50fd7667c7d22d8001811bc7e">FACE2</a>)||(ptrgeom-&gt;p==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a1068bcf25c9f187a8db0f422e0af64c8">CORN1</a>)||(ptrgeom-&gt;p==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a1a05e117efd4dbc39b7c590141004470">CORN3</a>) ){ jjn=0; jout=<a class="code" href="../../dd/d46/mpidefs_8h.html#ab3efab8b1f2dffc5907e0b0a5aa3988f">totalsize</a>[2]; }</div>
<div class="line"><a name="l04680"></a><span class="lineno"> 4680</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l04681"></a><span class="lineno"> 4681</span>&#160;      dualfprintf(fail_file,<span class="stringliteral">&quot;dir=%d no such location: %d\n&quot;</span>,dir,ptrgeom-&gt;p);</div>
<div class="line"><a name="l04682"></a><span class="lineno"> 4682</span>&#160;      myexit(1);</div>
<div class="line"><a name="l04683"></a><span class="lineno"> 4683</span>&#160;    }</div>
<div class="line"><a name="l04684"></a><span class="lineno"> 4684</span>&#160;    <span class="keywordflow">if</span>( </div>
<div class="line"><a name="l04685"></a><span class="lineno"> 4685</span>&#160;       ((<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[2]+jj&lt;=jjn)&amp;&amp;(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a516ad1adc872921939df143a56a721af">BCtype</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aae79dca9f851fb40349156f6bca1f8ca">X2DN</a>]==OUTFLOW)&amp;&amp;(pr[U1+dir-1] &gt; 0.)) </div>
<div class="line"><a name="l04686"></a><span class="lineno"> 4686</span>&#160;       ||((<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[2]+jj&gt;=jout)&amp;&amp;(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a516ad1adc872921939df143a56a721af">BCtype</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aa9363649053ac2e906715b3259a14954">X2UP</a>]==OUTFLOW)&amp;&amp;(pr[U1+dir-1] &lt; 0.)) </div>
<div class="line"><a name="l04687"></a><span class="lineno"> 4687</span>&#160;        ) {</div>
<div class="line"><a name="l04688"></a><span class="lineno"> 4688</span>&#160;      <span class="comment">// set pre-primitive</span></div>
<div class="line"><a name="l04689"></a><span class="lineno"> 4689</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl)    pr0[pl]=pr[pl];</div>
<div class="line"><a name="l04690"></a><span class="lineno"> 4690</span>&#160;      pr[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae907e773ef038f3fc0c2ad5de0cb0f07">U2</a>]=0;</div>
<div class="line"><a name="l04691"></a><span class="lineno"> 4691</span>&#160;</div>
<div class="line"><a name="l04692"></a><span class="lineno"> 4692</span>&#160;      <span class="comment">// account for changes</span></div>
<div class="line"><a name="l04693"></a><span class="lineno"> 4693</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) prdiag[pl]=pr0[pl];</div>
<div class="line"><a name="l04694"></a><span class="lineno"> 4694</span>&#160;      <span class="keywordtype">int</span> doingmhdfixup=1;</div>
<div class="line"><a name="l04695"></a><span class="lineno"> 4695</span>&#160;      diag_fixup((<a class="code" href="../../d8/d5b/defs_8general_8h.html#a55732148d2616d6d1f5d2abbe8710850">DOENOFLUX</a> != NOENOFLUX),prdiag, pr, ucons, ptrgeom, finalstep,doingmhdfixup,COUNTINFLOWACT);</div>
<div class="line"><a name="l04696"></a><span class="lineno"> 4696</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) prdiag[pl]=pr[pl];</div>
<div class="line"><a name="l04697"></a><span class="lineno"> 4697</span>&#160;    }</div>
<div class="line"><a name="l04698"></a><span class="lineno"> 4698</span>&#160;    if(<a class="code" href="../../da/d3e/definit_8h.html#a99ba7daf58b283bc831b8f507f5873a4" title="#define EOMTYPE EOMCOLDGRMHD">EOMRADTYPE</a>!=<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a993e29ef4139116d822d89bccb92180d" title="radiation equations of motion">EOMRADNONE</a>&amp;&amp;(</div>
<div class="line"><a name="l04699"></a><span class="lineno"> 4699</span>&#160;                                ((<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[2]+jj&lt;=jjn)&amp;&amp;(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a516ad1adc872921939df143a56a721af">BCtype</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aae79dca9f851fb40349156f6bca1f8ca">X2DN</a>]==OUTFLOW)&amp;&amp;(pr[URAD1+dir-1] &gt; 0.)) </div>
<div class="line"><a name="l04700"></a><span class="lineno"> 4700</span>&#160;                                ||((<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[2]+jj&gt;=jout)&amp;&amp;(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a516ad1adc872921939df143a56a721af">BCtype</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aa9363649053ac2e906715b3259a14954">X2UP</a>]==OUTFLOW)&amp;&amp;(pr[URAD1+dir-1] &lt; 0.)) </div>
<div class="line"><a name="l04701"></a><span class="lineno"> 4701</span>&#160;                                )</div>
<div class="line"><a name="l04702"></a><span class="lineno"> 4702</span>&#160;       ) {</div>
<div class="line"><a name="l04703"></a><span class="lineno"> 4703</span>&#160;      <span class="comment">// set pre-primitive</span></div>
<div class="line"><a name="l04704"></a><span class="lineno"> 4704</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl)    pr0[pl]=pr[pl];</div>
<div class="line"><a name="l04705"></a><span class="lineno"> 4705</span>&#160;      pr[URAD2]=0;</div>
<div class="line"><a name="l04706"></a><span class="lineno"> 4706</span>&#160;</div>
<div class="line"><a name="l04707"></a><span class="lineno"> 4707</span>&#160;      <span class="comment">// account for changes</span></div>
<div class="line"><a name="l04708"></a><span class="lineno"> 4708</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) prdiag[pl]=pr0[pl];</div>
<div class="line"><a name="l04709"></a><span class="lineno"> 4709</span>&#160;      <span class="keywordtype">int</span> doingmhdfixup=1;</div>
<div class="line"><a name="l04710"></a><span class="lineno"> 4710</span>&#160;      diag_fixup((<a class="code" href="../../d8/d5b/defs_8general_8h.html#a55732148d2616d6d1f5d2abbe8710850">DOENOFLUX</a> != NOENOFLUX),prdiag, pr, ucons, ptrgeom, finalstep,doingmhdfixup,COUNTINFLOWACT);</div>
<div class="line"><a name="l04711"></a><span class="lineno"> 4711</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) prdiag[pl]=pr[pl];</div>
<div class="line"><a name="l04712"></a><span class="lineno"> 4712</span>&#160;    }</div>
<div class="line"><a name="l04713"></a><span class="lineno"> 4713</span>&#160;  }</div>
<div class="line"><a name="l04714"></a><span class="lineno"> 4714</span>&#160;  else if(dir==3){</div>
<div class="line"><a name="l04715"></a><span class="lineno"> 4715</span>&#160;    <span class="comment">// for dir==3</span></div>
<div class="line"><a name="l04716"></a><span class="lineno"> 4716</span>&#160;    <span class="keywordflow">if</span>((ptrgeom-&gt;p==CENT)||(ptrgeom-&gt;p==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a5b4b42f50fd7667c7d22d8001811bc7e">FACE2</a>)||(ptrgeom-&gt;p==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a630fdcefb04bdca66118cfd21476e8fd">FACE3</a>)||(ptrgeom-&gt;p==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a1a05e117efd4dbc39b7c590141004470">CORN3</a>) ){ kkn=-1; kout=<a class="code" href="../../dd/d46/mpidefs_8h.html#ab3efab8b1f2dffc5907e0b0a5aa3988f">totalsize</a>[3]; }</div>
<div class="line"><a name="l04717"></a><span class="lineno"> 4717</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>((ptrgeom-&gt;p==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a630fdcefb04bdca66118cfd21476e8fd">FACE3</a>)||(ptrgeom-&gt;p==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a1068bcf25c9f187a8db0f422e0af64c8">CORN1</a>)||(ptrgeom-&gt;p==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab10e4ab484f1edd4cecb418ff22a743a">CORN2</a>) ){ kkn=0; kout=<a class="code" href="../../dd/d46/mpidefs_8h.html#ab3efab8b1f2dffc5907e0b0a5aa3988f">totalsize</a>[3]; }</div>
<div class="line"><a name="l04718"></a><span class="lineno"> 4718</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l04719"></a><span class="lineno"> 4719</span>&#160;      dualfprintf(fail_file,<span class="stringliteral">&quot;dir=%d no such location: %d\n&quot;</span>,dir,ptrgeom-&gt;p);</div>
<div class="line"><a name="l04720"></a><span class="lineno"> 4720</span>&#160;      myexit(1);</div>
<div class="line"><a name="l04721"></a><span class="lineno"> 4721</span>&#160;    }</div>
<div class="line"><a name="l04722"></a><span class="lineno"> 4722</span>&#160;    <span class="keywordflow">if</span>( </div>
<div class="line"><a name="l04723"></a><span class="lineno"> 4723</span>&#160;       ((<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[3]+kk&lt;=kkn)&amp;&amp;(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a516ad1adc872921939df143a56a721af">BCtype</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ada1c40d716a8e3567377cd77831aca10">X3DN</a>]==OUTFLOW)&amp;&amp;(pr[U1+dir-1] &gt; 0.)) </div>
<div class="line"><a name="l04724"></a><span class="lineno"> 4724</span>&#160;       ||((<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[3]+kk&gt;=kout)&amp;&amp;(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a516ad1adc872921939df143a56a721af">BCtype</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a55fd86081e74615c36554fed69074cd2">X3UP</a>]==OUTFLOW)&amp;&amp;(pr[U1+dir-1] &lt; 0.)) </div>
<div class="line"><a name="l04725"></a><span class="lineno"> 4725</span>&#160;        ) {</div>
<div class="line"><a name="l04726"></a><span class="lineno"> 4726</span>&#160;      <span class="comment">// set pre-primitive</span></div>
<div class="line"><a name="l04727"></a><span class="lineno"> 4727</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl)    pr0[pl]=pr[pl];</div>
<div class="line"><a name="l04728"></a><span class="lineno"> 4728</span>&#160;      pr[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8de9104f1fffa59f057b214d74c5cfea">U3</a>]=0;</div>
<div class="line"><a name="l04729"></a><span class="lineno"> 4729</span>&#160;</div>
<div class="line"><a name="l04730"></a><span class="lineno"> 4730</span>&#160;      <span class="comment">// account for changes</span></div>
<div class="line"><a name="l04731"></a><span class="lineno"> 4731</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) prdiag[pl]=pr0[pl];</div>
<div class="line"><a name="l04732"></a><span class="lineno"> 4732</span>&#160;      <span class="keywordtype">int</span> doingmhdfixup=1;</div>
<div class="line"><a name="l04733"></a><span class="lineno"> 4733</span>&#160;      diag_fixup((<a class="code" href="../../d8/d5b/defs_8general_8h.html#a55732148d2616d6d1f5d2abbe8710850">DOENOFLUX</a> != NOENOFLUX),prdiag, pr, ucons, ptrgeom, finalstep,doingmhdfixup,COUNTINFLOWACT);</div>
<div class="line"><a name="l04734"></a><span class="lineno"> 4734</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) prdiag[pl]=pr[pl];</div>
<div class="line"><a name="l04735"></a><span class="lineno"> 4735</span>&#160;    }</div>
<div class="line"><a name="l04736"></a><span class="lineno"> 4736</span>&#160;    if(<a class="code" href="../../da/d3e/definit_8h.html#a99ba7daf58b283bc831b8f507f5873a4" title="#define EOMTYPE EOMCOLDGRMHD">EOMRADTYPE</a>!=<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a993e29ef4139116d822d89bccb92180d" title="radiation equations of motion">EOMRADNONE</a>&amp;&amp;(</div>
<div class="line"><a name="l04737"></a><span class="lineno"> 4737</span>&#160;                                ((<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[3]+kk&lt;=kkn)&amp;&amp;(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a516ad1adc872921939df143a56a721af">BCtype</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ada1c40d716a8e3567377cd77831aca10">X3DN</a>]==OUTFLOW)&amp;&amp;(pr[URAD1+dir-1] &gt; 0.)) </div>
<div class="line"><a name="l04738"></a><span class="lineno"> 4738</span>&#160;                                ||((<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[3]+kk&gt;=kout)&amp;&amp;(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a516ad1adc872921939df143a56a721af">BCtype</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a55fd86081e74615c36554fed69074cd2">X3UP</a>]==OUTFLOW)&amp;&amp;(pr[URAD1+dir-1] &lt; 0.)) </div>
<div class="line"><a name="l04739"></a><span class="lineno"> 4739</span>&#160;                                )</div>
<div class="line"><a name="l04740"></a><span class="lineno"> 4740</span>&#160;       ) {</div>
<div class="line"><a name="l04741"></a><span class="lineno"> 4741</span>&#160;      <span class="comment">// set pre-primitive</span></div>
<div class="line"><a name="l04742"></a><span class="lineno"> 4742</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl)    pr0[pl]=pr[pl];</div>
<div class="line"><a name="l04743"></a><span class="lineno"> 4743</span>&#160;      pr[URAD3]=0;</div>
<div class="line"><a name="l04744"></a><span class="lineno"> 4744</span>&#160;</div>
<div class="line"><a name="l04745"></a><span class="lineno"> 4745</span>&#160;      <span class="comment">// account for changes</span></div>
<div class="line"><a name="l04746"></a><span class="lineno"> 4746</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) prdiag[pl]=pr0[pl];</div>
<div class="line"><a name="l04747"></a><span class="lineno"> 4747</span>&#160;      <span class="keywordtype">int</span> doingmhdfixup=1;</div>
<div class="line"><a name="l04748"></a><span class="lineno"> 4748</span>&#160;      diag_fixup((<a class="code" href="../../d8/d5b/defs_8general_8h.html#a55732148d2616d6d1f5d2abbe8710850">DOENOFLUX</a> != NOENOFLUX),prdiag, pr, ucons, ptrgeom, finalstep,doingmhdfixup,COUNTINFLOWACT);</div>
<div class="line"><a name="l04749"></a><span class="lineno"> 4749</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) prdiag[pl]=pr[pl];</div>
<div class="line"><a name="l04750"></a><span class="lineno"> 4750</span>&#160;    }</div>
<div class="line"><a name="l04751"></a><span class="lineno"> 4751</span>&#160;  }</div>
<div class="line"><a name="l04752"></a><span class="lineno"> 4752</span>&#160;  else return(1); <span class="comment">// uh</span></div>
<div class="line"><a name="l04753"></a><span class="lineno"> 4753</span>&#160;</div>
<div class="line"><a name="l04754"></a><span class="lineno"> 4754</span>&#160;  return(0);</div>
<div class="line"><a name="l04755"></a><span class="lineno"> 4755</span>&#160;}</div>
<div class="line"><a name="l04756"></a><span class="lineno"> 4756</span>&#160;</div>
<div class="line"><a name="l04757"></a><span class="lineno"> 4757</span>&#160;</div>
<div class="line"><a name="l04759"></a><span class="lineno"> 4759</span>&#160;<span class="keywordtype">int</span> inflow_check_3vel(<span class="keywordtype">int</span> dir, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *ucons, struct <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <span class="keywordtype">int</span> finalstep)</div>
<div class="line"><a name="l04760"></a><span class="lineno"> 4760</span>&#160;{</div>
<div class="line"><a name="l04761"></a><span class="lineno"> 4761</span>&#160;</div>
<div class="line"><a name="l04762"></a><span class="lineno"> 4762</span>&#160;  <span class="keywordflow">return</span>(inflow_check_4vel(dir,pr,ucons, ptrgeom,-1));</div>
<div class="line"><a name="l04763"></a><span class="lineno"> 4763</span>&#160;</div>
<div class="line"><a name="l04764"></a><span class="lineno"> 4764</span>&#160;}</div>
<div class="line"><a name="l04765"></a><span class="lineno"> 4765</span>&#160;</div>
<div class="line"><a name="l04767"></a><span class="lineno"> 4767</span>&#160;<span class="comment">// GODMARK: check for correctness</span></div>
<div class="line"><a name="l04768"></a><span class="lineno"> 4768</span>&#160;<span class="keywordtype">int</span> inflow_check_rel4vel(<span class="keywordtype">int</span> dir, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *ucons, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <span class="keywordtype">int</span> finalstep)</div>
<div class="line"><a name="l04769"></a><span class="lineno"> 4769</span>&#160;{</div>
<div class="line"><a name="l04770"></a><span class="lineno"> 4770</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ucon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>],uradcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>] ;</div>
<div class="line"><a name="l04771"></a><span class="lineno"> 4771</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> others[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a266c1c3ab2959dbfc603c7d3f12783fb" title="strict limit (doesn&#39;t work in general)">NUMOTHERSTATERESULTS</a>];</div>
<div class="line"><a name="l04772"></a><span class="lineno"> 4772</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> othersrad[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a266c1c3ab2959dbfc603c7d3f12783fb" title="strict limit (doesn&#39;t work in general)">NUMOTHERSTATERESULTS</a>];</div>
<div class="line"><a name="l04773"></a><span class="lineno"> 4773</span>&#160;  <span class="keywordtype">int</span> ii,jj,kk,loc;</div>
<div class="line"><a name="l04774"></a><span class="lineno"> 4774</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>,k ;</div>
<div class="line"><a name="l04775"></a><span class="lineno"> 4775</span>&#160;  <span class="keywordtype">int</span> pl,pliter;</div>
<div class="line"><a name="l04776"></a><span class="lineno"> 4776</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> alpha,betacon,gamma,vsq ;</div>
<div class="line"><a name="l04777"></a><span class="lineno"> 4777</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> qsq;</div>
<div class="line"><a name="l04778"></a><span class="lineno"> 4778</span>&#160;  <span class="keywordtype">int</span> iin,iout;</div>
<div class="line"><a name="l04779"></a><span class="lineno"> 4779</span>&#160;  <span class="keywordtype">int</span> jjn,jout;</div>
<div class="line"><a name="l04780"></a><span class="lineno"> 4780</span>&#160;  <span class="keywordtype">int</span> kkn,kout;</div>
<div class="line"><a name="l04781"></a><span class="lineno"> 4781</span>&#160;  <span class="keywordtype">int</span> dofix=0, dofixrad=0;</div>
<div class="line"><a name="l04782"></a><span class="lineno"> 4782</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> pr0[NPR];</div>
<div class="line"><a name="l04783"></a><span class="lineno"> 4783</span>&#160;</div>
<div class="line"><a name="l04784"></a><span class="lineno"> 4784</span>&#160;</div>
<div class="line"><a name="l04785"></a><span class="lineno"> 4785</span>&#160;  <span class="comment">//  return(0);</span></div>
<div class="line"><a name="l04786"></a><span class="lineno"> 4786</span>&#160;  ii=ptrgeom-&gt;i; </div>
<div class="line"><a name="l04787"></a><span class="lineno"> 4787</span>&#160;  jj=ptrgeom-&gt;j;</div>
<div class="line"><a name="l04788"></a><span class="lineno"> 4788</span>&#160;  kk=ptrgeom-&gt;k;</div>
<div class="line"><a name="l04789"></a><span class="lineno"> 4789</span>&#160;  loc=ptrgeom-&gt;p;</div>
<div class="line"><a name="l04790"></a><span class="lineno"> 4790</span>&#160;</div>
<div class="line"><a name="l04791"></a><span class="lineno"> 4791</span>&#160;</div>
<div class="line"><a name="l04792"></a><span class="lineno"> 4792</span>&#160;  <span class="comment">//ucon_calc(pr, ptrgeom, ucon,others) ;</span></div>
<div class="line"><a name="l04793"></a><span class="lineno"> 4793</span>&#160;</div>
<div class="line"><a name="l04794"></a><span class="lineno"> 4794</span>&#160;  <span class="comment">//  PALLLOOP(pl) dualfprintf(fail_file,&quot;nstep=%ld steppart=%d t=%21.15g :: pl=%d %21.15g\n&quot;,nstep,steppart,t,pl,pr[pl]);</span></div>
<div class="line"><a name="l04795"></a><span class="lineno"> 4795</span>&#160;</div>
<div class="line"><a name="l04796"></a><span class="lineno"> 4796</span>&#160;  <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#afc93fd4a6f7a2b87a9315d5fba5a529c">ucon_calc</a>(pr, ptrgeom, ucon, others),<span class="stringliteral">&quot;fixup.c:inflow_check_rel4vel()&quot;</span>, <span class="stringliteral">&quot;ucon_calc() dir=0&quot;</span>, 1);</div>
<div class="line"><a name="l04797"></a><span class="lineno"> 4797</span>&#160;  <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#afc93fd4a6f7a2b87a9315d5fba5a529c">ucon_calc</a>(&amp;pr[URAD1-U1], ptrgeom, uradcon, othersrad),<span class="stringliteral">&quot;fixup.c:inflow_check_rel4vel()&quot;</span>, <span class="stringliteral">&quot;ucon_calc() dir=0&quot;</span>, 1);</div>
<div class="line"><a name="l04798"></a><span class="lineno"> 4798</span>&#160;</div>
<div class="line"><a name="l04799"></a><span class="lineno"> 4799</span>&#160;  <span class="comment">//  DLOOPA(pl) dualfprintf(fail_file,&quot;ucon[%d]=%21.15g uconrad[%d]=%21.15g\n&quot;,pl,ucon[pl],pl,uradcon[pl]);</span></div>
<div class="line"><a name="l04800"></a><span class="lineno"> 4800</span>&#160;</div>
<div class="line"><a name="l04801"></a><span class="lineno"> 4801</span>&#160;  dofix=dofixrad=0;</div>
<div class="line"><a name="l04802"></a><span class="lineno"> 4802</span>&#160; </div>
<div class="line"><a name="l04803"></a><span class="lineno"> 4803</span>&#160;  <span class="keywordflow">if</span>(dir==1){</div>
<div class="line"><a name="l04804"></a><span class="lineno"> 4804</span>&#160;    <span class="comment">// for dir==1</span></div>
<div class="line"><a name="l04805"></a><span class="lineno"> 4805</span>&#160;    <span class="keywordflow">if</span>((ptrgeom-&gt;p==CENT)||(ptrgeom-&gt;p==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a5b4b42f50fd7667c7d22d8001811bc7e">FACE2</a>)||(ptrgeom-&gt;p==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a630fdcefb04bdca66118cfd21476e8fd">FACE3</a>)||(ptrgeom-&gt;p==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a1068bcf25c9f187a8db0f422e0af64c8">CORN1</a>) ){ iin=-1; iout=<a class="code" href="../../dd/d46/mpidefs_8h.html#ab3efab8b1f2dffc5907e0b0a5aa3988f">totalsize</a>[1]; }</div>
<div class="line"><a name="l04806"></a><span class="lineno"> 4806</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>((ptrgeom-&gt;p==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a1df736ddba855d7b429869f9f09dbd66">FACE1</a>)||(ptrgeom-&gt;p==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab10e4ab484f1edd4cecb418ff22a743a">CORN2</a>)||(ptrgeom-&gt;p==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a1a05e117efd4dbc39b7c590141004470">CORN3</a>) ){ iin=0; iout=<a class="code" href="../../dd/d46/mpidefs_8h.html#ab3efab8b1f2dffc5907e0b0a5aa3988f">totalsize</a>[1]; }</div>
<div class="line"><a name="l04807"></a><span class="lineno"> 4807</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l04808"></a><span class="lineno"> 4808</span>&#160;      dualfprintf(fail_file,<span class="stringliteral">&quot;dir=%d no such location: %d\n&quot;</span>,dir,ptrgeom-&gt;p);</div>
<div class="line"><a name="l04809"></a><span class="lineno"> 4809</span>&#160;      myexit(1);</div>
<div class="line"><a name="l04810"></a><span class="lineno"> 4810</span>&#160;    }</div>
<div class="line"><a name="l04811"></a><span class="lineno"> 4811</span>&#160;    <span class="keywordflow">if</span>( </div>
<div class="line"><a name="l04812"></a><span class="lineno"> 4812</span>&#160;       ((<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[1]+ii&lt;=iin)&amp;&amp;((<a class="code" href="../../d8/d5b/defs_8general_8h.html#a516ad1adc872921939df143a56a721af">BCtype</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aab7332b2c03d905515d5350d4fd0850f">X1DN</a>]==OUTFLOW || <a class="code" href="../../d8/d5b/defs_8general_8h.html#a516ad1adc872921939df143a56a721af">BCtype</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aab7332b2c03d905515d5350d4fd0850f">X1DN</a>]==HORIZONOUTFLOW) || <a class="code" href="../../d8/d5b/defs_8general_8h.html#a516ad1adc872921939df143a56a721af">BCtype</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aab7332b2c03d905515d5350d4fd0850f">X1DN</a>]==OUTFLOWNOINFLOW)&amp;&amp;(ucon[dir] &gt; 0.)) </div>
<div class="line"><a name="l04813"></a><span class="lineno"> 4813</span>&#160;       ||((<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[1]+ii&gt;=iout)&amp;&amp;((<a class="code" href="../../d8/d5b/defs_8general_8h.html#a516ad1adc872921939df143a56a721af">BCtype</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6a3603145c91f722d74610fbd6e4f696" title="----------—&gt; r | 3 | 1-0 | 2 v theta and likewise for 4,5 (4=out,5=in) directions:">X1UP</a>]==OUTFLOW || <a class="code" href="../../d8/d5b/defs_8general_8h.html#a516ad1adc872921939df143a56a721af">BCtype</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6a3603145c91f722d74610fbd6e4f696" title="----------—&gt; r | 3 | 1-0 | 2 v theta and likewise for 4,5 (4=out,5=in) directions:">X1UP</a>]==HORIZONOUTFLOW) || <a class="code" href="../../d8/d5b/defs_8general_8h.html#a516ad1adc872921939df143a56a721af">BCtype</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6a3603145c91f722d74610fbd6e4f696" title="----------—&gt; r | 3 | 1-0 | 2 v theta and likewise for 4,5 (4=out,5=in) directions:">X1UP</a>]==OUTFLOWNOINFLOW)&amp;&amp;(ucon[dir] &lt; 0.)) </div>
<div class="line"><a name="l04814"></a><span class="lineno"> 4814</span>&#160;        ) {</div>
<div class="line"><a name="l04815"></a><span class="lineno"> 4815</span>&#160;      dofix=1;</div>
<div class="line"><a name="l04816"></a><span class="lineno"> 4816</span>&#160;    }</div>
<div class="line"><a name="l04817"></a><span class="lineno"> 4817</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#a99ba7daf58b283bc831b8f507f5873a4" title="#define EOMTYPE EOMCOLDGRMHD">EOMRADTYPE</a>!=<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a993e29ef4139116d822d89bccb92180d" title="radiation equations of motion">EOMRADNONE</a>&amp;&amp;(</div>
<div class="line"><a name="l04818"></a><span class="lineno"> 4818</span>&#160;                                ((<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[1]+ii&lt;=iin)&amp;&amp;((<a class="code" href="../../d8/d5b/defs_8general_8h.html#a516ad1adc872921939df143a56a721af">BCtype</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aab7332b2c03d905515d5350d4fd0850f">X1DN</a>]==OUTFLOW || <a class="code" href="../../d8/d5b/defs_8general_8h.html#a516ad1adc872921939df143a56a721af">BCtype</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aab7332b2c03d905515d5350d4fd0850f">X1DN</a>]==HORIZONOUTFLOW) || <a class="code" href="../../d8/d5b/defs_8general_8h.html#a516ad1adc872921939df143a56a721af">BCtype</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aab7332b2c03d905515d5350d4fd0850f">X1DN</a>]==OUTFLOWNOINFLOW)&amp;&amp;(uradcon[dir] &gt; 0.)) </div>
<div class="line"><a name="l04819"></a><span class="lineno"> 4819</span>&#160;                                ||((<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[1]+ii&gt;=iout)&amp;&amp;((<a class="code" href="../../d8/d5b/defs_8general_8h.html#a516ad1adc872921939df143a56a721af">BCtype</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6a3603145c91f722d74610fbd6e4f696" title="----------—&gt; r | 3 | 1-0 | 2 v theta and likewise for 4,5 (4=out,5=in) directions:">X1UP</a>]==OUTFLOW || <a class="code" href="../../d8/d5b/defs_8general_8h.html#a516ad1adc872921939df143a56a721af">BCtype</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6a3603145c91f722d74610fbd6e4f696" title="----------—&gt; r | 3 | 1-0 | 2 v theta and likewise for 4,5 (4=out,5=in) directions:">X1UP</a>]==HORIZONOUTFLOW) || <a class="code" href="../../d8/d5b/defs_8general_8h.html#a516ad1adc872921939df143a56a721af">BCtype</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6a3603145c91f722d74610fbd6e4f696" title="----------—&gt; r | 3 | 1-0 | 2 v theta and likewise for 4,5 (4=out,5=in) directions:">X1UP</a>]==OUTFLOWNOINFLOW)&amp;&amp;(uradcon[dir] &lt; 0.)) </div>
<div class="line"><a name="l04820"></a><span class="lineno"> 4820</span>&#160;                                )</div>
<div class="line"><a name="l04821"></a><span class="lineno"> 4821</span>&#160;       ) {</div>
<div class="line"><a name="l04822"></a><span class="lineno"> 4822</span>&#160;      dofixrad=1;</div>
<div class="line"><a name="l04823"></a><span class="lineno"> 4823</span>&#160;    }</div>
<div class="line"><a name="l04824"></a><span class="lineno"> 4824</span>&#160;    <span class="keywordflow">if</span>( </div>
<div class="line"><a name="l04825"></a><span class="lineno"> 4825</span>&#160;       ((<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[1]+ii&lt;=iin)&amp;&amp;(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a516ad1adc872921939df143a56a721af">BCtype</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aab7332b2c03d905515d5350d4fd0850f">X1DN</a>]==FIXEDOUTFLOW)&amp;&amp;(pr[U1+dir-1] &gt; 0.)) </div>
<div class="line"><a name="l04826"></a><span class="lineno"> 4826</span>&#160;       ||((<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[1]+ii&gt;=iout)&amp;&amp;(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a516ad1adc872921939df143a56a721af">BCtype</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6a3603145c91f722d74610fbd6e4f696" title="----------—&gt; r | 3 | 1-0 | 2 v theta and likewise for 4,5 (4=out,5=in) directions:">X1UP</a>]==FIXEDOUTFLOW)&amp;&amp;(pr[U1+dir-1] &lt; 0.)) </div>
<div class="line"><a name="l04827"></a><span class="lineno"> 4827</span>&#160;        ) {</div>
<div class="line"><a name="l04828"></a><span class="lineno"> 4828</span>&#160;      <span class="comment">// set pre-primitive</span></div>
<div class="line"><a name="l04829"></a><span class="lineno"> 4829</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl)    pr0[pl]=pr[pl];</div>
<div class="line"><a name="l04830"></a><span class="lineno"> 4830</span>&#160;      <span class="comment">// then inflow according to Bondi-like atmosphere</span></div>
<div class="line"><a name="l04831"></a><span class="lineno"> 4831</span>&#160;      <span class="comment">// GODMARK: need to ensure this gives well-defined answers during init.c processing</span></div>
<div class="line"><a name="l04832"></a><span class="lineno"> 4832</span>&#160;      set_atmosphere(1,<a class="code" href="../../da/d3e/definit_8h.html#a3d14480f30d39eff4e51ae8bc93df56f" title="whether we use ultimately precise inversion or &quot;workable&quot; inversion precision (see utoprim&#39;s for ho...">WHICHVEL</a>,ptrgeom,pr); <span class="comment">// can change all pr&#39;s</span></div>
<div class="line"><a name="l04833"></a><span class="lineno"> 4833</span>&#160;      dofix=0; <span class="comment">// assume in boundary</span></div>
<div class="line"><a name="l04834"></a><span class="lineno"> 4834</span>&#160;    }</div>
<div class="line"><a name="l04835"></a><span class="lineno"> 4835</span>&#160;  }</div>
<div class="line"><a name="l04836"></a><span class="lineno"> 4836</span>&#160;  else if(dir==2){</div>
<div class="line"><a name="l04837"></a><span class="lineno"> 4837</span>&#160;    <span class="comment">// for dir==2</span></div>
<div class="line"><a name="l04838"></a><span class="lineno"> 4838</span>&#160;    <span class="keywordflow">if</span>((ptrgeom-&gt;p==CENT)||(ptrgeom-&gt;p==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a1df736ddba855d7b429869f9f09dbd66">FACE1</a>)||(ptrgeom-&gt;p==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a630fdcefb04bdca66118cfd21476e8fd">FACE3</a>)||(ptrgeom-&gt;p==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab10e4ab484f1edd4cecb418ff22a743a">CORN2</a>) ){ jjn=-1; jout=<a class="code" href="../../dd/d46/mpidefs_8h.html#ab3efab8b1f2dffc5907e0b0a5aa3988f">totalsize</a>[2]; }</div>
<div class="line"><a name="l04839"></a><span class="lineno"> 4839</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>((ptrgeom-&gt;p==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a5b4b42f50fd7667c7d22d8001811bc7e">FACE2</a>)||(ptrgeom-&gt;p==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a1068bcf25c9f187a8db0f422e0af64c8">CORN1</a>)||(ptrgeom-&gt;p==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a1a05e117efd4dbc39b7c590141004470">CORN3</a>) ){ jjn=0; jout=<a class="code" href="../../dd/d46/mpidefs_8h.html#ab3efab8b1f2dffc5907e0b0a5aa3988f">totalsize</a>[2]; }</div>
<div class="line"><a name="l04840"></a><span class="lineno"> 4840</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l04841"></a><span class="lineno"> 4841</span>&#160;      dualfprintf(fail_file,<span class="stringliteral">&quot;dir=%d no such location: %d\n&quot;</span>,dir,ptrgeom-&gt;p);</div>
<div class="line"><a name="l04842"></a><span class="lineno"> 4842</span>&#160;      myexit(1);</div>
<div class="line"><a name="l04843"></a><span class="lineno"> 4843</span>&#160;    }</div>
<div class="line"><a name="l04844"></a><span class="lineno"> 4844</span>&#160;    <span class="keywordflow">if</span>( </div>
<div class="line"><a name="l04845"></a><span class="lineno"> 4845</span>&#160;       ((<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[2]+jj&lt;=jjn)&amp;&amp;(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a516ad1adc872921939df143a56a721af">BCtype</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aae79dca9f851fb40349156f6bca1f8ca">X2DN</a>]==OUTFLOW || <a class="code" href="../../d8/d5b/defs_8general_8h.html#a516ad1adc872921939df143a56a721af">BCtype</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aae79dca9f851fb40349156f6bca1f8ca">X2DN</a>]==OUTFLOWNOINFLOW)&amp;&amp;(ucon[dir] &gt; 0.)) </div>
<div class="line"><a name="l04846"></a><span class="lineno"> 4846</span>&#160;       ||((<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[2]+jj&gt;=jout)&amp;&amp;(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a516ad1adc872921939df143a56a721af">BCtype</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aa9363649053ac2e906715b3259a14954">X2UP</a>]==OUTFLOW || <a class="code" href="../../d8/d5b/defs_8general_8h.html#a516ad1adc872921939df143a56a721af">BCtype</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aa9363649053ac2e906715b3259a14954">X2UP</a>]==OUTFLOWNOINFLOW)&amp;&amp;(ucon[dir] &lt; 0.)) </div>
<div class="line"><a name="l04847"></a><span class="lineno"> 4847</span>&#160;        ) {</div>
<div class="line"><a name="l04848"></a><span class="lineno"> 4848</span>&#160;      dofix=2;</div>
<div class="line"><a name="l04849"></a><span class="lineno"> 4849</span>&#160;    }</div>
<div class="line"><a name="l04850"></a><span class="lineno"> 4850</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#a99ba7daf58b283bc831b8f507f5873a4" title="#define EOMTYPE EOMCOLDGRMHD">EOMRADTYPE</a>!=<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a993e29ef4139116d822d89bccb92180d" title="radiation equations of motion">EOMRADNONE</a>&amp;&amp;(</div>
<div class="line"><a name="l04851"></a><span class="lineno"> 4851</span>&#160;                                ((<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[2]+jj&lt;=jjn)&amp;&amp;(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a516ad1adc872921939df143a56a721af">BCtype</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aae79dca9f851fb40349156f6bca1f8ca">X2DN</a>]==OUTFLOW || <a class="code" href="../../d8/d5b/defs_8general_8h.html#a516ad1adc872921939df143a56a721af">BCtype</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aae79dca9f851fb40349156f6bca1f8ca">X2DN</a>]==OUTFLOWNOINFLOW)&amp;&amp;(uradcon[dir] &gt; 0.)) </div>
<div class="line"><a name="l04852"></a><span class="lineno"> 4852</span>&#160;                                ||((<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[2]+jj&gt;=jout)&amp;&amp;(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a516ad1adc872921939df143a56a721af">BCtype</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aa9363649053ac2e906715b3259a14954">X2UP</a>]==OUTFLOW || <a class="code" href="../../d8/d5b/defs_8general_8h.html#a516ad1adc872921939df143a56a721af">BCtype</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aa9363649053ac2e906715b3259a14954">X2UP</a>]==OUTFLOWNOINFLOW)&amp;&amp;(uradcon[dir] &lt; 0.)) </div>
<div class="line"><a name="l04853"></a><span class="lineno"> 4853</span>&#160;                                )</div>
<div class="line"><a name="l04854"></a><span class="lineno"> 4854</span>&#160;       ) {</div>
<div class="line"><a name="l04855"></a><span class="lineno"> 4855</span>&#160;      dofixrad=2;</div>
<div class="line"><a name="l04856"></a><span class="lineno"> 4856</span>&#160;    }</div>
<div class="line"><a name="l04857"></a><span class="lineno"> 4857</span>&#160;  }</div>
<div class="line"><a name="l04858"></a><span class="lineno"> 4858</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(dir==3){</div>
<div class="line"><a name="l04859"></a><span class="lineno"> 4859</span>&#160;    <span class="comment">// for dir==3</span></div>
<div class="line"><a name="l04860"></a><span class="lineno"> 4860</span>&#160;    <span class="keywordflow">if</span>((ptrgeom-&gt;p==CENT)||(ptrgeom-&gt;p==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a1df736ddba855d7b429869f9f09dbd66">FACE1</a>)||(ptrgeom-&gt;p==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a5b4b42f50fd7667c7d22d8001811bc7e">FACE2</a>)||(ptrgeom-&gt;p==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a1a05e117efd4dbc39b7c590141004470">CORN3</a>) ){ kkn=-1; kout=<a class="code" href="../../dd/d46/mpidefs_8h.html#ab3efab8b1f2dffc5907e0b0a5aa3988f">totalsize</a>[3]; }</div>
<div class="line"><a name="l04861"></a><span class="lineno"> 4861</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>((ptrgeom-&gt;p==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a630fdcefb04bdca66118cfd21476e8fd">FACE3</a>)||(ptrgeom-&gt;p==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a1068bcf25c9f187a8db0f422e0af64c8">CORN1</a>)||(ptrgeom-&gt;p==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab10e4ab484f1edd4cecb418ff22a743a">CORN2</a>) ){ kkn=0; kout=<a class="code" href="../../dd/d46/mpidefs_8h.html#ab3efab8b1f2dffc5907e0b0a5aa3988f">totalsize</a>[3]; }</div>
<div class="line"><a name="l04862"></a><span class="lineno"> 4862</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l04863"></a><span class="lineno"> 4863</span>&#160;      dualfprintf(fail_file,<span class="stringliteral">&quot;dir=%d no such location: %d\n&quot;</span>,dir,ptrgeom-&gt;p);</div>
<div class="line"><a name="l04864"></a><span class="lineno"> 4864</span>&#160;      myexit(1);</div>
<div class="line"><a name="l04865"></a><span class="lineno"> 4865</span>&#160;    }</div>
<div class="line"><a name="l04866"></a><span class="lineno"> 4866</span>&#160;    <span class="keywordflow">if</span>( </div>
<div class="line"><a name="l04867"></a><span class="lineno"> 4867</span>&#160;       ((<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[3]+kk&lt;=kkn)&amp;&amp;(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a516ad1adc872921939df143a56a721af">BCtype</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ada1c40d716a8e3567377cd77831aca10">X3DN</a>]==OUTFLOW || <a class="code" href="../../d8/d5b/defs_8general_8h.html#a516ad1adc872921939df143a56a721af">BCtype</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ada1c40d716a8e3567377cd77831aca10">X3DN</a>]==OUTFLOWNOINFLOW)&amp;&amp;(ucon[dir] &gt; 0.)) </div>
<div class="line"><a name="l04868"></a><span class="lineno"> 4868</span>&#160;       ||((<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[3]+kk&gt;=kout)&amp;&amp;(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a516ad1adc872921939df143a56a721af">BCtype</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a55fd86081e74615c36554fed69074cd2">X3UP</a>]==OUTFLOW || <a class="code" href="../../d8/d5b/defs_8general_8h.html#a516ad1adc872921939df143a56a721af">BCtype</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a55fd86081e74615c36554fed69074cd2">X3UP</a>]==OUTFLOWNOINFLOW)&amp;&amp;(ucon[dir] &lt; 0.)) </div>
<div class="line"><a name="l04869"></a><span class="lineno"> 4869</span>&#160;        ) {</div>
<div class="line"><a name="l04870"></a><span class="lineno"> 4870</span>&#160;      dofix=3;</div>
<div class="line"><a name="l04871"></a><span class="lineno"> 4871</span>&#160;    }</div>
<div class="line"><a name="l04872"></a><span class="lineno"> 4872</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#a99ba7daf58b283bc831b8f507f5873a4" title="#define EOMTYPE EOMCOLDGRMHD">EOMRADTYPE</a>!=<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a993e29ef4139116d822d89bccb92180d" title="radiation equations of motion">EOMRADNONE</a>&amp;&amp;(</div>
<div class="line"><a name="l04873"></a><span class="lineno"> 4873</span>&#160;                                ((<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[3]+kk&lt;=kkn)&amp;&amp;(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a516ad1adc872921939df143a56a721af">BCtype</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ada1c40d716a8e3567377cd77831aca10">X3DN</a>]==OUTFLOW || <a class="code" href="../../d8/d5b/defs_8general_8h.html#a516ad1adc872921939df143a56a721af">BCtype</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ada1c40d716a8e3567377cd77831aca10">X3DN</a>]==OUTFLOWNOINFLOW)&amp;&amp;(uradcon[dir] &gt; 0.)) </div>
<div class="line"><a name="l04874"></a><span class="lineno"> 4874</span>&#160;                                ||((<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[3]+kk&gt;=kout)&amp;&amp;(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a516ad1adc872921939df143a56a721af">BCtype</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a55fd86081e74615c36554fed69074cd2">X3UP</a>]==OUTFLOW || <a class="code" href="../../d8/d5b/defs_8general_8h.html#a516ad1adc872921939df143a56a721af">BCtype</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a55fd86081e74615c36554fed69074cd2">X3UP</a>]==OUTFLOWNOINFLOW)&amp;&amp;(uradcon[dir] &lt; 0.)) </div>
<div class="line"><a name="l04875"></a><span class="lineno"> 4875</span>&#160;                                )</div>
<div class="line"><a name="l04876"></a><span class="lineno"> 4876</span>&#160;       ) {</div>
<div class="line"><a name="l04877"></a><span class="lineno"> 4877</span>&#160;      dofixrad=3;</div>
<div class="line"><a name="l04878"></a><span class="lineno"> 4878</span>&#160;    }</div>
<div class="line"><a name="l04879"></a><span class="lineno"> 4879</span>&#160;  }</div>
<div class="line"><a name="l04880"></a><span class="lineno"> 4880</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l04881"></a><span class="lineno"> 4881</span>&#160;    dualfprintf(fail_file,<span class="stringliteral">&quot;Shouldn&#39;t reach dir=%d\n&quot;</span>,dir);</div>
<div class="line"><a name="l04882"></a><span class="lineno"> 4882</span>&#160;    <span class="keywordflow">return</span>(1); <span class="comment">// uh</span></div>
<div class="line"><a name="l04883"></a><span class="lineno"> 4883</span>&#160;  }</div>
<div class="line"><a name="l04884"></a><span class="lineno"> 4884</span>&#160;</div>
<div class="line"><a name="l04885"></a><span class="lineno"> 4885</span>&#160;</div>
<div class="line"><a name="l04886"></a><span class="lineno"> 4886</span>&#160;</div>
<div class="line"><a name="l04887"></a><span class="lineno"> 4887</span>&#160;  <span class="keywordflow">if</span>(dofix){</div>
<div class="line"><a name="l04888"></a><span class="lineno"> 4888</span>&#160;    <span class="comment">// set pre-primitive</span></div>
<div class="line"><a name="l04889"></a><span class="lineno"> 4889</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl)    pr0[pl]=pr[pl];</div>
<div class="line"><a name="l04890"></a><span class="lineno"> 4890</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> prdiag[NPR];</div>
<div class="line"><a name="l04891"></a><span class="lineno"> 4891</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) prdiag[pl]=pr0[pl];</div>
<div class="line"><a name="l04892"></a><span class="lineno"> 4892</span>&#160;</div>
<div class="line"><a name="l04893"></a><span class="lineno"> 4893</span>&#160;</div>
<div class="line"><a name="l04894"></a><span class="lineno"> 4894</span>&#160;    <span class="comment">/* find gamma and remove it from primitives */</span></div>
<div class="line"><a name="l04895"></a><span class="lineno"> 4895</span>&#160;    if(gamma_calc(pr,ptrgeom,&amp;gamma,&amp;qsq)&gt;=1){</div>
<div class="line"><a name="l04896"></a><span class="lineno"> 4896</span>&#160;      dualfprintf(fail_file,<span class="stringliteral">&quot;gamma calc failed: inflow_check_rel4vel\n&quot;</span>);</div>
<div class="line"><a name="l04897"></a><span class="lineno"> 4897</span>&#160;      <span class="keywordflow">if</span> (fail(ii,jj,kk,loc,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab80e0a4ad12720e26d9e904b4796ec14">FAIL_UTCALC_DISCR</a>) &gt;= 1)</div>
<div class="line"><a name="l04898"></a><span class="lineno"> 4898</span>&#160;        <span class="keywordflow">return</span> (1);</div>
<div class="line"><a name="l04899"></a><span class="lineno"> 4899</span>&#160;    }</div>
<div class="line"><a name="l04900"></a><span class="lineno"> 4900</span>&#160;    pr[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>] /= gamma ;</div>
<div class="line"><a name="l04901"></a><span class="lineno"> 4901</span>&#160;    pr[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae907e773ef038f3fc0c2ad5de0cb0f07">U2</a>] /= gamma ;</div>
<div class="line"><a name="l04902"></a><span class="lineno"> 4902</span>&#160;    pr[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8de9104f1fffa59f057b214d74c5cfea">U3</a>] /= gamma ;</div>
<div class="line"><a name="l04903"></a><span class="lineno"> 4903</span>&#160;    alpha = 1./sqrt(-ptrgeom-&gt;gcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(0,0)]) ;</div>
<div class="line"><a name="l04904"></a><span class="lineno"> 4904</span>&#160;    </div>
<div class="line"><a name="l04905"></a><span class="lineno"> 4905</span>&#160;    <span class="comment">/* reset radial velocity so radial 4-velocity</span></div>
<div class="line"><a name="l04906"></a><span class="lineno"> 4906</span>&#160;<span class="comment">     * is zero */</span></div>
<div class="line"><a name="l04907"></a><span class="lineno"> 4907</span>&#160;    <span class="keywordflow">if</span>(dofix==1){</div>
<div class="line"><a name="l04908"></a><span class="lineno"> 4908</span>&#160;      betacon = ptrgeom-&gt;gcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(0,1)]*alpha*alpha ;</div>
<div class="line"><a name="l04909"></a><span class="lineno"> 4909</span>&#160;      pr[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>] = betacon/alpha ; <span class="comment">// gives 3-vel contravariant</span></div>
<div class="line"><a name="l04910"></a><span class="lineno"> 4910</span>&#160;    }</div>
<div class="line"><a name="l04911"></a><span class="lineno"> 4911</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(dofix==2){</div>
<div class="line"><a name="l04912"></a><span class="lineno"> 4912</span>&#160;      betacon = ptrgeom-&gt;gcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(0,2)]*alpha*alpha ;</div>
<div class="line"><a name="l04913"></a><span class="lineno"> 4913</span>&#160;      pr[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae907e773ef038f3fc0c2ad5de0cb0f07">U2</a>] = betacon/alpha ; <span class="comment">// gives 3-vel contravariant</span></div>
<div class="line"><a name="l04914"></a><span class="lineno"> 4914</span>&#160;    }</div>
<div class="line"><a name="l04915"></a><span class="lineno"> 4915</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(dofix==3){</div>
<div class="line"><a name="l04916"></a><span class="lineno"> 4916</span>&#160;      betacon = ptrgeom-&gt;gcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(0,3)]*alpha*alpha ;</div>
<div class="line"><a name="l04917"></a><span class="lineno"> 4917</span>&#160;      pr[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8de9104f1fffa59f057b214d74c5cfea">U3</a>] = betacon/alpha ; <span class="comment">// gives 3-vel contravariant</span></div>
<div class="line"><a name="l04918"></a><span class="lineno"> 4918</span>&#160;    }</div>
<div class="line"><a name="l04919"></a><span class="lineno"> 4919</span>&#160;    <span class="comment">/* now find new gamma and put it back in */</span></div>
<div class="line"><a name="l04920"></a><span class="lineno"> 4920</span>&#160;    vsq = 0. ;</div>
<div class="line"><a name="l04921"></a><span class="lineno"> 4921</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a35c1540b3f1a0de6fe1eb5a1e34e820a" title="loop over all Space dimensions; second rank loop">SLOOP</a>(j,k) vsq += ptrgeom-&gt;<a class="code" href="../../dc/dd2/newcodediff_8txt.html#a93300df7bd864b90cc8ed9f3d96515ad">gcov</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(j,k)]*pr[U1+j-1]*pr[U1+k-1] ;</div>
<div class="line"><a name="l04922"></a><span class="lineno"> 4922</span>&#160;</div>
<div class="line"><a name="l04923"></a><span class="lineno"> 4923</span>&#160;    if(vsq&lt;0.0){</div>
<div class="line"><a name="l04924"></a><span class="lineno"> 4924</span>&#160;      <span class="keywordflow">if</span>(vsq&gt;-<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a8913cb5d64cfec23ae1a3052930ec468">NUMEPSILON</a>*100.0) vsq=0.0; <span class="comment">// machine precision thing</span></div>
<div class="line"><a name="l04925"></a><span class="lineno"> 4925</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fail(ii,jj,kk,loc,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab711b8ab87b9ecf414b4ee48401467fa">FAIL_VSQ_NEG</a>) &gt;= 1){</div>
<div class="line"><a name="l04926"></a><span class="lineno"> 4926</span>&#160;        trifprintf(<span class="stringliteral">&quot;vsq=%21.15g\n&quot;</span>,vsq);</div>
<div class="line"><a name="l04927"></a><span class="lineno"> 4927</span>&#160;        <span class="keywordflow">return</span> (1);</div>
<div class="line"><a name="l04928"></a><span class="lineno"> 4928</span>&#160;      }</div>
<div class="line"><a name="l04929"></a><span class="lineno"> 4929</span>&#160;    }</div>
<div class="line"><a name="l04930"></a><span class="lineno"> 4930</span>&#160; </div>
<div class="line"><a name="l04931"></a><span class="lineno"> 4931</span>&#160;    <span class="comment">// it&#39;s possible that setting ucon(bc comp)-&gt;0 leads to v&gt;c, so just reduce gamma to GAMMAMAX if that&#39;s the case</span></div>
<div class="line"><a name="l04932"></a><span class="lineno"> 4932</span>&#160;    <span class="keywordflow">if</span>(vsq&gt;=1.0){</div>
<div class="line"><a name="l04933"></a><span class="lineno"> 4933</span>&#160;      <span class="keywordflow">if</span>(debugfail&gt;=1) dualfprintf(fail_file,<span class="stringliteral">&quot;i=%d j=%d k=%d inflow limit required change in gamma (after dofix==%d): vsq=%21.15g newvsq=%21.15g\n&quot;</span>,ii+<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[1],jj+<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[2],kk+<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[3],dofix,vsq,1.0-1.0/(<a class="code" href="../../d8/d5b/defs_8general_8h.html#accef7ff74daca804b9a5a3ad7d3db882">GAMMAMAX</a>*<a class="code" href="../../d8/d5b/defs_8general_8h.html#accef7ff74daca804b9a5a3ad7d3db882">GAMMAMAX</a>));</div>
<div class="line"><a name="l04934"></a><span class="lineno"> 4934</span>&#160;</div>
<div class="line"><a name="l04935"></a><span class="lineno"> 4935</span>&#160;      <span class="comment">// new vsq</span></div>
<div class="line"><a name="l04936"></a><span class="lineno"> 4936</span>&#160;      vsq = 1.0-1.0/(<a class="code" href="../../d8/d5b/defs_8general_8h.html#accef7ff74daca804b9a5a3ad7d3db882">GAMMAMAX</a>*<a class="code" href="../../d8/d5b/defs_8general_8h.html#accef7ff74daca804b9a5a3ad7d3db882">GAMMAMAX</a>);</div>
<div class="line"><a name="l04937"></a><span class="lineno"> 4937</span>&#160;</div>
<div class="line"><a name="l04938"></a><span class="lineno"> 4938</span>&#160;    }</div>
<div class="line"><a name="l04939"></a><span class="lineno"> 4939</span>&#160;</div>
<div class="line"><a name="l04940"></a><span class="lineno"> 4940</span>&#160;    gamma = 1./sqrt(1. - vsq) ;</div>
<div class="line"><a name="l04941"></a><span class="lineno"> 4941</span>&#160;    pr[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aacb3eec923047fe7ddf3eda070c600d9">U1</a>] *= gamma ;</div>
<div class="line"><a name="l04942"></a><span class="lineno"> 4942</span>&#160;    pr[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae907e773ef038f3fc0c2ad5de0cb0f07">U2</a>] *= gamma ;</div>
<div class="line"><a name="l04943"></a><span class="lineno"> 4943</span>&#160;    pr[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8de9104f1fffa59f057b214d74c5cfea">U3</a>] *= gamma ;</div>
<div class="line"><a name="l04944"></a><span class="lineno"> 4944</span>&#160;</div>
<div class="line"><a name="l04945"></a><span class="lineno"> 4945</span>&#160;    <span class="comment">// only for boundary conditions, not active zones, hence -1.0 instead of finalstep</span></div>
<div class="line"><a name="l04946"></a><span class="lineno"> 4946</span>&#160;    <span class="keywordtype">int</span> doingmhdfixup=1;</div>
<div class="line"><a name="l04947"></a><span class="lineno"> 4947</span>&#160;    diag_fixup((<a class="code" href="../../d8/d5b/defs_8general_8h.html#a55732148d2616d6d1f5d2abbe8710850">DOENOFLUX</a> != NOENOFLUX),prdiag, pr, ucons, ptrgeom, finalstep,doingmhdfixup,COUNTINFLOWACT);</div>
<div class="line"><a name="l04948"></a><span class="lineno"> 4948</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) prdiag[pl]=pr[pl];</div>
<div class="line"><a name="l04949"></a><span class="lineno"> 4949</span>&#160;</div>
<div class="line"><a name="l04950"></a><span class="lineno"> 4950</span>&#160;  }</div>
<div class="line"><a name="l04951"></a><span class="lineno"> 4951</span>&#160;</div>
<div class="line"><a name="l04952"></a><span class="lineno"> 4952</span>&#160;</div>
<div class="line"><a name="l04953"></a><span class="lineno"> 4953</span>&#160;</div>
<div class="line"><a name="l04954"></a><span class="lineno"> 4954</span>&#160;  if(dofixrad){</div>
<div class="line"><a name="l04955"></a><span class="lineno"> 4955</span>&#160;</div>
<div class="line"><a name="l04956"></a><span class="lineno"> 4956</span>&#160;    <span class="comment">// set pre-primitive</span></div>
<div class="line"><a name="l04957"></a><span class="lineno"> 4957</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl)    pr0[pl]=pr[pl];</div>
<div class="line"><a name="l04958"></a><span class="lineno"> 4958</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> prdiag[NPR];</div>
<div class="line"><a name="l04959"></a><span class="lineno"> 4959</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) prdiag[pl]=pr0[pl];</div>
<div class="line"><a name="l04960"></a><span class="lineno"> 4960</span>&#160;</div>
<div class="line"><a name="l04961"></a><span class="lineno"> 4961</span>&#160;</div>
<div class="line"><a name="l04962"></a><span class="lineno"> 4962</span>&#160;    <span class="comment">/* find gamma and remove it from primitives */</span></div>
<div class="line"><a name="l04963"></a><span class="lineno"> 4963</span>&#160;    if(gamma_calc(&amp;pr[URAD1-U1],ptrgeom,&amp;gamma,&amp;qsq)&gt;=1){</div>
<div class="line"><a name="l04964"></a><span class="lineno"> 4964</span>&#160;      dualfprintf(fail_file,<span class="stringliteral">&quot;gamma calc failed: inflow_check_rel4vel\n&quot;</span>);</div>
<div class="line"><a name="l04965"></a><span class="lineno"> 4965</span>&#160;      <span class="keywordflow">if</span> (fail(ii,jj,kk,loc,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab80e0a4ad12720e26d9e904b4796ec14">FAIL_UTCALC_DISCR</a>) &gt;= 1)</div>
<div class="line"><a name="l04966"></a><span class="lineno"> 4966</span>&#160;        <span class="keywordflow">return</span> (1);</div>
<div class="line"><a name="l04967"></a><span class="lineno"> 4967</span>&#160;    }</div>
<div class="line"><a name="l04968"></a><span class="lineno"> 4968</span>&#160;    pr[URAD1] /= gamma ;</div>
<div class="line"><a name="l04969"></a><span class="lineno"> 4969</span>&#160;    pr[URAD2] /= gamma ;</div>
<div class="line"><a name="l04970"></a><span class="lineno"> 4970</span>&#160;    pr[URAD3] /= gamma ;</div>
<div class="line"><a name="l04971"></a><span class="lineno"> 4971</span>&#160;    alpha = 1./sqrt(-ptrgeom-&gt;gcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(0,0)]) ;</div>
<div class="line"><a name="l04972"></a><span class="lineno"> 4972</span>&#160;    </div>
<div class="line"><a name="l04973"></a><span class="lineno"> 4973</span>&#160;    <span class="comment">/* reset radial velocity so radial 4-velocity</span></div>
<div class="line"><a name="l04974"></a><span class="lineno"> 4974</span>&#160;<span class="comment">     * is zero */</span></div>
<div class="line"><a name="l04975"></a><span class="lineno"> 4975</span>&#160;    <span class="keywordflow">if</span>(dofixrad==1){</div>
<div class="line"><a name="l04976"></a><span class="lineno"> 4976</span>&#160;      betacon = ptrgeom-&gt;gcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(0,1)]*alpha*alpha ;</div>
<div class="line"><a name="l04977"></a><span class="lineno"> 4977</span>&#160;      pr[URAD1] = betacon/alpha ; <span class="comment">// gives 3-vel contravariant</span></div>
<div class="line"><a name="l04978"></a><span class="lineno"> 4978</span>&#160;    }</div>
<div class="line"><a name="l04979"></a><span class="lineno"> 4979</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(dofixrad==2){</div>
<div class="line"><a name="l04980"></a><span class="lineno"> 4980</span>&#160;      betacon = ptrgeom-&gt;gcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(0,2)]*alpha*alpha ;</div>
<div class="line"><a name="l04981"></a><span class="lineno"> 4981</span>&#160;      pr[URAD2] = betacon/alpha ; <span class="comment">// gives 3-vel contravariant</span></div>
<div class="line"><a name="l04982"></a><span class="lineno"> 4982</span>&#160;    }</div>
<div class="line"><a name="l04983"></a><span class="lineno"> 4983</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(dofixrad==3){</div>
<div class="line"><a name="l04984"></a><span class="lineno"> 4984</span>&#160;      betacon = ptrgeom-&gt;gcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(0,3)]*alpha*alpha ;</div>
<div class="line"><a name="l04985"></a><span class="lineno"> 4985</span>&#160;      pr[URAD3] = betacon/alpha ; <span class="comment">// gives 3-vel contravariant</span></div>
<div class="line"><a name="l04986"></a><span class="lineno"> 4986</span>&#160;    }</div>
<div class="line"><a name="l04987"></a><span class="lineno"> 4987</span>&#160;    <span class="comment">/* now find new gamma and put it back in */</span></div>
<div class="line"><a name="l04988"></a><span class="lineno"> 4988</span>&#160;    vsq = 0. ;</div>
<div class="line"><a name="l04989"></a><span class="lineno"> 4989</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a35c1540b3f1a0de6fe1eb5a1e34e820a" title="loop over all Space dimensions; second rank loop">SLOOP</a>(j,k) vsq += ptrgeom-&gt;<a class="code" href="../../dc/dd2/newcodediff_8txt.html#a93300df7bd864b90cc8ed9f3d96515ad">gcov</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(j,k)]*pr[URAD1+j-1]*pr[URAD1+k-1] ;</div>
<div class="line"><a name="l04990"></a><span class="lineno"> 4990</span>&#160;</div>
<div class="line"><a name="l04991"></a><span class="lineno"> 4991</span>&#160;    if(vsq&lt;0.0){</div>
<div class="line"><a name="l04992"></a><span class="lineno"> 4992</span>&#160;      <span class="keywordflow">if</span>(vsq&gt;-<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a8913cb5d64cfec23ae1a3052930ec468">NUMEPSILON</a>*100.0) vsq=0.0; <span class="comment">// machine precision thing</span></div>
<div class="line"><a name="l04993"></a><span class="lineno"> 4993</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fail(ii,jj,kk,loc,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab711b8ab87b9ecf414b4ee48401467fa">FAIL_VSQ_NEG</a>) &gt;= 1){</div>
<div class="line"><a name="l04994"></a><span class="lineno"> 4994</span>&#160;        trifprintf(<span class="stringliteral">&quot;vsq=%21.15g\n&quot;</span>,vsq);</div>
<div class="line"><a name="l04995"></a><span class="lineno"> 4995</span>&#160;        <span class="keywordflow">return</span> (1);</div>
<div class="line"><a name="l04996"></a><span class="lineno"> 4996</span>&#160;      }</div>
<div class="line"><a name="l04997"></a><span class="lineno"> 4997</span>&#160;    }</div>
<div class="line"><a name="l04998"></a><span class="lineno"> 4998</span>&#160; </div>
<div class="line"><a name="l04999"></a><span class="lineno"> 4999</span>&#160;    <span class="comment">// it&#39;s possible that setting ucon(bc comp)-&gt;0 leads to v&gt;c, so just reduce gamma to GAMMAMAX if that&#39;s the case</span></div>
<div class="line"><a name="l05000"></a><span class="lineno"> 5000</span>&#160;    <span class="keywordflow">if</span>(vsq&gt;=1.0){</div>
<div class="line"><a name="l05001"></a><span class="lineno"> 5001</span>&#160;      <span class="keywordflow">if</span>(debugfail&gt;=1) dualfprintf(fail_file,<span class="stringliteral">&quot;i=%d j=%d k=%d inflow limit required change in gamma (after dofix==%d): vsq=%21.15g newvsq=%21.15g\n&quot;</span>,ii+<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[1],jj+<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[2],kk+<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[3],dofix,vsq,1.0-1.0/(<a class="code" href="../../d8/d5b/defs_8general_8h.html#accef7ff74daca804b9a5a3ad7d3db882">GAMMAMAX</a>*<a class="code" href="../../d8/d5b/defs_8general_8h.html#accef7ff74daca804b9a5a3ad7d3db882">GAMMAMAX</a>));</div>
<div class="line"><a name="l05002"></a><span class="lineno"> 5002</span>&#160;</div>
<div class="line"><a name="l05003"></a><span class="lineno"> 5003</span>&#160;      <span class="comment">// new vsq</span></div>
<div class="line"><a name="l05004"></a><span class="lineno"> 5004</span>&#160;      vsq = 1.0-1.0/(<a class="code" href="../../d8/d5b/defs_8general_8h.html#accef7ff74daca804b9a5a3ad7d3db882">GAMMAMAX</a>*<a class="code" href="../../d8/d5b/defs_8general_8h.html#accef7ff74daca804b9a5a3ad7d3db882">GAMMAMAX</a>);</div>
<div class="line"><a name="l05005"></a><span class="lineno"> 5005</span>&#160;</div>
<div class="line"><a name="l05006"></a><span class="lineno"> 5006</span>&#160;    }</div>
<div class="line"><a name="l05007"></a><span class="lineno"> 5007</span>&#160;</div>
<div class="line"><a name="l05008"></a><span class="lineno"> 5008</span>&#160;    gamma = 1./sqrt(1. - vsq) ;</div>
<div class="line"><a name="l05009"></a><span class="lineno"> 5009</span>&#160;    pr[URAD1] *= gamma ;</div>
<div class="line"><a name="l05010"></a><span class="lineno"> 5010</span>&#160;    pr[URAD2] *= gamma ;</div>
<div class="line"><a name="l05011"></a><span class="lineno"> 5011</span>&#160;    pr[URAD3] *= gamma ;</div>
<div class="line"><a name="l05012"></a><span class="lineno"> 5012</span>&#160;</div>
<div class="line"><a name="l05013"></a><span class="lineno"> 5013</span>&#160;    <span class="comment">// only for boundary conditions, not active zones, hence -1.0 instead of finalstep</span></div>
<div class="line"><a name="l05014"></a><span class="lineno"> 5014</span>&#160;    <span class="keywordtype">int</span> doingmhdfixup=1;</div>
<div class="line"><a name="l05015"></a><span class="lineno"> 5015</span>&#160;    diag_fixup((<a class="code" href="../../d8/d5b/defs_8general_8h.html#a55732148d2616d6d1f5d2abbe8710850">DOENOFLUX</a> != NOENOFLUX),prdiag, pr, ucons, ptrgeom, finalstep,doingmhdfixup,COUNTINFLOWACT);</div>
<div class="line"><a name="l05016"></a><span class="lineno"> 5016</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) prdiag[pl]=pr[pl];</div>
<div class="line"><a name="l05017"></a><span class="lineno"> 5017</span>&#160;</div>
<div class="line"><a name="l05018"></a><span class="lineno"> 5018</span>&#160;  }</div>
<div class="line"><a name="l05019"></a><span class="lineno"> 5019</span>&#160;  </div>
<div class="line"><a name="l05020"></a><span class="lineno"> 5020</span>&#160;</div>
<div class="line"><a name="l05021"></a><span class="lineno"> 5021</span>&#160;  if(dofix||dofixrad){</div>
<div class="line"><a name="l05022"></a><span class="lineno"> 5022</span>&#160;    <span class="keywordflow">return</span>(-1);</div>
<div class="line"><a name="l05023"></a><span class="lineno"> 5023</span>&#160;  }</div>
<div class="line"><a name="l05024"></a><span class="lineno"> 5024</span>&#160;</div>
<div class="line"><a name="l05025"></a><span class="lineno"> 5025</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l05026"></a><span class="lineno"> 5026</span>&#160;</div>
<div class="line"><a name="l05027"></a><span class="lineno"> 5027</span>&#160;}</div>
<div class="line"><a name="l05028"></a><span class="lineno"> 5028</span>&#160; </div>
<div class="line"><a name="l05029"></a><span class="lineno"> 5029</span>&#160;</div>
<div class="line"><a name="l05030"></a><span class="lineno"> 5030</span>&#160;<span class="comment">// fixup fluxes</span></div>
<div class="line"><a name="l05033"></a><span class="lineno"> 5033</span>&#160;<span class="comment"></span><span class="keywordtype">void</span> fix_flux(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pb)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*F1)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*F2)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*F3)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>])</div>
<div class="line"><a name="l05034"></a><span class="lineno"> 5034</span>&#160;{</div>
<div class="line"><a name="l05035"></a><span class="lineno"> 5035</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>,<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>,k,pl ;</div>
<div class="line"><a name="l05036"></a><span class="lineno"> 5036</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> sth ;</div>
<div class="line"><a name="l05037"></a><span class="lineno"> 5037</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> X[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>],V[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>],r,th ;</div>
<div class="line"><a name="l05038"></a><span class="lineno"> 5038</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../db/dec/boundsflux_8c.html#a8754d691787753931622044c7f4e2c26">inboundloop</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l05039"></a><span class="lineno"> 5039</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../db/dec/boundsflux_8c.html#a8807fc7ac0410e5b4f8946af8d20e5f5">outboundloop</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l05040"></a><span class="lineno"> 5040</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../db/dec/boundsflux_8c.html#a2d80075c76ae3f379ad6b0a76e782564">innormalloop</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l05041"></a><span class="lineno"> 5041</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../db/dec/boundsflux_8c.html#aca97d7ba819c1de5d4e47da493f33623">outnormalloop</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l05042"></a><span class="lineno"> 5042</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../db/dec/boundsflux_8c.html#a837550a23566d53384a9b084e0dceb33">inoutlohi</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a169f8e6d2a36fff12cb4999820e22214">NUMUPDOWN</a>][<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a169f8e6d2a36fff12cb4999820e22214">NUMUPDOWN</a>][<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l05043"></a><span class="lineno"> 5043</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../db/dec/boundsflux_8c.html#ac829241613d010b49da556690e5a5dba">riin</a>,<a class="code" href="../../db/dec/boundsflux_8c.html#a9ff963dee6a8ee6dadda7021050f07d1">riout</a>,<a class="code" href="../../db/dec/boundsflux_8c.html#a52d95b79e8bfdeaf3173426e93d4c0bc">rjin</a>,<a class="code" href="../../db/dec/boundsflux_8c.html#a62e6126121a80cd84f5f24116e0ac5e3">rjout</a>,<a class="code" href="../../db/dec/boundsflux_8c.html#a004e2bf74d687fea2dae13579ce6dfd5">rkin</a>,<a class="code" href="../../db/dec/boundsflux_8c.html#ac2060e4059d47a488d84bf9126c19fca">rkout</a>;</div>
<div class="line"><a name="l05044"></a><span class="lineno"> 5044</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../db/dec/boundsflux_8c.html#ae0df21c9bb5d73f77a8cac713c7c9d2c">dosetbc</a>[<a class="code" href="../../da/d3e/definit_8h.html#a1b2ef8afddd2c5d91ab65015bbd7b80b" title="NUMBER OF DIMENSIONS FOR COMPUTATION Can choose 3 and still do 1D optimized problems Choosing 2 or ev...">COMPDIM</a>*2];</div>
<div class="line"><a name="l05045"></a><span class="lineno"> 5045</span>&#160;  <span class="keywordtype">int</span> ri;</div>
<div class="line"><a name="l05046"></a><span class="lineno"> 5046</span>&#160;  <span class="keywordtype">int</span> boundvartype=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a435fa02094f996d08cfc56b1290c1de2">BOUNDFLUXTYPE</a>;</div>
<div class="line"><a name="l05047"></a><span class="lineno"> 5047</span>&#160;</div>
<div class="line"><a name="l05049"></a><span class="lineno"> 5049</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l05050"></a><span class="lineno"> 5050</span>&#160;  <span class="comment">// set bound loop</span></div>
<div class="line"><a name="l05051"></a><span class="lineno"> 5051</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l05053"></a><span class="lineno"> 5053</span>&#160;<span class="comment"></span>  set_boundloop(boundvartype, inboundloop,outboundloop,innormalloop,outnormalloop,inoutlohi, &amp;riin, &amp;riout, &amp;rjin, &amp;rjout, &amp;rkin, &amp;rkout, dosetbc);</div>
<div class="line"><a name="l05054"></a><span class="lineno"> 5054</span>&#160;  <span class="comment">//enerregion=ACTIVEREGION; // now replaces TRUEGLOBALENERREGION</span></div>
<div class="line"><a name="l05055"></a><span class="lineno"> 5055</span>&#160;  <span class="comment">//  localenerpos=enerposreg[enerregion];</span></div>
<div class="line"><a name="l05056"></a><span class="lineno"> 5056</span>&#160;</div>
<div class="line"><a name="l05057"></a><span class="lineno"> 5057</span>&#160;</div>
<div class="line"><a name="l05058"></a><span class="lineno"> 5058</span>&#160;  <span class="comment">// this has nothing to deal with MPI-boundaries, so ok as is</span></div>
<div class="line"><a name="l05059"></a><span class="lineno"> 5059</span>&#160;  <span class="comment">// only applies for polar axis</span></div>
<div class="line"><a name="l05060"></a><span class="lineno"> 5060</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../dd/d46/mpidefs_8h.html#ac3a964fb7b8404428db52c2588d52381">mycpupos</a>[2]==0){  </div>
<div class="line"><a name="l05061"></a><span class="lineno"> 5061</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a516ad1adc872921939df143a56a721af">BCtype</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aae79dca9f851fb40349156f6bca1f8ca">X2DN</a>]==POLARAXIS){</div>
<div class="line"><a name="l05062"></a><span class="lineno"> 5062</span>&#160;      <a class="code" href="../../d9/da3/global_8loops_8boundaries_8h.html#a8d8b8bb42cbf5b3cbea7d0cfdff08c30" title="for X2-dir [Note innormal and outnormal for 3rd direction and full inbound and outbound for 1st direc...">LOOPX2dir</a>{</div>
<div class="line"><a name="l05063"></a><span class="lineno"> 5063</span>&#160;        <span class="comment">// emf should be antisymmetric around polar axes? // GODMARK: how does this mix with metric?</span></div>
<div class="line"><a name="l05064"></a><span class="lineno"> 5064</span>&#160;        <a class="code" href="../../d9/da3/global_8loops_8boundaries_8h.html#a024d4db998ded5c8ed6d1ceabda730ea">LOOPBOUND2IN</a>{</div>
<div class="line"><a name="l05065"></a><span class="lineno"> 5065</span>&#160;          <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F1,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>) = 0;</div>
<div class="line"><a name="l05066"></a><span class="lineno"> 5066</span>&#160;          <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F1,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>) = -<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F1,i,-(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a3e64aa2cd3c5e0933e74fa4e7a925570">jp1mac</a>(j)),k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>) ; <span class="comment">// symmetric positions around polar axis, but antisymmetric value</span></div>
<div class="line"><a name="l05067"></a><span class="lineno"> 5067</span>&#160;          <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F3,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>) = -<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F3,i,-(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a3e64aa2cd3c5e0933e74fa4e7a925570">jp1mac</a>(j)),k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>) ; <span class="comment">// symmetric positions around polar axis, but antisymmetric value</span></div>
<div class="line"><a name="l05068"></a><span class="lineno"> 5068</span>&#160;          <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F3,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>) = 0;</div>
<div class="line"><a name="l05069"></a><span class="lineno"> 5069</span>&#160;        }</div>
<div class="line"><a name="l05070"></a><span class="lineno"> 5070</span>&#160;        <span class="comment">// all should be 0 except kinetic energy flux</span></div>
<div class="line"><a name="l05071"></a><span class="lineno"> 5071</span>&#160;        <span class="comment">// GODMARK: I&#39;m unsure if emf is not unlike, say, \Omega, which is a well-defined thing on the axis.</span></div>
<div class="line"><a name="l05072"></a><span class="lineno"> 5072</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl) if(pl!=U2) <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F2,i,0,k,pl) = 0. ;</div>
<div class="line"><a name="l05073"></a><span class="lineno"> 5073</span>&#160;      }</div>
<div class="line"><a name="l05074"></a><span class="lineno"> 5074</span>&#160;    }</div>
<div class="line"><a name="l05075"></a><span class="lineno"> 5075</span>&#160;  }</div>
<div class="line"><a name="l05076"></a><span class="lineno"> 5076</span>&#160;  if(<a class="code" href="../../dd/d46/mpidefs_8h.html#ac3a964fb7b8404428db52c2588d52381">mycpupos</a>[2]==<a class="code" href="../../dd/d46/mpidefs_8h.html#a2b69fb4a20e91ae01ef8452216afb784">ncpux2</a>-1){</div>
<div class="line"><a name="l05077"></a><span class="lineno"> 5077</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a516ad1adc872921939df143a56a721af">BCtype</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aa9363649053ac2e906715b3259a14954">X2UP</a>]==POLARAXIS){</div>
<div class="line"><a name="l05078"></a><span class="lineno"> 5078</span>&#160;      <a class="code" href="../../d9/da3/global_8loops_8boundaries_8h.html#a8d8b8bb42cbf5b3cbea7d0cfdff08c30" title="for X2-dir [Note innormal and outnormal for 3rd direction and full inbound and outbound for 1st direc...">LOOPX2dir</a>{</div>
<div class="line"><a name="l05079"></a><span class="lineno"> 5079</span>&#160;        <span class="comment">// emf</span></div>
<div class="line"><a name="l05080"></a><span class="lineno"> 5080</span>&#160;        <a class="code" href="../../d9/da3/global_8loops_8boundaries_8h.html#a8159ad46bd8e24ba5363b1e4410bc886">LOOPBOUND2OUT</a>{</div>
<div class="line"><a name="l05081"></a><span class="lineno"> 5081</span>&#160;          <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F1,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>) = -<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F1,i,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a618a8f621abeee9189fe29fa5783d8fd">jrefshiftmac</a>(j),k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>) ;</div>
<div class="line"><a name="l05082"></a><span class="lineno"> 5082</span>&#160;          <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F3,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>) = -<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F3,i,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a618a8f621abeee9189fe29fa5783d8fd">jrefshiftmac</a>(j),k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>) ;</div>
<div class="line"><a name="l05083"></a><span class="lineno"> 5083</span>&#160;        }</div>
<div class="line"><a name="l05084"></a><span class="lineno"> 5084</span>&#160;        <span class="comment">// GODMARK: unsure</span></div>
<div class="line"><a name="l05085"></a><span class="lineno"> 5085</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl) if(pl!=U2) <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F2,i,<a class="code" href="../../da/d3e/definit_8h.html#acd864640121c7df2c19f61f7baa507e4">N2</a>,k,pl) = 0. ;</div>
<div class="line"><a name="l05086"></a><span class="lineno"> 5086</span>&#160;      }</div>
<div class="line"><a name="l05087"></a><span class="lineno"> 5087</span>&#160;    }</div>
<div class="line"><a name="l05088"></a><span class="lineno"> 5088</span>&#160;  }</div>
<div class="line"><a name="l05089"></a><span class="lineno"> 5089</span>&#160;</div>
<div class="line"><a name="l05090"></a><span class="lineno"> 5090</span>&#160;  <span class="comment">// avoid mass flux in wrong direction, so consistent with velocity fix</span></div>
<div class="line"><a name="l05091"></a><span class="lineno"> 5091</span>&#160;  <span class="comment">// how to treat other fluxes?</span></div>
<div class="line"><a name="l05092"></a><span class="lineno"> 5092</span>&#160;  if(<a class="code" href="../../dd/d46/mpidefs_8h.html#ac3a964fb7b8404428db52c2588d52381">mycpupos</a>[1]==0){  </div>
<div class="line"><a name="l05093"></a><span class="lineno"> 5093</span>&#160;    <span class="keywordflow">if</span>((<a class="code" href="../../d8/d5b/defs_8general_8h.html#a516ad1adc872921939df143a56a721af">BCtype</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aab7332b2c03d905515d5350d4fd0850f">X1DN</a>]==OUTFLOW || <a class="code" href="../../d8/d5b/defs_8general_8h.html#a516ad1adc872921939df143a56a721af">BCtype</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aab7332b2c03d905515d5350d4fd0850f">X1DN</a>]==HORIZONOUTFLOW)){</div>
<div class="line"><a name="l05094"></a><span class="lineno"> 5094</span>&#160;      <a class="code" href="../../d9/da3/global_8loops_8boundaries_8h.html#a203e3b910738f16ad48b07082cd62797" title="for X1-dir [Note always uses innormal and outnormal so assumed to use this X1-dir loop first]...">LOOPX1dir</a>{</div>
<div class="line"><a name="l05095"></a><span class="lineno"> 5095</span>&#160;        ri=<a class="code" href="../../db/dec/boundsflux_8c.html#ac829241613d010b49da556690e5a5dba">riin</a>;</div>
<div class="line"><a name="l05096"></a><span class="lineno"> 5096</span>&#160;        <a class="code" href="../../d9/da3/global_8loops_8boundaries_8h.html#ac69bc344822b49071d0f205f3f51baed">LOOPBOUND1IN</a>{</div>
<div class="line"><a name="l05097"></a><span class="lineno"> 5097</span>&#160;          <span class="keywordflow">if</span>(<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F1,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>)&gt;0) <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F1,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>)=0;</div>
<div class="line"><a name="l05098"></a><span class="lineno"> 5098</span>&#160;        }</div>
<div class="line"><a name="l05099"></a><span class="lineno"> 5099</span>&#160;      }</div>
<div class="line"><a name="l05100"></a><span class="lineno"> 5100</span>&#160;    }</div>
<div class="line"><a name="l05101"></a><span class="lineno"> 5101</span>&#160;  }</div>
<div class="line"><a name="l05102"></a><span class="lineno"> 5102</span>&#160;  <span class="keywordflow">if</span>(mycpupos[1]==<a class="code" href="../../dd/d46/mpidefs_8h.html#a849af7562e98534cd4ea5764f5187bbd">ncpux1</a>-1){</div>
<div class="line"><a name="l05103"></a><span class="lineno"> 5103</span>&#160;    <span class="keywordflow">if</span>((<a class="code" href="../../d8/d5b/defs_8general_8h.html#a516ad1adc872921939df143a56a721af">BCtype</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6a3603145c91f722d74610fbd6e4f696" title="----------—&gt; r | 3 | 1-0 | 2 v theta and likewise for 4,5 (4=out,5=in) directions:">X1UP</a>]==OUTFLOW || <a class="code" href="../../d8/d5b/defs_8general_8h.html#a516ad1adc872921939df143a56a721af">BCtype</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6a3603145c91f722d74610fbd6e4f696" title="----------—&gt; r | 3 | 1-0 | 2 v theta and likewise for 4,5 (4=out,5=in) directions:">X1UP</a>]==HORIZONOUTFLOW)){</div>
<div class="line"><a name="l05104"></a><span class="lineno"> 5104</span>&#160;      <a class="code" href="../../d9/da3/global_8loops_8boundaries_8h.html#a203e3b910738f16ad48b07082cd62797" title="for X1-dir [Note always uses innormal and outnormal so assumed to use this X1-dir loop first]...">LOOPX1dir</a>{</div>
<div class="line"><a name="l05105"></a><span class="lineno"> 5105</span>&#160;        <a class="code" href="../../d9/da3/global_8loops_8boundaries_8h.html#ab6234714e5a7d10c0ffcb5836cd3894b">LOOPBOUND1OUT</a>{</div>
<div class="line"><a name="l05106"></a><span class="lineno"> 5106</span>&#160;          <span class="keywordflow">if</span>(<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F1,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>)&lt;0) <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F1,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>)=0;</div>
<div class="line"><a name="l05107"></a><span class="lineno"> 5107</span>&#160;        }</div>
<div class="line"><a name="l05108"></a><span class="lineno"> 5108</span>&#160;      }</div>
<div class="line"><a name="l05109"></a><span class="lineno"> 5109</span>&#160;    }</div>
<div class="line"><a name="l05110"></a><span class="lineno"> 5110</span>&#160;  }</div>
<div class="line"><a name="l05111"></a><span class="lineno"> 5111</span>&#160;</div>
<div class="line"><a name="l05112"></a><span class="lineno"> 5112</span>&#160;}</div>
<div class="line"><a name="l05113"></a><span class="lineno"> 5113</span>&#160;</div>
<div class="line"><a name="l05114"></a><span class="lineno"> 5114</span>&#160;</div>
<div class="line"><a name="l05116"></a><span class="lineno"> 5116</span>&#160;<span class="keywordtype">void</span> diag_eosfaillookup(<span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k)</div>
<div class="line"><a name="l05117"></a><span class="lineno"> 5117</span>&#160;{</div>
<div class="line"><a name="l05118"></a><span class="lineno"> 5118</span>&#160;  <span class="keywordtype">int</span> whocalled = <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a9454f5b09872c480ba94ecf93f8dd954">COUNTEOSLOOKUPFAIL</a>;</div>
<div class="line"><a name="l05119"></a><span class="lineno"> 5119</span>&#160;  <span class="keywordtype">int</span> tscale;</div>
<div class="line"><a name="l05120"></a><span class="lineno"> 5120</span>&#160;</div>
<div class="line"><a name="l05121"></a><span class="lineno"> 5121</span>&#160;  <span class="comment">// count every time corrects</span></div>
<div class="line"><a name="l05122"></a><span class="lineno"> 5122</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#aefc47346bd5140a39b6d744385796e56" title="0: don&#39;t output debug dump file or ener file(ener is based on dump counts) 1: do">DODEBUG</a>){</div>
<div class="line"><a name="l05123"></a><span class="lineno"> 5123</span>&#160;    <span class="keywordflow">if</span>(i==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a12b77db5b3cffcdb67935980d67b5e46" title="below 3 used to indicate when eos lookup failure shouldn&#39;t report failure since (e.g.) was not at a particular grid location">AVOIDI</a> &amp;&amp; j==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a1b789046189c58ac5f01a01327b962b3">AVOIDJ</a> &amp;&amp; k==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a155d6c4ebcc8032058910e913fa4bb2e">AVOIDK</a>){</div>
<div class="line"><a name="l05124"></a><span class="lineno"> 5124</span>&#160;      <span class="comment">// then do nothing since don&#39;t know where failure occurred</span></div>
<div class="line"><a name="l05125"></a><span class="lineno"> 5125</span>&#160;    }</div>
<div class="line"><a name="l05126"></a><span class="lineno"> 5126</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(i&lt;-N1BND || i&gt;<a class="code" href="../../da/d3e/definit_8h.html#abd7b39be02bc15d79b73e5cf2b531299" title="#define CORNGDETVERSION 0">N1</a>-1+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#aa00aaa6c09563827fbe601635b149ef8">N1BND</a> ||j&lt;-N2BND || j&gt;N2-1+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a4053d825930f47a796f9f13678ef32e3">N2BND</a> ||k&lt;-N3BND || k&gt;<a class="code" href="../../da/d3e/definit_8h.html#ad66109fbdc4d3adc9c3d6ff917038aef">N3</a>-1+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a90d132cb201447b8fe71388f1b0ffe93">N3BND</a> ){</div>
<div class="line"><a name="l05127"></a><span class="lineno"> 5127</span>&#160;      dualfprintf(fail_file,<span class="stringliteral">&quot;In diag_eosfaillookup() whocalled=%d for i=%d j=%d k=%d\n&quot;</span>,whocalled,i,j,k);</div>
<div class="line"><a name="l05128"></a><span class="lineno"> 5128</span>&#160;      myexit(3472762356);</div>
<div class="line"><a name="l05129"></a><span class="lineno"> 5129</span>&#160;    }</div>
<div class="line"><a name="l05130"></a><span class="lineno"> 5130</span>&#160;    <span class="keywordtype">int</span> indexfinalstep;</div>
<div class="line"><a name="l05131"></a><span class="lineno"> 5131</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ac92d98c36bda814d2a6241bcbaec69df" title="simple loop over 0 and 1 for failfloorcount[]">FINALSTEPLOOP</a>(indexfinalstep) <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a979d409ad1a4d007f6ec25e62a6d0415" title="loop over debug time scales">TSCALELOOP</a>(tscale) <a class="code" href="../../df/d1c/global_8storage_8h.html#a4ca176a81d2229ced28a5c53ebeacc06">GLOBALMACP0A3</a>(failfloorcount,i,j,k,indexfinalstep,tscale,whocalled)++;</div>
<div class="line"><a name="l05132"></a><span class="lineno"> 5132</span>&#160;  }</div>
<div class="line"><a name="l05133"></a><span class="lineno"> 5133</span>&#160;}</div>
</div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Fri May 20 2016 15:52:33 for HARM by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.8.3.1
</small></address>
</body>
</html>
