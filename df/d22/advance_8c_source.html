<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.3.1"/>
<title>HARM: advance.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">HARM
   </div>
   <div id="projectbrief">harm and utilities</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.3.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="../../search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">advance.c</div>  </div>
</div><!--header-->
<div class="contents">
<a href="../../df/d22/advance_8c.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="preprocessor">#include &quot;decs.h&quot;</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;</div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;</div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> compute_dt_fromsource(<span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *state, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *U, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *<a class="code" href="../../dc/dd2/newcodediff_8txt.html#ae7ab77d7e616dc02fba121a009b48c27">pr</a>, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *dUevolve, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *dUgeomevolveUU, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *dtij, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *gravitydt);</div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> dUtodt(<span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *state, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *<a class="code" href="../../dc/dd2/newcodediff_8txt.html#ae7ab77d7e616dc02fba121a009b48c27">pr</a>, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *dUgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *dUriemann, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *dUgeomgravity, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *accdt, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *gravitydt);</div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> check_point_vs_average(<span class="keywordtype">int</span> timeorder, <span class="keywordtype">int</span> numtimeorders, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflag, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pb, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pf, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *upoint, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *uavg, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <span class="keyword">struct</span> <a class="code" href="../../db/d3a/structof__newtonstats.html">of_newtonstats</a> *newtonstats);</div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;</div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;</div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;</div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> prepare_globaldt(</div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;                            <span class="keywordtype">int</span> truestep, </div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;                            <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ndt1,<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ndt2,<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ndt3,</div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;                            <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> accdt,<span class="keywordtype">int</span> accdti,<span class="keywordtype">int</span> accdtj,<span class="keywordtype">int</span> accdtk,</div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;                            <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gravitydt,<span class="keywordtype">int</span> gravitydti,<span class="keywordtype">int</span> gravitydtj,<span class="keywordtype">int</span> gravitydtk,</div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;                            <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *ndt);</div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;</div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;</div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="comment">//FTYPE globalgeom[NPR];</span></div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> flux2dUavg(<span class="keywordtype">int</span> whichpl, <span class="keywordtype">int</span> <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>, <span class="keywordtype">int</span> <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>, <span class="keywordtype">int</span> k, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*F1)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*F2)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*F3)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *dUavg1,<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *dUavg2,<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *dUavg3);</div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> dUtoU(<span class="keywordtype">int</span> timeorder, <span class="keywordtype">int</span> whichpl, <span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k, <span class="keywordtype">int</span> loc, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *dUgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*dUcomp)[NPR], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *dUriemann, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUf, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUnew, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ui,  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *uf, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *ucum);</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> dUtoU_check(<span class="keywordtype">int</span> timeorder, <span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k, <span class="keywordtype">int</span> loc, <span class="keywordtype">int</span> pl, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *dUgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*dUcomp)[NPR], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *dUriemann, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUf, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUnew, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ui,  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Uf, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *ucum);</div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> asym_compute_1(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*prim)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR]);</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> asym_compute_2(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*prim)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR]);</div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;</div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;</div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="keyword">static</span> <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> <a class="code" href="../../df/d22/advance_8c.html#a080ef26ac144e3416a4c5a0ccc1f1e9b" title="Returns the fractional difference between a &amp; b.">fractional_diff</a>( <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> <a class="code" href="../../d8/d5b/defs_8general_8h.html#aa73cf2d397cae726436e08d2c891bdb0">a</a>, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> b );</div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;</div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="keyword">static</span> <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> compute_dissmeasure(<span class="keywordtype">int</span> timeorder, <span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k, <span class="keywordtype">int</span> loc, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *<a class="code" href="../../dc/dd2/newcodediff_8txt.html#ae7ab77d7e616dc02fba121a009b48c27">pr</a>, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *q, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUf, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUnew, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*F1)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*F2)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*F3)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ui,  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Uf, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *tempucum);</div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;</div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;</div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="comment">// AVG_2_POINT functions:</span></div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> debugeno_compute(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*<a class="code" href="../../d9/d54/other6_8txt.html#a4c46d2d3bb1db943c0dce6af1c779ff5">p</a>)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*U)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*debugvars)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aa347c696e5a33836e47ff9045905dc28" title="#define NUMENODEBUGS 21 see email">NUMENODEBUGS</a>]);</div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;</div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> show_fluxes(<span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k, <span class="keywordtype">int</span> loc, <span class="keywordtype">int</span> pl,<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*F1)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*F2)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*F3)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>]);</div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;</div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d22/advance_8c.html#a217bbc071881142282a66a317664912b" title="this method guarantees conservation of non-sourced conserved quantities when metric is time-dependent...">advance_standard</a>(<span class="keywordtype">int</span> truestep,<span class="keywordtype">int</span> stage, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pi)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pb)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pf)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR],</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;                            <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pstag)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR],</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;                            <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pl_ct)[<a class="code" href="../../df/d1c/global_8storage_8h.html#a917a6677d5e3b38aa54aa577978bf823" title="123">NSTORE1</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR2INTERP], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pr_ct)[<a class="code" href="../../df/d1c/global_8storage_8h.html#a917a6677d5e3b38aa54aa577978bf823" title="123">NSTORE1</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR2INTERP],</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;                            <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*F1)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*F2)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*F3)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>],</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;                            <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*vpot)[<a class="code" href="../../df/d1c/global_8storage_8h.html#a917a6677d5e3b38aa54aa577978bf823" title="123">NSTORE1</a>+<a class="code" href="../../df/d1c/global_8storage_8h.html#a1c452bce7a227fd9f2c8f937a3c7841c">SHIFTSTORE1</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>+<a class="code" href="../../df/d1c/global_8storage_8h.html#adfe8c351b7f60e189dbd9bfca47af5c5">SHIFTSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>+<a class="code" href="../../df/d1c/global_8storage_8h.html#a6dc540b0373d80d3ea2db53d03a9fa72">SHIFTSTORE3</a>],</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;                            <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*ui)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*uf)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*ucum)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR],</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;                            <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUf,<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUnew,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a0263684ebff8e72a2f0de1861393595f">SFTYPE</a> fluxdt, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a0263684ebff8e72a2f0de1861393595f">SFTYPE</a> boundtime, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a0263684ebff8e72a2f0de1861393595f">SFTYPE</a> fluxtime, <span class="keywordtype">int</span> stagenow, <span class="keywordtype">int</span> numstages, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *ndt);</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d22/advance_8c.html#a38c6fa95ece38a2821c70a1524ec47ec" title="this method guarantees conservation of non-sourced conserved quantities when metric is time-dependent...">advance_standard_orig</a>(<span class="keywordtype">int</span> truestep,<span class="keywordtype">int</span> stage, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pi)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pb)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pf)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR],</div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;                            <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pstag)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR],</div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;                            <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pl_ct)[<a class="code" href="../../df/d1c/global_8storage_8h.html#a917a6677d5e3b38aa54aa577978bf823" title="123">NSTORE1</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR2INTERP], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pr_ct)[<a class="code" href="../../df/d1c/global_8storage_8h.html#a917a6677d5e3b38aa54aa577978bf823" title="123">NSTORE1</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR2INTERP],</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;                            <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*F1)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*F2)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*F3)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>],</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;                            <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*vpot)[<a class="code" href="../../df/d1c/global_8storage_8h.html#a917a6677d5e3b38aa54aa577978bf823" title="123">NSTORE1</a>+<a class="code" href="../../df/d1c/global_8storage_8h.html#a1c452bce7a227fd9f2c8f937a3c7841c">SHIFTSTORE1</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>+<a class="code" href="../../df/d1c/global_8storage_8h.html#adfe8c351b7f60e189dbd9bfca47af5c5">SHIFTSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>+<a class="code" href="../../df/d1c/global_8storage_8h.html#a6dc540b0373d80d3ea2db53d03a9fa72">SHIFTSTORE3</a>],</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;                            <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*ui)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*uf)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*ucum)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR],</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;                            <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUf,<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUnew,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a0263684ebff8e72a2f0de1861393595f">SFTYPE</a> fluxdt, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a0263684ebff8e72a2f0de1861393595f">SFTYPE</a> boundtime, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a0263684ebff8e72a2f0de1861393595f">SFTYPE</a> fluxtime, <span class="keywordtype">int</span> stagenow, <span class="keywordtype">int</span> numstages, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *ndt);</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> advance_finitevolume(<span class="keywordtype">int</span> truestep,<span class="keywordtype">int</span> stage, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pi)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pb)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pf)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR],</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;                                <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pstag)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR],</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;                                <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pl_ct)[<a class="code" href="../../df/d1c/global_8storage_8h.html#a917a6677d5e3b38aa54aa577978bf823" title="123">NSTORE1</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR2INTERP], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pr_ct)[<a class="code" href="../../df/d1c/global_8storage_8h.html#a917a6677d5e3b38aa54aa577978bf823" title="123">NSTORE1</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR2INTERP],</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;                                <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*F1)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*F2)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*F3)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>],</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;                                <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*vpot)[<a class="code" href="../../df/d1c/global_8storage_8h.html#a917a6677d5e3b38aa54aa577978bf823" title="123">NSTORE1</a>+<a class="code" href="../../df/d1c/global_8storage_8h.html#a1c452bce7a227fd9f2c8f937a3c7841c">SHIFTSTORE1</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>+<a class="code" href="../../df/d1c/global_8storage_8h.html#adfe8c351b7f60e189dbd9bfca47af5c5">SHIFTSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>+<a class="code" href="../../df/d1c/global_8storage_8h.html#a6dc540b0373d80d3ea2db53d03a9fa72">SHIFTSTORE3</a>],</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;                                <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*ui)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*uf)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*ucum)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR],</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;                                <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUf,<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUnew, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a0263684ebff8e72a2f0de1861393595f">SFTYPE</a> fluxdt, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a0263684ebff8e72a2f0de1861393595f">SFTYPE</a> boundtime, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a0263684ebff8e72a2f0de1861393595f">SFTYPE</a> fluxtime,  <span class="keywordtype">int</span> stagenow, <span class="keywordtype">int</span> numstages, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *ndt);</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;<span class="keywordtype">void</span> pre_interpolate_and_advance(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pb)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR])</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;{</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;  <span class="comment">// Compute and Store (globally) the get_state() data for the CENT position to avoid computing later and for merged-higher-order method</span></div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;<span class="comment"></span><span class="preprocessor">#if(STOREFLUXSTATE||STORESHOCKINDICATOR)</span></div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;<span class="preprocessor"></span>  <span class="comment">// NOTE: This is done before advance since always needed, and only needed once for all dimensions, and don&#39;t here instead of inside advance() since needed during fluxcalc() that is called first before any use of get_geometry() that we would use to put this call with</span></div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;  compute_and_store_fluxstatecent(pb);</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;  <span class="comment">// now flux_compute() and other flux-position-related things will obtain get_state() data for p_l and p_r from global arrays</span></div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;  <span class="comment">// indicate to any needed piece of code that computed pre-interpolates if needed.</span></div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;  <a class="code" href="../../d8/d5b/defs_8general_8h.html#a01e7281889728e2ec41a4159da19ac69">global_preinterpolate</a>=1;</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;}</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;</div>
<div class="line"><a name="l00102"></a><span class="lineno"><a class="code" href="../../df/d22/advance_8c.html#a22dff5dc24ff389254919e70b79be489">  102</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="../../df/d22/advance_8c.html#a22dff5dc24ff389254919e70b79be489" title="pi: initial values at t=t0 to compute Ui pb: values used to compute flux/source pf: solution using fl...">advance</a>(<span class="keywordtype">int</span> truestep, <span class="keywordtype">int</span> stage, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pi)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pb)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pf)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR],</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;            <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pstag)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR],</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;            <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pl_ct)[<a class="code" href="../../df/d1c/global_8storage_8h.html#a917a6677d5e3b38aa54aa577978bf823" title="123">NSTORE1</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR2INTERP], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pr_ct)[<a class="code" href="../../df/d1c/global_8storage_8h.html#a917a6677d5e3b38aa54aa577978bf823" title="123">NSTORE1</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR2INTERP],</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;            <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*F1)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*F2)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*F3)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>],</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;            <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*vpot)[<a class="code" href="../../df/d1c/global_8storage_8h.html#a917a6677d5e3b38aa54aa577978bf823" title="123">NSTORE1</a>+<a class="code" href="../../df/d1c/global_8storage_8h.html#a1c452bce7a227fd9f2c8f937a3c7841c">SHIFTSTORE1</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>+<a class="code" href="../../df/d1c/global_8storage_8h.html#adfe8c351b7f60e189dbd9bfca47af5c5">SHIFTSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>+<a class="code" href="../../df/d1c/global_8storage_8h.html#a6dc540b0373d80d3ea2db53d03a9fa72">SHIFTSTORE3</a>],</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;            <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*ui)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*uf)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*ucum)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR],</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;            <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUf, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUnew, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a0263684ebff8e72a2f0de1861393595f">SFTYPE</a> fluxdt, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a0263684ebff8e72a2f0de1861393595f">SFTYPE</a> boundtime, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a0263684ebff8e72a2f0de1861393595f">SFTYPE</a> fluxtime, <span class="keywordtype">int</span> timeorder, <span class="keywordtype">int</span> numtimeorders, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *ndt)</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;{</div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;  <span class="comment">// setup state and interpolation stuff for interpolation and advance calls</span></div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;<span class="comment"></span>  pre_interpolate_and_advance(pb);</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;  <span class="comment">// advance</span></div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;<span class="comment"></span>  <span class="keywordflow">if</span>(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a55732148d2616d6d1f5d2abbe8710850">DOENOFLUX</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ac634a307561f486f9df8ba8a67c21c19">ENOFINITEVOLUME</a>){</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;    <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(advance_finitevolume(truestep,stage,pi,pb,pf,pstag,pl_ct, pr_ct, F1, F2, F3, vpot,ui,uf,ucum,CUf,CUnew,fluxdt,boundtime,fluxtime,timeorder,numtimeorders,ndt),<span class="stringliteral">&quot;advance.c:advance()&quot;</span>, <span class="stringliteral">&quot;advance_finitevolume()&quot;</span>, 1);</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;  }</div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>((<a class="code" href="../../d8/d5b/defs_8general_8h.html#a55732148d2616d6d1f5d2abbe8710850">DOENOFLUX</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#adacaaf8526353cfe870206f0cf4d2ca7" title="for DOENOFLUX: 0: no ENO flux reconstruction 1: reconstruct F for finite difference rep...">NOENOFLUX</a>)||(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a55732148d2616d6d1f5d2abbe8710850">DOENOFLUX</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a81c6be7c38a1e29b40efa57ca47d0d02">ENOFLUXRECON</a>)||(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a55732148d2616d6d1f5d2abbe8710850">DOENOFLUX</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a286c4981cce7871d9c990e9e02a69471">ENOFLUXSPLIT</a>)){</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;    <span class="comment">// new standard preserves conserved quantities even when metric changes</span></div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;    <span class="comment">//    MYFUN(advance_standard_orig(truestep,stage,pi,pb,pf,pstag,pl_ct, pr_ct, F1, F2, F3, vpot,ui,uf,ucum,CUf,CUnew,fluxdt,boundtime,fluxtime,timeorder,numtimeorders,ndt),&quot;advance.c:advance()&quot;, &quot;advance_standard()&quot;, 1);</span></div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;    <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(<a class="code" href="../../df/d22/advance_8c.html#a217bbc071881142282a66a317664912b" title="this method guarantees conservation of non-sourced conserved quantities when metric is time-dependent...">advance_standard</a>(truestep,stage,pi,pb,pf,pstag,pl_ct, pr_ct, F1, F2, F3, vpot,ui,uf,ucum,CUf,CUnew,fluxdt,boundtime,fluxtime,timeorder,numtimeorders,ndt),<span class="stringliteral">&quot;advance.c:advance()&quot;</span>, <span class="stringliteral">&quot;advance_standard()&quot;</span>, 1);</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;  }</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;    dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;No such DOENOFLUX=%d\n&quot;</span>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a55732148d2616d6d1f5d2abbe8710850">DOENOFLUX</a>);</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;    myexit(1);</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;  }</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;</div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;}</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;<span class="comment">// Notes:</span></div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;<span class="comment">// loop range defined with +SHIFT? so consistent with requirement by IF3DSPCTHENMPITRANSFERATPOLE or consistent with setting upper face flux and using it, which is only used for FLUXBSTAG for evolving field on faces.  This forces field on upper face to be evolved as required in some cases.</span></div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;<span class="comment">// This is bit excessive for non-face quantities, but fake partial evolution of centered value at &quot;N&quot; is ok as long as don&#39;t hit NaN&#39;s that slow down code.</span></div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;</div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;</div>
<div class="line"><a name="l00160"></a><span class="lineno"><a class="code" href="../../df/d22/advance_8c.html#a217bbc071881142282a66a317664912b">  160</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d22/advance_8c.html#a217bbc071881142282a66a317664912b" title="this method guarantees conservation of non-sourced conserved quantities when metric is time-dependent...">advance_standard</a>(</div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;                            <span class="keywordtype">int</span> truestep,</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;                            <span class="keywordtype">int</span> stage,</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;                            <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pi)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR],</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;                            <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pb)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR],</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;                            <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pf)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR],</div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;                            <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pstag)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR],</div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;                            <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pl_ct)[<a class="code" href="../../df/d1c/global_8storage_8h.html#a917a6677d5e3b38aa54aa577978bf823" title="123">NSTORE1</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR2INTERP], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pr_ct)[<a class="code" href="../../df/d1c/global_8storage_8h.html#a917a6677d5e3b38aa54aa577978bf823" title="123">NSTORE1</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR2INTERP],</div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;                            <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*F1)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*F2)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*F3)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>],</div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;                            <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*vpot)[<a class="code" href="../../df/d1c/global_8storage_8h.html#a917a6677d5e3b38aa54aa577978bf823" title="123">NSTORE1</a>+<a class="code" href="../../df/d1c/global_8storage_8h.html#a1c452bce7a227fd9f2c8f937a3c7841c">SHIFTSTORE1</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>+<a class="code" href="../../df/d1c/global_8storage_8h.html#adfe8c351b7f60e189dbd9bfca47af5c5">SHIFTSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>+<a class="code" href="../../df/d1c/global_8storage_8h.html#a6dc540b0373d80d3ea2db53d03a9fa72">SHIFTSTORE3</a>],</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;                            <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*ui)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR],</div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;                            <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*uf)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR],</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;                            <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*ucum)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR], </div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;                            <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUf, </div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;                            <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUnew, </div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;                            <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a0263684ebff8e72a2f0de1861393595f">SFTYPE</a> fluxdt,</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;                            <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a0263684ebff8e72a2f0de1861393595f">SFTYPE</a> boundtime,</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;                            <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a0263684ebff8e72a2f0de1861393595f">SFTYPE</a> fluxtime,</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;                            <span class="keywordtype">int</span> timeorder, <span class="keywordtype">int</span> numtimeorders,</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;                            <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *ndt)</div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;{</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ndt1, ndt2, ndt3;</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dUtot;</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> idx1,idx2;</div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;  <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a0263684ebff8e72a2f0de1861393595f">SFTYPE</a> dt4diag;</div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;  <span class="keyword">static</span> <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a0263684ebff8e72a2f0de1861393595f">SFTYPE</a> dt4diag_willbe=0;</div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;  <span class="keywordtype">int</span> finalstep,initialstep;</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> accdt, accdt_ij;</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;  <span class="keywordtype">int</span> accdti,accdtj,accdtk;</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gravitydt, gravitydt_ij;</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;  <span class="keywordtype">int</span> gravitydti,gravitydtj,gravitydtk;</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;  <span class="comment">//  FTYPE (*dUriemannarray)[NSTORE2][NSTORE3][NPR];</span></div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*ucumformetric)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR];</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;  <span class="keywordtype">int</span> enerregion;</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;  <span class="keywordtype">int</span> *localenerpos;</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;  <span class="keywordtype">int</span> jj;</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*utoinvert)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR];</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *utoinvert1;</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*tempucum)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR];</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*useducum)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR];</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *useducum1;</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*preupoint)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR];</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*myupoint)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR];</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *myupoint1;</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*myupointuf)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR];</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*olduf)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR];</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;  <span class="keywordtype">int</span> whichpltoavg[NPR];</div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;  <span class="keywordtype">int</span> ifnotavgthencopy[NPR];</div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;  <span class="keywordtype">int</span> is,ie,js,je,ks,ke;</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;  <span class="keywordtype">int</span> doingextrashiftforstag;</div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;  <span class="keywordflow">if</span>((<a class="code" href="../../d8/d5b/defs_8general_8h.html#a5ef0ed187c80734536c4ef6156bc43c2">GLOBALBCMOVEDWITHACTIVESECTION</a>==0 || USEMPI) &amp;&amp; truestep &amp;&amp; <a class="code" href="../../da/d3e/definit_8h.html#ae2cc56909ed67595b899f79bfe6fe8c3" title="whether to do ENO debug">DOGRIDSECTIONING</a>){</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;    <span class="comment">// then need to fill pf with pi everywhere in global region, so that non-ACTIVE region will be set for boundary conditions within the domain.</span></div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;    <span class="keywordtype">int</span> <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>,<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>,k,pliter,pl;</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;    <a class="code" href="../../da/db2/global_8loops_8manypoints_8h.html#a197212887b1b5691f14a128a4c23646a" title="below used for initialization and such, not a computational issue">LOOPF</a>{</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pf,i,j,k,pl) = <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pi,i,j,k,pl);</div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;    }</div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;  }</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;</div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a11c4e99e1493d0c1914ad1ab313ea472">FLUXB</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0b6762cef74e396f50a83864bb53fb6c">FLUXCTSTAG</a>){</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;    <span class="comment">// fill in tempucum with changes that are not controlled well in space, but later fill in ucum from this in controlled way</span></div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;    tempucum=<a class="code" href="../../df/d1c/global_8storage_8h.html#ad89dafa5d772b862a44b0f576983ead3" title="shifted pointer (a_s_) wrappers Couldn&#39;t figure out how to macrofy a_s_ or a_, so when changing have ...">GLOBALPOINT</a>(utemparray);</div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;    useducum=tempucum; <span class="comment">// unless changed</span></div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;  }</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;    <span class="comment">// no special shifting of indices occurs that requires loop shifting</span></div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;    tempucum=ucum;</div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;    useducum=ucum;</div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;  }</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;  olduf=<a class="code" href="../../df/d1c/global_8storage_8h.html#ad89dafa5d772b862a44b0f576983ead3" title="shifted pointer (a_s_) wrappers Couldn&#39;t figure out how to macrofy a_s_ or a_, so when changing have ...">GLOBALPOINT</a>(oldufstore);</div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;</div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;  ucumformetric=<a class="code" href="../../df/d1c/global_8storage_8h.html#ad89dafa5d772b862a44b0f576983ead3" title="shifted pointer (a_s_) wrappers Couldn&#39;t figure out how to macrofy a_s_ or a_, so when changing have ...">GLOBALPOINT</a>(ucumformetric);<span class="comment">// temporary space for ucum for metric that is same time as &quot;pb&quot;, so not updated yet or is ui</span></div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;</div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;</div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;</div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;  <span class="comment">// Setup function tasks</span></div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;  <span class="comment">// for ZLOOP:</span></div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;  <span class="comment">// avoid looping over region outside active+ghost grid</span></div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;  <span class="comment">// good because somewhat general and avoid bad inversions, etc.</span></div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;  enerregion=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ada79b005f9c0caf71f9365c1e16d8c80">TRUEGLOBALWITHBNDENERREGION</a>;</div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;  localenerpos=<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad41a84c69f5ec4a51492e96b4dc61ac4">enerposreg</a>[enerregion];</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;</div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;</div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;  accdt=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>; <span class="comment">// initially no limit to dt due to acceleration</span></div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;  accdti=accdtj=accdtk=-100;</div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;  gravitydt=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>; <span class="comment">// initially no limit to dt due to time derivatives in gravity</span></div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;  gravitydti=gravitydtj=gravitydtk=-100;</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;</div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;</div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;</div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;</div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;  <span class="comment">// set initialstep and finalstep to tell some procedures and diagnostic functions if should be accounting or not</span></div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;<span class="comment"></span>  <span class="keywordflow">if</span>(timeorder==0){</div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;    initialstep=1;</div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;  }</div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;    initialstep=0;</div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;  }</div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;</div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;  <span class="keywordflow">if</span>(timeorder==numtimeorders-1){</div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;    finalstep=1;</div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;  }</div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;    finalstep=0;</div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;  }</div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;</div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;</div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;  <span class="comment">// whether need to compute flux</span></div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;  <span class="comment">// only compute flux if flux is added to get Uf or Ucum</span></div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;<span class="comment"></span>  <span class="keywordtype">int</span> <a class="code" href="../../d8/d5b/defs_8general_8h.html#a03344fc1457035406713e8d85d215576" title="used for each region, related to global quantities _tot quantities here are global since used in rest...">doflux</a> = (CUf[2]!=0.0 || CUnew[1]!=0.0); <span class="comment">// in reality, only do flux if CUf[2]!=0 as CUnew is just to accumulate to get U^{n+1}</span></div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;  <span class="comment">// current implicit dt factor</span></div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;  <span class="comment">// Since we don&#39;t pass CUnew[NUMPREDTCUFS+timeorder], we assume never try to add M^i into U^{n+1} unless computed for current U^i or previous U^i</span></div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUimp=&amp;CUf[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a214c8d806784f513292419871af16a25">NUMPREDTCUFS</a>+timeorder];</div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;</div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;</div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;  <span class="comment">// set dt4diag for source diagnostics</span></div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;<span class="comment"></span>  <span class="keywordflow">if</span>(timeorder==numtimeorders-1 &amp;&amp; (<a class="code" href="../../d8/d5b/defs_8general_8h.html#a1a1088d87617078680f1fd0f0d707384">nstep</a>%<a class="code" href="../../da/d3e/definit_8h.html#a397b655d0a3bd70f6d2c007c3a9d7ebe">DIAGSOURCECOMPSTEP</a>==0) ){</div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;    <span class="comment">// every 4 full steps as well as on final step of full step (otherwise diag_source_comp() too expensive)</span></div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;    dt4diag=dt4diag_willbe;</div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;    dt4diag_willbe=0;</div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;  }</div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;    dt4diag_willbe+=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a56db625f31229c5e8b208ff27d464931">dt</a>;</div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;    dt4diag=-1.0;</div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;  }</div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;</div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;</div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;</div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;  <span class="comment">// Setup loops [+1 extra compared to normal comp region if doing FLUXCTSTAG]</span></div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;<span class="comment"></span>  get_flux_startendindices(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ab5c60dcb37b1f7e5642525031cd5cbcf">Uconsevolveloop</a>,&amp;is,&amp;ie,&amp;js,&amp;je,&amp;ks,&amp;ke);</div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;</div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;</div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;</div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;  <span class="comment">// Set initial ui, temporary space, so ok that COMPZLOOP() goes over +1 in FLUXB==FLUXCTSTAG case</span></div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;<span class="comment"></span>  <span class="keywordflow">if</span>(timeorder==0){</div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;    <span class="comment">// last timestep&#39;s final ucum is stored into ucumformetric and ui as initial term in ucum</span></div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;    <span class="comment">// copy ucum -&gt; {ucumformetric,ui}</span></div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;    <span class="keywordflow">if</span>(doingmetricsubstep()) copy_3dnpr_2ptrs(is,ie,js,je,ks,ke,ucum,ucumformetric,ui);</div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;    <span class="keywordflow">else</span> copy_3dnpr(is,ie,js,je,ks,ke,ucum,ui); <span class="comment">// only need to setup ui then</span></div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;  }</div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;    <span class="comment">// preserve this time&#39;s value of ucum for the metric (for timeorder==0 ucumformetric is assigned from ui)</span></div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;    <span class="comment">// copy ucum -&gt; ucumformetric</span></div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;    <span class="keywordflow">if</span>(doingmetricsubstep()) copy_3dnpr(is,ie,js,je,ks,ke,ucum,ucumformetric);</div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;  }</div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;</div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;</div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;</div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;  <span class="comment">// Compute flux</span></div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;<span class="preprocessor">#if(PRODUCTION==0)</span></div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;<span class="preprocessor"></span>  trifprintf( <span class="stringliteral">&quot;#0f&quot;</span>);</div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;</div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;</div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;</div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;  ndt1=ndt2=ndt3=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>; <span class="comment">// if doflux==0 or truestep==0, then setting ndt=BIG means doesn&#39;t affect any other sub-steps or steps that are trying to set dt as minimum over sub-step dt&#39;s.</span></div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;  <span class="keywordflow">if</span>(doflux &amp;&amp; truestep){ <span class="comment">// only do if not just passing through</span></div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;    <span class="keywordflow">if</span>(1){</div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;      <span class="comment">// NORMAL:</span></div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;      <span class="comment">// pb used here on a stencil, so if pb=pf or pb=pi in pointers, shouldn&#39;t change pi or pf yet -- don&#39;t currently</span></div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;      <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(<a class="code" href="../../dc/dae/flux_8c.html#ab229b0f3f2caf3c0a3ef5299fba2b1c0" title="see fluxcompute.c for non-computer science, real physics calculations of flux">fluxcalc</a>(stage,initialstep,finalstep,pb,pstag,pl_ct, pr_ct, vpot,F1,F2,F3,CUf,CUnew,fluxdt,fluxtime,&amp;ndt1,&amp;ndt2,&amp;ndt3),<span class="stringliteral">&quot;advance.c:advance_standard()&quot;</span>, <span class="stringliteral">&quot;fluxcalcall&quot;</span>, 1);</div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;    }</div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;  }<span class="comment">// end if not just passing through</span></div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;  <span class="comment">// from here on, pi/pb/pf are only used a zone at a time rather than on a stencil</span></div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;</div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;</div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;</div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;<span class="preprocessor">#if(PRODUCTION==0)</span></div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;<span class="preprocessor"></span>  trifprintf( <span class="stringliteral">&quot;1f&quot;</span>);</div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160; </div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;</div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;</div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;</div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;</div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;  <span class="comment">// now update get flux update [loop should go over normal computational region +1 on outer edges so automatically set field if staggered.  Since we only set tempucum so far, ucum in that +1 region is unaffected]</span></div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;</div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;  <span class="keywordtype">int</span> didreturnpf;</div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;  <span class="keywordflow">if</span>(truestep){</div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;</div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;</div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;    <span class="comment">// initialize uf and ucum if very first time here since ucum is cumulative (+=) [now tempucum is cumulative]</span></div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;    <span class="comment">// copy 0 -&gt; {uf,tempucum,olduf}</span></div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;    <span class="keywordflow">if</span>(timeorder==0) init_3dnpr_3ptrs(is, ie, js, je, ks, ke,0.0, uf,tempucum,olduf);</div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;</div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;</div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;</div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;<span class="preprocessor">#if(WHICHEOM==WITHNOGDET &amp;&amp; (NOGDETB1==1 || NOGDETB2==1 || NOGDETB3==1) )</span></div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;<span class="preprocessor"></span>    <span class="comment">// for FLUXB==FLUXCTSTAG, assume no source term for field</span></div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a11c4e99e1493d0c1914ad1ab313ea472">FLUXB</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0b6762cef74e396f50a83864bb53fb6c">FLUXCTSTAG</a>){</div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;      dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;Not setup for field source term if staggered field\n&quot;</span>);</div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;      myexit(176023);</div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;    }</div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;  </div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;   </div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;</div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;    <span class="comment">// FIRST UPDATE FIELD using its flux</span></div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;<span class="comment"></span>    <span class="keywordtype">int</span> doother=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac578a63f887dbc4797b555bd9c468a5f">DOALLPL</a>; <span class="comment">// default</span></div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a11c4e99e1493d0c1914ad1ab313ea472">FLUXB</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0b6762cef74e396f50a83864bb53fb6c">FLUXCTSTAG</a>){</div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;      doother=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a2932863193c6165af8a2a33ce597c27c">DONONBPL</a>;</div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;      </div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;      <span class="comment">// then field version of ui[] is stored as &quot;conserved&quot; value at FACE, not CENT</span></div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;      <span class="comment">//PLOOPBONLY(pl) MACP0A1(ui,i,j,k,pl) is itself // FACE (see step_ch.c&#39;s setup_rktimestep and know that ui=unew for before first substep)</span></div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;</div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;      <span class="keywordflow">if</span>(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#acd8b4c9899cba6ecfcaf9292cf9db17a">NOGDETB1</a> ||<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#af0e822c28f1b4f38270e64317e2c7590">NOGDETB2</a> ||<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0cba504dc38c151c3be0ef3bb6f4c396">NOGDETB3</a>){</div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;        dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;This approach requires B have no source terms.\n&quot;</span>);</div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;        myexit(34983463);</div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;      }</div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;</div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;<span class="preprocessor">#pragma omp parallel // OPENMPGLOBALPRIVATEFORINVERSION // don&#39;t need EOS stuff here since not getting state or doing inversion yet.</span></div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;<span class="preprocessor"></span>      {</div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;        <span class="keywordtype">int</span> pl,pliter,<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>,<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>,k;</div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;        <span class="comment">// zero-out dUgeom in case non-B pl&#39;s used.</span></div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;        <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dUgeom[NPR]={0.0},dUriemann[NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>]={0.0},dUriemann1[NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>]={0.0},dUriemann2[NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>]={0.0},dUriemann3[NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>]={0.0};</div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;        <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dUcomp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ac34589654a83c911addd1fda0898e738">NUMSOURCES</a>][NPR];</div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;        <span class="keywordtype">int</span> sc;</div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a2da8b12fca78064531b9b64e5699e4fc" title="loop over ALL sources (including geometry)">SCLOOP</a>(sc) dUcomp[sc][pl]=0.0;</div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;</div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;</div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;        <span class="comment">// [Loop goes over up to +1 normal computational region for getting new staggered U if doing FLUXCTSTAG] so can do interpolation on it to get centered field</span></div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;<span class="comment"></span>        <a class="code" href="../../d5/d7b/global_8openmploops_8h.html#a1389db2daf5bd9e94918090c253a16c9">OPENMP3DLOOPVARSDEFINE</a>; <a class="code" href="../../d5/d7b/global_8openmploops_8h.html#a8de37da93c3462c536ef830f2fbaee61" title="forced to be a computational loop, so start/stop cannot already have shifts in them (which is normal ...">OPENMP3DLOOPSETUP</a>(is,ie,js,je,ks,ke);</div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;</div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;<span class="preprocessor">#pragma omp for schedule(OPENMPSCHEDULE(),OPENMPCHUNKSIZE(blocksize))</span></div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;<span class="preprocessor"></span>        <a class="code" href="../../d5/d7b/global_8openmploops_8h.html#a9e48537d3cb58cc3a3765b8a18b43b15" title="Oddly, performance changes by 10% when changing how start and stop blockijk (and fixing how used too ...">OPENMP3DLOOPBLOCK</a>{</div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;          <a class="code" href="../../df/d1c/global_8storage_8h.html#a96983b0c56e836f50cb7c1af16f59fb6">OPENMP3DLOOPBLOCK2IJK</a>(i,j,k);</div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;</div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;          <span class="comment">// dUriemann is actually average quantity, but we treat is as a point quantity at the zone center</span></div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;          <span class="keywordflow">if</span>(doflux){</div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;            flux2dUavg(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38be7776d45c50ab681a1d9fd7b34bb2">DOBPL</a>,i,j,k,F1,F2,F3,dUriemann1,dUriemann2,dUriemann3);</div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;            <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a9afde1f1647e18e733406a1566b8b550">PLOOPBONLY</a>(pl) dUriemann[pl]=dUriemann1[pl]+dUriemann2[pl]+dUriemann3[pl]; <span class="comment">// this addition is one type of avg-&gt;point mistake</span></div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;          }</div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;          <span class="keywordflow">else</span> <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a9afde1f1647e18e733406a1566b8b550">PLOOPBONLY</a>(pl) dUriemann[pl]=0.0;</div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;</div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;          <span class="comment">// Get update</span></div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;          <span class="comment">// ui is itself at FACE as already set</span></div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;          <span class="comment">// this overwrites uf[B1,B2,B3], while need original uf[B1,B2,B3] for some RK methods, so store as olduf outside this loop, already.</span></div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;          dUtoU(timeorder,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38be7776d45c50ab681a1d9fd7b34bb2">DOBPL</a>,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8936711f57f82d1fc75c21fa2894e1c6">CENT</a>,dUgeom, dUcomp, dUriemann, CUf, CUnew, <a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(ui,i,j,k), <a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(uf,i,j,k), <a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(tempucum,i,j,k));</div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;          <span class="keywordflow">if</span>(finalstep==0){</div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;            <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) <span class="keywordflow">if</span>(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a56c640597356b6f642dd6ee1afb87e74">BPL</a>(pl)) <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(olduf,i,j,k,pl) = <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(uf,i,j,k,pl);</div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;          }</div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;</div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;        }<span class="comment">//end loop</span></div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;      }<span class="comment">// end parallel</span></div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;</div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;</div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;</div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;      <span class="comment">// first copy over all quantities as point, which is true except for fields if FLUXRECON active</span></div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;      <span class="comment">// copy utoinvert -&gt; myupoint</span></div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;      <span class="comment">// only copy magnetic field pl&#39;s -- later copy rest when needed for inversion</span></div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;      <span class="comment">// KORALNOTE: For general RK method, need to feed-into implicit solver field from Uf, not tempucum.  So seems I need both fields to be processed for such RK methods.   One for actual final field, and one for &quot;initial+flux&quot; form into implicit solver that just contributes to tempucum.</span></div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;</div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;      <span class="comment">// if using staggered grid for magnetic field, then need to convert ucum to pstag to new pb/pf</span></div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;      <span class="comment">// GODMARK: Use of globals</span></div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;      myupoint=<a class="code" href="../../df/d1c/global_8storage_8h.html#ad89dafa5d772b862a44b0f576983ead3" title="shifted pointer (a_s_) wrappers Couldn&#39;t figure out how to macrofy a_s_ or a_, so when changing have ...">GLOBALPOINT</a>(upointglobal);</div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;      </div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;      <span class="keywordflow">if</span>(1){ <span class="comment">// normal switching case</span></div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;      </div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;        <span class="keywordflow">if</span>(finalstep==1) preupoint=tempucum;</div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;        <span class="keywordflow">else</span> preupoint=uf;</div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;      </div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;        copy_tempucum_finalucum(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38be7776d45c50ab681a1d9fd7b34bb2">DOBPL</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#ab5c60dcb37b1f7e5642525031cd5cbcf">Uconsevolveloop</a>,preupoint,myupoint);</div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;</div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;        <span class="comment">// uses tempucum and gets reaveraged field into myupoint</span></div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;        <span class="keywordflow">if</span>(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a41163ae4887e295df142ae7fc9b4829c">extrazones4emf</a> &amp;&amp; <a class="code" href="../../d8/d5b/defs_8general_8h.html#ad5c8369abdf1833b4afc10d11d52b537">dofluxreconevolvepointfield</a>==0) field_integrate_fluxrecon(stage, pb, preupoint, myupoint);</div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;</div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;        <span class="comment">// first pb entry is used for shock indicator, second is filled with new field</span></div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;        <span class="comment">// myupoint goes in as staggered point value of magnetic flux and returned as centered point value of magnetic flux</span></div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;        <a class="code" href="../../d0/dde/fluxctstag_8c.html#a3c59ef3a54b18bbaf4970c13995dadfc" title="wrapper for taking staggered conserved field quantity and obtaining centered field quantity upoint en...">interpolate_ustag2fieldcent</a>(stage, boundtime, timeorder, numtimeorders, pb, pstag, myupoint, NULL);</div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;      }</div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;</div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;      <span class="comment">// special higher-time-order uf-always calculation of field for when final ucum is different from final uf</span></div>
<div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;      <span class="comment">// if CUnew[2]==1 on final step, then means Uf we compute is same as ucum.</span></div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;      <span class="keywordflow">if</span>(finalstep==1 &amp;&amp; CUnew[2]!=1.0){</div>
<div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;</div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;        <span class="comment">// still have to do uf calculation</span></div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;        myupointuf=<a class="code" href="../../df/d1c/global_8storage_8h.html#ad89dafa5d772b862a44b0f576983ead3" title="shifted pointer (a_s_) wrappers Couldn&#39;t figure out how to macrofy a_s_ or a_, so when changing have ...">GLOBALPOINT</a>(upointglobaluf);</div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;        <span class="comment">// get other non-field things in case used</span></div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;        <span class="comment">// NO, not used, so can avoid.</span></div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;        <span class="comment">//        int pliter;</span></div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;        <span class="comment">//        // NOT RIGHT, shoud full copy: PLOOP(pliter,pl) MACP0A1(myupointuf,i,j,k,pl) = MACP0A1(myupoint,i,j,k,pl);</span></div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;</div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;        preupoint=uf;</div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;      </div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;        copy_tempucum_finalucum(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38be7776d45c50ab681a1d9fd7b34bb2">DOBPL</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#ab5c60dcb37b1f7e5642525031cd5cbcf">Uconsevolveloop</a>,preupoint,myupointuf);</div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;</div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;        <span class="comment">// uses tempucum and gets reaveraged field into myupointuf</span></div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;        <span class="keywordflow">if</span>(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a41163ae4887e295df142ae7fc9b4829c">extrazones4emf</a> &amp;&amp; <a class="code" href="../../d8/d5b/defs_8general_8h.html#ad5c8369abdf1833b4afc10d11d52b537">dofluxreconevolvepointfield</a>==0) field_integrate_fluxrecon(stage, pb, preupoint, myupointuf);</div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;</div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;        <span class="comment">// first pb entry is used for shock indicator, second is filled with new field</span></div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;        <span class="comment">// myupointuf goes in as staggered point value of magnetic flux and returned as centered point value of magnetic flux</span></div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;        <a class="code" href="../../d0/dde/fluxctstag_8c.html#a3c59ef3a54b18bbaf4970c13995dadfc" title="wrapper for taking staggered conserved field quantity and obtaining centered field quantity upoint en...">interpolate_ustag2fieldcent</a>(stage, boundtime, timeorder, numtimeorders, pb, pstag, myupointuf, NULL);</div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;</div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;      }</div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;      <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;        <span class="comment">// then no need for separate myupointuf, so just point to same space</span></div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;        myupointuf=myupoint;</div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;      }</div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;</div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;</div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;      <span class="comment">// now myupoint contain CENTered point conserved (to be converted to primitive quantity later) ready for MHD or RAD inversion procedures (or implicit use of such inversions)</span></div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;      <span class="comment">// myupointuf contains always uf version of field</span></div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;      <span class="comment">// myupoint constains uf version except for finalstep=1, when it contains tempucum version</span></div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;    }<span class="comment">// end if staggered field method</span></div>
<div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;  </div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;</div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;</div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;</div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;</div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;    <span class="comment">// get loop range (only needs to be over same location as final centered primitive to invert.</span></div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;    get_inversion_startendindices(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ab5c60dcb37b1f7e5642525031cd5cbcf">Uconsevolveloop</a>,&amp;is,&amp;ie,&amp;js,&amp;je,&amp;ks,&amp;ke);</div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;</div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;</div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;    <span class="comment">// UPDATE NON_FIELD using flux and source</span></div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;    <span class="comment">// PERFORM INVERSION</span></div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;    <span class="comment">// DO FIXUP1ZONE</span></div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;<span class="comment"></span><span class="preprocessor">#pragma omp parallel OPENMPGLOBALPRIVATEFORSTATEANDGEOM  // &lt;-- only includes more than OPENMPGLOBALPRIVATEFORINVERSION needed for inversion</span></div>
<div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;<span class="preprocessor"></span>    {</div>
<div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;      <span class="keywordtype">int</span> pl,pliter,<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>,<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>,k;</div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;      <span class="keyword">struct </span><a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> geomdontuse;</div>
<div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;      <span class="keyword">struct </span><a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom=&amp;geomdontuse;</div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;</div>
<div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;      <span class="comment">// for source()</span></div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Uitemp[NPR];</div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;      <span class="comment">// set all to zero in case doother=DONONBPL in which case need rest of calculations to know no change to field</span></div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dUgeom[NPR]={0},dUriemann[NPR]={0},dUriemann1[NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>]={0},dUriemann2[NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>]={0},dUriemann3[NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>]={0},dUcomp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ac34589654a83c911addd1fda0898e738">NUMSOURCES</a>][NPR]={{0}};</div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;      <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> qdontuse;</div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;      <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *qptr=&amp;qdontuse;</div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;      <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> qdontuse2;</div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;      <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *qptr2=&amp;qdontuse2; <span class="comment">// different qptr since call normal and special get_state()</span></div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;</div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;</div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;      <span class="comment">// for inversion</span></div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> prbefore[NPR];</div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;      <span class="keyword">struct </span><a class="code" href="../../db/d3a/structof__newtonstats.html">of_newtonstats</a> newtonstats; setnewtonstatsdefault(&amp;newtonstats);</div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;      <span class="keywordtype">int</span> showmessages=1;</div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;      <span class="keywordtype">int</span> allowlocalfailurefixandnoreport=1; <span class="comment">// allow local fixups</span></div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;      <span class="comment">// initialize counters</span></div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;      newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a073783ba864c07681c8999a67162202b">nstroke</a>=newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a83280998e47831044a7e35299495a9bb">lntries</a>=0;</div>
<div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;      <span class="keywordtype">int</span> eomtype;</div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;</div>
<div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;</div>
<div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;</div>
<div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;      <a class="code" href="../../d5/d7b/global_8openmploops_8h.html#a1389db2daf5bd9e94918090c253a16c9">OPENMP3DLOOPVARSDEFINE</a>; <a class="code" href="../../d5/d7b/global_8openmploops_8h.html#a8de37da93c3462c536ef830f2fbaee61" title="forced to be a computational loop, so start/stop cannot already have shifts in them (which is normal ...">OPENMP3DLOOPSETUP</a>(is,ie,js,je,ks,ke);</div>
<div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;      </div>
<div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;<span class="preprocessor">#pragma omp for schedule(OPENMPSCHEDULE(),OPENMPCHUNKSIZE(blocksize))</span></div>
<div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;<span class="preprocessor"></span>      <a class="code" href="../../d5/d7b/global_8openmploops_8h.html#a9e48537d3cb58cc3a3765b8a18b43b15" title="Oddly, performance changes by 10% when changing how start and stop blockijk (and fixing how used too ...">OPENMP3DLOOPBLOCK</a>{</div>
<div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;        <a class="code" href="../../df/d1c/global_8storage_8h.html#a96983b0c56e836f50cb7c1af16f59fb6">OPENMP3DLOOPBLOCK2IJK</a>(i,j,k);</div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;</div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;        <span class="comment">// setup default eomtype</span></div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;        eomtype=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aa28b06d889a02621b45edc716bfb2d01">EOMDEFAULT</a>;</div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;</div>
<div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;</div>
<div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;        <span class="comment">// set geometry for centered zone to be updated</span></div>
<div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;        <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a3059ed7bfcfb692cbe8014d55fd7c1e4">get_geometry</a>(i, j, k, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8936711f57f82d1fc75c21fa2894e1c6">CENT</a>, ptrgeom);</div>
<div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;      </div>
<div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;        <span class="comment">// find Ui(pi)</span></div>
<div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;        <span class="comment">// force use of primitive to set Ui since otherwise wherever corrected/changed primitive (in fixup, etc.) then would have to change conserved quantity, while same since both are point values</span></div>
<div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;        <span class="comment">// only field for staggered method is special point value at faces that needs to come from conserved quantity</span></div>
<div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;        <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a11e17cd8b0594d1ad52e3594aa9f477e" title="find ucon, ucov, bcon, bcov from primitive variables when calling get_state, users of this function e...">get_state</a>(<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(pi,i,j,k), ptrgeom, qptr),<span class="stringliteral">&quot;step_ch.c:advance()&quot;</span>, <span class="stringliteral">&quot;get_state()&quot;</span>, 1);</div>
<div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;        <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a9a54096e4c40a15a2c1bf74266153616" title="calculate &quot;conserved&quot; quantities">primtoU</a>(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a15d073255fcc246f09aa26337e643d22" title="defines data return types for primtoU() and primtoflux()">UEVOLVE</a>,<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(pi,i,j,k), qptr, ptrgeom, Uitemp, NULL),<span class="stringliteral">&quot;step_ch.c:advance()&quot;</span>, <span class="stringliteral">&quot;primtoU()&quot;</span>, 1);</div>
<div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;</div>
<div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;        <span class="keywordflow">if</span>(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a11c4e99e1493d0c1914ad1ab313ea472">FLUXB</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0b6762cef74e396f50a83864bb53fb6c">FLUXCTSTAG</a> || <a class="code" href="../../d8/d5b/defs_8general_8h.html#a55732148d2616d6d1f5d2abbe8710850">DOENOFLUX</a> != <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#adacaaf8526353cfe870206f0cf4d2ca7" title="for DOENOFLUX: 0: no ENO flux reconstruction 1: reconstruct F for finite difference rep...">NOENOFLUX</a> ){</div>
<div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;          <span class="comment">// then field version of ui[] is stored as &quot;conserved&quot; value at FACE, not CENT</span></div>
<div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a26c7def0d92cbac4d6a7e03a68c3825a">PLOOPNOB1</a>(pl) <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(ui,i,j,k,pl)=Uitemp[pl]; <span class="comment">// CENT</span></div>
<div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;          <span class="comment">//PLOOPBONLY(pl) MACP0A1(ui,i,j,k,pl) is itself // FACE (see step_ch.c&#39;s setup_rktimestep and know that ui=unew for before first substep)</span></div>
<div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a122c19dd82429684d201ae0f9521be53">PLOOPNOB2</a>(pl) <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(ui,i,j,k,pl)=Uitemp[pl]; <span class="comment">// CENT</span></div>
<div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;        }</div>
<div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;        <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(ui,i,j,k,pl)=Uitemp[pl]; <span class="comment">// all at CENT</span></div>
<div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;        }</div>
<div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;</div>
<div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;        <span class="comment">//        if(myid==5 &amp;&amp; nstep==1 &amp;&amp; steppart==0 &amp;&amp; ptrgeom-&gt;i==19 &amp;&amp; ptrgeom-&gt;j==15){</span></div>
<div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;        <span class="comment">//          PLOOP(pliter,pl) dualfprintf(fail_file,&quot;pl=%d pi=%21.15g ui=%21.15g\n&quot;,MACP0A1(pi,i,j,k,pl),MACP0A1(ui,i,j,k,pl)*ptrgeom-&gt;igdetnosing);</span></div>
<div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;        <span class="comment">//        }</span></div>
<div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160; </div>
<div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;        <span class="comment">// dUriemann is actually average quantity, but we treat is as a point quantity at the zone center</span></div>
<div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;        <span class="keywordflow">if</span>(doflux){</div>
<div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;          flux2dUavg(doother,i,j,k,F1,F2,F3,dUriemann1,dUriemann2,dUriemann3);</div>
<div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) dUriemann[pl]=dUriemann1[pl]+dUriemann2[pl]+dUriemann3[pl]; <span class="comment">// this addition is one type of avg-&gt;point mistake</span></div>
<div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;        }</div>
<div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;        <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) dUriemann[pl]=0.0;</div>
<div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;        }</div>
<div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;</div>
<div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;        <span class="comment">// save pi before it gets modified in case pf=pi or pf=pb as a pointer.</span></div>
<div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;        <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> piorig[NPR],pborig[NPR];</div>
<div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl){</div>
<div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;          piorig[pl] = <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pi,i,j,k,pl);</div>
<div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;          pborig[pl] = <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,i,j,k,pl);</div>
<div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;        }</div>
<div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;</div>
<div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;</div>
<div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;        <span class="comment">// Utoprim as initial conditions : can&#39;t assume want these to be same in the end, so assign</span></div>
<div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;        <span class="comment">// MAJORNOTE: final step often sets pointers of pi=pf, in order to use arbitrary guess, so must set pf ONLY once pi is done being used.</span></div>
<div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;        <span class="comment">// pb is probably closer than pi for inversion</span></div>
<div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;<span class="comment"></span>        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl) <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pf,i,j,k,pl) = <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,i,j,k,pl);</div>
<div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;        <span class="keywordflow">if</span>(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a11c4e99e1493d0c1914ad1ab313ea472">FLUXB</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0b6762cef74e396f50a83864bb53fb6c">FLUXCTSTAG</a>){</div>
<div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;          <span class="comment">// then upoint actually contains centered updated field used for source() and starting point for more readily getting inversion</span></div>
<div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;          <span class="comment">// myupointuf contains always uf version, not tempucum version, of updated field.</span></div>
<div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a9afde1f1647e18e733406a1566b8b550">PLOOPBONLY</a>(pl) <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pf,i,j,k,pl)=<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(myupointuf,i,j,k,pl)*ptrgeom-&gt;igdetnosing; <span class="comment">// valid for this setup of NOGDETB1/B2/B3==0</span></div>
<div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;        }</div>
<div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;</div>
<div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;</div>
<div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;        <span class="comment">// get state since both source() and dUtodt() need same state</span></div>
<div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;        <span class="comment">// From pb, so different than state for Ui(pi)</span></div>
<div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;        <span class="comment">// Inside source() might use pb,pf,etc. to get new state.</span></div>
<div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;        <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(<a class="code" href="../../de/d8c/phys_8c.html#a126e2e13b7ac0d2c79b17ecf87129b77" title="wrapper for choosing to get state by computing it or from global array pointer assign (overrides the ...">get_stateforsource</a>(pborig, ptrgeom, &amp;qptr2) ,<span class="stringliteral">&quot;advance.c:()&quot;</span>, <span class="stringliteral">&quot;get_state() dir=0&quot;</span>, 1);</div>
<div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;      </div>
<div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;</div>
<div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;        <span class="comment">// note that uf and ucum are initialized inside setup_rktimestep() before first substep</span></div>
<div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;</div>
<div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;        <span class="comment">// get dissmeasure</span></div>
<div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;        <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dissmeasure=compute_dissmeasure(timeorder,i,j,k,ptrgeom-&gt;p,<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(pf,i,j,k),ptrgeom,qptr2,CUf, CUnew, F1, F2, F3, <a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(ui,i,j,k),<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(olduf,i,j,k), <a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(tempucum,i,j,k)); <span class="comment">// GODMARK:  If doflux==0, then this actually uses old F&#39;s.</span></div>
<div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;</div>
<div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;        <span class="comment">// find dU(pb)</span></div>
<div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;        <span class="comment">// so pf contains updated field at cell center for use in (e.g.) implicit solver that uses inversion P(U)</span></div>
<div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;        <span class="comment">// Note that uf[B1,B2,B3] is already updated, but need to pass old uf for RK3/RK4, so use olduf.</span></div>
<div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;        <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a4ebf7765a6bde079a76719b89d3033b6" title="add in source terms to equations of motion ui and dUriemann in UEVOLVE form assume q(pr) so consisten...">source</a>(piorig, pborig, <a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(pf,i,j,k), &amp;didreturnpf, &amp;eomtype, ptrgeom, qptr2, <a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(ui,i,j,k), <a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(olduf,i,j,k), CUf, CUimp,dissmeasure, dUriemann, dUcomp, dUgeom),<span class="stringliteral">&quot;step_ch.c:advance()&quot;</span>, <span class="stringliteral">&quot;source&quot;</span>, 1);</div>
<div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;        <span class="comment">// assumes final dUcomp is nonzero and representative of source term over this timestep</span></div>
<div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;        </div>
<div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;</div>
<div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;</div>
<div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;<span class="preprocessor">#if(SPLITNPR)</span></div>
<div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;<span class="preprocessor"></span>        <span class="comment">// don&#39;t update metric if only doing B1-B3</span></div>
<div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;        <span class="keywordflow">if</span>(<a class="code" href="../../d8/d5b/defs_8general_8h.html#aa2010d23a21177641277f5119a2705c7">advancepassnumber</a>==-1 || <a class="code" href="../../d8/d5b/defs_8general_8h.html#aa2010d23a21177641277f5119a2705c7">advancepassnumber</a>==1)</div>
<div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;<span class="preprocessor"></span>          {</div>
<div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;            <span class="keywordflow">if</span>(<a class="code" href="../../d8/d5b/defs_8general_8h.html#aac5486df6a846aa6cb47c73202ac0485">DODIAGS</a>){</div>
<div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;<span class="preprocessor">#if(ACCURATESOURCEDIAG&gt;=1)</span></div>
<div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;<span class="preprocessor"></span>              diag_source_all(ptrgeom,dUgeom,fluxdt);</div>
<div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;<span class="preprocessor"></span>              diag_source_all(ptrgeom,dUgeom,dt4diag);</div>
<div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#if(ACCURATESOURCEDIAG&gt;=2)</span></div>
<div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;<span class="preprocessor"></span>              diag_source_comp(ptrgeom,dUcomp,fluxdt);</div>
<div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;<span class="preprocessor"></span>              diag_source_comp(ptrgeom,dUcomp,dt4diag);</div>
<div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;<span class="preprocessor"></span>            }</div>
<div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;          }</div>
<div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;</div>
<div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;      </div>
<div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;        <span class="comment">// Get update: tempucum</span></div>
<div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;<span class="comment"></span>        <span class="comment">//        PLOOP(pliter,pl) globalgeom[pl]=ptrgeom-&gt;gdet;</span></div>
<div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;        <span class="comment">// ok to use &quot;uf&quot; here instead of &quot;olduf&quot; since field is not done here.</span></div>
<div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;        <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ufconsider[NPR],tempucumconsider[NPR];</div>
<div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;          ufconsider[pl]=<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(olduf,i,j,k,pl);</div>
<div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;          tempucumconsider[pl]=<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(tempucum,i,j,k,pl);</div>
<div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;        }</div>
<div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;        dUtoU(timeorder,doother,i,j,k,ptrgeom-&gt;p,dUgeom, dUcomp, dUriemann, CUf, CUnew, <a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(ui,i,j,k), ufconsider, tempucumconsider);</div>
<div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;</div>
<div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;        <span class="comment">// KORALNOTE: field dUtoU loses previous time uf needed for RK3 and RK4, so need to store it for safe keeping</span></div>
<div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;        <span class="comment">// this oldud is used for B1,B2,B3 and required in cases when CUf[1]!=0.0, as even TVD RK2 method needs because previous Uf used even for updating new Uf.</span></div>
<div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;<span class="comment"></span>        <span class="comment">// Save uf here because below modify uf to account for floors.</span></div>
<div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;        <span class="comment">// The later modification of uf is required for &gt;=RK3 methods that use olduf</span></div>
<div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;        <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> origolduf[NPR];</div>
<div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;        <span class="keywordflow">if</span>(doother==<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a2932863193c6165af8a2a33ce597c27c">DONONBPL</a>){</div>
<div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;            <span class="keywordflow">if</span>(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a56c640597356b6f642dd6ee1afb87e74">BPL</a>(pl)==0){</div>
<div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;              origolduf[pl] = <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(olduf,i,j,k,pl);</div>
<div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;              <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(olduf,i,j,k,pl) = ufconsider[pl];</div>
<div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;            }</div>
<div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;          }</div>
<div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;        }</div>
<div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(doother==<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac578a63f887dbc4797b555bd9c468a5f">DOALLPL</a>){</div>
<div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;            origolduf[pl] = <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(olduf,i,j,k,pl);</div>
<div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;            <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(olduf,i,j,k,pl) = ufconsider[pl];</div>
<div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;          }</div>
<div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;        }</div>
<div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;</div>
<div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;</div>
<div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;        <span class="comment">// Choose what to invert</span></div>
<div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;<span class="comment"></span>        <span class="keywordflow">if</span>(finalstep){</div>
<div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;          <span class="comment">// invert ucum on final step</span></div>
<div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;          utoinvert = tempucum;</div>
<div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;          useducum=tempucum;</div>
<div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;</div>
<div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;          utoinvert1 = tempucumconsider;</div>
<div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;          useducum1 = tempucumconsider;</div>
<div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;</div>
<div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;        }</div>
<div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;        <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;          <span class="comment">// invert uf on substeps</span></div>
<div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;          utoinvert = uf; <span class="comment">// should always be uf, not olduf.</span></div>
<div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;          <span class="comment">// tempucum just cumulates for now</span></div>
<div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;          useducum=tempucum;</div>
<div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;</div>
<div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;          utoinvert1 = ufconsider;</div>
<div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;          useducum1 = tempucumconsider;</div>
<div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;        }</div>
<div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;        <span class="keywordflow">if</span>(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a11c4e99e1493d0c1914ad1ab313ea472">FLUXB</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0b6762cef74e396f50a83864bb53fb6c">FLUXCTSTAG</a>){</div>
<div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;          <span class="comment">// copy over evolved field.  If finalstep=1, then myupoint contains ucum field as required.  Else has uf field as required.</span></div>
<div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a9afde1f1647e18e733406a1566b8b550">PLOOPBONLY</a>(pl) utoinvert1[pl] = <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(myupoint,i,j,k,pl);</div>
<div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;        } <span class="comment">// else already there as point centered quantity</span></div>
<div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;        </div>
<div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;        </div>
<div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;</div>
<div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;<span class="preprocessor">#if(0)</span></div>
<div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;        <span class="comment">// setup myupoint to invert</span></div>
<div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;<span class="comment"></span>        <span class="keywordflow">if</span>(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a11c4e99e1493d0c1914ad1ab313ea472">FLUXB</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0b6762cef74e396f50a83864bb53fb6c">FLUXCTSTAG</a>){</div>
<div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;          <span class="comment">// already have field in myupoint, just copy the others over</span></div>
<div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) <span class="keywordflow">if</span>(doother==<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac578a63f887dbc4797b555bd9c468a5f">DOALLPL</a> || doother==<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a2932863193c6165af8a2a33ce597c27c">DONONBPL</a> &amp;&amp; <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a56c640597356b6f642dd6ee1afb87e74">BPL</a>(pl)==0 || doother==<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38be7776d45c50ab681a1d9fd7b34bb2">DOBPL</a> &amp;&amp; <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a56c640597356b6f642dd6ee1afb87e74">BPL</a>(pl)==1) <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(myupoint,i,j,k,pl)=<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(utoinvert,i,j,k,pl);</div>
<div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;        }</div>
<div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;        <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;          <span class="comment">// utoinvert never reassigned from global a_utoinvert assignment since if here not doing FLUXCTSTAG</span></div>
<div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;          myupoint=utoinvert;</div>
<div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;        }</div>
<div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;        myupoint1=utoinvert1;</div>
<div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;        <span class="comment">// INVERT [loop only over &quot;centered&quot; cells]</span></div>
<div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;        <span class="comment">// Utoprimgen() properly  uses eomtype as potentially changed in source() call</span></div>
<div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;        <span class="comment">// if doing inversion, then check if should use entropy or energy if originally assuming should use energy</span></div>
<div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;<span class="comment"></span>        <span class="keywordtype">int</span> eomtypelocal;</div>
<div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;        eomtypelocal=eomtype;</div>
<div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;</div>
<div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;</div>
<div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;</div>
<div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;        <span class="comment">// Setup and Do inversion</span></div>
<div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;<span class="comment"></span>        <span class="keywordflow">if</span>(finalstep){ <span class="comment">// last call, so ucum is cooked and ready to eat!</span></div>
<div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;          <span class="comment">// store guess for diss_compute before changed by normal inversion</span></div>
<div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl) prbefore[pl]=<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pf,i,j,k,pl);</div>
<div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;</div>
<div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;          <span class="keywordflow">if</span>(CUnew[2]==1.0){</div>
<div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;            <span class="comment">// then use original eomtypelocal</span></div>
<div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;          }</div>
<div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;          <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;            <span class="comment">// then Uf is not ucum on finalstep=1, so any prior implicit inversion was not final inversion.</span></div>
<div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;            <span class="comment">// So change any do nothing to do something</span></div>
<div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;            <span class="keywordflow">if</span>(eomtypelocal==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a04d93d33dd8dba356800fa12cb80064e">EOMDIDGRMHD</a>) eomtypelocal=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a03d89f51ab60206791830c886d62bfd0">EOMGRMHD</a>;</div>
<div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;            <span class="keywordflow">else</span> <span class="keywordflow">if</span>(eomtypelocal==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a74427604dbc716cea325f65f5c927662">EOMDIDENTROPYGRMHD</a>) eomtypelocal=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a40b55e98bfcccde1a3f19d983ca7488c">EOMENTROPYGRMHD</a>;</div>
<div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;            <span class="keywordflow">else</span> <span class="keywordflow">if</span>(eomtypelocal==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a32a2f53eca0d980049cee1dd4680aa00">EOMDIDCOLDGRMHD</a>) eomtypelocal=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a757ad8b9c2c7611dad8aab853a87f61b">EOMCOLDGRMHD</a>;</div>
<div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;            <span class="keywordflow">else</span> <span class="keywordflow">if</span>(eomtypelocal==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3420955bd635f2316f19b5fbd2bf9377" title="whether relativistic or nonrelativistic EOMs (speed of light limitation)">EOMDIDFFDE</a>) eomtypelocal=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6f6094bc467dc61f9490ad7e1de63580">EOMFFDE</a>;</div>
<div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;            <span class="keywordflow">else</span> <span class="keywordflow">if</span>(eomtypelocal==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a74db521f4998f75d6ed72e6408d12ef4">EOMDIDFFDE2</a>) eomtypelocal=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a30a753538ac3bf4801ac123a37dfcc57">EOMFFDE2</a>;</div>
<div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;          }</div>
<div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;        }</div>
<div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;</div>
<div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;</div>
<div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;</div>
<div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;        <span class="comment">// actual inversion</span></div>
<div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;        <span class="keywordtype">int</span> whichcap=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a4b6c6060c025e15f1d92aae3dcb9365b" title="which cap type to place in rad inversion">CAPTYPEBASIC</a>;</div>
<div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;        <span class="keywordtype">int</span> whichmethod=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aef33cf4e6c2534137907bc2eaefdb224">MODEPICKBEST</a>; <span class="comment">// try to choose best option for this &quot;external&quot; inversion</span></div>
<div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;        <span class="keywordtype">int</span> modprim=0;</div>
<div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;        <span class="keywordtype">int</span> checkoninversiongas=<a class="code" href="../../da/d3e/definit_8h.html#a5dc18e6d15e4420586d45d912fccebac" title="whether to check on inversion and report problem Also, use diag_fixup() to account for changes in U w...">CHECKONINVERSION</a>;</div>
<div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;        <span class="keywordtype">int</span> checkoninversionrad=<a class="code" href="../../da/d3e/definit_8h.html#a70e4418eb8c6479afc202024b46ad581">CHECKONINVERSIONRAD</a>;</div>
<div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;        <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(<a class="code" href="../../d1/d3e/utoprimgen_8c.html#a7e078cc9a354495bc85554d875a705d9" title="General explicit inversion of U[MHD]-&gt;P[MHD] and also inverts scalars. Inverts radiation if(EOMRADTYP...">Utoprimgen</a>(showmessages,checkoninversiongas,checkoninversionrad,allowlocalfailurefixandnoreport, finalstep,&amp;eomtypelocal,whichcap,whichmethod,modprim,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7d1dc231c422450f87fdb3e71b4a7aff" title="defines how Utoprimgen is used">EVOLVEUTOPRIM</a>,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a15d073255fcc246f09aa26337e643d22" title="defines data return types for primtoU() and primtoflux()">UEVOLVE</a>,utoinvert1, qptr2, ptrgeom, dissmeasure, piorig, <a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(pf,i,j,k),&amp;newtonstats),<span class="stringliteral">&quot;step_ch.c:advance()&quot;</span>, <span class="stringliteral">&quot;Utoprimgen&quot;</span>, 1);</div>
<div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;        <a class="code" href="../../d8/d5b/defs_8general_8h.html#a5f1c4a4bf07f7a6010404484cb9e6b50">nstroke</a>+=newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a073783ba864c07681c8999a67162202b">nstroke</a>; newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a073783ba864c07681c8999a67162202b">nstroke</a>=newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a83280998e47831044a7e35299495a9bb">lntries</a>=0;</div>
<div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;          </div>
<div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;          </div>
<div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;<span class="preprocessor">#if(DODISS||DODISSVSR)</span></div>
<div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;<span class="preprocessor"></span>        <span class="keywordflow">if</span>(finalstep){</div>
<div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;          <span class="comment">// then see what entropy inversion would give</span></div>
<div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;          diss_compute(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7d1dc231c422450f87fdb3e71b4a7aff" title="defines how Utoprimgen is used">EVOLVEUTOPRIM</a>,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a15d073255fcc246f09aa26337e643d22" title="defines data return types for primtoU() and primtoflux()">UEVOLVE</a>,utoinvert1,ptrgeom,prbefore,<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(pf,i,j,k),&amp;newtonstats);</div>
<div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;        }</div>
<div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;<span class="preprocessor"></span>          </div>
<div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;        </div>
<div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;        </div>
<div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;        <span class="comment">// Do fixup1zone and adjust dUriemann, uf, and tempucum</span></div>
<div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;<span class="comment"></span><span class="preprocessor">#if(SPLITNPR)</span></div>
<div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;<span class="preprocessor"></span>        <span class="comment">// don&#39;t update metric if only doing B1-B3</span></div>
<div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;        <span class="keywordflow">if</span>(<a class="code" href="../../d8/d5b/defs_8general_8h.html#aa2010d23a21177641277f5119a2705c7">advancepassnumber</a>==-1 || <a class="code" href="../../d8/d5b/defs_8general_8h.html#aa2010d23a21177641277f5119a2705c7">advancepassnumber</a>==1)</div>
<div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;<span class="preprocessor"></span>          {</div>
<div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;            <span class="comment">// immediate local (i.e. 1-zone) fix</span></div>
<div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;<span class="preprocessor">#if(FIXUPZONES==FIXUP1ZONE)</span></div>
<div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;<span class="preprocessor"></span>            <span class="comment">// SUPERGODMARK: Below should differentiate beteween whether want negative densities fixed or not, but right now fixup1zone() does all</span></div>
<div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;            <span class="keywordflow">if</span>((<a class="code" href="../../da/d3e/definit_8h.html#a01d34fa922c4eaac94e27f2179523626" title="whether to allow negative internal energy in substep UTOPRIMFAILRETURNTYPE==UTOPRIMRETURNADJUSTED sho...">STEPOVERNEGU</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aadfa6222f83a05ce3739fedf420bdfea">NEGDENSITY_ALWAYSFIXUP</a>)||(<a class="code" href="../../da/d3e/definit_8h.html#a23eeede57657104811b4f7e5e7dda656" title="seems to make things worse (more failures, but also worse failures)">STEPOVERNEGRHO</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aadfa6222f83a05ce3739fedf420bdfea">NEGDENSITY_ALWAYSFIXUP</a>)||(<a class="code" href="../../d8/dc0/init_8h.html#a352ef6d348d5c3986dc77165755b8733">STEPOVERNEGRHOU</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aadfa6222f83a05ce3739fedf420bdfea">NEGDENSITY_ALWAYSFIXUP</a>)||(finalstep)){</div>
<div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;              <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> utoinvertlocal[NPR];</div>
<div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;              <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) utoinvertlocal[pl] = utoinvert1[pl];</div>
<div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;              <span class="keywordtype">int</span> docorrectucons=0;</div>
<div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;              <span class="keywordtype">int</span> didfixup=fixup1zone(docorrectucons,<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(pf,i,j,k),utoinvertlocal, ptrgeom,finalstep);</div>
<div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;            }<span class="comment">// if might do fixups</span></div>
<div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;<span class="preprocessor"></span>          }<span class="comment">// end doing single-point fixups</span></div>
<div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;</div>
<div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;</div>
<div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;        </div>
<div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;        </div>
<div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;        <span class="comment">// Save results to uf and tempucum (whether fixup or not)</span></div>
<div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;<span class="comment"></span>        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;          <span class="comment">// only save if not already updated uf and tempucum separately</span></div>
<div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;          <span class="keywordflow">if</span>(doother==<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac578a63f887dbc4797b555bd9c468a5f">DOALLPL</a> || doother==<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a2932863193c6165af8a2a33ce597c27c">DONONBPL</a> &amp;&amp; <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a56c640597356b6f642dd6ee1afb87e74">BPL</a>(pl)==0 || doother==<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38be7776d45c50ab681a1d9fd7b34bb2">DOBPL</a> &amp;&amp; <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a56c640597356b6f642dd6ee1afb87e74">BPL</a>(pl)==1){</div>
<div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;            <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(uf,i,j,k,pl)=ufconsider[pl];</div>
<div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;            <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(tempucum,i,j,k,pl)=tempucumconsider[pl];</div>
<div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;          }</div>
<div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;        }</div>
<div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;</div>
<div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;      </div>
<div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;            </div>
<div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;      </div>
<div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;        <span class="comment">// get timestep limit from acceleration</span></div>
<div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;<span class="comment"></span><span class="preprocessor">#if(LIMITDTWITHSOURCETERM)</span></div>
<div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#if(SPLITNPR)</span></div>
<div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;<span class="preprocessor"></span>        <span class="comment">// don&#39;t do dUtodt if only doing B1-B3</span></div>
<div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;        <span class="keywordflow">if</span>(<a class="code" href="../../d8/d5b/defs_8general_8h.html#aa2010d23a21177641277f5119a2705c7">advancepassnumber</a>==-1 || <a class="code" href="../../d8/d5b/defs_8general_8h.html#aa2010d23a21177641277f5119a2705c7">advancepassnumber</a>==1)</div>
<div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;<span class="preprocessor"></span>          {</div>
<div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;            <span class="comment">// geometry is post-metric update, but should still give good estimate of future dt</span></div>
<div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;            dUtodt(ptrgeom, qptr2, <a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(pb,i,j,k), dUgeom, dUriemann, dUcomp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a06b1d017ed7599c17c423f4d989a8d63" title="these get ADDED UP, not independently treated number of source terms.">GEOMSOURCE</a>], &amp;accdt_ij, &amp;gravitydt_ij);</div>
<div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;</div>
<div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;<span class="preprocessor">#pragma omp critical</span></div>
<div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;<span class="preprocessor"></span>            {</div>
<div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;              <span class="keywordflow">if</span>(accdt_ij&lt;accdt){</div>
<div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;                accdt=accdt_ij;</div>
<div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;                accdti=<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>;</div>
<div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;                accdtj=<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>;</div>
<div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;                accdtk=k;</div>
<div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;              }</div>
<div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;              <span class="keywordflow">if</span>(gravitydt_ij&lt;gravitydt){</div>
<div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;                gravitydt=gravitydt_ij;</div>
<div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;                gravitydti=<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>;</div>
<div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;                gravitydtj=<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>;</div>
<div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;                gravitydtk=k;</div>
<div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;              }</div>
<div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;            }<span class="comment">// end critical region</span></div>
<div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;          }<span class="comment">// end block that may mean: if not only doing B1-B3</span></div>
<div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;</div>
<div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;<span class="preprocessor">#endif // end if doing LIMITDTWITHSOURCETERM</span></div>
<div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;<span class="preprocessor"></span>          </div>
<div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;</div>
<div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;</div>
<div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;</div>
<div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;      } <span class="comment">// end COMPZLOOP :: end looping to obtain dUriemann and full unew update</span></div>
<div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;    }<span class="comment">// end parallel block</span></div>
<div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;  } <span class="comment">// end if truestep</span></div>
<div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;    <span class="comment">// then nothing to do since nothing changed</span></div>
<div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;    <span class="comment">// previously updated dU and got new ucum as fed into metric, but now metric has its own ucummetric so all that is not needed</span></div>
<div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;    <span class="comment">// SUPERGODMARK: no, I guess I don&#39;t recall what was being done for metric and why when passing through with dt==0.0</span></div>
<div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;</div>
<div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;    <span class="comment">// just need to copy ui -&gt; {uf,tempucum} to duplicate behavior of dUtoU()</span></div>
<div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;    copy_3dnpr_2ptrs(is,ie,js,je,ks,ke,ui,uf,tempucum);</div>
<div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;  }</div>
<div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;</div>
<div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;</div>
<div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;</div>
<div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;</div>
<div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;</div>
<div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;<span class="preprocessor">#if(PRODUCTION==0)</span></div>
<div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;<span class="preprocessor"></span>  trifprintf( <span class="stringliteral">&quot;#0m&quot;</span>);</div>
<div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;</div>
<div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;</div>
<div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160; </div>
<div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;    </div>
<div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;  <span class="comment">// EVOLVE (update/compute) METRIC HERE</span></div>
<div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;  <span class="comment">// In general computes stress-energy tensor (T) from pb and T is then used to compute metric</span></div>
<div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;  <span class="comment">// Done here instead of after flux since horizon_flux() updates flux through boundary that would change metric</span></div>
<div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;  <span class="comment">// want metric to be at same time as everything else done with pb so RK method is consistent</span></div>
<div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;  <span class="comment">// uses unew that&#39;s NOT updated yet</span></div>
<div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;<span class="comment"></span>  <span class="keywordflow">if</span>(truestep){</div>
<div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;    <span class="keywordflow">if</span>(doingmetricsubstep()){</div>
<div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;<span class="preprocessor">#if(SPLITNPR)</span></div>
<div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;<span class="preprocessor"></span>      <span class="comment">// don&#39;t update metric if only doing B1-B3</span></div>
<div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;      <span class="keywordflow">if</span>(<a class="code" href="../../d8/d5b/defs_8general_8h.html#aa2010d23a21177641277f5119a2705c7">advancepassnumber</a>==-1 || <a class="code" href="../../d8/d5b/defs_8general_8h.html#aa2010d23a21177641277f5119a2705c7">advancepassnumber</a>==1)</div>
<div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;<span class="preprocessor"></span>        {</div>
<div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;          compute_new_metric_substep(CUf,CUnew,pb,ucumformetric); <span class="comment">// CHANGINGMARK : Not sure if CUnew here is correct</span></div>
<div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;        }</div>
<div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;    }<span class="comment">// end if doing metric substepping</span></div>
<div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;  }</div>
<div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;</div>
<div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;</div>
<div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;</div>
<div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;</div>
<div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;</div>
<div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;  <span class="comment">// compute flux diagnostics (accurately using all substeps)</span></div>
<div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;<span class="comment"></span>  <span class="keywordflow">if</span>(doflux &amp;&amp; truestep){</div>
<div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;    <span class="comment">// must come after metric changes that can change where flux surface is since otherwise when flux surface changes, we won&#39;t track this substep&#39;s flux through the new surface but the old surface (which could even be at r=0 and have no flux)</span></div>
<div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;    <span class="comment">// if using unew, then since metric update above uses old unew, need present flux at new horizon surface</span></div>
<div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;<span class="preprocessor">#if(SPLITNPR)</span></div>
<div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;<span class="preprocessor"></span>    <span class="comment">// don&#39;t update metric if only doing B1-B3</span></div>
<div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../d8/d5b/defs_8general_8h.html#aa2010d23a21177641277f5119a2705c7">advancepassnumber</a>==-1 || <a class="code" href="../../d8/d5b/defs_8general_8h.html#aa2010d23a21177641277f5119a2705c7">advancepassnumber</a>==1)</div>
<div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;<span class="preprocessor"></span>      {</div>
<div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;<span class="preprocessor">#if(ACCURATEDIAG)</span></div>
<div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;<span class="preprocessor"></span>        diag_flux_pureflux(pb,F1, F2, F3, fluxdt); <span class="comment">// fluxdt is true dt for this flux as added in dUtoU() as part of ucum</span></div>
<div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;<span class="preprocessor"></span>      }</div>
<div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;  }</div>
<div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;</div>
<div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;</div>
<div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;  </div>
<div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;<span class="preprocessor">#if(PRODUCTION==0)</span></div>
<div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;<span class="preprocessor"></span>  trifprintf( <span class="stringliteral">&quot;#0s&quot;</span>);</div>
<div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;</div>
<div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;</div>
<div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;  <span class="comment">// Copy over tempucum -&gt; ucum per pl to account for staggered field</span></div>
<div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;<span class="comment"></span>  <span class="keywordflow">if</span>(finalstep &amp;&amp; <a class="code" href="../../d8/d5b/defs_8general_8h.html#a11c4e99e1493d0c1914ad1ab313ea472">FLUXB</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0b6762cef74e396f50a83864bb53fb6c">FLUXCTSTAG</a>){</div>
<div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;    <span class="comment">// copy over new ucum in only desired locations irrespective of where tempucum was updated</span></div>
<div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;    <span class="comment">// copy tempucum -&gt; ucum</span></div>
<div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;    copy_tempucum_finalucum(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac578a63f887dbc4797b555bd9c468a5f">DOALLPL</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#ab5c60dcb37b1f7e5642525031cd5cbcf">Uconsevolveloop</a>,tempucum,ucum); <span class="comment">// fill-in all pl&#39;s for storage and for next step.</span></div>
<div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;  }</div>
<div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;</div>
<div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;</div>
<div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;</div>
<div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;</div>
<div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;  <span class="comment">// If not fixing up primitives after inversion immediately, then fix up all zones at once afterwards</span></div>
<div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;<span class="preprocessor">#if(SPLITNPR)</span></div>
<div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;<span class="preprocessor"></span>  <span class="comment">// don&#39;t update metric if only doing B1-B3</span></div>
<div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../d8/d5b/defs_8general_8h.html#aa2010d23a21177641277f5119a2705c7">advancepassnumber</a>==-1 || <a class="code" href="../../d8/d5b/defs_8general_8h.html#aa2010d23a21177641277f5119a2705c7">advancepassnumber</a>==1)</div>
<div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;<span class="preprocessor"></span>    {</div>
<div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;<span class="preprocessor">#if(FIXUPZONES==FIXUPALLZONES)</span></div>
<div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;<span class="preprocessor"></span>      <span class="comment">//      fixup(stage,pf,useducum,finalstep); // GODMARK: if want to correct useducum, then have to be more careful like when doing fixup1zone()</span></div>
<div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;      fixup(stage,pf,utoinvert,finalstep);</div>
<div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;<span class="preprocessor">#endif  </span></div>
<div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;<span class="preprocessor"></span>    }</div>
<div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;</div>
<div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;</div>
<div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;</div>
<div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;  <span class="comment">// Determine next timestep from waves, fluxes, and source updates</span></div>
<div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;</div>
<div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;  prepare_globaldt(truestep,ndt1,ndt2,ndt3,accdt,accdti,accdtj,accdtk,gravitydt,gravitydti,gravitydtj,gravitydtk,ndt);</div>
<div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;</div>
<div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;</div>
<div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;</div>
<div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;<span class="preprocessor">#if(PRODUCTION==0)</span></div>
<div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;<span class="preprocessor"></span>  trifprintf( <span class="stringliteral">&quot;2f&quot;</span>);</div>
<div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;</div>
<div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;  <span class="keywordflow">return</span> (0);</div>
<div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;}</div>
<div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;</div>
<div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;</div>
<div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;</div>
<div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;</div>
<div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;</div>
<div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;</div>
<div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;</div>
<div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;</div>
<div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;</div>
<div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;</div>
<div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;<span class="keyword">static</span> <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> compute_dissmeasure(<span class="keywordtype">int</span> timeorder, <span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k, <span class="keywordtype">int</span> loc, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *q, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUf, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUnew, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*F1)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*F2)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*F3)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *ui,  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *uf, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *tempucum)</div>
<div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;{</div>
<div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dissmeasure;</div>
<div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;  <span class="keywordtype">int</span> pliter,pl;</div>
<div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;</div>
<div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#a3003c071224bcc99a325417b239ceb9a">DODISSMEASURE</a>==0) <span class="keywordflow">return</span>(-1.0);</div>
<div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;</div>
<div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>&gt;0){</div>
<div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dUgeomtemp[NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>];</div>
<div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> uitemp[NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>];</div>
<div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> uftemp[NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>];</div>
<div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> tempucumtemp[NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>];</div>
<div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;      dUgeomtemp[pl]=0.0; <span class="comment">// geometry not relevant for this calculation</span></div>
<div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;      uitemp[pl]=ui[pl];</div>
<div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;      uftemp[pl]=uf[pl];</div>
<div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;      tempucumtemp[pl]=tempucum[pl];</div>
<div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;    }</div>
<div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;    <span class="keywordtype">int</span> plsp;</div>
<div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;    <span class="keywordtype">int</span> specialfrom;</div>
<div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;    <span class="keywordtype">int</span> truenspecial=0;</div>
<div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;<span class="preprocessor">#if(NSPECIAL==6)</span></div>
<div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;<span class="preprocessor">#if(EOMRADTYPE!=EOMRADNONE)</span></div>
<div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;<span class="preprocessor"></span>    <span class="keywordtype">int</span> plspeciallist[<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>]={<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#aa6b3b8850078685640b8fc78914c598c" title="choose SPECIALPL">SPECIALPL1</a>,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ae4dba22c8a336b399468e524c4eec8ee">SPECIALPL2</a>,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a68da293cc434393a2800bf5c5c973684">SPECIALPL3</a>,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ada4c24301300c9c888eac23c4adc8620">SPECIALPL4</a>,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a266d9d6cf2072fb0929bd1068e7fb4c6">SPECIALPL5</a>,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#abc7dcf5445527ed1189d0f5cca014789">SPECIALPL6</a>};</div>
<div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;    truenspecial=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>;</div>
<div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;<span class="preprocessor"></span>    <span class="keywordtype">int</span> plspeciallist[<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>]={<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#aa6b3b8850078685640b8fc78914c598c" title="choose SPECIALPL">SPECIALPL1</a>,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ae4dba22c8a336b399468e524c4eec8ee">SPECIALPL2</a>,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a68da293cc434393a2800bf5c5c973684">SPECIALPL3</a>,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ada4c24301300c9c888eac23c4adc8620">SPECIALPL4</a>,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a266d9d6cf2072fb0929bd1068e7fb4c6">SPECIALPL5</a>};</div>
<div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;    truenspecial=5;</div>
<div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;<span class="preprocessor">#elif(NSPECIAL==2)</span></div>
<div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;<span class="preprocessor"></span>    <span class="keywordtype">int</span> plspeciallist[<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>]={<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#aa6b3b8850078685640b8fc78914c598c" title="choose SPECIALPL">SPECIALPL1</a>,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ae4dba22c8a336b399468e524c4eec8ee">SPECIALPL2</a>};</div>
<div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;    truenspecial=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>;</div>
<div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;<span class="preprocessor">#elif(NSPECIAL==1)</span></div>
<div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;<span class="preprocessor"></span>    <span class="keywordtype">int</span> plspeciallist[<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>]={<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#aa6b3b8850078685640b8fc78914c598c" title="choose SPECIALPL">SPECIALPL1</a>};</div>
<div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;    truenspecial=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>;</div>
<div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;<span class="preprocessor"></span>    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ace9028e160f1fa3ad7da85f9443f3127">PLOOPSPECIALONLY</a>(plsp,truenspecial){</div>
<div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;      specialfrom=plspeciallist[plsp-NPR];</div>
<div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;      dUgeomtemp[plsp]=0.0;</div>
<div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;      uitemp[plsp] = uitemp[specialfrom];</div>
<div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;      uftemp[plsp] = uftemp[specialfrom];</div>
<div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;      tempucumtemp[plsp] = tempucumtemp[specialfrom];</div>
<div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;    }</div>
<div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dUriemanntemp[NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>]={0},dUriemann1temp[NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>]={0},dUriemann2temp[NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>]={0},dUriemann3temp[NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>]={0};</div>
<div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;    <span class="comment">// get flux update for all NPR and NSEPCIAL quantities</span></div>
<div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;    flux2dUavg(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#aae0730ddcfcd4a1591362411a0cde82b">DOSPECIALPL</a>,i,j,k,F1,F2,F3,dUriemann1temp,dUriemann2temp,dUriemann3temp);</div>
<div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;    <span class="comment">// get dUriemann for NPR and truenspecial quantities</span></div>
<div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) dUriemanntemp[pl]=dUriemann1temp[pl]+dUriemann2temp[pl]+dUriemann3temp[pl];</div>
<div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ace9028e160f1fa3ad7da85f9443f3127">PLOOPSPECIALONLY</a>(plsp,truenspecial){</div>
<div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;      dUriemanntemp[plsp]=dUriemann1temp[plsp]+dUriemann2temp[plsp]+dUriemann3temp[plsp];</div>
<div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;    }</div>
<div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;    <span class="comment">// Get final U for NPR and NSPECIAL quantities</span></div>
<div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;    <span class="comment">//    FTYPE dUcomptemp[NUMSOURCES][NPR+NSPECIAL];</span></div>
<div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dUcomptemp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ac34589654a83c911addd1fda0898e738">NUMSOURCES</a>][NPR];</div>
<div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;    <span class="keywordtype">int</span> sc;</div>
<div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a2da8b12fca78064531b9b64e5699e4fc" title="loop over ALL sources (including geometry)">SCLOOP</a>(sc) dUcomptemp[sc][pl]=0.0;</div>
<div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;    <span class="comment">//    PLOOPSPECIALONLY(plsp,truenspecial){</span></div>
<div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;    <span class="comment">//      SCLOOP(sc) dUcomptemp[sc][plsp]=0.0;</span></div>
<div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;    <span class="comment">//    }</span></div>
<div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;    dUtoU(timeorder,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#aae0730ddcfcd4a1591362411a0cde82b">DOSPECIALPL</a>,i,j,k,loc,dUgeomtemp, dUcomptemp, dUriemanntemp, CUf, CUnew, uitemp, uftemp, tempucumtemp);</div>
<div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;</div>
<div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;</div>
<div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;</div>
<div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;    <span class="comment">// now get dissipation measure.  dissmeasure&lt;0.0 means dissipation occuring (e.g. in density field)</span></div>
<div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;<span class="comment"></span>    </div>
<div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;    <span class="comment">// First, get dUnondiss and dUdiss and norm</span></div>
<div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dUdissplusnondiss[NPR];</div>
<div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dUnondiss[NPR];</div>
<div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dUdiss[NPR];</div>
<div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dissmeasurepl[NPR];</div>
<div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> signdiss;</div>
<div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> norm[NPR];</div>
<div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ace9028e160f1fa3ad7da85f9443f3127">PLOOPSPECIALONLY</a>(plsp,truenspecial){</div>
<div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;      specialfrom=plspeciallist[plsp-NPR];</div>
<div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;      dUdissplusnondiss[specialfrom]=(uftemp[specialfrom] - uitemp[specialfrom]);</div>
<div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;      dUnondiss[specialfrom]=(uftemp[plsp] - uitemp[plsp]);</div>
<div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;      dUdiss[specialfrom]=dUdissplusnondiss[specialfrom] - dUnondiss[specialfrom];</div>
<div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;            </div>
<div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;      norm[specialfrom]=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a09c78d2f8feb311dd9fc969a0bf84979">SMALL</a>+(fabs(dUdiss[specialfrom])+fabs(dUnondiss[specialfrom]));</div>
<div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;    }</div>
<div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160;</div>
<div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160;    <span class="comment">// get actual norm that&#39;s over multiple components for the magentic field</span></div>
<div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> actualnorm[NPR];</div>
<div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ace9028e160f1fa3ad7da85f9443f3127">PLOOPSPECIALONLY</a>(plsp,truenspecial){</div>
<div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160;      specialfrom=plspeciallist[plsp-NPR];</div>
<div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160;      <span class="keywordflow">if</span>(specialfrom==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a> || specialfrom==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>){</div>
<div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;        actualnorm[specialfrom] = <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a09c78d2f8feb311dd9fc969a0bf84979">SMALL</a> + norm[specialfrom];</div>
<div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160;      }</div>
<div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span>(specialfrom==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a> || specialfrom==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a> || specialfrom==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>){</div>
<div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160;        <span class="comment">// for magnetic field, actualnorm is computed as:</span></div>
<div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;        <span class="comment">// |dUdiss(B1)|^2 |dUnondiss(B1)|^2 + |dUdiss(B2)|^2 + |dUnondiss(B2)|^2 + |dUdiss(B3)|^2 + |dUnondiss(B3)|^2 + |dUdiss(UU)| + |dUnondiss(UU)|</span></div>
<div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;        <span class="comment">// So we account for any magnetic energy change and help with normalization by also using total energy change</span></div>
<div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;        actualnorm[specialfrom]=0.0;</div>
<div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;        <span class="keywordtype">int</span> jj;</div>
<div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj){</div>
<div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;          pl=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>+jj-1;</div>
<div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;          actualnorm[specialfrom] += <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a09c78d2f8feb311dd9fc969a0bf84979">SMALL</a>+(fabs(dUdiss[pl]*dUdiss[pl])+fabs(dUnondiss[pl]*dUnondiss[pl]));</div>
<div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160;        }</div>
<div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;        actualnorm[specialfrom] += fabs(dUdiss[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]) + fabs(dUnondiss[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]); <span class="comment">// add energy as reference for normalization to avoid weak magnetic fields suggesting strong dissipation.  GODMARK: But, kinda risky, because nominally want to use energy to capture any field dissipation, not just when the field is important to total energy dissipation.</span></div>
<div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;        <span class="comment">//  But much better than (say) using total energy density as reference.  We  use actual energy dissipation as reference.  So if reconnection is at all important to total dissipation, it will be accounted for.  When total energy dissipation is dominated by non-reconnection, that missed dissipation is a small correction.</span></div>
<div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;        <span class="comment">// But, because total energy dissipation is less trustable due to average vs. point issue in general creating artificial heating or cooling, this is a bit less trustable as even a normalization.</span></div>
<div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;      }</div>
<div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span>(specialfrom==URAD0){</div>
<div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;        actualnorm[specialfrom] = <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a09c78d2f8feb311dd9fc969a0bf84979">SMALL</a> + norm[specialfrom];</div>
<div class="line"><a name="l01133"></a><span class="lineno"> 1133</span>&#160;      }</div>
<div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;    }</div>
<div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160;    </div>
<div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160;    <span class="comment">// compute dissmeasure for each quantity using actualnorm</span></div>
<div class="line"><a name="l01139"></a><span class="lineno"> 1139</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160;<span class="comment"></span>    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ace9028e160f1fa3ad7da85f9443f3127">PLOOPSPECIALONLY</a>(plsp,truenspecial){</div>
<div class="line"><a name="l01142"></a><span class="lineno"> 1142</span>&#160;      specialfrom=plspeciallist[plsp-NPR];</div>
<div class="line"><a name="l01143"></a><span class="lineno"> 1143</span>&#160;</div>
<div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160;      <span class="comment">// set sign in front of dissmeasure</span></div>
<div class="line"><a name="l01145"></a><span class="lineno"> 1145</span>&#160;      <span class="keywordflow">if</span>(specialfrom==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>) signdiss=+1.0; <span class="comment">// dUdiss&gt;0 means adding density due to dissipation (i.e. convergence, not divergence)</span></div>
<div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span>(specialfrom==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>) signdiss=-1.0; <span class="comment">// dUdiss&lt;0 means adding energy due to dissipation (i.e. dissipation)</span></div>
<div class="line"><a name="l01147"></a><span class="lineno"> 1147</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span>(specialfrom==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a> || specialfrom==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a> || specialfrom==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>) signdiss=-1.0; <span class="comment">// dUdiss&lt;0 means lost magentic energy due to dissipation (i.e. dissipation)</span></div>
<div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span>(specialfrom==URAD0) signdiss=-1.0; <span class="comment">// dUdiss&lt;0 means adding energy due to dissipation (i.e. dissipation)</span></div>
<div class="line"><a name="l01149"></a><span class="lineno"> 1149</span>&#160;</div>
<div class="line"><a name="l01150"></a><span class="lineno"> 1150</span>&#160;      <span class="comment">// get dissmeasure, which is normalized dUdiss with correct sign</span></div>
<div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160;      <span class="keywordflow">if</span>(specialfrom==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a> || specialfrom==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a> || specialfrom==URAD0){</div>
<div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160;        <span class="comment">// standard dUdiss/actualnorm</span></div>
<div class="line"><a name="l01153"></a><span class="lineno"> 1153</span>&#160;        dissmeasurepl[specialfrom] = -signdiss*(dUdiss[specialfrom])/actualnorm[specialfrom];</div>
<div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;      }</div>
<div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span>(specialfrom==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a> || specialfrom==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a> || specialfrom==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>){</div>
<div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160;        <span class="comment">// special use of square of dUdiss: dUdiss^2(B1,B2,B3)/actualnorm</span></div>
<div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160;        dissmeasurepl[specialfrom] = -signdiss*(<a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a1e471b644e7fd684cd5dbb144e00ee81">sign</a>(dUdiss[specialfrom])*dUdiss[specialfrom]*dUdiss[specialfrom])/actualnorm[specialfrom];</div>
<div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160;      }</div>
<div class="line"><a name="l01159"></a><span class="lineno"> 1159</span>&#160;</div>
<div class="line"><a name="l01160"></a><span class="lineno"> 1160</span>&#160;      <span class="comment">//      dualfprintf(fail_file,&quot;plsp=%d specialfrom=%d dissmeasurepl=%g\n&quot;,plsp,specialfrom,dissmeasurepl[specialfrom]);</span></div>
<div class="line"><a name="l01161"></a><span class="lineno"> 1161</span>&#160;</div>
<div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160;      <span class="comment">//    dualfprintf(fail_file,&quot;DISS (ijk=%d %d %d): (%d %d) ui=%g %g : uf=%g %g : dUdiss=%g dUnondiss=%g : dU1=%g %g : dU2=%g %g : dissmeasure=%g\n&quot;,i,j,k,specialfrom,plsp,uitemp[specialfrom],uitemp[plsp],uftemp[specialfrom],uftemp[plsp],dUdiss,dUnondiss,dUriemann1temp[specialfrom]*CUf[2]*dt,dUriemann1temp[plsp]*CUf[2]*dt,dUriemann2temp[specialfrom]*CUf[2]*dt,dUriemann2temp[plsp]*CUf[2]*dt,dissmeasure);</span></div>
<div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;</div>
<div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160;      <span class="comment">// DEBUG</span></div>
<div class="line"><a name="l01165"></a><span class="lineno"> 1165</span>&#160;      <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#a3003c071224bcc99a325417b239ceb9a">DODISSMEASURE</a>){</div>
<div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160;        GLOBALMACP0A1(dissmeasurearray,i,j,k,plsp-NPR)=dissmeasurepl[specialfrom];</div>
<div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;      }</div>
<div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160;</div>
<div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160;    }</div>
<div class="line"><a name="l01170"></a><span class="lineno"> 1170</span>&#160;</div>
<div class="line"><a name="l01172"></a><span class="lineno"> 1172</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01173"></a><span class="lineno"> 1173</span>&#160;    <span class="comment">// Choose which *total* dissipation measurement to use.  Must somehow combine different original equations of motion into a single measure since energy vs. entropy changes involve energy equation that combines both shocks and reconnection.</span></div>
<div class="line"><a name="l01174"></a><span class="lineno"> 1174</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01176"></a><span class="lineno"> 1176</span>&#160;<span class="comment"></span>    <span class="keywordflow">if</span>(truenspecial==1){</div>
<div class="line"><a name="l01177"></a><span class="lineno"> 1177</span>&#160;      dissmeasure=dissmeasurepl[<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#aa6b3b8850078685640b8fc78914c598c" title="choose SPECIALPL">SPECIALPL1</a>];</div>
<div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160;    }</div>
<div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160;    <span class="comment">// Can&#39;t trust energy, since average vs. point issue itself leads to erreoneous apparent dissipation (which when using energy equation alone is what leads to inappropriate heating in divergent flows, as well as inappropriate cooling in divergent flows, often in stripes in u_g due to sensitivity to higher-order interpolation schemes like PPM).</span></div>
<div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160;    <span class="comment">//          dissmeasure=dissmeasurepl[SPECIALPL2];</span></div>
<div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(truenspecial&gt;=5){</div>
<div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160;      <span class="comment">// can&#39;t trust energy, but density doesn&#39;t account for magnetic energy.  So use density for shocks and magnetic energy flux for reconnection.</span></div>
<div class="line"><a name="l01183"></a><span class="lineno"> 1183</span>&#160;      dissmeasure=dissmeasurepl[<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#aa6b3b8850078685640b8fc78914c598c" title="choose SPECIALPL">SPECIALPL1</a>];</div>
<div class="line"><a name="l01184"></a><span class="lineno"> 1184</span>&#160;</div>
<div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dissmeasurefield=dissmeasurepl[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7b21d6a6a4573b4997b1f04b01cd4efb">B1</a>];</div>
<div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160;      dissmeasurefield=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(dissmeasurefield,dissmeasurepl[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a>]);</div>
<div class="line"><a name="l01187"></a><span class="lineno"> 1187</span>&#160;      dissmeasurefield=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(dissmeasurefield,dissmeasurepl[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae6ac0edb1e2c9c7672ab9488d8b65be9">B3</a>]);</div>
<div class="line"><a name="l01188"></a><span class="lineno"> 1188</span>&#160;      </div>
<div class="line"><a name="l01189"></a><span class="lineno"> 1189</span>&#160;      <span class="comment">// add field dissipation measure, but only account if above machine error (i.e. relative to total energy as defined above)</span></div>
<div class="line"><a name="l01190"></a><span class="lineno"> 1190</span>&#160;      dissmeasure=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(dissmeasure,10.0*<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a8913cb5d64cfec23ae1a3052930ec468">NUMEPSILON</a>+dissmeasurefield);</div>
<div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;</div>
<div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160;      <span class="keywordflow">if</span>(truenspecial&gt;=6 &amp;&amp; <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#abc7dcf5445527ed1189d0f5cca014789">SPECIALPL6</a>&gt;=0){</div>
<div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;        <span class="comment">// add radiation pressure to total pressure if optically thick</span></div>
<div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160;        <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> tautot[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>],tautotmax;</div>
<div class="line"><a name="l01195"></a><span class="lineno"> 1195</span>&#160;        <a class="code" href="../../df/d21/global_8funcdeclare_8rad_8h.html#a5943065ab3d5b4e9f4f691db499b588f" title="calculates total opacity over dx[]">calc_tautot</a>(pr, ptrgeom, NULL, tautot, &amp;tautotmax); <span class="comment">// high accuracy not required</span></div>
<div class="line"><a name="l01196"></a><span class="lineno"> 1196</span>&#160;</div>
<div class="line"><a name="l01197"></a><span class="lineno"> 1197</span>&#160;        <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dissswitch=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(tautotmax/<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a6a13dd3e955c5141f0c100fd5821ee4d" title="KORALTODO SUPERGODMARK: Turn this on and rest all tests and see if makes worse or better...">TAUTOTMAXSWITCH</a>,1.0);</div>
<div class="line"><a name="l01198"></a><span class="lineno"> 1198</span>&#160;</div>
<div class="line"><a name="l01199"></a><span class="lineno"> 1199</span>&#160;        dissmeasure = <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(dissmeasure,dissmeasurepl[<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#abc7dcf5445527ed1189d0f5cca014789">SPECIALPL6</a>])*dissswitch + dissmeasure*(1.0-dissswitch);</div>
<div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160;      }</div>
<div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160;    }</div>
<div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160;</div>
<div class="line"><a name="l01203"></a><span class="lineno"> 1203</span>&#160;    <span class="keywordflow">if</span>(truenspecial&gt;0 &amp;&amp; <a class="code" href="../../da/d3e/definit_8h.html#a3003c071224bcc99a325417b239ceb9a">DODISSMEASURE</a>){</div>
<div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;      <span class="comment">// DEBUG</span></div>
<div class="line"><a name="l01205"></a><span class="lineno"> 1205</span>&#160;      GLOBALMACP0A1(dissmeasurearray,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>)=dissmeasure;</div>
<div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;    }</div>
<div class="line"><a name="l01207"></a><span class="lineno"> 1207</span>&#160;</div>
<div class="line"><a name="l01208"></a><span class="lineno"> 1208</span>&#160;</div>
<div class="line"><a name="l01209"></a><span class="lineno"> 1209</span>&#160;  }</div>
<div class="line"><a name="l01210"></a><span class="lineno"> 1210</span>&#160;</div>
<div class="line"><a name="l01211"></a><span class="lineno"> 1211</span>&#160;  dissmeasure=-1.0; <span class="comment">// force use of energy unless energy fails.</span></div>
<div class="line"><a name="l01212"></a><span class="lineno"> 1212</span>&#160;</div>
<div class="line"><a name="l01213"></a><span class="lineno"> 1213</span>&#160;  <span class="keywordflow">return</span>(dissmeasure);</div>
<div class="line"><a name="l01214"></a><span class="lineno"> 1214</span>&#160;}</div>
<div class="line"><a name="l01215"></a><span class="lineno"> 1215</span>&#160;</div>
<div class="line"><a name="l01216"></a><span class="lineno"> 1216</span>&#160;</div>
<div class="line"><a name="l01217"></a><span class="lineno"> 1217</span>&#160;</div>
<div class="line"><a name="l01218"></a><span class="lineno"> 1218</span>&#160;</div>
<div class="line"><a name="l01219"></a><span class="lineno"> 1219</span>&#160;</div>
<div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160;</div>
<div class="line"><a name="l01221"></a><span class="lineno"> 1221</span>&#160;</div>
<div class="line"><a name="l01222"></a><span class="lineno"> 1222</span>&#160;</div>
<div class="line"><a name="l01223"></a><span class="lineno"> 1223</span>&#160;</div>
<div class="line"><a name="l01224"></a><span class="lineno"> 1224</span>&#160;</div>
<div class="line"><a name="l01225"></a><span class="lineno"> 1225</span>&#160;</div>
<div class="line"><a name="l01226"></a><span class="lineno"> 1226</span>&#160;</div>
<div class="line"><a name="l01227"></a><span class="lineno"> 1227</span>&#160;</div>
<div class="line"><a name="l01228"></a><span class="lineno"> 1228</span>&#160;</div>
<div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160;</div>
<div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160;</div>
<div class="line"><a name="l01231"></a><span class="lineno"> 1231</span>&#160;</div>
<div class="line"><a name="l01235"></a><span class="lineno"><a class="code" href="../../df/d22/advance_8c.html#a38c6fa95ece38a2821c70a1524ec47ec"> 1235</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d22/advance_8c.html#a38c6fa95ece38a2821c70a1524ec47ec" title="this method guarantees conservation of non-sourced conserved quantities when metric is time-dependent...">advance_standard_orig</a>(</div>
<div class="line"><a name="l01236"></a><span class="lineno"> 1236</span>&#160;                            <span class="keywordtype">int</span> truestep,</div>
<div class="line"><a name="l01237"></a><span class="lineno"> 1237</span>&#160;                            <span class="keywordtype">int</span> stage,</div>
<div class="line"><a name="l01238"></a><span class="lineno"> 1238</span>&#160;                            <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pi)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR],</div>
<div class="line"><a name="l01239"></a><span class="lineno"> 1239</span>&#160;                            <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pb)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR],</div>
<div class="line"><a name="l01240"></a><span class="lineno"> 1240</span>&#160;                            <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pf)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR],</div>
<div class="line"><a name="l01241"></a><span class="lineno"> 1241</span>&#160;                            <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pstag)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR],</div>
<div class="line"><a name="l01242"></a><span class="lineno"> 1242</span>&#160;                            <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pl_ct)[<a class="code" href="../../df/d1c/global_8storage_8h.html#a917a6677d5e3b38aa54aa577978bf823" title="123">NSTORE1</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR2INTERP], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pr_ct)[<a class="code" href="../../df/d1c/global_8storage_8h.html#a917a6677d5e3b38aa54aa577978bf823" title="123">NSTORE1</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR2INTERP],</div>
<div class="line"><a name="l01243"></a><span class="lineno"> 1243</span>&#160;                            <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*F1)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*F2)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*F3)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>],</div>
<div class="line"><a name="l01244"></a><span class="lineno"> 1244</span>&#160;                            <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*vpot)[<a class="code" href="../../df/d1c/global_8storage_8h.html#a917a6677d5e3b38aa54aa577978bf823" title="123">NSTORE1</a>+<a class="code" href="../../df/d1c/global_8storage_8h.html#a1c452bce7a227fd9f2c8f937a3c7841c">SHIFTSTORE1</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>+<a class="code" href="../../df/d1c/global_8storage_8h.html#adfe8c351b7f60e189dbd9bfca47af5c5">SHIFTSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>+<a class="code" href="../../df/d1c/global_8storage_8h.html#a6dc540b0373d80d3ea2db53d03a9fa72">SHIFTSTORE3</a>],</div>
<div class="line"><a name="l01245"></a><span class="lineno"> 1245</span>&#160;                            <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*ui)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR],</div>
<div class="line"><a name="l01246"></a><span class="lineno"> 1246</span>&#160;                            <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*uf)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR],</div>
<div class="line"><a name="l01247"></a><span class="lineno"> 1247</span>&#160;                            <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*ucum)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR], </div>
<div class="line"><a name="l01248"></a><span class="lineno"> 1248</span>&#160;                            <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUf, </div>
<div class="line"><a name="l01249"></a><span class="lineno"> 1249</span>&#160;                            <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUnew, </div>
<div class="line"><a name="l01250"></a><span class="lineno"> 1250</span>&#160;                            <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a0263684ebff8e72a2f0de1861393595f">SFTYPE</a> fluxdt,</div>
<div class="line"><a name="l01251"></a><span class="lineno"> 1251</span>&#160;                            <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a0263684ebff8e72a2f0de1861393595f">SFTYPE</a> boundtime,</div>
<div class="line"><a name="l01252"></a><span class="lineno"> 1252</span>&#160;                            <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a0263684ebff8e72a2f0de1861393595f">SFTYPE</a> fluxtime,</div>
<div class="line"><a name="l01253"></a><span class="lineno"> 1253</span>&#160;                            <span class="keywordtype">int</span> timeorder, <span class="keywordtype">int</span> numtimeorders,</div>
<div class="line"><a name="l01254"></a><span class="lineno"> 1254</span>&#160;                            <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *ndt)</div>
<div class="line"><a name="l01255"></a><span class="lineno"> 1255</span>&#160;{</div>
<div class="line"><a name="l01256"></a><span class="lineno"> 1256</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ndt1, ndt2, ndt3;</div>
<div class="line"><a name="l01257"></a><span class="lineno"> 1257</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dUtot;</div>
<div class="line"><a name="l01258"></a><span class="lineno"> 1258</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> idx1,idx2;</div>
<div class="line"><a name="l01259"></a><span class="lineno"> 1259</span>&#160;  <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a0263684ebff8e72a2f0de1861393595f">SFTYPE</a> dt4diag;</div>
<div class="line"><a name="l01260"></a><span class="lineno"> 1260</span>&#160;  <span class="keyword">static</span> <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a0263684ebff8e72a2f0de1861393595f">SFTYPE</a> dt4diag_willbe=0;</div>
<div class="line"><a name="l01261"></a><span class="lineno"> 1261</span>&#160;  <span class="keywordtype">int</span> finalstep,initialstep;</div>
<div class="line"><a name="l01262"></a><span class="lineno"> 1262</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> accdt, accdt_ij;</div>
<div class="line"><a name="l01263"></a><span class="lineno"> 1263</span>&#160;  <span class="keywordtype">int</span> accdti,accdtj,accdtk;</div>
<div class="line"><a name="l01264"></a><span class="lineno"> 1264</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gravitydt, gravitydt_ij;</div>
<div class="line"><a name="l01265"></a><span class="lineno"> 1265</span>&#160;  <span class="keywordtype">int</span> gravitydti,gravitydtj,gravitydtk;</div>
<div class="line"><a name="l01266"></a><span class="lineno"> 1266</span>&#160;  <span class="comment">//  FTYPE (*dUriemannarray)[NSTORE2][NSTORE3][NPR];</span></div>
<div class="line"><a name="l01267"></a><span class="lineno"> 1267</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*ucumformetric)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR];</div>
<div class="line"><a name="l01268"></a><span class="lineno"> 1268</span>&#160;  <span class="keywordtype">int</span> enerregion;</div>
<div class="line"><a name="l01269"></a><span class="lineno"> 1269</span>&#160;  <span class="keywordtype">int</span> *localenerpos;</div>
<div class="line"><a name="l01270"></a><span class="lineno"> 1270</span>&#160;  <span class="keywordtype">int</span> jj;</div>
<div class="line"><a name="l01271"></a><span class="lineno"> 1271</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*utoinvert)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR];</div>
<div class="line"><a name="l01272"></a><span class="lineno"> 1272</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*tempucum)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR];</div>
<div class="line"><a name="l01273"></a><span class="lineno"> 1273</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*useducum)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR];</div>
<div class="line"><a name="l01274"></a><span class="lineno"> 1274</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*myupoint)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR];</div>
<div class="line"><a name="l01275"></a><span class="lineno"> 1275</span>&#160;  <span class="keywordtype">int</span> whichpltoavg[NPR];</div>
<div class="line"><a name="l01276"></a><span class="lineno"> 1276</span>&#160;  <span class="keywordtype">int</span> ifnotavgthencopy[NPR];</div>
<div class="line"><a name="l01277"></a><span class="lineno"> 1277</span>&#160;  <span class="keywordtype">int</span> is,ie,js,je,ks,ke;</div>
<div class="line"><a name="l01278"></a><span class="lineno"> 1278</span>&#160;  <span class="keywordtype">int</span> doingextrashiftforstag;</div>
<div class="line"><a name="l01279"></a><span class="lineno"> 1279</span>&#160;</div>
<div class="line"><a name="l01280"></a><span class="lineno"> 1280</span>&#160;</div>
<div class="line"><a name="l01281"></a><span class="lineno"> 1281</span>&#160;</div>
<div class="line"><a name="l01282"></a><span class="lineno"> 1282</span>&#160;</div>
<div class="line"><a name="l01283"></a><span class="lineno"> 1283</span>&#160;</div>
<div class="line"><a name="l01284"></a><span class="lineno"> 1284</span>&#160;</div>
<div class="line"><a name="l01285"></a><span class="lineno"> 1285</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a11c4e99e1493d0c1914ad1ab313ea472">FLUXB</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0b6762cef74e396f50a83864bb53fb6c">FLUXCTSTAG</a>){</div>
<div class="line"><a name="l01286"></a><span class="lineno"> 1286</span>&#160;    <span class="comment">// fill in tempucum with changes that are not controlled well in space, but later fill in ucum from this in controlled way</span></div>
<div class="line"><a name="l01287"></a><span class="lineno"> 1287</span>&#160;    tempucum=<a class="code" href="../../df/d1c/global_8storage_8h.html#ad89dafa5d772b862a44b0f576983ead3" title="shifted pointer (a_s_) wrappers Couldn&#39;t figure out how to macrofy a_s_ or a_, so when changing have ...">GLOBALPOINT</a>(utemparray);</div>
<div class="line"><a name="l01288"></a><span class="lineno"> 1288</span>&#160;    useducum=tempucum; <span class="comment">// unless changed</span></div>
<div class="line"><a name="l01289"></a><span class="lineno"> 1289</span>&#160;  }</div>
<div class="line"><a name="l01290"></a><span class="lineno"> 1290</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l01291"></a><span class="lineno"> 1291</span>&#160;    <span class="comment">// no special shifting of indices occurs that requires loop shifting</span></div>
<div class="line"><a name="l01292"></a><span class="lineno"> 1292</span>&#160;    tempucum=ucum;</div>
<div class="line"><a name="l01293"></a><span class="lineno"> 1293</span>&#160;    useducum=ucum;</div>
<div class="line"><a name="l01294"></a><span class="lineno"> 1294</span>&#160;  }</div>
<div class="line"><a name="l01295"></a><span class="lineno"> 1295</span>&#160;</div>
<div class="line"><a name="l01296"></a><span class="lineno"> 1296</span>&#160;</div>
<div class="line"><a name="l01297"></a><span class="lineno"> 1297</span>&#160;  ucumformetric=<a class="code" href="../../df/d1c/global_8storage_8h.html#ad89dafa5d772b862a44b0f576983ead3" title="shifted pointer (a_s_) wrappers Couldn&#39;t figure out how to macrofy a_s_ or a_, so when changing have ...">GLOBALPOINT</a>(ucumformetric);<span class="comment">// temporary space for ucum for metric that is same time as &quot;pb&quot;, so not updated yet or is ui</span></div>
<div class="line"><a name="l01298"></a><span class="lineno"> 1298</span>&#160;</div>
<div class="line"><a name="l01299"></a><span class="lineno"> 1299</span>&#160;</div>
<div class="line"><a name="l01300"></a><span class="lineno"> 1300</span>&#160;</div>
<div class="line"><a name="l01302"></a><span class="lineno"> 1302</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01303"></a><span class="lineno"> 1303</span>&#160;  <span class="comment">// Setup function tasks</span></div>
<div class="line"><a name="l01304"></a><span class="lineno"> 1304</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01306"></a><span class="lineno"> 1306</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01307"></a><span class="lineno"> 1307</span>&#160;</div>
<div class="line"><a name="l01308"></a><span class="lineno"> 1308</span>&#160;  <span class="comment">// for ZLOOP:</span></div>
<div class="line"><a name="l01309"></a><span class="lineno"> 1309</span>&#160;  <span class="comment">// avoid looping over region outside active+ghost grid</span></div>
<div class="line"><a name="l01310"></a><span class="lineno"> 1310</span>&#160;  <span class="comment">// good because somewhat general and avoid bad inversions, etc.</span></div>
<div class="line"><a name="l01311"></a><span class="lineno"> 1311</span>&#160;  enerregion=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ada79b005f9c0caf71f9365c1e16d8c80">TRUEGLOBALWITHBNDENERREGION</a>;</div>
<div class="line"><a name="l01312"></a><span class="lineno"> 1312</span>&#160;  localenerpos=<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad41a84c69f5ec4a51492e96b4dc61ac4">enerposreg</a>[enerregion];</div>
<div class="line"><a name="l01313"></a><span class="lineno"> 1313</span>&#160;</div>
<div class="line"><a name="l01314"></a><span class="lineno"> 1314</span>&#160;</div>
<div class="line"><a name="l01315"></a><span class="lineno"> 1315</span>&#160;  accdt=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>; <span class="comment">// initially no limit to dt due to acceleration</span></div>
<div class="line"><a name="l01316"></a><span class="lineno"> 1316</span>&#160;  accdti=accdtj=accdtk=-100;</div>
<div class="line"><a name="l01317"></a><span class="lineno"> 1317</span>&#160;  gravitydt=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>; <span class="comment">// initially no limit to dt due to time derivatives in gravity</span></div>
<div class="line"><a name="l01318"></a><span class="lineno"> 1318</span>&#160;  gravitydti=gravitydtj=gravitydtk=-100;</div>
<div class="line"><a name="l01319"></a><span class="lineno"> 1319</span>&#160;</div>
<div class="line"><a name="l01320"></a><span class="lineno"> 1320</span>&#160;</div>
<div class="line"><a name="l01321"></a><span class="lineno"> 1321</span>&#160;</div>
<div class="line"><a name="l01322"></a><span class="lineno"> 1322</span>&#160;</div>
<div class="line"><a name="l01323"></a><span class="lineno"> 1323</span>&#160;<span class="preprocessor">#if(ASYMDIAGCHECK)</span></div>
<div class="line"><a name="l01324"></a><span class="lineno"> 1324</span>&#160;<span class="preprocessor"></span>  dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;BEGINNING steppart=%d nstep=%ld\n&quot;</span>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a70170b90229f9fc05eebf8508a685c70">steppart</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a1a1088d87617078680f1fd0f0d707384">nstep</a>);</div>
<div class="line"><a name="l01325"></a><span class="lineno"> 1325</span>&#160;</div>
<div class="line"><a name="l01326"></a><span class="lineno"> 1326</span>&#160;  dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;pi in advance\n&quot;</span>);</div>
<div class="line"><a name="l01327"></a><span class="lineno"> 1327</span>&#160;  asym_compute_1(pi);</div>
<div class="line"><a name="l01328"></a><span class="lineno"> 1328</span>&#160;</div>
<div class="line"><a name="l01329"></a><span class="lineno"> 1329</span>&#160;  dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;pb in advance\n&quot;</span>);</div>
<div class="line"><a name="l01330"></a><span class="lineno"> 1330</span>&#160;  asym_compute_1(pb);</div>
<div class="line"><a name="l01331"></a><span class="lineno"> 1331</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01332"></a><span class="lineno"> 1332</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01334"></a><span class="lineno"> 1334</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01335"></a><span class="lineno"> 1335</span>&#160;  <span class="comment">// set initialstep and finalstep to tell some procedures and diagnostic functions if should be accounting or not</span></div>
<div class="line"><a name="l01336"></a><span class="lineno"> 1336</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01338"></a><span class="lineno"> 1338</span>&#160;<span class="comment"></span>  <span class="keywordflow">if</span>(timeorder==0){</div>
<div class="line"><a name="l01339"></a><span class="lineno"> 1339</span>&#160;    initialstep=1;</div>
<div class="line"><a name="l01340"></a><span class="lineno"> 1340</span>&#160;  }</div>
<div class="line"><a name="l01341"></a><span class="lineno"> 1341</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l01342"></a><span class="lineno"> 1342</span>&#160;    initialstep=0;</div>
<div class="line"><a name="l01343"></a><span class="lineno"> 1343</span>&#160;  }</div>
<div class="line"><a name="l01344"></a><span class="lineno"> 1344</span>&#160;</div>
<div class="line"><a name="l01345"></a><span class="lineno"> 1345</span>&#160;  <span class="keywordflow">if</span>(timeorder==numtimeorders-1){</div>
<div class="line"><a name="l01346"></a><span class="lineno"> 1346</span>&#160;    finalstep=1;</div>
<div class="line"><a name="l01347"></a><span class="lineno"> 1347</span>&#160;  }</div>
<div class="line"><a name="l01348"></a><span class="lineno"> 1348</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l01349"></a><span class="lineno"> 1349</span>&#160;    finalstep=0;</div>
<div class="line"><a name="l01350"></a><span class="lineno"> 1350</span>&#160;  }</div>
<div class="line"><a name="l01351"></a><span class="lineno"> 1351</span>&#160;</div>
<div class="line"><a name="l01353"></a><span class="lineno"> 1353</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01354"></a><span class="lineno"> 1354</span>&#160;  <span class="comment">// whether need to compute flux</span></div>
<div class="line"><a name="l01355"></a><span class="lineno"> 1355</span>&#160;  <span class="comment">// only compute flux if flux is added to get Uf or Ucum</span></div>
<div class="line"><a name="l01357"></a><span class="lineno"> 1357</span>&#160;<span class="comment"></span>  <span class="keywordtype">int</span> <a class="code" href="../../d8/d5b/defs_8general_8h.html#a03344fc1457035406713e8d85d215576" title="used for each region, related to global quantities _tot quantities here are global since used in rest...">doflux</a> = (CUf[2]!=0.0 || CUnew[1]!=0.0);</div>
<div class="line"><a name="l01358"></a><span class="lineno"> 1358</span>&#160;  <span class="comment">// current implicit dt factor</span></div>
<div class="line"><a name="l01359"></a><span class="lineno"> 1359</span>&#160;  <span class="comment">// Since we don&#39;t pass CUnew[NUMPREDTCUFS+timeorder], we assume never try to add M^i into U^{n+1} unless computed for current U^i or previous U^i</span></div>
<div class="line"><a name="l01360"></a><span class="lineno"> 1360</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUimp=&amp;CUf[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a214c8d806784f513292419871af16a25">NUMPREDTCUFS</a>+timeorder];</div>
<div class="line"><a name="l01361"></a><span class="lineno"> 1361</span>&#160;</div>
<div class="line"><a name="l01362"></a><span class="lineno"> 1362</span>&#160;</div>
<div class="line"><a name="l01363"></a><span class="lineno"> 1363</span>&#160;</div>
<div class="line"><a name="l01365"></a><span class="lineno"> 1365</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01366"></a><span class="lineno"> 1366</span>&#160;  <span class="comment">// set dt4diag for source diagnostics</span></div>
<div class="line"><a name="l01367"></a><span class="lineno"> 1367</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01369"></a><span class="lineno"> 1369</span>&#160;<span class="comment"></span>  <span class="keywordflow">if</span>(timeorder==numtimeorders-1 &amp;&amp; (<a class="code" href="../../d8/d5b/defs_8general_8h.html#a1a1088d87617078680f1fd0f0d707384">nstep</a>%<a class="code" href="../../da/d3e/definit_8h.html#a397b655d0a3bd70f6d2c007c3a9d7ebe">DIAGSOURCECOMPSTEP</a>==0) ){</div>
<div class="line"><a name="l01370"></a><span class="lineno"> 1370</span>&#160;    <span class="comment">// every 4 full steps as well as on final step of full step (otherwise diag_source_comp() too expensive)</span></div>
<div class="line"><a name="l01371"></a><span class="lineno"> 1371</span>&#160;    dt4diag=dt4diag_willbe;</div>
<div class="line"><a name="l01372"></a><span class="lineno"> 1372</span>&#160;    dt4diag_willbe=0;</div>
<div class="line"><a name="l01373"></a><span class="lineno"> 1373</span>&#160;  }</div>
<div class="line"><a name="l01374"></a><span class="lineno"> 1374</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l01375"></a><span class="lineno"> 1375</span>&#160;    dt4diag_willbe+=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a56db625f31229c5e8b208ff27d464931">dt</a>;</div>
<div class="line"><a name="l01376"></a><span class="lineno"> 1376</span>&#160;    dt4diag=-1.0;</div>
<div class="line"><a name="l01377"></a><span class="lineno"> 1377</span>&#160;  }</div>
<div class="line"><a name="l01378"></a><span class="lineno"> 1378</span>&#160;</div>
<div class="line"><a name="l01379"></a><span class="lineno"> 1379</span>&#160;</div>
<div class="line"><a name="l01380"></a><span class="lineno"> 1380</span>&#160;</div>
<div class="line"><a name="l01382"></a><span class="lineno"> 1382</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01383"></a><span class="lineno"> 1383</span>&#160;  <span class="comment">// Setup loops [+1 extra compared to normal comp region if doing FLUXCTSTAG]</span></div>
<div class="line"><a name="l01384"></a><span class="lineno"> 1384</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01386"></a><span class="lineno"> 1386</span>&#160;<span class="comment"></span>  get_flux_startendindices(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ab5c60dcb37b1f7e5642525031cd5cbcf">Uconsevolveloop</a>,&amp;is,&amp;ie,&amp;js,&amp;je,&amp;ks,&amp;ke);</div>
<div class="line"><a name="l01387"></a><span class="lineno"> 1387</span>&#160;</div>
<div class="line"><a name="l01388"></a><span class="lineno"> 1388</span>&#160;</div>
<div class="line"><a name="l01389"></a><span class="lineno"> 1389</span>&#160;</div>
<div class="line"><a name="l01391"></a><span class="lineno"> 1391</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01392"></a><span class="lineno"> 1392</span>&#160;  <span class="comment">// Set initial ui, temporary space, so ok that COMPZLOOP() goes over +1 in FLUXB==FLUXCTSTAG case</span></div>
<div class="line"><a name="l01393"></a><span class="lineno"> 1393</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01395"></a><span class="lineno"> 1395</span>&#160;<span class="comment"></span>  <span class="keywordflow">if</span>(timeorder==0){</div>
<div class="line"><a name="l01396"></a><span class="lineno"> 1396</span>&#160;    <span class="comment">// last timestep&#39;s final ucum is stored into ucumformetric and ui as initial term in ucum</span></div>
<div class="line"><a name="l01397"></a><span class="lineno"> 1397</span>&#160;    <span class="comment">// copy ucum -&gt; {ucumformetric,ui}</span></div>
<div class="line"><a name="l01398"></a><span class="lineno"> 1398</span>&#160;    <span class="keywordflow">if</span>(doingmetricsubstep()) copy_3dnpr_2ptrs(is,ie,js,je,ks,ke,ucum,ucumformetric,ui);</div>
<div class="line"><a name="l01399"></a><span class="lineno"> 1399</span>&#160;    <span class="keywordflow">else</span> copy_3dnpr(is,ie,js,je,ks,ke,ucum,ui); <span class="comment">// only need to setup ui then</span></div>
<div class="line"><a name="l01400"></a><span class="lineno"> 1400</span>&#160;  }</div>
<div class="line"><a name="l01401"></a><span class="lineno"> 1401</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l01402"></a><span class="lineno"> 1402</span>&#160;    <span class="comment">// preserve this time&#39;s value of ucum for the metric (for timeorder==0 ucumformetric is assigned from ui)</span></div>
<div class="line"><a name="l01403"></a><span class="lineno"> 1403</span>&#160;    <span class="comment">// copy ucum -&gt; ucumformetric</span></div>
<div class="line"><a name="l01404"></a><span class="lineno"> 1404</span>&#160;    <span class="keywordflow">if</span>(doingmetricsubstep()) copy_3dnpr(is,ie,js,je,ks,ke,ucum,ucumformetric);</div>
<div class="line"><a name="l01405"></a><span class="lineno"> 1405</span>&#160;  }</div>
<div class="line"><a name="l01406"></a><span class="lineno"> 1406</span>&#160;</div>
<div class="line"><a name="l01407"></a><span class="lineno"> 1407</span>&#160;</div>
<div class="line"><a name="l01409"></a><span class="lineno"> 1409</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01410"></a><span class="lineno"> 1410</span>&#160;  <span class="comment">// Compute flux</span></div>
<div class="line"><a name="l01411"></a><span class="lineno"> 1411</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01413"></a><span class="lineno"> 1413</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01414"></a><span class="lineno"> 1414</span>&#160;<span class="preprocessor">#if(PRODUCTION==0)</span></div>
<div class="line"><a name="l01415"></a><span class="lineno"> 1415</span>&#160;<span class="preprocessor"></span>  trifprintf( <span class="stringliteral">&quot;#0f&quot;</span>);</div>
<div class="line"><a name="l01416"></a><span class="lineno"> 1416</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01417"></a><span class="lineno"> 1417</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01418"></a><span class="lineno"> 1418</span>&#160;</div>
<div class="line"><a name="l01419"></a><span class="lineno"> 1419</span>&#160;</div>
<div class="line"><a name="l01420"></a><span class="lineno"> 1420</span>&#160;</div>
<div class="line"><a name="l01421"></a><span class="lineno"> 1421</span>&#160;  ndt1=ndt2=ndt3=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>;</div>
<div class="line"><a name="l01422"></a><span class="lineno"> 1422</span>&#160;  <span class="keywordflow">if</span>(doflux &amp;&amp; truestep){ <span class="comment">// only do if not just passing through</span></div>
<div class="line"><a name="l01423"></a><span class="lineno"> 1423</span>&#160;</div>
<div class="line"><a name="l01424"></a><span class="lineno"> 1424</span>&#160;    <span class="keywordflow">if</span>(1){</div>
<div class="line"><a name="l01425"></a><span class="lineno"> 1425</span>&#160;      <span class="comment">// NORMAL:</span></div>
<div class="line"><a name="l01426"></a><span class="lineno"> 1426</span>&#160;      <span class="comment">// pb used here on a stencil, so if pb=pf or pb=pi in pointers, shouldn&#39;t change pi or pf yet -- don&#39;t currently</span></div>
<div class="line"><a name="l01427"></a><span class="lineno"> 1427</span>&#160;      <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(<a class="code" href="../../dc/dae/flux_8c.html#ab229b0f3f2caf3c0a3ef5299fba2b1c0" title="see fluxcompute.c for non-computer science, real physics calculations of flux">fluxcalc</a>(stage,initialstep,finalstep,pb,pstag,pl_ct, pr_ct, vpot,F1,F2,F3,CUf,CUnew,fluxdt,fluxtime,&amp;ndt1,&amp;ndt2,&amp;ndt3),<span class="stringliteral">&quot;advance.c:advance_standard_orig()&quot;</span>, <span class="stringliteral">&quot;fluxcalcall&quot;</span>, 1);</div>
<div class="line"><a name="l01428"></a><span class="lineno"> 1428</span>&#160;    }</div>
<div class="line"><a name="l01429"></a><span class="lineno"> 1429</span>&#160;</div>
<div class="line"><a name="l01430"></a><span class="lineno"> 1430</span>&#160;  </div>
<div class="line"><a name="l01431"></a><span class="lineno"> 1431</span>&#160;<span class="preprocessor">#if(0)// DEBUG:</span></div>
<div class="line"><a name="l01432"></a><span class="lineno"> 1432</span>&#160;<span class="preprocessor"></span>    <span class="keywordflow">if</span>(1){</div>
<div class="line"><a name="l01433"></a><span class="lineno"> 1433</span>&#160;      ndt1donor=ndt2donor=ndt3donor=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>;</div>
<div class="line"><a name="l01434"></a><span class="lineno"> 1434</span>&#160;      <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(<a class="code" href="../../dc/dae/flux_8c.html#aa26f8747446e1cd5bd214ebc345aafa2" title="compute donor-based flux, bypassing normal fluxcalc().">fluxcalc_donor</a>(stage,pb,pstag,pl_ct, pr_ct, vpot,<a class="code" href="../../df/d1c/global_8storage_8h.html#ad89dafa5d772b862a44b0f576983ead3" title="shifted pointer (a_s_) wrappers Couldn&#39;t figure out how to macrofy a_s_ or a_, so when changing have ...">GLOBALPOINT</a>(F1EM),<a class="code" href="../../df/d1c/global_8storage_8h.html#ad89dafa5d772b862a44b0f576983ead3" title="shifted pointer (a_s_) wrappers Couldn&#39;t figure out how to macrofy a_s_ or a_, so when changing have ...">GLOBALPOINT</a>(F2EM),<a class="code" href="../../df/d1c/global_8storage_8h.html#ad89dafa5d772b862a44b0f576983ead3" title="shifted pointer (a_s_) wrappers Couldn&#39;t figure out how to macrofy a_s_ or a_, so when changing have ...">GLOBALPOINT</a>(F3EM),CUf,CUnew,fluxdt,fluxtime,&amp;ndt1donor,&amp;ndt2donor,&amp;ndt3donor),<span class="stringliteral">&quot;advance.c:advance_standard_orig()&quot;</span>, <span class="stringliteral">&quot;fluxcalcall&quot;</span>, 1);</div>
<div class="line"><a name="l01435"></a><span class="lineno"> 1435</span>&#160;    }</div>
<div class="line"><a name="l01436"></a><span class="lineno"> 1436</span>&#160;    <span class="comment">// DEBUG:</span></div>
<div class="line"><a name="l01437"></a><span class="lineno"> 1437</span>&#160;    <span class="keywordflow">if</span>(1){</div>
<div class="line"><a name="l01438"></a><span class="lineno"> 1438</span>&#160;      <span class="keywordtype">int</span> <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>,<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>,k,pl,pliter;</div>
<div class="line"><a name="l01439"></a><span class="lineno"> 1439</span>&#160;      <a class="code" href="../../da/db2/global_8loops_8manypoints_8h.html#a615c1d48363ecaa0866f1c0fd337b780">FULLLOOP</a>{</div>
<div class="line"><a name="l01440"></a><span class="lineno"> 1440</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l01441"></a><span class="lineno"> 1441</span>&#160;          <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#abd7b39be02bc15d79b73e5cf2b531299" title="#define CORNGDETVERSION 0">N1</a>&gt;1) <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F1,i,j,k,pl)=GLOBALMACP0A1(F1EM,i,j,k,pl);</div>
<div class="line"><a name="l01442"></a><span class="lineno"> 1442</span>&#160;          <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#acd864640121c7df2c19f61f7baa507e4">N2</a>&gt;1) <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F2,i,j,k,pl)=GLOBALMACP0A1(F2EM,i,j,k,pl);</div>
<div class="line"><a name="l01443"></a><span class="lineno"> 1443</span>&#160;          <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#ad66109fbdc4d3adc9c3d6ff917038aef">N3</a>&gt;1) <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F3,i,j,k,pl)=GLOBALMACP0A1(F3EM,i,j,k,pl);</div>
<div class="line"><a name="l01444"></a><span class="lineno"> 1444</span>&#160;        }</div>
<div class="line"><a name="l01445"></a><span class="lineno"> 1445</span>&#160;      }</div>
<div class="line"><a name="l01446"></a><span class="lineno"> 1446</span>&#160;      ndt1=ndt1donor;</div>
<div class="line"><a name="l01447"></a><span class="lineno"> 1447</span>&#160;      ndt2=ndt2donor;</div>
<div class="line"><a name="l01448"></a><span class="lineno"> 1448</span>&#160;      ndt3=ndt3donor;</div>
<div class="line"><a name="l01449"></a><span class="lineno"> 1449</span>&#160;    }</div>
<div class="line"><a name="l01450"></a><span class="lineno"> 1450</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01451"></a><span class="lineno"> 1451</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01452"></a><span class="lineno"> 1452</span>&#160;</div>
<div class="line"><a name="l01453"></a><span class="lineno"> 1453</span>&#160;<span class="preprocessor">#if(0)// DEBUG:</span></div>
<div class="line"><a name="l01454"></a><span class="lineno"> 1454</span>&#160;<span class="preprocessor"></span>    <span class="keywordflow">if</span>(1){</div>
<div class="line"><a name="l01455"></a><span class="lineno"> 1455</span>&#160;      <span class="keywordtype">int</span> <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>,<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>,k,pliter,pl;</div>
<div class="line"><a name="l01456"></a><span class="lineno"> 1456</span>&#160;      dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,                 <span class="stringliteral">&quot;BADLOOPCOMPARE: nstep=%ld steppart=%d\n&quot;</span>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a1a1088d87617078680f1fd0f0d707384">nstep</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a70170b90229f9fc05eebf8508a685c70">steppart</a>);</div>
<div class="line"><a name="l01457"></a><span class="lineno"> 1457</span>&#160;      dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,                 <span class="stringliteral">&quot;ndt1orig=%21.15g ndt1new=%21.15g ndt2orig=%21.15g ndt2new=%21.15g\n&quot;</span>,ndt1,ndt1donor,ndt2,ndt2donor);</div>
<div class="line"><a name="l01458"></a><span class="lineno"> 1458</span>&#160;      <a class="code" href="../../df/da8/global_8comploops_8h.html#a73344b9115781fb6586768527d859edd">COMPFULLLOOP</a>{</div>
<div class="line"><a name="l01459"></a><span class="lineno"> 1459</span>&#160;        <span class="keywordflow">if</span>(i==390 &amp;&amp; j==1 &amp;&amp; k==0){</div>
<div class="line"><a name="l01460"></a><span class="lineno"> 1460</span>&#160;          dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,                 <span class="stringliteral">&quot;i=%d j=%d k=%d\n&quot;</span>,i,j,k);</div>
<div class="line"><a name="l01461"></a><span class="lineno"> 1461</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;          pl=%d F1orig=%21.15g F1new=%21.15g  :: F2orig=%21.15g F2new=%21.15g \n&quot;</span>,pl,<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F1,i,j,k,pl),GLOBALMACP0A1(F1EM,i,j,k,pl),<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F2,i,j,k,pl),GLOBALMACP0A1(F2EM,i,j,k,pl));</div>
<div class="line"><a name="l01462"></a><span class="lineno"> 1462</span>&#160;        }</div>
<div class="line"><a name="l01463"></a><span class="lineno"> 1463</span>&#160;      }</div>
<div class="line"><a name="l01464"></a><span class="lineno"> 1464</span>&#160;    }</div>
<div class="line"><a name="l01465"></a><span class="lineno"> 1465</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01466"></a><span class="lineno"> 1466</span>&#160;<span class="preprocessor"></span>  </div>
<div class="line"><a name="l01467"></a><span class="lineno"> 1467</span>&#160;<span class="preprocessor">#if(0)// DEBUG:</span></div>
<div class="line"><a name="l01468"></a><span class="lineno"> 1468</span>&#160;<span class="preprocessor"></span>    <span class="keywordflow">if</span>(1){</div>
<div class="line"><a name="l01469"></a><span class="lineno"> 1469</span>&#160;      <span class="keywordtype">int</span> <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>,<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>,k,pliter,pl;</div>
<div class="line"><a name="l01470"></a><span class="lineno"> 1470</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> diff1,diff2;</div>
<div class="line"><a name="l01471"></a><span class="lineno"> 1471</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> sum1,sum2;</div>
<div class="line"><a name="l01472"></a><span class="lineno"> 1472</span>&#160;      dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,                 <span class="stringliteral">&quot;BADLOOPCOMPARE: nstep=%ld steppart=%d\n&quot;</span>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a1a1088d87617078680f1fd0f0d707384">nstep</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a70170b90229f9fc05eebf8508a685c70">steppart</a>);</div>
<div class="line"><a name="l01473"></a><span class="lineno"> 1473</span>&#160;      dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,                 <span class="stringliteral">&quot;ndt1orig=%21.15g ndt1new=%21.15g ndt2orig=%21.15g ndt2new=%21.15g\n&quot;</span>,ndt1,ndt1donor,ndt2,ndt2donor);</div>
<div class="line"><a name="l01474"></a><span class="lineno"> 1474</span>&#160;      <a class="code" href="../../df/da8/global_8comploops_8h.html#a73344b9115781fb6586768527d859edd">COMPFULLLOOP</a>{</div>
<div class="line"><a name="l01475"></a><span class="lineno"> 1475</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l01476"></a><span class="lineno"> 1476</span>&#160;          diff1=fabs(<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F1,i,j,k,pl)-GLOBALMACP0A1(F1EM,i,j,k,pl));</div>
<div class="line"><a name="l01477"></a><span class="lineno"> 1477</span>&#160;          sum1=fabs(<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F1,i,j,k,pl))+fabs(GLOBALMACP0A1(F1EM,i,j,k,pl))+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a09c78d2f8feb311dd9fc969a0bf84979">SMALL</a>;</div>
<div class="line"><a name="l01478"></a><span class="lineno"> 1478</span>&#160;          diff2=fabs(<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F2,i,j,k,pl)-GLOBALMACP0A1(F2EM,i,j,k,pl));</div>
<div class="line"><a name="l01479"></a><span class="lineno"> 1479</span>&#160;          sum2=fabs(<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F2,i,j,k,pl))+fabs(GLOBALMACP0A1(F2EM,i,j,k,pl))+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a09c78d2f8feb311dd9fc969a0bf84979">SMALL</a>;</div>
<div class="line"><a name="l01480"></a><span class="lineno"> 1480</span>&#160;          <span class="keywordflow">if</span>(diff1/sum1&gt;100.0*<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a8913cb5d64cfec23ae1a3052930ec468">NUMEPSILON</a> || diff2/sum2&gt;100.0*<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a8913cb5d64cfec23ae1a3052930ec468">NUMEPSILON</a>){</div>
<div class="line"><a name="l01481"></a><span class="lineno"> 1481</span>&#160;            dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,                 <span class="stringliteral">&quot;i=%d j=%d k=%d\n&quot;</span>,i,j,k);</div>
<div class="line"><a name="l01482"></a><span class="lineno"> 1482</span>&#160;            dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;          pl=%d diff1/sum1=%21.15g F1orig=%21.15g F1new=%21.15g  :: diff2/sum2=%21.15g F2orig=%21.15g F2new=%21.15g \n&quot;</span>,pl,diff1/sum1,<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F1,i,j,k,pl),GLOBALMACP0A1(F1EM,i,j,k,pl),diff2/sum2,<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F2,i,j,k,pl),GLOBALMACP0A1(F2EM,i,j,k,pl));</div>
<div class="line"><a name="l01483"></a><span class="lineno"> 1483</span>&#160;          }</div>
<div class="line"><a name="l01484"></a><span class="lineno"> 1484</span>&#160;        }</div>
<div class="line"><a name="l01485"></a><span class="lineno"> 1485</span>&#160;      }</div>
<div class="line"><a name="l01486"></a><span class="lineno"> 1486</span>&#160;    }</div>
<div class="line"><a name="l01487"></a><span class="lineno"> 1487</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01488"></a><span class="lineno"> 1488</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01489"></a><span class="lineno"> 1489</span>&#160;  }<span class="comment">// end if not just passing through</span></div>
<div class="line"><a name="l01490"></a><span class="lineno"> 1490</span>&#160;</div>
<div class="line"><a name="l01491"></a><span class="lineno"> 1491</span>&#160;</div>
<div class="line"><a name="l01492"></a><span class="lineno"> 1492</span>&#160;</div>
<div class="line"><a name="l01493"></a><span class="lineno"> 1493</span>&#160;</div>
<div class="line"><a name="l01494"></a><span class="lineno"> 1494</span>&#160;</div>
<div class="line"><a name="l01495"></a><span class="lineno"> 1495</span>&#160;</div>
<div class="line"><a name="l01496"></a><span class="lineno"> 1496</span>&#160;<span class="preprocessor">#if(PRODUCTION==0)</span></div>
<div class="line"><a name="l01497"></a><span class="lineno"> 1497</span>&#160;<span class="preprocessor"></span>  trifprintf( <span class="stringliteral">&quot;1f&quot;</span>);</div>
<div class="line"><a name="l01498"></a><span class="lineno"> 1498</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01499"></a><span class="lineno"> 1499</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01500"></a><span class="lineno"> 1500</span>&#160;</div>
<div class="line"><a name="l01501"></a><span class="lineno"> 1501</span>&#160;</div>
<div class="line"><a name="l01502"></a><span class="lineno"> 1502</span>&#160;</div>
<div class="line"><a name="l01503"></a><span class="lineno"> 1503</span>&#160;  <span class="comment">// from here on, pi/pb/pf are only used a zone at a time rather than on a stencil</span></div>
<div class="line"><a name="l01504"></a><span class="lineno"> 1504</span>&#160;</div>
<div class="line"><a name="l01505"></a><span class="lineno"> 1505</span>&#160;</div>
<div class="line"><a name="l01506"></a><span class="lineno"> 1506</span>&#160;  </div>
<div class="line"><a name="l01507"></a><span class="lineno"> 1507</span>&#160;</div>
<div class="line"><a name="l01508"></a><span class="lineno"> 1508</span>&#160;</div>
<div class="line"><a name="l01509"></a><span class="lineno"> 1509</span>&#160;</div>
<div class="line"><a name="l01510"></a><span class="lineno"> 1510</span>&#160;</div>
<div class="line"><a name="l01513"></a><span class="lineno"> 1513</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01514"></a><span class="lineno"> 1514</span>&#160;  <span class="comment">// now update get flux update [loop should go over normal computational region +1 on outer edges so automatically set field if staggered.  Since we only set tempucum so far, ucum in that +1 region is unaffected]</span></div>
<div class="line"><a name="l01515"></a><span class="lineno"> 1515</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01517"></a><span class="lineno"> 1517</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01518"></a><span class="lineno"> 1518</span>&#160;</div>
<div class="line"><a name="l01519"></a><span class="lineno"> 1519</span>&#160;  <span class="keywordtype">int</span> didreturnpf;</div>
<div class="line"><a name="l01520"></a><span class="lineno"> 1520</span>&#160;  <span class="keywordflow">if</span>(truestep){</div>
<div class="line"><a name="l01521"></a><span class="lineno"> 1521</span>&#160;</div>
<div class="line"><a name="l01522"></a><span class="lineno"> 1522</span>&#160;</div>
<div class="line"><a name="l01523"></a><span class="lineno"> 1523</span>&#160;    <span class="comment">// initialize uf and ucum if very first time here since ucum is cumulative (+=) [now tempucum is cumulative]</span></div>
<div class="line"><a name="l01524"></a><span class="lineno"> 1524</span>&#160;    <span class="comment">// copy 0 -&gt; {uf,tempucum}</span></div>
<div class="line"><a name="l01525"></a><span class="lineno"> 1525</span>&#160;    <span class="keywordflow">if</span>(timeorder==0) init_3dnpr_2ptrs(is, ie, js, je, ks, ke,0.0, uf,tempucum);</div>
<div class="line"><a name="l01526"></a><span class="lineno"> 1526</span>&#160;</div>
<div class="line"><a name="l01527"></a><span class="lineno"> 1527</span>&#160;</div>
<div class="line"><a name="l01528"></a><span class="lineno"> 1528</span>&#160;</div>
<div class="line"><a name="l01529"></a><span class="lineno"> 1529</span>&#160;<span class="preprocessor">#if(WHICHEOM==WITHNOGDET &amp;&amp; (NOGDETB1==1 || NOGDETB2==1 || NOGDETB3==1) )</span></div>
<div class="line"><a name="l01530"></a><span class="lineno"> 1530</span>&#160;<span class="preprocessor"></span>    <span class="comment">// for FLUXB==FLUXCTSTAG, assume no source term for field</span></div>
<div class="line"><a name="l01531"></a><span class="lineno"> 1531</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a11c4e99e1493d0c1914ad1ab313ea472">FLUXB</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0b6762cef74e396f50a83864bb53fb6c">FLUXCTSTAG</a>){</div>
<div class="line"><a name="l01532"></a><span class="lineno"> 1532</span>&#160;      dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;Not setup for field source term if staggered field\n&quot;</span>);</div>
<div class="line"><a name="l01533"></a><span class="lineno"> 1533</span>&#160;      myexit(176023);</div>
<div class="line"><a name="l01534"></a><span class="lineno"> 1534</span>&#160;    }</div>
<div class="line"><a name="l01535"></a><span class="lineno"> 1535</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01536"></a><span class="lineno"> 1536</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01537"></a><span class="lineno"> 1537</span>&#160;</div>
<div class="line"><a name="l01538"></a><span class="lineno"> 1538</span>&#160;<span class="preprocessor">#pragma omp parallel OPENMPGLOBALPRIVATEFORSTATEANDGEOM</span></div>
<div class="line"><a name="l01539"></a><span class="lineno"> 1539</span>&#160;<span class="preprocessor"></span>    {</div>
<div class="line"><a name="l01540"></a><span class="lineno"> 1540</span>&#160;      <span class="keywordtype">int</span> pl,pliter,<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>,<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>,k;</div>
<div class="line"><a name="l01541"></a><span class="lineno"> 1541</span>&#160;      <span class="keyword">struct </span><a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> geomdontuse;</div>
<div class="line"><a name="l01542"></a><span class="lineno"> 1542</span>&#160;      <span class="keyword">struct </span><a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom=&amp;geomdontuse;</div>
<div class="line"><a name="l01543"></a><span class="lineno"> 1543</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Uitemp[NPR];</div>
<div class="line"><a name="l01544"></a><span class="lineno"> 1544</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dUgeom[NPR],dUriemann[NPR],dUriemann1[NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>],dUriemann2[NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>],dUriemann3[NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>],dUcomp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ac34589654a83c911addd1fda0898e738">NUMSOURCES</a>][NPR];</div>
<div class="line"><a name="l01545"></a><span class="lineno"> 1545</span>&#160;      <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> qdontuse;</div>
<div class="line"><a name="l01546"></a><span class="lineno"> 1546</span>&#160;      <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *qptr=&amp;qdontuse;</div>
<div class="line"><a name="l01547"></a><span class="lineno"> 1547</span>&#160;      <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> qdontuse2;</div>
<div class="line"><a name="l01548"></a><span class="lineno"> 1548</span>&#160;      <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *qptr2=&amp;qdontuse2; <span class="comment">// different qptr since call normal and special get_state()</span></div>
<div class="line"><a name="l01549"></a><span class="lineno"> 1549</span>&#160;      <span class="comment">// setup default eomtype</span></div>
<div class="line"><a name="l01550"></a><span class="lineno"> 1550</span>&#160;      <span class="keywordtype">int</span> eomtype;</div>
<div class="line"><a name="l01551"></a><span class="lineno"> 1551</span>&#160;</div>
<div class="line"><a name="l01552"></a><span class="lineno"> 1552</span>&#160;</div>
<div class="line"><a name="l01553"></a><span class="lineno"> 1553</span>&#160;      <a class="code" href="../../d5/d7b/global_8openmploops_8h.html#a1389db2daf5bd9e94918090c253a16c9">OPENMP3DLOOPVARSDEFINE</a>; <a class="code" href="../../d5/d7b/global_8openmploops_8h.html#a8de37da93c3462c536ef830f2fbaee61" title="forced to be a computational loop, so start/stop cannot already have shifts in them (which is normal ...">OPENMP3DLOOPSETUP</a>(is,ie,js,je,ks,ke);</div>
<div class="line"><a name="l01554"></a><span class="lineno"> 1554</span>&#160;</div>
<div class="line"><a name="l01555"></a><span class="lineno"> 1555</span>&#160;      </div>
<div class="line"><a name="l01556"></a><span class="lineno"> 1556</span>&#160;<span class="preprocessor">#pragma omp for schedule(OPENMPSCHEDULE(),OPENMPCHUNKSIZE(blocksize))</span></div>
<div class="line"><a name="l01557"></a><span class="lineno"> 1557</span>&#160;<span class="preprocessor"></span>      <a class="code" href="../../d5/d7b/global_8openmploops_8h.html#a9e48537d3cb58cc3a3765b8a18b43b15" title="Oddly, performance changes by 10% when changing how start and stop blockijk (and fixing how used too ...">OPENMP3DLOOPBLOCK</a>{</div>
<div class="line"><a name="l01558"></a><span class="lineno"> 1558</span>&#160;        <a class="code" href="../../df/d1c/global_8storage_8h.html#a96983b0c56e836f50cb7c1af16f59fb6">OPENMP3DLOOPBLOCK2IJK</a>(i,j,k);</div>
<div class="line"><a name="l01559"></a><span class="lineno"> 1559</span>&#160;</div>
<div class="line"><a name="l01560"></a><span class="lineno"> 1560</span>&#160;        <span class="comment">// setup default eomtype</span></div>
<div class="line"><a name="l01561"></a><span class="lineno"> 1561</span>&#160;        eomtype=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aa28b06d889a02621b45edc716bfb2d01">EOMDEFAULT</a>;</div>
<div class="line"><a name="l01562"></a><span class="lineno"> 1562</span>&#160;</div>
<div class="line"><a name="l01563"></a><span class="lineno"> 1563</span>&#160;</div>
<div class="line"><a name="l01564"></a><span class="lineno"> 1564</span>&#160;        <span class="comment">// set geometry for centered zone to be updated</span></div>
<div class="line"><a name="l01565"></a><span class="lineno"> 1565</span>&#160;        <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a3059ed7bfcfb692cbe8014d55fd7c1e4">get_geometry</a>(i, j, k, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8936711f57f82d1fc75c21fa2894e1c6">CENT</a>, ptrgeom);</div>
<div class="line"><a name="l01566"></a><span class="lineno"> 1566</span>&#160;      </div>
<div class="line"><a name="l01567"></a><span class="lineno"> 1567</span>&#160;        <span class="comment">// find Ui(pi)</span></div>
<div class="line"><a name="l01568"></a><span class="lineno"> 1568</span>&#160;        <span class="comment">// force use of primitive to set Ui since otherwise wherever corrected/changed primitive (in fixup, etc.) then would have to change conserved quantity, while same since both are point values</span></div>
<div class="line"><a name="l01569"></a><span class="lineno"> 1569</span>&#160;        <span class="comment">// only field for staggered method is special point value at faces that needs to come from conserved quantity</span></div>
<div class="line"><a name="l01570"></a><span class="lineno"> 1570</span>&#160;        <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a11e17cd8b0594d1ad52e3594aa9f477e" title="find ucon, ucov, bcon, bcov from primitive variables when calling get_state, users of this function e...">get_state</a>(<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(pi,i,j,k), ptrgeom, qptr),<span class="stringliteral">&quot;step_ch.c:advance()&quot;</span>, <span class="stringliteral">&quot;get_state()&quot;</span>, 1);</div>
<div class="line"><a name="l01571"></a><span class="lineno"> 1571</span>&#160;        <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a9a54096e4c40a15a2c1bf74266153616" title="calculate &quot;conserved&quot; quantities">primtoU</a>(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a15d073255fcc246f09aa26337e643d22" title="defines data return types for primtoU() and primtoflux()">UEVOLVE</a>,<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(pi,i,j,k), qptr, ptrgeom, Uitemp, NULL),<span class="stringliteral">&quot;step_ch.c:advance()&quot;</span>, <span class="stringliteral">&quot;primtoU()&quot;</span>, 1);</div>
<div class="line"><a name="l01572"></a><span class="lineno"> 1572</span>&#160;</div>
<div class="line"><a name="l01573"></a><span class="lineno"> 1573</span>&#160;        <span class="keywordflow">if</span>(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a11c4e99e1493d0c1914ad1ab313ea472">FLUXB</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0b6762cef74e396f50a83864bb53fb6c">FLUXCTSTAG</a> || <a class="code" href="../../d8/d5b/defs_8general_8h.html#a55732148d2616d6d1f5d2abbe8710850">DOENOFLUX</a> != <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#adacaaf8526353cfe870206f0cf4d2ca7" title="for DOENOFLUX: 0: no ENO flux reconstruction 1: reconstruct F for finite difference rep...">NOENOFLUX</a> ){</div>
<div class="line"><a name="l01574"></a><span class="lineno"> 1574</span>&#160;          <span class="comment">// then field version of ui[] is stored as &quot;conserved&quot; value at FACE, not CENT</span></div>
<div class="line"><a name="l01575"></a><span class="lineno"> 1575</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a26c7def0d92cbac4d6a7e03a68c3825a">PLOOPNOB1</a>(pl) <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(ui,i,j,k,pl)=Uitemp[pl]; <span class="comment">// CENT</span></div>
<div class="line"><a name="l01576"></a><span class="lineno"> 1576</span>&#160;          <span class="comment">//PLOOPBONLY(pl) MACP0A1(ui,i,j,k,pl) is itself // FACE (see step_ch.c&#39;s setup_rktimestep and know that ui=unew for before first substep)</span></div>
<div class="line"><a name="l01577"></a><span class="lineno"> 1577</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a122c19dd82429684d201ae0f9521be53">PLOOPNOB2</a>(pl) <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(ui,i,j,k,pl)=Uitemp[pl]; <span class="comment">// CENT</span></div>
<div class="line"><a name="l01578"></a><span class="lineno"> 1578</span>&#160;        }</div>
<div class="line"><a name="l01579"></a><span class="lineno"> 1579</span>&#160;        <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l01580"></a><span class="lineno"> 1580</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(ui,i,j,k,pl)=Uitemp[pl]; <span class="comment">// all at CENT</span></div>
<div class="line"><a name="l01581"></a><span class="lineno"> 1581</span>&#160;        }</div>
<div class="line"><a name="l01582"></a><span class="lineno"> 1582</span>&#160; </div>
<div class="line"><a name="l01583"></a><span class="lineno"> 1583</span>&#160;        <span class="comment">// dUriemann is actually average quantity, but we treat is as a point quantity at the zone center</span></div>
<div class="line"><a name="l01584"></a><span class="lineno"> 1584</span>&#160;        <span class="keywordflow">if</span>(doflux){</div>
<div class="line"><a name="l01585"></a><span class="lineno"> 1585</span>&#160;          flux2dUavg(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac578a63f887dbc4797b555bd9c468a5f">DOALLPL</a>,i,j,k,F1,F2,F3,dUriemann1,dUriemann2,dUriemann3);</div>
<div class="line"><a name="l01586"></a><span class="lineno"> 1586</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) dUriemann[pl]=dUriemann1[pl]+dUriemann2[pl]+dUriemann3[pl]; <span class="comment">// this addition is one type of avg-&gt;point mistake</span></div>
<div class="line"><a name="l01587"></a><span class="lineno"> 1587</span>&#160;        }</div>
<div class="line"><a name="l01588"></a><span class="lineno"> 1588</span>&#160;        <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l01589"></a><span class="lineno"> 1589</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) dUriemann[pl]=0.0;</div>
<div class="line"><a name="l01590"></a><span class="lineno"> 1590</span>&#160;        }</div>
<div class="line"><a name="l01591"></a><span class="lineno"> 1591</span>&#160;</div>
<div class="line"><a name="l01592"></a><span class="lineno"> 1592</span>&#160;</div>
<div class="line"><a name="l01594"></a><span class="lineno"> 1594</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01595"></a><span class="lineno"> 1595</span>&#160;        <span class="comment">// Utoprim as initial conditions : can&#39;t assume want these to be same in the end, so assign</span></div>
<div class="line"><a name="l01596"></a><span class="lineno"> 1596</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01597"></a><span class="lineno"> 1597</span>&#160;        <span class="comment">// MAJORNOTE: Since final step often sets pointers of pi=pf, in order to use arbitrary guess, must set here once done with pi,pb,pf.</span></div>
<div class="line"><a name="l01598"></a><span class="lineno"> 1598</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01600"></a><span class="lineno"> 1600</span>&#160;<span class="comment"></span>        <span class="comment">// copy pb-&gt;pf as initial pf</span></div>
<div class="line"><a name="l01601"></a><span class="lineno"> 1601</span>&#160;        <span class="comment">// can do this now that don&#39;t need pi anymore</span></div>
<div class="line"><a name="l01602"></a><span class="lineno"> 1602</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl) <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pf,i,j,k,pl) = <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pb,i,j,k,pl);</div>
<div class="line"><a name="l01603"></a><span class="lineno"> 1603</span>&#160;</div>
<div class="line"><a name="l01604"></a><span class="lineno"> 1604</span>&#160;</div>
<div class="line"><a name="l01607"></a><span class="lineno"> 1607</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01608"></a><span class="lineno"> 1608</span>&#160;        <span class="comment">// now update get source update (only affects stress-energy tensor in general)</span></div>
<div class="line"><a name="l01609"></a><span class="lineno"> 1609</span>&#160;        <span class="comment">// [Loop goes over up to +1 normal computational region for getting new staggered U if doing FLUXCTSTAG]</span></div>
<div class="line"><a name="l01610"></a><span class="lineno"> 1610</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01612"></a><span class="lineno"> 1612</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l01613"></a><span class="lineno"> 1613</span>&#160;        <span class="comment">// get state since both source() and dUtodt() need same state</span></div>
<div class="line"><a name="l01614"></a><span class="lineno"> 1614</span>&#160;        <span class="comment">// From pb, so different than state for Ui(pi)</span></div>
<div class="line"><a name="l01615"></a><span class="lineno"> 1615</span>&#160;        <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(<a class="code" href="../../de/d8c/phys_8c.html#a126e2e13b7ac0d2c79b17ecf87129b77" title="wrapper for choosing to get state by computing it or from global array pointer assign (overrides the ...">get_stateforsource</a>(<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(pb,i,j,k), ptrgeom, &amp;qptr2) ,<span class="stringliteral">&quot;advance.c:()&quot;</span>, <span class="stringliteral">&quot;get_state() dir=0&quot;</span>, 1);</div>
<div class="line"><a name="l01616"></a><span class="lineno"> 1616</span>&#160;      </div>
<div class="line"><a name="l01617"></a><span class="lineno"> 1617</span>&#160;</div>
<div class="line"><a name="l01618"></a><span class="lineno"> 1618</span>&#160;        <span class="comment">// note that uf and ucum are initialized inside setup_rktimestep() before first substep</span></div>
<div class="line"><a name="l01619"></a><span class="lineno"> 1619</span>&#160;</div>
<div class="line"><a name="l01620"></a><span class="lineno"> 1620</span>&#160;</div>
<div class="line"><a name="l01621"></a><span class="lineno"> 1621</span>&#160;        <span class="comment">// find dU(pb)</span></div>
<div class="line"><a name="l01622"></a><span class="lineno"> 1622</span>&#160;        <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a4ebf7765a6bde079a76719b89d3033b6" title="add in source terms to equations of motion ui and dUriemann in UEVOLVE form assume q(pr) so consisten...">source</a>(<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(pi,i,j,k), <a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(pb,i,j,k), <a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(pf,i,j,k), &amp;didreturnpf, &amp;eomtype, ptrgeom, qptr2, <a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(ui,i,j,k), <a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(uf,i,j,k), CUf, CUimp, 0.0, dUriemann, dUcomp, dUgeom),<span class="stringliteral">&quot;step_ch.c:advance()&quot;</span>, <span class="stringliteral">&quot;source&quot;</span>, 1);</div>
<div class="line"><a name="l01623"></a><span class="lineno"> 1623</span>&#160;        <span class="comment">// assumes final dUcomp is nonzero and representative of source term over this timestep</span></div>
<div class="line"><a name="l01624"></a><span class="lineno"> 1624</span>&#160;        <span class="comment">// KORALTODO: Not using eomtype for this method because outside loop.  Would have to store eomtype in array or something!</span></div>
<div class="line"><a name="l01625"></a><span class="lineno"> 1625</span>&#160; </div>
<div class="line"><a name="l01626"></a><span class="lineno"> 1626</span>&#160;        <span class="comment">// DEBUG (to check if source updated pf guess)</span></div>
<div class="line"><a name="l01627"></a><span class="lineno"> 1627</span>&#160;        <span class="comment">//        if(didreturnpf==1) dualfprintf(fail_file,&quot;didreturnpf=%d\n&quot;,didreturnpf);</span></div>
<div class="line"><a name="l01628"></a><span class="lineno"> 1628</span>&#160;</div>
<div class="line"><a name="l01629"></a><span class="lineno"> 1629</span>&#160;</div>
<div class="line"><a name="l01630"></a><span class="lineno"> 1630</span>&#160;<span class="preprocessor">#if(SPLITNPR)</span></div>
<div class="line"><a name="l01631"></a><span class="lineno"> 1631</span>&#160;<span class="preprocessor"></span>        <span class="comment">// don&#39;t update metric if only doing B1-B3</span></div>
<div class="line"><a name="l01632"></a><span class="lineno"> 1632</span>&#160;        <span class="keywordflow">if</span>(<a class="code" href="../../d8/d5b/defs_8general_8h.html#aa2010d23a21177641277f5119a2705c7">advancepassnumber</a>==-1 || <a class="code" href="../../d8/d5b/defs_8general_8h.html#aa2010d23a21177641277f5119a2705c7">advancepassnumber</a>==1)</div>
<div class="line"><a name="l01633"></a><span class="lineno"> 1633</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01634"></a><span class="lineno"> 1634</span>&#160;<span class="preprocessor"></span>          {</div>
<div class="line"><a name="l01635"></a><span class="lineno"> 1635</span>&#160;            <span class="keywordflow">if</span>(<a class="code" href="../../d8/d5b/defs_8general_8h.html#aac5486df6a846aa6cb47c73202ac0485">DODIAGS</a>){</div>
<div class="line"><a name="l01636"></a><span class="lineno"> 1636</span>&#160;<span class="preprocessor">#if(ACCURATESOURCEDIAG&gt;=1)</span></div>
<div class="line"><a name="l01637"></a><span class="lineno"> 1637</span>&#160;<span class="preprocessor"></span>              diag_source_all(ptrgeom,dUgeom,fluxdt);</div>
<div class="line"><a name="l01638"></a><span class="lineno"> 1638</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l01639"></a><span class="lineno"> 1639</span>&#160;<span class="preprocessor"></span>              diag_source_all(ptrgeom,dUgeom,dt4diag);</div>
<div class="line"><a name="l01640"></a><span class="lineno"> 1640</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01641"></a><span class="lineno"> 1641</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#if(ACCURATESOURCEDIAG&gt;=2)</span></div>
<div class="line"><a name="l01642"></a><span class="lineno"> 1642</span>&#160;<span class="preprocessor"></span>              diag_source_comp(ptrgeom,dUcomp,fluxdt);</div>
<div class="line"><a name="l01643"></a><span class="lineno"> 1643</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l01644"></a><span class="lineno"> 1644</span>&#160;<span class="preprocessor"></span>              diag_source_comp(ptrgeom,dUcomp,dt4diag);</div>
<div class="line"><a name="l01645"></a><span class="lineno"> 1645</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01646"></a><span class="lineno"> 1646</span>&#160;<span class="preprocessor"></span>            }</div>
<div class="line"><a name="l01647"></a><span class="lineno"> 1647</span>&#160;          }</div>
<div class="line"><a name="l01648"></a><span class="lineno"> 1648</span>&#160;</div>
<div class="line"><a name="l01649"></a><span class="lineno"> 1649</span>&#160;      </div>
<div class="line"><a name="l01650"></a><span class="lineno"> 1650</span>&#160;</div>
<div class="line"><a name="l01651"></a><span class="lineno"> 1651</span>&#160;        <span class="comment">// Get update</span></div>
<div class="line"><a name="l01652"></a><span class="lineno"> 1652</span>&#160;        dUtoU(timeorder,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac578a63f887dbc4797b555bd9c468a5f">DOALLPL</a>, i,j,k,ptrgeom-&gt;p,dUgeom, dUcomp, dUriemann, CUf, CUnew, <a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(ui,i,j,k), <a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(uf,i,j,k), <a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(tempucum,i,j,k));</div>
<div class="line"><a name="l01653"></a><span class="lineno"> 1653</span>&#160;      </div>
<div class="line"><a name="l01654"></a><span class="lineno"> 1654</span>&#160;      </div>
<div class="line"><a name="l01655"></a><span class="lineno"> 1655</span>&#160;      </div>
<div class="line"><a name="l01656"></a><span class="lineno"> 1656</span>&#160;        <span class="comment">// get timestep limit from acceleration</span></div>
<div class="line"><a name="l01657"></a><span class="lineno"> 1657</span>&#160;<span class="preprocessor">#if(LIMITDTWITHSOURCETERM)</span></div>
<div class="line"><a name="l01658"></a><span class="lineno"> 1658</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#if(SPLITNPR)</span></div>
<div class="line"><a name="l01659"></a><span class="lineno"> 1659</span>&#160;<span class="preprocessor"></span>        <span class="comment">// don&#39;t do dUtodt if only doing B1-B3</span></div>
<div class="line"><a name="l01660"></a><span class="lineno"> 1660</span>&#160;        <span class="keywordflow">if</span>(<a class="code" href="../../d8/d5b/defs_8general_8h.html#aa2010d23a21177641277f5119a2705c7">advancepassnumber</a>==-1 || <a class="code" href="../../d8/d5b/defs_8general_8h.html#aa2010d23a21177641277f5119a2705c7">advancepassnumber</a>==1)</div>
<div class="line"><a name="l01661"></a><span class="lineno"> 1661</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01662"></a><span class="lineno"> 1662</span>&#160;<span class="preprocessor"></span>          {</div>
<div class="line"><a name="l01663"></a><span class="lineno"> 1663</span>&#160;            <span class="comment">// geometry is post-metric update, but should still give good estimate of future dt</span></div>
<div class="line"><a name="l01664"></a><span class="lineno"> 1664</span>&#160;            dUtodt(ptrgeom, qptr2, <a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(pb,i,j,k), dUgeom, dUriemann, dUcomp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a06b1d017ed7599c17c423f4d989a8d63" title="these get ADDED UP, not independently treated number of source terms.">GEOMSOURCE</a>], &amp;accdt_ij, &amp;gravitydt_ij);</div>
<div class="line"><a name="l01665"></a><span class="lineno"> 1665</span>&#160;</div>
<div class="line"><a name="l01666"></a><span class="lineno"> 1666</span>&#160;<span class="preprocessor">#pragma omp critical</span></div>
<div class="line"><a name="l01667"></a><span class="lineno"> 1667</span>&#160;<span class="preprocessor"></span>            {</div>
<div class="line"><a name="l01668"></a><span class="lineno"> 1668</span>&#160;              <span class="keywordflow">if</span>(accdt_ij&lt;accdt){</div>
<div class="line"><a name="l01669"></a><span class="lineno"> 1669</span>&#160;                accdt=accdt_ij;</div>
<div class="line"><a name="l01670"></a><span class="lineno"> 1670</span>&#160;                accdti=<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>;</div>
<div class="line"><a name="l01671"></a><span class="lineno"> 1671</span>&#160;                accdtj=<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>;</div>
<div class="line"><a name="l01672"></a><span class="lineno"> 1672</span>&#160;                accdtk=k;</div>
<div class="line"><a name="l01673"></a><span class="lineno"> 1673</span>&#160;              }</div>
<div class="line"><a name="l01674"></a><span class="lineno"> 1674</span>&#160;              <span class="keywordflow">if</span>(gravitydt_ij&lt;gravitydt){</div>
<div class="line"><a name="l01675"></a><span class="lineno"> 1675</span>&#160;                gravitydt=gravitydt_ij;</div>
<div class="line"><a name="l01676"></a><span class="lineno"> 1676</span>&#160;                gravitydti=<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>;</div>
<div class="line"><a name="l01677"></a><span class="lineno"> 1677</span>&#160;                gravitydtj=<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>;</div>
<div class="line"><a name="l01678"></a><span class="lineno"> 1678</span>&#160;                gravitydtk=k;</div>
<div class="line"><a name="l01679"></a><span class="lineno"> 1679</span>&#160;              }</div>
<div class="line"><a name="l01680"></a><span class="lineno"> 1680</span>&#160;            }<span class="comment">// end critical region</span></div>
<div class="line"><a name="l01681"></a><span class="lineno"> 1681</span>&#160;          }<span class="comment">// end block that may mean: if not only doing B1-B3</span></div>
<div class="line"><a name="l01682"></a><span class="lineno"> 1682</span>&#160;</div>
<div class="line"><a name="l01683"></a><span class="lineno"> 1683</span>&#160;<span class="preprocessor">#endif // end if doing LIMITDTWITHSOURCETERM</span></div>
<div class="line"><a name="l01684"></a><span class="lineno"> 1684</span>&#160;<span class="preprocessor"></span>          </div>
<div class="line"><a name="l01685"></a><span class="lineno"> 1685</span>&#160;</div>
<div class="line"><a name="l01686"></a><span class="lineno"> 1686</span>&#160;</div>
<div class="line"><a name="l01687"></a><span class="lineno"> 1687</span>&#160;</div>
<div class="line"><a name="l01688"></a><span class="lineno"> 1688</span>&#160;</div>
<div class="line"><a name="l01689"></a><span class="lineno"> 1689</span>&#160;</div>
<div class="line"><a name="l01690"></a><span class="lineno"> 1690</span>&#160;<span class="preprocessor">#if(FLUXDUMP==1)</span></div>
<div class="line"><a name="l01691"></a><span class="lineno"> 1691</span>&#160;<span class="preprocessor"></span>        <a class="code" href="../../d8/d5b/defs_8general_8h.html#a8dbd91efbd66d631d5833f18413afcd7">fluxdumpdt</a>=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a56db625f31229c5e8b208ff27d464931">dt</a>; <span class="comment">// store current dt so when dump fluxdump use that dt instead of updated dt</span></div>
<div class="line"><a name="l01692"></a><span class="lineno"> 1692</span>&#160;        <a class="code" href="../../d8/d5b/defs_8general_8h.html#af72cb94d3bf2c583e1572cfadfe1414c">fluxdumprealnstep</a>=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a0b92e4d6197989f0f9b0609c8615a46f">realnstep</a>;</div>
<div class="line"><a name="l01693"></a><span class="lineno"> 1693</span>&#160;        <span class="comment">// DEBUG - DIAG:</span></div>
<div class="line"><a name="l01694"></a><span class="lineno"> 1694</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) GLOBALMACP0A1(fluxdump,i,j,k,0*NPR + pl)=dUgeom[pl];</div>
<div class="line"><a name="l01695"></a><span class="lineno"> 1695</span>&#160;</div>
<div class="line"><a name="l01696"></a><span class="lineno"> 1696</span>&#160;        <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#abd7b39be02bc15d79b73e5cf2b531299" title="#define CORNGDETVERSION 0">N1</a>&gt;1) <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) GLOBALMACP0A1(fluxdump,i,j,k,1*NPR + pl)=dUriemann1[pl];</div>
<div class="line"><a name="l01697"></a><span class="lineno"> 1697</span>&#160;        <span class="keywordflow">else</span> <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) GLOBALMACP0A1(fluxdump,i,j,k,1*NPR + pl)=0.0;</div>
<div class="line"><a name="l01698"></a><span class="lineno"> 1698</span>&#160;  </div>
<div class="line"><a name="l01699"></a><span class="lineno"> 1699</span>&#160;        <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#acd864640121c7df2c19f61f7baa507e4">N2</a>&gt;1) <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) GLOBALMACP0A1(fluxdump,i,j,k,2*NPR + pl)=dUriemann2[pl];</div>
<div class="line"><a name="l01700"></a><span class="lineno"> 1700</span>&#160;        <span class="keywordflow">else</span> <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) GLOBALMACP0A1(fluxdump,i,j,k,2*NPR + pl)=0.0;</div>
<div class="line"><a name="l01701"></a><span class="lineno"> 1701</span>&#160;</div>
<div class="line"><a name="l01702"></a><span class="lineno"> 1702</span>&#160;        <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#ad66109fbdc4d3adc9c3d6ff917038aef">N3</a>&gt;1) <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) GLOBALMACP0A1(fluxdump,i,j,k,3*NPR + pl)=dUriemann3[pl];</div>
<div class="line"><a name="l01703"></a><span class="lineno"> 1703</span>&#160;        <span class="keywordflow">else</span> <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) GLOBALMACP0A1(fluxdump,i,j,k,3*NPR + pl)=0.0;</div>
<div class="line"><a name="l01704"></a><span class="lineno"> 1704</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01705"></a><span class="lineno"> 1705</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01706"></a><span class="lineno"> 1706</span>&#160;      } <span class="comment">// end COMPZLOOP :: end looping to obtain dUriemann and full unew update</span></div>
<div class="line"><a name="l01707"></a><span class="lineno"> 1707</span>&#160;    }<span class="comment">// end parallel block</span></div>
<div class="line"><a name="l01708"></a><span class="lineno"> 1708</span>&#160;  } <span class="comment">// end if truestep</span></div>
<div class="line"><a name="l01709"></a><span class="lineno"> 1709</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l01710"></a><span class="lineno"> 1710</span>&#160;    <span class="comment">// then nothing to do since nothing changed</span></div>
<div class="line"><a name="l01711"></a><span class="lineno"> 1711</span>&#160;    <span class="comment">// previously updated dU and got new ucum as fed into metric, but now metric has its own ucummetric so all that is not needed</span></div>
<div class="line"><a name="l01712"></a><span class="lineno"> 1712</span>&#160;    <span class="comment">// SUPERGODMARK: no, I guess I don&#39;t recall what was being done for metric and why when passing through with dt==0.0</span></div>
<div class="line"><a name="l01713"></a><span class="lineno"> 1713</span>&#160;</div>
<div class="line"><a name="l01714"></a><span class="lineno"> 1714</span>&#160;    <span class="comment">// just need to copy ui -&gt; {uf,tempucum} to duplicate behavior of dUtoU()</span></div>
<div class="line"><a name="l01715"></a><span class="lineno"> 1715</span>&#160;    copy_3dnpr_2ptrs(is,ie,js,je,ks,ke,ui,uf,tempucum);</div>
<div class="line"><a name="l01716"></a><span class="lineno"> 1716</span>&#160;  }</div>
<div class="line"><a name="l01717"></a><span class="lineno"> 1717</span>&#160;</div>
<div class="line"><a name="l01718"></a><span class="lineno"> 1718</span>&#160;</div>
<div class="line"><a name="l01719"></a><span class="lineno"> 1719</span>&#160;</div>
<div class="line"><a name="l01720"></a><span class="lineno"> 1720</span>&#160;</div>
<div class="line"><a name="l01721"></a><span class="lineno"> 1721</span>&#160;</div>
<div class="line"><a name="l01722"></a><span class="lineno"> 1722</span>&#160;</div>
<div class="line"><a name="l01723"></a><span class="lineno"> 1723</span>&#160;</div>
<div class="line"><a name="l01724"></a><span class="lineno"> 1724</span>&#160;<span class="preprocessor">#if(PRODUCTION==0)</span></div>
<div class="line"><a name="l01725"></a><span class="lineno"> 1725</span>&#160;<span class="preprocessor"></span>  trifprintf( <span class="stringliteral">&quot;#0m&quot;</span>);</div>
<div class="line"><a name="l01726"></a><span class="lineno"> 1726</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01727"></a><span class="lineno"> 1727</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01728"></a><span class="lineno"> 1728</span>&#160;  </div>
<div class="line"><a name="l01729"></a><span class="lineno"> 1729</span>&#160;    </div>
<div class="line"><a name="l01731"></a><span class="lineno"> 1731</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01732"></a><span class="lineno"> 1732</span>&#160;  <span class="comment">// EVOLVE (update/compute) METRIC HERE</span></div>
<div class="line"><a name="l01733"></a><span class="lineno"> 1733</span>&#160;  <span class="comment">// In general computes stress-energy tensor (T) from pb and T is then used to compute metric</span></div>
<div class="line"><a name="l01734"></a><span class="lineno"> 1734</span>&#160;  <span class="comment">// Done here instead of after flux since horizon_flux() updates flux through boundary that would change metric</span></div>
<div class="line"><a name="l01735"></a><span class="lineno"> 1735</span>&#160;  <span class="comment">// want metric to be at same time as everything else done with pb so RK method is consistent</span></div>
<div class="line"><a name="l01736"></a><span class="lineno"> 1736</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01737"></a><span class="lineno"> 1737</span>&#160;  <span class="comment">// uses unew that&#39;s NOT updated yet</span></div>
<div class="line"><a name="l01739"></a><span class="lineno"> 1739</span>&#160;<span class="comment"></span>  <span class="keywordflow">if</span>(truestep){</div>
<div class="line"><a name="l01740"></a><span class="lineno"> 1740</span>&#160;    <span class="keywordflow">if</span>(doingmetricsubstep()){</div>
<div class="line"><a name="l01741"></a><span class="lineno"> 1741</span>&#160;<span class="preprocessor">#if(SPLITNPR)</span></div>
<div class="line"><a name="l01742"></a><span class="lineno"> 1742</span>&#160;<span class="preprocessor"></span>      <span class="comment">// don&#39;t update metric if only doing B1-B3</span></div>
<div class="line"><a name="l01743"></a><span class="lineno"> 1743</span>&#160;      <span class="keywordflow">if</span>(<a class="code" href="../../d8/d5b/defs_8general_8h.html#aa2010d23a21177641277f5119a2705c7">advancepassnumber</a>==-1 || <a class="code" href="../../d8/d5b/defs_8general_8h.html#aa2010d23a21177641277f5119a2705c7">advancepassnumber</a>==1)</div>
<div class="line"><a name="l01744"></a><span class="lineno"> 1744</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01745"></a><span class="lineno"> 1745</span>&#160;<span class="preprocessor"></span>        {</div>
<div class="line"><a name="l01746"></a><span class="lineno"> 1746</span>&#160;          compute_new_metric_substep(CUf,CUnew,pb,ucumformetric); <span class="comment">// CHANGINGMARK : Not sure if CUnew here is correct</span></div>
<div class="line"><a name="l01747"></a><span class="lineno"> 1747</span>&#160;        }</div>
<div class="line"><a name="l01748"></a><span class="lineno"> 1748</span>&#160;    }<span class="comment">// end if doing metric substepping</span></div>
<div class="line"><a name="l01749"></a><span class="lineno"> 1749</span>&#160;  }</div>
<div class="line"><a name="l01750"></a><span class="lineno"> 1750</span>&#160;</div>
<div class="line"><a name="l01751"></a><span class="lineno"> 1751</span>&#160;</div>
<div class="line"><a name="l01752"></a><span class="lineno"> 1752</span>&#160;</div>
<div class="line"><a name="l01753"></a><span class="lineno"> 1753</span>&#160;</div>
<div class="line"><a name="l01755"></a><span class="lineno"> 1755</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01756"></a><span class="lineno"> 1756</span>&#160;  <span class="comment">// compute flux diagnostics (accurately using all substeps)</span></div>
<div class="line"><a name="l01757"></a><span class="lineno"> 1757</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01759"></a><span class="lineno"> 1759</span>&#160;<span class="comment"></span>  <span class="keywordflow">if</span>(doflux &amp;&amp; truestep){</div>
<div class="line"><a name="l01760"></a><span class="lineno"> 1760</span>&#160;    <span class="comment">// must come after metric changes that can change where flux surface is since otherwise when flux surface changes, we won&#39;t track this substep&#39;s flux through the new surface but the old surface (which could even be at r=0 and have no flux)</span></div>
<div class="line"><a name="l01761"></a><span class="lineno"> 1761</span>&#160;    <span class="comment">// if using unew, then since metric update above uses old unew, need present flux at new horizon surface</span></div>
<div class="line"><a name="l01762"></a><span class="lineno"> 1762</span>&#160;<span class="preprocessor">#if(SPLITNPR)</span></div>
<div class="line"><a name="l01763"></a><span class="lineno"> 1763</span>&#160;<span class="preprocessor"></span>    <span class="comment">// don&#39;t update metric if only doing B1-B3</span></div>
<div class="line"><a name="l01764"></a><span class="lineno"> 1764</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../d8/d5b/defs_8general_8h.html#aa2010d23a21177641277f5119a2705c7">advancepassnumber</a>==-1 || <a class="code" href="../../d8/d5b/defs_8general_8h.html#aa2010d23a21177641277f5119a2705c7">advancepassnumber</a>==1)</div>
<div class="line"><a name="l01765"></a><span class="lineno"> 1765</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01766"></a><span class="lineno"> 1766</span>&#160;<span class="preprocessor"></span>      {</div>
<div class="line"><a name="l01767"></a><span class="lineno"> 1767</span>&#160;<span class="preprocessor">#if(ACCURATEDIAG)</span></div>
<div class="line"><a name="l01768"></a><span class="lineno"> 1768</span>&#160;<span class="preprocessor"></span>        diag_flux_pureflux(pb,F1, F2, F3, fluxdt); <span class="comment">// fluxdt is true dt for this flux as added in dUtoU() as part of ucum</span></div>
<div class="line"><a name="l01769"></a><span class="lineno"> 1769</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01770"></a><span class="lineno"> 1770</span>&#160;<span class="preprocessor"></span>      }</div>
<div class="line"><a name="l01771"></a><span class="lineno"> 1771</span>&#160;  }</div>
<div class="line"><a name="l01772"></a><span class="lineno"> 1772</span>&#160;</div>
<div class="line"><a name="l01773"></a><span class="lineno"> 1773</span>&#160;</div>
<div class="line"><a name="l01774"></a><span class="lineno"> 1774</span>&#160;</div>
<div class="line"><a name="l01775"></a><span class="lineno"> 1775</span>&#160;</div>
<div class="line"><a name="l01776"></a><span class="lineno"> 1776</span>&#160;</div>
<div class="line"><a name="l01777"></a><span class="lineno"> 1777</span>&#160;</div>
<div class="line"><a name="l01778"></a><span class="lineno"> 1778</span>&#160;  </div>
<div class="line"><a name="l01779"></a><span class="lineno"> 1779</span>&#160;<span class="preprocessor">#if(PRODUCTION==0)</span></div>
<div class="line"><a name="l01780"></a><span class="lineno"> 1780</span>&#160;<span class="preprocessor"></span>  trifprintf( <span class="stringliteral">&quot;#0s&quot;</span>);</div>
<div class="line"><a name="l01781"></a><span class="lineno"> 1781</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01782"></a><span class="lineno"> 1782</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01783"></a><span class="lineno"> 1783</span>&#160;</div>
<div class="line"><a name="l01784"></a><span class="lineno"> 1784</span>&#160;</div>
<div class="line"><a name="l01785"></a><span class="lineno"> 1785</span>&#160;</div>
<div class="line"><a name="l01786"></a><span class="lineno"> 1786</span>&#160;</div>
<div class="line"><a name="l01788"></a><span class="lineno"> 1788</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01789"></a><span class="lineno"> 1789</span>&#160;  <span class="comment">// Copy over tempucum -&gt; ucum per pl to account for staggered field</span></div>
<div class="line"><a name="l01790"></a><span class="lineno"> 1790</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01791"></a><span class="lineno"> 1791</span>&#160;  <span class="comment">// And choose which RK-quantity to invert</span></div>
<div class="line"><a name="l01792"></a><span class="lineno"> 1792</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01794"></a><span class="lineno"> 1794</span>&#160;<span class="comment"></span>  <span class="keywordflow">if</span>(finalstep){</div>
<div class="line"><a name="l01795"></a><span class="lineno"> 1795</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a11c4e99e1493d0c1914ad1ab313ea472">FLUXB</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0b6762cef74e396f50a83864bb53fb6c">FLUXCTSTAG</a>){</div>
<div class="line"><a name="l01796"></a><span class="lineno"> 1796</span>&#160;      <span class="comment">// copy over new ucum in only desired locations irrespective of where tempucum was updated</span></div>
<div class="line"><a name="l01797"></a><span class="lineno"> 1797</span>&#160;      <span class="comment">// copy tempucum -&gt; ucum</span></div>
<div class="line"><a name="l01798"></a><span class="lineno"> 1798</span>&#160;      copy_tempucum_finalucum(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac578a63f887dbc4797b555bd9c468a5f">DOALLPL</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#ab5c60dcb37b1f7e5642525031cd5cbcf">Uconsevolveloop</a>,tempucum,ucum);</div>
<div class="line"><a name="l01799"></a><span class="lineno"> 1799</span>&#160;    }</div>
<div class="line"><a name="l01800"></a><span class="lineno"> 1800</span>&#160;    utoinvert = ucum;</div>
<div class="line"><a name="l01801"></a><span class="lineno"> 1801</span>&#160;    useducum=ucum;</div>
<div class="line"><a name="l01802"></a><span class="lineno"> 1802</span>&#160;  }</div>
<div class="line"><a name="l01803"></a><span class="lineno"> 1803</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l01804"></a><span class="lineno"> 1804</span>&#160;    <span class="comment">// tempucum cumulates for now</span></div>
<div class="line"><a name="l01805"></a><span class="lineno"> 1805</span>&#160;    utoinvert = uf;</div>
<div class="line"><a name="l01806"></a><span class="lineno"> 1806</span>&#160;    <span class="comment">// tempucum cumulates for now</span></div>
<div class="line"><a name="l01807"></a><span class="lineno"> 1807</span>&#160;    useducum=tempucum;</div>
<div class="line"><a name="l01808"></a><span class="lineno"> 1808</span>&#160;  }</div>
<div class="line"><a name="l01809"></a><span class="lineno"> 1809</span>&#160;</div>
<div class="line"><a name="l01810"></a><span class="lineno"> 1810</span>&#160;</div>
<div class="line"><a name="l01811"></a><span class="lineno"> 1811</span>&#160;</div>
<div class="line"><a name="l01812"></a><span class="lineno"> 1812</span>&#160;</div>
<div class="line"><a name="l01813"></a><span class="lineno"> 1813</span>&#160;</div>
<div class="line"><a name="l01815"></a><span class="lineno"> 1815</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01816"></a><span class="lineno"> 1816</span>&#160;  <span class="comment">// split ZLOOP above and below to allow staggered field method</span></div>
<div class="line"><a name="l01817"></a><span class="lineno"> 1817</span>&#160;  <span class="comment">// [loop only over &quot;centered&quot; cells]</span></div>
<div class="line"><a name="l01818"></a><span class="lineno"> 1818</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01820"></a><span class="lineno"> 1820</span>&#160;<span class="comment"></span>  <span class="keywordflow">if</span>(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a11c4e99e1493d0c1914ad1ab313ea472">FLUXB</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0b6762cef74e396f50a83864bb53fb6c">FLUXCTSTAG</a>){</div>
<div class="line"><a name="l01821"></a><span class="lineno"> 1821</span>&#160;    <span class="comment">// if using staggered grid for magnetic field, then need to convert ucum to pstag to new pb/pf</span></div>
<div class="line"><a name="l01822"></a><span class="lineno"> 1822</span>&#160;</div>
<div class="line"><a name="l01823"></a><span class="lineno"> 1823</span>&#160;</div>
<div class="line"><a name="l01824"></a><span class="lineno"> 1824</span>&#160;    <span class="comment">// GODMARK: Use of globals</span></div>
<div class="line"><a name="l01825"></a><span class="lineno"> 1825</span>&#160;    myupoint=<a class="code" href="../../df/d1c/global_8storage_8h.html#ad89dafa5d772b862a44b0f576983ead3" title="shifted pointer (a_s_) wrappers Couldn&#39;t figure out how to macrofy a_s_ or a_, so when changing have ...">GLOBALPOINT</a>(upointglobal);</div>
<div class="line"><a name="l01826"></a><span class="lineno"> 1826</span>&#160;</div>
<div class="line"><a name="l01827"></a><span class="lineno"> 1827</span>&#160;    <span class="comment">// first copy over all quantities as point, which is true except for fields if FLUXRECON active</span></div>
<div class="line"><a name="l01828"></a><span class="lineno"> 1828</span>&#160;    <span class="comment">// copy utoinvert -&gt; myupoint</span></div>
<div class="line"><a name="l01829"></a><span class="lineno"> 1829</span>&#160;    <span class="comment">// copy all pl&#39;s since myupoint eventually used to invert rest of non-field quantities</span></div>
<div class="line"><a name="l01830"></a><span class="lineno"> 1830</span>&#160;    copy_tempucum_finalucum(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac578a63f887dbc4797b555bd9c468a5f">DOALLPL</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#ab5c60dcb37b1f7e5642525031cd5cbcf">Uconsevolveloop</a>,utoinvert,myupoint);</div>
<div class="line"><a name="l01831"></a><span class="lineno"> 1831</span>&#160;</div>
<div class="line"><a name="l01832"></a><span class="lineno"> 1832</span>&#160;</div>
<div class="line"><a name="l01833"></a><span class="lineno"> 1833</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a41163ae4887e295df142ae7fc9b4829c">extrazones4emf</a> &amp;&amp; <a class="code" href="../../d8/d5b/defs_8general_8h.html#ad5c8369abdf1833b4afc10d11d52b537">dofluxreconevolvepointfield</a>==0){</div>
<div class="line"><a name="l01834"></a><span class="lineno"> 1834</span>&#160;      <span class="comment">//bound_uavg(STAGEM1,utoinvert); // DEBUG</span></div>
<div class="line"><a name="l01835"></a><span class="lineno"> 1835</span>&#160;      <span class="comment">// uses utoinvert and gets reaveraged field into myupoint</span></div>
<div class="line"><a name="l01836"></a><span class="lineno"> 1836</span>&#160;      field_integrate_fluxrecon(stage, pb, utoinvert, myupoint);</div>
<div class="line"><a name="l01837"></a><span class="lineno"> 1837</span>&#160;    }</div>
<div class="line"><a name="l01838"></a><span class="lineno"> 1838</span>&#160;</div>
<div class="line"><a name="l01839"></a><span class="lineno"> 1839</span>&#160;</div>
<div class="line"><a name="l01840"></a><span class="lineno"> 1840</span>&#160;    <span class="comment">// first pb entry is used for shock indicator, second is filled with new field</span></div>
<div class="line"><a name="l01841"></a><span class="lineno"> 1841</span>&#160;    <span class="comment">// myupoint goes in as staggered point value of magnetic flux and returned as centered point value of magnetic flux</span></div>
<div class="line"><a name="l01842"></a><span class="lineno"> 1842</span>&#160;    <span class="comment">// first pb entry is used for shock indicator, second is filled with new field</span></div>
<div class="line"><a name="l01843"></a><span class="lineno"> 1843</span>&#160;    <span class="comment">// myupoint goes in as staggered point value of magnetic flux and returned as centered point value of magnetic flux</span></div>
<div class="line"><a name="l01844"></a><span class="lineno"> 1844</span>&#160;    <span class="keywordflow">if</span>(1){ <span class="comment">// must manually override to use below donor version</span></div>
<div class="line"><a name="l01845"></a><span class="lineno"> 1845</span>&#160;      <a class="code" href="../../d0/dde/fluxctstag_8c.html#a3c59ef3a54b18bbaf4970c13995dadfc" title="wrapper for taking staggered conserved field quantity and obtaining centered field quantity upoint en...">interpolate_ustag2fieldcent</a>(stage, boundtime, timeorder, numtimeorders, pb, pstag, myupoint, pf);</div>
<div class="line"><a name="l01846"></a><span class="lineno"> 1846</span>&#160;    }</div>
<div class="line"><a name="l01847"></a><span class="lineno"> 1847</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l01848"></a><span class="lineno"> 1848</span>&#160;      <span class="comment">//      interpolate_ustag2fieldcent_donor(stage, boundtime, timeorder, numtimeorders, pb, pstag, myupoint, pf);</span></div>
<div class="line"><a name="l01849"></a><span class="lineno"> 1849</span>&#160;    }</div>
<div class="line"><a name="l01850"></a><span class="lineno"> 1850</span>&#160;</div>
<div class="line"><a name="l01852"></a><span class="lineno"> 1852</span>&#160;    <span class="comment">// now myupoint contains centered point conserved quantities ready for inversion</span></div>
<div class="line"><a name="l01854"></a><span class="lineno"> 1854</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01855"></a><span class="lineno"> 1855</span>&#160;  }</div>
<div class="line"><a name="l01856"></a><span class="lineno"> 1856</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l01857"></a><span class="lineno"> 1857</span>&#160;    <span class="comment">// utoinvert never reassigned from global a_utoinvert assignment since if here not doing FLUXCTSTAG</span></div>
<div class="line"><a name="l01858"></a><span class="lineno"> 1858</span>&#160;    myupoint=utoinvert;</div>
<div class="line"><a name="l01859"></a><span class="lineno"> 1859</span>&#160;  }</div>
<div class="line"><a name="l01860"></a><span class="lineno"> 1860</span>&#160;</div>
<div class="line"><a name="l01861"></a><span class="lineno"> 1861</span>&#160;</div>
<div class="line"><a name="l01862"></a><span class="lineno"> 1862</span>&#160;</div>
<div class="line"><a name="l01863"></a><span class="lineno"> 1863</span>&#160;</div>
<div class="line"><a name="l01864"></a><span class="lineno"> 1864</span>&#160;</div>
<div class="line"><a name="l01865"></a><span class="lineno"> 1865</span>&#160;</div>
<div class="line"><a name="l01866"></a><span class="lineno"> 1866</span>&#160;</div>
<div class="line"><a name="l01867"></a><span class="lineno"> 1867</span>&#160;</div>
<div class="line"><a name="l01869"></a><span class="lineno"> 1869</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01870"></a><span class="lineno"> 1870</span>&#160;  <span class="comment">// INVERT [loop only over &quot;centered&quot; cells]</span></div>
<div class="line"><a name="l01871"></a><span class="lineno"> 1871</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01873"></a><span class="lineno"> 1873</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01874"></a><span class="lineno"> 1874</span>&#160;</div>
<div class="line"><a name="l01875"></a><span class="lineno"> 1875</span>&#160;  <span class="comment">// get loop range</span></div>
<div class="line"><a name="l01876"></a><span class="lineno"> 1876</span>&#160;  get_inversion_startendindices(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ab5c60dcb37b1f7e5642525031cd5cbcf">Uconsevolveloop</a>,&amp;is,&amp;ie,&amp;js,&amp;je,&amp;ks,&amp;ke);</div>
<div class="line"><a name="l01877"></a><span class="lineno"> 1877</span>&#160;</div>
<div class="line"><a name="l01878"></a><span class="lineno"> 1878</span>&#160;<span class="preprocessor">#pragma omp parallel OPENMPGLOBALPRIVATEFORINVERSION</span></div>
<div class="line"><a name="l01879"></a><span class="lineno"> 1879</span>&#160;<span class="preprocessor"></span>  {</div>
<div class="line"><a name="l01880"></a><span class="lineno"> 1880</span>&#160;    <span class="keywordtype">int</span> pl,pliter,<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>,<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>,k;</div>
<div class="line"><a name="l01881"></a><span class="lineno"> 1881</span>&#160;    <span class="keyword">struct </span><a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> geomdontuse;</div>
<div class="line"><a name="l01882"></a><span class="lineno"> 1882</span>&#160;    <span class="keyword">struct </span><a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom=&amp;geomdontuse;</div>
<div class="line"><a name="l01883"></a><span class="lineno"> 1883</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> prbefore[NPR];</div>
<div class="line"><a name="l01884"></a><span class="lineno"> 1884</span>&#160;    <span class="keyword">struct </span><a class="code" href="../../db/d3a/structof__newtonstats.html">of_newtonstats</a> newtonstats;  setnewtonstatsdefault(&amp;newtonstats);</div>
<div class="line"><a name="l01885"></a><span class="lineno"> 1885</span>&#160;    <span class="keywordtype">int</span> showmessages=1;</div>
<div class="line"><a name="l01886"></a><span class="lineno"> 1886</span>&#160;    <span class="keywordtype">int</span> allowlocalfailurefixandnoreport=1; <span class="comment">// allow local fixups</span></div>
<div class="line"><a name="l01887"></a><span class="lineno"> 1887</span>&#160;</div>
<div class="line"><a name="l01888"></a><span class="lineno"> 1888</span>&#160;    <span class="comment">// setup default eomtype</span></div>
<div class="line"><a name="l01889"></a><span class="lineno"> 1889</span>&#160;    <span class="keywordtype">int</span> eomtype;</div>
<div class="line"><a name="l01890"></a><span class="lineno"> 1890</span>&#160;    </div>
<div class="line"><a name="l01891"></a><span class="lineno"> 1891</span>&#160;    <a class="code" href="../../d5/d7b/global_8openmploops_8h.html#a1389db2daf5bd9e94918090c253a16c9">OPENMP3DLOOPVARSDEFINE</a>;  <a class="code" href="../../d5/d7b/global_8openmploops_8h.html#a8de37da93c3462c536ef830f2fbaee61" title="forced to be a computational loop, so start/stop cannot already have shifts in them (which is normal ...">OPENMP3DLOOPSETUP</a>(is,ie,js,je,ks,ke);</div>
<div class="line"><a name="l01892"></a><span class="lineno"> 1892</span>&#160;</div>
<div class="line"><a name="l01893"></a><span class="lineno"> 1893</span>&#160;    <span class="comment">// initialize counters</span></div>
<div class="line"><a name="l01894"></a><span class="lineno"> 1894</span>&#160;    newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a073783ba864c07681c8999a67162202b">nstroke</a>=newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a83280998e47831044a7e35299495a9bb">lntries</a>=0;</div>
<div class="line"><a name="l01895"></a><span class="lineno"> 1895</span>&#160;</div>
<div class="line"><a name="l01896"></a><span class="lineno"> 1896</span>&#160;</div>
<div class="line"><a name="l01897"></a><span class="lineno"> 1897</span>&#160;<span class="preprocessor">#pragma omp for schedule(OPENMPVARYENDTIMESCHEDULE(),OPENMPCHUNKSIZE(blocksize)) reduction(+: nstroke)</span></div>
<div class="line"><a name="l01898"></a><span class="lineno"> 1898</span>&#160;<span class="preprocessor"></span>    <a class="code" href="../../d5/d7b/global_8openmploops_8h.html#a9e48537d3cb58cc3a3765b8a18b43b15" title="Oddly, performance changes by 10% when changing how start and stop blockijk (and fixing how used too ...">OPENMP3DLOOPBLOCK</a>{</div>
<div class="line"><a name="l01899"></a><span class="lineno"> 1899</span>&#160;      <a class="code" href="../../df/d1c/global_8storage_8h.html#a96983b0c56e836f50cb7c1af16f59fb6">OPENMP3DLOOPBLOCK2IJK</a>(i,j,k);</div>
<div class="line"><a name="l01900"></a><span class="lineno"> 1900</span>&#160; </div>
<div class="line"><a name="l01901"></a><span class="lineno"> 1901</span>&#160;      <span class="comment">// setup default eomtype</span></div>
<div class="line"><a name="l01902"></a><span class="lineno"> 1902</span>&#160;      <span class="comment">// KORALTODO: Note that eomtype should have been set from source(), but different loop.  But not using this &quot;orig&quot;  method for koral evolution, so ok.</span></div>
<div class="line"><a name="l01903"></a><span class="lineno"> 1903</span>&#160;      eomtype=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aa28b06d889a02621b45edc716bfb2d01">EOMDEFAULT</a>;</div>
<div class="line"><a name="l01904"></a><span class="lineno"> 1904</span>&#160;</div>
<div class="line"><a name="l01905"></a><span class="lineno"> 1905</span>&#160;      <span class="comment">// set geometry for centered zone to be updated</span></div>
<div class="line"><a name="l01906"></a><span class="lineno"> 1906</span>&#160;      <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a3059ed7bfcfb692cbe8014d55fd7c1e4">get_geometry</a>(i, j, k, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8936711f57f82d1fc75c21fa2894e1c6">CENT</a>, ptrgeom);</div>
<div class="line"><a name="l01907"></a><span class="lineno"> 1907</span>&#160;</div>
<div class="line"><a name="l01908"></a><span class="lineno"> 1908</span>&#160;      </div>
<div class="line"><a name="l01909"></a><span class="lineno"> 1909</span>&#160;      <span class="comment">// invert U-&gt;p</span></div>
<div class="line"><a name="l01910"></a><span class="lineno"> 1910</span>&#160;      <span class="keywordflow">if</span>(finalstep){ <span class="comment">// last call, so ucum is cooked and ready to eat!</span></div>
<div class="line"><a name="l01911"></a><span class="lineno"> 1911</span>&#160;        <span class="comment">// store guess for diss_compute before changed by normal inversion</span></div>
<div class="line"><a name="l01912"></a><span class="lineno"> 1912</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl) prbefore[pl]=<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pf,i,j,k,pl);</div>
<div class="line"><a name="l01913"></a><span class="lineno"> 1913</span>&#160;</div>
<div class="line"><a name="l01914"></a><span class="lineno"> 1914</span>&#160;        <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dissmeasure=-1.0; <span class="comment">// assume energy try ok</span></div>
<div class="line"><a name="l01915"></a><span class="lineno"> 1915</span>&#160;        <span class="keywordtype">int</span> whichcap=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a4b6c6060c025e15f1d92aae3dcb9365b" title="which cap type to place in rad inversion">CAPTYPEBASIC</a>;</div>
<div class="line"><a name="l01916"></a><span class="lineno"> 1916</span>&#160;        <span class="keywordtype">int</span> whichmethod=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aef33cf4e6c2534137907bc2eaefdb224">MODEPICKBEST</a>; <span class="comment">// try to choose best option for this &quot;external&quot; inversion</span></div>
<div class="line"><a name="l01917"></a><span class="lineno"> 1917</span>&#160;        <span class="keywordtype">int</span> modprim=0;</div>
<div class="line"><a name="l01918"></a><span class="lineno"> 1918</span>&#160;        <span class="keywordtype">int</span> checkoninversiongas=<a class="code" href="../../da/d3e/definit_8h.html#a5dc18e6d15e4420586d45d912fccebac" title="whether to check on inversion and report problem Also, use diag_fixup() to account for changes in U w...">CHECKONINVERSION</a>;</div>
<div class="line"><a name="l01919"></a><span class="lineno"> 1919</span>&#160;        <span class="keywordtype">int</span> checkoninversionrad=<a class="code" href="../../da/d3e/definit_8h.html#a70e4418eb8c6479afc202024b46ad581">CHECKONINVERSIONRAD</a>;</div>
<div class="line"><a name="l01920"></a><span class="lineno"> 1920</span>&#160;        <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(<a class="code" href="../../d1/d3e/utoprimgen_8c.html#a7e078cc9a354495bc85554d875a705d9" title="General explicit inversion of U[MHD]-&gt;P[MHD] and also inverts scalars. Inverts radiation if(EOMRADTYP...">Utoprimgen</a>(showmessages,checkoninversiongas,checkoninversionrad,allowlocalfailurefixandnoreport, finalstep,&amp;eomtype,whichcap,whichmethod,modprim,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7d1dc231c422450f87fdb3e71b4a7aff" title="defines how Utoprimgen is used">EVOLVEUTOPRIM</a>,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a15d073255fcc246f09aa26337e643d22" title="defines data return types for primtoU() and primtoflux()">UEVOLVE</a>,<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(myupoint,i,j,k), NULL, ptrgeom, dissmeasure, <a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(pi,i,j,k), <a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(pf,i,j,k),&amp;newtonstats),<span class="stringliteral">&quot;step_ch.c:advance()&quot;</span>, <span class="stringliteral">&quot;Utoprimgen&quot;</span>, 1);</div>
<div class="line"><a name="l01921"></a><span class="lineno"> 1921</span>&#160;        <a class="code" href="../../d8/d5b/defs_8general_8h.html#a5f1c4a4bf07f7a6010404484cb9e6b50">nstroke</a>+=newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a073783ba864c07681c8999a67162202b">nstroke</a>; newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a073783ba864c07681c8999a67162202b">nstroke</a>=newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a83280998e47831044a7e35299495a9bb">lntries</a>=0;</div>
<div class="line"><a name="l01922"></a><span class="lineno"> 1922</span>&#160;</div>
<div class="line"><a name="l01923"></a><span class="lineno"> 1923</span>&#160;</div>
<div class="line"><a name="l01924"></a><span class="lineno"> 1924</span>&#160;<span class="preprocessor">#if(DODISS||DODISSVSR)</span></div>
<div class="line"><a name="l01925"></a><span class="lineno"> 1925</span>&#160;<span class="preprocessor"></span>        <span class="comment">// then see what entropy inversion would give</span></div>
<div class="line"><a name="l01926"></a><span class="lineno"> 1926</span>&#160;        diss_compute(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7d1dc231c422450f87fdb3e71b4a7aff" title="defines how Utoprimgen is used">EVOLVEUTOPRIM</a>,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a15d073255fcc246f09aa26337e643d22" title="defines data return types for primtoU() and primtoflux()">UEVOLVE</a>,<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(myupoint,i,j,k),ptrgeom,prbefore,<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(pf,i,j,k),&amp;newtonstats);</div>
<div class="line"><a name="l01927"></a><span class="lineno"> 1927</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01928"></a><span class="lineno"> 1928</span>&#160;<span class="preprocessor"></span> </div>
<div class="line"><a name="l01929"></a><span class="lineno"> 1929</span>&#160;      }</div>
<div class="line"><a name="l01930"></a><span class="lineno"> 1930</span>&#160;      <span class="keywordflow">else</span>{ <span class="comment">// otherwise still iterating on primitives</span></div>
<div class="line"><a name="l01931"></a><span class="lineno"> 1931</span>&#160;        <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dissmeasure=-1.0; <span class="comment">// assume energy try ok</span></div>
<div class="line"><a name="l01932"></a><span class="lineno"> 1932</span>&#160;        <span class="keywordtype">int</span> whichcap=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a4b6c6060c025e15f1d92aae3dcb9365b" title="which cap type to place in rad inversion">CAPTYPEBASIC</a>;</div>
<div class="line"><a name="l01933"></a><span class="lineno"> 1933</span>&#160;        <span class="keywordtype">int</span> whichmethod=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aef33cf4e6c2534137907bc2eaefdb224">MODEPICKBEST</a>; <span class="comment">// try to choose best option for this &quot;external&quot; inversion</span></div>
<div class="line"><a name="l01934"></a><span class="lineno"> 1934</span>&#160;        <span class="keywordtype">int</span> modprim=0;</div>
<div class="line"><a name="l01935"></a><span class="lineno"> 1935</span>&#160;        <span class="keywordtype">int</span> checkoninversiongas=<a class="code" href="../../da/d3e/definit_8h.html#a5dc18e6d15e4420586d45d912fccebac" title="whether to check on inversion and report problem Also, use diag_fixup() to account for changes in U w...">CHECKONINVERSION</a>;</div>
<div class="line"><a name="l01936"></a><span class="lineno"> 1936</span>&#160;        <span class="keywordtype">int</span> checkoninversionrad=<a class="code" href="../../da/d3e/definit_8h.html#a70e4418eb8c6479afc202024b46ad581">CHECKONINVERSIONRAD</a>;</div>
<div class="line"><a name="l01937"></a><span class="lineno"> 1937</span>&#160;        <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(<a class="code" href="../../d1/d3e/utoprimgen_8c.html#a7e078cc9a354495bc85554d875a705d9" title="General explicit inversion of U[MHD]-&gt;P[MHD] and also inverts scalars. Inverts radiation if(EOMRADTYP...">Utoprimgen</a>(showmessages,checkoninversiongas,checkoninversionrad,allowlocalfailurefixandnoreport, finalstep,&amp;eomtype,whichcap,whichmethod,modprim,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7d1dc231c422450f87fdb3e71b4a7aff" title="defines how Utoprimgen is used">EVOLVEUTOPRIM</a>,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a15d073255fcc246f09aa26337e643d22" title="defines data return types for primtoU() and primtoflux()">UEVOLVE</a>,<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(myupoint,i,j,k), NULL, ptrgeom, dissmeasure, <a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(pi,i,j,k), <a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(pf,i,j,k),&amp;newtonstats),<span class="stringliteral">&quot;step_ch.c:advance()&quot;</span>, <span class="stringliteral">&quot;Utoprimgen&quot;</span>, 1);</div>
<div class="line"><a name="l01938"></a><span class="lineno"> 1938</span>&#160;        <a class="code" href="../../d8/d5b/defs_8general_8h.html#a5f1c4a4bf07f7a6010404484cb9e6b50">nstroke</a>+=newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a073783ba864c07681c8999a67162202b">nstroke</a>; newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a073783ba864c07681c8999a67162202b">nstroke</a>=newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a83280998e47831044a7e35299495a9bb">lntries</a>=0;</div>
<div class="line"><a name="l01939"></a><span class="lineno"> 1939</span>&#160;      }</div>
<div class="line"><a name="l01940"></a><span class="lineno"> 1940</span>&#160;</div>
<div class="line"><a name="l01941"></a><span class="lineno"> 1941</span>&#160;</div>
<div class="line"><a name="l01942"></a><span class="lineno"> 1942</span>&#160;</div>
<div class="line"><a name="l01943"></a><span class="lineno"> 1943</span>&#160;</div>
<div class="line"><a name="l01944"></a><span class="lineno"> 1944</span>&#160;      </div>
<div class="line"><a name="l01945"></a><span class="lineno"> 1945</span>&#160;<span class="preprocessor">#if(SPLITNPR)</span></div>
<div class="line"><a name="l01946"></a><span class="lineno"> 1946</span>&#160;<span class="preprocessor"></span>      <span class="comment">// don&#39;t update metric if only doing B1-B3</span></div>
<div class="line"><a name="l01947"></a><span class="lineno"> 1947</span>&#160;      <span class="keywordflow">if</span>(<a class="code" href="../../d8/d5b/defs_8general_8h.html#aa2010d23a21177641277f5119a2705c7">advancepassnumber</a>==-1 || <a class="code" href="../../d8/d5b/defs_8general_8h.html#aa2010d23a21177641277f5119a2705c7">advancepassnumber</a>==1)</div>
<div class="line"><a name="l01948"></a><span class="lineno"> 1948</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01949"></a><span class="lineno"> 1949</span>&#160;<span class="preprocessor"></span>        {</div>
<div class="line"><a name="l01950"></a><span class="lineno"> 1950</span>&#160;          <span class="comment">// immediate local (i.e. 1-zone) fix</span></div>
<div class="line"><a name="l01951"></a><span class="lineno"> 1951</span>&#160;<span class="preprocessor">#if(FIXUPZONES==FIXUP1ZONE)</span></div>
<div class="line"><a name="l01952"></a><span class="lineno"> 1952</span>&#160;<span class="preprocessor"></span>          <span class="comment">// SUPERGODMARK: Below should differentiate beteween whether want negative densities fixed or not, but right now fixup1zone() does all</span></div>
<div class="line"><a name="l01953"></a><span class="lineno"> 1953</span>&#160;          <span class="keywordflow">if</span>((<a class="code" href="../../da/d3e/definit_8h.html#a01d34fa922c4eaac94e27f2179523626" title="whether to allow negative internal energy in substep UTOPRIMFAILRETURNTYPE==UTOPRIMRETURNADJUSTED sho...">STEPOVERNEGU</a>==0)||(<a class="code" href="../../da/d3e/definit_8h.html#a23eeede57657104811b4f7e5e7dda656" title="seems to make things worse (more failures, but also worse failures)">STEPOVERNEGRHO</a>==0)||(<a class="code" href="../../d8/dc0/init_8h.html#a352ef6d348d5c3986dc77165755b8733">STEPOVERNEGRHOU</a>==0)||(finalstep)){</div>
<div class="line"><a name="l01954"></a><span class="lineno"> 1954</span>&#160;            <span class="keywordtype">int</span> docorrectucons=0;</div>
<div class="line"><a name="l01955"></a><span class="lineno"> 1955</span>&#160;            <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(fixup1zone(docorrectucons,<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(pf,i,j,k),<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(useducum,i,j,k), ptrgeom,finalstep),<span class="stringliteral">&quot;fixup.c:fixup()&quot;</span>, <span class="stringliteral">&quot;fixup1zone()&quot;</span>, 1);</div>
<div class="line"><a name="l01956"></a><span class="lineno"> 1956</span>&#160;          }</div>
<div class="line"><a name="l01957"></a><span class="lineno"> 1957</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01958"></a><span class="lineno"> 1958</span>&#160;<span class="preprocessor"></span>        }</div>
<div class="line"><a name="l01959"></a><span class="lineno"> 1959</span>&#160;</div>
<div class="line"><a name="l01960"></a><span class="lineno"> 1960</span>&#160;</div>
<div class="line"><a name="l01961"></a><span class="lineno"> 1961</span>&#160;    }<span class="comment">// end COMPZLOOP</span></div>
<div class="line"><a name="l01962"></a><span class="lineno"> 1962</span>&#160;  }<span class="comment">// end parallel section</span></div>
<div class="line"><a name="l01963"></a><span class="lineno"> 1963</span>&#160;</div>
<div class="line"><a name="l01964"></a><span class="lineno"> 1964</span>&#160;</div>
<div class="line"><a name="l01965"></a><span class="lineno"> 1965</span>&#160;</div>
<div class="line"><a name="l01966"></a><span class="lineno"> 1966</span>&#160;</div>
<div class="line"><a name="l01967"></a><span class="lineno"> 1967</span>&#160;</div>
<div class="line"><a name="l01968"></a><span class="lineno"> 1968</span>&#160;</div>
<div class="line"><a name="l01969"></a><span class="lineno"> 1969</span>&#160;</div>
<div class="line"><a name="l01970"></a><span class="lineno"> 1970</span>&#160;</div>
<div class="line"><a name="l01971"></a><span class="lineno"> 1971</span>&#160;</div>
<div class="line"><a name="l01972"></a><span class="lineno"> 1972</span>&#160;<span class="preprocessor">#if(ASYMDIAGCHECK)</span></div>
<div class="line"><a name="l01973"></a><span class="lineno"> 1973</span>&#160;<span class="preprocessor"></span>  dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;useducum in advance\n&quot;</span>);</div>
<div class="line"><a name="l01974"></a><span class="lineno"> 1974</span>&#160;  asym_compute_2(useducum);</div>
<div class="line"><a name="l01975"></a><span class="lineno"> 1975</span>&#160;</div>
<div class="line"><a name="l01976"></a><span class="lineno"> 1976</span>&#160;  dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;ENDING steppart=%d nstep=%ld\n&quot;</span>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a70170b90229f9fc05eebf8508a685c70">steppart</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a1a1088d87617078680f1fd0f0d707384">nstep</a>);</div>
<div class="line"><a name="l01977"></a><span class="lineno"> 1977</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01978"></a><span class="lineno"> 1978</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01979"></a><span class="lineno"> 1979</span>&#160;</div>
<div class="line"><a name="l01980"></a><span class="lineno"> 1980</span>&#160;</div>
<div class="line"><a name="l01981"></a><span class="lineno"> 1981</span>&#160;</div>
<div class="line"><a name="l01983"></a><span class="lineno"> 1983</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01984"></a><span class="lineno"> 1984</span>&#160;  <span class="comment">// If not fixing up primitives after inversion immediately, then fix up all zones at once afterwards</span></div>
<div class="line"><a name="l01985"></a><span class="lineno"> 1985</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l01987"></a><span class="lineno"> 1987</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01988"></a><span class="lineno"> 1988</span>&#160;<span class="preprocessor">#if(SPLITNPR)</span></div>
<div class="line"><a name="l01989"></a><span class="lineno"> 1989</span>&#160;<span class="preprocessor"></span>  <span class="comment">// don&#39;t update metric if only doing B1-B3</span></div>
<div class="line"><a name="l01990"></a><span class="lineno"> 1990</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../d8/d5b/defs_8general_8h.html#aa2010d23a21177641277f5119a2705c7">advancepassnumber</a>==-1 || <a class="code" href="../../d8/d5b/defs_8general_8h.html#aa2010d23a21177641277f5119a2705c7">advancepassnumber</a>==1)</div>
<div class="line"><a name="l01991"></a><span class="lineno"> 1991</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01992"></a><span class="lineno"> 1992</span>&#160;<span class="preprocessor"></span>    {</div>
<div class="line"><a name="l01993"></a><span class="lineno"> 1993</span>&#160;<span class="preprocessor">#if(FIXUPZONES==FIXUPALLZONES)</span></div>
<div class="line"><a name="l01994"></a><span class="lineno"> 1994</span>&#160;<span class="preprocessor"></span>      fixup(stage,pf,useducum,finalstep);</div>
<div class="line"><a name="l01995"></a><span class="lineno"> 1995</span>&#160;<span class="preprocessor">#endif  </span></div>
<div class="line"><a name="l01996"></a><span class="lineno"> 1996</span>&#160;<span class="preprocessor"></span>    }</div>
<div class="line"><a name="l01997"></a><span class="lineno"> 1997</span>&#160;</div>
<div class="line"><a name="l01998"></a><span class="lineno"> 1998</span>&#160;</div>
<div class="line"><a name="l02000"></a><span class="lineno"> 2000</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02001"></a><span class="lineno"> 2001</span>&#160;  <span class="comment">// Determine next timestep from waves, fluxes, and source updates</span></div>
<div class="line"><a name="l02002"></a><span class="lineno"> 2002</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02004"></a><span class="lineno"> 2004</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02005"></a><span class="lineno"> 2005</span>&#160;</div>
<div class="line"><a name="l02006"></a><span class="lineno"> 2006</span>&#160;  prepare_globaldt(truestep,ndt1,ndt2,ndt3,accdt,accdti,accdtj,accdtk,gravitydt,gravitydti,gravitydtj,gravitydtk,ndt);</div>
<div class="line"><a name="l02007"></a><span class="lineno"> 2007</span>&#160;</div>
<div class="line"><a name="l02008"></a><span class="lineno"> 2008</span>&#160;</div>
<div class="line"><a name="l02009"></a><span class="lineno"> 2009</span>&#160;</div>
<div class="line"><a name="l02010"></a><span class="lineno"> 2010</span>&#160;<span class="preprocessor">#if(PRODUCTION==0)</span></div>
<div class="line"><a name="l02011"></a><span class="lineno"> 2011</span>&#160;<span class="preprocessor"></span>  trifprintf( <span class="stringliteral">&quot;2f&quot;</span>);</div>
<div class="line"><a name="l02012"></a><span class="lineno"> 2012</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02013"></a><span class="lineno"> 2013</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l02014"></a><span class="lineno"> 2014</span>&#160;  <span class="keywordflow">return</span> (0);</div>
<div class="line"><a name="l02015"></a><span class="lineno"> 2015</span>&#160;}</div>
<div class="line"><a name="l02016"></a><span class="lineno"> 2016</span>&#160;</div>
<div class="line"><a name="l02017"></a><span class="lineno"> 2017</span>&#160;</div>
<div class="line"><a name="l02018"></a><span class="lineno"> 2018</span>&#160;</div>
<div class="line"><a name="l02019"></a><span class="lineno"> 2019</span>&#160;</div>
<div class="line"><a name="l02020"></a><span class="lineno"> 2020</span>&#160;</div>
<div class="line"><a name="l02021"></a><span class="lineno"> 2021</span>&#160;</div>
<div class="line"><a name="l02022"></a><span class="lineno"> 2022</span>&#160;</div>
<div class="line"><a name="l02023"></a><span class="lineno"> 2023</span>&#160;</div>
<div class="line"><a name="l02024"></a><span class="lineno"> 2024</span>&#160;</div>
<div class="line"><a name="l02025"></a><span class="lineno"> 2025</span>&#160;</div>
<div class="line"><a name="l02026"></a><span class="lineno"> 2026</span>&#160;</div>
<div class="line"><a name="l02027"></a><span class="lineno"> 2027</span>&#160;</div>
<div class="line"><a name="l02028"></a><span class="lineno"> 2028</span>&#160;</div>
<div class="line"><a name="l02029"></a><span class="lineno"> 2029</span>&#160;</div>
<div class="line"><a name="l02030"></a><span class="lineno"> 2030</span>&#160;</div>
<div class="line"><a name="l02031"></a><span class="lineno"> 2031</span>&#160;</div>
<div class="line"><a name="l02032"></a><span class="lineno"> 2032</span>&#160;</div>
<div class="line"><a name="l02035"></a><span class="lineno"> 2035</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> advance_finitevolume(</div>
<div class="line"><a name="l02036"></a><span class="lineno"> 2036</span>&#160;                                <span class="keywordtype">int</span> truestep,</div>
<div class="line"><a name="l02037"></a><span class="lineno"> 2037</span>&#160;                                <span class="keywordtype">int</span> stage,</div>
<div class="line"><a name="l02038"></a><span class="lineno"> 2038</span>&#160;                                <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pi)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR],</div>
<div class="line"><a name="l02039"></a><span class="lineno"> 2039</span>&#160;                                <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pb)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR],</div>
<div class="line"><a name="l02040"></a><span class="lineno"> 2040</span>&#160;                                <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pf)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR],</div>
<div class="line"><a name="l02041"></a><span class="lineno"> 2041</span>&#160;                                <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pstag)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR],</div>
<div class="line"><a name="l02042"></a><span class="lineno"> 2042</span>&#160;                                <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pl_ct)[<a class="code" href="../../df/d1c/global_8storage_8h.html#a917a6677d5e3b38aa54aa577978bf823" title="123">NSTORE1</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR2INTERP], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*pr_ct)[<a class="code" href="../../df/d1c/global_8storage_8h.html#a917a6677d5e3b38aa54aa577978bf823" title="123">NSTORE1</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR2INTERP],</div>
<div class="line"><a name="l02043"></a><span class="lineno"> 2043</span>&#160;                                <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*F1)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*F2)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*F3)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>],</div>
<div class="line"><a name="l02044"></a><span class="lineno"> 2044</span>&#160;                                <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*vpot)[<a class="code" href="../../df/d1c/global_8storage_8h.html#a917a6677d5e3b38aa54aa577978bf823" title="123">NSTORE1</a>+<a class="code" href="../../df/d1c/global_8storage_8h.html#a1c452bce7a227fd9f2c8f937a3c7841c">SHIFTSTORE1</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>+<a class="code" href="../../df/d1c/global_8storage_8h.html#adfe8c351b7f60e189dbd9bfca47af5c5">SHIFTSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>+<a class="code" href="../../df/d1c/global_8storage_8h.html#a6dc540b0373d80d3ea2db53d03a9fa72">SHIFTSTORE3</a>],</div>
<div class="line"><a name="l02045"></a><span class="lineno"> 2045</span>&#160;                                <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*ui)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR],</div>
<div class="line"><a name="l02046"></a><span class="lineno"> 2046</span>&#160;                                <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*uf)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR],</div>
<div class="line"><a name="l02047"></a><span class="lineno"> 2047</span>&#160;                                <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*ucum)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR], </div>
<div class="line"><a name="l02048"></a><span class="lineno"> 2048</span>&#160;                                <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUf, </div>
<div class="line"><a name="l02049"></a><span class="lineno"> 2049</span>&#160;                                <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUnew, </div>
<div class="line"><a name="l02050"></a><span class="lineno"> 2050</span>&#160;                                <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a0263684ebff8e72a2f0de1861393595f">SFTYPE</a> fluxdt,</div>
<div class="line"><a name="l02051"></a><span class="lineno"> 2051</span>&#160;                                <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a0263684ebff8e72a2f0de1861393595f">SFTYPE</a> boundtime,</div>
<div class="line"><a name="l02052"></a><span class="lineno"> 2052</span>&#160;                                <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a0263684ebff8e72a2f0de1861393595f">SFTYPE</a> fluxtime,</div>
<div class="line"><a name="l02053"></a><span class="lineno"> 2053</span>&#160;                                <span class="keywordtype">int</span> timeorder, <span class="keywordtype">int</span> numtimeorders,</div>
<div class="line"><a name="l02054"></a><span class="lineno"> 2054</span>&#160;                                <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *ndt)</div>
<div class="line"><a name="l02055"></a><span class="lineno"> 2055</span>&#160;{</div>
<div class="line"><a name="l02056"></a><span class="lineno"> 2056</span>&#160;  <span class="keywordtype">int</span> sc;</div>
<div class="line"><a name="l02057"></a><span class="lineno"> 2057</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ndt1, ndt2, ndt3;</div>
<div class="line"><a name="l02058"></a><span class="lineno"> 2058</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dUtot;</div>
<div class="line"><a name="l02059"></a><span class="lineno"> 2059</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> idx1,idx2;</div>
<div class="line"><a name="l02060"></a><span class="lineno"> 2060</span>&#160;  <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a0263684ebff8e72a2f0de1861393595f">SFTYPE</a> dt4diag;</div>
<div class="line"><a name="l02061"></a><span class="lineno"> 2061</span>&#160;  <span class="keyword">static</span> <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a0263684ebff8e72a2f0de1861393595f">SFTYPE</a> dt4diag_willbe=0;</div>
<div class="line"><a name="l02062"></a><span class="lineno"> 2062</span>&#160;  <span class="keywordtype">int</span> finalstep,initialstep;</div>
<div class="line"><a name="l02063"></a><span class="lineno"> 2063</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> accdt, accdt_ij;</div>
<div class="line"><a name="l02064"></a><span class="lineno"> 2064</span>&#160;  <span class="keywordtype">int</span> accdti,accdtj,accdtk;</div>
<div class="line"><a name="l02065"></a><span class="lineno"> 2065</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gravitydt, gravitydt_ij;</div>
<div class="line"><a name="l02066"></a><span class="lineno"> 2066</span>&#160;  <span class="keywordtype">int</span> gravitydti,gravitydtj,gravitydtk;</div>
<div class="line"><a name="l02067"></a><span class="lineno"> 2067</span>&#160;  <span class="keywordtype">int</span> enerregion;</div>
<div class="line"><a name="l02068"></a><span class="lineno"> 2068</span>&#160;  <span class="keywordtype">int</span> *localenerpos;</div>
<div class="line"><a name="l02069"></a><span class="lineno"> 2069</span>&#160;  <span class="keywordtype">int</span> jj;</div>
<div class="line"><a name="l02070"></a><span class="lineno"> 2070</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*utoinvert)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR];</div>
<div class="line"><a name="l02071"></a><span class="lineno"> 2071</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*tempucum)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR];</div>
<div class="line"><a name="l02072"></a><span class="lineno"> 2072</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*useducum)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR];</div>
<div class="line"><a name="l02073"></a><span class="lineno"> 2073</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*myupoint)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR];</div>
<div class="line"><a name="l02074"></a><span class="lineno"> 2074</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*ucumformetric)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR];</div>
<div class="line"><a name="l02075"></a><span class="lineno"> 2075</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*dUgeomarray)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR];</div>
<div class="line"><a name="l02076"></a><span class="lineno"> 2076</span>&#160;  <span class="comment">// staggered field function:</span></div>
<div class="line"><a name="l02077"></a><span class="lineno"> 2077</span>&#160;  <span class="keywordtype">int</span> whichpltoavg[NPR];</div>
<div class="line"><a name="l02078"></a><span class="lineno"> 2078</span>&#160;  <span class="keywordtype">int</span> ifnotavgthencopy[NPR];</div>
<div class="line"><a name="l02079"></a><span class="lineno"> 2079</span>&#160;  <span class="keywordtype">int</span> docons,dosource;</div>
<div class="line"><a name="l02080"></a><span class="lineno"> 2080</span>&#160;  <span class="keywordtype">int</span> locpl[NPR];</div>
<div class="line"><a name="l02081"></a><span class="lineno"> 2081</span>&#160;  <span class="keywordtype">int</span> is,ie,js,je,ks,ke;</div>
<div class="line"><a name="l02082"></a><span class="lineno"> 2082</span>&#160;  <span class="keywordtype">int</span> doingextrashiftforstag;</div>
<div class="line"><a name="l02083"></a><span class="lineno"> 2083</span>&#160;</div>
<div class="line"><a name="l02084"></a><span class="lineno"> 2084</span>&#160;</div>
<div class="line"><a name="l02085"></a><span class="lineno"> 2085</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a11c4e99e1493d0c1914ad1ab313ea472">FLUXB</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0b6762cef74e396f50a83864bb53fb6c">FLUXCTSTAG</a>){</div>
<div class="line"><a name="l02086"></a><span class="lineno"> 2086</span>&#160;    tempucum=<a class="code" href="../../df/d1c/global_8storage_8h.html#ad89dafa5d772b862a44b0f576983ead3" title="shifted pointer (a_s_) wrappers Couldn&#39;t figure out how to macrofy a_s_ or a_, so when changing have ...">GLOBALPOINT</a>(utemparray);</div>
<div class="line"><a name="l02087"></a><span class="lineno"> 2087</span>&#160;    useducum=tempucum; <span class="comment">// unless changed</span></div>
<div class="line"><a name="l02088"></a><span class="lineno"> 2088</span>&#160;  }</div>
<div class="line"><a name="l02089"></a><span class="lineno"> 2089</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l02090"></a><span class="lineno"> 2090</span>&#160;    <span class="comment">// no special shifting of indices occurs that requires loop shifting</span></div>
<div class="line"><a name="l02091"></a><span class="lineno"> 2091</span>&#160;    tempucum=ucum;</div>
<div class="line"><a name="l02092"></a><span class="lineno"> 2092</span>&#160;    useducum=ucum;</div>
<div class="line"><a name="l02093"></a><span class="lineno"> 2093</span>&#160;  }</div>
<div class="line"><a name="l02094"></a><span class="lineno"> 2094</span>&#160;</div>
<div class="line"><a name="l02095"></a><span class="lineno"> 2095</span>&#160;</div>
<div class="line"><a name="l02096"></a><span class="lineno"> 2096</span>&#160;  ucumformetric=<a class="code" href="../../df/d1c/global_8storage_8h.html#ad89dafa5d772b862a44b0f576983ead3" title="shifted pointer (a_s_) wrappers Couldn&#39;t figure out how to macrofy a_s_ or a_, so when changing have ...">GLOBALPOINT</a>(ucumformetric);<span class="comment">// temporary space for ucum for metric that is same time as &quot;pb&quot;, so not updated yet or is ui</span></div>
<div class="line"><a name="l02097"></a><span class="lineno"> 2097</span>&#160;  dUgeomarray=<a class="code" href="../../df/d1c/global_8storage_8h.html#ad89dafa5d772b862a44b0f576983ead3" title="shifted pointer (a_s_) wrappers Couldn&#39;t figure out how to macrofy a_s_ or a_, so when changing have ...">GLOBALPOINT</a>(dUgeomarray);<span class="comment">// temporary space for dUgeomarray</span></div>
<div class="line"><a name="l02098"></a><span class="lineno"> 2098</span>&#160;</div>
<div class="line"><a name="l02099"></a><span class="lineno"> 2099</span>&#160;</div>
<div class="line"><a name="l02100"></a><span class="lineno"> 2100</span>&#160;  </div>
<div class="line"><a name="l02101"></a><span class="lineno"> 2101</span>&#160;  {<span class="comment">// begin block</span></div>
<div class="line"><a name="l02102"></a><span class="lineno"> 2102</span>&#160;    <span class="keywordtype">int</span> pl,pliter;</div>
<div class="line"><a name="l02103"></a><span class="lineno"> 2103</span>&#160;    <span class="comment">// any cons</span></div>
<div class="line"><a name="l02104"></a><span class="lineno"> 2104</span>&#160;    docons=0;</div>
<div class="line"><a name="l02105"></a><span class="lineno"> 2105</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) docons+=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a42a3e0ccdd6805791cf169d439d305d6">do_conserved_integration</a>[pl];</div>
<div class="line"><a name="l02106"></a><span class="lineno"> 2106</span>&#160;    docons*=(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a55732148d2616d6d1f5d2abbe8710850">DOENOFLUX</a> == <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ac634a307561f486f9df8ba8a67c21c19">ENOFINITEVOLUME</a>);</div>
<div class="line"><a name="l02107"></a><span class="lineno"> 2107</span>&#160;</div>
<div class="line"><a name="l02108"></a><span class="lineno"> 2108</span>&#160;    <span class="comment">// any source</span></div>
<div class="line"><a name="l02109"></a><span class="lineno"> 2109</span>&#160;    dosource=0;</div>
<div class="line"><a name="l02110"></a><span class="lineno"> 2110</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) dosource+=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a619bd249bee29e34eb58716b9b88dc8a">do_source_integration</a>[pl];</div>
<div class="line"><a name="l02111"></a><span class="lineno"> 2111</span>&#160;    dosource*=(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a55732148d2616d6d1f5d2abbe8710850">DOENOFLUX</a> == ENOFINITEVOLUME);</div>
<div class="line"><a name="l02112"></a><span class="lineno"> 2112</span>&#160;  }<span class="comment">// end block</span></div>
<div class="line"><a name="l02113"></a><span class="lineno"> 2113</span>&#160;</div>
<div class="line"><a name="l02114"></a><span class="lineno"> 2114</span>&#160;</div>
<div class="line"><a name="l02116"></a><span class="lineno"> 2116</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02117"></a><span class="lineno"> 2117</span>&#160;  <span class="comment">// Setup loops and dt&#39;s</span></div>
<div class="line"><a name="l02118"></a><span class="lineno"> 2118</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02120"></a><span class="lineno"> 2120</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02121"></a><span class="lineno"> 2121</span>&#160;</div>
<div class="line"><a name="l02122"></a><span class="lineno"> 2122</span>&#160;  <span class="comment">// for CZLOOP:</span></div>
<div class="line"><a name="l02123"></a><span class="lineno"> 2123</span>&#160;  <span class="comment">// avoid looping over region outside active+ghost grid</span></div>
<div class="line"><a name="l02124"></a><span class="lineno"> 2124</span>&#160;  <span class="comment">// good because somewhat general and avoid bad inversions, etc.</span></div>
<div class="line"><a name="l02125"></a><span class="lineno"> 2125</span>&#160;  enerregion=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ada79b005f9c0caf71f9365c1e16d8c80">TRUEGLOBALWITHBNDENERREGION</a>;</div>
<div class="line"><a name="l02126"></a><span class="lineno"> 2126</span>&#160;  localenerpos=<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad41a84c69f5ec4a51492e96b4dc61ac4">enerposreg</a>[enerregion];</div>
<div class="line"><a name="l02127"></a><span class="lineno"> 2127</span>&#160;</div>
<div class="line"><a name="l02128"></a><span class="lineno"> 2128</span>&#160;</div>
<div class="line"><a name="l02129"></a><span class="lineno"> 2129</span>&#160;  accdt=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>; <span class="comment">// initially no limit to dt due to acceleration</span></div>
<div class="line"><a name="l02130"></a><span class="lineno"> 2130</span>&#160;  accdti=accdtj=accdtk=-100;</div>
<div class="line"><a name="l02131"></a><span class="lineno"> 2131</span>&#160;  gravitydt=BIG; <span class="comment">// initially no limit to dt due to time-changes in gravity</span></div>
<div class="line"><a name="l02132"></a><span class="lineno"> 2132</span>&#160;  gravitydti=gravitydtj=gravitydtk=-100;</div>
<div class="line"><a name="l02133"></a><span class="lineno"> 2133</span>&#160; </div>
<div class="line"><a name="l02134"></a><span class="lineno"> 2134</span>&#160;</div>
<div class="line"><a name="l02136"></a><span class="lineno"> 2136</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02137"></a><span class="lineno"> 2137</span>&#160;  <span class="comment">// set initialstep and finalstep to tell some procedures and diagnostic functions if should be accounting or not</span></div>
<div class="line"><a name="l02138"></a><span class="lineno"> 2138</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02140"></a><span class="lineno"> 2140</span>&#160;<span class="comment"></span>  if(timeorder==0){</div>
<div class="line"><a name="l02141"></a><span class="lineno"> 2141</span>&#160;    initialstep=1;</div>
<div class="line"><a name="l02142"></a><span class="lineno"> 2142</span>&#160;  }</div>
<div class="line"><a name="l02143"></a><span class="lineno"> 2143</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l02144"></a><span class="lineno"> 2144</span>&#160;    initialstep=0;</div>
<div class="line"><a name="l02145"></a><span class="lineno"> 2145</span>&#160;  }</div>
<div class="line"><a name="l02146"></a><span class="lineno"> 2146</span>&#160;</div>
<div class="line"><a name="l02147"></a><span class="lineno"> 2147</span>&#160;  <span class="keywordflow">if</span>(timeorder==numtimeorders-1){</div>
<div class="line"><a name="l02148"></a><span class="lineno"> 2148</span>&#160;    finalstep=1;</div>
<div class="line"><a name="l02149"></a><span class="lineno"> 2149</span>&#160;  }</div>
<div class="line"><a name="l02150"></a><span class="lineno"> 2150</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l02151"></a><span class="lineno"> 2151</span>&#160;    finalstep=0;</div>
<div class="line"><a name="l02152"></a><span class="lineno"> 2152</span>&#160;  }</div>
<div class="line"><a name="l02153"></a><span class="lineno"> 2153</span>&#160;</div>
<div class="line"><a name="l02155"></a><span class="lineno"> 2155</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02156"></a><span class="lineno"> 2156</span>&#160;  <span class="comment">// whether need to compute flux</span></div>
<div class="line"><a name="l02157"></a><span class="lineno"> 2157</span>&#160;  <span class="comment">// only compute flux if flux is added to get Uf or Ucum</span></div>
<div class="line"><a name="l02159"></a><span class="lineno"> 2159</span>&#160;<span class="comment"></span>  <span class="keywordtype">int</span> <a class="code" href="../../d8/d5b/defs_8general_8h.html#a03344fc1457035406713e8d85d215576" title="used for each region, related to global quantities _tot quantities here are global since used in rest...">doflux</a> = (CUf[2]!=0.0 || CUnew[1]!=0.0);</div>
<div class="line"><a name="l02160"></a><span class="lineno"> 2160</span>&#160;  <span class="comment">// current implicit dt factor</span></div>
<div class="line"><a name="l02161"></a><span class="lineno"> 2161</span>&#160;  <span class="comment">// Since we don&#39;t pass CUnew[NUMPREDTCUFS+timeorder], we assume never try to add M^i into U^{n+1} unless computed for current U^i or previous U^i</span></div>
<div class="line"><a name="l02162"></a><span class="lineno"> 2162</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUimp=&amp;CUf[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a214c8d806784f513292419871af16a25">NUMPREDTCUFS</a>+timeorder];</div>
<div class="line"><a name="l02163"></a><span class="lineno"> 2163</span>&#160;</div>
<div class="line"><a name="l02165"></a><span class="lineno"> 2165</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02166"></a><span class="lineno"> 2166</span>&#160;  <span class="comment">// set dt4diag for source diagnostics</span></div>
<div class="line"><a name="l02167"></a><span class="lineno"> 2167</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02169"></a><span class="lineno"> 2169</span>&#160;<span class="comment"></span>  <span class="keywordflow">if</span>(timeorder==numtimeorders-1 &amp;&amp; (<a class="code" href="../../d8/d5b/defs_8general_8h.html#a1a1088d87617078680f1fd0f0d707384">nstep</a>%<a class="code" href="../../da/d3e/definit_8h.html#a397b655d0a3bd70f6d2c007c3a9d7ebe">DIAGSOURCECOMPSTEP</a>==0) ){</div>
<div class="line"><a name="l02170"></a><span class="lineno"> 2170</span>&#160;    <span class="comment">// every 4 full steps as well as on final step of full step (otherwise diag_source_comp() too expensive)</span></div>
<div class="line"><a name="l02171"></a><span class="lineno"> 2171</span>&#160;    dt4diag=dt4diag_willbe;</div>
<div class="line"><a name="l02172"></a><span class="lineno"> 2172</span>&#160;    dt4diag_willbe=0;</div>
<div class="line"><a name="l02173"></a><span class="lineno"> 2173</span>&#160;  }</div>
<div class="line"><a name="l02174"></a><span class="lineno"> 2174</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l02175"></a><span class="lineno"> 2175</span>&#160;    dt4diag_willbe+=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a56db625f31229c5e8b208ff27d464931">dt</a>;</div>
<div class="line"><a name="l02176"></a><span class="lineno"> 2176</span>&#160;    dt4diag=-1.0;</div>
<div class="line"><a name="l02177"></a><span class="lineno"> 2177</span>&#160;  }</div>
<div class="line"><a name="l02178"></a><span class="lineno"> 2178</span>&#160;</div>
<div class="line"><a name="l02179"></a><span class="lineno"> 2179</span>&#160;</div>
<div class="line"><a name="l02181"></a><span class="lineno"> 2181</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02182"></a><span class="lineno"> 2182</span>&#160;  <span class="comment">// Setup loops</span></div>
<div class="line"><a name="l02183"></a><span class="lineno"> 2183</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02185"></a><span class="lineno"> 2185</span>&#160;<span class="comment"></span>  get_flux_startendindices(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ab5c60dcb37b1f7e5642525031cd5cbcf">Uconsevolveloop</a>,&amp;is,&amp;ie,&amp;js,&amp;je,&amp;ks,&amp;ke);</div>
<div class="line"><a name="l02186"></a><span class="lineno"> 2186</span>&#160;</div>
<div class="line"><a name="l02187"></a><span class="lineno"> 2187</span>&#160;</div>
<div class="line"><a name="l02188"></a><span class="lineno"> 2188</span>&#160;</div>
<div class="line"><a name="l02190"></a><span class="lineno"> 2190</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02191"></a><span class="lineno"> 2191</span>&#160;  <span class="comment">// Setup RK stuff</span></div>
<div class="line"><a name="l02192"></a><span class="lineno"> 2192</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02194"></a><span class="lineno"> 2194</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02195"></a><span class="lineno"> 2195</span>&#160;  <span class="comment">// setup RK&#39;s uinitial (needed since sometimes set ui=0 inside advance())</span></div>
<div class="line"><a name="l02196"></a><span class="lineno"> 2196</span>&#160;  <span class="comment">// unew should be read in, now assign to uinitial for finite volume method or normal method when dt=0.0 or moving grid</span></div>
<div class="line"><a name="l02197"></a><span class="lineno"> 2197</span>&#160;  <span class="comment">// below can&#39;t be CZLOOP since need uinitial in ghost+active region</span></div>
<div class="line"><a name="l02198"></a><span class="lineno"> 2198</span>&#160;  <span class="comment">// GODMARK: since ui=ucum (average quantities) then if change primitive somehow (fixup, etc.) then must change corresponding average conserved quantity somehow (this is one reason why using average values is annoying, although in some cases we use Sasha&#39;s method to treat average like point for *change* in average conserved quantity)</span></div>
<div class="line"><a name="l02199"></a><span class="lineno"> 2199</span>&#160;  <span class="comment">// otherwise assume ui didn&#39;t change.  Present RK schemes assume this.  Otherwise have to keep track of pf/Uf pairs in RK stepping</span></div>
<div class="line"><a name="l02201"></a><span class="lineno"> 2201</span>&#160;<span class="comment"></span>  <span class="comment">//</span></div>
<div class="line"><a name="l02202"></a><span class="lineno"> 2202</span>&#160;  <span class="comment">// Set initial ui, temporary space, so ok that COMPZLOOP() goes over +1 in FLUXB==FLUXCTSTAG case</span></div>
<div class="line"><a name="l02203"></a><span class="lineno"> 2203</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02205"></a><span class="lineno"> 2205</span>&#160;<span class="comment"></span>  <span class="keywordflow">if</span>(timeorder==0){</div>
<div class="line"><a name="l02206"></a><span class="lineno"> 2206</span>&#160;    <span class="comment">// last timestep&#39;s final ucum is stored into ucumformetric and ui as initial term in ucum</span></div>
<div class="line"><a name="l02207"></a><span class="lineno"> 2207</span>&#160;    <span class="comment">// copy ucum -&gt; {ucumformetric,ui}</span></div>
<div class="line"><a name="l02208"></a><span class="lineno"> 2208</span>&#160;    <span class="keywordflow">if</span>(doingmetricsubstep()) copy_3dnpr_2ptrs(is,ie,js,je,ks,ke,ucum,ucumformetric,ui);</div>
<div class="line"><a name="l02209"></a><span class="lineno"> 2209</span>&#160;    <span class="keywordflow">else</span> copy_3dnpr(is,ie,js,je,ks,ke,ucum,ui); <span class="comment">// only need to setup ui then</span></div>
<div class="line"><a name="l02210"></a><span class="lineno"> 2210</span>&#160;  }</div>
<div class="line"><a name="l02211"></a><span class="lineno"> 2211</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l02212"></a><span class="lineno"> 2212</span>&#160;    <span class="comment">// preserve this time&#39;s value of ucum for the metric (for timeorder==0 ucumformetric is assigned from ui)</span></div>
<div class="line"><a name="l02213"></a><span class="lineno"> 2213</span>&#160;    <span class="comment">// copy ucum -&gt; ucumformetric</span></div>
<div class="line"><a name="l02214"></a><span class="lineno"> 2214</span>&#160;    <span class="keywordflow">if</span>(doingmetricsubstep()) copy_3dnpr(is,ie,js,je,ks,ke,ucum,ucumformetric);</div>
<div class="line"><a name="l02215"></a><span class="lineno"> 2215</span>&#160;  }</div>
<div class="line"><a name="l02216"></a><span class="lineno"> 2216</span>&#160;</div>
<div class="line"><a name="l02217"></a><span class="lineno"> 2217</span>&#160;</div>
<div class="line"><a name="l02218"></a><span class="lineno"> 2218</span>&#160;</div>
<div class="line"><a name="l02220"></a><span class="lineno"> 2220</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02221"></a><span class="lineno"> 2221</span>&#160;  <span class="comment">// Compute flux</span></div>
<div class="line"><a name="l02222"></a><span class="lineno"> 2222</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02224"></a><span class="lineno"> 2224</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02225"></a><span class="lineno"> 2225</span>&#160;<span class="preprocessor">#if(PRODUCTION==0)</span></div>
<div class="line"><a name="l02226"></a><span class="lineno"> 2226</span>&#160;<span class="preprocessor"></span>  trifprintf( <span class="stringliteral">&quot;#0f&quot;</span>);</div>
<div class="line"><a name="l02227"></a><span class="lineno"> 2227</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02228"></a><span class="lineno"> 2228</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l02229"></a><span class="lineno"> 2229</span>&#160;  ndt1=ndt2=ndt3=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>;</div>
<div class="line"><a name="l02230"></a><span class="lineno"> 2230</span>&#160;  <span class="keywordflow">if</span>(doflux &amp;&amp; truestep){</div>
<div class="line"><a name="l02231"></a><span class="lineno"> 2231</span>&#160;    <span class="comment">// pb used here on a stencil, so if pb=pf or pb=pi in pointers, shouldn&#39;t change pi or pf yet -- don&#39;t currently</span></div>
<div class="line"><a name="l02232"></a><span class="lineno"> 2232</span>&#160;    <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(<a class="code" href="../../dc/dae/flux_8c.html#ab229b0f3f2caf3c0a3ef5299fba2b1c0" title="see fluxcompute.c for non-computer science, real physics calculations of flux">fluxcalc</a>(stage,initialstep,finalstep,pb,pstag,pl_ct, pr_ct, vpot,F1,F2,F3,CUf,CUnew,fluxdt,fluxtime,&amp;ndt1,&amp;ndt2,&amp;ndt3),<span class="stringliteral">&quot;advance.c:advance_standard_orig()&quot;</span>, <span class="stringliteral">&quot;fluxcalcall&quot;</span>, 1);</div>
<div class="line"><a name="l02233"></a><span class="lineno"> 2233</span>&#160;  }</div>
<div class="line"><a name="l02234"></a><span class="lineno"> 2234</span>&#160;</div>
<div class="line"><a name="l02235"></a><span class="lineno"> 2235</span>&#160;<span class="preprocessor">#if(PRODUCTION==0)</span></div>
<div class="line"><a name="l02236"></a><span class="lineno"> 2236</span>&#160;<span class="preprocessor"></span>  trifprintf( <span class="stringliteral">&quot;1f&quot;</span>);</div>
<div class="line"><a name="l02237"></a><span class="lineno"> 2237</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02238"></a><span class="lineno"> 2238</span>&#160;<span class="preprocessor"></span>  <span class="comment">// from here on, pi/pb/pf are only used a zone at a time rather than on a stencil</span></div>
<div class="line"><a name="l02239"></a><span class="lineno"> 2239</span>&#160;</div>
<div class="line"><a name="l02240"></a><span class="lineno"> 2240</span>&#160;</div>
<div class="line"><a name="l02241"></a><span class="lineno"> 2241</span>&#160;</div>
<div class="line"><a name="l02242"></a><span class="lineno"> 2242</span>&#160;</div>
<div class="line"><a name="l02243"></a><span class="lineno"> 2243</span>&#160;</div>
<div class="line"><a name="l02244"></a><span class="lineno"> 2244</span>&#160;</div>
<div class="line"><a name="l02245"></a><span class="lineno"> 2245</span>&#160;</div>
<div class="line"><a name="l02246"></a><span class="lineno"> 2246</span>&#160;<span class="preprocessor">#if(PRODUCTION==0)</span></div>
<div class="line"><a name="l02247"></a><span class="lineno"> 2247</span>&#160;<span class="preprocessor"></span>  trifprintf( <span class="stringliteral">&quot;#0m&quot;</span>);</div>
<div class="line"><a name="l02248"></a><span class="lineno"> 2248</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02249"></a><span class="lineno"> 2249</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l02250"></a><span class="lineno"> 2250</span>&#160;</div>
<div class="line"><a name="l02252"></a><span class="lineno"> 2252</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02253"></a><span class="lineno"> 2253</span>&#160;  <span class="comment">// Utoprim as initial conditions : can&#39;t assume want these to be same in the end, so assign</span></div>
<div class="line"><a name="l02254"></a><span class="lineno"> 2254</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02255"></a><span class="lineno"> 2255</span>&#160;  <span class="comment">// Since final step often sets pointers of pi=pf, in order to use arbitrary guess, must set here once done with pi,pb,pf.</span></div>
<div class="line"><a name="l02256"></a><span class="lineno"> 2256</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02258"></a><span class="lineno"> 2258</span>&#160;<span class="comment"></span>  <span class="comment">// setup initial guess for inversion</span></div>
<div class="line"><a name="l02259"></a><span class="lineno"> 2259</span>&#160;  <span class="comment">// use pb since should be closer to pf</span></div>
<div class="line"><a name="l02260"></a><span class="lineno"> 2260</span>&#160;  <span class="comment">// copy pb-&gt;pf</span></div>
<div class="line"><a name="l02261"></a><span class="lineno"> 2261</span>&#160;  <span class="comment">// OK to do here, because never really use pi</span></div>
<div class="line"><a name="l02262"></a><span class="lineno"> 2262</span>&#160;  copy_3dnpr_fullloop(pb,pf);</div>
<div class="line"><a name="l02263"></a><span class="lineno"> 2263</span>&#160;</div>
<div class="line"><a name="l02264"></a><span class="lineno"> 2264</span>&#160;</div>
<div class="line"><a name="l02265"></a><span class="lineno"> 2265</span>&#160; </div>
<div class="line"><a name="l02267"></a><span class="lineno"> 2267</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02268"></a><span class="lineno"> 2268</span>&#160;  <span class="comment">// SOURCE TERM</span></div>
<div class="line"><a name="l02269"></a><span class="lineno"> 2269</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02271"></a><span class="lineno"> 2271</span>&#160;<span class="comment"></span>  <span class="keywordtype">int</span> didreturnpf; <span class="comment">// used to have source() pass back better guess for Utoprimgen() than pb.</span></div>
<div class="line"><a name="l02272"></a><span class="lineno"> 2272</span>&#160;</div>
<div class="line"><a name="l02273"></a><span class="lineno"> 2273</span>&#160;  <span class="keywordflow">if</span>(truestep){</div>
<div class="line"><a name="l02274"></a><span class="lineno"> 2274</span>&#160;    <span class="comment">// GODMARK: other/more special cases?</span></div>
<div class="line"><a name="l02275"></a><span class="lineno"> 2275</span>&#160;<span class="preprocessor">#if(WHICHEOM==WITHNOGDET &amp;&amp; (NOGDETB1==1 || NOGDETB2==1 || NOGDETB3==1) )</span></div>
<div class="line"><a name="l02276"></a><span class="lineno"> 2276</span>&#160;<span class="preprocessor"></span>    <span class="comment">// for FLUXB==FLUXCTSTAG, assume no source term for field</span></div>
<div class="line"><a name="l02277"></a><span class="lineno"> 2277</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a11c4e99e1493d0c1914ad1ab313ea472">FLUXB</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0b6762cef74e396f50a83864bb53fb6c">FLUXCTSTAG</a>){</div>
<div class="line"><a name="l02278"></a><span class="lineno"> 2278</span>&#160;      dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;Not setup for field source term if staggered field\n&quot;</span>);</div>
<div class="line"><a name="l02279"></a><span class="lineno"> 2279</span>&#160;      myexit(176023);</div>
<div class="line"><a name="l02280"></a><span class="lineno"> 2280</span>&#160;    }</div>
<div class="line"><a name="l02281"></a><span class="lineno"> 2281</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02282"></a><span class="lineno"> 2282</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l02283"></a><span class="lineno"> 2283</span>&#160;    <span class="comment">//    COMPZSLOOP(is,ie,js,je,ks,ke){</span></div>
<div class="line"><a name="l02284"></a><span class="lineno"> 2284</span>&#160;<span class="preprocessor">#if(STOREFLUXSTATE)</span></div>
<div class="line"><a name="l02285"></a><span class="lineno"> 2285</span>&#160;<span class="preprocessor"></span>    <span class="comment">// call get_stateforsource, which just reads existing data instead of generating from EOS, etc.</span></div>
<div class="line"><a name="l02286"></a><span class="lineno"> 2286</span>&#160;<span class="preprocessor">#pragma omp parallel </span></div>
<div class="line"><a name="l02287"></a><span class="lineno"> 2287</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#else</span></div>
<div class="line"><a name="l02288"></a><span class="lineno"> 2288</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#pragma omp parallel OPENMPGLOBALPRIVATEFORSTATEANDGEOM</span></div>
<div class="line"><a name="l02289"></a><span class="lineno"> 2289</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02290"></a><span class="lineno"> 2290</span>&#160;<span class="preprocessor"></span>    {</div>
<div class="line"><a name="l02291"></a><span class="lineno"> 2291</span>&#160;      <span class="keywordtype">int</span> <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>,<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>,k,pl,pliter;</div>
<div class="line"><a name="l02292"></a><span class="lineno"> 2292</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dUgeom[NPR],dUriemann[NPR],dUriemann1[NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>],dUriemann2[NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>],dUriemann3[NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>],dUcomp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ac34589654a83c911addd1fda0898e738">NUMSOURCES</a>][NPR];</div>
<div class="line"><a name="l02293"></a><span class="lineno"> 2293</span>&#160;      <span class="keyword">struct </span><a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> geomdontuse;</div>
<div class="line"><a name="l02294"></a><span class="lineno"> 2294</span>&#160;      <span class="keyword">struct </span><a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom=&amp;geomdontuse;</div>
<div class="line"><a name="l02295"></a><span class="lineno"> 2295</span>&#160;      <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> qdontuse;</div>
<div class="line"><a name="l02296"></a><span class="lineno"> 2296</span>&#160;      <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *qptr=&amp;qdontuse;</div>
<div class="line"><a name="l02297"></a><span class="lineno"> 2297</span>&#160;      <span class="comment">// setup default eomtype</span></div>
<div class="line"><a name="l02298"></a><span class="lineno"> 2298</span>&#160;      <span class="keywordtype">int</span> eomtype;</div>
<div class="line"><a name="l02299"></a><span class="lineno"> 2299</span>&#160;</div>
<div class="line"><a name="l02300"></a><span class="lineno"> 2300</span>&#160;      <a class="code" href="../../d5/d7b/global_8openmploops_8h.html#a1389db2daf5bd9e94918090c253a16c9">OPENMP3DLOOPVARSDEFINE</a>; <a class="code" href="../../d5/d7b/global_8openmploops_8h.html#a8de37da93c3462c536ef830f2fbaee61" title="forced to be a computational loop, so start/stop cannot already have shifts in them (which is normal ...">OPENMP3DLOOPSETUP</a>(is,ie,js,je,ks,ke);</div>
<div class="line"><a name="l02301"></a><span class="lineno"> 2301</span>&#160;</div>
<div class="line"><a name="l02302"></a><span class="lineno"> 2302</span>&#160;      </div>
<div class="line"><a name="l02303"></a><span class="lineno"> 2303</span>&#160;<span class="preprocessor">#pragma omp for schedule(OPENMPSCHEDULE(),OPENMPCHUNKSIZE(blocksize))</span></div>
<div class="line"><a name="l02304"></a><span class="lineno"> 2304</span>&#160;<span class="preprocessor"></span>      <a class="code" href="../../d5/d7b/global_8openmploops_8h.html#a9e48537d3cb58cc3a3765b8a18b43b15" title="Oddly, performance changes by 10% when changing how start and stop blockijk (and fixing how used too ...">OPENMP3DLOOPBLOCK</a>{</div>
<div class="line"><a name="l02305"></a><span class="lineno"> 2305</span>&#160;        <a class="code" href="../../df/d1c/global_8storage_8h.html#a96983b0c56e836f50cb7c1af16f59fb6">OPENMP3DLOOPBLOCK2IJK</a>(i,j,k);</div>
<div class="line"><a name="l02306"></a><span class="lineno"> 2306</span>&#160;</div>
<div class="line"><a name="l02307"></a><span class="lineno"> 2307</span>&#160;        <span class="comment">// setup default eomtype</span></div>
<div class="line"><a name="l02308"></a><span class="lineno"> 2308</span>&#160;        eomtype=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aa28b06d889a02621b45edc716bfb2d01">EOMDEFAULT</a>;</div>
<div class="line"><a name="l02309"></a><span class="lineno"> 2309</span>&#160;</div>
<div class="line"><a name="l02310"></a><span class="lineno"> 2310</span>&#160;        <span class="comment">// find dU(pb)</span></div>
<div class="line"><a name="l02311"></a><span class="lineno"> 2311</span>&#160;        <span class="comment">// only find source term if non-Minkowski and non-Cartesian</span></div>
<div class="line"><a name="l02312"></a><span class="lineno"> 2312</span>&#160;        <span class="comment">// set geometry for centered zone to be updated</span></div>
<div class="line"><a name="l02313"></a><span class="lineno"> 2313</span>&#160;        <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a3059ed7bfcfb692cbe8014d55fd7c1e4">get_geometry</a>(i, j, k, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8936711f57f82d1fc75c21fa2894e1c6">CENT</a>, ptrgeom);</div>
<div class="line"><a name="l02314"></a><span class="lineno"> 2314</span>&#160;</div>
<div class="line"><a name="l02315"></a><span class="lineno"> 2315</span>&#160;        <span class="comment">// get state</span></div>
<div class="line"><a name="l02316"></a><span class="lineno"> 2316</span>&#160;        <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(<a class="code" href="../../de/d8c/phys_8c.html#a126e2e13b7ac0d2c79b17ecf87129b77" title="wrapper for choosing to get state by computing it or from global array pointer assign (overrides the ...">get_stateforsource</a>(<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(pb,i,j,k), ptrgeom, &amp;qptr) ,<span class="stringliteral">&quot;advance.c:()&quot;</span>, <span class="stringliteral">&quot;get_state() dir=0&quot;</span>, 1);</div>
<div class="line"><a name="l02317"></a><span class="lineno"> 2317</span>&#160;</div>
<div class="line"><a name="l02318"></a><span class="lineno"> 2318</span>&#160;</div>
<div class="line"><a name="l02319"></a><span class="lineno"> 2319</span>&#160;        <span class="comment">// dUriemann is volume averaged quantity (here this calcuation is done in case want to limit sources)</span></div>
<div class="line"><a name="l02320"></a><span class="lineno"> 2320</span>&#160;        <span class="keywordflow">if</span>(doflux){</div>
<div class="line"><a name="l02321"></a><span class="lineno"> 2321</span>&#160;          flux2dUavg(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac578a63f887dbc4797b555bd9c468a5f">DOALLPL</a>,i,j,k,F1,F2,F3,dUriemann1,dUriemann2,dUriemann3);</div>
<div class="line"><a name="l02322"></a><span class="lineno"> 2322</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) dUriemann[pl]=dUriemann1[pl]+dUriemann2[pl]+dUriemann3[pl]; <span class="comment">// this addition is entirely consistent with point-&gt;averages</span></div>
<div class="line"><a name="l02323"></a><span class="lineno"> 2323</span>&#160;        }</div>
<div class="line"><a name="l02324"></a><span class="lineno"> 2324</span>&#160;        else{</div>
<div class="line"><a name="l02325"></a><span class="lineno"> 2325</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) dUriemann[pl]=0.0;</div>
<div class="line"><a name="l02326"></a><span class="lineno"> 2326</span>&#160;        }</div>
<div class="line"><a name="l02327"></a><span class="lineno"> 2327</span>&#160;</div>
<div class="line"><a name="l02328"></a><span class="lineno"> 2328</span>&#160;     </div>
<div class="line"><a name="l02329"></a><span class="lineno"> 2329</span>&#160;        <span class="comment">// get source term (point source, don&#39;t use to update diagnostics)</span></div>
<div class="line"><a name="l02330"></a><span class="lineno"> 2330</span>&#160;        <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a4ebf7765a6bde079a76719b89d3033b6" title="add in source terms to equations of motion ui and dUriemann in UEVOLVE form assume q(pr) so consisten...">source</a>(<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(pi,i,j,k), <a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(pb,i,j,k), <a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(pf,i,j,k), &amp;didreturnpf, &amp;eomtype, ptrgeom, qptr, <a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(ui,i,j,k), <a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(uf,i,j,k), CUf, CUimp, 0.0, dUriemann, dUcomp, <a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(dUgeomarray,i,j,k)),&quot;<a class="code" href="../../d9/de0/step__ch_8c.html#afe241569412f22a86dea9cd91b516af8" title="take step itself">step_ch</a>.c:<a class="code" href="../../df/d22/advance_8c.html#a22dff5dc24ff389254919e70b79be489" title="pi: initial values at t=t0 to compute Ui pb: values used to compute flux/source pf: solution using fl...">advance</a>()&quot;, &quot;<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a4ebf7765a6bde079a76719b89d3033b6" title="add in source terms to equations of motion ui and dUriemann in UEVOLVE form assume q(pr) so consisten...">source</a>&quot;, 1);</div>
<div class="line"><a name="l02331"></a><span class="lineno"> 2331</span>&#160;      }<span class="comment">// end COMPZLOOP</span></div>
<div class="line"><a name="l02332"></a><span class="lineno"> 2332</span>&#160;</div>
<div class="line"><a name="l02333"></a><span class="lineno"> 2333</span>&#160;</div>
<div class="line"><a name="l02334"></a><span class="lineno"> 2334</span>&#160;      <span class="comment">// Store diagnostics related to component form of sources. Done here since don&#39;t integrate-up compnents of source.  So only point accurate</span></div>
<div class="line"><a name="l02335"></a><span class="lineno"> 2335</span>&#160;<span class="preprocessor">#if(SPLITNPR)</span></div>
<div class="line"><a name="l02336"></a><span class="lineno"> 2336</span>&#160;<span class="preprocessor"></span>      <span class="comment">// don&#39;t update metric if only doing B1-B3</span></div>
<div class="line"><a name="l02337"></a><span class="lineno"> 2337</span>&#160;      <span class="keywordflow">if</span>(<a class="code" href="../../d8/d5b/defs_8general_8h.html#aa2010d23a21177641277f5119a2705c7">advancepassnumber</a>==-1 || <a class="code" href="../../d8/d5b/defs_8general_8h.html#aa2010d23a21177641277f5119a2705c7">advancepassnumber</a>==1)</div>
<div class="line"><a name="l02338"></a><span class="lineno"> 2338</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02339"></a><span class="lineno"> 2339</span>&#160;<span class="preprocessor"></span>        {</div>
<div class="line"><a name="l02340"></a><span class="lineno"> 2340</span>&#160;<span class="preprocessor">#pragma omp critical // since diagnostics store in same global cumulative variables</span></div>
<div class="line"><a name="l02341"></a><span class="lineno"> 2341</span>&#160;<span class="preprocessor"></span>          {</div>
<div class="line"><a name="l02342"></a><span class="lineno"> 2342</span>&#160;            <span class="keywordflow">if</span>(<a class="code" href="../../d8/d5b/defs_8general_8h.html#aac5486df6a846aa6cb47c73202ac0485">DODIAGS</a>){</div>
<div class="line"><a name="l02343"></a><span class="lineno"> 2343</span>&#160;<span class="preprocessor">#if(ACCURATESOURCEDIAG&gt;=2)</span></div>
<div class="line"><a name="l02344"></a><span class="lineno"> 2344</span>&#160;<span class="preprocessor"></span>              diag_source_comp(ptrgeom,dUcomp,fluxdt);</div>
<div class="line"><a name="l02345"></a><span class="lineno"> 2345</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l02346"></a><span class="lineno"> 2346</span>&#160;<span class="preprocessor"></span>              diag_source_comp(ptrgeom,dUcomp,dt4diag);</div>
<div class="line"><a name="l02347"></a><span class="lineno"> 2347</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02348"></a><span class="lineno"> 2348</span>&#160;<span class="preprocessor"></span>            }</div>
<div class="line"><a name="l02349"></a><span class="lineno"> 2349</span>&#160;          }</div>
<div class="line"><a name="l02350"></a><span class="lineno"> 2350</span>&#160;        }</div>
<div class="line"><a name="l02351"></a><span class="lineno"> 2351</span>&#160;      </div>
<div class="line"><a name="l02352"></a><span class="lineno"> 2352</span>&#160;</div>
<div class="line"><a name="l02353"></a><span class="lineno"> 2353</span>&#160;      <span class="comment">// volume integrate dUgeom</span></div>
<div class="line"><a name="l02354"></a><span class="lineno"> 2354</span>&#160;      <span class="comment">// c2a_1 c2a_2 c2a_3</span></div>
<div class="line"><a name="l02355"></a><span class="lineno"> 2355</span>&#160;      <span class="keywordflow">if</span>(dosource){</div>
<div class="line"><a name="l02356"></a><span class="lineno"> 2356</span>&#160;        <span class="comment">// need to limit source averaging -- GODMARK</span></div>
<div class="line"><a name="l02357"></a><span class="lineno"> 2357</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl) locpl[pl]=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8936711f57f82d1fc75c21fa2894e1c6">CENT</a>;</div>
<div class="line"><a name="l02358"></a><span class="lineno"> 2358</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl) whichpltoavg[pl]=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a619bd249bee29e34eb58716b9b88dc8a">do_source_integration</a>[pl];<span class="comment">// default</span></div>
<div class="line"><a name="l02359"></a><span class="lineno"> 2359</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl) ifnotavgthencopy[pl]=1-<a class="code" href="../../d8/d5b/defs_8general_8h.html#a619bd249bee29e34eb58716b9b88dc8a">do_source_integration</a>[pl];<span class="comment">// default</span></div>
<div class="line"><a name="l02360"></a><span class="lineno"> 2360</span>&#160;        avg2cen_interp(locpl,whichpltoavg, ifnotavgthencopy, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a293f3768bb5a864faf74ed3b364d030c" title="quantities to interp">ENOSOURCETERM</a>, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ad09dd24833e44298326aeb7bd1e781ed">ENOCENT2AVGTYPE</a>, pb, <a class="code" href="../../df/d1c/global_8storage_8h.html#ad4d4e53463c3b69d3214d6a35f3c88f7" title="Access to any non-global pointer (not a_s_): note that ok to have nothing as prefix, but macro using prefix##name assumes prefix is defined even inputted as nothing.">POINT</a>(dUgeomarray), <a class="code" href="../../df/d1c/global_8storage_8h.html#ad4d4e53463c3b69d3214d6a35f3c88f7" title="Access to any non-global pointer (not a_s_): note that ok to have nothing as prefix, but macro using prefix##name assumes prefix is defined even inputted as nothing.">POINT</a>(dUgeomarray));</div>
<div class="line"><a name="l02361"></a><span class="lineno"> 2361</span>&#160;      }</div>
<div class="line"><a name="l02362"></a><span class="lineno"> 2362</span>&#160;    }<span class="comment">// end parallel region</span></div>
<div class="line"><a name="l02363"></a><span class="lineno"> 2363</span>&#160;  }<span class="comment">// end if truestep</span></div>
<div class="line"><a name="l02364"></a><span class="lineno"> 2364</span>&#160;</div>
<div class="line"><a name="l02365"></a><span class="lineno"> 2365</span>&#160;</div>
<div class="line"><a name="l02366"></a><span class="lineno"> 2366</span>&#160;</div>
<div class="line"><a name="l02367"></a><span class="lineno"> 2367</span>&#160;</div>
<div class="line"><a name="l02368"></a><span class="lineno"> 2368</span>&#160;</div>
<div class="line"><a name="l02369"></a><span class="lineno"> 2369</span>&#160;</div>
<div class="line"><a name="l02370"></a><span class="lineno"> 2370</span>&#160;</div>
<div class="line"><a name="l02371"></a><span class="lineno"> 2371</span>&#160;</div>
<div class="line"><a name="l02372"></a><span class="lineno"> 2372</span>&#160;</div>
<div class="line"><a name="l02373"></a><span class="lineno"> 2373</span>&#160;</div>
<div class="line"><a name="l02375"></a><span class="lineno"> 2375</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02376"></a><span class="lineno"> 2376</span>&#160;  <span class="comment">// update Ui to Uf (ultimately to ucum)</span></div>
<div class="line"><a name="l02377"></a><span class="lineno"> 2377</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02379"></a><span class="lineno"> 2379</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02380"></a><span class="lineno"> 2380</span>&#160;  <span class="comment">//  COMPZSLOOP(is,ie,js,je,ks,ke){</span></div>
<div class="line"><a name="l02381"></a><span class="lineno"> 2381</span>&#160;<span class="preprocessor">#if(STOREFLUXSTATE)</span></div>
<div class="line"><a name="l02382"></a><span class="lineno"> 2382</span>&#160;<span class="preprocessor"></span>  <span class="comment">// call get_stateforsource, which just reads existing data instead of generating from EOS, etc.</span></div>
<div class="line"><a name="l02383"></a><span class="lineno"> 2383</span>&#160;<span class="preprocessor">#pragma omp parallel </span></div>
<div class="line"><a name="l02384"></a><span class="lineno"> 2384</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#else</span></div>
<div class="line"><a name="l02385"></a><span class="lineno"> 2385</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#pragma omp parallel OPENMPGLOBALPRIVATEFORSTATEANDGEOM</span></div>
<div class="line"><a name="l02386"></a><span class="lineno"> 2386</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02387"></a><span class="lineno"> 2387</span>&#160;<span class="preprocessor"></span>  {</div>
<div class="line"><a name="l02388"></a><span class="lineno"> 2388</span>&#160;    <span class="keywordtype">int</span> <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>,<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>,k,pl,pliter;</div>
<div class="line"><a name="l02389"></a><span class="lineno"> 2389</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fdummy;</div>
<div class="line"><a name="l02390"></a><span class="lineno"> 2390</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dUgeom[NPR],dUriemann[NPR],dUriemann1[NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>],dUriemann2[NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>],dUriemann3[NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>],dUcomp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ac34589654a83c911addd1fda0898e738">NUMSOURCES</a>][NPR];</div>
<div class="line"><a name="l02391"></a><span class="lineno"> 2391</span>&#160;    <span class="keyword">struct </span><a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> geomdontuse;</div>
<div class="line"><a name="l02392"></a><span class="lineno"> 2392</span>&#160;    <span class="keyword">struct </span><a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom=&amp;geomdontuse;</div>
<div class="line"><a name="l02393"></a><span class="lineno"> 2393</span>&#160;    <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> qdontuse;</div>
<div class="line"><a name="l02394"></a><span class="lineno"> 2394</span>&#160;    <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *qptr=&amp;qdontuse;</div>
<div class="line"><a name="l02395"></a><span class="lineno"> 2395</span>&#160;    <span class="comment">// GODMARK: KORALTODO: setup default eomtype (not using source() from above!)</span></div>
<div class="line"><a name="l02396"></a><span class="lineno"> 2396</span>&#160;    <span class="keywordtype">int</span> eomtype;</div>
<div class="line"><a name="l02397"></a><span class="lineno"> 2397</span>&#160;</div>
<div class="line"><a name="l02398"></a><span class="lineno"> 2398</span>&#160;    <a class="code" href="../../d5/d7b/global_8openmploops_8h.html#a1389db2daf5bd9e94918090c253a16c9">OPENMP3DLOOPVARSDEFINE</a>;  <a class="code" href="../../d5/d7b/global_8openmploops_8h.html#a8de37da93c3462c536ef830f2fbaee61" title="forced to be a computational loop, so start/stop cannot already have shifts in them (which is normal ...">OPENMP3DLOOPSETUP</a>(is,ie,js,je,ks,ke);</div>
<div class="line"><a name="l02399"></a><span class="lineno"> 2399</span>&#160;</div>
<div class="line"><a name="l02400"></a><span class="lineno"> 2400</span>&#160;      </div>
<div class="line"><a name="l02401"></a><span class="lineno"> 2401</span>&#160;<span class="preprocessor">#pragma omp for schedule(OPENMPSCHEDULE(),OPENMPCHUNKSIZE(blocksize))</span></div>
<div class="line"><a name="l02402"></a><span class="lineno"> 2402</span>&#160;<span class="preprocessor"></span>    <a class="code" href="../../d5/d7b/global_8openmploops_8h.html#a9e48537d3cb58cc3a3765b8a18b43b15" title="Oddly, performance changes by 10% when changing how start and stop blockijk (and fixing how used too ...">OPENMP3DLOOPBLOCK</a>{</div>
<div class="line"><a name="l02403"></a><span class="lineno"> 2403</span>&#160;      <a class="code" href="../../df/d1c/global_8storage_8h.html#a96983b0c56e836f50cb7c1af16f59fb6">OPENMP3DLOOPBLOCK2IJK</a>(i,j,k);</div>
<div class="line"><a name="l02404"></a><span class="lineno"> 2404</span>&#160;</div>
<div class="line"><a name="l02405"></a><span class="lineno"> 2405</span>&#160;      <span class="comment">// setup default eomtype</span></div>
<div class="line"><a name="l02406"></a><span class="lineno"> 2406</span>&#160;      eomtype=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aa28b06d889a02621b45edc716bfb2d01">EOMDEFAULT</a>;</div>
<div class="line"><a name="l02407"></a><span class="lineno"> 2407</span>&#160;</div>
<div class="line"><a name="l02408"></a><span class="lineno"> 2408</span>&#160;</div>
<div class="line"><a name="l02409"></a><span class="lineno"> 2409</span>&#160;      <span class="comment">// get geometry at center where source is located</span></div>
<div class="line"><a name="l02410"></a><span class="lineno"> 2410</span>&#160;      <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a3059ed7bfcfb692cbe8014d55fd7c1e4">get_geometry</a>(i, j, k, CENT, ptrgeom);</div>
<div class="line"><a name="l02411"></a><span class="lineno"> 2411</span>&#160;</div>
<div class="line"><a name="l02412"></a><span class="lineno"> 2412</span>&#160;      <span class="comment">// get state</span></div>
<div class="line"><a name="l02413"></a><span class="lineno"> 2413</span>&#160;      <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(<a class="code" href="../../de/d8c/phys_8c.html#a126e2e13b7ac0d2c79b17ecf87129b77" title="wrapper for choosing to get state by computing it or from global array pointer assign (overrides the ...">get_stateforsource</a>(<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(pb,i,j,k), ptrgeom, &amp;qptr) ,<span class="stringliteral">&quot;advance.c:()&quot;</span>, <span class="stringliteral">&quot;get_state() dir=0&quot;</span>, 1);</div>
<div class="line"><a name="l02414"></a><span class="lineno"> 2414</span>&#160;  </div>
<div class="line"><a name="l02416"></a><span class="lineno"> 2416</span>&#160;      <span class="comment">//</span></div>
<div class="line"><a name="l02417"></a><span class="lineno"> 2417</span>&#160;      <span class="comment">// Utoprim as initial conditions : can&#39;t assume want these to be same in the end, so assign</span></div>
<div class="line"><a name="l02418"></a><span class="lineno"> 2418</span>&#160;      <span class="comment">//</span></div>
<div class="line"><a name="l02420"></a><span class="lineno"> 2420</span>&#160;<span class="comment"></span>  </div>
<div class="line"><a name="l02421"></a><span class="lineno"> 2421</span>&#160;      <span class="comment">// initialize uf and ucum if very first time here since ucum is cumulative (+=)</span></div>
<div class="line"><a name="l02422"></a><span class="lineno"> 2422</span>&#160;      <span class="comment">//    if(timeorder==0) PLOOP(pliter,pl) MACP0A1(uf,i,j,k,pl)=MACP0A1(tempucum,i,j,k,pl)=MACP0A1(ucum,i,j,k,pl)=0.0;</span></div>
<div class="line"><a name="l02423"></a><span class="lineno"> 2423</span>&#160;      <span class="keywordflow">if</span>(timeorder==0) <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(uf,i,j,k,pl)=<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(tempucum,i,j,k,pl)=0.0;</div>
<div class="line"><a name="l02424"></a><span class="lineno"> 2424</span>&#160;  </div>
<div class="line"><a name="l02425"></a><span class="lineno"> 2425</span>&#160;      <span class="comment">// NEED TO DEFINE Ui on other substeps besides the 0th one</span></div>
<div class="line"><a name="l02426"></a><span class="lineno"> 2426</span>&#160;      <span class="comment">// find Ui(pi)</span></div>
<div class="line"><a name="l02427"></a><span class="lineno"> 2427</span>&#160;</div>
<div class="line"><a name="l02428"></a><span class="lineno"> 2428</span>&#160;</div>
<div class="line"><a name="l02429"></a><span class="lineno"> 2429</span>&#160;</div>
<div class="line"><a name="l02430"></a><span class="lineno"> 2430</span>&#160;      if(truestep){</div>
<div class="line"><a name="l02431"></a><span class="lineno"> 2431</span>&#160;        <span class="comment">// get source term (volume integrated)</span></div>
<div class="line"><a name="l02432"></a><span class="lineno"> 2432</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) dUgeom[pl]=<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(dUgeomarray,i,j,k,pl);</div>
<div class="line"><a name="l02433"></a><span class="lineno"> 2433</span>&#160;</div>
<div class="line"><a name="l02434"></a><span class="lineno"> 2434</span>&#160;</div>
<div class="line"><a name="l02435"></a><span class="lineno"> 2435</span>&#160;        <span class="comment">// store diagnostics related to source.  Totals, so use volume-integrated source.</span></div>
<div class="line"><a name="l02436"></a><span class="lineno"> 2436</span>&#160;<span class="preprocessor">#if(SPLITNPR)</span></div>
<div class="line"><a name="l02437"></a><span class="lineno"> 2437</span>&#160;<span class="preprocessor"></span>        <span class="comment">// don&#39;t update metric if only doing B1-B3</span></div>
<div class="line"><a name="l02438"></a><span class="lineno"> 2438</span>&#160;        <span class="keywordflow">if</span>(<a class="code" href="../../d8/d5b/defs_8general_8h.html#aa2010d23a21177641277f5119a2705c7">advancepassnumber</a>==-1 || <a class="code" href="../../d8/d5b/defs_8general_8h.html#aa2010d23a21177641277f5119a2705c7">advancepassnumber</a>==1)</div>
<div class="line"><a name="l02439"></a><span class="lineno"> 2439</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02440"></a><span class="lineno"> 2440</span>&#160;<span class="preprocessor"></span>          {</div>
<div class="line"><a name="l02441"></a><span class="lineno"> 2441</span>&#160;<span class="preprocessor">#pragma omp critical // since diagnostics store in same global cumulative variables</span></div>
<div class="line"><a name="l02442"></a><span class="lineno"> 2442</span>&#160;<span class="preprocessor"></span>            {</div>
<div class="line"><a name="l02443"></a><span class="lineno"> 2443</span>&#160;            <span class="keywordflow">if</span>(<a class="code" href="../../d8/d5b/defs_8general_8h.html#aac5486df6a846aa6cb47c73202ac0485">DODIAGS</a>){</div>
<div class="line"><a name="l02444"></a><span class="lineno"> 2444</span>&#160;<span class="preprocessor">#if(ACCURATESOURCEDIAG&gt;=1)</span></div>
<div class="line"><a name="l02445"></a><span class="lineno"> 2445</span>&#160;<span class="preprocessor"></span>              diag_source_all(ptrgeom,dUgeom,fluxdt);</div>
<div class="line"><a name="l02446"></a><span class="lineno"> 2446</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l02447"></a><span class="lineno"> 2447</span>&#160;<span class="preprocessor"></span>              diag_source_all(ptrgeom,dUgeom,dt4diag);</div>
<div class="line"><a name="l02448"></a><span class="lineno"> 2448</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02449"></a><span class="lineno"> 2449</span>&#160;<span class="preprocessor"></span>            }</div>
<div class="line"><a name="l02450"></a><span class="lineno"> 2450</span>&#160;          }   </div>
<div class="line"><a name="l02451"></a><span class="lineno"> 2451</span>&#160;        }</div>
<div class="line"><a name="l02452"></a><span class="lineno"> 2452</span>&#160;    </div>
<div class="line"><a name="l02453"></a><span class="lineno"> 2453</span>&#160;</div>
<div class="line"><a name="l02454"></a><span class="lineno"> 2454</span>&#160;        <span class="comment">// dUriemann is volume averaged quantity</span></div>
<div class="line"><a name="l02455"></a><span class="lineno"> 2455</span>&#160;        <span class="keywordflow">if</span>(doflux){</div>
<div class="line"><a name="l02456"></a><span class="lineno"> 2456</span>&#160;          flux2dUavg(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac578a63f887dbc4797b555bd9c468a5f">DOALLPL</a>,i,j,k,F1,F2,F3,dUriemann1,dUriemann2,dUriemann3);</div>
<div class="line"><a name="l02457"></a><span class="lineno"> 2457</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) dUriemann[pl]=dUriemann1[pl]+dUriemann2[pl]+dUriemann3[pl]; <span class="comment">// this addition is entirely consistent with point-&gt;averages</span></div>
<div class="line"><a name="l02458"></a><span class="lineno"> 2458</span>&#160;        }</div>
<div class="line"><a name="l02459"></a><span class="lineno"> 2459</span>&#160;        else{</div>
<div class="line"><a name="l02460"></a><span class="lineno"> 2460</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) dUriemann[pl]=0.0;</div>
<div class="line"><a name="l02461"></a><span class="lineno"> 2461</span>&#160;        }</div>
<div class="line"><a name="l02462"></a><span class="lineno"> 2462</span>&#160;      }</div>
<div class="line"><a name="l02463"></a><span class="lineno"> 2463</span>&#160;      else{</div>
<div class="line"><a name="l02464"></a><span class="lineno"> 2464</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l02465"></a><span class="lineno"> 2465</span>&#160;          dUriemann[pl]=0.0;</div>
<div class="line"><a name="l02466"></a><span class="lineno"> 2466</span>&#160;          dUgeom[pl]=0.0;</div>
<div class="line"><a name="l02467"></a><span class="lineno"> 2467</span>&#160;        }</div>
<div class="line"><a name="l02468"></a><span class="lineno"> 2468</span>&#160;      }</div>
<div class="line"><a name="l02469"></a><span class="lineno"> 2469</span>&#160;</div>
<div class="line"><a name="l02470"></a><span class="lineno"> 2470</span>&#160;      <span class="comment">// find uf==Uf and additional terms to ucum</span></div>
<div class="line"><a name="l02471"></a><span class="lineno"> 2471</span>&#160;      dUtoU(timeorder,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac578a63f887dbc4797b555bd9c468a5f">DOALLPL</a>, i,j,k,ptrgeom-&gt;p,dUgeom, dUcomp, dUriemann, CUf, CUnew, <a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(ui,i,j,k), <a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(uf,i,j,k), <a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(tempucum,i,j,k));</div>
<div class="line"><a name="l02472"></a><span class="lineno"> 2472</span>&#160;</div>
<div class="line"><a name="l02473"></a><span class="lineno"> 2473</span>&#160;</div>
<div class="line"><a name="l02474"></a><span class="lineno"> 2474</span>&#160;</div>
<div class="line"><a name="l02475"></a><span class="lineno"> 2475</span>&#160;<span class="preprocessor">#if(LIMITDTWITHSOURCETERM)</span></div>
<div class="line"><a name="l02476"></a><span class="lineno"> 2476</span>&#160;<span class="preprocessor"></span>      <span class="comment">// SUPERGODMARK: no longer have access to dUcomp : NEED TO FIX</span></div>
<div class="line"><a name="l02477"></a><span class="lineno"> 2477</span>&#160;      <span class="comment">// below is correct, but excessive</span></div>
<div class="line"><a name="l02478"></a><span class="lineno"> 2478</span>&#160;      <span class="comment">// get source term again in order to have dUcomp (NEED TO FIX)</span></div>
<div class="line"><a name="l02479"></a><span class="lineno"> 2479</span>&#160;      <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a4ebf7765a6bde079a76719b89d3033b6" title="add in source terms to equations of motion ui and dUriemann in UEVOLVE form assume q(pr) so consisten...">source</a>(<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(pi,i,j,k), <a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(pb,i,j,k), <a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(pf,i,j,k), &amp;didreturnpf, &amp;eomtype, ptrgeom, qptr, <a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(ui,i,j,k), <a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(uf,i,j,k), CUf, CUimp, 0.0, dUriemann, dUcomp, &amp;fdummy),<span class="stringliteral">&quot;step_ch.c:advance()&quot;</span>, <span class="stringliteral">&quot;source&quot;</span>, 2);</div>
<div class="line"><a name="l02480"></a><span class="lineno"> 2480</span>&#160;</div>
<div class="line"><a name="l02481"></a><span class="lineno"> 2481</span>&#160;</div>
<div class="line"><a name="l02482"></a><span class="lineno"> 2482</span>&#160;      dUtodt(ptrgeom, qptr, <a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(pb,i,j,k), dUgeom, dUriemann, dUcomp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a06b1d017ed7599c17c423f4d989a8d63" title="these get ADDED UP, not independently treated number of source terms.">GEOMSOURCE</a>], &amp;accdt_ij, &amp;gravitydt_ij);</div>
<div class="line"><a name="l02483"></a><span class="lineno"> 2483</span>&#160;      <span class="comment">// below is old before grid sectioning</span></div>
<div class="line"><a name="l02484"></a><span class="lineno"> 2484</span>&#160;      <span class="comment">//#if( (DOEVOLVEMETRIC || DOSELFGRAVVSR) &amp;&amp; (RESTRICTDTSETTINGINSIDEHORIZON&gt;=1) )</span></div>
<div class="line"><a name="l02485"></a><span class="lineno"> 2485</span>&#160;      <span class="comment">//    // avoid limiting dt if inside horizon</span></div>
<div class="line"><a name="l02486"></a><span class="lineno"> 2486</span>&#160;      <span class="comment">//    if(WITHINENERREGION(enerposreg[OUTSIDEHORIZONENERREGION],i,j,k))</span></div>
<div class="line"><a name="l02487"></a><span class="lineno"> 2487</span>&#160;      <span class="comment">//#endif</span></div>
<div class="line"><a name="l02488"></a><span class="lineno"> 2488</span>&#160;<span class="preprocessor">#pragma omp critical</span></div>
<div class="line"><a name="l02489"></a><span class="lineno"> 2489</span>&#160;<span class="preprocessor"></span>      {</div>
<div class="line"><a name="l02490"></a><span class="lineno"> 2490</span>&#160;        <span class="keywordflow">if</span>(accdt_ij&lt;accdt){</div>
<div class="line"><a name="l02491"></a><span class="lineno"> 2491</span>&#160;          accdt=accdt_ij;</div>
<div class="line"><a name="l02492"></a><span class="lineno"> 2492</span>&#160;          accdti=<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>;</div>
<div class="line"><a name="l02493"></a><span class="lineno"> 2493</span>&#160;          accdtj=<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>;</div>
<div class="line"><a name="l02494"></a><span class="lineno"> 2494</span>&#160;          accdtk=k;</div>
<div class="line"><a name="l02495"></a><span class="lineno"> 2495</span>&#160;        }</div>
<div class="line"><a name="l02496"></a><span class="lineno"> 2496</span>&#160;        <span class="keywordflow">if</span>(gravitydt_ij&lt;gravitydt){</div>
<div class="line"><a name="l02497"></a><span class="lineno"> 2497</span>&#160;          gravitydt=gravitydt_ij;</div>
<div class="line"><a name="l02498"></a><span class="lineno"> 2498</span>&#160;          gravitydti=<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>;</div>
<div class="line"><a name="l02499"></a><span class="lineno"> 2499</span>&#160;          gravitydtj=<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>;</div>
<div class="line"><a name="l02500"></a><span class="lineno"> 2500</span>&#160;          gravitydtk=k;</div>
<div class="line"><a name="l02501"></a><span class="lineno"> 2501</span>&#160;        }</div>
<div class="line"><a name="l02502"></a><span class="lineno"> 2502</span>&#160;      }<span class="comment">// end critical region</span></div>
<div class="line"><a name="l02503"></a><span class="lineno"> 2503</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02504"></a><span class="lineno"> 2504</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l02505"></a><span class="lineno"> 2505</span>&#160;</div>
<div class="line"><a name="l02506"></a><span class="lineno"> 2506</span>&#160;</div>
<div class="line"><a name="l02507"></a><span class="lineno"> 2507</span>&#160;</div>
<div class="line"><a name="l02508"></a><span class="lineno"> 2508</span>&#160;<span class="preprocessor">#if(FLUXDUMP==1)</span></div>
<div class="line"><a name="l02509"></a><span class="lineno"> 2509</span>&#160;<span class="preprocessor"></span>      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) GLOBALMACP0A1(fluxdump,i,j,k,0*NPR + pl)=dUgeom[pl];</div>
<div class="line"><a name="l02510"></a><span class="lineno"> 2510</span>&#160;</div>
<div class="line"><a name="l02511"></a><span class="lineno"> 2511</span>&#160;      if(<a class="code" href="../../da/d3e/definit_8h.html#abd7b39be02bc15d79b73e5cf2b531299" title="#define CORNGDETVERSION 0">N1</a>&gt;1) <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) GLOBALMACP0A1(fluxdump,i,j,k,1*NPR + pl)=dUriemann1[pl];</div>
<div class="line"><a name="l02512"></a><span class="lineno"> 2512</span>&#160;      else <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) GLOBALMACP0A1(fluxdump,i,j,k,1*NPR + pl)=0.0;</div>
<div class="line"><a name="l02513"></a><span class="lineno"> 2513</span>&#160;  </div>
<div class="line"><a name="l02514"></a><span class="lineno"> 2514</span>&#160;      if(<a class="code" href="../../da/d3e/definit_8h.html#acd864640121c7df2c19f61f7baa507e4">N2</a>&gt;1) <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) GLOBALMACP0A1(fluxdump,i,j,k,2*NPR + pl)=dUriemann2[pl];</div>
<div class="line"><a name="l02515"></a><span class="lineno"> 2515</span>&#160;      else <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) GLOBALMACP0A1(fluxdump,i,j,k,2*NPR + pl)=0.0;</div>
<div class="line"><a name="l02516"></a><span class="lineno"> 2516</span>&#160;</div>
<div class="line"><a name="l02517"></a><span class="lineno"> 2517</span>&#160;      if(<a class="code" href="../../da/d3e/definit_8h.html#ad66109fbdc4d3adc9c3d6ff917038aef">N3</a>&gt;1) <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) GLOBALMACP0A1(fluxdump,i,j,k,3*NPR + pl)=dUriemann3[pl];</div>
<div class="line"><a name="l02518"></a><span class="lineno"> 2518</span>&#160;      else <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) GLOBALMACP0A1(fluxdump,i,j,k,3*NPR + pl)=0.0;</div>
<div class="line"><a name="l02519"></a><span class="lineno"> 2519</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02520"></a><span class="lineno"> 2520</span>&#160;<span class="preprocessor"></span>  </div>
<div class="line"><a name="l02521"></a><span class="lineno"> 2521</span>&#160;</div>
<div class="line"><a name="l02522"></a><span class="lineno"> 2522</span>&#160;    }<span class="comment">// end 3D LOOP</span></div>
<div class="line"><a name="l02523"></a><span class="lineno"> 2523</span>&#160;  }<span class="comment">//end parallel region</span></div>
<div class="line"><a name="l02524"></a><span class="lineno"> 2524</span>&#160;</div>
<div class="line"><a name="l02525"></a><span class="lineno"> 2525</span>&#160;</div>
<div class="line"><a name="l02526"></a><span class="lineno"> 2526</span>&#160;</div>
<div class="line"><a name="l02527"></a><span class="lineno"> 2527</span>&#160;</div>
<div class="line"><a name="l02528"></a><span class="lineno"> 2528</span>&#160;</div>
<div class="line"><a name="l02530"></a><span class="lineno"> 2530</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02531"></a><span class="lineno"> 2531</span>&#160;  <span class="comment">// EVOLVE (update/compute) METRIC HERE</span></div>
<div class="line"><a name="l02532"></a><span class="lineno"> 2532</span>&#160;  <span class="comment">// In general computes stress-energy tensor (T) from pb and T is then used to compute metric</span></div>
<div class="line"><a name="l02533"></a><span class="lineno"> 2533</span>&#160;  <span class="comment">// Done here instead of after flux since horizon_flux() updates flux through boundary that would change metric</span></div>
<div class="line"><a name="l02534"></a><span class="lineno"> 2534</span>&#160;  <span class="comment">// want metric to be at same time as everythin else done with pb so RK method is consistent</span></div>
<div class="line"><a name="l02535"></a><span class="lineno"> 2535</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02536"></a><span class="lineno"> 2536</span>&#160;  <span class="comment">// uses unew that&#39;s NOT updated yet</span></div>
<div class="line"><a name="l02538"></a><span class="lineno"> 2538</span>&#160;<span class="comment"></span>  <span class="keywordflow">if</span>(truestep){</div>
<div class="line"><a name="l02539"></a><span class="lineno"> 2539</span>&#160;<span class="preprocessor">#if(SPLITNPR)</span></div>
<div class="line"><a name="l02540"></a><span class="lineno"> 2540</span>&#160;<span class="preprocessor"></span>    <span class="comment">// don&#39;t update metric if only doing B1-B3</span></div>
<div class="line"><a name="l02541"></a><span class="lineno"> 2541</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../d8/d5b/defs_8general_8h.html#aa2010d23a21177641277f5119a2705c7">advancepassnumber</a>==-1 || <a class="code" href="../../d8/d5b/defs_8general_8h.html#aa2010d23a21177641277f5119a2705c7">advancepassnumber</a>==1)</div>
<div class="line"><a name="l02542"></a><span class="lineno"> 2542</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02543"></a><span class="lineno"> 2543</span>&#160;<span class="preprocessor"></span>      {</div>
<div class="line"><a name="l02544"></a><span class="lineno"> 2544</span>&#160;        compute_new_metric_substep(CUf,CUnew,pb,ucumformetric); <span class="comment">// CHANGINGMARK : Not sure if CUnew here is correct</span></div>
<div class="line"><a name="l02545"></a><span class="lineno"> 2545</span>&#160;      }</div>
<div class="line"><a name="l02546"></a><span class="lineno"> 2546</span>&#160;  }</div>
<div class="line"><a name="l02547"></a><span class="lineno"> 2547</span>&#160;</div>
<div class="line"><a name="l02548"></a><span class="lineno"> 2548</span>&#160;</div>
<div class="line"><a name="l02549"></a><span class="lineno"> 2549</span>&#160;</div>
<div class="line"><a name="l02551"></a><span class="lineno"> 2551</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02552"></a><span class="lineno"> 2552</span>&#160;  <span class="comment">// compute flux diagnostics (accurately using all substeps)</span></div>
<div class="line"><a name="l02553"></a><span class="lineno"> 2553</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02555"></a><span class="lineno"> 2555</span>&#160;<span class="comment"></span>  <span class="keywordflow">if</span>(doflux &amp;&amp; truestep){</div>
<div class="line"><a name="l02556"></a><span class="lineno"> 2556</span>&#160;    <span class="comment">// must come after metric changes that can change where flux surface is since otherwise when flux surface changes, we won&#39;t track this substep&#39;s flux through the new surface but the old surface (which could even be at r=0 and have no flux)</span></div>
<div class="line"><a name="l02557"></a><span class="lineno"> 2557</span>&#160;    <span class="comment">// if using unew, then since metric update above uses old unew, need present flux at new horizon surface</span></div>
<div class="line"><a name="l02558"></a><span class="lineno"> 2558</span>&#160;<span class="preprocessor">#if(SPLITNPR)</span></div>
<div class="line"><a name="l02559"></a><span class="lineno"> 2559</span>&#160;<span class="preprocessor"></span>    <span class="comment">// don&#39;t update metric if only doing B1-B3</span></div>
<div class="line"><a name="l02560"></a><span class="lineno"> 2560</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../d8/d5b/defs_8general_8h.html#aa2010d23a21177641277f5119a2705c7">advancepassnumber</a>==-1 || <a class="code" href="../../d8/d5b/defs_8general_8h.html#aa2010d23a21177641277f5119a2705c7">advancepassnumber</a>==1)</div>
<div class="line"><a name="l02561"></a><span class="lineno"> 2561</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02562"></a><span class="lineno"> 2562</span>&#160;<span class="preprocessor"></span>      {</div>
<div class="line"><a name="l02563"></a><span class="lineno"> 2563</span>&#160;<span class="preprocessor">#if(ACCURATEDIAG)</span></div>
<div class="line"><a name="l02564"></a><span class="lineno"> 2564</span>&#160;<span class="preprocessor"></span>        diag_flux_pureflux(pb,F1, F2, F3, fluxdt); <span class="comment">// fluxdt is true dt for this flux as added in dUtoU() as part of ucum update</span></div>
<div class="line"><a name="l02565"></a><span class="lineno"> 2565</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02566"></a><span class="lineno"> 2566</span>&#160;<span class="preprocessor"></span>      }</div>
<div class="line"><a name="l02567"></a><span class="lineno"> 2567</span>&#160;  }</div>
<div class="line"><a name="l02568"></a><span class="lineno"> 2568</span>&#160;</div>
<div class="line"><a name="l02569"></a><span class="lineno"> 2569</span>&#160;</div>
<div class="line"><a name="l02570"></a><span class="lineno"> 2570</span>&#160;</div>
<div class="line"><a name="l02571"></a><span class="lineno"> 2571</span>&#160;</div>
<div class="line"><a name="l02572"></a><span class="lineno"> 2572</span>&#160;</div>
<div class="line"><a name="l02573"></a><span class="lineno"> 2573</span>&#160;</div>
<div class="line"><a name="l02574"></a><span class="lineno"> 2574</span>&#160;</div>
<div class="line"><a name="l02576"></a><span class="lineno"> 2576</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02577"></a><span class="lineno"> 2577</span>&#160;  <span class="comment">// Copy over tempucum -&gt; ucum per pl to account for staggered field</span></div>
<div class="line"><a name="l02578"></a><span class="lineno"> 2578</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02579"></a><span class="lineno"> 2579</span>&#160;  <span class="comment">// and volume differentiate the conserved quantity</span></div>
<div class="line"><a name="l02580"></a><span class="lineno"> 2580</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02582"></a><span class="lineno"> 2582</span>&#160;<span class="comment"></span>  <span class="keywordflow">if</span>(finalstep){</div>
<div class="line"><a name="l02583"></a><span class="lineno"> 2583</span>&#160;    <span class="comment">// last call, so ucum is cooked and ready to eat!</span></div>
<div class="line"><a name="l02584"></a><span class="lineno"> 2584</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a11c4e99e1493d0c1914ad1ab313ea472">FLUXB</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0b6762cef74e396f50a83864bb53fb6c">FLUXCTSTAG</a>){</div>
<div class="line"><a name="l02585"></a><span class="lineno"> 2585</span>&#160;      copy_tempucum_finalucum(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac578a63f887dbc4797b555bd9c468a5f">DOALLPL</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#ab5c60dcb37b1f7e5642525031cd5cbcf">Uconsevolveloop</a>,tempucum,ucum);</div>
<div class="line"><a name="l02586"></a><span class="lineno"> 2586</span>&#160;    }</div>
<div class="line"><a name="l02587"></a><span class="lineno"> 2587</span>&#160;    <span class="comment">// useducum only used after ucum assigned to ui above</span></div>
<div class="line"><a name="l02588"></a><span class="lineno"> 2588</span>&#160;    utoinvert=ucum;</div>
<div class="line"><a name="l02589"></a><span class="lineno"> 2589</span>&#160;    useducum=ucum;</div>
<div class="line"><a name="l02590"></a><span class="lineno"> 2590</span>&#160;    <span class="comment">//    ubound=utoinvert;</span></div>
<div class="line"><a name="l02591"></a><span class="lineno"> 2591</span>&#160;  }</div>
<div class="line"><a name="l02592"></a><span class="lineno"> 2592</span>&#160;  <span class="keywordflow">else</span>{ <span class="comment">// otherwise still iterating on primitives</span></div>
<div class="line"><a name="l02593"></a><span class="lineno"> 2593</span>&#160;    <span class="comment">// don&#39;t need to copy over tempucum-&gt;ucum yet</span></div>
<div class="line"><a name="l02594"></a><span class="lineno"> 2594</span>&#160;    utoinvert=uf;</div>
<div class="line"><a name="l02595"></a><span class="lineno"> 2595</span>&#160;    useducum=tempucum;</div>
<div class="line"><a name="l02596"></a><span class="lineno"> 2596</span>&#160;    <span class="comment">//    ubound=utoinvert;</span></div>
<div class="line"><a name="l02597"></a><span class="lineno"> 2597</span>&#160;  }</div>
<div class="line"><a name="l02598"></a><span class="lineno"> 2598</span>&#160;</div>
<div class="line"><a name="l02599"></a><span class="lineno"> 2599</span>&#160;  <span class="comment">// GODMARK: use of globals</span></div>
<div class="line"><a name="l02600"></a><span class="lineno"> 2600</span>&#160;  myupoint=<a class="code" href="../../df/d1c/global_8storage_8h.html#ad89dafa5d772b862a44b0f576983ead3" title="shifted pointer (a_s_) wrappers Couldn&#39;t figure out how to macrofy a_s_ or a_, so when changing have ...">GLOBALPOINT</a>(upointglobal);</div>
<div class="line"><a name="l02601"></a><span class="lineno"> 2601</span>&#160;</div>
<div class="line"><a name="l02602"></a><span class="lineno"> 2602</span>&#160;</div>
<div class="line"><a name="l02603"></a><span class="lineno"> 2603</span>&#160;</div>
<div class="line"><a name="l02604"></a><span class="lineno"> 2604</span>&#160;  <span class="comment">// to debug ENO</span></div>
<div class="line"><a name="l02605"></a><span class="lineno"> 2605</span>&#160;  <span class="comment">//#if(DOENODEBUG)</span></div>
<div class="line"><a name="l02606"></a><span class="lineno"> 2606</span>&#160;  <span class="comment">//debugeno_compute(pb,utoinvert,enodebugarray); //SASDEBUG -- OLD USE: now assign debugs inside reconstructeno code</span></div>
<div class="line"><a name="l02607"></a><span class="lineno"> 2607</span>&#160;  <span class="comment">//#endif</span></div>
<div class="line"><a name="l02608"></a><span class="lineno"> 2608</span>&#160;</div>
<div class="line"><a name="l02609"></a><span class="lineno"> 2609</span>&#160;</div>
<div class="line"><a name="l02610"></a><span class="lineno"> 2610</span>&#160;</div>
<div class="line"><a name="l02611"></a><span class="lineno"> 2611</span>&#160;</div>
<div class="line"><a name="l02612"></a><span class="lineno"> 2612</span>&#160;</div>
<div class="line"><a name="l02613"></a><span class="lineno"> 2613</span>&#160;  <span class="comment">// a2c_1 a2c_2 a2c_3</span></div>
<div class="line"><a name="l02614"></a><span class="lineno"> 2614</span>&#160;  <span class="keywordflow">if</span>(docons){</div>
<div class="line"><a name="l02615"></a><span class="lineno"> 2615</span>&#160;    <span class="keywordtype">int</span> pl,pliter;</div>
<div class="line"><a name="l02616"></a><span class="lineno"> 2616</span>&#160;    <span class="comment">// conserved quantity is limited later after primitive is obtained</span></div>
<div class="line"><a name="l02617"></a><span class="lineno"> 2617</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl) locpl[pl]=CENT;</div>
<div class="line"><a name="l02618"></a><span class="lineno"> 2618</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl) whichpltoavg[pl]=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a42a3e0ccdd6805791cf169d439d305d6">do_conserved_integration</a>[pl];<span class="comment">// default</span></div>
<div class="line"><a name="l02619"></a><span class="lineno"> 2619</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl) ifnotavgthencopy[pl]=1-<a class="code" href="../../d8/d5b/defs_8general_8h.html#a42a3e0ccdd6805791cf169d439d305d6">do_conserved_integration</a>[pl];<span class="comment">// default</span></div>
<div class="line"><a name="l02620"></a><span class="lineno"> 2620</span>&#160;    avg2cen_interp(locpl,whichpltoavg, ifnotavgthencopy, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ad1fd1d9616fb6fb4583f1c1abfd783dd">ENOCONSERVED</a>, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a05cc377983df7497bdf0c89bbbd6886d">ENOAVG2CENTTYPE</a>, pb, utoinvert, myupoint);  <span class="comment">//SASMARK:  pb&#39;s for shock indicators should be defined on ALL grid, not only on ghost+active.  Maybe should use pi instead because define everywhere?</span></div>
<div class="line"><a name="l02621"></a><span class="lineno"> 2621</span>&#160;  }</div>
<div class="line"><a name="l02622"></a><span class="lineno"> 2622</span>&#160;  else{</div>
<div class="line"><a name="l02623"></a><span class="lineno"> 2623</span>&#160;    <span class="comment">//    myupoint=utoinvert;</span></div>
<div class="line"><a name="l02624"></a><span class="lineno"> 2624</span>&#160;    copy_tempucum_finalucum(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac578a63f887dbc4797b555bd9c468a5f">DOALLPL</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#ab5c60dcb37b1f7e5642525031cd5cbcf">Uconsevolveloop</a>,utoinvert,myupoint);</div>
<div class="line"><a name="l02625"></a><span class="lineno"> 2625</span>&#160;  }</div>
<div class="line"><a name="l02626"></a><span class="lineno"> 2626</span>&#160;</div>
<div class="line"><a name="l02627"></a><span class="lineno"> 2627</span>&#160;</div>
<div class="line"><a name="l02628"></a><span class="lineno"> 2628</span>&#160;</div>
<div class="line"><a name="l02630"></a><span class="lineno"> 2630</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02631"></a><span class="lineno"> 2631</span>&#160;  <span class="comment">// split CZLOOP above and below to allow staggered field method</span></div>
<div class="line"><a name="l02632"></a><span class="lineno"> 2632</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02634"></a><span class="lineno"> 2634</span>&#160;<span class="comment"></span>  <span class="keywordflow">if</span>(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a11c4e99e1493d0c1914ad1ab313ea472">FLUXB</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0b6762cef74e396f50a83864bb53fb6c">FLUXCTSTAG</a>){</div>
<div class="line"><a name="l02635"></a><span class="lineno"> 2635</span>&#160;    <span class="comment">// if using staggered grid for magnetic field, then need to convert ucum to pstag to new pb/pf</span></div>
<div class="line"><a name="l02636"></a><span class="lineno"> 2636</span>&#160;</div>
<div class="line"><a name="l02637"></a><span class="lineno"> 2637</span>&#160;    <span class="comment">// GODMARK: If had c2a/a2c with 3-point outputs, then could do avg2cen_interp and below at once</span></div>
<div class="line"><a name="l02638"></a><span class="lineno"> 2638</span>&#160;</div>
<div class="line"><a name="l02639"></a><span class="lineno"> 2639</span>&#160;    <span class="comment">// first pb entry is used for shock indicator, second is filled with new field</span></div>
<div class="line"><a name="l02640"></a><span class="lineno"> 2640</span>&#160;    <a class="code" href="../../d0/dde/fluxctstag_8c.html#a3c59ef3a54b18bbaf4970c13995dadfc" title="wrapper for taking staggered conserved field quantity and obtaining centered field quantity upoint en...">interpolate_ustag2fieldcent</a>(stage, boundtime, timeorder, numtimeorders, pb, pstag, myupoint, pf);</div>
<div class="line"><a name="l02641"></a><span class="lineno"> 2641</span>&#160;</div>
<div class="line"><a name="l02643"></a><span class="lineno"> 2643</span>&#160;    <span class="comment">// now utoinvert contains centered point conserved quantities ready for inversion</span></div>
<div class="line"><a name="l02645"></a><span class="lineno"> 2645</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02646"></a><span class="lineno"> 2646</span>&#160;  }</div>
<div class="line"><a name="l02647"></a><span class="lineno"> 2647</span>&#160;</div>
<div class="line"><a name="l02648"></a><span class="lineno"> 2648</span>&#160;</div>
<div class="line"><a name="l02649"></a><span class="lineno"> 2649</span>&#160;</div>
<div class="line"><a name="l02650"></a><span class="lineno"> 2650</span>&#160;</div>
<div class="line"><a name="l02652"></a><span class="lineno"> 2652</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02653"></a><span class="lineno"> 2653</span>&#160;  <span class="comment">// Invert U -&gt; p</span></div>
<div class="line"><a name="l02654"></a><span class="lineno"> 2654</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02655"></a><span class="lineno"> 2655</span>&#160;  <span class="comment">// and fixup p if inversion bad</span></div>
<div class="line"><a name="l02656"></a><span class="lineno"> 2656</span>&#160;  <span class="comment">// and compute dissipation rate if requested</span></div>
<div class="line"><a name="l02657"></a><span class="lineno"> 2657</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02659"></a><span class="lineno"> 2659</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02660"></a><span class="lineno"> 2660</span>&#160;</div>
<div class="line"><a name="l02661"></a><span class="lineno"> 2661</span>&#160;  <span class="comment">// get loop range</span></div>
<div class="line"><a name="l02662"></a><span class="lineno"> 2662</span>&#160;  get_inversion_startendindices(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ab5c60dcb37b1f7e5642525031cd5cbcf">Uconsevolveloop</a>,&amp;is,&amp;ie,&amp;js,&amp;je,&amp;ks,&amp;ke);</div>
<div class="line"><a name="l02663"></a><span class="lineno"> 2663</span>&#160;</div>
<div class="line"><a name="l02664"></a><span class="lineno"> 2664</span>&#160;<span class="preprocessor">#pragma omp parallel OPENMPGLOBALPRIVATEFORINVERSION</span></div>
<div class="line"><a name="l02665"></a><span class="lineno"> 2665</span>&#160;<span class="preprocessor"></span>  {</div>
<div class="line"><a name="l02666"></a><span class="lineno"> 2666</span>&#160;    <span class="keywordtype">int</span> <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>,<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>,k,pl,pliter;</div>
<div class="line"><a name="l02667"></a><span class="lineno"> 2667</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> prbefore[NPR];</div>
<div class="line"><a name="l02668"></a><span class="lineno"> 2668</span>&#160;    <span class="keyword">struct </span><a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> geomdontuse;</div>
<div class="line"><a name="l02669"></a><span class="lineno"> 2669</span>&#160;    <span class="keyword">struct </span><a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom=&amp;geomdontuse;</div>
<div class="line"><a name="l02670"></a><span class="lineno"> 2670</span>&#160;    <span class="keyword">struct </span><a class="code" href="../../db/d3a/structof__newtonstats.html">of_newtonstats</a> newtonstats; setnewtonstatsdefault(&amp;newtonstats);</div>
<div class="line"><a name="l02671"></a><span class="lineno"> 2671</span>&#160;    <span class="keywordtype">int</span> showmessages=1;</div>
<div class="line"><a name="l02672"></a><span class="lineno"> 2672</span>&#160;    <span class="keywordtype">int</span> allowlocalfailurefixandnoreport=1; <span class="comment">// allow local fixups</span></div>
<div class="line"><a name="l02673"></a><span class="lineno"> 2673</span>&#160;    </div>
<div class="line"><a name="l02674"></a><span class="lineno"> 2674</span>&#160;    <span class="comment">// setup default eomtype</span></div>
<div class="line"><a name="l02675"></a><span class="lineno"> 2675</span>&#160;    <span class="keywordtype">int</span> eomtype;</div>
<div class="line"><a name="l02676"></a><span class="lineno"> 2676</span>&#160;</div>
<div class="line"><a name="l02677"></a><span class="lineno"> 2677</span>&#160;</div>
<div class="line"><a name="l02678"></a><span class="lineno"> 2678</span>&#160;    <a class="code" href="../../d5/d7b/global_8openmploops_8h.html#a1389db2daf5bd9e94918090c253a16c9">OPENMP3DLOOPVARSDEFINE</a>;  <a class="code" href="../../d5/d7b/global_8openmploops_8h.html#a8de37da93c3462c536ef830f2fbaee61" title="forced to be a computational loop, so start/stop cannot already have shifts in them (which is normal ...">OPENMP3DLOOPSETUP</a>(is,ie,js,je,ks,ke);</div>
<div class="line"><a name="l02679"></a><span class="lineno"> 2679</span>&#160;</div>
<div class="line"><a name="l02680"></a><span class="lineno"> 2680</span>&#160;    <span class="comment">// initialize counters</span></div>
<div class="line"><a name="l02681"></a><span class="lineno"> 2681</span>&#160;    newtonstats.nstroke=newtonstats.lntries=0;</div>
<div class="line"><a name="l02682"></a><span class="lineno"> 2682</span>&#160;    <span class="comment">// ptr different when in parallel region</span></div>
<div class="line"><a name="l02683"></a><span class="lineno"> 2683</span>&#160;    ptrgeom=&amp;geomdontuse;</div>
<div class="line"><a name="l02684"></a><span class="lineno"> 2684</span>&#160;</div>
<div class="line"><a name="l02685"></a><span class="lineno"> 2685</span>&#160;<span class="preprocessor">#pragma omp for schedule(OPENMPVARYENDTIMESCHEDULE(),OPENMPCHUNKSIZE(blocksize)) reduction(+: nstroke)</span></div>
<div class="line"><a name="l02686"></a><span class="lineno"> 2686</span>&#160;<span class="preprocessor"></span>    <a class="code" href="../../d5/d7b/global_8openmploops_8h.html#a9e48537d3cb58cc3a3765b8a18b43b15" title="Oddly, performance changes by 10% when changing how start and stop blockijk (and fixing how used too ...">OPENMP3DLOOPBLOCK</a>{</div>
<div class="line"><a name="l02687"></a><span class="lineno"> 2687</span>&#160;      <a class="code" href="../../df/d1c/global_8storage_8h.html#a96983b0c56e836f50cb7c1af16f59fb6">OPENMP3DLOOPBLOCK2IJK</a>(i,j,k);</div>
<div class="line"><a name="l02688"></a><span class="lineno"> 2688</span>&#160;</div>
<div class="line"><a name="l02689"></a><span class="lineno"> 2689</span>&#160;      <span class="comment">// setup default eomtype (KORALTODO: GODMARK: Doesn&#39;t use source() version of eomtype from above)</span></div>
<div class="line"><a name="l02690"></a><span class="lineno"> 2690</span>&#160;      eomtype=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aa28b06d889a02621b45edc716bfb2d01">EOMDEFAULT</a>;</div>
<div class="line"><a name="l02691"></a><span class="lineno"> 2691</span>&#160; </div>
<div class="line"><a name="l02692"></a><span class="lineno"> 2692</span>&#160;      <span class="comment">// set geometry for centered zone to be updated</span></div>
<div class="line"><a name="l02693"></a><span class="lineno"> 2693</span>&#160;      <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a3059ed7bfcfb692cbe8014d55fd7c1e4">get_geometry</a>(i, j, k, CENT, ptrgeom);</div>
<div class="line"><a name="l02694"></a><span class="lineno"> 2694</span>&#160;</div>
<div class="line"><a name="l02695"></a><span class="lineno"> 2695</span>&#160;</div>
<div class="line"><a name="l02696"></a><span class="lineno"> 2696</span>&#160;      <span class="comment">// store guess for diss_compute before changed by normal inversion</span></div>
<div class="line"><a name="l02697"></a><span class="lineno"> 2697</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#ad5ba6b43c072aca55951657f023cbfc3" title="always goes over all conserved">PALLLOOP</a>(pl) prbefore[pl]=<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(pf,i,j,k,pl);</div>
<div class="line"><a name="l02698"></a><span class="lineno"> 2698</span>&#160;  </div>
<div class="line"><a name="l02699"></a><span class="lineno"> 2699</span>&#160;</div>
<div class="line"><a name="l02700"></a><span class="lineno"> 2700</span>&#160;      <span class="comment">// invert point U-&gt; point p</span></div>
<div class="line"><a name="l02701"></a><span class="lineno"> 2701</span>&#160;      <span class="keywordtype">int</span> dissmeasure=-1.0; <span class="comment">// assume ok to try energy</span></div>
<div class="line"><a name="l02702"></a><span class="lineno"> 2702</span>&#160;      <span class="keywordtype">int</span> whichcap=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a4b6c6060c025e15f1d92aae3dcb9365b" title="which cap type to place in rad inversion">CAPTYPEBASIC</a>;</div>
<div class="line"><a name="l02703"></a><span class="lineno"> 2703</span>&#160;      <span class="keywordtype">int</span> whichmethod=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aef33cf4e6c2534137907bc2eaefdb224">MODEPICKBEST</a>; <span class="comment">// try to choose best option for this &quot;external&quot; inversion</span></div>
<div class="line"><a name="l02704"></a><span class="lineno"> 2704</span>&#160;      <span class="keywordtype">int</span> modprim=0;</div>
<div class="line"><a name="l02705"></a><span class="lineno"> 2705</span>&#160;      <span class="keywordtype">int</span> checkoninversiongas=<a class="code" href="../../da/d3e/definit_8h.html#a5dc18e6d15e4420586d45d912fccebac" title="whether to check on inversion and report problem Also, use diag_fixup() to account for changes in U w...">CHECKONINVERSION</a>;</div>
<div class="line"><a name="l02706"></a><span class="lineno"> 2706</span>&#160;      <span class="keywordtype">int</span> checkoninversionrad=<a class="code" href="../../da/d3e/definit_8h.html#a70e4418eb8c6479afc202024b46ad581">CHECKONINVERSIONRAD</a>;</div>
<div class="line"><a name="l02707"></a><span class="lineno"> 2707</span>&#160;      <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(<a class="code" href="../../d1/d3e/utoprimgen_8c.html#a7e078cc9a354495bc85554d875a705d9" title="General explicit inversion of U[MHD]-&gt;P[MHD] and also inverts scalars. Inverts radiation if(EOMRADTYP...">Utoprimgen</a>(showmessages,checkoninversiongas,checkoninversionrad,allowlocalfailurefixandnoreport, finalstep,&amp;eomtype,whichcap,whichmethod,modprim,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a7d1dc231c422450f87fdb3e71b4a7aff" title="defines how Utoprimgen is used">EVOLVEUTOPRIM</a>, <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a15d073255fcc246f09aa26337e643d22" title="defines data return types for primtoU() and primtoflux()">UEVOLVE</a>, <a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(myupoint,i,j,k), NULL, ptrgeom, dissmeasure, <a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(pi,i,j,k), <a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(pf,i,j,k),&amp;newtonstats),&quot;<a class="code" href="../../d9/de0/step__ch_8c.html#afe241569412f22a86dea9cd91b516af8" title="take step itself">step_ch</a>.c:advance()&quot;, &quot;<a class="code" href="../../d1/d3e/utoprimgen_8c.html#a7e078cc9a354495bc85554d875a705d9" title="General explicit inversion of U[MHD]-&gt;P[MHD] and also inverts scalars. Inverts radiation if(EOMRADTYP...">Utoprimgen</a>&quot;, 1);</div>
<div class="line"><a name="l02708"></a><span class="lineno"> 2708</span>&#160;      <a class="code" href="../../d8/d5b/defs_8general_8h.html#a5f1c4a4bf07f7a6010404484cb9e6b50">nstroke</a>+=newtonstats.<a class="code" href="../../d8/d5b/defs_8general_8h.html#a5f1c4a4bf07f7a6010404484cb9e6b50">nstroke</a>; newtonstats.nstroke=newtonstats.<a class="code" href="../../db/d3a/structof__newtonstats.html#a83280998e47831044a7e35299495a9bb">lntries</a>=0;</div>
<div class="line"><a name="l02709"></a><span class="lineno"> 2709</span>&#160;</div>
<div class="line"><a name="l02710"></a><span class="lineno"> 2710</span>&#160;      <span class="comment">//If using a high order scheme, need to choose whether to trust the point value</span></div>
<div class="line"><a name="l02711"></a><span class="lineno"> 2711</span>&#160;      if(docons){</div>
<div class="line"><a name="l02712"></a><span class="lineno"> 2712</span>&#160;        <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(check_point_vs_average(timeorder, numtimeorders, <a class="code" href="../../df/d1c/global_8storage_8h.html#a5dd5a282922755d8516bcbf69ccfa767">GLOBALMAC</a>(pflag,i,j,k),<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(pb,i,j,k),<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(pf,i,j,k),<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(myupoint,i,j,k),<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(utoinvert,i,j,k),ptrgeom,&amp;newtonstats),<span class="stringliteral">&quot;advance.c:advance_finitevolume()&quot;</span>, <span class="stringliteral">&quot;check_point_vs_average()&quot;</span>, 1);</div>
<div class="line"><a name="l02713"></a><span class="lineno"> 2713</span>&#160;      }</div>
<div class="line"><a name="l02714"></a><span class="lineno"> 2714</span>&#160;</div>
<div class="line"><a name="l02715"></a><span class="lineno"> 2715</span>&#160;</div>
<div class="line"><a name="l02716"></a><span class="lineno"> 2716</span>&#160;<span class="preprocessor">#if(DODISS||DODISSVSR)</span></div>
<div class="line"><a name="l02717"></a><span class="lineno"> 2717</span>&#160;<span class="preprocessor"></span>      <span class="keywordflow">if</span>(finalstep){</div>
<div class="line"><a name="l02718"></a><span class="lineno"> 2718</span>&#160;        <span class="comment">// then see what entropy inversion would give</span></div>
<div class="line"><a name="l02719"></a><span class="lineno"> 2719</span>&#160;        diss_compute(EVOLVEUTOPRIM,UEVOLVE,<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(useducum,i,j,k),ptrgeom,prbefore, <a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(pf,i,j,k),&amp;newtonstats);</div>
<div class="line"><a name="l02720"></a><span class="lineno"> 2720</span>&#160;      }</div>
<div class="line"><a name="l02721"></a><span class="lineno"> 2721</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02722"></a><span class="lineno"> 2722</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l02723"></a><span class="lineno"> 2723</span>&#160;</div>
<div class="line"><a name="l02724"></a><span class="lineno"> 2724</span>&#160;<span class="preprocessor">#if(SPLITNPR)</span></div>
<div class="line"><a name="l02725"></a><span class="lineno"> 2725</span>&#160;<span class="preprocessor"></span>      <span class="comment">// don&#39;t update metric if only doing B1-B3</span></div>
<div class="line"><a name="l02726"></a><span class="lineno"> 2726</span>&#160;      <span class="keywordflow">if</span>(<a class="code" href="../../d8/d5b/defs_8general_8h.html#aa2010d23a21177641277f5119a2705c7">advancepassnumber</a>==-1 || <a class="code" href="../../d8/d5b/defs_8general_8h.html#aa2010d23a21177641277f5119a2705c7">advancepassnumber</a>==1)</div>
<div class="line"><a name="l02727"></a><span class="lineno"> 2727</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02728"></a><span class="lineno"> 2728</span>&#160;<span class="preprocessor"></span>        {</div>
<div class="line"><a name="l02729"></a><span class="lineno"> 2729</span>&#160;          <span class="comment">// immediate local (i.e. 1-zone) fix</span></div>
<div class="line"><a name="l02730"></a><span class="lineno"> 2730</span>&#160;<span class="preprocessor">#if(FIXUPZONES==FIXUP1ZONE)</span></div>
<div class="line"><a name="l02731"></a><span class="lineno"> 2731</span>&#160;<span class="preprocessor"></span>          <span class="comment">// SUPERGODMARK: Below should differentiate beteween whether want negative densities fixed or not, but right now fixup1zone() does all</span></div>
<div class="line"><a name="l02732"></a><span class="lineno"> 2732</span>&#160;          <span class="keywordflow">if</span>((<a class="code" href="../../da/d3e/definit_8h.html#a01d34fa922c4eaac94e27f2179523626" title="whether to allow negative internal energy in substep UTOPRIMFAILRETURNTYPE==UTOPRIMRETURNADJUSTED sho...">STEPOVERNEGU</a>==0)||(<a class="code" href="../../da/d3e/definit_8h.html#a23eeede57657104811b4f7e5e7dda656" title="seems to make things worse (more failures, but also worse failures)">STEPOVERNEGRHO</a>==0)||(<a class="code" href="../../d8/dc0/init_8h.html#a352ef6d348d5c3986dc77165755b8733">STEPOVERNEGRHOU</a>==0)||(finalstep)){</div>
<div class="line"><a name="l02733"></a><span class="lineno"> 2733</span>&#160;            <span class="keywordtype">int</span> docorrectucons=0;</div>
<div class="line"><a name="l02734"></a><span class="lineno"> 2734</span>&#160;            <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(fixup1zone(docorrectucons,<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(pf,i,j,k), <a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(useducum,i,j,k), ptrgeom, finalstep),<span class="stringliteral">&quot;advance.c:advance_finitevolume()&quot;</span>, <span class="stringliteral">&quot;fixup1zone()&quot;</span>, 1);</div>
<div class="line"><a name="l02735"></a><span class="lineno"> 2735</span>&#160;          }</div>
<div class="line"><a name="l02736"></a><span class="lineno"> 2736</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02737"></a><span class="lineno"> 2737</span>&#160;<span class="preprocessor"></span>        }</div>
<div class="line"><a name="l02738"></a><span class="lineno"> 2738</span>&#160;    }<span class="comment">// end COMPZLOOP</span></div>
<div class="line"><a name="l02739"></a><span class="lineno"> 2739</span>&#160;  }<span class="comment">// end parallel region</span></div>
<div class="line"><a name="l02740"></a><span class="lineno"> 2740</span>&#160;</div>
<div class="line"><a name="l02741"></a><span class="lineno"> 2741</span>&#160;</div>
<div class="line"><a name="l02742"></a><span class="lineno"> 2742</span>&#160;</div>
<div class="line"><a name="l02743"></a><span class="lineno"> 2743</span>&#160;</div>
<div class="line"><a name="l02744"></a><span class="lineno"> 2744</span>&#160;</div>
<div class="line"><a name="l02746"></a><span class="lineno"> 2746</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02747"></a><span class="lineno"> 2747</span>&#160;  <span class="comment">// If not fixing up primitives after inversion immediately, then fix up all zones at once afterwards</span></div>
<div class="line"><a name="l02748"></a><span class="lineno"> 2748</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02750"></a><span class="lineno"> 2750</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02751"></a><span class="lineno"> 2751</span>&#160;<span class="preprocessor">#if(SPLITNPR)</span></div>
<div class="line"><a name="l02752"></a><span class="lineno"> 2752</span>&#160;<span class="preprocessor"></span>  <span class="comment">// don&#39;t update metric if only doing B1-B3</span></div>
<div class="line"><a name="l02753"></a><span class="lineno"> 2753</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../d8/d5b/defs_8general_8h.html#aa2010d23a21177641277f5119a2705c7">advancepassnumber</a>==-1 || <a class="code" href="../../d8/d5b/defs_8general_8h.html#aa2010d23a21177641277f5119a2705c7">advancepassnumber</a>==1)</div>
<div class="line"><a name="l02754"></a><span class="lineno"> 2754</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02755"></a><span class="lineno"> 2755</span>&#160;<span class="preprocessor"></span>    {</div>
<div class="line"><a name="l02756"></a><span class="lineno"> 2756</span>&#160;<span class="preprocessor">#if(FIXUPZONES==FIXUPALLZONES)</span></div>
<div class="line"><a name="l02757"></a><span class="lineno"> 2757</span>&#160;<span class="preprocessor"></span>      fixup(stage,pf,useducum,finalstep);</div>
<div class="line"><a name="l02758"></a><span class="lineno"> 2758</span>&#160;<span class="preprocessor">#endif  </span></div>
<div class="line"><a name="l02759"></a><span class="lineno"> 2759</span>&#160;<span class="preprocessor"></span>    }</div>
<div class="line"><a name="l02760"></a><span class="lineno"> 2760</span>&#160;</div>
<div class="line"><a name="l02761"></a><span class="lineno"> 2761</span>&#160;</div>
<div class="line"><a name="l02762"></a><span class="lineno"> 2762</span>&#160;</div>
<div class="line"><a name="l02764"></a><span class="lineno"> 2764</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02765"></a><span class="lineno"> 2765</span>&#160;  <span class="comment">// Determine next timestep from waves, fluxes, and source updates</span></div>
<div class="line"><a name="l02766"></a><span class="lineno"> 2766</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02768"></a><span class="lineno"> 2768</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02769"></a><span class="lineno"> 2769</span>&#160;  prepare_globaldt(truestep,ndt1,ndt2,ndt3,accdt,accdti,accdtj,accdtk,gravitydt,gravitydti,gravitydtj,gravitydtk,ndt);</div>
<div class="line"><a name="l02770"></a><span class="lineno"> 2770</span>&#160; </div>
<div class="line"><a name="l02771"></a><span class="lineno"> 2771</span>&#160;</div>
<div class="line"><a name="l02772"></a><span class="lineno"> 2772</span>&#160;<span class="preprocessor">#if(PRODUCTION==0)</span></div>
<div class="line"><a name="l02773"></a><span class="lineno"> 2773</span>&#160;<span class="preprocessor"></span>  trifprintf( <span class="stringliteral">&quot;2f&quot;</span>);</div>
<div class="line"><a name="l02774"></a><span class="lineno"> 2774</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02775"></a><span class="lineno"> 2775</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l02776"></a><span class="lineno"> 2776</span>&#160;  <span class="keywordflow">return</span> (0);</div>
<div class="line"><a name="l02777"></a><span class="lineno"> 2777</span>&#160;}</div>
<div class="line"><a name="l02778"></a><span class="lineno"> 2778</span>&#160;</div>
<div class="line"><a name="l02779"></a><span class="lineno"> 2779</span>&#160;</div>
<div class="line"><a name="l02780"></a><span class="lineno"> 2780</span>&#160;</div>
<div class="line"><a name="l02781"></a><span class="lineno"> 2781</span>&#160;</div>
<div class="line"><a name="l02782"></a><span class="lineno"> 2782</span>&#160;</div>
<div class="line"><a name="l02784"></a><span class="lineno"> 2784</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> prepare_globaldt(</div>
<div class="line"><a name="l02785"></a><span class="lineno"> 2785</span>&#160;                            <span class="keywordtype">int</span> truestep,</div>
<div class="line"><a name="l02786"></a><span class="lineno"> 2786</span>&#160;                            <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ndt1,<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ndt2,<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ndt3,</div>
<div class="line"><a name="l02787"></a><span class="lineno"> 2787</span>&#160;                            <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> accdt,<span class="keywordtype">int</span> accdti,<span class="keywordtype">int</span> accdtj,<span class="keywordtype">int</span> accdtk,</div>
<div class="line"><a name="l02788"></a><span class="lineno"> 2788</span>&#160;                            <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gravitydt,<span class="keywordtype">int</span> gravitydti,<span class="keywordtype">int</span> gravitydtj,<span class="keywordtype">int</span> gravitydtk,</div>
<div class="line"><a name="l02789"></a><span class="lineno"> 2789</span>&#160;                            <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *ndt)</div>
<div class="line"><a name="l02790"></a><span class="lineno"> 2790</span>&#160;{</div>
<div class="line"><a name="l02791"></a><span class="lineno"> 2791</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> wavedt;</div>
<div class="line"><a name="l02792"></a><span class="lineno"> 2792</span>&#160;  <span class="keywordtype">int</span> jj;</div>
<div class="line"><a name="l02793"></a><span class="lineno"> 2793</span>&#160;</div>
<div class="line"><a name="l02794"></a><span class="lineno"> 2794</span>&#160;</div>
<div class="line"><a name="l02795"></a><span class="lineno"> 2795</span>&#160;</div>
<div class="line"><a name="l02797"></a><span class="lineno"> 2797</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02798"></a><span class="lineno"> 2798</span>&#160;  <span class="comment">// unsplit multidimensional Courant condition</span></div>
<div class="line"><a name="l02799"></a><span class="lineno"> 2799</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02801"></a><span class="lineno"> 2801</span>&#160;<span class="comment"></span>  <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#aa1449a3fdd665da411ee53a6d886e770" title="whether to compute per cell $dt$ by storing $dt$ per dimension and then computing minimum per cell ra...">PERCELLDT</a>==0){</div>
<div class="line"><a name="l02802"></a><span class="lineno"> 2802</span>&#160;    wavedt = <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a748444614dc4843c0b48bb5d23671554" title="for cour fixed for any dimensional problem, below makes no sense.">MINDTSET</a>(ndt1,ndt2,ndt3);</div>
<div class="line"><a name="l02803"></a><span class="lineno"> 2803</span>&#160;  }</div>
<div class="line"><a name="l02804"></a><span class="lineno"> 2804</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l02805"></a><span class="lineno"> 2805</span>&#160;    wavedt = ndt1; <span class="comment">// full result stored in *any* of ndt1,2,3 regardless of whether dimension is relevant</span></div>
<div class="line"><a name="l02806"></a><span class="lineno"> 2806</span>&#160;  }</div>
<div class="line"><a name="l02807"></a><span class="lineno"> 2807</span>&#160;</div>
<div class="line"><a name="l02808"></a><span class="lineno"> 2808</span>&#160;</div>
<div class="line"><a name="l02809"></a><span class="lineno"> 2809</span>&#160;</div>
<div class="line"><a name="l02811"></a><span class="lineno"> 2811</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02812"></a><span class="lineno"> 2812</span>&#160;  <span class="comment">// minimize dt over all &quot;operators&quot;</span></div>
<div class="line"><a name="l02813"></a><span class="lineno"> 2813</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02815"></a><span class="lineno"> 2815</span>&#160;<span class="comment"></span>  *ndt = <a class="code" href="../../d8/d5b/defs_8general_8h.html#a8685a7babea647420ac0741a6859f867">defcon</a> * <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(wavedt , accdt);</div>
<div class="line"><a name="l02816"></a><span class="lineno"> 2816</span>&#160;</div>
<div class="line"><a name="l02817"></a><span class="lineno"> 2817</span>&#160;<span class="preprocessor">#if(USEGRAVITYDTINDTLIMIT)</span></div>
<div class="line"><a name="l02818"></a><span class="lineno"> 2818</span>&#160;<span class="preprocessor"></span>  <span class="comment">// use gravitydt (often too small, but sometimes accdt/ndt not small enough)</span></div>
<div class="line"><a name="l02819"></a><span class="lineno"> 2819</span>&#160;  *ndt = <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(*ndt,gravitydt);</div>
<div class="line"><a name="l02820"></a><span class="lineno"> 2820</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02821"></a><span class="lineno"> 2821</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l02822"></a><span class="lineno"> 2822</span>&#160;</div>
<div class="line"><a name="l02824"></a><span class="lineno"> 2824</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02825"></a><span class="lineno"> 2825</span>&#160;  <span class="comment">// Store some global variables for timestep</span></div>
<div class="line"><a name="l02826"></a><span class="lineno"> 2826</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02828"></a><span class="lineno"> 2828</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02829"></a><span class="lineno"> 2829</span>&#160;  <a class="code" href="../../d8/d5b/defs_8general_8h.html#ae58178ca76ba1f6fd135877e28ca1409">gravitydtglobal</a> = gravitydt;</div>
<div class="line"><a name="l02830"></a><span class="lineno"> 2830</span>&#160;  <a class="code" href="../../d8/d5b/defs_8general_8h.html#a0a7150593e8f78afd7a91cfb19edab08">sourcedtglobal</a>  = accdt; <span class="comment">// accdt includes gravitydtglobal</span></div>
<div class="line"><a name="l02831"></a><span class="lineno"> 2831</span>&#160;  <a class="code" href="../../d8/d5b/defs_8general_8h.html#a0e73706eb0db019d8fa67c66f41d93d6">wavedtglobal</a>    = wavedt;</div>
<div class="line"><a name="l02832"></a><span class="lineno"> 2832</span>&#160;</div>
<div class="line"><a name="l02833"></a><span class="lineno"> 2833</span>&#160;<span class="preprocessor">#if(PRODUCTION==0)</span></div>
<div class="line"><a name="l02834"></a><span class="lineno"> 2834</span>&#160;<span class="preprocessor"></span>  <span class="keywordflow">if</span>(truestep){</div>
<div class="line"><a name="l02835"></a><span class="lineno"> 2835</span>&#160;    <span class="comment">// report per-CPU time-step limited every 100 time steps</span></div>
<div class="line"><a name="l02836"></a><span class="lineno"> 2836</span>&#160;</div>
<div class="line"><a name="l02837"></a><span class="lineno"> 2837</span>&#160;    <span class="comment">// GODMARK: 1 : do always</span></div>
<div class="line"><a name="l02838"></a><span class="lineno"> 2838</span>&#160;    <span class="keywordflow">if</span>(1|| <a class="code" href="../../d8/d5b/defs_8general_8h.html#a1a1088d87617078680f1fd0f0d707384">nstep</a>%<a class="code" href="../../d8/d5b/defs_8general_8h.html#a6650077e624189283a8fc864f948d3b5">DTr</a>==0){</div>
<div class="line"><a name="l02839"></a><span class="lineno"> 2839</span>&#160;      logdtfprintf(<span class="stringliteral">&quot;nstep=%ld steppart=%d :: dt=%g ndt=%g ndt1=%g ndt2=%g ndt3=%g\n&quot;</span>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a1a1088d87617078680f1fd0f0d707384">nstep</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a70170b90229f9fc05eebf8508a685c70">steppart</a>,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a56db625f31229c5e8b208ff27d464931">dt</a>,*ndt,ndt1,ndt2,ndt3);</div>
<div class="line"><a name="l02840"></a><span class="lineno"> 2840</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) logdtfprintf(&quot;dir=%d wavedti=%d wavedtj=%d wavedtk=%d\n&quot;,jj,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a60004d0cf271a3424b7d088a58535ca3">waveglobaldti</a>[jj],<a class="code" href="../../d8/d5b/defs_8general_8h.html#a3150634683ba5433c6fe8c3d0eda69fb">waveglobaldtj</a>[jj],<a class="code" href="../../d8/d5b/defs_8general_8h.html#ab3c7e902be71f8882765fe0a88986925">waveglobaldtk</a>[jj]);</div>
<div class="line"><a name="l02841"></a><span class="lineno"> 2841</span>&#160;      logdtfprintf(&quot;accdt=%g (accdti=%d accdtj=%d accdtk=%d) :: gravitydt=%g (gravitydti=%d gravitydtj=%d gravitydtk=%d) :: <a class="code" href="../../d8/d5b/defs_8general_8h.html#ae1aa0d402c34ec50b2da9371b5f69ce4">gravityskipstep</a>=%d\n&quot;,accdt,accdti,accdtj,accdtk,gravitydt,gravitydti,gravitydtj,gravitydtk,<a class="code" href="../../d8/d5b/defs_8general_8h.html#ae1aa0d402c34ec50b2da9371b5f69ce4">gravityskipstep</a>);</div>
<div class="line"><a name="l02842"></a><span class="lineno"> 2842</span>&#160;    }</div>
<div class="line"><a name="l02843"></a><span class="lineno"> 2843</span>&#160;  }</div>
<div class="line"><a name="l02844"></a><span class="lineno"> 2844</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02845"></a><span class="lineno"> 2845</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l02846"></a><span class="lineno"> 2846</span>&#160;</div>
<div class="line"><a name="l02847"></a><span class="lineno"> 2847</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l02848"></a><span class="lineno"> 2848</span>&#160;}</div>
<div class="line"><a name="l02849"></a><span class="lineno"> 2849</span>&#160;</div>
<div class="line"><a name="l02850"></a><span class="lineno"> 2850</span>&#160;</div>
<div class="line"><a name="l02851"></a><span class="lineno"> 2851</span>&#160;</div>
<div class="line"><a name="l02852"></a><span class="lineno"> 2852</span>&#160;</div>
<div class="line"><a name="l02853"></a><span class="lineno"> 2853</span>&#160;</div>
<div class="line"><a name="l02854"></a><span class="lineno"> 2854</span>&#160;</div>
<div class="line"><a name="l02855"></a><span class="lineno"> 2855</span>&#160;</div>
<div class="line"><a name="l02856"></a><span class="lineno"> 2856</span>&#160;</div>
<div class="line"><a name="l02857"></a><span class="lineno"> 2857</span>&#160;</div>
<div class="line"><a name="l02858"></a><span class="lineno"> 2858</span>&#160;</div>
<div class="line"><a name="l02859"></a><span class="lineno"> 2859</span>&#160;</div>
<div class="line"><a name="l02865"></a><span class="lineno"> 2865</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> check_point_vs_average(<span class="keywordtype">int</span> timeorder, <span class="keywordtype">int</span> numtimeorders, <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> *lpflag, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pb, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pf, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *upoint, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *uavg, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <span class="keyword">struct</span> <a class="code" href="../../db/d3a/structof__newtonstats.html">of_newtonstats</a> *newtonstats)</div>
<div class="line"><a name="l02866"></a><span class="lineno"> 2866</span>&#160;{</div>
<div class="line"><a name="l02867"></a><span class="lineno"> 2867</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> pavg[NPR];  <span class="comment">//atch for temporary storage of primitives obtained from inverting the averaged conserved quantities</span></div>
<div class="line"><a name="l02868"></a><span class="lineno"> 2868</span>&#160;  <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a9377001671b5ece8bb2a2cf636de4b8a">PFTYPE</a> invert_from_point_flag, invert_from_average_flag;</div>
<div class="line"><a name="l02869"></a><span class="lineno"> 2869</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> frac_avg_used;  <span class="comment">//this is be used for flux interpolation limiting</span></div>
<div class="line"><a name="l02870"></a><span class="lineno"> 2870</span>&#160;  <span class="keywordtype">int</span> pl,pliter;</div>
<div class="line"><a name="l02871"></a><span class="lineno"> 2871</span>&#160;  <span class="keywordtype">int</span> is_convergence_failure;</div>
<div class="line"><a name="l02872"></a><span class="lineno"> 2872</span>&#160;  <span class="keywordtype">int</span> avgschemeatall;</div>
<div class="line"><a name="l02873"></a><span class="lineno"> 2873</span>&#160;  <span class="keywordtype">int</span> finalstep;</div>
<div class="line"><a name="l02874"></a><span class="lineno"> 2874</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> <a class="code" href="../../df/d22/advance_8c.html#a0936d88b132d9655aa9287035a4793c5" title="If density or gamma-factors are different by more than fractional_difference_threshold for states pin...">limit_prim_correction</a>( <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fractional_difference_threshold, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *geom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pout );</div>
<div class="line"><a name="l02875"></a><span class="lineno"> 2875</span>&#160;  <span class="keywordtype">int</span> showmessages=1;</div>
<div class="line"><a name="l02876"></a><span class="lineno"> 2876</span>&#160;  <span class="keywordtype">int</span> allowlocalfailurefixandnoreport=1; <span class="comment">// allow local fixups</span></div>
<div class="line"><a name="l02877"></a><span class="lineno"> 2877</span>&#160;</div>
<div class="line"><a name="l02878"></a><span class="lineno"> 2878</span>&#160;  <span class="comment">// setup default eomtype</span></div>
<div class="line"><a name="l02879"></a><span class="lineno"> 2879</span>&#160;  <span class="keywordtype">int</span> eomtype=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aa28b06d889a02621b45edc716bfb2d01">EOMDEFAULT</a>;</div>
<div class="line"><a name="l02880"></a><span class="lineno"> 2880</span>&#160;</div>
<div class="line"><a name="l02881"></a><span class="lineno"> 2881</span>&#160;</div>
<div class="line"><a name="l02882"></a><span class="lineno"> 2882</span>&#160;  finalstep=timeorder == numtimeorders-1;</div>
<div class="line"><a name="l02883"></a><span class="lineno"> 2883</span>&#160;</div>
<div class="line"><a name="l02884"></a><span class="lineno"> 2884</span>&#160;</div>
<div class="line"><a name="l02885"></a><span class="lineno"> 2885</span>&#160;</div>
<div class="line"><a name="l02886"></a><span class="lineno"> 2886</span>&#160;  avgschemeatall=(<a class="code" href="../../d8/d5b/defs_8general_8h.html#adedce549d7ca97c62ec54f15549703eb">interporder</a>[<a class="code" href="../../d8/d5b/defs_8general_8h.html#acb6f71700ed482e84b69ee6bec92c303">avgscheme</a>[1]]&gt;3) ||  (<a class="code" href="../../d8/d5b/defs_8general_8h.html#adedce549d7ca97c62ec54f15549703eb">interporder</a>[<a class="code" href="../../d8/d5b/defs_8general_8h.html#acb6f71700ed482e84b69ee6bec92c303">avgscheme</a>[2]]&gt;3) ||  (<a class="code" href="../../d8/d5b/defs_8general_8h.html#adedce549d7ca97c62ec54f15549703eb">interporder</a>[<a class="code" href="../../d8/d5b/defs_8general_8h.html#acb6f71700ed482e84b69ee6bec92c303">avgscheme</a>[3]]&gt;3);</div>
<div class="line"><a name="l02887"></a><span class="lineno"> 2887</span>&#160;  <span class="keywordflow">if</span>(avgschemeatall==0) <span class="keywordflow">return</span>(0); <span class="comment">// since nothing to do</span></div>
<div class="line"><a name="l02888"></a><span class="lineno"> 2888</span>&#160;</div>
<div class="line"><a name="l02889"></a><span class="lineno"> 2889</span>&#160;</div>
<div class="line"><a name="l02890"></a><span class="lineno"> 2890</span>&#160;  invert_from_point_flag = lpflag[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>];</div>
<div class="line"><a name="l02891"></a><span class="lineno"> 2891</span>&#160;</div>
<div class="line"><a name="l02892"></a><span class="lineno"> 2892</span>&#160;</div>
<div class="line"><a name="l02893"></a><span class="lineno"> 2893</span>&#160;  <span class="keywordflow">if</span>( 0 &amp;&amp; debugfail &gt;= 1 &amp;&amp; (<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a294c90ee60024e6f3548814e7ff10a41">IFUTOPRIMFAILSOFT</a>(invert_from_point_flag)) ) {</div>
<div class="line"><a name="l02894"></a><span class="lineno"> 2894</span>&#160;    dualfprintf( <a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>, <span class="stringliteral">&quot;t = %g, nstep = %ld, steppart = %d, i = %d, j = %d, rho = %21.15g, u = %21.15g, fracneg = %21.15g\n&quot;</span>,</div>
<div class="line"><a name="l02895"></a><span class="lineno"> 2895</span>&#160;                 <a class="code" href="../../d8/d5b/defs_8general_8h.html#ae1ee1e1c83c3f70e2e1afed4f4f5b41e">t</a>, <a class="code" href="../../d8/d5b/defs_8general_8h.html#a0b92e4d6197989f0f9b0609c8615a46f">realnstep</a>, <a class="code" href="../../d8/d5b/defs_8general_8h.html#a70170b90229f9fc05eebf8508a685c70">steppart</a>, ptrgeom-&gt;i + <a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[1], ptrgeom-&gt;j + <a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[2],</div>
<div class="line"><a name="l02896"></a><span class="lineno"> 2896</span>&#160;                 pf[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>], pf[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>], (pf[RHO]&gt;0)?(-pf[UU]/(pf[RHO]+DBL_MIN)):(-pf[RHO]/(pf[UU]+DBL_MIN)) );</div>
<div class="line"><a name="l02897"></a><span class="lineno"> 2897</span>&#160;  }</div>
<div class="line"><a name="l02898"></a><span class="lineno"> 2898</span>&#160;</div>
<div class="line"><a name="l02899"></a><span class="lineno"> 2899</span>&#160;</div>
<div class="line"><a name="l02900"></a><span class="lineno"> 2900</span>&#160;  <span class="comment">//WHAT IF INTERNAL ENERGY BECOMES SLIGHTLY NEGATIVE?  WE STILL CAN DO THE LIMITING IN PRIM QUANTITIES! -- coorrected but check! -- SUPERSASMARK TODO atch</span></div>
<div class="line"><a name="l02901"></a><span class="lineno"> 2901</span>&#160;  <span class="keywordflow">if</span>( <a class="code" href="../../d8/d5b/defs_8general_8h.html#a0d5e1b767182dfc4e2a3f89a9173d1ef">LIMIT_AC_PRIM_FRAC_CHANGE</a> &amp;&amp;</div>
<div class="line"><a name="l02902"></a><span class="lineno"> 2902</span>&#160;      (</div>
<div class="line"><a name="l02903"></a><span class="lineno"> 2903</span>&#160;       <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afaacb1c256e44ec7be2adaac65713f2b">IFUTOPRIMNOFAILORFIXED</a>(invert_from_point_flag) || <span class="comment">//atch added the below to still do the pt. vs. avg. check on primitives if the internal energy goes neg.</span></div>
<div class="line"><a name="l02904"></a><span class="lineno"> 2904</span>&#160;       ( (<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ac530de9aaf5536f3b22423a77cc9c391">IFUTOPRIMFAILSOFTNOTRHORELATED</a>(invert_from_point_flag)) &amp;&amp; (0 != <a class="code" href="../../da/d3e/definit_8h.html#a01d34fa922c4eaac94e27f2179523626" title="whether to allow negative internal energy in substep UTOPRIMFAILRETURNTYPE==UTOPRIMRETURNADJUSTED sho...">STEPOVERNEGU</a>) ) || <span class="comment">//intermediate substep with stepping over u &lt; 0</span></div>
<div class="line"><a name="l02905"></a><span class="lineno"> 2905</span>&#160;       ( (<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab883f9e4302c57b5bf243cad6d318972">IFUTOPRIMFAILSOFTRHORELATED</a>(invert_from_point_flag)) &amp;&amp; (0 != <a class="code" href="../../da/d3e/definit_8h.html#a23eeede57657104811b4f7e5e7dda656" title="seems to make things worse (more failures, but also worse failures)">STEPOVERNEGRHO</a>) ) <span class="comment">//intermediate substep with stepping over rho &lt; 0</span></div>
<div class="line"><a name="l02906"></a><span class="lineno"> 2906</span>&#160;       )</div>
<div class="line"><a name="l02907"></a><span class="lineno"> 2907</span>&#160;      ) {</div>
<div class="line"><a name="l02908"></a><span class="lineno"> 2908</span>&#160;</div>
<div class="line"><a name="l02909"></a><span class="lineno"> 2909</span>&#160;</div>
<div class="line"><a name="l02910"></a><span class="lineno"> 2910</span>&#160;    <span class="comment">//make a copy of the initial guess so that not to modify the original pb&#39;s</span></div>
<div class="line"><a name="l02911"></a><span class="lineno"> 2911</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) pavg[pl] = pb[pl];</div>
<div class="line"><a name="l02912"></a><span class="lineno"> 2912</span>&#160;    <span class="comment">//invert the average U -&gt; &quot;average&quot; p</span></div>
<div class="line"><a name="l02913"></a><span class="lineno"> 2913</span>&#160;    <span class="keywordtype">int</span> dissmeasure=-1.0; <span class="comment">// assume ok to try energy</span></div>
<div class="line"><a name="l02914"></a><span class="lineno"> 2914</span>&#160;    <span class="keywordtype">int</span> whichcap=CAPTYPEBASIC;</div>
<div class="line"><a name="l02915"></a><span class="lineno"> 2915</span>&#160;    <span class="keywordtype">int</span> whichmethod=MODEPICKBEST; <span class="comment">// try to choose best option for this &quot;external&quot; inversion</span></div>
<div class="line"><a name="l02916"></a><span class="lineno"> 2916</span>&#160;    <span class="keywordtype">int</span> modprim=0;</div>
<div class="line"><a name="l02917"></a><span class="lineno"> 2917</span>&#160;    <span class="keywordtype">int</span> checkoninversiongas=CHECKONINVERSION;</div>
<div class="line"><a name="l02918"></a><span class="lineno"> 2918</span>&#160;    <span class="keywordtype">int</span> checkoninversionrad=CHECKONINVERSIONRAD;</div>
<div class="line"><a name="l02919"></a><span class="lineno"> 2919</span>&#160;    <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(Utoprimgen(showmessages,checkoninversiongas,checkoninversionrad,allowlocalfailurefixandnoreport, finalstep,&amp;eomtype,whichcap,whichmethod,modprim,EVOLVEUTOPRIM, UEVOLVE, uavg, NULL, ptrgeom, dissmeasure, pavg, pavg,newtonstats),&quot;<a class="code" href="../../d9/de0/step__ch_8c.html#afe241569412f22a86dea9cd91b516af8" title="take step itself">step_ch</a>.c:advance()&quot;, &quot;Utoprimgen&quot;, 3);</div>
<div class="line"><a name="l02920"></a><span class="lineno"> 2920</span>&#160;</div>
<div class="line"><a name="l02921"></a><span class="lineno"> 2921</span>&#160;    invert_from_average_flag = GLOBALMACP0A1(pflag,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>);</div>
<div class="line"><a name="l02922"></a><span class="lineno"> 2922</span>&#160;</div>
<div class="line"><a name="l02923"></a><span class="lineno"> 2923</span>&#160;    <span class="comment">//Inversion from the average value succeeded or has a negative density or internal energy</span></div>
<div class="line"><a name="l02924"></a><span class="lineno"> 2924</span>&#160;    if( <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afaacb1c256e44ec7be2adaac65713f2b">IFUTOPRIMNOFAILORFIXED</a>(invert_from_average_flag) || <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a294c90ee60024e6f3548814e7ff10a41">IFUTOPRIMFAILSOFT</a>(invert_from_average_flag) ) {</div>
<div class="line"><a name="l02925"></a><span class="lineno"> 2925</span>&#160;      <span class="comment">//Inversion from both from the point and the average values succeeded</span></div>
<div class="line"><a name="l02926"></a><span class="lineno"> 2926</span>&#160;      <span class="comment">//checks if the states&#39; gamma factors and densities are different by more than a certain fraction</span></div>
<div class="line"><a name="l02927"></a><span class="lineno"> 2927</span>&#160;      <span class="comment">//and if different, modify the point values such that they are not further than by MAX_AC_PRIM_FRAC_CHANGE</span></div>
<div class="line"><a name="l02928"></a><span class="lineno"> 2928</span>&#160;      <span class="comment">//from the average ones</span></div>
<div class="line"><a name="l02929"></a><span class="lineno"> 2929</span>&#160;      frac_avg_used = <a class="code" href="../../df/d22/advance_8c.html#a0936d88b132d9655aa9287035a4793c5" title="If density or gamma-factors are different by more than fractional_difference_threshold for states pin...">limit_prim_correction</a>(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a43991f234455e5f1169b75f14dede420">MAX_AC_PRIM_FRAC_CHANGE</a>, ptrgeom, pavg, pf);</div>
<div class="line"><a name="l02930"></a><span class="lineno"> 2930</span>&#160;</div>
<div class="line"><a name="l02931"></a><span class="lineno"> 2931</span>&#160;<span class="preprocessor">#if( DOENODEBUG )  //atch debug; note that use the location with pl =0 , interporflux = 0, &amp; dir = 1 since limiting the change in prim quantities is not a per-component operation</span></div>
<div class="line"><a name="l02932"></a><span class="lineno"> 2932</span>&#160;<span class="preprocessor"></span>      <span class="keywordflow">if</span>(  frac_avg_used &gt; 0.01 ) {</div>
<div class="line"><a name="l02933"></a><span class="lineno"> 2933</span>&#160;        <a class="code" href="../../df/d1c/global_8storage_8h.html#ada9f84fa2aec677eddee6160d314c94f">MACP0A4</a>(enodebugarray,ptrgeom-&gt;i,ptrgeom-&gt;j,ptrgeom-&gt;k,1-1,0,0,ENODEBUGPARAM_LIMCORR_PRIM)++;</div>
<div class="line"><a name="l02934"></a><span class="lineno"> 2934</span>&#160;      }</div>
<div class="line"><a name="l02935"></a><span class="lineno"> 2935</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02936"></a><span class="lineno"> 2936</span>&#160;<span class="preprocessor"></span>      </div>
<div class="line"><a name="l02937"></a><span class="lineno"> 2937</span>&#160;      <span class="keywordflow">if</span>( pf[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>] &lt; 0.0 &amp;&amp; timeorder == numtimeorders-1 ) {</div>
<div class="line"><a name="l02938"></a><span class="lineno"> 2938</span>&#160;        lpflag[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>] = <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a042dcc3162731841db25689b5f94c2ac">UTOPRIMFAILU2AVG2</a>;</div>
<div class="line"><a name="l02939"></a><span class="lineno"> 2939</span>&#160;      }</div>
<div class="line"><a name="l02940"></a><span class="lineno"> 2940</span>&#160;</div>
<div class="line"><a name="l02941"></a><span class="lineno"> 2941</span>&#160;      <span class="comment">//lpflag[FLAGUTOPRIMFAIL] = invert_from_point_flag;  //unneeded since it is alrady == UTOPRIMNOFAIL</span></div>
<div class="line"><a name="l02942"></a><span class="lineno"> 2942</span>&#160;</div>
<div class="line"><a name="l02943"></a><span class="lineno"> 2943</span>&#160;    } <span class="comment">// end if both point and average did NOT fail</span></div>
<div class="line"><a name="l02944"></a><span class="lineno"> 2944</span>&#160;    <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l02945"></a><span class="lineno"> 2945</span>&#160;      <span class="comment">//Inversion from the point values succeeded but that from the average failed:</span></div>
<div class="line"><a name="l02946"></a><span class="lineno"> 2946</span>&#160;      <span class="comment">//retain the point value</span></div>
<div class="line"><a name="l02947"></a><span class="lineno"> 2947</span>&#160;</div>
<div class="line"><a name="l02948"></a><span class="lineno"> 2948</span>&#160;      <span class="comment">//set the inversion error flag to correspond to the inversion from the average value</span></div>
<div class="line"><a name="l02949"></a><span class="lineno"> 2949</span>&#160;      lpflag[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a070864d9f91a98856ae6df725bbb044c" title="FAILURE FLAGS (always should be listed first starting from 0 and NUMFAILPFLAGS should be number of th...">FLAGUTOPRIMFAIL</a>] = invert_from_point_flag;</div>
<div class="line"><a name="l02950"></a><span class="lineno"> 2950</span>&#160;      frac_avg_used = 0.0;  <span class="comment">//used point value, i.e. zero fracion of the average value</span></div>
<div class="line"><a name="l02951"></a><span class="lineno"> 2951</span>&#160;    }</div>
<div class="line"><a name="l02952"></a><span class="lineno"> 2952</span>&#160;  }</div>
<div class="line"><a name="l02953"></a><span class="lineno"> 2953</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>( <a class="code" href="../../d8/d5b/defs_8general_8h.html#a618d1d6042e7d435e9439a0bbd7a9048">INVERTFROMAVERAGEIFFAILED</a> &amp;&amp; (<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0894a5e6c53e2e8a143d10be7a42d492">IFUTOPRIMFAIL</a>(invert_from_point_flag)) ) {  <span class="comment">//failure  //atch correct</span></div>
<div class="line"><a name="l02954"></a><span class="lineno"> 2954</span>&#160;    <span class="comment">//inversion from the point value failed</span></div>
<div class="line"><a name="l02955"></a><span class="lineno"> 2955</span>&#160;</div>
<div class="line"><a name="l02956"></a><span class="lineno"> 2956</span>&#160;    <span class="comment">// if last substep -&gt; revert to the average value, else if only negative densities then allow for substep.  If other type of failures, then never allow and revert to Uavg</span></div>
<div class="line"><a name="l02957"></a><span class="lineno"> 2957</span>&#160;</div>
<div class="line"><a name="l02958"></a><span class="lineno"> 2958</span>&#160;</div>
<div class="line"><a name="l02959"></a><span class="lineno"> 2959</span>&#160;    <span class="comment">// GODMARK:</span></div>
<div class="line"><a name="l02960"></a><span class="lineno"> 2960</span>&#160;    <span class="comment">// CHECK IF INVERSION FAILED.  IF FAILED, TRY TO USE uavg:</span></div>
<div class="line"><a name="l02961"></a><span class="lineno"> 2961</span>&#160;    <span class="comment">// invert U-&gt;p</span></div>
<div class="line"><a name="l02962"></a><span class="lineno"> 2962</span>&#160;</div>
<div class="line"><a name="l02963"></a><span class="lineno"> 2963</span>&#160;    <span class="comment">// GODMARK: decide whether best to revert to average or not</span></div>
<div class="line"><a name="l02964"></a><span class="lineno"> 2964</span>&#160;</div>
<div class="line"><a name="l02965"></a><span class="lineno"> 2965</span>&#160;    <span class="comment">//=1 if it is a non-convergence failure; =0 if it is an occurrence of a negative density</span></div>
<div class="line"><a name="l02966"></a><span class="lineno"> 2966</span>&#160;    is_convergence_failure = !<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a294c90ee60024e6f3548814e7ff10a41">IFUTOPRIMFAILSOFT</a>(invert_from_point_flag);</div>
<div class="line"><a name="l02967"></a><span class="lineno"> 2967</span>&#160;</div>
<div class="line"><a name="l02968"></a><span class="lineno"> 2968</span>&#160;    <span class="keywordflow">if</span>((timeorder==numtimeorders-1 <span class="comment">/*&amp;&amp; (1 == is_nonconvergence_failure || FIXUPZONES == FIXUPNOZONES)*/</span> ) ||   <span class="comment">// last substep, then DO invert from average IF no fixups or non-convergence failure (ADT) SASMARKx</span></div>
<div class="line"><a name="l02969"></a><span class="lineno"> 2969</span>&#160;</div>
<div class="line"><a name="l02970"></a><span class="lineno"> 2970</span>&#160;       ( 1 == is_convergence_failure ) || <span class="comment">//non-convergence (no solution in primitive quantities) error, so have to fix it up</span></div>
<div class="line"><a name="l02971"></a><span class="lineno"> 2971</span>&#160;</div>
<div class="line"><a name="l02972"></a><span class="lineno"> 2972</span>&#160;       ( (timeorder&lt;numtimeorders-1) &amp;&amp; (</div>
<div class="line"><a name="l02973"></a><span class="lineno"> 2973</span>&#160;                                         ((<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ac530de9aaf5536f3b22423a77cc9c391">IFUTOPRIMFAILSOFTNOTRHORELATED</a>(invert_from_point_flag)) &amp;&amp; (0 == <a class="code" href="../../da/d3e/definit_8h.html#a01d34fa922c4eaac94e27f2179523626" title="whether to allow negative internal energy in substep UTOPRIMFAILRETURNTYPE==UTOPRIMRETURNADJUSTED sho...">STEPOVERNEGU</a>))||</div>
<div class="line"><a name="l02974"></a><span class="lineno"> 2974</span>&#160;                                         ((invert_from_point_flag==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a24290f84c3e2b725f7cbbdff81da4760">UTOPRIMFAILRHOUNEG</a>) &amp;&amp; (0 == <a class="code" href="../../d8/dc0/init_8h.html#a352ef6d348d5c3986dc77165755b8733">STEPOVERNEGRHOU</a>)) ||</div>
<div class="line"><a name="l02975"></a><span class="lineno"> 2975</span>&#160;                                         ((<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab883f9e4302c57b5bf243cad6d318972">IFUTOPRIMFAILSOFTRHORELATED</a>(invert_from_point_flag)) &amp;&amp; (0 == <a class="code" href="../../da/d3e/definit_8h.html#a23eeede57657104811b4f7e5e7dda656" title="seems to make things worse (more failures, but also worse failures)">STEPOVERNEGRHO</a>))</div>
<div class="line"><a name="l02976"></a><span class="lineno"> 2976</span>&#160;                                         )</div>
<div class="line"><a name="l02977"></a><span class="lineno"> 2977</span>&#160;         )  <span class="comment">//intermediate substep with no stepping over u &lt; 0, rho&lt;0, or both &lt;0</span></div>
<div class="line"><a name="l02978"></a><span class="lineno"> 2978</span>&#160;       ) {</div>
<div class="line"><a name="l02979"></a><span class="lineno"> 2979</span>&#160;      <span class="keywordflow">if</span>(debugfail &gt;= 1) {</div>
<div class="line"><a name="l02980"></a><span class="lineno"> 2980</span>&#160;        dualfprintf( <a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>, <span class="stringliteral">&quot;Inversion from the point value failed.  Using the inversion from the average value.\n&quot;</span> );</div>
<div class="line"><a name="l02981"></a><span class="lineno"> 2981</span>&#160;      }</div>
<div class="line"><a name="l02982"></a><span class="lineno"> 2982</span>&#160;</div>
<div class="line"><a name="l02983"></a><span class="lineno"> 2983</span>&#160;      <span class="comment">//make a copy of the initial guess so that not to modify the original pb&#39;s</span></div>
<div class="line"><a name="l02984"></a><span class="lineno"> 2984</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) pf[pl] = pb[pl];</div>
<div class="line"><a name="l02985"></a><span class="lineno"> 2985</span>&#160;      <span class="comment">//invert the average U -&gt; &quot;average&quot; p</span></div>
<div class="line"><a name="l02986"></a><span class="lineno"> 2986</span>&#160;      <span class="keywordtype">int</span> dissmeasure=-1.0; <span class="comment">// assume ok to try energy</span></div>
<div class="line"><a name="l02987"></a><span class="lineno"> 2987</span>&#160;      <span class="keywordtype">int</span> whichcap=CAPTYPEBASIC;</div>
<div class="line"><a name="l02988"></a><span class="lineno"> 2988</span>&#160;      <span class="keywordtype">int</span> whichmethod=MODEPICKBEST; <span class="comment">// try to choose best option for this &quot;external&quot; inversion</span></div>
<div class="line"><a name="l02989"></a><span class="lineno"> 2989</span>&#160;      <span class="keywordtype">int</span> modprim=0;</div>
<div class="line"><a name="l02990"></a><span class="lineno"> 2990</span>&#160;      <span class="keywordtype">int</span> checkoninversiongas=CHECKONINVERSION;</div>
<div class="line"><a name="l02991"></a><span class="lineno"> 2991</span>&#160;      <span class="keywordtype">int</span> checkoninversionrad=CHECKONINVERSIONRAD;</div>
<div class="line"><a name="l02992"></a><span class="lineno"> 2992</span>&#160;      <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(Utoprimgen(showmessages,checkoninversiongas,checkoninversionrad,allowlocalfailurefixandnoreport, finalstep,&amp;eomtype,whichcap,whichmethod,modprim,EVOLVEUTOPRIM, UEVOLVE, uavg, NULL, ptrgeom, dissmeasure, pb, pf,newtonstats),&quot;<a class="code" href="../../d9/de0/step__ch_8c.html#afe241569412f22a86dea9cd91b516af8" title="take step itself">step_ch</a>.c:advance()&quot;, &quot;Utoprimgen&quot;, 3);</div>
<div class="line"><a name="l02993"></a><span class="lineno"> 2993</span>&#160;      <span class="comment">//      invert_from_average_flag = lpflag[FLAGUTOPRIMFAIL];</span></div>
<div class="line"><a name="l02994"></a><span class="lineno"> 2994</span>&#160;</div>
<div class="line"><a name="l02995"></a><span class="lineno"> 2995</span>&#160;</div>
<div class="line"><a name="l02996"></a><span class="lineno"> 2996</span>&#160;      <span class="comment">//Have the results from the inversion from the average value -- copy the result over</span></div>
<div class="line"><a name="l02997"></a><span class="lineno"> 2997</span>&#160;      <span class="comment">//      PLOOP(pliter,pl) pf[pl] = pavg[pl];</span></div>
<div class="line"><a name="l02998"></a><span class="lineno"> 2998</span>&#160;      <span class="comment">//      lpflag[FLAGUTOPRIMFAIL] = invert_from_average_flag;</span></div>
<div class="line"><a name="l02999"></a><span class="lineno"> 2999</span>&#160;</div>
<div class="line"><a name="l03000"></a><span class="lineno"> 3000</span>&#160;      <span class="comment">//old code:</span></div>
<div class="line"><a name="l03001"></a><span class="lineno"> 3001</span>&#160;      <span class="comment">//MYFUN(Utoprimgen(showmessages,checkoninversiongas,checkoninversionrad,allowlocalfailurefixandnoreport, finalstep,&amp;eomtype,EVOLVEUTOPRIM, UEVOLVE, avg, NULL, ptrgeom, dissmeasure, pb, pf,&amp;newtonstats),&quot;step_ch.c:advance()&quot;, &quot;Utoprimgen&quot;, 2);</span></div>
<div class="line"><a name="l03002"></a><span class="lineno"> 3002</span>&#160;</div>
<div class="line"><a name="l03003"></a><span class="lineno"> 3003</span>&#160;      frac_avg_used = 1.0; <span class="comment">//reverted to the average value</span></div>
<div class="line"><a name="l03004"></a><span class="lineno"> 3004</span>&#160;</div>
<div class="line"><a name="l03005"></a><span class="lineno"> 3005</span>&#160;    }</div>
<div class="line"><a name="l03006"></a><span class="lineno"> 3006</span>&#160;    else {</div>
<div class="line"><a name="l03007"></a><span class="lineno"> 3007</span>&#160;      frac_avg_used = 0.0; <span class="comment">//used the point value</span></div>
<div class="line"><a name="l03008"></a><span class="lineno"> 3008</span>&#160;    }</div>
<div class="line"><a name="l03009"></a><span class="lineno"> 3009</span>&#160;  }</div>
<div class="line"><a name="l03010"></a><span class="lineno"> 3010</span>&#160;</div>
<div class="line"><a name="l03011"></a><span class="lineno"> 3011</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l03012"></a><span class="lineno"> 3012</span>&#160;}</div>
<div class="line"><a name="l03013"></a><span class="lineno"> 3013</span>&#160;</div>
<div class="line"><a name="l03014"></a><span class="lineno"> 3014</span>&#160;</div>
<div class="line"><a name="l03015"></a><span class="lineno"> 3015</span>&#160;</div>
<div class="line"><a name="l03016"></a><span class="lineno"> 3016</span>&#160;</div>
<div class="line"><a name="l03017"></a><span class="lineno"> 3017</span>&#160;</div>
<div class="line"><a name="l03018"></a><span class="lineno"><a class="code" href="../../df/d22/advance_8c.html#a58e70abbec4cf7ac016d4ce9c51d7e1a"> 3018</a></span>&#160;<span class="preprocessor">#define COMPARE_GAMMA 0</span></div>
<div class="line"><a name="l03019"></a><span class="lineno"> 3019</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l03023"></a><span class="lineno"><a class="code" href="../../df/d22/advance_8c.html#a0936d88b132d9655aa9287035a4793c5"> 3023</a></span>&#160;<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> <a class="code" href="../../df/d22/advance_8c.html#a0936d88b132d9655aa9287035a4793c5" title="If density or gamma-factors are different by more than fractional_difference_threshold for states pin...">limit_prim_correction</a>( <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fractional_difference_threshold, <span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *geom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pin, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pout )</div>
<div class="line"><a name="l03024"></a><span class="lineno"> 3024</span>&#160;{</div>
<div class="line"><a name="l03025"></a><span class="lineno"> 3025</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> gammain = 0.0, gammaout = 0.0;</div>
<div class="line"><a name="l03026"></a><span class="lineno"> 3026</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> frac_start, frac_end, frac_diff;</div>
<div class="line"><a name="l03027"></a><span class="lineno"> 3027</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> fraction_input_value;</div>
<div class="line"><a name="l03028"></a><span class="lineno"> 3028</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> comovingenergyin, comovingenergyout;</div>
<div class="line"><a name="l03029"></a><span class="lineno"> 3029</span>&#160;  <span class="keywordtype">int</span> pl,pliter;</div>
<div class="line"><a name="l03030"></a><span class="lineno"> 3030</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> bsqin,bsqout;</div>
<div class="line"><a name="l03031"></a><span class="lineno"> 3031</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> qin, qout;</div>
<div class="line"><a name="l03032"></a><span class="lineno"> 3032</span>&#160;  <span class="keywordtype">int</span> jj;</div>
<div class="line"><a name="l03033"></a><span class="lineno"> 3033</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> bdotuin, bdotuout;</div>
<div class="line"><a name="l03034"></a><span class="lineno"> 3034</span>&#160;</div>
<div class="line"><a name="l03035"></a><span class="lineno"> 3035</span>&#160;</div>
<div class="line"><a name="l03036"></a><span class="lineno"> 3036</span>&#160;<span class="preprocessor">#if( COMPARE_GAMMA ) </span></div>
<div class="line"><a name="l03037"></a><span class="lineno"> 3037</span>&#160;<span class="preprocessor"></span>  gamma_calc( pin, geom, &amp;gammain );</div>
<div class="line"><a name="l03038"></a><span class="lineno"> 3038</span>&#160;  gamma_calc( pout, geom, &amp;gammaout );</div>
<div class="line"><a name="l03039"></a><span class="lineno"> 3039</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03040"></a><span class="lineno"> 3040</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l03041"></a><span class="lineno"> 3041</span>&#160;  <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a11e17cd8b0594d1ad52e3594aa9f477e" title="find ucon, ucov, bcon, bcov from primitive variables when calling get_state, users of this function e...">get_state</a>(pin, geom, &amp;qin);</div>
<div class="line"><a name="l03042"></a><span class="lineno"> 3042</span>&#160;  <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a11e17cd8b0594d1ad52e3594aa9f477e" title="find ucon, ucov, bcon, bcov from primitive variables when calling get_state, users of this function e...">get_state</a>(pout, geom, &amp;qout);</div>
<div class="line"><a name="l03043"></a><span class="lineno"> 3043</span>&#160;</div>
<div class="line"><a name="l03044"></a><span class="lineno"> 3044</span>&#160;  bsqout = <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a7aac0a38641f2d6b53549677fa052a79">dot</a>(qout.<a class="code" href="../../d1/d83/structof__state.html#a9a5aa459c68ba51073dd9a245c1a7798">bcon</a>, qout.<a class="code" href="../../d1/d83/structof__state.html#a60ad0baeb54ce3584309ba5567a72f41">bcov</a>);</div>
<div class="line"><a name="l03045"></a><span class="lineno"> 3045</span>&#160;  bsqin = <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a7aac0a38641f2d6b53549677fa052a79">dot</a>(qin.<a class="code" href="../../d1/d83/structof__state.html#a9a5aa459c68ba51073dd9a245c1a7798">bcon</a>, qin.<a class="code" href="../../d1/d83/structof__state.html#a60ad0baeb54ce3584309ba5567a72f41">bcov</a>);</div>
<div class="line"><a name="l03046"></a><span class="lineno"> 3046</span>&#160;</div>
<div class="line"><a name="l03047"></a><span class="lineno"> 3047</span>&#160;  bdotuin = 0.0;   <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) bdotuin+=(qin.<a class="code" href="../../d1/d83/structof__state.html#a09881c3d05809ef27f8115d02a835e11">ucov</a>[jj])*(qin.<a class="code" href="../../d1/d83/structof__state.html#a9a5aa459c68ba51073dd9a245c1a7798">bcon</a>[jj]);</div>
<div class="line"><a name="l03048"></a><span class="lineno"> 3048</span>&#160;  bdotuout = 0.0;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) bdotuout+=(qout.<a class="code" href="../../d1/d83/structof__state.html#a09881c3d05809ef27f8115d02a835e11">ucov</a>[jj])*(qout.<a class="code" href="../../d1/d83/structof__state.html#a9a5aa459c68ba51073dd9a245c1a7798">bcon</a>[jj]);</div>
<div class="line"><a name="l03049"></a><span class="lineno"> 3049</span>&#160;</div>
<div class="line"><a name="l03050"></a><span class="lineno"> 3050</span>&#160;  <span class="comment">// u.T.u comoving energy density</span></div>
<div class="line"><a name="l03051"></a><span class="lineno"> 3051</span>&#160;  comovingenergyin = pin[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>] + pin[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>] + bsqin*0.5 - bdotuin*bdotuin;</div>
<div class="line"><a name="l03052"></a><span class="lineno"> 3052</span>&#160;  comovingenergyout = pout[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>] + pout[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>] + bsqout*0.5 - bdotuout*bdotuout;</div>
<div class="line"><a name="l03053"></a><span class="lineno"> 3053</span>&#160;</div>
<div class="line"><a name="l03054"></a><span class="lineno"> 3054</span>&#160;</div>
<div class="line"><a name="l03055"></a><span class="lineno"> 3055</span>&#160; </div>
<div class="line"><a name="l03056"></a><span class="lineno"> 3056</span>&#160;<span class="preprocessor">#if( COMPARE_GAMMA ) </span></div>
<div class="line"><a name="l03057"></a><span class="lineno"> 3057</span>&#160;<span class="preprocessor"></span>  frac_diff = <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>( <a class="code" href="../../df/d22/advance_8c.html#a080ef26ac144e3416a4c5a0ccc1f1e9b" title="Returns the fractional difference between a &amp; b.">fractional_diff</a>(gammain, gammaout), </div>
<div class="line"><a name="l03058"></a><span class="lineno"> 3058</span>&#160;                   <a class="code" href="../../df/d22/advance_8c.html#a080ef26ac144e3416a4c5a0ccc1f1e9b" title="Returns the fractional difference between a &amp; b.">fractional_diff</a>( comovingenergyin, comovingenergyout ) );</div>
<div class="line"><a name="l03059"></a><span class="lineno"> 3059</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l03060"></a><span class="lineno"> 3060</span>&#160;<span class="preprocessor"></span>  frac_diff = <a class="code" href="../../df/d22/advance_8c.html#a080ef26ac144e3416a4c5a0ccc1f1e9b" title="Returns the fractional difference between a &amp; b.">fractional_diff</a>( comovingenergyin, comovingenergyout );</div>
<div class="line"><a name="l03061"></a><span class="lineno"> 3061</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03062"></a><span class="lineno"> 3062</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l03063"></a><span class="lineno"> 3063</span>&#160;  <span class="comment">//fractional difference at which the reduction to the input value starts</span></div>
<div class="line"><a name="l03064"></a><span class="lineno"> 3064</span>&#160;  frac_start = 0.5 * fractional_difference_threshold;</div>
<div class="line"><a name="l03065"></a><span class="lineno"> 3065</span>&#160;</div>
<div class="line"><a name="l03066"></a><span class="lineno"> 3066</span>&#160;  <span class="comment">//fractional difference after which only the input value is used</span></div>
<div class="line"><a name="l03067"></a><span class="lineno"> 3067</span>&#160;  frac_end = fractional_difference_threshold;</div>
<div class="line"><a name="l03068"></a><span class="lineno"> 3068</span>&#160;</div>
<div class="line"><a name="l03069"></a><span class="lineno"> 3069</span>&#160;  <span class="comment">//the fraction of the input value used in the output; increases linearly from 0 to 1 for fractions going from frac_start to frac_end</span></div>
<div class="line"><a name="l03070"></a><span class="lineno"> 3070</span>&#160;  fraction_input_value = <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>( 0., <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(1., (frac_diff - frac_start)/(frac_end - frac_start) ) );</div>
<div class="line"><a name="l03071"></a><span class="lineno"> 3071</span>&#160;</div>
<div class="line"><a name="l03072"></a><span class="lineno"> 3072</span>&#160;  <span class="keywordflow">if</span>( 0.0 != fraction_input_value ){</div>
<div class="line"><a name="l03073"></a><span class="lineno"> 3073</span>&#160;    <span class="comment">//states are too different: reverted to primitives that correspond to average conserved quantities because trust them more than point values</span></div>
<div class="line"><a name="l03074"></a><span class="lineno"> 3074</span>&#160;    dualfprintf( <a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>, <span class="stringliteral">&quot;States are too different, using %3d%% of the average values: i = %d, j = %d, k = %d, nstep = %ld, steppart = %d, t = %21.15g\n&quot;</span>, </div>
<div class="line"><a name="l03075"></a><span class="lineno"> 3075</span>&#160;                 (<span class="keywordtype">int</span>)(100. * fraction_input_value), geom-&gt;i, geom-&gt;j, geom-&gt;k, <a class="code" href="../../d8/d5b/defs_8general_8h.html#a1a1088d87617078680f1fd0f0d707384">nstep</a>, <a class="code" href="../../d8/d5b/defs_8general_8h.html#a70170b90229f9fc05eebf8508a685c70">steppart</a>, <a class="code" href="../../d8/d5b/defs_8general_8h.html#ae1ee1e1c83c3f70e2e1afed4f4f5b41e">t</a> );</div>
<div class="line"><a name="l03076"></a><span class="lineno"> 3076</span>&#160;    <span class="keywordflow">if</span>( debugfail &gt;= 2 ){</div>
<div class="line"><a name="l03077"></a><span class="lineno"> 3077</span>&#160;      dualfprintf( <a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>, <span class="stringliteral">&quot;Prim. pt. value (gamma, rho, u): &quot;</span> );</div>
<div class="line"><a name="l03078"></a><span class="lineno"> 3078</span>&#160;      dualfprintf( <a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>, <span class="stringliteral">&quot;%21.15g %21.15g %21.15g\n&quot;</span>,  gammaout, pout[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>], pout[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>] );</div>
<div class="line"><a name="l03079"></a><span class="lineno"> 3079</span>&#160;      dualfprintf( <a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>, <span class="stringliteral">&quot;Prim. avg value (gamma, rho, u): &quot;</span> );</div>
<div class="line"><a name="l03080"></a><span class="lineno"> 3080</span>&#160;      dualfprintf( <a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>, <span class="stringliteral">&quot;%21.15g %21.15g %21.15g\n&quot;</span>, gammain, pin[RHO], pin[UU] );</div>
<div class="line"><a name="l03081"></a><span class="lineno"> 3081</span>&#160;      dualfprintf( <a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>, <span class="stringliteral">&quot;Frac. difference(ganna, rho, u): &quot;</span> );</div>
<div class="line"><a name="l03082"></a><span class="lineno"> 3082</span>&#160;      dualfprintf( <a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>, <span class="stringliteral">&quot;%21.15g %21.15g %21.15g\n&quot;</span>, </div>
<div class="line"><a name="l03083"></a><span class="lineno"> 3083</span>&#160;                   <a class="code" href="../../df/d22/advance_8c.html#a080ef26ac144e3416a4c5a0ccc1f1e9b" title="Returns the fractional difference between a &amp; b.">fractional_diff</a>(gammain, gammaout),</div>
<div class="line"><a name="l03084"></a><span class="lineno"> 3084</span>&#160;                   <a class="code" href="../../df/d22/advance_8c.html#a080ef26ac144e3416a4c5a0ccc1f1e9b" title="Returns the fractional difference between a &amp; b.">fractional_diff</a>(pin[RHO], pout[RHO]),  </div>
<div class="line"><a name="l03085"></a><span class="lineno"> 3085</span>&#160;                   <a class="code" href="../../df/d22/advance_8c.html#a080ef26ac144e3416a4c5a0ccc1f1e9b" title="Returns the fractional difference between a &amp; b.">fractional_diff</a>(pin[UU], pout[UU])</div>
<div class="line"><a name="l03086"></a><span class="lineno"> 3086</span>&#160;                   );</div>
<div class="line"><a name="l03087"></a><span class="lineno"> 3087</span>&#160;    }</div>
<div class="line"><a name="l03088"></a><span class="lineno"> 3088</span>&#160;  }</div>
<div class="line"><a name="l03089"></a><span class="lineno"> 3089</span>&#160;</div>
<div class="line"><a name="l03090"></a><span class="lineno"> 3090</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) {</div>
<div class="line"><a name="l03091"></a><span class="lineno"> 3091</span>&#160;    pout[pl] = fraction_input_value * pin[pl] + (1. - fraction_input_value) * pout[pl];</div>
<div class="line"><a name="l03092"></a><span class="lineno"> 3092</span>&#160;  }</div>
<div class="line"><a name="l03093"></a><span class="lineno"> 3093</span>&#160;</div>
<div class="line"><a name="l03094"></a><span class="lineno"> 3094</span>&#160;  <span class="keywordflow">return</span>( fraction_input_value );</div>
<div class="line"><a name="l03095"></a><span class="lineno"> 3095</span>&#160;}</div>
<div class="line"><a name="l03096"></a><span class="lineno"> 3096</span>&#160;</div>
<div class="line"><a name="l03097"></a><span class="lineno"> 3097</span>&#160;</div>
<div class="line"><a name="l03098"></a><span class="lineno"> 3098</span>&#160;</div>
<div class="line"><a name="l03100"></a><span class="lineno"><a class="code" href="../../df/d22/advance_8c.html#a080ef26ac144e3416a4c5a0ccc1f1e9b"> 3100</a></span>&#160;<span class="keyword">static</span> <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> <a class="code" href="../../df/d22/advance_8c.html#a080ef26ac144e3416a4c5a0ccc1f1e9b" title="Returns the fractional difference between a &amp; b.">fractional_diff</a>( <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> <a class="code" href="../../d8/d5b/defs_8general_8h.html#aa73cf2d397cae726436e08d2c891bdb0">a</a>, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> b )</div>
<div class="line"><a name="l03101"></a><span class="lineno"> 3101</span>&#160;{</div>
<div class="line"><a name="l03102"></a><span class="lineno"> 3102</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> frac_diff;</div>
<div class="line"><a name="l03103"></a><span class="lineno"> 3103</span>&#160;</div>
<div class="line"><a name="l03104"></a><span class="lineno"> 3104</span>&#160;  frac_diff = 2. * fabs( a - b ) / ( fabs(a) + fabs(b) + DBL_MIN );</div>
<div class="line"><a name="l03105"></a><span class="lineno"> 3105</span>&#160;</div>
<div class="line"><a name="l03106"></a><span class="lineno"> 3106</span>&#160;  <span class="keywordflow">return</span>( frac_diff );</div>
<div class="line"><a name="l03107"></a><span class="lineno"> 3107</span>&#160;</div>
<div class="line"><a name="l03108"></a><span class="lineno"> 3108</span>&#160;}</div>
<div class="line"><a name="l03109"></a><span class="lineno"> 3109</span>&#160;</div>
<div class="line"><a name="l03110"></a><span class="lineno"> 3110</span>&#160;</div>
<div class="line"><a name="l03111"></a><span class="lineno"> 3111</span>&#160;</div>
<div class="line"><a name="l03112"></a><span class="lineno"> 3112</span>&#160;</div>
<div class="line"><a name="l03113"></a><span class="lineno"> 3113</span>&#160;</div>
<div class="line"><a name="l03114"></a><span class="lineno"> 3114</span>&#160;</div>
<div class="line"><a name="l03115"></a><span class="lineno"> 3115</span>&#160;</div>
<div class="line"><a name="l03116"></a><span class="lineno"> 3116</span>&#160;</div>
<div class="line"><a name="l03117"></a><span class="lineno"> 3117</span>&#160;</div>
<div class="line"><a name="l03118"></a><span class="lineno"> 3118</span>&#160;</div>
<div class="line"><a name="l03119"></a><span class="lineno"> 3119</span>&#160;</div>
<div class="line"><a name="l03120"></a><span class="lineno"> 3120</span>&#160;</div>
<div class="line"><a name="l03121"></a><span class="lineno"> 3121</span>&#160;</div>
<div class="line"><a name="l03122"></a><span class="lineno"> 3122</span>&#160;</div>
<div class="line"><a name="l03123"></a><span class="lineno"> 3123</span>&#160;</div>
<div class="line"><a name="l03124"></a><span class="lineno"> 3124</span>&#160;</div>
<div class="line"><a name="l03125"></a><span class="lineno"> 3125</span>&#160;</div>
<div class="line"><a name="l03126"></a><span class="lineno"> 3126</span>&#160;</div>
<div class="line"><a name="l03127"></a><span class="lineno"> 3127</span>&#160;</div>
<div class="line"><a name="l03128"></a><span class="lineno"> 3128</span>&#160;</div>
<div class="line"><a name="l03129"></a><span class="lineno"> 3129</span>&#160;</div>
<div class="line"><a name="l03130"></a><span class="lineno"> 3130</span>&#160;</div>
<div class="line"><a name="l03131"></a><span class="lineno"> 3131</span>&#160;</div>
<div class="line"><a name="l03132"></a><span class="lineno"> 3132</span>&#160;</div>
<div class="line"><a name="l03133"></a><span class="lineno"> 3133</span>&#160;</div>
<div class="line"><a name="l03135"></a><span class="lineno"> 3135</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> flux2dUavg(<span class="keywordtype">int</span> whichpl, <span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*F1)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*F2)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*F3)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *dU1avg,<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *dU2avg,<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *dU3avg)</div>
<div class="line"><a name="l03136"></a><span class="lineno"> 3136</span>&#160;{</div>
<div class="line"><a name="l03137"></a><span class="lineno"> 3137</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> idx1,idx2,idx3;</div>
<div class="line"><a name="l03138"></a><span class="lineno"> 3138</span>&#160;  <span class="keywordtype">int</span> pl,pliter;</div>
<div class="line"><a name="l03139"></a><span class="lineno"> 3139</span>&#160;</div>
<div class="line"><a name="l03140"></a><span class="lineno"> 3140</span>&#160;<span class="preprocessor">#if(VOLUMEDIFF==0)</span></div>
<div class="line"><a name="l03141"></a><span class="lineno"> 3141</span>&#160;<span class="preprocessor"></span>  idx1=1.0/<a class="code" href="../../d8/d5b/defs_8general_8h.html#a99b91d8e229e5df70958f2aed7fd15bf">dx</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a63979cf6054f403eab1d354e6dcc4ce9">RR</a>];</div>
<div class="line"><a name="l03142"></a><span class="lineno"> 3142</span>&#160;  idx2=1.0/<a class="code" href="../../d8/d5b/defs_8general_8h.html#a99b91d8e229e5df70958f2aed7fd15bf">dx</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8ccbf4850176503992b0295081d5f4bc">TH</a>];</div>
<div class="line"><a name="l03143"></a><span class="lineno"> 3143</span>&#160;  idx3=1.0/<a class="code" href="../../d8/d5b/defs_8general_8h.html#a99b91d8e229e5df70958f2aed7fd15bf">dx</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae0fcc909f5a4166b625a6707cbdfa643">PH</a>];</div>
<div class="line"><a name="l03144"></a><span class="lineno"> 3144</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l03145"></a><span class="lineno"> 3145</span>&#160;<span class="preprocessor"></span>  idx1=<a class="code" href="../../df/d1c/global_8storage_8h.html#a5880d8dad454b7235d907ffe4e50f5d4">GLOBALMETMACP0A1</a>(idxvol,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a63979cf6054f403eab1d354e6dcc4ce9">RR</a>);</div>
<div class="line"><a name="l03146"></a><span class="lineno"> 3146</span>&#160;  idx2=<a class="code" href="../../df/d1c/global_8storage_8h.html#a5880d8dad454b7235d907ffe4e50f5d4">GLOBALMETMACP0A1</a>(idxvol,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8ccbf4850176503992b0295081d5f4bc">TH</a>);</div>
<div class="line"><a name="l03147"></a><span class="lineno"> 3147</span>&#160;  idx3=<a class="code" href="../../df/d1c/global_8storage_8h.html#a5880d8dad454b7235d907ffe4e50f5d4">GLOBALMETMACP0A1</a>(idxvol,i,j,k,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae0fcc909f5a4166b625a6707cbdfa643">PH</a>);</div>
<div class="line"><a name="l03148"></a><span class="lineno"> 3148</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03149"></a><span class="lineno"> 3149</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l03150"></a><span class="lineno"> 3150</span>&#160;  <span class="keywordtype">int</span> special;</div>
<div class="line"><a name="l03151"></a><span class="lineno"> 3151</span>&#160;  <span class="keywordflow">if</span>(whichpl==<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#aae0730ddcfcd4a1591362411a0cde82b">DOSPECIALPL</a>){</div>
<div class="line"><a name="l03152"></a><span class="lineno"> 3152</span>&#160;    special=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>;</div>
<div class="line"><a name="l03153"></a><span class="lineno"> 3153</span>&#160;    whichpl=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac578a63f887dbc4797b555bd9c468a5f">DOALLPL</a>; <span class="comment">// override</span></div>
<div class="line"><a name="l03154"></a><span class="lineno"> 3154</span>&#160;  }</div>
<div class="line"><a name="l03155"></a><span class="lineno"> 3155</span>&#160;  <span class="keywordflow">else</span> special=0;</div>
<div class="line"><a name="l03156"></a><span class="lineno"> 3156</span>&#160;</div>
<div class="line"><a name="l03157"></a><span class="lineno"> 3157</span>&#160;  <span class="comment">// initialize for simplicity so don&#39;t have to do it conditionally on N&gt;1</span></div>
<div class="line"><a name="l03158"></a><span class="lineno"> 3158</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af5cae09eb90a697085d48b1779209f0e">PALLLOOPSPECIAL</a>(pl,special){</div>
<div class="line"><a name="l03159"></a><span class="lineno"> 3159</span>&#160;    dU1avg[pl]=0;</div>
<div class="line"><a name="l03160"></a><span class="lineno"> 3160</span>&#160;    dU2avg[pl]=0;</div>
<div class="line"><a name="l03161"></a><span class="lineno"> 3161</span>&#160;    dU3avg[pl]=0;</div>
<div class="line"><a name="l03162"></a><span class="lineno"> 3162</span>&#160;  }</div>
<div class="line"><a name="l03163"></a><span class="lineno"> 3163</span>&#160;</div>
<div class="line"><a name="l03164"></a><span class="lineno"> 3164</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a11c4e99e1493d0c1914ad1ab313ea472">FLUXB</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6cf8dd4f55e698316ccf74b8e57e317a">FLUXCD</a>){ <span class="comment">// don&#39;t use volume reg. since differencing is large</span></div>
<div class="line"><a name="l03165"></a><span class="lineno"> 3165</span>&#160;    </div>
<div class="line"><a name="l03166"></a><span class="lineno"> 3166</span>&#160;    <span class="keywordflow">if</span>(whichpl==<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac578a63f887dbc4797b555bd9c468a5f">DOALLPL</a> || whichpl==<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a2932863193c6165af8a2a33ce597c27c">DONONBPL</a>){</div>
<div class="line"><a name="l03167"></a><span class="lineno"> 3167</span>&#160;</div>
<div class="line"><a name="l03168"></a><span class="lineno"> 3168</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a26c7def0d92cbac4d6a7e03a68c3825a">PLOOPNOB1</a>(pl){</div>
<div class="line"><a name="l03169"></a><span class="lineno"> 3169</span>&#160;<span class="preprocessor">#if(N1&gt;1)</span></div>
<div class="line"><a name="l03170"></a><span class="lineno"> 3170</span>&#160;<span class="preprocessor"></span>        dU1avg[pl]=(</div>
<div class="line"><a name="l03171"></a><span class="lineno"> 3171</span>&#160;                    - (<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F1,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a27e1e0a92af691ffd03d7e9d0a628392">ip1mac</a>(i),j,k,pl) - <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F1,i,j,k,pl)) *idx1</div>
<div class="line"><a name="l03172"></a><span class="lineno"> 3172</span>&#160;                    );</div>
<div class="line"><a name="l03173"></a><span class="lineno"> 3173</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03174"></a><span class="lineno"> 3174</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#if(N2&gt;1)</span></div>
<div class="line"><a name="l03175"></a><span class="lineno"> 3175</span>&#160;<span class="preprocessor"></span>        dU2avg[pl]=(</div>
<div class="line"><a name="l03176"></a><span class="lineno"> 3176</span>&#160;                    - (<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F2,i,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a3e64aa2cd3c5e0933e74fa4e7a925570">jp1mac</a>(j),k,pl) - <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F2,i,j,k,pl)) *idx2</div>
<div class="line"><a name="l03177"></a><span class="lineno"> 3177</span>&#160;                    );</div>
<div class="line"><a name="l03178"></a><span class="lineno"> 3178</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03179"></a><span class="lineno"> 3179</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l03180"></a><span class="lineno"> 3180</span>&#160;<span class="preprocessor">#if(N3&gt;1)</span></div>
<div class="line"><a name="l03181"></a><span class="lineno"> 3181</span>&#160;<span class="preprocessor"></span>        dU3avg[pl]=(</div>
<div class="line"><a name="l03182"></a><span class="lineno"> 3182</span>&#160;                    - (<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F3,i,j,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#aafe7c78a2d0713ddc9a4f1c61764e3b9">kp1mac</a>(k),pl) - <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F3,i,j,k,pl)) *idx3</div>
<div class="line"><a name="l03183"></a><span class="lineno"> 3183</span>&#160;                    );</div>
<div class="line"><a name="l03184"></a><span class="lineno"> 3184</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03185"></a><span class="lineno"> 3185</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l03186"></a><span class="lineno"> 3186</span>&#160;      }</div>
<div class="line"><a name="l03187"></a><span class="lineno"> 3187</span>&#160;    </div>
<div class="line"><a name="l03188"></a><span class="lineno"> 3188</span>&#160;      <span class="comment">// rest of variables (if any) are normal</span></div>
<div class="line"><a name="l03189"></a><span class="lineno"> 3189</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a0d088ead05b528883cab696231b1d673">PLOOPNOB2SPECIAL</a>(pl,special){</div>
<div class="line"><a name="l03190"></a><span class="lineno"> 3190</span>&#160;<span class="preprocessor">#if(N1&gt;1)</span></div>
<div class="line"><a name="l03191"></a><span class="lineno"> 3191</span>&#160;<span class="preprocessor"></span>        dU1avg[pl]=(</div>
<div class="line"><a name="l03192"></a><span class="lineno"> 3192</span>&#160;                    - (<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F1,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a27e1e0a92af691ffd03d7e9d0a628392">ip1mac</a>(i),j,k,pl) - <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F1,i,j,k,pl)) *idx1</div>
<div class="line"><a name="l03193"></a><span class="lineno"> 3193</span>&#160;                    );</div>
<div class="line"><a name="l03194"></a><span class="lineno"> 3194</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03195"></a><span class="lineno"> 3195</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#if(N2&gt;1)</span></div>
<div class="line"><a name="l03196"></a><span class="lineno"> 3196</span>&#160;<span class="preprocessor"></span>        dU2avg[pl]=(</div>
<div class="line"><a name="l03197"></a><span class="lineno"> 3197</span>&#160;                    - (<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F2,i,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a3e64aa2cd3c5e0933e74fa4e7a925570">jp1mac</a>(j),k,pl) - <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F2,i,j,k,pl)) *idx2</div>
<div class="line"><a name="l03198"></a><span class="lineno"> 3198</span>&#160;                    );</div>
<div class="line"><a name="l03199"></a><span class="lineno"> 3199</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03200"></a><span class="lineno"> 3200</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#if(N3&gt;1)</span></div>
<div class="line"><a name="l03201"></a><span class="lineno"> 3201</span>&#160;<span class="preprocessor"></span>        dU3avg[pl]=(</div>
<div class="line"><a name="l03202"></a><span class="lineno"> 3202</span>&#160;                    - (<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F3,i,j,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#aafe7c78a2d0713ddc9a4f1c61764e3b9">kp1mac</a>(k),pl) - <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F3,i,j,k,pl)) *idx3</div>
<div class="line"><a name="l03203"></a><span class="lineno"> 3203</span>&#160;                    );</div>
<div class="line"><a name="l03204"></a><span class="lineno"> 3204</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03205"></a><span class="lineno"> 3205</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l03206"></a><span class="lineno"> 3206</span>&#160;      }</div>
<div class="line"><a name="l03207"></a><span class="lineno"> 3207</span>&#160;    }<span class="comment">// end if doing non-B U</span></div>
<div class="line"><a name="l03208"></a><span class="lineno"> 3208</span>&#160;</div>
<div class="line"><a name="l03209"></a><span class="lineno"> 3209</span>&#160;    <span class="keywordflow">if</span>(whichpl==<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac578a63f887dbc4797b555bd9c468a5f">DOALLPL</a> || whichpl==<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38be7776d45c50ab681a1d9fd7b34bb2">DOBPL</a>){</div>
<div class="line"><a name="l03210"></a><span class="lineno"> 3210</span>&#160;</div>
<div class="line"><a name="l03211"></a><span class="lineno"> 3211</span>&#160;      <span class="comment">// simple version that assumes Fi[Bi] is set to 0 in flux.c for FLUXCD (which it is currently)</span></div>
<div class="line"><a name="l03212"></a><span class="lineno"> 3212</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a9afde1f1647e18e733406a1566b8b550">PLOOPBONLY</a>(pl){</div>
<div class="line"><a name="l03213"></a><span class="lineno"> 3213</span>&#160;<span class="preprocessor">#if(N1&gt;1)</span></div>
<div class="line"><a name="l03214"></a><span class="lineno"> 3214</span>&#160;<span class="preprocessor"></span>        dU1avg[pl]=(</div>
<div class="line"><a name="l03215"></a><span class="lineno"> 3215</span>&#160;                    - (<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F1,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a27e1e0a92af691ffd03d7e9d0a628392">ip1mac</a>(i),j,k,pl) - <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F1,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a08f559f6e35177f2990475ed54b676e6" title="setup for various boundary situations so doesn&#39;t produce differences in irrelevant directions...">im1mac</a>(i),j,k,pl)) *idx1</div>
<div class="line"><a name="l03216"></a><span class="lineno"> 3216</span>&#160;                    );</div>
<div class="line"><a name="l03217"></a><span class="lineno"> 3217</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03218"></a><span class="lineno"> 3218</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#if(N2&gt;1)</span></div>
<div class="line"><a name="l03219"></a><span class="lineno"> 3219</span>&#160;<span class="preprocessor"></span>        dU2avg[pl]=(</div>
<div class="line"><a name="l03220"></a><span class="lineno"> 3220</span>&#160;                    - (<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F2,i,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a3e64aa2cd3c5e0933e74fa4e7a925570">jp1mac</a>(j),k,pl) - <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F2,i,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a815ff9872dbd287ceb444b229ed48ded">jm1mac</a>(j),k,pl)) *idx2</div>
<div class="line"><a name="l03221"></a><span class="lineno"> 3221</span>&#160;                    );</div>
<div class="line"><a name="l03222"></a><span class="lineno"> 3222</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03223"></a><span class="lineno"> 3223</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#if(N3&gt;1)</span></div>
<div class="line"><a name="l03224"></a><span class="lineno"> 3224</span>&#160;<span class="preprocessor"></span>        dU3avg[pl]=(</div>
<div class="line"><a name="l03225"></a><span class="lineno"> 3225</span>&#160;                    - (<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F3,i,j,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#aafe7c78a2d0713ddc9a4f1c61764e3b9">kp1mac</a>(k),pl) - <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F3,i,j,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#af08e27a43532afdccfdb21fcdea20871">km1mac</a>(k),pl)) *idx3</div>
<div class="line"><a name="l03226"></a><span class="lineno"> 3226</span>&#160;                    );</div>
<div class="line"><a name="l03227"></a><span class="lineno"> 3227</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03228"></a><span class="lineno"> 3228</span>&#160;<span class="preprocessor"></span>      }</div>
<div class="line"><a name="l03229"></a><span class="lineno"> 3229</span>&#160;    }<span class="comment">// end if doing B U</span></div>
<div class="line"><a name="l03230"></a><span class="lineno"> 3230</span>&#160;</div>
<div class="line"><a name="l03231"></a><span class="lineno"> 3231</span>&#160;  }<span class="comment">// end FLUXCD</span></div>
<div class="line"><a name="l03232"></a><span class="lineno"> 3232</span>&#160;</div>
<div class="line"><a name="l03233"></a><span class="lineno"> 3233</span>&#160;  <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l03234"></a><span class="lineno"> 3234</span>&#160;</div>
<div class="line"><a name="l03235"></a><span class="lineno"> 3235</span>&#160;    </div>
<div class="line"><a name="l03236"></a><span class="lineno"> 3236</span>&#160;    <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> lowerF2,upperF2;</div>
<div class="line"><a name="l03237"></a><span class="lineno"> 3237</span>&#160;<span class="preprocessor">#if(IF3DSPCTHENMPITRANSFERATPOLE==1)</span></div>
<div class="line"><a name="l03238"></a><span class="lineno"> 3238</span>&#160;<span class="preprocessor"></span>    <span class="comment">// Ensure that spherical polar axis flux only contributes to B2 for special3dspc=1 with polar cut-out.</span></div>
<div class="line"><a name="l03239"></a><span class="lineno"> 3239</span>&#160;    <span class="comment">// Allows more arbitrary interpolations across axis (including with gdet factors)</span></div>
<div class="line"><a name="l03240"></a><span class="lineno"> 3240</span>&#160;    <span class="comment">// &quot;lower&quot; means we will zero-out lower F2, while &quot;upper&quot; means we will zero-out upper F2 in terms of j in Du2avg expression</span></div>
<div class="line"><a name="l03241"></a><span class="lineno"> 3241</span>&#160;    <span class="keywordtype">int</span> preconditionF2lower=(<a class="code" href="../../d2/dbf/metric_8h.html#a720c791e54d46bbf744b0e3ed7050947">ISSPCMCOORD</a>(<a class="code" href="../../da/d3e/definit_8h.html#ab343edb2f60f3de2d654dcf1c58e06a2" title="#else define MAXBND 3 endif">MCOORD</a>) &amp;&amp; <a class="code" href="../../d8/d5b/defs_8general_8h.html#a11c4e99e1493d0c1914ad1ab313ea472">FLUXB</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0b6762cef74e396f50a83864bb53fb6c">FLUXCTSTAG</a> &amp;&amp; <a class="code" href="../../d8/d5b/defs_8general_8h.html#a67cb78168551d0bd18591a73d82dccf1" title="ENO DEBUG GLOBAL VARS.">special3dspc</a> &amp;&amp; (<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[2]+j==0 || <a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[2]+j==<a class="code" href="../../dd/d46/mpidefs_8h.html#ab3efab8b1f2dffc5907e0b0a5aa3988f">totalsize</a>[2]));</div>
<div class="line"><a name="l03242"></a><span class="lineno"> 3242</span>&#160;    <span class="keywordtype">int</span> preconditionF2upper=(<a class="code" href="../../d2/dbf/metric_8h.html#a720c791e54d46bbf744b0e3ed7050947">ISSPCMCOORD</a>(<a class="code" href="../../da/d3e/definit_8h.html#ab343edb2f60f3de2d654dcf1c58e06a2" title="#else define MAXBND 3 endif">MCOORD</a>) &amp;&amp; <a class="code" href="../../d8/d5b/defs_8general_8h.html#a11c4e99e1493d0c1914ad1ab313ea472">FLUXB</a>==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0b6762cef74e396f50a83864bb53fb6c">FLUXCTSTAG</a> &amp;&amp; <a class="code" href="../../d8/d5b/defs_8general_8h.html#a67cb78168551d0bd18591a73d82dccf1" title="ENO DEBUG GLOBAL VARS.">special3dspc</a> &amp;&amp; (<a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[2]+j==-1 || <a class="code" href="../../dd/d46/mpidefs_8h.html#a23649bd7d99c7d81c59db19199e2f11d">startpos</a>[2]+j==<a class="code" href="../../dd/d46/mpidefs_8h.html#ab3efab8b1f2dffc5907e0b0a5aa3988f">totalsize</a>[2]-1));</div>
<div class="line"><a name="l03243"></a><span class="lineno"> 3243</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03244"></a><span class="lineno"> 3244</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l03245"></a><span class="lineno"> 3245</span>&#160;    <span class="comment">// other (normal) FLUXB methods, including FLUXCTSTAG</span></div>
<div class="line"><a name="l03246"></a><span class="lineno"> 3246</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af5cae09eb90a697085d48b1779209f0e">PALLLOOPSPECIAL</a>(pl,special) {</div>
<div class="line"><a name="l03247"></a><span class="lineno"> 3247</span>&#160;      <span class="keywordflow">if</span>(whichpl==<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a2932863193c6165af8a2a33ce597c27c">DONONBPL</a> &amp;&amp; <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a56c640597356b6f642dd6ee1afb87e74">BPL</a>(pl)==1 || whichpl==<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38be7776d45c50ab681a1d9fd7b34bb2">DOBPL</a> &amp;&amp; <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a56c640597356b6f642dd6ee1afb87e74">BPL</a>(pl)==0) <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l03248"></a><span class="lineno"> 3248</span>&#160;</div>
<div class="line"><a name="l03249"></a><span class="lineno"> 3249</span>&#160;</div>
<div class="line"><a name="l03250"></a><span class="lineno"> 3250</span>&#160;<span class="preprocessor">#if(IF3DSPCTHENMPITRANSFERATPOLE==1)</span></div>
<div class="line"><a name="l03251"></a><span class="lineno"> 3251</span>&#160;<span class="preprocessor"></span>      <span class="keywordflow">if</span>(pl!=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a> &amp;&amp; preconditionF2lower) lowerF2=0.0;</div>
<div class="line"><a name="l03252"></a><span class="lineno"> 3252</span>&#160;      <span class="keywordflow">else</span> lowerF2=1.0;</div>
<div class="line"><a name="l03253"></a><span class="lineno"> 3253</span>&#160;      <span class="keywordflow">if</span>(pl!=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a6945d50f798e1fde624d70c74457090e">B2</a> &amp;&amp; preconditionF2upper) upperF2=0.0;</div>
<div class="line"><a name="l03254"></a><span class="lineno"> 3254</span>&#160;      <span class="keywordflow">else</span> upperF2=1.0;</div>
<div class="line"><a name="l03255"></a><span class="lineno"> 3255</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l03256"></a><span class="lineno"> 3256</span>&#160;<span class="preprocessor"></span>      lowerF2=1.0;</div>
<div class="line"><a name="l03257"></a><span class="lineno"> 3257</span>&#160;      upperF2=1.0;</div>
<div class="line"><a name="l03258"></a><span class="lineno"> 3258</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03259"></a><span class="lineno"> 3259</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l03260"></a><span class="lineno"> 3260</span>&#160;</div>
<div class="line"><a name="l03261"></a><span class="lineno"> 3261</span>&#160;<span class="preprocessor">#if(N1&gt;1)</span></div>
<div class="line"><a name="l03262"></a><span class="lineno"> 3262</span>&#160;<span class="preprocessor"></span>      dU1avg[pl]=(</div>
<div class="line"><a name="l03263"></a><span class="lineno"> 3263</span>&#160;                  - (<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F1,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a27e1e0a92af691ffd03d7e9d0a628392">ip1mac</a>(i),j,k,pl) - <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F1,i,j,k,pl)) *idx1</div>
<div class="line"><a name="l03264"></a><span class="lineno"> 3264</span>&#160;                  );</div>
<div class="line"><a name="l03265"></a><span class="lineno"> 3265</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03266"></a><span class="lineno"> 3266</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#if(N2&gt;1)</span></div>
<div class="line"><a name="l03267"></a><span class="lineno"> 3267</span>&#160;<span class="preprocessor"></span>      dU2avg[pl]=(</div>
<div class="line"><a name="l03268"></a><span class="lineno"> 3268</span>&#160;                  - (upperF2*<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F2,i,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a3e64aa2cd3c5e0933e74fa4e7a925570">jp1mac</a>(j),k,pl) - lowerF2*<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F2,i,j,k,pl)) *idx2</div>
<div class="line"><a name="l03269"></a><span class="lineno"> 3269</span>&#160;                  );</div>
<div class="line"><a name="l03270"></a><span class="lineno"> 3270</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03271"></a><span class="lineno"> 3271</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#if(N3&gt;1)</span></div>
<div class="line"><a name="l03272"></a><span class="lineno"> 3272</span>&#160;<span class="preprocessor"></span>      dU3avg[pl]=(</div>
<div class="line"><a name="l03273"></a><span class="lineno"> 3273</span>&#160;                  - (<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F3,i,j,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#aafe7c78a2d0713ddc9a4f1c61764e3b9">kp1mac</a>(k),pl) - <a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F3,i,j,k,pl)) *idx3</div>
<div class="line"><a name="l03274"></a><span class="lineno"> 3274</span>&#160;                  );</div>
<div class="line"><a name="l03275"></a><span class="lineno"> 3275</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03276"></a><span class="lineno"> 3276</span>&#160;<span class="preprocessor"></span>    }</div>
<div class="line"><a name="l03277"></a><span class="lineno"> 3277</span>&#160;</div>
<div class="line"><a name="l03278"></a><span class="lineno"> 3278</span>&#160;</div>
<div class="line"><a name="l03279"></a><span class="lineno"> 3279</span>&#160;</div>
<div class="line"><a name="l03280"></a><span class="lineno"> 3280</span>&#160;</div>
<div class="line"><a name="l03281"></a><span class="lineno"> 3281</span>&#160;  }</div>
<div class="line"><a name="l03282"></a><span class="lineno"> 3282</span>&#160;</div>
<div class="line"><a name="l03283"></a><span class="lineno"> 3283</span>&#160;</div>
<div class="line"><a name="l03284"></a><span class="lineno"> 3284</span>&#160;</div>
<div class="line"><a name="l03285"></a><span class="lineno"> 3285</span>&#160;</div>
<div class="line"><a name="l03286"></a><span class="lineno"> 3286</span>&#160;}</div>
<div class="line"><a name="l03287"></a><span class="lineno"> 3287</span>&#160;</div>
<div class="line"><a name="l03288"></a><span class="lineno"> 3288</span>&#160;</div>
<div class="line"><a name="l03289"></a><span class="lineno"> 3289</span>&#160;</div>
<div class="line"><a name="l03290"></a><span class="lineno"> 3290</span>&#160;</div>
<div class="line"><a name="l03291"></a><span class="lineno"> 3291</span>&#160;</div>
<div class="line"><a name="l03293"></a><span class="lineno"> 3293</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> dUtoU(<span class="keywordtype">int</span> timeorder, <span class="keywordtype">int</span> whichpl, <span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k, <span class="keywordtype">int</span> loc, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *dUgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*dUcomp)[NPR], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *dUriemann, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUf, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUnew, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ui,  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Uf, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *ucum)</div>
<div class="line"><a name="l03294"></a><span class="lineno"> 3294</span>&#160;{</div>
<div class="line"><a name="l03295"></a><span class="lineno"> 3295</span>&#160;  <span class="keywordtype">int</span> pl,pliter;</div>
<div class="line"><a name="l03296"></a><span class="lineno"> 3296</span>&#160;  <span class="keywordtype">void</span> dUtoU_check(<span class="keywordtype">int</span> timeorder, <span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k, <span class="keywordtype">int</span> loc, <span class="keywordtype">int</span> pl, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *dUgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*dUcomp)[NPR], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *dUriemann, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUf, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUnew, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ui,  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Uf, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *ucum);</div>
<div class="line"><a name="l03297"></a><span class="lineno"> 3297</span>&#160;</div>
<div class="line"><a name="l03298"></a><span class="lineno"> 3298</span>&#160;  <span class="keywordtype">int</span> special;</div>
<div class="line"><a name="l03299"></a><span class="lineno"> 3299</span>&#160;  <span class="keywordflow">if</span>(whichpl==<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#aae0730ddcfcd4a1591362411a0cde82b">DOSPECIALPL</a>){</div>
<div class="line"><a name="l03300"></a><span class="lineno"> 3300</span>&#160;    special=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>;</div>
<div class="line"><a name="l03301"></a><span class="lineno"> 3301</span>&#160;    whichpl=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac578a63f887dbc4797b555bd9c468a5f">DOALLPL</a>; <span class="comment">// override</span></div>
<div class="line"><a name="l03302"></a><span class="lineno"> 3302</span>&#160;  }</div>
<div class="line"><a name="l03303"></a><span class="lineno"> 3303</span>&#160;  <span class="keywordflow">else</span> special=0;</div>
<div class="line"><a name="l03304"></a><span class="lineno"> 3304</span>&#160;</div>
<div class="line"><a name="l03305"></a><span class="lineno"> 3305</span>&#160;</div>
<div class="line"><a name="l03306"></a><span class="lineno"> 3306</span>&#160;</div>
<div class="line"><a name="l03307"></a><span class="lineno"> 3307</span>&#160;  <span class="comment">// get physics non-geometry source terms</span></div>
<div class="line"><a name="l03308"></a><span class="lineno"> 3308</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dUrad[NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>],dUnonrad[NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>]; <span class="comment">// NSPECIAL part only used if whichpl==DOSPECIALPL</span></div>
<div class="line"><a name="l03309"></a><span class="lineno"> 3309</span>&#160;  <span class="keywordtype">int</span> sc;</div>
<div class="line"><a name="l03310"></a><span class="lineno"> 3310</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af5cae09eb90a697085d48b1779209f0e">PALLLOOPSPECIAL</a>(pl,special){</div>
<div class="line"><a name="l03311"></a><span class="lineno"> 3311</span>&#160;    dUrad[pl]=0.0; <span class="comment">// init as zero</span></div>
<div class="line"><a name="l03312"></a><span class="lineno"> 3312</span>&#160;    <span class="comment">// only sc=RADSOURCE is in implicit part, so only separate that out</span></div>
<div class="line"><a name="l03313"></a><span class="lineno"> 3313</span>&#160;    sc=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab130f34dd5996718289efe08bc68b518">RADSOURCE</a>;</div>
<div class="line"><a name="l03314"></a><span class="lineno"> 3314</span>&#160;    <span class="keywordflow">if</span>(pl&lt;NPR) dUrad[pl] = dUcomp[sc][pl]; <span class="comment">// dUcomp always NPR, but dUrad over full range possible</span></div>
<div class="line"><a name="l03315"></a><span class="lineno"> 3315</span>&#160;</div>
<div class="line"><a name="l03316"></a><span class="lineno"> 3316</span>&#160;    <span class="comment">// all terms except RADSOURCE</span></div>
<div class="line"><a name="l03317"></a><span class="lineno"> 3317</span>&#160;    dUnonrad[pl] = dUgeom[pl] - dUrad[pl];</div>
<div class="line"><a name="l03318"></a><span class="lineno"> 3318</span>&#160;  }</div>
<div class="line"><a name="l03319"></a><span class="lineno"> 3319</span>&#160;</div>
<div class="line"><a name="l03320"></a><span class="lineno"> 3320</span>&#160;  <span class="comment">// initialize dUradall as zero.  Ensure initialized for any possible pl&#39;s</span></div>
<div class="line"><a name="l03321"></a><span class="lineno"> 3321</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dUradall[NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>][<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0a72db4856620ff1b9551c885f1b32b5">MAXTIMEORDER</a>];</div>
<div class="line"><a name="l03322"></a><span class="lineno"> 3322</span>&#160;  <span class="keywordtype">int</span> ii,jj;</div>
<div class="line"><a name="l03323"></a><span class="lineno"> 3323</span>&#160;  <span class="keywordflow">for</span>(ii=0;ii&lt;<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0a72db4856620ff1b9551c885f1b32b5">MAXTIMEORDER</a>;ii++){</div>
<div class="line"><a name="l03324"></a><span class="lineno"> 3324</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) dUradall[pl][ii]=0.0;</div>
<div class="line"><a name="l03325"></a><span class="lineno"> 3325</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af5cae09eb90a697085d48b1779209f0e">PALLLOOPSPECIAL</a>(pl,special) dUradall[pl][ii]=0.0;</div>
<div class="line"><a name="l03326"></a><span class="lineno"> 3326</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a9afde1f1647e18e733406a1566b8b550">PLOOPBONLY</a>(pl) dUradall[pl][ii]=0.0;</div>
<div class="line"><a name="l03327"></a><span class="lineno"> 3327</span>&#160;  }</div>
<div class="line"><a name="l03328"></a><span class="lineno"> 3328</span>&#160;</div>
<div class="line"><a name="l03329"></a><span class="lineno"> 3329</span>&#160;</div>
<div class="line"><a name="l03330"></a><span class="lineno"> 3330</span>&#160;  <span class="comment">// store physics dU&#39;s that could need an implicit treatment</span></div>
<div class="line"><a name="l03331"></a><span class="lineno"> 3331</span>&#160;  if(<a class="code" href="../../da/d3e/definit_8h.html#a99ba7daf58b283bc831b8f507f5873a4" title="#define EOMTYPE EOMCOLDGRMHD">EOMRADTYPE</a>!=<a class="code" href="../../d4/d96/global_8nondepmnemonics_8rad_8h.html#a993e29ef4139116d822d89bccb92180d" title="radiation equations of motion">EOMRADNONE</a> &amp;&amp; special==0){ <span class="comment">// don&#39;t access Mradk if from compute_dissmeasure that uses special!=0</span></div>
<div class="line"><a name="l03332"></a><span class="lineno"> 3332</span>&#160;    <span class="comment">// only non-field case</span></div>
<div class="line"><a name="l03333"></a><span class="lineno"> 3333</span>&#160;    <span class="keywordflow">if</span>(whichpl==<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac578a63f887dbc4797b555bd9c468a5f">DOALLPL</a> || whichpl==<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a2932863193c6165af8a2a33ce597c27c">DONONBPL</a>){</div>
<div class="line"><a name="l03334"></a><span class="lineno"> 3334</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl){</div>
<div class="line"><a name="l03335"></a><span class="lineno"> 3335</span>&#160;        <a class="code" href="../../df/d1c/global_8storage_8h.html#ad72b4d1450b9b8c3abdcf9fb88acfba9">GLOBALMACP1A1</a>(Mradk,timeorder,i,j,k,pl) = dUrad[pl]; <span class="comment">// USE OF GLOBALS // only NPR pl&#39;s exist for Mradk</span></div>
<div class="line"><a name="l03336"></a><span class="lineno"> 3336</span>&#160;      }</div>
<div class="line"><a name="l03337"></a><span class="lineno"> 3337</span>&#160;      </div>
<div class="line"><a name="l03338"></a><span class="lineno"> 3338</span>&#160;      <span class="comment">// now assign dUradall for radiation</span></div>
<div class="line"><a name="l03339"></a><span class="lineno"> 3339</span>&#160;      <span class="keywordflow">for</span>(ii=0;ii&lt;=timeorder;ii++){ <span class="comment">// timeorder goes from 0..TIMEORDER-1 inclusive</span></div>
<div class="line"><a name="l03340"></a><span class="lineno"> 3340</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) dUradall[pl][ii] = <a class="code" href="../../df/d1c/global_8storage_8h.html#ad72b4d1450b9b8c3abdcf9fb88acfba9">GLOBALMACP1A1</a>(Mradk,ii,i,j,k,pl); <span class="comment">// radiation could affect any pl&#39;s, but only NPR pl&#39;s exist for Mradk GODMARK -- issue with dissmeasure?</span></div>
<div class="line"><a name="l03341"></a><span class="lineno"> 3341</span>&#160;      }</div>
<div class="line"><a name="l03342"></a><span class="lineno"> 3342</span>&#160;    }</div>
<div class="line"><a name="l03343"></a><span class="lineno"> 3343</span>&#160;  }</div>
<div class="line"><a name="l03344"></a><span class="lineno"> 3344</span>&#160;  else{</div>
<div class="line"><a name="l03345"></a><span class="lineno"> 3345</span>&#160;    <span class="comment">// then assume not related to implicit radiation but still done per timeorder as if explicit</span></div>
<div class="line"><a name="l03346"></a><span class="lineno"> 3346</span>&#160;    ii=timeorder;</div>
<div class="line"><a name="l03347"></a><span class="lineno"> 3347</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af5cae09eb90a697085d48b1779209f0e">PALLLOOPSPECIAL</a>(pl,special) dUradall[pl][ii] = dUrad[pl];</div>
<div class="line"><a name="l03348"></a><span class="lineno"> 3348</span>&#160;  }</div>
<div class="line"><a name="l03349"></a><span class="lineno"> 3349</span>&#160;</div>
<div class="line"><a name="l03350"></a><span class="lineno"> 3350</span>&#160;</div>
<div class="line"><a name="l03351"></a><span class="lineno"> 3351</span>&#160;  if(whichpl==<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac578a63f887dbc4797b555bd9c468a5f">DOALLPL</a>){</div>
<div class="line"><a name="l03352"></a><span class="lineno"> 3352</span>&#160;    <span class="comment">// finally assign new Uf and ucum</span></div>
<div class="line"><a name="l03353"></a><span class="lineno"> 3353</span>&#160;    <span class="comment">// store uf to avoid recomputing U(pf) used later as pb for advance()</span></div>
<div class="line"><a name="l03354"></a><span class="lineno"> 3354</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af5cae09eb90a697085d48b1779209f0e">PALLLOOPSPECIAL</a>(pl,special) Uf[pl] = UFSET(CUf,<a class="code" href="../../d8/d5b/defs_8general_8h.html#a56db625f31229c5e8b208ff27d464931">dt</a>,Ui[pl],Uf[pl],dUriemann[pl],dUnonrad[pl],dUradall[pl]);</div>
<div class="line"><a name="l03355"></a><span class="lineno"> 3355</span>&#160;    </div>
<div class="line"><a name="l03356"></a><span class="lineno"> 3356</span>&#160;    </div>
<div class="line"><a name="l03357"></a><span class="lineno"> 3357</span>&#160;    <span class="comment">// how much of Ui, dU, and Uf to keep for final solution</span></div>
<div class="line"><a name="l03358"></a><span class="lineno"> 3358</span>&#160;    <span class="comment">// ultimately ucum is actual solution used to find final pf</span></div>
<div class="line"><a name="l03359"></a><span class="lineno"> 3359</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af5cae09eb90a697085d48b1779209f0e">PALLLOOPSPECIAL</a>(pl,special) ucum[pl] += UCUMUPDATE(CUnew,dt,Ui[pl],Uf[pl],dUriemann[pl],dUnonrad[pl],dUradall[pl]);</div>
<div class="line"><a name="l03360"></a><span class="lineno"> 3360</span>&#160;</div>
<div class="line"><a name="l03361"></a><span class="lineno"> 3361</span>&#160;<span class="preprocessor">#if(PRODUCTION==0)</span></div>
<div class="line"><a name="l03362"></a><span class="lineno"> 3362</span>&#160;<span class="preprocessor"></span>    <span class="keywordflow">if</span>(<a class="code" href="../../d8/d5b/defs_8general_8h.html#a11c4e99e1493d0c1914ad1ab313ea472">FLUXB</a>!=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a0b6762cef74e396f50a83864bb53fb6c">FLUXCTSTAG</a>){<span class="comment">// turned off by default for FLUXB==FLUXCTSTAG since even with PRODUCTION==0, FLUXB==FLUXCTSTAG&#39;s extended loop causes output at edges.</span></div>
<div class="line"><a name="l03363"></a><span class="lineno"> 3363</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) dUtoU_check(timeorder,i,j,k,loc,pl, dUgeom, dUcomp, dUriemann, CUf, CUnew, Ui,  Uf, ucum);</div>
<div class="line"><a name="l03364"></a><span class="lineno"> 3364</span>&#160;    }</div>
<div class="line"><a name="l03365"></a><span class="lineno"> 3365</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03366"></a><span class="lineno"> 3366</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l03367"></a><span class="lineno"> 3367</span>&#160;  }</div>
<div class="line"><a name="l03368"></a><span class="lineno"> 3368</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(whichpl==<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38be7776d45c50ab681a1d9fd7b34bb2">DOBPL</a>){</div>
<div class="line"><a name="l03369"></a><span class="lineno"> 3369</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a9afde1f1647e18e733406a1566b8b550">PLOOPBONLY</a>(pl) Uf[pl] = UFSET(CUf,dt,Ui[pl],Uf[pl],dUriemann[pl],dUnonrad[pl],dUradall[pl]);</div>
<div class="line"><a name="l03370"></a><span class="lineno"> 3370</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a9afde1f1647e18e733406a1566b8b550">PLOOPBONLY</a>(pl) ucum[pl] += UCUMUPDATE(CUnew,dt,Ui[pl],Uf[pl],dUriemann[pl],dUnonrad[pl],dUradall[pl]);</div>
<div class="line"><a name="l03371"></a><span class="lineno"> 3371</span>&#160;  }</div>
<div class="line"><a name="l03372"></a><span class="lineno"> 3372</span>&#160;  else if(whichpl==<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a2932863193c6165af8a2a33ce597c27c">DONONBPL</a>){</div>
<div class="line"><a name="l03373"></a><span class="lineno"> 3373</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af5cae09eb90a697085d48b1779209f0e">PALLLOOPSPECIAL</a>(pl,special) if(!<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a56c640597356b6f642dd6ee1afb87e74">BPL</a>(pl)) Uf[pl] = UFSET(CUf,dt,Ui[pl],Uf[pl],dUriemann[pl],dUnonrad[pl],dUradall[pl]);</div>
<div class="line"><a name="l03374"></a><span class="lineno"> 3374</span>&#160;    <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af5cae09eb90a697085d48b1779209f0e">PALLLOOPSPECIAL</a>(pl,special) if(!<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a56c640597356b6f642dd6ee1afb87e74">BPL</a>(pl)) ucum[pl] += UCUMUPDATE(CUnew,dt,Ui[pl],Uf[pl],dUriemann[pl],dUnonrad[pl],dUradall[pl]);</div>
<div class="line"><a name="l03375"></a><span class="lineno"> 3375</span>&#160;  }</div>
<div class="line"><a name="l03376"></a><span class="lineno"> 3376</span>&#160;</div>
<div class="line"><a name="l03377"></a><span class="lineno"> 3377</span>&#160;  <span class="comment">//  if(nstep==4 &amp;&amp; steppart==0 &amp;&amp; whichpl==DONONBPL){</span></div>
<div class="line"><a name="l03378"></a><span class="lineno"> 3378</span>&#160;  <span class="comment">//    PALLLOOPSPECIAL(pl,special) dualfprintf(fail_file,&quot;UtoU: %21.15g %21.15g %21.15g %21.15g\n&quot;,(CUf[0])*(Ui[pl]/globalgeom[pl]),(CUf[1])*(Uf[pl]/globalgeom[pl]),(CUf[2])*(dt)*((dUriemann[pl]/globalgeom[pl])+(dUgeom[pl]/globalgeom[pl])),CUf[2]*dt);</span></div>
<div class="line"><a name="l03379"></a><span class="lineno"> 3379</span>&#160;  <span class="comment">//  }</span></div>
<div class="line"><a name="l03380"></a><span class="lineno"> 3380</span>&#160;</div>
<div class="line"><a name="l03381"></a><span class="lineno"> 3381</span>&#160;</div>
<div class="line"><a name="l03382"></a><span class="lineno"> 3382</span>&#160;}</div>
<div class="line"><a name="l03383"></a><span class="lineno"> 3383</span>&#160;</div>
<div class="line"><a name="l03384"></a><span class="lineno"> 3384</span>&#160;</div>
<div class="line"><a name="l03385"></a><span class="lineno"> 3385</span>&#160;</div>
<div class="line"><a name="l03387"></a><span class="lineno"> 3387</span>&#160;static <span class="keywordtype">void</span> dUtoU_check(<span class="keywordtype">int</span> timeorder, <span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k, <span class="keywordtype">int</span> loc, <span class="keywordtype">int</span> pl, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *dUgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*dUcomp)[NPR], <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *dUriemann, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUf, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUnew, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Ui,  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *Uf, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *ucum)</div>
<div class="line"><a name="l03388"></a><span class="lineno"> 3388</span>&#160;{</div>
<div class="line"><a name="l03389"></a><span class="lineno"> 3389</span>&#160;  <span class="keywordtype">int</span> showfluxes;</div>
<div class="line"><a name="l03390"></a><span class="lineno"> 3390</span>&#160;  <span class="keywordtype">void</span> show_fluxes(<span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k, <span class="keywordtype">int</span> loc, <span class="keywordtype">int</span> pl,<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*F1)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*F2)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*F3)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>]);</div>
<div class="line"><a name="l03391"></a><span class="lineno"> 3391</span>&#160;</div>
<div class="line"><a name="l03392"></a><span class="lineno"> 3392</span>&#160;</div>
<div class="line"><a name="l03393"></a><span class="lineno"> 3393</span>&#160;  <span class="comment">// default</span></div>
<div class="line"><a name="l03394"></a><span class="lineno"> 3394</span>&#160;  showfluxes=0;</div>
<div class="line"><a name="l03395"></a><span class="lineno"> 3395</span>&#160;</div>
<div class="line"><a name="l03396"></a><span class="lineno"> 3396</span>&#160;  <span class="keywordflow">if</span>(!<a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(Uf[pl])){</div>
<div class="line"><a name="l03397"></a><span class="lineno"> 3397</span>&#160;    dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;dUtoU after: nan found for Uf[%d]=%21.15g\n&quot;</span>,pl,Uf[pl]);</div>
<div class="line"><a name="l03398"></a><span class="lineno"> 3398</span>&#160;    dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;pl=%d Ui=%21.15g dUriemann=%21.15g dugeom=%21.15g\n&quot;</span>,pl,Ui[pl],dUriemann[pl],dUgeom[pl]);</div>
<div class="line"><a name="l03399"></a><span class="lineno"> 3399</span>&#160;    showfluxes=1;</div>
<div class="line"><a name="l03400"></a><span class="lineno"> 3400</span>&#160;  }</div>
<div class="line"><a name="l03401"></a><span class="lineno"> 3401</span>&#160;  <span class="keywordflow">if</span>(!<a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(ucum[pl])){</div>
<div class="line"><a name="l03402"></a><span class="lineno"> 3402</span>&#160;    dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;dUtoU after: nan found for ucum[%d]=%21.15g\n&quot;</span>,pl,ucum[pl]);</div>
<div class="line"><a name="l03403"></a><span class="lineno"> 3403</span>&#160;    dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;pl=%d Ui=%21.15g dUriemann=%21.15g dugeom=%21.15g\n&quot;</span>,pl,Ui[pl],dUriemann[pl],dUgeom[pl]);</div>
<div class="line"><a name="l03404"></a><span class="lineno"> 3404</span>&#160;    showfluxes=1;</div>
<div class="line"><a name="l03405"></a><span class="lineno"> 3405</span>&#160;  }</div>
<div class="line"><a name="l03406"></a><span class="lineno"> 3406</span>&#160;</div>
<div class="line"><a name="l03407"></a><span class="lineno"> 3407</span>&#160;  <span class="keywordflow">if</span>(showfluxes){</div>
<div class="line"><a name="l03408"></a><span class="lineno"> 3408</span>&#160;    show_fluxes(i,j,k,loc,pl,<a class="code" href="../../df/d1c/global_8storage_8h.html#ad89dafa5d772b862a44b0f576983ead3" title="shifted pointer (a_s_) wrappers Couldn&#39;t figure out how to macrofy a_s_ or a_, so when changing have ...">GLOBALPOINT</a>(F1),<a class="code" href="../../df/d1c/global_8storage_8h.html#ad89dafa5d772b862a44b0f576983ead3" title="shifted pointer (a_s_) wrappers Couldn&#39;t figure out how to macrofy a_s_ or a_, so when changing have ...">GLOBALPOINT</a>(F2),<a class="code" href="../../df/d1c/global_8storage_8h.html#ad89dafa5d772b862a44b0f576983ead3" title="shifted pointer (a_s_) wrappers Couldn&#39;t figure out how to macrofy a_s_ or a_, so when changing have ...">GLOBALPOINT</a>(F3));</div>
<div class="line"><a name="l03409"></a><span class="lineno"> 3409</span>&#160;  }</div>
<div class="line"><a name="l03410"></a><span class="lineno"> 3410</span>&#160;</div>
<div class="line"><a name="l03411"></a><span class="lineno"> 3411</span>&#160;</div>
<div class="line"><a name="l03412"></a><span class="lineno"> 3412</span>&#160;}</div>
<div class="line"><a name="l03413"></a><span class="lineno"> 3413</span>&#160;</div>
<div class="line"><a name="l03414"></a><span class="lineno"> 3414</span>&#160;</div>
<div class="line"><a name="l03417"></a><span class="lineno"> 3417</span>&#160;<span class="keywordtype">void</span> ucum_check(<span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k, <span class="keywordtype">int</span> loc, <span class="keywordtype">int</span> pl, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *ucum)</div>
<div class="line"><a name="l03418"></a><span class="lineno"> 3418</span>&#160;{</div>
<div class="line"><a name="l03419"></a><span class="lineno"> 3419</span>&#160;  <span class="keywordtype">int</span> showfluxes;</div>
<div class="line"><a name="l03420"></a><span class="lineno"> 3420</span>&#160;</div>
<div class="line"><a name="l03421"></a><span class="lineno"> 3421</span>&#160;</div>
<div class="line"><a name="l03422"></a><span class="lineno"> 3422</span>&#160;  <span class="comment">// default</span></div>
<div class="line"><a name="l03423"></a><span class="lineno"> 3423</span>&#160;  showfluxes=0;</div>
<div class="line"><a name="l03424"></a><span class="lineno"> 3424</span>&#160;</div>
<div class="line"><a name="l03425"></a><span class="lineno"> 3425</span>&#160;  <span class="keywordflow">if</span>(!<a class="code" href="../../d8/df4/global_8funcdeclare_8h.html#a9d578d6f7714cd0ca219fc3be5f34422" title="SUPERLONGDOUBLE declarations.">isfinite</a>(ucum[pl])){</div>
<div class="line"><a name="l03426"></a><span class="lineno"> 3426</span>&#160;    dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;ucum_check: nan found at i=%d j=%d k=%d loc=%d for ucum[pl=%d]=%21.15g\n&quot;</span>,i,j,k,loc,pl,ucum[pl]);</div>
<div class="line"><a name="l03427"></a><span class="lineno"> 3427</span>&#160;    showfluxes=1;</div>
<div class="line"><a name="l03428"></a><span class="lineno"> 3428</span>&#160;  }</div>
<div class="line"><a name="l03429"></a><span class="lineno"> 3429</span>&#160;</div>
<div class="line"><a name="l03430"></a><span class="lineno"> 3430</span>&#160;  <span class="keywordflow">if</span>(showfluxes){</div>
<div class="line"><a name="l03431"></a><span class="lineno"> 3431</span>&#160;    show_fluxes(i,j,k,loc,pl,<a class="code" href="../../df/d1c/global_8storage_8h.html#ad89dafa5d772b862a44b0f576983ead3" title="shifted pointer (a_s_) wrappers Couldn&#39;t figure out how to macrofy a_s_ or a_, so when changing have ...">GLOBALPOINT</a>(F1),<a class="code" href="../../df/d1c/global_8storage_8h.html#ad89dafa5d772b862a44b0f576983ead3" title="shifted pointer (a_s_) wrappers Couldn&#39;t figure out how to macrofy a_s_ or a_, so when changing have ...">GLOBALPOINT</a>(F2),<a class="code" href="../../df/d1c/global_8storage_8h.html#ad89dafa5d772b862a44b0f576983ead3" title="shifted pointer (a_s_) wrappers Couldn&#39;t figure out how to macrofy a_s_ or a_, so when changing have ...">GLOBALPOINT</a>(F3));</div>
<div class="line"><a name="l03432"></a><span class="lineno"> 3432</span>&#160;  }</div>
<div class="line"><a name="l03433"></a><span class="lineno"> 3433</span>&#160;</div>
<div class="line"><a name="l03434"></a><span class="lineno"> 3434</span>&#160;</div>
<div class="line"><a name="l03435"></a><span class="lineno"> 3435</span>&#160;}</div>
<div class="line"><a name="l03436"></a><span class="lineno"> 3436</span>&#160;</div>
<div class="line"><a name="l03438"></a><span class="lineno"> 3438</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> show_fluxes(<span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k, <span class="keywordtype">int</span> loc, <span class="keywordtype">int</span> pl,<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*F1)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*F2)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>],<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*F3)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac14b9db972c66ce6df62cb4d4faa6ded">NSPECIAL</a>])</div>
<div class="line"><a name="l03439"></a><span class="lineno"> 3439</span>&#160;{</div>
<div class="line"><a name="l03440"></a><span class="lineno"> 3440</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#abd7b39be02bc15d79b73e5cf2b531299" title="#define CORNGDETVERSION 0">N1</a>&gt;1){</div>
<div class="line"><a name="l03441"></a><span class="lineno"> 3441</span>&#160;    dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;pl=%d i=%d j=%d k=%d :: F1[i]=%21.15g F1[i+1]=%21.15g dF1/dx1=%21.15g \n&quot;</span>,pl,i,j,k,<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F1,i,j,k,pl),<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F1,i+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a2fb146af349ab49ff48fa36b12b9e4fe" title="x1">SHIFT1</a>,j,k,pl),(<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F1,i+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a2fb146af349ab49ff48fa36b12b9e4fe" title="x1">SHIFT1</a>,j,k,pl)-<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F1,i,j,k,pl))/<a class="code" href="../../d8/d5b/defs_8general_8h.html#a99b91d8e229e5df70958f2aed7fd15bf">dx</a>[1]);</div>
<div class="line"><a name="l03442"></a><span class="lineno"> 3442</span>&#160;  }</div>
<div class="line"><a name="l03443"></a><span class="lineno"> 3443</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#acd864640121c7df2c19f61f7baa507e4">N2</a>&gt;1){</div>
<div class="line"><a name="l03444"></a><span class="lineno"> 3444</span>&#160;    dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;pl=%d i=%d j=%d k=%d :: F2[j]=%21.15g F2[j+1]=%21.15g dF2/dx2=%21.15g\n&quot;</span>,pl,i,j,k,<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F2,i,j,k,pl),<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F2,i,j+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a4601f340e88302d63182d0844c4e3c09" title="x2">SHIFT2</a>,k,pl),(<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F2,i,j+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a4601f340e88302d63182d0844c4e3c09" title="x2">SHIFT2</a>,k,pl)-<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F2,i,j,k,pl))/<a class="code" href="../../d8/d5b/defs_8general_8h.html#a99b91d8e229e5df70958f2aed7fd15bf">dx</a>[2]);</div>
<div class="line"><a name="l03445"></a><span class="lineno"> 3445</span>&#160;  }</div>
<div class="line"><a name="l03446"></a><span class="lineno"> 3446</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#ad66109fbdc4d3adc9c3d6ff917038aef">N3</a>&gt;1){</div>
<div class="line"><a name="l03447"></a><span class="lineno"> 3447</span>&#160;    dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;pl=%d i=%d j=%d k=%d :: F3[k]=%21.15g F3[k+1]=%21.15g dF3/dx3=%21.15g \n&quot;</span>,pl,i,j,k,<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F3,i,j,k,pl),<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F3,i,j,k+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac3ff9bd198294b5b3a9c6a22b9cf456a" title="x3">SHIFT3</a>,pl),(<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F3,i,j,k+<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#ac3ff9bd198294b5b3a9c6a22b9cf456a" title="x3">SHIFT3</a>,pl)-<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(F3,i,j,k,pl))/<a class="code" href="../../d8/d5b/defs_8general_8h.html#a99b91d8e229e5df70958f2aed7fd15bf">dx</a>[3]);</div>
<div class="line"><a name="l03448"></a><span class="lineno"> 3448</span>&#160;  }</div>
<div class="line"><a name="l03449"></a><span class="lineno"> 3449</span>&#160;</div>
<div class="line"><a name="l03450"></a><span class="lineno"> 3450</span>&#160;}</div>
<div class="line"><a name="l03451"></a><span class="lineno"> 3451</span>&#160;</div>
<div class="line"><a name="l03452"></a><span class="lineno"> 3452</span>&#160;</div>
<div class="line"><a name="l03453"></a><span class="lineno"> 3453</span>&#160;</div>
<div class="line"><a name="l03456"></a><span class="lineno"> 3456</span>&#160;<span class="keywordtype">int</span> set_dt(<a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> (*prim)[<a class="code" href="../../df/d1c/global_8storage_8h.html#ad1398d310d3072da1a781925d63e61b2">NSTORE2</a>][<a class="code" href="../../df/d1c/global_8storage_8h.html#a6763b3a393c2900fc4a186bfbe6f3bb5">NSTORE3</a>][NPR], <a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a0263684ebff8e72a2f0de1861393595f">SFTYPE</a> *dt)</div>
<div class="line"><a name="l03457"></a><span class="lineno"> 3457</span>&#160;{</div>
<div class="line"><a name="l03458"></a><span class="lineno"> 3458</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> state;</div>
<div class="line"><a name="l03459"></a><span class="lineno"> 3459</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> geomdontuse;</div>
<div class="line"><a name="l03460"></a><span class="lineno"> 3460</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom=&amp;geomdontuse;</div>
<div class="line"><a name="l03461"></a><span class="lineno"> 3461</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>,<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>,k;</div>
<div class="line"><a name="l03462"></a><span class="lineno"> 3462</span>&#160;  <span class="keywordtype">int</span> pl,pliter;</div>
<div class="line"><a name="l03463"></a><span class="lineno"> 3463</span>&#160;  <span class="keywordtype">int</span> jj,kk,ll;</div>
<div class="line"><a name="l03464"></a><span class="lineno"> 3464</span>&#160;  <span class="keywordtype">int</span> dir,ignorecourant;</div>
<div class="line"><a name="l03465"></a><span class="lineno"> 3465</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> cmax1,cmin1;</div>
<div class="line"><a name="l03466"></a><span class="lineno"> 3466</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> cmax2,cmin2;</div>
<div class="line"><a name="l03467"></a><span class="lineno"> 3467</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> cmax3,cmin3;</div>
<div class="line"><a name="l03468"></a><span class="lineno"> 3468</span>&#160;  <span class="keywordtype">int</span> wavendti[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>],wavendtj[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>],wavendtk[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l03469"></a><span class="lineno"> 3469</span>&#160;  <span class="keywordtype">int</span> accdti,accdtj,accdtk;</div>
<div class="line"><a name="l03470"></a><span class="lineno"> 3470</span>&#160;  <span class="keywordtype">int</span> gravitydti,gravitydtj,gravitydtk;</div>
<div class="line"><a name="l03471"></a><span class="lineno"> 3471</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> tempwavedt,tempaccdt,tempgravitydt;</div>
<div class="line"><a name="l03472"></a><span class="lineno"> 3472</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dtij[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>]={<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>}, wavedt, accdt, gravitydt;</div>
<div class="line"><a name="l03473"></a><span class="lineno"> 3473</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> wavendt[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l03474"></a><span class="lineno"> 3474</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> wavedt_1,wavedt_2,wavedttemp;</div>
<div class="line"><a name="l03475"></a><span class="lineno"> 3475</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ndtfinal;</div>
<div class="line"><a name="l03476"></a><span class="lineno"> 3476</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dUgeom[NPR],dUcomp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ac34589654a83c911addd1fda0898e738">NUMSOURCES</a>][NPR];</div>
<div class="line"><a name="l03477"></a><span class="lineno"> 3477</span>&#160;  <span class="keywordtype">int</span> enerregion;</div>
<div class="line"><a name="l03478"></a><span class="lineno"> 3478</span>&#160;  <span class="keywordtype">int</span> *waveenerpos, *sourceenerpos;</div>
<div class="line"><a name="l03479"></a><span class="lineno"> 3479</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> <a class="code" href="../../dc/dd2/newcodediff_8txt.html#a933233ff9879962bcc2ff987c6920f90">X</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>],<a class="code" href="../../dc/dd2/newcodediff_8txt.html#af84f2c3bf153920b7c8d186132d39bc7">V</a>[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>],Vp1[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l03480"></a><span class="lineno"> 3480</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dUriemann[NPR];</div>
<div class="line"><a name="l03481"></a><span class="lineno"> 3481</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Ugeomfree[NPR],U[NPR];</div>
<div class="line"><a name="l03482"></a><span class="lineno"> 3482</span>&#160;</div>
<div class="line"><a name="l03483"></a><span class="lineno"> 3483</span>&#160;</div>
<div class="line"><a name="l03484"></a><span class="lineno"> 3484</span>&#160;</div>
<div class="line"><a name="l03485"></a><span class="lineno"> 3485</span>&#160;</div>
<div class="line"><a name="l03486"></a><span class="lineno"> 3486</span>&#160;  wavedt_1=wavedt_2=wavedt=accdt=gravitydt=ndtfinal=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>;</div>
<div class="line"><a name="l03487"></a><span class="lineno"> 3487</span>&#160;  wavendt[1]=wavendt[2]=wavendt[3]=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>;</div>
<div class="line"><a name="l03488"></a><span class="lineno"> 3488</span>&#160;  wavendti[1]=wavendtj[1]=wavendtk[1]=-100;</div>
<div class="line"><a name="l03489"></a><span class="lineno"> 3489</span>&#160;  wavendti[2]=wavendtj[2]=wavendtk[2]=-100;</div>
<div class="line"><a name="l03490"></a><span class="lineno"> 3490</span>&#160;  wavendti[3]=wavendtj[3]=wavendtk[3]=-100;</div>
<div class="line"><a name="l03491"></a><span class="lineno"> 3491</span>&#160;  accdti=accdtj=accdtk=-100;</div>
<div class="line"><a name="l03492"></a><span class="lineno"> 3492</span>&#160;  gravitydti=gravitydtj=gravitydtk=-100;</div>
<div class="line"><a name="l03493"></a><span class="lineno"> 3493</span>&#160;</div>
<div class="line"><a name="l03494"></a><span class="lineno"> 3494</span>&#160;  enerregion=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab48e4e45d2434009418d485187e3bdc9" title="&quot;outside&quot; horizon means r&gt;=r_+">OUTSIDEHORIZONENERREGION</a>; <span class="comment">// consistent with flux update (except when doing WHAM)</span></div>
<div class="line"><a name="l03495"></a><span class="lineno"> 3495</span>&#160;  sourceenerpos=<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad41a84c69f5ec4a51492e96b4dc61ac4">enerposreg</a>[enerregion];</div>
<div class="line"><a name="l03496"></a><span class="lineno"> 3496</span>&#160;</div>
<div class="line"><a name="l03497"></a><span class="lineno"> 3497</span>&#160;  <span class="keywordtype">int</span> didreturnpf=0; <span class="comment">// used to have source() pass back better guess for Utoprimgen() than pb.</span></div>
<div class="line"><a name="l03498"></a><span class="lineno"> 3498</span>&#160;</div>
<div class="line"><a name="l03499"></a><span class="lineno"> 3499</span>&#160;  <span class="comment">//  COMPFULLLOOP{ // want to use boundary cells as well to limit dt (otherwise boundary-induced changes not treated)</span></div>
<div class="line"><a name="l03500"></a><span class="lineno"> 3500</span>&#160;  <a class="code" href="../../d1/d07/global_8gridsectioning_8h.html#a39ab1af4b34a81d2eabffdfd6001fe7f">LOOPWITHINACTIVESECTIONEXPAND1</a>(i,j,k){ <span class="comment">// only 1 grid cell within boundary.  Don&#39;t need to use extrapolated cells deep inside boundary because those cells are not evolved.  More consistent with how flux.c sets dt.</span></div>
<div class="line"><a name="l03501"></a><span class="lineno"> 3501</span>&#160;</div>
<div class="line"><a name="l03502"></a><span class="lineno"> 3502</span>&#160;    <span class="comment">// includes &quot;ghost&quot; zones in case boundary drives solution</span></div>
<div class="line"><a name="l03503"></a><span class="lineno"> 3503</span>&#160;    <a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a3059ed7bfcfb692cbe8014d55fd7c1e4">get_geometry</a>(i, j, k, CENT, ptrgeom);</div>
<div class="line"><a name="l03504"></a><span class="lineno"> 3504</span>&#160;    </div>
<div class="line"><a name="l03505"></a><span class="lineno"> 3505</span>&#160;    <span class="comment">// need full state for vchar()</span></div>
<div class="line"><a name="l03506"></a><span class="lineno"> 3506</span>&#160;    <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a11e17cd8b0594d1ad52e3594aa9f477e" title="find ucon, ucov, bcon, bcov from primitive variables when calling get_state, users of this function e...">get_state</a>(<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(prim,i,j,k), ptrgeom, &amp;state),<span class="stringliteral">&quot;advance.c:set_dt()&quot;</span>, <span class="stringliteral">&quot;get_state()&quot;</span>, 1);</div>
<div class="line"><a name="l03507"></a><span class="lineno"> 3507</span>&#160;    </div>
<div class="line"><a name="l03508"></a><span class="lineno"> 3508</span>&#160;    </div>
<div class="line"><a name="l03509"></a><span class="lineno"> 3509</span>&#160;<span class="preprocessor">#if(N1&gt;1)</span></div>
<div class="line"><a name="l03510"></a><span class="lineno"> 3510</span>&#160;<span class="preprocessor"></span>    dir=1;</div>
<div class="line"><a name="l03511"></a><span class="lineno"> 3511</span>&#160;    <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(<a class="code" href="../../de/db6/wavespeeds_8c.html#a89ebfcafdd16ff4aafb94363ca6da464" title="get wave speeds for flux calculation and for dt calculation">vchar_all</a>(<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(prim,i,j,k), &amp;state, dir, ptrgeom, &amp;cmax1, &amp;cmin1,&amp;ignorecourant),<span class="stringliteral">&quot;advance.c:set_dt()&quot;</span>, <span class="stringliteral">&quot;vchar_all() dir=1&quot;</span>, 1);</div>
<div class="line"><a name="l03512"></a><span class="lineno"> 3512</span>&#160;    dtij[dir] = <a class="code" href="../../d8/d5b/defs_8general_8h.html#ab95415a19b94c9c8b05a1a1d1be4ce40">cour</a> * <a class="code" href="../../d8/d5b/defs_8general_8h.html#a99b91d8e229e5df70958f2aed7fd15bf">dx</a>[dir] / <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(fabs(cmax1),fabs(cmin1));</div>
<div class="line"><a name="l03513"></a><span class="lineno"> 3513</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#a09f66feb0b682784bacf263f9dedf61d" title="whether to force dt to use velocity based upon speed of light Doesn&#39;t change how fluxes are computed!...">FORCESOLVEL</a>){</div>
<div class="line"><a name="l03514"></a><span class="lineno"> 3514</span>&#160;      dtij[dir] = <a class="code" href="../../d8/d5b/defs_8general_8h.html#ab95415a19b94c9c8b05a1a1d1be4ce40">cour</a>*<a class="code" href="../../d8/d5b/defs_8general_8h.html#a99b91d8e229e5df70958f2aed7fd15bf">dx</a>[dir]*sqrt(ptrgeom-&gt;gcov[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(dir,dir)]);</div>
<div class="line"><a name="l03515"></a><span class="lineno"> 3515</span>&#160;    }</div>
<div class="line"><a name="l03516"></a><span class="lineno"> 3516</span>&#160;    <span class="keywordflow">if</span> (dtij[dir] &lt; wavendt[dir]){</div>
<div class="line"><a name="l03517"></a><span class="lineno"> 3517</span>&#160;      wavendt[dir] = dtij[dir];</div>
<div class="line"><a name="l03518"></a><span class="lineno"> 3518</span>&#160;      wavendti[dir] = <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>;</div>
<div class="line"><a name="l03519"></a><span class="lineno"> 3519</span>&#160;      wavendtj[dir] = <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>;</div>
<div class="line"><a name="l03520"></a><span class="lineno"> 3520</span>&#160;      wavendtk[dir] = k;</div>
<div class="line"><a name="l03521"></a><span class="lineno"> 3521</span>&#160;    }</div>
<div class="line"><a name="l03522"></a><span class="lineno"> 3522</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03523"></a><span class="lineno"> 3523</span>&#160;<span class="preprocessor"></span>    </div>
<div class="line"><a name="l03524"></a><span class="lineno"> 3524</span>&#160;<span class="preprocessor">#if(N2&gt;1)</span></div>
<div class="line"><a name="l03525"></a><span class="lineno"> 3525</span>&#160;<span class="preprocessor"></span>    dir=2;</div>
<div class="line"><a name="l03526"></a><span class="lineno"> 3526</span>&#160;    <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(<a class="code" href="../../de/db6/wavespeeds_8c.html#a89ebfcafdd16ff4aafb94363ca6da464" title="get wave speeds for flux calculation and for dt calculation">vchar_all</a>(<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(prim,i,j,k), &amp;state, dir, ptrgeom, &amp;cmax2, &amp;cmin2,&amp;ignorecourant),<span class="stringliteral">&quot;advance.c:set_dt()&quot;</span>, <span class="stringliteral">&quot;vchar_all() dir=2&quot;</span>, 1);</div>
<div class="line"><a name="l03527"></a><span class="lineno"> 3527</span>&#160;    dtij[dir] = <a class="code" href="../../d8/d5b/defs_8general_8h.html#ab95415a19b94c9c8b05a1a1d1be4ce40">cour</a> * <a class="code" href="../../d8/d5b/defs_8general_8h.html#a99b91d8e229e5df70958f2aed7fd15bf">dx</a>[dir] / <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(fabs(cmax2),fabs(cmin2));</div>
<div class="line"><a name="l03528"></a><span class="lineno"> 3528</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#a09f66feb0b682784bacf263f9dedf61d" title="whether to force dt to use velocity based upon speed of light Doesn&#39;t change how fluxes are computed!...">FORCESOLVEL</a>){</div>
<div class="line"><a name="l03529"></a><span class="lineno"> 3529</span>&#160;      dtij[dir] = <a class="code" href="../../d8/d5b/defs_8general_8h.html#ab95415a19b94c9c8b05a1a1d1be4ce40">cour</a>*<a class="code" href="../../d8/d5b/defs_8general_8h.html#a99b91d8e229e5df70958f2aed7fd15bf">dx</a>[dir]*sqrt(ptrgeom-&gt;gcov[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(dir,dir)]);</div>
<div class="line"><a name="l03530"></a><span class="lineno"> 3530</span>&#160;    }</div>
<div class="line"><a name="l03531"></a><span class="lineno"> 3531</span>&#160;    <span class="keywordflow">if</span> (dtij[dir] &lt; wavendt[dir]){</div>
<div class="line"><a name="l03532"></a><span class="lineno"> 3532</span>&#160;      wavendt[dir] = dtij[dir];</div>
<div class="line"><a name="l03533"></a><span class="lineno"> 3533</span>&#160;      wavendti[dir] = <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>;</div>
<div class="line"><a name="l03534"></a><span class="lineno"> 3534</span>&#160;      wavendtj[dir] = <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>;</div>
<div class="line"><a name="l03535"></a><span class="lineno"> 3535</span>&#160;      wavendtk[dir] = k;</div>
<div class="line"><a name="l03536"></a><span class="lineno"> 3536</span>&#160;    }</div>
<div class="line"><a name="l03537"></a><span class="lineno"> 3537</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03538"></a><span class="lineno"> 3538</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l03539"></a><span class="lineno"> 3539</span>&#160;<span class="preprocessor">#if(N3&gt;1)</span></div>
<div class="line"><a name="l03540"></a><span class="lineno"> 3540</span>&#160;<span class="preprocessor"></span>    dir=3;</div>
<div class="line"><a name="l03541"></a><span class="lineno"> 3541</span>&#160;    <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(<a class="code" href="../../de/db6/wavespeeds_8c.html#a89ebfcafdd16ff4aafb94363ca6da464" title="get wave speeds for flux calculation and for dt calculation">vchar_all</a>(<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(prim,i,j,k), &amp;state, dir, ptrgeom, &amp;cmax3, &amp;cmin3,&amp;ignorecourant),<span class="stringliteral">&quot;restart.c:set_dt()&quot;</span>, <span class="stringliteral">&quot;vchar_all() dir=3&quot;</span>, 1);</div>
<div class="line"><a name="l03542"></a><span class="lineno"> 3542</span>&#160;    dtij[dir] = <a class="code" href="../../d8/d5b/defs_8general_8h.html#ab95415a19b94c9c8b05a1a1d1be4ce40">cour</a> * <a class="code" href="../../d8/d5b/defs_8general_8h.html#a99b91d8e229e5df70958f2aed7fd15bf">dx</a>[dir] / <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(fabs(cmax3),fabs(cmin3));</div>
<div class="line"><a name="l03543"></a><span class="lineno"> 3543</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#a09f66feb0b682784bacf263f9dedf61d" title="whether to force dt to use velocity based upon speed of light Doesn&#39;t change how fluxes are computed!...">FORCESOLVEL</a>){</div>
<div class="line"><a name="l03544"></a><span class="lineno"> 3544</span>&#160;      dtij[dir] = <a class="code" href="../../d8/d5b/defs_8general_8h.html#ab95415a19b94c9c8b05a1a1d1be4ce40">cour</a>*<a class="code" href="../../d8/d5b/defs_8general_8h.html#a99b91d8e229e5df70958f2aed7fd15bf">dx</a>[dir]*sqrt(ptrgeom-&gt;gcov[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(dir,dir)]);</div>
<div class="line"><a name="l03545"></a><span class="lineno"> 3545</span>&#160;    }</div>
<div class="line"><a name="l03546"></a><span class="lineno"> 3546</span>&#160;    <span class="keywordflow">if</span> (dtij[dir] &lt; wavendt[dir]){</div>
<div class="line"><a name="l03547"></a><span class="lineno"> 3547</span>&#160;      wavendt[dir] = dtij[dir];</div>
<div class="line"><a name="l03548"></a><span class="lineno"> 3548</span>&#160;      wavendti[dir] = <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>;</div>
<div class="line"><a name="l03549"></a><span class="lineno"> 3549</span>&#160;      wavendtj[dir] = <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>;</div>
<div class="line"><a name="l03550"></a><span class="lineno"> 3550</span>&#160;      wavendtk[dir] = k;</div>
<div class="line"><a name="l03551"></a><span class="lineno"> 3551</span>&#160;    }</div>
<div class="line"><a name="l03552"></a><span class="lineno"> 3552</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03553"></a><span class="lineno"> 3553</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l03554"></a><span class="lineno"> 3554</span>&#160;</div>
<div class="line"><a name="l03555"></a><span class="lineno"> 3555</span>&#160;</div>
<div class="line"><a name="l03556"></a><span class="lineno"> 3556</span>&#160;    <span class="comment">// also get PERCELLDT==1 version</span></div>
<div class="line"><a name="l03557"></a><span class="lineno"> 3557</span>&#160;    wavedttemp = <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a748444614dc4843c0b48bb5d23671554" title="for cour fixed for any dimensional problem, below makes no sense.">MINDTSET</a>(dtij[1],dtij[2],dtij[3]);</div>
<div class="line"><a name="l03558"></a><span class="lineno"> 3558</span>&#160;    <span class="keywordflow">if</span>(wavedttemp&lt;wavedt_2) wavedt_2=wavedttemp;</div>
<div class="line"><a name="l03559"></a><span class="lineno"> 3559</span>&#160;</div>
<div class="line"><a name="l03560"></a><span class="lineno"> 3560</span>&#160;</div>
<div class="line"><a name="l03561"></a><span class="lineno"> 3561</span>&#160;</div>
<div class="line"><a name="l03563"></a><span class="lineno"> 3563</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l03564"></a><span class="lineno"> 3564</span>&#160;    <span class="comment">// deal with source terms</span></div>
<div class="line"><a name="l03565"></a><span class="lineno"> 3565</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l03567"></a><span class="lineno"> 3567</span>&#160;<span class="comment"></span>    <span class="keywordflow">if</span>(<a class="code" href="../../dd/d5e/global_8loops_8diagnostics_8h.html#adce09b604562ed55df79f487e8d038e4" title="defines whether within the enerregion considered loop-related macro">WITHINENERREGION</a>(sourceenerpos,i,j,k)){</div>
<div class="line"><a name="l03568"></a><span class="lineno"> 3568</span>&#160;</div>
<div class="line"><a name="l03569"></a><span class="lineno"> 3569</span>&#160;</div>
<div class="line"><a name="l03570"></a><span class="lineno"> 3570</span>&#160;<span class="preprocessor">#if(LIMITDTWITHSOURCETERM)</span></div>
<div class="line"><a name="l03571"></a><span class="lineno"> 3571</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l03572"></a><span class="lineno"> 3572</span>&#160;      <span class="comment">// conserved quantity without geometry</span></div>
<div class="line"><a name="l03573"></a><span class="lineno"> 3573</span>&#160;      <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a9a54096e4c40a15a2c1bf74266153616" title="calculate &quot;conserved&quot; quantities">primtoU</a>(UEVOLVE, <a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(prim,i,j,k), &amp;state, ptrgeom, U, NULL),<span class="stringliteral">&quot;step_ch.c:advance()&quot;</span>, <span class="stringliteral">&quot;primtoU()&quot;</span>, 1);</div>
<div class="line"><a name="l03574"></a><span class="lineno"> 3574</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) Ugeomfree[pl] = U[pl]*(ptrgeom-&gt;<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a6d808515c6c005e51aeefb326bc04515">IEOMFUNCNOSINGMAC</a>(pl));</div>
<div class="line"><a name="l03575"></a><span class="lineno"> 3575</span>&#160;</div>
<div class="line"><a name="l03576"></a><span class="lineno"> 3576</span>&#160;      <span class="comment">// get source term</span></div>
<div class="line"><a name="l03577"></a><span class="lineno"> 3577</span>&#160;      <span class="comment">// GODMARK: here dUriemann=0, although in reality this setting of dt is related to the constraint trying to make</span></div>
<div class="line"><a name="l03578"></a><span class="lineno"> 3578</span>&#160;      <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) dUriemann[pl]=0.0;</div>
<div class="line"><a name="l03579"></a><span class="lineno"> 3579</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> CUf[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ab17e7e66eb2bc86b9d61d6bb61a0a4a3" title="NUMDTCUFS also includes what&#39;s necessary for IMEX.">NUMDTCUFS</a>]={0.0}; <span class="comment">// no update yet!</span></div>
<div class="line"><a name="l03580"></a><span class="lineno"> 3580</span>&#160;      <span class="keywordtype">int</span> timeorder=0; <span class="comment">// fake timeorder</span></div>
<div class="line"><a name="l03581"></a><span class="lineno"> 3581</span>&#160;      <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *CUimp=&amp;CUf[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a214c8d806784f513292419871af16a25">NUMPREDTCUFS</a>+timeorder];</div>
<div class="line"><a name="l03582"></a><span class="lineno"> 3582</span>&#160;      <span class="comment">// modifies prim() to be closer to final, which is ok here.</span></div>
<div class="line"><a name="l03583"></a><span class="lineno"> 3583</span>&#160;      <span class="comment">// setup default eomtype</span></div>
<div class="line"><a name="l03584"></a><span class="lineno"> 3584</span>&#160;      <span class="keywordtype">int</span> eomtype=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#aa28b06d889a02621b45edc716bfb2d01">EOMDEFAULT</a>;</div>
<div class="line"><a name="l03585"></a><span class="lineno"> 3585</span>&#160;      <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a4ebf7765a6bde079a76719b89d3033b6" title="add in source terms to equations of motion ui and dUriemann in UEVOLVE form assume q(pr) so consisten...">source</a>(<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(prim,i,j,k), <a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(prim,i,j,k), <a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(prim,i,j,k), &amp;didreturnpf, &amp;eomtype, ptrgeom, &amp;state, U, U, CUf, CUimp, 0.0, dUriemann, dUcomp, dUgeom),<span class="stringliteral">&quot;advance.c:set_dt()&quot;</span>, <span class="stringliteral">&quot;source&quot;</span>, 1);</div>
<div class="line"><a name="l03586"></a><span class="lineno"> 3586</span>&#160;</div>
<div class="line"><a name="l03587"></a><span class="lineno"> 3587</span>&#160;      <span class="comment">// get dt limit</span></div>
<div class="line"><a name="l03588"></a><span class="lineno"> 3588</span>&#160;      compute_dt_fromsource(ptrgeom,&amp;state,<a class="code" href="../../df/d1c/global_8storage_8h.html#a849d8ce0cf4a61f92340425b34ba9538">MAC</a>(prim,i,j,k), Ugeomfree, dUgeom, dUcomp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a06b1d017ed7599c17c423f4d989a8d63" title="these get ADDED UP, not independently treated number of source terms.">GEOMSOURCE</a>], &amp;tempaccdt, &amp;tempgravitydt);</div>
<div class="line"><a name="l03589"></a><span class="lineno"> 3589</span>&#160;      <span class="keywordflow">if</span>(accdt&gt;tempaccdt){</div>
<div class="line"><a name="l03590"></a><span class="lineno"> 3590</span>&#160;        accdt=tempaccdt;</div>
<div class="line"><a name="l03591"></a><span class="lineno"> 3591</span>&#160;        accdti=<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>;</div>
<div class="line"><a name="l03592"></a><span class="lineno"> 3592</span>&#160;        accdtj=<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>;</div>
<div class="line"><a name="l03593"></a><span class="lineno"> 3593</span>&#160;        accdtk=k;</div>
<div class="line"><a name="l03594"></a><span class="lineno"> 3594</span>&#160;      }</div>
<div class="line"><a name="l03595"></a><span class="lineno"> 3595</span>&#160;      <span class="keywordflow">if</span>(gravitydt&gt;tempgravitydt){</div>
<div class="line"><a name="l03596"></a><span class="lineno"> 3596</span>&#160;        gravitydt=tempgravitydt;</div>
<div class="line"><a name="l03597"></a><span class="lineno"> 3597</span>&#160;        gravitydti=<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>;</div>
<div class="line"><a name="l03598"></a><span class="lineno"> 3598</span>&#160;        gravitydtj=<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>;</div>
<div class="line"><a name="l03599"></a><span class="lineno"> 3599</span>&#160;        gravitydtk=k;</div>
<div class="line"><a name="l03600"></a><span class="lineno"> 3600</span>&#160;      }</div>
<div class="line"><a name="l03601"></a><span class="lineno"> 3601</span>&#160;</div>
<div class="line"><a name="l03602"></a><span class="lineno"> 3602</span>&#160;<span class="preprocessor">#if(0)// DEBUG</span></div>
<div class="line"><a name="l03603"></a><span class="lineno"> 3603</span>&#160;<span class="preprocessor"></span>      <span class="keywordflow">if</span>(i==-1 || i==0){</div>
<div class="line"><a name="l03604"></a><span class="lineno"> 3604</span>&#160;        dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,<span class="stringliteral">&quot;BANG: i=%d\n&quot;</span>,i);</div>
<div class="line"><a name="l03605"></a><span class="lineno"> 3605</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ad3709a52076ae713f92f3c3fe3ec9255">fail_file</a>,&quot;prim[%d]=%21.15g\n&quot;,pl,<a class="code" href="../../df/d1c/global_8storage_8h.html#a42b71f60b3fac655a8770411acf0ab62">MACP0A1</a>(prim,i,j,k,pl));</div>
<div class="line"><a name="l03606"></a><span class="lineno"> 3606</span>&#160;        <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) dualfprintf(fail_file,&quot;dUgeom[%d]=%21.15g dUcompgeomsource=%21.15g\n&quot;,pl,dUgeom[pl],dUcomp[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a06b1d017ed7599c17c423f4d989a8d63" title="these get ADDED UP, not independently treated number of source terms.">GEOMSOURCE</a>][pl]);</div>
<div class="line"><a name="l03607"></a><span class="lineno"> 3607</span>&#160;        if(i==-1){</div>
<div class="line"><a name="l03608"></a><span class="lineno"> 3608</span>&#160;          <span class="comment">// side-by-side</span></div>
<div class="line"><a name="l03609"></a><span class="lineno"> 3609</span>&#160;          <a class="code" href="../../d9/de9/coord_8c.html#a041e7b005310415c97d90f4b8521ed1a" title="get X(i,j,k) CENT is default position in degenerate cases">coord</a>(i,j,k,CENT,X);</div>
<div class="line"><a name="l03610"></a><span class="lineno"> 3610</span>&#160;          <a class="code" href="../../d9/de9/coord_8c.html#a65ad4ca9656d141cc995fd35ed31dc40" title="Returns boyer-lindquist coordinte of point.">bl_coord</a>(X,V);</div>
<div class="line"><a name="l03611"></a><span class="lineno"> 3611</span>&#160;          <a class="code" href="../../d9/de9/coord_8c.html#a041e7b005310415c97d90f4b8521ed1a" title="get X(i,j,k) CENT is default position in degenerate cases">coord</a>(<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a27e1e0a92af691ffd03d7e9d0a628392">ip1mac</a>(i),j,k,CENT,X);</div>
<div class="line"><a name="l03612"></a><span class="lineno"> 3612</span>&#160;          <a class="code" href="../../d9/de9/coord_8c.html#a65ad4ca9656d141cc995fd35ed31dc40" title="Returns boyer-lindquist coordinte of point.">bl_coord</a>(X,Vp1);</div>
<div class="line"><a name="l03613"></a><span class="lineno"> 3613</span>&#160;          dualfprintf(fail_file,<span class="stringliteral">&quot;r(i=-1)=%21.15g r(i=0)=%21.15g\n&quot;</span>,V[1],Vp1[1]);</div>
<div class="line"><a name="l03614"></a><span class="lineno"> 3614</span>&#160;          dualfprintf(fail_file,<span class="stringliteral">&quot;gdet(i=-1)=%21.15g gdet(i=0)=%21.15g\n&quot;</span>,<a class="code" href="../../df/d1c/global_8storage_8h.html#ac4eaa3d655bb85afeb57a11eebbd55cd">GLOBALMETMACP1A0</a>(<a class="code" href="../../dc/dd2/newcodediff_8txt.html#a597ef3c829c23db3a2637f8b3aefe240">gdet</a>,CENT,i,j,k),<a class="code" href="../../df/d1c/global_8storage_8h.html#ac4eaa3d655bb85afeb57a11eebbd55cd">GLOBALMETMACP1A0</a>(<a class="code" href="../../dc/dd2/newcodediff_8txt.html#a597ef3c829c23db3a2637f8b3aefe240">gdet</a>,CENT,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a27e1e0a92af691ffd03d7e9d0a628392">ip1mac</a>(i),j,k));</div>
<div class="line"><a name="l03615"></a><span class="lineno"> 3615</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a59b7ef1517ff22fd4dfce4cf6d380c55" title="loop over all Dimensions; second rank loop">DLOOP</a>(jj,kk) dualfprintf(fail_file,&quot;%d %d <a class="code" href="../../dc/dd2/newcodediff_8txt.html#a93300df7bd864b90cc8ed9f3d96515ad">gcov</a>(i=-1)=%21.15g <a class="code" href="../../dc/dd2/newcodediff_8txt.html#a93300df7bd864b90cc8ed9f3d96515ad">gcov</a>(i=0)=%21.15g\n&quot;,jj,kk,<a class="code" href="../../df/d1c/global_8storage_8h.html#a8c27ba787d80fbfe0fe30ade21ad5c0c">GLOBALMETMACP1A2</a>(<a class="code" href="../../dc/dd2/newcodediff_8txt.html#a93300df7bd864b90cc8ed9f3d96515ad">gcov</a>,CENT,i,j,k,jj,kk),<a class="code" href="../../df/d1c/global_8storage_8h.html#a8c27ba787d80fbfe0fe30ade21ad5c0c">GLOBALMETMACP1A2</a>(gcov,CENT,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a27e1e0a92af691ffd03d7e9d0a628392">ip1mac</a>(i),j,k,jj,kk));</div>
<div class="line"><a name="l03616"></a><span class="lineno"> 3616</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a59b7ef1517ff22fd4dfce4cf6d380c55" title="loop over all Dimensions; second rank loop">DLOOP</a>(jj,kk) dualfprintf(fail_file,&quot;%d %d gcovlast(i=-1)=%21.15g gcovlast(i=0)=%21.15g\n&quot;,jj,kk,<a class="code" href="../../df/d1c/global_8storage_8h.html#a8c27ba787d80fbfe0fe30ade21ad5c0c">GLOBALMETMACP1A2</a>(gcovlast,CENT,i,j,k,jj,kk),<a class="code" href="../../df/d1c/global_8storage_8h.html#a8c27ba787d80fbfe0fe30ade21ad5c0c">GLOBALMETMACP1A2</a>(gcovlast,CENT,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a27e1e0a92af691ffd03d7e9d0a628392">ip1mac</a>(i),j,k,jj,kk));</div>
<div class="line"><a name="l03617"></a><span class="lineno"> 3617</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a59b7ef1517ff22fd4dfce4cf6d380c55" title="loop over all Dimensions; second rank loop">DLOOP</a>(jj,kk) dualfprintf(fail_file,&quot;%d %d <a class="code" href="../../dc/dd2/newcodediff_8txt.html#a98399a5a291e3844900ecfbacdcb2da0">gcon</a>(i=-1)=%21.15g <a class="code" href="../../dc/dd2/newcodediff_8txt.html#a98399a5a291e3844900ecfbacdcb2da0">gcon</a>(i=0)=%21.15g\n&quot;,jj,kk,<a class="code" href="../../df/d1c/global_8storage_8h.html#a8c27ba787d80fbfe0fe30ade21ad5c0c">GLOBALMETMACP1A2</a>(<a class="code" href="../../dc/dd2/newcodediff_8txt.html#a98399a5a291e3844900ecfbacdcb2da0">gcon</a>,CENT,i,j,k,jj,kk),<a class="code" href="../../df/d1c/global_8storage_8h.html#a8c27ba787d80fbfe0fe30ade21ad5c0c">GLOBALMETMACP1A2</a>(gcon,CENT,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a27e1e0a92af691ffd03d7e9d0a628392">ip1mac</a>(i),j,k,jj,kk));</div>
<div class="line"><a name="l03618"></a><span class="lineno"> 3618</span>&#160;          <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a59b7ef1517ff22fd4dfce4cf6d380c55" title="loop over all Dimensions; second rank loop">DLOOP</a>(jj,kk) <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(ll) dualfprintf(fail_file,&quot;%d %d %d <a class="code" href="../../dc/dd2/newcodediff_8txt.html#a03bab59595551d88dd24b0f83a7b7517">conn</a>(i=-1)=%21.15g <a class="code" href="../../dc/dd2/newcodediff_8txt.html#a03bab59595551d88dd24b0f83a7b7517">conn</a>(i=0)=%21.15g\n&quot;,jj,kk,ll,<a class="code" href="../../df/d1c/global_8storage_8h.html#a2476676a88475196fe46751cda7b35f1">GLOBALMETMACP0A3</a>(<a class="code" href="../../dc/dd2/newcodediff_8txt.html#a03bab59595551d88dd24b0f83a7b7517">conn</a>,i,j,k,jj,kk,ll),<a class="code" href="../../df/d1c/global_8storage_8h.html#a2476676a88475196fe46751cda7b35f1">GLOBALMETMACP0A3</a>(conn,<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a27e1e0a92af691ffd03d7e9d0a628392">ip1mac</a>(i),j,k,jj,kk,ll));</div>
<div class="line"><a name="l03619"></a><span class="lineno"> 3619</span>&#160;        }</div>
<div class="line"><a name="l03620"></a><span class="lineno"> 3620</span>&#160;      }</div>
<div class="line"><a name="l03621"></a><span class="lineno"> 3621</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03622"></a><span class="lineno"> 3622</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l03623"></a><span class="lineno"> 3623</span>&#160;</div>
<div class="line"><a name="l03624"></a><span class="lineno"> 3624</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03625"></a><span class="lineno"> 3625</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l03626"></a><span class="lineno"> 3626</span>&#160;</div>
<div class="line"><a name="l03627"></a><span class="lineno"> 3627</span>&#160;    } <span class="comment">// end if within source enerregion</span></div>
<div class="line"><a name="l03628"></a><span class="lineno"> 3628</span>&#160;</div>
<div class="line"><a name="l03629"></a><span class="lineno"> 3629</span>&#160;  } <span class="comment">// end of loop</span></div>
<div class="line"><a name="l03630"></a><span class="lineno"> 3630</span>&#160;</div>
<div class="line"><a name="l03631"></a><span class="lineno"> 3631</span>&#160;</div>
<div class="line"><a name="l03632"></a><span class="lineno"> 3632</span>&#160;</div>
<div class="line"><a name="l03633"></a><span class="lineno"> 3633</span>&#160;</div>
<div class="line"><a name="l03634"></a><span class="lineno"> 3634</span>&#160;</div>
<div class="line"><a name="l03635"></a><span class="lineno"> 3635</span>&#160;</div>
<div class="line"><a name="l03636"></a><span class="lineno"> 3636</span>&#160;    <span class="comment">// GODMARK: note that in normal advance, wavendt[i] is over each CPU region and wavedt computed for each CPU and then minimized over all CPUs -- so not perfectly consistent with MPI</span></div>
<div class="line"><a name="l03637"></a><span class="lineno"> 3637</span>&#160;    <span class="comment">// here we preserve perfect MPI domain decomposition</span></div>
<div class="line"><a name="l03638"></a><span class="lineno"> 3638</span>&#160;  mpifmin(&amp;wavendt[1]);</div>
<div class="line"><a name="l03639"></a><span class="lineno"> 3639</span>&#160;  mpifmin(&amp;wavendt[2]);</div>
<div class="line"><a name="l03640"></a><span class="lineno"> 3640</span>&#160;  mpifmin(&amp;wavendt[3]);</div>
<div class="line"><a name="l03641"></a><span class="lineno"> 3641</span>&#160;  <span class="comment">// single all-CPU wavedt for PERCELLDT==0 version</span></div>
<div class="line"><a name="l03642"></a><span class="lineno"> 3642</span>&#160;  wavedt_1 = <a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a748444614dc4843c0b48bb5d23671554" title="for cour fixed for any dimensional problem, below makes no sense.">MINDTSET</a>(wavendt[1],wavendt[2],wavendt[3]); <span class="comment">// wavendt[i] is over entire region for each i</span></div>
<div class="line"><a name="l03643"></a><span class="lineno"> 3643</span>&#160;</div>
<div class="line"><a name="l03644"></a><span class="lineno"> 3644</span>&#160;  <span class="comment">// minimize per-cell dt over all CPUs for PERCELLDT==1 version</span></div>
<div class="line"><a name="l03645"></a><span class="lineno"> 3645</span>&#160;  mpifmin(&amp;wavedt_2);</div>
<div class="line"><a name="l03646"></a><span class="lineno"> 3646</span>&#160;</div>
<div class="line"><a name="l03647"></a><span class="lineno"> 3647</span>&#160;  <span class="comment">// get actual version to use</span></div>
<div class="line"><a name="l03648"></a><span class="lineno"> 3648</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../da/d3e/definit_8h.html#aa1449a3fdd665da411ee53a6d886e770" title="whether to compute per cell $dt$ by storing $dt$ per dimension and then computing minimum per cell ra...">PERCELLDT</a>==0) wavedt=wavedt_1;</div>
<div class="line"><a name="l03649"></a><span class="lineno"> 3649</span>&#160;  <span class="keywordflow">else</span> wavedt=wavedt_2;</div>
<div class="line"><a name="l03650"></a><span class="lineno"> 3650</span>&#160;</div>
<div class="line"><a name="l03651"></a><span class="lineno"> 3651</span>&#160;  <span class="comment">// single all-CPU accdt and gravitydt</span></div>
<div class="line"><a name="l03652"></a><span class="lineno"> 3652</span>&#160;  mpifmin(&amp;accdt);</div>
<div class="line"><a name="l03653"></a><span class="lineno"> 3653</span>&#160;  mpifmin(&amp;gravitydt);</div>
<div class="line"><a name="l03654"></a><span class="lineno"> 3654</span>&#160;</div>
<div class="line"><a name="l03655"></a><span class="lineno"> 3655</span>&#160;  <a class="code" href="../../d8/d5b/defs_8general_8h.html#a0e73706eb0db019d8fa67c66f41d93d6">wavedtglobal</a>=wavedt;</div>
<div class="line"><a name="l03656"></a><span class="lineno"> 3656</span>&#160;  <a class="code" href="../../d8/d5b/defs_8general_8h.html#a0a7150593e8f78afd7a91cfb19edab08">sourcedtglobal</a>=accdt;</div>
<div class="line"><a name="l03657"></a><span class="lineno"> 3657</span>&#160;  <a class="code" href="../../d8/d5b/defs_8general_8h.html#ae58178ca76ba1f6fd135877e28ca1409">gravitydtglobal</a>=gravitydt;</div>
<div class="line"><a name="l03658"></a><span class="lineno"> 3658</span>&#160;</div>
<div class="line"><a name="l03659"></a><span class="lineno"> 3659</span>&#160;</div>
<div class="line"><a name="l03660"></a><span class="lineno"> 3660</span>&#160;  <span class="comment">// find global minimum value of wavendt over all cpus</span></div>
<div class="line"><a name="l03661"></a><span class="lineno"> 3661</span>&#160;  ndtfinal=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(wavedt,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(accdt,gravitydt));</div>
<div class="line"><a name="l03662"></a><span class="lineno"> 3662</span>&#160;</div>
<div class="line"><a name="l03663"></a><span class="lineno"> 3663</span>&#160;<span class="preprocessor">#if(1)</span></div>
<div class="line"><a name="l03664"></a><span class="lineno"> 3664</span>&#160;<span class="preprocessor"></span>  <span class="comment">// below single line only right if 1-CPU</span></div>
<div class="line"><a name="l03665"></a><span class="lineno"> 3665</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj) dualfprintf(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ab936051f5aaca44c6c3c41dee0d19c36">log_file</a>,&quot;dtij[%d]=%21.15g wavendti=%d wavendtj=%d wavendtk=%d\n&quot;,jj,wavendt[jj],wavendti[jj],wavendtj[jj],wavendtk[jj]);</div>
<div class="line"><a name="l03666"></a><span class="lineno"> 3666</span>&#160;  dualfprintf(log_file,&quot;wavedt_1=%21.15g wavedt_2=%21.15g\n&quot;,wavedt_1,wavedt_2); <span class="comment">// report this so can compare PERCELLDT==0 vs. 1 at least when starting or restarting runs</span></div>
<div class="line"><a name="l03667"></a><span class="lineno"> 3667</span>&#160;  dualfprintf(log_file,&quot;ndtfinal=%21.15g wavedt=%21.15g accdt=%21.15g gravitydt=%21.15g\n&quot;,ndtfinal,wavedt,accdt,gravitydt); </div>
<div class="line"><a name="l03668"></a><span class="lineno"> 3668</span>&#160;  dualfprintf(log_file,&quot;accdti=%d accdtj=%d accdtk=%d :: gravitydti=%d  gravitydtj=%d  gravitydtk=%d\n&quot;,accdti,accdtj,accdtk,gravitydti,gravitydtj,gravitydtk);</div>
<div class="line"><a name="l03669"></a><span class="lineno"> 3669</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03670"></a><span class="lineno"> 3670</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l03671"></a><span class="lineno"> 3671</span>&#160;  *dt = ndtfinal;</div>
<div class="line"><a name="l03672"></a><span class="lineno"> 3672</span>&#160;</div>
<div class="line"><a name="l03673"></a><span class="lineno"> 3673</span>&#160;</div>
<div class="line"><a name="l03674"></a><span class="lineno"> 3674</span>&#160;  <span class="comment">// don&#39;t step beyond end of run</span></div>
<div class="line"><a name="l03675"></a><span class="lineno"> 3675</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5b/defs_8general_8h.html#ae1ee1e1c83c3f70e2e1afed4f4f5b41e">t</a> + *dt &gt; <a class="code" href="../../d8/d5b/defs_8general_8h.html#a19a363a93267c97a3d521293fc39d942">tf</a>) *dt = <a class="code" href="../../d8/d5b/defs_8general_8h.html#a19a363a93267c97a3d521293fc39d942">tf</a> - <a class="code" href="../../d8/d5b/defs_8general_8h.html#ae1ee1e1c83c3f70e2e1afed4f4f5b41e">t</a>;</div>
<div class="line"><a name="l03676"></a><span class="lineno"> 3676</span>&#160;  </div>
<div class="line"><a name="l03677"></a><span class="lineno"> 3677</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l03678"></a><span class="lineno"> 3678</span>&#160;}</div>
<div class="line"><a name="l03679"></a><span class="lineno"> 3679</span>&#160;</div>
<div class="line"><a name="l03680"></a><span class="lineno"> 3680</span>&#160;</div>
<div class="line"><a name="l03681"></a><span class="lineno"> 3681</span>&#160;<span class="comment">// 0.5 not good enough for pressureless collapse</span></div>
<div class="line"><a name="l03682"></a><span class="lineno"> 3682</span>&#160;<span class="comment">// normal cour=0.8/4 works for presureless collapse for longsteps, so use 0.1 to be safe since rarely gravity conquers timestep</span></div>
<div class="line"><a name="l03683"></a><span class="lineno"> 3683</span>&#160;<span class="comment">// but cour=0.8 and GRAVITYCOUR = 0.1 doesn&#39;t even work for longsteps!</span></div>
<div class="line"><a name="l03684"></a><span class="lineno"><a class="code" href="../../df/d22/advance_8c.html#aee532ee6b3b6f97488c944cd5aebc695"> 3684</a></span>&#160;<span class="preprocessor">#define GRAVITYCOUR (0.1)</span></div>
<div class="line"><a name="l03685"></a><span class="lineno"> 3685</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l03687"></a><span class="lineno"> 3687</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> compute_dt_fromsource(<span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *state, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *U, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *dUevolvedt, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *dUgeomevolvedt, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *dtij, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *gravitydt)</div>
<div class="line"><a name="l03688"></a><span class="lineno"> 3688</span>&#160;{</div>
<div class="line"><a name="l03689"></a><span class="lineno"> 3689</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dUevolve[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>],dUgeomevolve[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l03690"></a><span class="lineno"> 3690</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dUd[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>],dUu[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l03691"></a><span class="lineno"> 3691</span>&#160;  <span class="keywordtype">int</span> jj,kk;</div>
<div class="line"><a name="l03692"></a><span class="lineno"> 3692</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> rhoprime[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l03693"></a><span class="lineno"> 3693</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> ag[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>],dtsource[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l03694"></a><span class="lineno"> 3694</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> rho,u,P,bsq,w,eta;</div>
<div class="line"><a name="l03695"></a><span class="lineno"> 3695</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> mydU[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l03696"></a><span class="lineno"> 3696</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> mydUdtgravity, rhoprimegravity, aggravity;</div>
<div class="line"><a name="l03697"></a><span class="lineno"> 3697</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> frac;</div>
<div class="line"><a name="l03698"></a><span class="lineno"> 3698</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#ad21ff679aac3fe28202c6d592eafd3e6">i</a>,<a class="code" href="../../d0/ddc/datadesc__mb09_8txt.html#a89e3d6451dccc75ffa4e5f4e6e774b69">j</a>,k,loc;</div>
<div class="line"><a name="l03699"></a><span class="lineno"> 3699</span>&#160;  <span class="keyword">extern</span> <span class="keywordtype">void</span> compute_dr(<span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *dr);</div>
<div class="line"><a name="l03700"></a><span class="lineno"> 3700</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dr,dphidt,phi,tempdt;</div>
<div class="line"><a name="l03701"></a><span class="lineno"> 3701</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> veleff;</div>
<div class="line"><a name="l03702"></a><span class="lineno"> 3702</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> v1max,v1min;</div>
<div class="line"><a name="l03703"></a><span class="lineno"> 3703</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> mydx[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>];</div>
<div class="line"><a name="l03704"></a><span class="lineno"> 3704</span>&#160;</div>
<div class="line"><a name="l03705"></a><span class="lineno"> 3705</span>&#160;</div>
<div class="line"><a name="l03706"></a><span class="lineno"> 3706</span>&#160;  i=ptrgeom-&gt;i;</div>
<div class="line"><a name="l03707"></a><span class="lineno"> 3707</span>&#160;  j=ptrgeom-&gt;j;</div>
<div class="line"><a name="l03708"></a><span class="lineno"> 3708</span>&#160;  k=ptrgeom-&gt;k;</div>
<div class="line"><a name="l03709"></a><span class="lineno"> 3709</span>&#160;  loc=ptrgeom-&gt;p;</div>
<div class="line"><a name="l03710"></a><span class="lineno"> 3710</span>&#160;</div>
<div class="line"><a name="l03711"></a><span class="lineno"> 3711</span>&#160;  <span class="comment">// default is no limit on dt due to flux differential or source terms</span></div>
<div class="line"><a name="l03712"></a><span class="lineno"> 3712</span>&#160;  *dtij=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>;</div>
<div class="line"><a name="l03713"></a><span class="lineno"> 3713</span>&#160;  <span class="comment">// default is no limit due to time-dependence of gravity</span></div>
<div class="line"><a name="l03714"></a><span class="lineno"> 3714</span>&#160;  *gravitydt=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a38eb76aa0a9a1bb1dac30c75be4a05b6">BIG</a>;</div>
<div class="line"><a name="l03715"></a><span class="lineno"> 3715</span>&#160;</div>
<div class="line"><a name="l03716"></a><span class="lineno"> 3716</span>&#160;</div>
<div class="line"><a name="l03717"></a><span class="lineno"> 3717</span>&#160;  <span class="comment">// convert from dU/dt to dU</span></div>
<div class="line"><a name="l03718"></a><span class="lineno"> 3718</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj){</div>
<div class="line"><a name="l03719"></a><span class="lineno"> 3719</span>&#160;    dUevolve[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>+jj] = dUevolvedt[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>+jj]*<a class="code" href="../../d8/d5b/defs_8general_8h.html#a56db625f31229c5e8b208ff27d464931">dt</a>;</div>
<div class="line"><a name="l03720"></a><span class="lineno"> 3720</span>&#160;    dUgeomevolve[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>+jj] = dUgeomevolvedt[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>+jj]*<a class="code" href="../../d8/d5b/defs_8general_8h.html#a56db625f31229c5e8b208ff27d464931">dt</a>;</div>
<div class="line"><a name="l03721"></a><span class="lineno"> 3721</span>&#160;  }</div>
<div class="line"><a name="l03722"></a><span class="lineno"> 3722</span>&#160;</div>
<div class="line"><a name="l03723"></a><span class="lineno"> 3723</span>&#160;</div>
<div class="line"><a name="l03724"></a><span class="lineno"> 3724</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj){</div>
<div class="line"><a name="l03725"></a><span class="lineno"> 3725</span>&#160;    dUd[jj]=dUevolve[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>+jj]*(ptrgeom-&gt;IEOMFUNCNOSINGMAC(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>+jj)); <span class="comment">// remove geometry</span></div>
<div class="line"><a name="l03726"></a><span class="lineno"> 3726</span>&#160;  }</div>
<div class="line"><a name="l03727"></a><span class="lineno"> 3727</span>&#160;  raise_vec(dUd,ptrgeom,dUu);</div>
<div class="line"><a name="l03728"></a><span class="lineno"> 3728</span>&#160;</div>
<div class="line"><a name="l03729"></a><span class="lineno"> 3729</span>&#160;  <span class="comment">// comparing time update with time value, so keep lower as conserved quantity</span></div>
<div class="line"><a name="l03730"></a><span class="lineno"> 3730</span>&#160;  mydU[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>]=dUd[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>];</div>
<div class="line"><a name="l03731"></a><span class="lineno"> 3731</span>&#160;  mydUdtgravity = dUgeomevolvedt[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]*(ptrgeom-&gt;IEOMFUNCNOSINGMAC(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>)); <span class="comment">// pure gravity piece</span></div>
<div class="line"><a name="l03732"></a><span class="lineno"> 3732</span>&#160;</div>
<div class="line"><a name="l03733"></a><span class="lineno"> 3733</span>&#160;  mydx[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>]=<a class="code" href="../../d8/d5b/defs_8general_8h.html#a56db625f31229c5e8b208ff27d464931">dt</a>; <span class="comment">// so in the end dt_time &lt;=C*dt/(dU/rhoprime)</span></div>
<div class="line"><a name="l03734"></a><span class="lineno"> 3734</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#aa97638a87093a4efe2bece0de87093cc" title="loop over all Space dimensions; first rank loop">SLOOPA</a>(jj){</div>
<div class="line"><a name="l03735"></a><span class="lineno"> 3735</span>&#160;    <span class="comment">// treating momentum update as giving dv^i, so for getting Courant condition of moving across grid, need upper</span></div>
<div class="line"><a name="l03736"></a><span class="lineno"> 3736</span>&#160;    mydU[jj] = dUu[jj];</div>
<div class="line"><a name="l03737"></a><span class="lineno"> 3737</span>&#160;    mydx[jj] = <a class="code" href="../../d8/d5b/defs_8general_8h.html#a99b91d8e229e5df70958f2aed7fd15bf">dx</a>[jj];</div>
<div class="line"><a name="l03738"></a><span class="lineno"> 3738</span>&#160;  }</div>
<div class="line"><a name="l03739"></a><span class="lineno"> 3739</span>&#160;    </div>
<div class="line"><a name="l03740"></a><span class="lineno"> 3740</span>&#160;</div>
<div class="line"><a name="l03741"></a><span class="lineno"> 3741</span>&#160;  bsq = <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a7aac0a38641f2d6b53549677fa052a79">dot</a>(state-&gt;<a class="code" href="../../d1/d83/structof__state.html#a9a5aa459c68ba51073dd9a245c1a7798">bcon</a>, state-&gt;<a class="code" href="../../d1/d83/structof__state.html#a60ad0baeb54ce3584309ba5567a72f41">bcov</a>);</div>
<div class="line"><a name="l03742"></a><span class="lineno"> 3742</span>&#160;  rho=pr[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>];</div>
<div class="line"><a name="l03743"></a><span class="lineno"> 3743</span>&#160;  u=pr[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>];</div>
<div class="line"><a name="l03744"></a><span class="lineno"> 3744</span>&#160;  P=pressure_rho0_u_simple(i,j,k,loc,rho,u);</div>
<div class="line"><a name="l03745"></a><span class="lineno"> 3745</span>&#160;  w = rho+u+P;</div>
<div class="line"><a name="l03746"></a><span class="lineno"> 3746</span>&#160;  eta = w+bsq;</div>
<div class="line"><a name="l03747"></a><span class="lineno"> 3747</span>&#160;</div>
<div class="line"><a name="l03748"></a><span class="lineno"> 3748</span>&#160;</div>
<div class="line"><a name="l03749"></a><span class="lineno"> 3749</span>&#160;</div>
<div class="line"><a name="l03750"></a><span class="lineno"> 3750</span>&#160;</div>
<div class="line"><a name="l03751"></a><span class="lineno"> 3751</span>&#160;</div>
<div class="line"><a name="l03753"></a><span class="lineno"> 3753</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l03754"></a><span class="lineno"> 3754</span>&#160;  <span class="comment">// New method for dealing with source terms</span></div>
<div class="line"><a name="l03755"></a><span class="lineno"> 3755</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l03757"></a><span class="lineno"> 3757</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03758"></a><span class="lineno"> 3758</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj){</div>
<div class="line"><a name="l03759"></a><span class="lineno"> 3759</span>&#160;    <span class="comment">// U[UU] is like eta but with \gamma^2 factors that are present in the momentum terms</span></div>
<div class="line"><a name="l03760"></a><span class="lineno"> 3760</span>&#160;    <span class="comment">// account for geometry prefactor of conserved quantities and put in geometry consistent with source term</span></div>
<div class="line"><a name="l03761"></a><span class="lineno"> 3761</span>&#160;    <span class="comment">// U[UU] \sim eta \gamma^2 when neglecting stress terms</span></div>
<div class="line"><a name="l03762"></a><span class="lineno"> 3762</span>&#160;    <span class="comment">// GODMARK: Might want to be more careful like in utoprim_jon.c in how normalize errors</span></div>
<div class="line"><a name="l03763"></a><span class="lineno"> 3763</span>&#160;    <span class="comment">// GODMARK: Consider REMOVERESTMASSFROMUU==2 effects</span></div>
<div class="line"><a name="l03764"></a><span class="lineno"> 3764</span>&#160;    rhoprime[jj]=<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(fabs(eta),fabs(U[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]));</div>
<div class="line"><a name="l03765"></a><span class="lineno"> 3765</span>&#160;</div>
<div class="line"><a name="l03766"></a><span class="lineno"> 3766</span>&#160;    <span class="comment">// update to 3-velocity v^i is approximately due to this acceleration</span></div>
<div class="line"><a name="l03767"></a><span class="lineno"> 3767</span>&#160;    <span class="comment">// ag^j \sim (\rho\gamma^2 v^i)/(\rho\gamma^2) \sim dv^i/dt</span></div>
<div class="line"><a name="l03768"></a><span class="lineno"> 3768</span>&#160;    <span class="comment">// below is really = acceleration * dt</span></div>
<div class="line"><a name="l03769"></a><span class="lineno"> 3769</span>&#160;    ag[jj]=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a09c78d2f8feb311dd9fc969a0bf84979">SMALL</a>+fabs(mydU[jj]/rhoprime[jj]); <span class="comment">// acceleration.  SMALL is so doesn&#39;t identically vanish and we get nan below</span></div>
<div class="line"><a name="l03770"></a><span class="lineno"> 3770</span>&#160;</div>
<div class="line"><a name="l03771"></a><span class="lineno"> 3771</span>&#160;    <span class="comment">// for time, idea is to keep d\rho/\rho\lesssim cour, so dtnew = dtold *\rho/d\rho = dtold/ag[TT]</span></div>
<div class="line"><a name="l03772"></a><span class="lineno"> 3772</span>&#160;    <span class="keywordflow">if</span>(jj==<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>) dtsource[jj]=<a class="code" href="../../d8/d5b/defs_8general_8h.html#ab95415a19b94c9c8b05a1a1d1be4ce40">cour</a>*(mydx[jj]/ag[jj]);</div>
<div class="line"><a name="l03773"></a><span class="lineno"> 3773</span>&#160;    <span class="comment">// dt = dx/ag since ag is really  = dv^i = dx^i/dt</span></div>
<div class="line"><a name="l03774"></a><span class="lineno"> 3774</span>&#160;    <span class="keywordflow">else</span> dtsource[jj]=<a class="code" href="../../d8/d5b/defs_8general_8h.html#ab95415a19b94c9c8b05a1a1d1be4ce40">cour</a>*(mydx[jj]/ag[jj]); <span class="comment">// characteristic time-step for increasing velocity so mass would cross a grid</span></div>
<div class="line"><a name="l03775"></a><span class="lineno"> 3775</span>&#160;      </div>
<div class="line"><a name="l03776"></a><span class="lineno"> 3776</span>&#160;  }</div>
<div class="line"><a name="l03777"></a><span class="lineno"> 3777</span>&#160;</div>
<div class="line"><a name="l03778"></a><span class="lineno"> 3778</span>&#160;</div>
<div class="line"><a name="l03779"></a><span class="lineno"> 3779</span>&#160;</div>
<div class="line"><a name="l03780"></a><span class="lineno"> 3780</span>&#160;</div>
<div class="line"><a name="l03782"></a><span class="lineno"> 3782</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l03783"></a><span class="lineno"> 3783</span>&#160;  <span class="comment">// Self-gravity</span></div>
<div class="line"><a name="l03784"></a><span class="lineno"> 3784</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l03786"></a><span class="lineno"> 3786</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03787"></a><span class="lineno"> 3787</span>&#160;<span class="preprocessor">#if(DOSELFGRAVVSR)</span></div>
<div class="line"><a name="l03788"></a><span class="lineno"> 3788</span>&#160;<span class="preprocessor"></span>  <span class="comment">// make sure metric is not varying too fast</span></div>
<div class="line"><a name="l03789"></a><span class="lineno"> 3789</span>&#160;  <span class="comment">// just look at perturbed part of g_{tt} -- an invariant in stationary metrics, so good indicator of gauge-invariant time-dependence of metric</span></div>
<div class="line"><a name="l03790"></a><span class="lineno"> 3790</span>&#160;  <span class="comment">// only look at loc=CENT since others should be similar to order unity -- also CENT won&#39;t diverge at r=0</span></div>
<div class="line"><a name="l03791"></a><span class="lineno"> 3791</span>&#160;  <span class="comment">//  frac = (METMACP1A1(gcovpertlast,CENT,i,j,k,TT) - METMACP1A1(gcovpert,CENT,i,j,k,TT))/(fabs(METMACP1A1(gcovpertlast,CENT,i,j,k,TT)) + fabs(METMACP1A1(gcovpert,CENT,i,j,k,TT)));</span></div>
<div class="line"><a name="l03792"></a><span class="lineno"> 3792</span>&#160;  <span class="comment">// above frac has no dt, so no measure of what dt should be</span></div>
<div class="line"><a name="l03793"></a><span class="lineno"> 3793</span>&#160;</div>
<div class="line"><a name="l03794"></a><span class="lineno"> 3794</span>&#160;  <span class="comment">// \Gamma^t_{tt} measures dg_{tt}/dt</span></div>
<div class="line"><a name="l03795"></a><span class="lineno"> 3795</span>&#160;  <span class="comment">// \Gamma^t_{tt} \approx g_{tt},t g^{tt}  so that g_{tt},t = \Gamma^t_{tt}/g^{tt}</span></div>
<div class="line"><a name="l03796"></a><span class="lineno"> 3796</span>&#160;  <span class="comment">// now form same construct as with (dU/dt)/U as above</span></div>
<div class="line"><a name="l03797"></a><span class="lineno"> 3797</span>&#160;  <span class="comment">// g^{tt} can&#39;t go to 0 unless in bad coordinate system (BL-coords on horizon)</span></div>
<div class="line"><a name="l03798"></a><span class="lineno"> 3798</span>&#160;  <span class="comment">// frac is approximately g_{tt},t/g^{tt} \aprox 1/dt</span></div>
<div class="line"><a name="l03799"></a><span class="lineno"> 3799</span>&#160;  <span class="comment">// GODMARK: below might be problem in non-relativistic case</span></div>
<div class="line"><a name="l03800"></a><span class="lineno"> 3800</span>&#160;</div>
<div class="line"><a name="l03801"></a><span class="lineno"> 3801</span>&#160;</div>
<div class="line"><a name="l03802"></a><span class="lineno"> 3802</span>&#160;</div>
<div class="line"><a name="l03803"></a><span class="lineno"> 3803</span>&#160;  <span class="comment">// get \Gamma_{ttt} = dphi/dt ~ 1/2 g_{tt,t}</span></div>
<div class="line"><a name="l03804"></a><span class="lineno"> 3804</span>&#160;  dphidt=0.0;</div>
<div class="line"><a name="l03805"></a><span class="lineno"> 3805</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#a5f53c1711297fb7345342298fa31396f" title="loop over all Dimensions; first rank loop">DLOOPA</a>(jj) dphidt += <a class="code" href="../../df/d1c/global_8storage_8h.html#a2476676a88475196fe46751cda7b35f1">GLOBALMETMACP0A3</a>(<a class="code" href="../../dc/dd2/newcodediff_8txt.html#a03bab59595551d88dd24b0f83a7b7517">conn</a>,i,j,k,jj,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>)*(ptrgeom-&gt;gcov[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(jj,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>)]);</div>
<div class="line"><a name="l03806"></a><span class="lineno"> 3806</span>&#160;  dphidt = fabs(dphidt); <span class="comment">// don&#39;t care about sign, just magnitude</span></div>
<div class="line"><a name="l03807"></a><span class="lineno"> 3807</span>&#160;</div>
<div class="line"><a name="l03808"></a><span class="lineno"> 3808</span>&#160;  <span class="comment">// get \phi ~ -(g_{tt} +1)/2</span></div>
<div class="line"><a name="l03809"></a><span class="lineno"> 3809</span>&#160;  <span class="comment">// phi by itself has no meaning, but as a reference for changes in phi in time it does</span></div>
<div class="line"><a name="l03810"></a><span class="lineno"> 3810</span>&#160;  phi = -(1.0+ptrgeom-&gt;gcov[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>)])*0.5;</div>
<div class="line"><a name="l03811"></a><span class="lineno"> 3811</span>&#160;  phi = fabs(phi); <span class="comment">// sign not important</span></div>
<div class="line"><a name="l03812"></a><span class="lineno"> 3812</span>&#160;</div>
<div class="line"><a name="l03813"></a><span class="lineno"> 3813</span>&#160;<span class="preprocessor">#if(0)</span></div>
<div class="line"><a name="l03814"></a><span class="lineno"> 3814</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l03815"></a><span class="lineno"> 3815</span>&#160;  <span class="comment">// treat dt ~ \phi / (d\phi/dt)</span></div>
<div class="line"><a name="l03816"></a><span class="lineno"> 3816</span>&#160;  <span class="comment">//  frac = fabs(GLOBALMETMACP0A3(conn,i,j,k,TT,TT,TT)/((1+GLOBALMETMACP1A2(gcon,CENT,i,j,k,TT,TT))*(1+GLOBALMETMACP1A2(gcon,CENT,i,j,k,TT,TT))));</span></div>
<div class="line"><a name="l03817"></a><span class="lineno"> 3817</span>&#160;  frac = fabs(dphidt/phi);</div>
<div class="line"><a name="l03818"></a><span class="lineno"> 3818</span>&#160;  *gravitydt = <a class="code" href="../../d8/d5b/defs_8general_8h.html#ab95415a19b94c9c8b05a1a1d1be4ce40">cour</a>*(<a class="code" href="../../df/d22/advance_8c.html#aee532ee6b3b6f97488c944cd5aebc695">GRAVITYCOUR</a>/frac);</div>
<div class="line"><a name="l03819"></a><span class="lineno"> 3819</span>&#160;  <span class="comment">// this dt keeps frac~cour</span></div>
<div class="line"><a name="l03820"></a><span class="lineno"> 3820</span>&#160;  <span class="comment">//  *gravitydt = cour*(GRAVITYCOUR/frac); // GRAVITYCOUR is additional courant factor on gravitational term</span></div>
<div class="line"><a name="l03821"></a><span class="lineno"> 3821</span>&#160;</div>
<div class="line"><a name="l03822"></a><span class="lineno"> 3822</span>&#160;</div>
<div class="line"><a name="l03823"></a><span class="lineno"> 3823</span>&#160;  <span class="comment">// treat d\phi/dt as v^2/dt</span></div>
<div class="line"><a name="l03824"></a><span class="lineno"> 3824</span>&#160;  compute_dr( i,  j,  k, &amp;dr);</div>
<div class="line"><a name="l03825"></a><span class="lineno"> 3825</span>&#160;  <span class="comment">//dgttdt = fabs(GLOBALMETMACP0A3(conn,i,j,k,TT,TT,TT)/(GLOBALMETMACP1A2(gcon,CENT,i,j,k,TT,TT)));</span></div>
<div class="line"><a name="l03826"></a><span class="lineno"> 3826</span>&#160;  <span class="comment">//tempdt = GRAVITYCOUR*pow(cour*cour*dr*dr/dgttdt,1.0/3.0); // GRAVITYCOUR in front is effective additional courant factor on gravitational term</span></div>
<div class="line"><a name="l03827"></a><span class="lineno"> 3827</span>&#160;  tempdt = <a class="code" href="../../df/d22/advance_8c.html#aee532ee6b3b6f97488c944cd5aebc695">GRAVITYCOUR</a>*pow(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ab95415a19b94c9c8b05a1a1d1be4ce40">cour</a>*<a class="code" href="../../d8/d5b/defs_8general_8h.html#ab95415a19b94c9c8b05a1a1d1be4ce40">cour</a>*dr*dr/dphidt,1.0/3.0); <span class="comment">// GRAVITYCOUR in front is effective additional courant factor on gravitational term</span></div>
<div class="line"><a name="l03828"></a><span class="lineno"> 3828</span>&#160;</div>
<div class="line"><a name="l03829"></a><span class="lineno"> 3829</span>&#160;  <span class="keywordflow">if</span>(tempdt&lt;*gravitydt) *gravitydt=tempdt;</div>
<div class="line"><a name="l03830"></a><span class="lineno"> 3830</span>&#160;<span class="preprocessor">#elif(0)</span></div>
<div class="line"><a name="l03831"></a><span class="lineno"> 3831</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l03832"></a><span class="lineno"> 3832</span>&#160;  frac = fabs(ptrgeom-&gt;gcon[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a28b8da8b36c3a7b2f04da8809cd50b34">GIND</a>(<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>,<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>)]*dphidt);</div>
<div class="line"><a name="l03833"></a><span class="lineno"> 3833</span>&#160;  *gravitydt = <a class="code" href="../../d8/d5b/defs_8general_8h.html#ab95415a19b94c9c8b05a1a1d1be4ce40">cour</a>*(<a class="code" href="../../df/d22/advance_8c.html#aee532ee6b3b6f97488c944cd5aebc695">GRAVITYCOUR</a>/frac);</div>
<div class="line"><a name="l03834"></a><span class="lineno"> 3834</span>&#160;</div>
<div class="line"><a name="l03835"></a><span class="lineno"> 3835</span>&#160;</div>
<div class="line"><a name="l03836"></a><span class="lineno"> 3836</span>&#160;</div>
<div class="line"><a name="l03837"></a><span class="lineno"> 3837</span>&#160;</div>
<div class="line"><a name="l03838"></a><span class="lineno"> 3838</span>&#160;<span class="preprocessor">#elif(1)</span></div>
<div class="line"><a name="l03839"></a><span class="lineno"> 3839</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l03841"></a><span class="lineno"> 3841</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l03842"></a><span class="lineno"> 3842</span>&#160;  <span class="comment">// 3 methods to limit dt</span></div>
<div class="line"><a name="l03843"></a><span class="lineno"> 3843</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l03845"></a><span class="lineno"> 3845</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03846"></a><span class="lineno"> 3846</span>&#160;  <span class="comment">// LOCAL DPHI/DT LIMIT</span></div>
<div class="line"><a name="l03847"></a><span class="lineno"> 3847</span>&#160;  <span class="comment">// treat dt ~ \phi / (d\phi/dt)</span></div>
<div class="line"><a name="l03848"></a><span class="lineno"> 3848</span>&#160;  <span class="comment">//  frac = fabs(GLOBALMETMACP0A3(conn,i,j,k,TT,TT,TT)/((1+GLOBALMETMACP1A2(gcon,CENT,i,j,k,TT,TT))*(1+GLOBALMETMACP1A2(gcon,CENT,i,j,k,TT,TT))));</span></div>
<div class="line"><a name="l03849"></a><span class="lineno"> 3849</span>&#160;  frac = fabs(dphidt/phi);</div>
<div class="line"><a name="l03850"></a><span class="lineno"> 3850</span>&#160;  *gravitydt = <a class="code" href="../../d8/d5b/defs_8general_8h.html#ab95415a19b94c9c8b05a1a1d1be4ce40">cour</a>*(<a class="code" href="../../df/d22/advance_8c.html#aee532ee6b3b6f97488c944cd5aebc695">GRAVITYCOUR</a>/frac);</div>
<div class="line"><a name="l03851"></a><span class="lineno"> 3851</span>&#160;  <span class="comment">// this dt keeps frac~cour</span></div>
<div class="line"><a name="l03852"></a><span class="lineno"> 3852</span>&#160;  <span class="comment">//  *gravitydt = cour*(GRAVITYCOUR/frac); // GRAVITYCOUR is additional courant factor on gravitational term</span></div>
<div class="line"><a name="l03853"></a><span class="lineno"> 3853</span>&#160;</div>
<div class="line"><a name="l03854"></a><span class="lineno"> 3854</span>&#160;</div>
<div class="line"><a name="l03855"></a><span class="lineno"> 3855</span>&#160;</div>
<div class="line"><a name="l03856"></a><span class="lineno"> 3856</span>&#160;  compute_dr( i,  j,  k, &amp;dr);</div>
<div class="line"><a name="l03857"></a><span class="lineno"> 3857</span>&#160;</div>
<div class="line"><a name="l03858"></a><span class="lineno"> 3858</span>&#160;</div>
<div class="line"><a name="l03859"></a><span class="lineno"> 3859</span>&#160;  <span class="comment">// LOCAL DU/DT LIMIT BUT TREAT AS VELOCITY LIMITED BY SOL</span></div>
<div class="line"><a name="l03860"></a><span class="lineno"> 3860</span>&#160;</div>
<div class="line"><a name="l03861"></a><span class="lineno"> 3861</span>&#160;<span class="preprocessor">#if(REMOVERESTMASSFROMUU==2)</span></div>
<div class="line"><a name="l03862"></a><span class="lineno"> 3862</span>&#160;<span class="preprocessor"></span>  rhoprimegravity=fabs(U[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a94db1ec6a412a83becda73ca2a5db0bf">UU</a>]); <span class="comment">// gravity affects only \rho \phi -like terms order \rho v^2, not \rho</span></div>
<div class="line"><a name="l03863"></a><span class="lineno"> 3863</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l03864"></a><span class="lineno"> 3864</span>&#160;<span class="preprocessor"></span>  <span class="comment">// remove rest-mass</span></div>
<div class="line"><a name="l03865"></a><span class="lineno"> 3865</span>&#160;  rhoprimegravity=fabs(U[UU]+U[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a3bf4402b9e2ae88e4462c3689f5d22b8">RHO</a>]); <span class="comment">// gravity affects only \rho \phi -like terms order \rho v^2, not \rho</span></div>
<div class="line"><a name="l03866"></a><span class="lineno"> 3866</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03867"></a><span class="lineno"> 3867</span>&#160;<span class="preprocessor"></span>  aggravity=<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a09c78d2f8feb311dd9fc969a0bf84979">SMALL</a>+fabs(mydUdtgravity/rhoprimegravity);</div>
<div class="line"><a name="l03868"></a><span class="lineno"> 3868</span>&#160;  veleff = aggravity*mydx[1];</div>
<div class="line"><a name="l03869"></a><span class="lineno"> 3869</span>&#160;</div>
<div class="line"><a name="l03870"></a><span class="lineno"> 3870</span>&#160;  <span class="comment">// get speed of light in 1-direction (dx^1/dt)</span></div>
<div class="line"><a name="l03871"></a><span class="lineno"> 3871</span>&#160;  sol(pr,state,1,ptrgeom,&amp;v1max,&amp;v1min);</div>
<div class="line"><a name="l03872"></a><span class="lineno"> 3872</span>&#160;  <span class="comment">// limit &quot;velocity&quot; to speed of light</span></div>
<div class="line"><a name="l03873"></a><span class="lineno"> 3873</span>&#160;  <span class="keywordflow">if</span>(veleff&gt;fabs(v1min)) veleff=fabs(v1min);</div>
<div class="line"><a name="l03874"></a><span class="lineno"> 3874</span>&#160;  <span class="keywordflow">if</span>(veleff&gt;fabs(v1max)) veleff=fabs(v1max);</div>
<div class="line"><a name="l03875"></a><span class="lineno"> 3875</span>&#160;</div>
<div class="line"><a name="l03876"></a><span class="lineno"> 3876</span>&#160;  tempdt=<a class="code" href="../../df/d22/advance_8c.html#aee532ee6b3b6f97488c944cd5aebc695">GRAVITYCOUR</a>*<a class="code" href="../../d8/d5b/defs_8general_8h.html#ab95415a19b94c9c8b05a1a1d1be4ce40">cour</a>*mydx[1]/veleff;</div>
<div class="line"><a name="l03877"></a><span class="lineno"> 3877</span>&#160;  <span class="keywordflow">if</span>(tempdt&lt;*gravitydt) *gravitydt=tempdt;</div>
<div class="line"><a name="l03878"></a><span class="lineno"> 3878</span>&#160;</div>
<div class="line"><a name="l03879"></a><span class="lineno"> 3879</span>&#160;</div>
<div class="line"><a name="l03880"></a><span class="lineno"> 3880</span>&#160;  <span class="comment">// LOCAL LIMIT ON DPHI/DT WHERE PHI~V^2</span></div>
<div class="line"><a name="l03881"></a><span class="lineno"> 3881</span>&#160;  <span class="comment">//dgttdt = fabs(GLOBALMETMACP0A3(conn,i,j,k,TT,TT,TT)/(GLOBALMETMACP1A2(gcon,CENT,i,j,k,TT,TT)));</span></div>
<div class="line"><a name="l03882"></a><span class="lineno"> 3882</span>&#160;  <span class="comment">//tempdt = GRAVITYCOUR*pow(cour*cour*dr*dr/dgttdt,1.0/3.0); // GRAVITYCOUR in front is effective additional courant factor on gravitational term</span></div>
<div class="line"><a name="l03883"></a><span class="lineno"> 3883</span>&#160;  tempdt = <a class="code" href="../../df/d22/advance_8c.html#aee532ee6b3b6f97488c944cd5aebc695">GRAVITYCOUR</a>*pow(<a class="code" href="../../d8/d5b/defs_8general_8h.html#ab95415a19b94c9c8b05a1a1d1be4ce40">cour</a>*<a class="code" href="../../d8/d5b/defs_8general_8h.html#ab95415a19b94c9c8b05a1a1d1be4ce40">cour</a>*dr*dr/dphidt,1.0/3.0); <span class="comment">// GRAVITYCOUR in front is effective additional courant factor on gravitational term</span></div>
<div class="line"><a name="l03884"></a><span class="lineno"> 3884</span>&#160;  <span class="keywordflow">if</span>(tempdt&lt;*gravitydt) *gravitydt=tempdt;</div>
<div class="line"><a name="l03885"></a><span class="lineno"> 3885</span>&#160;</div>
<div class="line"><a name="l03886"></a><span class="lineno"> 3886</span>&#160;</div>
<div class="line"><a name="l03887"></a><span class="lineno"> 3887</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03888"></a><span class="lineno"> 3888</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l03889"></a><span class="lineno"> 3889</span>&#160;</div>
<div class="line"><a name="l03890"></a><span class="lineno"> 3890</span>&#160;</div>
<div class="line"><a name="l03891"></a><span class="lineno"> 3891</span>&#160;</div>
<div class="line"><a name="l03892"></a><span class="lineno"> 3892</span>&#160;<span class="preprocessor">#endif // end if DOSELFGRAVVSR==1</span></div>
<div class="line"><a name="l03893"></a><span class="lineno"> 3893</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l03894"></a><span class="lineno"> 3894</span>&#160;</div>
<div class="line"><a name="l03895"></a><span class="lineno"> 3895</span>&#160;</div>
<div class="line"><a name="l03896"></a><span class="lineno"> 3896</span>&#160;</div>
<div class="line"><a name="l03897"></a><span class="lineno"> 3897</span>&#160;</div>
<div class="line"><a name="l03898"></a><span class="lineno"> 3898</span>&#160;</div>
<div class="line"><a name="l03899"></a><span class="lineno"> 3899</span>&#160;</div>
<div class="line"><a name="l03900"></a><span class="lineno"> 3900</span>&#160;</div>
<div class="line"><a name="l03901"></a><span class="lineno"> 3901</span>&#160;</div>
<div class="line"><a name="l03902"></a><span class="lineno"> 3902</span>&#160;</div>
<div class="line"><a name="l03904"></a><span class="lineno"> 3904</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l03905"></a><span class="lineno"> 3905</span>&#160;  <span class="comment">// Finally store source term&#39;s version of limited dt to be used later</span></div>
<div class="line"><a name="l03906"></a><span class="lineno"> 3906</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l03908"></a><span class="lineno"> 3908</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03909"></a><span class="lineno"> 3909</span>&#160;  <span class="comment">//  if(ptrgeom-&gt;i==30 &amp;&amp; ptrgeom-&gt;j==31){</span></div>
<div class="line"><a name="l03910"></a><span class="lineno"> 3910</span>&#160;  <span class="comment">//  DLOOPA(jj) dualfprintf(fail_file,&quot;dtsource[%d]=%21.15g : %21.15g : %21.15g %21.15g : %21.15g\n&quot;,jj,dtsource[jj],cour,mydx[jj],ag[jj],dUevolve[UU+jj]);</span></div>
<div class="line"><a name="l03911"></a><span class="lineno"> 3911</span>&#160;  <span class="comment">//} </span></div>
<div class="line"><a name="l03912"></a><span class="lineno"> 3912</span>&#160;</div>
<div class="line"><a name="l03913"></a><span class="lineno"> 3913</span>&#160;  <span class="comment">//  dualfprintf(fail_file,&quot;i=%d mydUdtgravity=%21.15g rhoprimegravity=%21.15g rhoprime[TT]=%21.15g mydU[TT]=%21.15g\n&quot;,ptrgeom-&gt;i,mydUdtgravity,rhoprimegravity,rhoprime[TT],mydU[TT]);</span></div>
<div class="line"><a name="l03914"></a><span class="lineno"> 3914</span>&#160;</div>
<div class="line"><a name="l03915"></a><span class="lineno"> 3915</span>&#160;  <span class="comment">// always do time-component</span></div>
<div class="line"><a name="l03916"></a><span class="lineno"> 3916</span>&#160;  <span class="comment">// accounts for thermal changes if cooling function or geometry changes if metric changing</span></div>
<div class="line"><a name="l03917"></a><span class="lineno"> 3917</span>&#160;  <span class="keywordflow">if</span> (dtsource[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>] &lt; *dtij) *dtij = dtsource[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a08ca909b46b12e894320afaabce3056e" title="time period between dumps for various types of dumps NO, use &quot;DUMPTYPE&quot; names now">TT</a>];</div>
<div class="line"><a name="l03918"></a><span class="lineno"> 3918</span>&#160;</div>
<div class="line"><a name="l03919"></a><span class="lineno"> 3919</span>&#160;<span class="preprocessor">#if(N1&gt;1)</span></div>
<div class="line"><a name="l03920"></a><span class="lineno"> 3920</span>&#160;<span class="preprocessor"></span>  <span class="keywordflow">if</span> (dtsource[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a63979cf6054f403eab1d354e6dcc4ce9">RR</a>] &lt; *dtij) *dtij = dtsource[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a63979cf6054f403eab1d354e6dcc4ce9">RR</a>];</div>
<div class="line"><a name="l03921"></a><span class="lineno"> 3921</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03922"></a><span class="lineno"> 3922</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#if(N2&gt;1)</span></div>
<div class="line"><a name="l03923"></a><span class="lineno"> 3923</span>&#160;<span class="preprocessor"></span>  <span class="keywordflow">if</span> (dtsource[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8ccbf4850176503992b0295081d5f4bc">TH</a>] &lt; *dtij) *dtij = dtsource[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#a8ccbf4850176503992b0295081d5f4bc">TH</a>];</div>
<div class="line"><a name="l03924"></a><span class="lineno"> 3924</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03925"></a><span class="lineno"> 3925</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#if(N3&gt;1)</span></div>
<div class="line"><a name="l03926"></a><span class="lineno"> 3926</span>&#160;<span class="preprocessor"></span>  <span class="keywordflow">if</span> (dtsource[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae0fcc909f5a4166b625a6707cbdfa643">PH</a>] &lt; *dtij) *dtij = dtsource[<a class="code" href="../../de/d10/global_8nondepmnemonics_8h.html#ae0fcc909f5a4166b625a6707cbdfa643">PH</a>];</div>
<div class="line"><a name="l03927"></a><span class="lineno"> 3927</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03928"></a><span class="lineno"> 3928</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l03929"></a><span class="lineno"> 3929</span>&#160;</div>
<div class="line"><a name="l03930"></a><span class="lineno"> 3930</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l03931"></a><span class="lineno"> 3931</span>&#160;</div>
<div class="line"><a name="l03932"></a><span class="lineno"> 3932</span>&#160;}</div>
<div class="line"><a name="l03933"></a><span class="lineno"> 3933</span>&#160;</div>
<div class="line"><a name="l03934"></a><span class="lineno"> 3934</span>&#160;</div>
<div class="line"><a name="l03935"></a><span class="lineno"> 3935</span>&#160;</div>
<div class="line"><a name="l03937"></a><span class="lineno"> 3937</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> dUtodt(<span class="keyword">struct</span> <a class="code" href="../../d6/d39/global_8structs_8h.html#aa7fe064ca3d2eb92f00456cd7c186eae" title="typedef struct of_geom struct of_compgeom; force to be the same">of_geom</a> *ptrgeom, <span class="keyword">struct</span> <a class="code" href="../../d1/d83/structof__state.html" title="state structure">of_state</a> *qaddr, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *pr, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *dUgeom, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *dUriemann, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *dUgeomgravity, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *accdt, <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> *gravitydt)</div>
<div class="line"><a name="l03938"></a><span class="lineno"> 3938</span>&#160;{</div>
<div class="line"><a name="l03939"></a><span class="lineno"> 3939</span>&#160;  <span class="keywordtype">int</span> pl,pliter;</div>
<div class="line"><a name="l03940"></a><span class="lineno"> 3940</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> dUtotal[NPR];</div>
<div class="line"><a name="l03941"></a><span class="lineno"> 3941</span>&#160;  <a class="code" href="../../d6/df4/global_8realdef_8h.html#a4b869b0ea0650e99dff987e742327ce0" title="need not change below datatype stuff">FTYPE</a> Ugeomfree[NPR],U[NPR];</div>
<div class="line"><a name="l03942"></a><span class="lineno"> 3942</span>&#160;</div>
<div class="line"><a name="l03943"></a><span class="lineno"> 3943</span>&#160;</div>
<div class="line"><a name="l03944"></a><span class="lineno"> 3944</span>&#160;</div>
<div class="line"><a name="l03945"></a><span class="lineno"> 3945</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) {</div>
<div class="line"><a name="l03946"></a><span class="lineno"> 3946</span>&#160;    <span class="comment">// while each piece may be &quot;large&quot;, when summed if small then final change to conserved quantity is small, so that&#39;s all that&#39;s relevant</span></div>
<div class="line"><a name="l03947"></a><span class="lineno"> 3947</span>&#160;    dUtotal[pl]=dUriemann[pl]+dUgeom[pl];</div>
<div class="line"><a name="l03948"></a><span class="lineno"> 3948</span>&#160;    <span class="comment">// GODMARK:</span></div>
<div class="line"><a name="l03949"></a><span class="lineno"> 3949</span>&#160;    <span class="comment">//    dUtotal[pl]=fabs(dUriemann[pl])+fabs(dUgeom[pl]);</span></div>
<div class="line"><a name="l03950"></a><span class="lineno"> 3950</span>&#160;  }</div>
<div class="line"><a name="l03951"></a><span class="lineno"> 3951</span>&#160;</div>
<div class="line"><a name="l03952"></a><span class="lineno"> 3952</span>&#160;  <span class="comment">// conserved quantity without geometry</span></div>
<div class="line"><a name="l03953"></a><span class="lineno"> 3953</span>&#160;  <a class="code" href="../../d9/d43/global_8variousmacros_8h.html#a0163a499c88dd8b07688e3dbd7007f0e">MYFUN</a>(<a class="code" href="../../d3/ddc/phys_8funcdeclare_8h.html#a9a54096e4c40a15a2c1bf74266153616" title="calculate &quot;conserved&quot; quantities">primtoU</a>(UEVOLVE, pr, qaddr, ptrgeom, U, NULL),<span class="stringliteral">&quot;step_ch.c:advance()&quot;</span>, <span class="stringliteral">&quot;primtoU()&quot;</span>, 1);</div>
<div class="line"><a name="l03954"></a><span class="lineno"> 3954</span>&#160;  <a class="code" href="../../d5/dd8/global_8loops_8perpoint_8h.html#af1c67086436007e897bccc458390886f" title="PLOOP controls looping over conserved or primitive -type quantities except during interpolation or ot...">PLOOP</a>(pliter,pl) Ugeomfree[pl] = U[pl]*(ptrgeom-&gt;<a class="code" href="../../d1/de6/global_8depmnemonics_8h.html#a6d808515c6c005e51aeefb326bc04515">IEOMFUNCNOSINGMAC</a>(pl));</div>
<div class="line"><a name="l03955"></a><span class="lineno"> 3955</span>&#160;</div>
<div class="line"><a name="l03956"></a><span class="lineno"> 3956</span>&#160;</div>
<div class="line"><a name="l03957"></a><span class="lineno"> 3957</span>&#160;  compute_dt_fromsource(ptrgeom, qaddr, pr, Ugeomfree, dUtotal, dUgeomgravity, accdt, gravitydt);</div>
<div class="line"><a name="l03958"></a><span class="lineno"> 3958</span>&#160;    </div>
<div class="line"><a name="l03959"></a><span class="lineno"> 3959</span>&#160;</div>
<div class="line"><a name="l03960"></a><span class="lineno"> 3960</span>&#160;</div>
<div class="line"><a name="l03961"></a><span class="lineno"> 3961</span>&#160;  return(0);</div>
<div class="line"><a name="l03962"></a><span class="lineno"> 3962</span>&#160;</div>
<div class="line"><a name="l03963"></a><span class="lineno"> 3963</span>&#160;}</div>
<div class="line"><a name="l03964"></a><span class="lineno"> 3964</span>&#160;</div>
</div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Fri May 20 2016 15:52:32 for HARM by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.8.3.1
</small></address>
</body>
</html>
